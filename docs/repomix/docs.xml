<repomix><file_summary>This file is a merged representation of a subset of the codebase, containing specifically included files and files not matching ignore patterns, combined into a single document by Repomix.
The content has been processed where line numbers have been added, content has been formatted for parsing in xml style.<purpose>This file contains a packed representation of a subset of the repository&apos;s contents that is considered the most important context.
It is designed to be easily consumable by AI systems for analysis, code review,
or other automated processes.</purpose><file_format>The content is organized as follows:
1. This summary section
2. Repository information
3. Directory structure
4. Repository files (if enabled)
5. Repository files, each consisting of:
  - File path as an attribute
  - Full contents of the file</file_format><usage_guidelines>- This file should be treated as read-only. Any changes should be made to the
  original repository files, not this packed version.
- When processing this file, use the file path to distinguish
  between different files in the repository.
- Be aware that this file may contain sensitive information. Handle it with
  the same level of security as you would the original repository.</usage_guidelines><notes>- Some files may have been excluded based on .gitignore rules and Repomix&apos;s configuration
- Binary files are not included in this packed representation. Please refer to the Repository Structure section for a complete list of file paths, including binary files
- Only files matching these patterns are included: src/**/*
- Files matching these patterns are excluded: tmp/, *.log, dist/
- Files matching patterns in .gitignore are excluded
- Files matching default ignore patterns are excluded
- Line numbers have been added to the beginning of each line
- Content has been formatted for parsing in xml style
- Files are sorted by Git change count (files with more changes are at the bottom)</notes></file_summary><directory_structure>src/
  __tests__/
    components.test.tsx
    dr13-coverage.test.tsx
    f1-f6-components.test.tsx
    p1-explainability.test.tsx
    quality-utils-drift.test.ts
    setup.ts
  api/
    routes/
      agents.ts
      compliance.ts
      correlations.ts
      coverage.ts
      dashboard.ts
      evaluations.ts
      metrics.ts
      pipeline.ts
      quality.ts
      sessions.ts
      traces.ts
      trends.ts
    data-loader.ts
    server.ts
  components/
    views/
      AuditorView.tsx
      ExecutiveView.tsx
      OperatorView.tsx
    AgentActivityPanel.tsx
    AgentScoreSummary.tsx
    AlertList.tsx
    ChainOfThoughtPanel.tsx
    ComplianceFrameworkMap.tsx
    ConfidencePanel.tsx
    CorrelationHeatmap.tsx
    CoverageGrid.tsx
    CQIHero.tsx
    EvaluationDetail.tsx
    EvaluationEventOverlay.tsx
    EvaluationExpandedRow.tsx
    EvaluationTable.tsx
    HandoffCard.tsx
    HealthOverview.tsx
    Indicators.tsx
    Layout.tsx
    MetaItem.tsx
    MetricCard.tsx
    MetricCompare.tsx
    MetricGrid.tsx
    PageShell.tsx
    PipelineFunnel.tsx
    ProvenancePanel.tsx
    QualityLiveIndicator.tsx
    RoleSelector.tsx
    ScoreBadge.tsx
    ScoreHistogram.tsx
    Section.tsx
    ShortcutOverlay.tsx
    SLATable.tsx
    SpanTree.tsx
    Sparkline.tsx
    SplitPane.tsx
    StatCard.tsx
    SyncEmptyState.tsx
    TrendChart.tsx
    TrendSeries.tsx
    TurnTimeline.tsx
  contexts/
    KeyboardNavContext.tsx
    RoleContext.tsx
  hooks/
    useAgentSession.ts
    useAgentStats.ts
    useCompliance.ts
    useCoverage.ts
    useDashboard.ts
    useMetricDetail.ts
    useMetricEvaluations.ts
    usePipeline.ts
    useQualityLive.ts
    useSessionDetail.ts
    useTrace.ts
    useTraceEvaluations.ts
    useTrend.ts
  lib/
    constants.ts
    quality-utils.ts
  pages/
    AgentSessionPage.tsx
    AgentsPage.tsx
    CompliancePage.tsx
    CorrelationsPage.tsx
    CoveragePage.tsx
    EvaluationDetailPage.tsx
    PipelinePage.tsx
    SessionDetailPage.tsx
    TraceDetailPage.tsx
  App.tsx
  main.tsx
  theme.css
  types.ts
  vite-env.d.ts</directory_structure><files>This section contains the contents of the repository&apos;s files.<file path="src/__tests__/components.test.tsx">  1: import { describe, it, expect, afterEach } from &apos;vitest&apos;;
  2: import { render, screen, cleanup, within } from &apos;@testing-library/react&apos;;
  3: import { StatusBadge, TrendIndicator, ConfidenceBadge } from &apos;../components/Indicators.js&apos;;
  4: import { HealthOverview } from &apos;../components/HealthOverview.js&apos;;
  5: import { AlertList } from &apos;../components/AlertList.js&apos;;
  6: import { SLATable } from &apos;../components/SLATable.js&apos;;
  7: import type {
  8:   QualityDashboardSummary,
  9:   TriggeredAlert,
 10:   SLAComplianceResult,
 11:   MetricTrend,
 12:   ConfidenceIndicator,
 13: } from &apos;../types.js&apos;;
 14: 
 15: // ---------------------------------------------------------------------------
 16: // Test Data Factories
 17: // ---------------------------------------------------------------------------
 18: 
 19: function makeDashboard(overrides: Partial&lt;QualityDashboardSummary&gt; = {}): QualityDashboardSummary {
 20:   return {
 21:     overallStatus: &apos;healthy&apos;,
 22:     metrics: [],
 23:     alerts: [],
 24:     summary: {
 25:       totalMetrics: 7,
 26:       healthyMetrics: 5,
 27:       warningMetrics: 1,
 28:       criticalMetrics: 1,
 29:       noDataMetrics: 0,
 30:     },
 31:     timestamp: &apos;2026-02-10T00:00:00Z&apos;,
 32:     ...overrides,
 33:   };
 34: }
 35: 
 36: function makeAlert(overrides: Partial&lt;TriggeredAlert&gt; = {}): TriggeredAlert {
 37:   return {
 38:     severity: &apos;warning&apos;,
 39:     message: &apos;Test alert message&apos;,
 40:     aggregation: &apos;avg&apos;,
 41:     threshold: 0.7,
 42:     actualValue: 0.6,
 43:     direction: &apos;below&apos;,
 44:     ...overrides,
 45:   };
 46: }
 47: 
 48: function makeSLA(overrides: Partial&lt;SLAComplianceResult&gt; = {}): SLAComplianceResult {
 49:   return {
 50:     sla: { metric: &apos;relevance&apos;, aggregation: &apos;avg&apos;, target: 0.8, direction: &apos;above&apos; },
 51:     compliant: true,
 52:     status: &apos;compliant&apos;,
 53:     actualValue: 0.9,
 54:     gap: 0.1,
 55:     marginPercent: 12.5,
 56:     ...overrides,
 57:   };
 58: }
 59: 
 60: // ---------------------------------------------------------------------------
 61: // StatusBadge
 62: // ---------------------------------------------------------------------------
 63: 
 64: describe(&apos;StatusBadge&apos;, () =&gt; {
 65:   it(&apos;renders healthy status&apos;, () =&gt; {
 66:     render(&lt;StatusBadge status=&quot;healthy&quot; /&gt;);
 67:     expect(screen.getByLabelText(&apos;Status: healthy&apos;)).toBeInTheDocument();
 68:     expect(screen.getByText(/healthy/)).toBeInTheDocument();
 69:   });
 70: 
 71:   it(&apos;renders critical status&apos;, () =&gt; {
 72:     render(&lt;StatusBadge status=&quot;critical&quot; /&gt;);
 73:     expect(screen.getByLabelText(&apos;Status: critical&apos;)).toBeInTheDocument();
 74:   });
 75: 
 76:   it(&apos;renders no_data status&apos;, () =&gt; {
 77:     render(&lt;StatusBadge status=&quot;no_data&quot; /&gt;);
 78:     expect(screen.getByLabelText(&apos;Status: no_data&apos;)).toBeInTheDocument();
 79:   });
 80: });
 81: 
 82: // ---------------------------------------------------------------------------
 83: // TrendIndicator
 84: // ---------------------------------------------------------------------------
 85: 
 86: describe(&apos;TrendIndicator&apos;, () =&gt; {
 87:   it(&apos;renders nothing when trend is undefined&apos;, () =&gt; {
 88:     const { container } = render(&lt;TrendIndicator trend={undefined} /&gt;);
 89:     expect(container.innerHTML).toBe(&apos;&apos;);
 90:   });
 91: 
 92:   it(&apos;renders improving trend with positive percentage&apos;, () =&gt; {
 93:     const trend: MetricTrend = {
 94:       direction: &apos;improving&apos;,
 95:       delta: 0.05,
 96:       percentChange: 5.3,
 97:       currentValue: 0.85,
 98:       previousValue: 0.8,
 99:       aggregation: &apos;avg&apos;,
100:       lowSampleWarning: false,
101:     };
102:     render(&lt;TrendIndicator trend={trend} /&gt;);
103:     expect(screen.getByText(/\+5.3%/)).toBeInTheDocument();
104:     expect(screen.getByLabelText(/improving/)).toBeInTheDocument();
105:   });
106: 
107:   it(&apos;renders degrading trend with negative percentage&apos;, () =&gt; {
108:     const trend: MetricTrend = {
109:       direction: &apos;degrading&apos;,
110:       delta: -0.05,
111:       percentChange: -3.1,
112:       currentValue: 0.75,
113:       previousValue: 0.8,
114:       aggregation: &apos;avg&apos;,
115:       lowSampleWarning: false,
116:     };
117:     render(&lt;TrendIndicator trend={trend} /&gt;);
118:     expect(screen.getByText(/-3.1%/)).toBeInTheDocument();
119:   });
120: 
121:   it(&apos;shows low sample warning indicator&apos;, () =&gt; {
122:     const trend: MetricTrend = {
123:       direction: &apos;stable&apos;,
124:       delta: 0,
125:       percentChange: 0,
126:       currentValue: 0.8,
127:       previousValue: 0.8,
128:       aggregation: &apos;avg&apos;,
129:       lowSampleWarning: true,
130:     };
131:     render(&lt;TrendIndicator trend={trend} /&gt;);
132:     expect(screen.getByText(&apos;*&apos;)).toBeInTheDocument();
133:   });
134: });
135: 
136: // ---------------------------------------------------------------------------
137: // ConfidenceBadge
138: // ---------------------------------------------------------------------------
139: 
140: describe(&apos;ConfidenceBadge&apos;, () =&gt; {
141:   it(&apos;renders nothing when confidence is undefined&apos;, () =&gt; {
142:     const { container } = render(&lt;ConfidenceBadge confidence={undefined} /&gt;);
143:     expect(container.innerHTML).toBe(&apos;&apos;);
144:   });
145: 
146:   it(&apos;renders high confidence&apos;, () =&gt; {
147:     const confidence: ConfidenceIndicator = {
148:       level: &apos;high&apos;,
149:       sampleCount: 100,
150:       scoreStdDev: 0.1,
151:       evaluatorCount: 1,
152:       evaluatorAgreement: null,
153:     };
154:     render(&lt;ConfidenceBadge confidence={confidence} /&gt;);
155:     expect(screen.getByLabelText(&apos;Confidence: high&apos;)).toBeInTheDocument();
156:   });
157: });
158: 
159: // ---------------------------------------------------------------------------
160: // HealthOverview
161: // ---------------------------------------------------------------------------
162: 
163: describe(&apos;HealthOverview&apos;, () =&gt; {
164:   it(&apos;renders healthy banner text&apos;, () =&gt; {
165:     render(&lt;HealthOverview dashboard={makeDashboard({ overallStatus: &apos;healthy&apos; })} /&gt;);
166:     expect(screen.getByText(&apos;All metrics within thresholds&apos;)).toBeInTheDocument();
167:   });
168: 
169:   it(&apos;renders critical banner text&apos;, () =&gt; {
170:     render(&lt;HealthOverview dashboard={makeDashboard({ overallStatus: &apos;critical&apos; })} /&gt;);
171:     expect(screen.getByText(&apos;Critical issues detected&apos;)).toBeInTheDocument();
172:   });
173: 
174:   it(&apos;renders warning banner text&apos;, () =&gt; {
175:     render(&lt;HealthOverview dashboard={makeDashboard({ overallStatus: &apos;warning&apos; })} /&gt;);
176:     expect(screen.getByText(&apos;Some metrics need attention&apos;)).toBeInTheDocument();
177:   });
178: 
179:   it(&apos;renders no_data banner text&apos;, () =&gt; {
180:     render(&lt;HealthOverview dashboard={makeDashboard({ overallStatus: &apos;no_data&apos; })} /&gt;);
181:     expect(screen.getByText(&apos;No evaluation data available&apos;)).toBeInTheDocument();
182:   });
183: 
184:   it(&apos;renders summary counts&apos;, () =&gt; {
185:     const dash = makeDashboard({
186:       summary: { totalMetrics: 7, healthyMetrics: 3, warningMetrics: 2, criticalMetrics: 1, noDataMetrics: 1 },
187:     });
188:     const { container } = render(&lt;HealthOverview dashboard={dash} /&gt;);
189:     const counts = container.querySelectorAll(&apos;.summary-count&apos;);
190:     expect(counts).toHaveLength(4);
191:     expect(within(counts[0] as HTMLElement).getByText(&apos;7&apos;)).toBeInTheDocument();
192:     expect(within(counts[0] as HTMLElement).getByText(&apos;Total&apos;)).toBeInTheDocument();
193:     expect(within(counts[1] as HTMLElement).getByText(&apos;3&apos;)).toBeInTheDocument();
194:     expect(within(counts[2] as HTMLElement).getByText(&apos;2&apos;)).toBeInTheDocument();
195:     expect(within(counts[3] as HTMLElement).getByText(&apos;1&apos;)).toBeInTheDocument();
196:   });
197: });
198: 
199: // ---------------------------------------------------------------------------
200: // AlertList
201: // ---------------------------------------------------------------------------
202: 
203: describe(&apos;AlertList&apos;, () =&gt; {
204:   it(&apos;renders nothing for empty alerts&apos;, () =&gt; {
205:     const { container } = render(&lt;AlertList alerts={[]} /&gt;);
206:     expect(container.innerHTML).toBe(&apos;&apos;);
207:   });
208: 
209:   it(&apos;renders alert messages&apos;, () =&gt; {
210:     const alerts = [makeAlert({ message: &apos;Relevance p50 critically low&apos; })];
211:     render(&lt;AlertList alerts={alerts} /&gt;);
212:     expect(screen.getByText(&apos;Relevance p50 critically low&apos;)).toBeInTheDocument();
213:   });
214: 
215:   it(&apos;sorts alerts by severity (critical first)&apos;, () =&gt; {
216:     const alerts = [
217:       makeAlert({ severity: &apos;info&apos;, message: &apos;info alert&apos; }),
218:       makeAlert({ severity: &apos;critical&apos;, message: &apos;critical alert&apos; }),
219:       makeAlert({ severity: &apos;warning&apos;, message: &apos;warning alert&apos; }),
220:     ];
221:     const { container } = render(&lt;AlertList alerts={alerts} /&gt;);
222:     const items = container.querySelectorAll(&apos;.alert-item&apos;);
223:     expect(items[0]).toHaveTextContent(&apos;critical alert&apos;);
224:     expect(items[1]).toHaveTextContent(&apos;warning alert&apos;);
225:     expect(items[2]).toHaveTextContent(&apos;info alert&apos;);
226:   });
227: 
228:   it(&apos;renders remediation hints&apos;, () =&gt; {
229:     const alerts = [makeAlert({ remediationHints: [&apos;Review recent prompt changes&apos;] })];
230:     render(&lt;AlertList alerts={alerts} /&gt;);
231:     expect(screen.getByText(/Review recent prompt changes/)).toBeInTheDocument();
232:   });
233: 
234:   it(&apos;renders aggregation and threshold metadata&apos;, () =&gt; {
235:     const alerts = [makeAlert({ aggregation: &apos;p50&apos;, actualValue: 0.45, threshold: 0.7 })];
236:     const { container } = render(&lt;AlertList alerts={alerts} /&gt;);
237:     const meta = container.querySelector(&apos;.alert-meta&apos;);
238:     expect(meta).toHaveTextContent(&apos;p50 = 0.4500&apos;);
239:     expect(meta).toHaveTextContent(&apos;threshold: 0.7000&apos;);
240:   });
241: });
242: 
243: // ---------------------------------------------------------------------------
244: // SLATable
245: // ---------------------------------------------------------------------------
246: 
247: describe(&apos;SLATable&apos;, () =&gt; {
248:   it(&apos;renders nothing for empty SLAs&apos;, () =&gt; {
249:     const { container } = render(&lt;SLATable slas={[]} /&gt;);
250:     expect(container.innerHTML).toBe(&apos;&apos;);
251:   });
252: 
253:   it(&apos;renders SLA rows with metric name and target&apos;, () =&gt; {
254:     const slas = [makeSLA()];
255:     render(&lt;SLATable slas={slas} /&gt;);
256:     expect(screen.getByText(&apos;relevance (avg)&apos;)).toBeInTheDocument();
257:     expect(screen.getByText(/&gt;= 0.8000/)).toBeInTheDocument();
258:   });
259: 
260:   it(&apos;renders actual value and gap&apos;, () =&gt; {
261:     const slas = [makeSLA({ actualValue: 0.9, gap: 0.1 })];
262:     const { container } = render(&lt;SLATable slas={slas} /&gt;);
263:     const cells = container.querySelectorAll(&apos;td&apos;);
264:     // Cells: metric, target, actual, gap, status
265:     expect(cells[2]).toHaveTextContent(&apos;0.9000&apos;);
266:     expect(cells[3]).toHaveTextContent(&apos;+0.1000&apos;);
267:   });
268: 
269:   it(&apos;renders N/A for null actual value&apos;, () =&gt; {
270:     const slas = [makeSLA({ actualValue: null, gap: null, status: &apos;no_data&apos;, compliant: false })];
271:     render(&lt;SLATable slas={slas} /&gt;);
272:     expect(screen.getByText(&apos;N/A&apos;)).toBeInTheDocument();
273:   });
274: 
275:   it(&apos;renders non-compliant gap in critical color&apos;, () =&gt; {
276:     const slas = [makeSLA({ compliant: false, gap: -0.1, status: &apos;non_compliant&apos; })];
277:     render(&lt;SLATable slas={slas} /&gt;);
278:     // Gap cell should have critical color style
279:     const gapCell = screen.getByText(&apos;-0.1000&apos;);
280:     expect(gapCell).toHaveStyle({ color: &apos;var(--status-critical)&apos; });
281:   });
282: });</file><file path="src/components/RoleSelector.tsx"> 1: import { useLocation } from &apos;wouter&apos;;
 2: import type { RoleViewType } from &apos;../types.js&apos;;
 3: 
 4: const TABS: Array&lt;{ path: string; label: string; role?: RoleViewType }&gt; = [
 5:   { path: &apos;/&apos;, label: &apos;Dashboard&apos; },
 6:   { path: &apos;/role/executive&apos;, label: &apos;Executive&apos;, role: &apos;executive&apos; },
 7:   { path: &apos;/role/operator&apos;, label: &apos;Operator&apos;, role: &apos;operator&apos; },
 8:   { path: &apos;/role/auditor&apos;, label: &apos;Auditor&apos;, role: &apos;auditor&apos; },
 9:   { path: &apos;/correlations&apos;, label: &apos;Correlations&apos; },
10:   { path: &apos;/coverage&apos;, label: &apos;Coverage&apos; },
11:   { path: &apos;/pipeline&apos;, label: &apos;Pipeline&apos; },
12: ];
13: 
14: export function RoleSelector() {
15:   const [location, setLocation] = useLocation();
16: 
17:   return (
18:     &lt;nav className=&quot;tab-nav&quot; role=&quot;tablist&quot; aria-label=&quot;Dashboard views&quot;&gt;
19:       {TABS.map((tab) =&gt; {
20:         const active = location === tab.path;
21:         return (
22:           &lt;button
23:             key={tab.path}
24:             role=&quot;tab&quot;
25:             aria-selected={active}
26:             className=&quot;tab-btn&quot;
27:             onClick={() =&gt; setLocation(tab.path)}
28:           &gt;
29:             {tab.label}
30:           &lt;/button&gt;
31:         );
32:       })}
33:     &lt;/nav&gt;
34:   );
35: }</file><file path="src/components/ScoreHistogram.tsx"> 1: export function ScoreHistogram({ distribution }: { distribution: Array&lt;{ bucket: string; count: number }&gt; }) {
 2:   if (distribution.length === 0) return null;
 3: 
 4:   const maxCount = Math.max(...distribution.map((d) =&gt; d.count), 1);
 5: 
 6:   return (
 7:     &lt;div&gt;
 8:       &lt;div className=&quot;histogram&quot;&gt;
 9:         {distribution.map((d, i) =&gt; (
10:           &lt;div
11:             key={i}
12:             className=&quot;histogram-bar&quot;
13:             style={{ height: `${(d.count / maxCount) * 100}%` }}
14:             aria-label={`${d.bucket}: ${d.count} evaluations`}
15:           &gt;
16:             &lt;div className=&quot;tooltip&quot;&gt;
17:               {d.bucket}: {d.count}
18:             &lt;/div&gt;
19:           &lt;/div&gt;
20:         ))}
21:       &lt;/div&gt;
22:       &lt;div className=&quot;histogram-labels&quot;&gt;
23:         &lt;span&gt;{distribution[0]?.bucket}&lt;/span&gt;
24:         &lt;span&gt;{distribution[distribution.length - 1]?.bucket}&lt;/span&gt;
25:       &lt;/div&gt;
26:     &lt;/div&gt;
27:   );
28: }</file><file path="src/components/SLATable.tsx"> 1: import type { SLAComplianceResult } from &apos;../types.js&apos;;
 2: import { StatusBadge } from &apos;./Indicators.js&apos;;
 3: 
 4: export function SLATable({ slas }: { slas: SLAComplianceResult[] }) {
 5:   if (slas.length === 0) return null;
 6: 
 7:   return (
 8:     &lt;table className=&quot;sla-table&quot;&gt;
 9:       &lt;thead&gt;
10:         &lt;tr&gt;
11:           &lt;th&gt;Metric&lt;/th&gt;
12:           &lt;th&gt;Target&lt;/th&gt;
13:           &lt;th&gt;Actual&lt;/th&gt;
14:           &lt;th&gt;Gap&lt;/th&gt;
15:           &lt;th&gt;Status&lt;/th&gt;
16:         &lt;/tr&gt;
17:       &lt;/thead&gt;
18:       &lt;tbody&gt;
19:         {slas.map((sla) =&gt; (
20:           &lt;tr key={`${sla.sla.metric}-${sla.sla.aggregation}`}&gt;
21:             &lt;td&gt;{sla.sla.metric} ({sla.sla.aggregation})&lt;/td&gt;
22:             &lt;td style={{ fontFamily: &apos;var(--font-mono)&apos; }}&gt;
23:               {sla.sla.direction === &apos;above&apos; ? &apos;&gt;=&apos; : &apos;&lt;=&apos;} {sla.sla.target.toFixed(4)}
24:             &lt;/td&gt;
25:             &lt;td style={{ fontFamily: &apos;var(--font-mono)&apos; }}&gt;
26:               {sla.actualValue !== null ? sla.actualValue.toFixed(4) : &apos;N/A&apos;}
27:             &lt;/td&gt;
28:             &lt;td style={{
29:               fontFamily: &apos;var(--font-mono)&apos;,
30:               color: sla.gap !== null &amp;&amp; !sla.compliant ? &apos;var(--status-critical)&apos; : &apos;var(--status-healthy)&apos;,
31:             }}&gt;
32:               {sla.gap !== null ? (sla.gap &gt;= 0 ? &apos;+&apos; : &apos;&apos;) + sla.gap.toFixed(4) : &apos;-&apos;}
33:             &lt;/td&gt;
34:             &lt;td&gt;&lt;StatusBadge status={sla.status} /&gt;&lt;/td&gt;
35:           &lt;/tr&gt;
36:         ))}
37:       &lt;/tbody&gt;
38:     &lt;/table&gt;
39:   );
40: }</file><file path="src/components/Sparkline.tsx"> 1: import { memo } from &apos;react&apos;;
 2: 
 3: interface SparklineProps {
 4:   /** Array of score values (nulls allowed for gaps) */
 5:   data: (number | null)[];
 6:   /** SVG width in px */
 7:   width?: number;
 8:   /** SVG height in px */
 9:   height?: number;
10:   /** Stroke color (CSS var or hex) */
11:   color?: string;
12:   /** Accessible label for the sparkline */
13:   label?: string;
14: }
15: 
16: function SparklineInner({ data, width = 80, height = 24, color = &apos;var(--text-secondary)&apos;, label }: SparklineProps) {
17:   const values = data.filter((v): v is number =&gt; v !== null &amp;&amp; Number.isFinite(v));
18:   if (values.length &lt; 2) return null;
19: 
20:   const min = Math.min(...values);
21:   const max = Math.max(...values);
22:   const range = max - min || 1;
23:   const pad = 2;
24:   const xDenom = data.length &gt; 1 ? data.length - 1 : 1;
25: 
26:   const points = data
27:     .map((v, i) =&gt; {
28:       if (v === null || !Number.isFinite(v)) return null;
29:       const x = pad + (i / xDenom) * (width - pad * 2);
30:       const y = pad + (1 - (v - min) / range) * (height - pad * 2);
31:       return `${x},${y}`;
32:     })
33:     .filter((p): p is string =&gt; p !== null)
34:     .join(&apos; &apos;);
35: 
36:   return (
37:     &lt;svg
38:       width={width}
39:       height={height}
40:       viewBox={`0 0 ${width} ${height}`}
41:       role=&quot;img&quot;
42:       aria-label={label ?? &apos;Score trend sparkline&apos;}
43:       style={{ display: &apos;block&apos; }}
44:     &gt;
45:       &lt;polyline
46:         points={points}
47:         fill=&quot;none&quot;
48:         stroke={color}
49:         strokeWidth={1.5}
50:         strokeLinecap=&quot;round&quot;
51:         strokeLinejoin=&quot;round&quot;
52:       /&gt;
53:     &lt;/svg&gt;
54:   );
55: }
56: 
57: export const Sparkline = memo(SparklineInner);</file><file path="src/types.ts"> 1: export type {
 2:   QualityDashboardSummary,
 3:   QualityMetricResult,
 4:   QualityMetricConfig,
 5:   MetricDetailResult,
 6:   TriggeredAlert,
 7:   MetricTrend,
 8:   ConfidenceIndicator,
 9:   WorstExplanation,
10:   SLAComplianceResult,
11:   ExecutiveView,
12:   OperatorView,
13:   AuditorView,
14:   RoleView,
15:   RoleViewType,
16:   AlertSeverity,
17:   TrendDirection,
18:   PipelineResult,
19:   PipelineStage,
20:   PipelineDropoff,
21:   CoverageHeatmap,
22:   CoverageCell,
23:   CoverageGap,
24:   CoverageStatus,
25: } from &apos;../../dist/lib/quality-metrics.js&apos;;
26: 
27: export type { EvaluationResult, TraceSpan } from &apos;../../dist/backends/index.js&apos;;
28: export type { CompositeQualityIndex, CQIContribution, MetricDynamics, CorrelationFeature } from &apos;../../dist/lib/quality-feature-engineering.js&apos;;
29: export type { HandoffEvaluation, TurnLevelResult, MultiAgentEvaluation } from &apos;../../dist/lib/quality-multi-agent.js&apos;;
30: export type { HumanVerificationEvent } from &apos;../../dist/lib/verification-events.js&apos;;
31: export type { SLAEvaluationResult } from &apos;../../dist/lib/quality-sla.js&apos;;
32: 
33: export type Period = &apos;24h&apos; | &apos;7d&apos; | &apos;30d&apos;;
34: 
35: export type OverallStatus = &apos;healthy&apos; | &apos;warning&apos; | &apos;critical&apos; | &apos;no_data&apos;;</file><file path="src/vite-env.d.ts">1: /// &lt;reference types=&quot;vite/client&quot; /&gt;</file><file path="src/__tests__/f1-f6-components.test.tsx">  1: import { describe, it, expect, afterEach, vi } from &apos;vitest&apos;;
  2: import { render, screen, cleanup, fireEvent, within, act } from &apos;@testing-library/react&apos;;
  3: import { ScoreBadge } from &apos;../components/ScoreBadge.js&apos;;
  4: import { CQIHero } from &apos;../components/CQIHero.js&apos;;
  5: import { EvaluationTable, type EvalRow } from &apos;../components/EvaluationTable.js&apos;;
  6: import { CorrelationHeatmap } from &apos;../components/CorrelationHeatmap.js&apos;;
  7: import { KeyboardNavProvider, useShortcut, useKeyboardNav } from &apos;../contexts/KeyboardNavContext.js&apos;;
  8: import type { CompositeQualityIndex } from &apos;../types.js&apos;;
  9: import type { CorrelationFeature } from &apos;../types.js&apos;;
 10: 
 11: afterEach(cleanup);
 12: 
 13: // ---------------------------------------------------------------------------
 14: // ScoreBadge (F1)
 15: // ---------------------------------------------------------------------------
 16: 
 17: describe(&apos;ScoreBadge&apos;, () =&gt; {
 18:   it(&apos;renders null score as N/A with aria-label&apos;, () =&gt; {
 19:     render(&lt;ScoreBadge score={null} metricName=&quot;relevance&quot; /&gt;);
 20:     const badge = screen.getByLabelText(&apos;relevance: no data&apos;);
 21:     expect(badge).toBeInTheDocument();
 22:     expect(badge.textContent).toContain(&apos;N/A&apos;);
 23:   });
 24: 
 25:   it(&apos;renders high score with excellent band&apos;, () =&gt; {
 26:     render(&lt;ScoreBadge score={0.95} metricName=&quot;relevance&quot; direction=&quot;maximize&quot; /&gt;);
 27:     const badge = screen.getByLabelText(/Score: 0.95, excellent/);
 28:     expect(badge).toBeInTheDocument();
 29:     expect(badge.textContent).toContain(&apos;0.95&apos;);
 30:   });
 31: 
 32:   it(&apos;renders minimize direction hint&apos;, () =&gt; {
 33:     render(&lt;ScoreBadge score={0.05} metricName=&quot;hallucination&quot; direction=&quot;minimize&quot; /&gt;);
 34:     expect(screen.getByLabelText(/lower is better/)).toBeInTheDocument();
 35:   });
 36: 
 37:   it(&apos;uses custom label when provided&apos;, () =&gt; {
 38:     render(&lt;ScoreBadge score={0.85} metricName=&quot;coherence&quot; label=&quot;0.8500&quot; /&gt;);
 39:     const badge = screen.getByLabelText(/Score: 0.85/);
 40:     expect(badge.textContent).toContain(&apos;0.8500&apos;);
 41:   });
 42: 
 43:   it(&apos;renders failing band for low maximize score&apos;, () =&gt; {
 44:     render(&lt;ScoreBadge score={0.3} metricName=&quot;relevance&quot; direction=&quot;maximize&quot; /&gt;);
 45:     expect(screen.getByLabelText(/failing/)).toBeInTheDocument();
 46:   });
 47: });
 48: 
 49: // ---------------------------------------------------------------------------
 50: // CQIHero (F2)
 51: // ---------------------------------------------------------------------------
 52: 
 53: function makeCQI(overrides: Partial&lt;CompositeQualityIndex&gt; = {}): CompositeQualityIndex {
 54:   return {
 55:     value: 0.82,
 56:     featureVersion: &apos;1.0&apos;,
 57:     weights: { relevance: 0.2, coherence: 0.15, hallucination: 0.2 },
 58:     contributions: [
 59:       { metric: &apos;relevance&apos;, rawScore: 0.9, normalizedScore: 0.9, weight: 0.2, contribution: 0.18 },
 60:       { metric: &apos;coherence&apos;, rawScore: 0.85, normalizedScore: 0.85, weight: 0.15, contribution: 0.1275 },
 61:       { metric: &apos;hallucination&apos;, rawScore: 0.05, normalizedScore: 0.95, weight: 0.2, contribution: 0.19 },
 62:     ],
 63:     ...overrides,
 64:   };
 65: }
 66: 
 67: describe(&apos;CQIHero&apos;, () =&gt; {
 68:   it(&apos;renders CQI value as percentage&apos;, () =&gt; {
 69:     const { container } = render(&lt;CQIHero cqi={makeCQI()} /&gt;);
 70:     expect(container.textContent).toContain(&apos;82.0&apos;);
 71:   });
 72: 
 73:   it(&apos;has correct region role and aria-label&apos;, () =&gt; {
 74:     render(&lt;CQIHero cqi={makeCQI()} /&gt;);
 75:     const region = screen.getByRole(&apos;region&apos;);
 76:     expect(region).toHaveAttribute(&apos;aria-label&apos;, &apos;Composite Quality Index: 82.0&apos;);
 77:   });
 78: 
 79:   it(&apos;renders contribution segments with titles&apos;, () =&gt; {
 80:     const { container } = render(&lt;CQIHero cqi={makeCQI()} /&gt;);
 81:     const segments = container.querySelectorAll(&apos;[title*=&quot;weight&quot;]&apos;);
 82:     expect(segments).toHaveLength(3);
 83:   });
 84: 
 85:   it(&apos;renders screen reader table with caption&apos;, () =&gt; {
 86:     const { container } = render(&lt;CQIHero cqi={makeCQI()} /&gt;);
 87:     const caption = container.querySelector(&apos;caption&apos;);
 88:     expect(caption).toHaveTextContent(&apos;CQI Metric Breakdown&apos;);
 89:   });
 90: 
 91:   it(&apos;handles empty contributions&apos;, () =&gt; {
 92:     const { container } = render(&lt;CQIHero cqi={makeCQI({ contributions: [] })} /&gt;);
 93:     expect(container.textContent).toContain(&apos;82.0&apos;);
 94:     expect(container.querySelectorAll(&apos;[title*=&quot;weight&quot;]&apos;)).toHaveLength(0);
 95:   });
 96: });
 97: 
 98: // ---------------------------------------------------------------------------
 99: // EvaluationTable (F6)
100: // ---------------------------------------------------------------------------
101: 
102: function makeEvalRows(): EvalRow[] {
103:   return [
104:     { score: 0.95, label: &apos;excellent&apos;, explanation: &apos;Great output&apos;, evaluator: &apos;judge-1&apos;, timestamp: &apos;2026-02-17T00:00:00Z&apos; },
105:     { score: 0.5, label: &apos;partial&apos;, explanation: &apos;Needs work&apos;, evaluator: &apos;judge-1&apos;, timestamp: &apos;2026-02-16T00:00:00Z&apos; },
106:     { score: 0.1, label: &apos;hallucinated&apos;, explanation: &apos;Contains hallucination&apos;, evaluator: &apos;judge-2&apos;, timestamp: &apos;2026-02-15T00:00:00Z&apos; },
107:   ];
108: }
109: 
110: describe(&apos;EvaluationTable&apos;, () =&gt; {
111:   it(&apos;renders all evaluation rows&apos;, () =&gt; {
112:     const { container } = render(&lt;EvaluationTable evaluations={makeEvalRows()} /&gt;);
113:     const rows = container.querySelectorAll(&apos;tbody tr&apos;);
114:     expect(rows).toHaveLength(3);
115:   });
116: 
117:   it(&apos;renders score values in table cells&apos;, () =&gt; {
118:     const { container } = render(&lt;EvaluationTable evaluations={makeEvalRows()} /&gt;);
119:     expect(container.textContent).toContain(&apos;0.9500&apos;);
120:     expect(container.textContent).toContain(&apos;0.5000&apos;);
121:     expect(container.textContent).toContain(&apos;0.1000&apos;);
122:   });
123: 
124:   it(&apos;renders category filter buttons&apos;, () =&gt; {
125:     render(&lt;EvaluationTable evaluations={makeEvalRows()} /&gt;);
126:     const buttons = screen.getAllByRole(&apos;button&apos;);
127:     const labels = buttons.map(b =&gt; b.textContent);
128:     expect(labels).toContain(&apos;Pass&apos;);
129:     expect(labels).toContain(&apos;Review&apos;);
130:     expect(labels).toContain(&apos;Fail&apos;);
131:   });
132: 
133:   it(&apos;filters rows when category button clicked&apos;, () =&gt; {
134:     const { container } = render(&lt;EvaluationTable evaluations={makeEvalRows()} /&gt;);
135:     const failBtn = screen.getAllByRole(&apos;button&apos;).find(b =&gt; b.textContent === &apos;Fail&apos;)!;
136:     fireEvent.click(failBtn);
137:     const rows = container.querySelectorAll(&apos;tbody tr&apos;);
138:     expect(rows.length).toBeLessThan(3);
139:   });
140: 
141:   it(&apos;renders empty state when no evaluations&apos;, () =&gt; {
142:     const { container } = render(&lt;EvaluationTable evaluations={[]} /&gt;);
143:     expect(container.textContent).toContain(&apos;No evaluations match&apos;);
144:   });
145: 
146:   it(&apos;has sortable column headers with aria-sort&apos;, () =&gt; {
147:     const { container } = render(&lt;EvaluationTable evaluations={makeEvalRows()} /&gt;);
148:     const sortableHeaders = container.querySelectorAll(&apos;th[aria-sort]&apos;);
149:     expect(sortableHeaders.length).toBeGreaterThan(0);
150:   });
151: 
152:   it(&apos;renders expand toggle on each row&apos;, () =&gt; {
153:     render(&lt;EvaluationTable evaluations={makeEvalRows()} /&gt;);
154:     const expandBtns = screen.getAllByLabelText(&apos;Expand row&apos;);
155:     expect(expandBtns).toHaveLength(3);
156:   });
157: 
158:   it(&apos;expands row on click to show full detail&apos;, () =&gt; {
159:     const rows: EvalRow[] = [{
160:       score: 0.95,
161:       label: &apos;excellent&apos;,
162:       explanation: &apos;A very detailed explanation that should be fully visible when expanded&apos;,
163:       evaluator: &apos;judge-1&apos;,
164:       timestamp: &apos;2026-02-17T00:00:00Z&apos;,
165:       evaluatorType: &apos;llm&apos;,
166:       traceId: &apos;abc-123&apos;,
167:       sessionId: &apos;sess-456&apos;,
168:     }];
169:     const { container } = render(&lt;EvaluationTable evaluations={rows} /&gt;);
170:     const expandBtn = screen.getByLabelText(&apos;Expand row&apos;);
171:     fireEvent.click(expandBtn);
172:     expect(container.textContent).toContain(&apos;Evaluator Type&apos;);
173:     expect(container.textContent).toContain(&apos;llm&apos;);
174:     expect(container.textContent).toContain(&apos;abc-123&apos;);
175:     expect(container.textContent).toContain(&apos;sess-456&apos;);
176:   });
177: 
178:   it(&apos;collapses row on second click&apos;, () =&gt; {
179:     const rows: EvalRow[] = [{
180:       score: 0.95,
181:       label: &apos;excellent&apos;,
182:       explanation: &apos;Detail text&apos;,
183:       evaluatorType: &apos;llm&apos;,
184:       traceId: &apos;abc-123&apos;,
185:     }];
186:     const { container } = render(&lt;EvaluationTable evaluations={rows} /&gt;);
187:     const expandBtn = screen.getByLabelText(&apos;Expand row&apos;);
188:     fireEvent.click(expandBtn);
189:     expect(container.textContent).toContain(&apos;Evaluator Type&apos;);
190:     const collapseBtn = screen.getByLabelText(&apos;Collapse row&apos;);
191:     fireEvent.click(collapseBtn);
192:     expect(container.textContent).not.toContain(&apos;Evaluator Type&apos;);
193:   });
194: });
195: 
196: // ---------------------------------------------------------------------------
197: // CorrelationHeatmap (F5)
198: // ---------------------------------------------------------------------------
199: 
200: function makeCorrelations(): { correlations: CorrelationFeature[]; metrics: string[] } {
201:   const metrics = [&apos;relevance&apos;, &apos;coherence&apos;, &apos;hallucination&apos;];
202:   const correlations: CorrelationFeature[] = [
203:     {
204:       metricA: &apos;relevance&apos;, metricB: &apos;coherence&apos;,
205:       pearsonR: 0.73, spearmanR: 0.7, effectSize: 0.5,
206:       pValue: 0.001, significant: true,
207:       lagHours: 0, isKnownToxicCombo: false,
208:       coOccurrenceRate: 0, causalConfidence: &apos;correlation&apos;,
209:       featureVersion: &apos;3.0&apos;,
210:     },
211:     {
212:       metricA: &apos;relevance&apos;, metricB: &apos;hallucination&apos;,
213:       pearsonR: -0.85, spearmanR: -0.82, effectSize: 0.9,
214:       pValue: 0.0001, significant: true,
215:       lagHours: 1, isKnownToxicCombo: true,
216:       coOccurrenceRate: 0.6, causalConfidence: &apos;correlation&apos;,
217:       featureVersion: &apos;3.0&apos;,
218:     },
219:     {
220:       metricA: &apos;coherence&apos;, metricB: &apos;hallucination&apos;,
221:       pearsonR: -0.45, spearmanR: -0.4, effectSize: 0.3,
222:       pValue: 0.05, significant: false,
223:       lagHours: 0, isKnownToxicCombo: false,
224:       coOccurrenceRate: 0, causalConfidence: &apos;correlation&apos;,
225:       featureVersion: &apos;3.0&apos;,
226:     },
227:   ];
228:   return { correlations, metrics };
229: }
230: 
231: describe(&apos;CorrelationHeatmap&apos;, () =&gt; {
232:   it(&apos;renders table with correct role&apos;, () =&gt; {
233:     const { correlations, metrics } = makeCorrelations();
234:     const { container } = render(&lt;CorrelationHeatmap correlations={correlations} metrics={metrics} /&gt;);
235:     expect(container.querySelector(&apos;[role=&quot;table&quot;]&apos;)).toBeInTheDocument();
236:   });
237: 
238:   it(&apos;renders column headers&apos;, () =&gt; {
239:     const { correlations, metrics } = makeCorrelations();
240:     const { container } = render(&lt;CorrelationHeatmap correlations={correlations} metrics={metrics} /&gt;);
241:     const headers = container.querySelectorAll(&apos;[role=&quot;columnheader&quot;]&apos;);
242:     expect(headers).toHaveLength(3);
243:   });
244: 
245:   it(&apos;renders diagonal cells as 1.00&apos;, () =&gt; {
246:     const { correlations, metrics } = makeCorrelations();
247:     const { container } = render(&lt;CorrelationHeatmap correlations={correlations} metrics={metrics} /&gt;);
248:     // Diagonal cells have aria-label like &quot;relevance vs relevance: 1.00&quot;
249:     const allCells = container.querySelectorAll(&apos;[role=&quot;cell&quot;]&apos;);
250:     let diagCount = 0;
251:     allCells.forEach(cell =&gt; {
252:       if (cell.textContent === &apos;1.00&apos;) diagCount++;
253:     });
254:     expect(diagCount).toBe(3);
255:   });
256: 
257:   it(&apos;renders off-diagonal correlation values&apos;, () =&gt; {
258:     const { correlations, metrics } = makeCorrelations();
259:     const { container } = render(&lt;CorrelationHeatmap correlations={correlations} metrics={metrics} /&gt;);
260:     expect(container.textContent).toContain(&apos;0.73&apos;);
261:     expect(container.textContent).toContain(&apos;-0.85&apos;);
262:   });
263: 
264:   it(&apos;renders cells with aria-labels&apos;, () =&gt; {
265:     const { correlations, metrics } = makeCorrelations();
266:     const { container } = render(&lt;CorrelationHeatmap correlations={correlations} metrics={metrics} /&gt;);
267:     const cell = container.querySelector(&apos;[aria-label*=&quot;relevance vs coherence&quot;]&apos;);
268:     expect(cell).toBeInTheDocument();
269:   });
270: 
271:   it(&apos;applies toxic border styling&apos;, () =&gt; {
272:     const { correlations, metrics } = makeCorrelations();
273:     const { container } = render(&lt;CorrelationHeatmap correlations={correlations} metrics={metrics} /&gt;);
274:     const toxicCells = container.querySelectorAll(&apos;[style*=&quot;2px solid&quot;]&apos;);
275:     expect(toxicCells.length).toBeGreaterThanOrEqual(2);
276:   });
277: });
278: 
279: // ---------------------------------------------------------------------------
280: // KeyboardNavContext — regression tests for infinite re-render fix
281: // ---------------------------------------------------------------------------
282: 
283: function ShortcutConsumer({ shortcutKey, desc }: { shortcutKey: string; desc: string }) {
284:   const action = vi.fn();
285:   useShortcut(shortcutKey, desc, &apos;test&apos;, action);
286:   return &lt;div data-testid=&quot;consumer&quot;&gt;{desc}&lt;/div&gt;;
287: }
288: 
289: describe(&apos;KeyboardNavProvider&apos;, () =&gt; {
290:   it(&apos;renders children without infinite loop&apos;, () =&gt; {
291:     const { getByTestId } = render(
292:       &lt;KeyboardNavProvider&gt;
293:         &lt;ShortcutConsumer shortcutKey=&quot;h&quot; desc=&quot;Go home&quot; /&gt;
294:       &lt;/KeyboardNavProvider&gt;,
295:     );
296:     expect(getByTestId(&apos;consumer&apos;)).toBeInTheDocument();
297:   });
298: 
299:   it(&apos;registers multiple shortcuts without loop&apos;, () =&gt; {
300:     const { getAllByTestId } = render(
301:       &lt;KeyboardNavProvider&gt;
302:         &lt;ShortcutConsumer shortcutKey=&quot;h&quot; desc=&quot;Go home&quot; /&gt;
303:         &lt;ShortcutConsumer shortcutKey=&quot;s&quot; desc=&quot;Search&quot; /&gt;
304:         &lt;ShortcutConsumer shortcutKey=&quot;?&quot; desc=&quot;Help&quot; /&gt;
305:       &lt;/KeyboardNavProvider&gt;,
306:     );
307:     expect(getAllByTestId(&apos;consumer&apos;)).toHaveLength(3);
308:   });
309: 
310:   it(&apos;useKeyboardNav throws outside provider&apos;, () =&gt; {
311:     function Orphan() {
312:       useKeyboardNav();
313:       return null;
314:     }
315:     expect(() =&gt; render(&lt;Orphan /&gt;)).toThrow(&apos;useKeyboardNav must be used within KeyboardNavProvider&apos;);
316:   });
317: 
318:   it(&apos;fires shortcut action on keydown&apos;, () =&gt; {
319:     const action = vi.fn();
320:     function ActionConsumer() {
321:       useShortcut(&apos;x&apos;, &apos;Test action&apos;, &apos;test&apos;, action);
322:       return null;
323:     }
324:     render(
325:       &lt;KeyboardNavProvider&gt;
326:         &lt;ActionConsumer /&gt;
327:       &lt;/KeyboardNavProvider&gt;,
328:     );
329:     act(() =&gt; {
330:       fireEvent.keyDown(document, { key: &apos;x&apos; });
331:     });
332:     expect(action).toHaveBeenCalledOnce();
333:   });
334: 
335:   it(&apos;toggles overlay on ? key&apos;, () =&gt; {
336:     function OverlayReader() {
337:       const { overlayOpen } = useKeyboardNav();
338:       return &lt;div data-testid=&quot;overlay&quot;&gt;{overlayOpen ? &apos;open&apos; : &apos;closed&apos;}&lt;/div&gt;;
339:     }
340:     render(
341:       &lt;KeyboardNavProvider&gt;
342:         &lt;OverlayReader /&gt;
343:       &lt;/KeyboardNavProvider&gt;,
344:     );
345:     expect(screen.getByTestId(&apos;overlay&apos;).textContent).toBe(&apos;closed&apos;);
346:     act(() =&gt; {
347:       fireEvent.keyDown(document, { key: &apos;?&apos; });
348:     });
349:     expect(screen.getByTestId(&apos;overlay&apos;).textContent).toBe(&apos;open&apos;);
350:   });
351: });</file><file path="src/__tests__/quality-utils-drift.test.ts">  1: /**
  2:  * Drift detection for dashboard/src/lib/quality-utils.ts (DR12).
  3:  *
  4:  * These tests pin the exact output of every exported function and constant
  5:  * against reference values derived from src/lib/quality-feature-engineering.ts.
  6:  * If the parent changes a threshold or mapping and quality-utils.ts is not
  7:  * updated, at least one assertion here will fail.
  8:  */
  9: 
 10: import { describe, it, expect } from &apos;vitest&apos;;
 11: import {
 12:   scoreColorBand,
 13:   inferScoreDirection,
 14:   labelToOrdinal,
 15:   ordinalToCategory,
 16:   truncateText,
 17:   ROLE_FEATURE_CONFIG,
 18:   SCORE_COLORS,
 19: } from &apos;../lib/quality-utils.js&apos;;
 20: 
 21: // ---------------------------------------------------------------------------
 22: // scoreColorBand
 23: // ---------------------------------------------------------------------------
 24: 
 25: describe(&apos;scoreColorBand&apos;, () =&gt; {
 26:   describe(&apos;maximize direction (default)&apos;, () =&gt; {
 27:     it.each&lt;[number, string]&gt;([
 28:       [1.0, &apos;excellent&apos;],
 29:       [0.95, &apos;excellent&apos;],
 30:       [0.9, &apos;excellent&apos;],   // &gt;= 0.9 threshold
 31:       [0.89, &apos;good&apos;],
 32:       [0.8, &apos;good&apos;],        // &gt;= 0.8 threshold
 33:       [0.79, &apos;adequate&apos;],
 34:       [0.6, &apos;adequate&apos;],    // &gt;= 0.6 threshold
 35:       [0.59, &apos;poor&apos;],
 36:       [0.4, &apos;poor&apos;],        // &gt;= 0.4 threshold
 37:       [0.39, &apos;failing&apos;],
 38:       [0.0, &apos;failing&apos;],
 39:     ])(&apos;score %f → %s&apos;, (score, expected) =&gt; {
 40:       expect(scoreColorBand(score, &apos;maximize&apos;)).toBe(expected);
 41:     });
 42:   });
 43: 
 44:   describe(&apos;minimize direction&apos;, () =&gt; {
 45:     it.each&lt;[number, string]&gt;([
 46:       [0.0, &apos;excellent&apos;],   // 1 - 0.0 = 1.0 &gt;= 0.9
 47:       [0.1, &apos;excellent&apos;],   // 1 - 0.1 = 0.9 &gt;= 0.9
 48:       [0.11, &apos;good&apos;],       // 1 - 0.11 = 0.89 &gt;= 0.8
 49:       [0.2, &apos;good&apos;],        // 1 - 0.2 = 0.8 &gt;= 0.8
 50:       [0.4, &apos;adequate&apos;],    // 1 - 0.4 = 0.6 &gt;= 0.6
 51:       [0.6, &apos;poor&apos;],        // 1 - 0.6 = 0.4 &gt;= 0.4
 52:       [0.61, &apos;failing&apos;],    // 1 - 0.61 = 0.39
 53:     ])(&apos;score %f → %s&apos;, (score, expected) =&gt; {
 54:       expect(scoreColorBand(score, &apos;minimize&apos;)).toBe(expected);
 55:     });
 56:   });
 57: 
 58:   it(&apos;defaults to maximize when direction omitted&apos;, () =&gt; {
 59:     expect(scoreColorBand(0.95)).toBe(&apos;excellent&apos;);
 60:     expect(scoreColorBand(0.5)).toBe(&apos;poor&apos;);
 61:   });
 62: });
 63: 
 64: // ---------------------------------------------------------------------------
 65: // inferScoreDirection
 66: // ---------------------------------------------------------------------------
 67: 
 68: describe(&apos;inferScoreDirection&apos;, () =&gt; {
 69:   it(&apos;above → minimize&apos;, () =&gt; {
 70:     expect(inferScoreDirection(&apos;above&apos;)).toBe(&apos;minimize&apos;);
 71:   });
 72: 
 73:   it(&apos;below → maximize&apos;, () =&gt; {
 74:     expect(inferScoreDirection(&apos;below&apos;)).toBe(&apos;maximize&apos;);
 75:   });
 76: 
 77:   it(&apos;undefined → maximize&apos;, () =&gt; {
 78:     expect(inferScoreDirection(undefined)).toBe(&apos;maximize&apos;);
 79:   });
 80: });
 81: 
 82: // ---------------------------------------------------------------------------
 83: // labelToOrdinal
 84: // ---------------------------------------------------------------------------
 85: 
 86: describe(&apos;labelToOrdinal&apos;, () =&gt; {
 87:   it.each([
 88:     [&apos;excellent&apos;, 4, &apos;Pass&apos;],
 89:     [&apos;highly_relevant&apos;, 4, &apos;Pass&apos;],
 90:     [&apos;fully_faithful&apos;, 4, &apos;Pass&apos;],
 91:     [&apos;perfect&apos;, 4, &apos;Pass&apos;],
 92:     [&apos;relevant&apos;, 3, &apos;Pass&apos;],
 93:     [&apos;good&apos;, 3, &apos;Pass&apos;],
 94:     [&apos;faithful&apos;, 3, &apos;Pass&apos;],
 95:     [&apos;pass&apos;, 3, &apos;Pass&apos;],
 96:     [&apos;correct&apos;, 3, &apos;Pass&apos;],
 97:     [&apos;coherent&apos;, 3, &apos;Pass&apos;],
 98:     [&apos;partial&apos;, 2, &apos;Review&apos;],
 99:     [&apos;borderline&apos;, 2, &apos;Review&apos;],
100:     [&apos;adequate&apos;, 2, &apos;Review&apos;],
101:     [&apos;mixed&apos;, 2, &apos;Review&apos;],
102:     [&apos;off_topic&apos;, 1, &apos;Fail&apos;],
103:     [&apos;irrelevant&apos;, 1, &apos;Fail&apos;],
104:     [&apos;unfaithful&apos;, 1, &apos;Fail&apos;],
105:     [&apos;fail&apos;, 1, &apos;Fail&apos;],
106:     [&apos;incorrect&apos;, 1, &apos;Fail&apos;],
107:     [&apos;incoherent&apos;, 1, &apos;Fail&apos;],
108:     [&apos;hallucinated&apos;, 0, &apos;Fail&apos;],
109:     [&apos;fabricated&apos;, 0, &apos;Fail&apos;],
110:     [&apos;toxic&apos;, 0, &apos;Fail&apos;],
111:     [&apos;dangerous&apos;, 0, &apos;Fail&apos;],
112:   ] as [string, number, string][])(&apos;&quot;%s&quot; → ordinal %i, category %s&apos;, (label, ordinal, category) =&gt; {
113:     const result = labelToOrdinal(label);
114:     expect(result.ordinal).toBe(ordinal);
115:     expect(result.category).toBe(category);
116:     expect(result.mapped).toBe(true);
117:   });
118: 
119:   it(&apos;normalizes case and hyphens&apos;, () =&gt; {
120:     expect(labelToOrdinal(&apos;EXCELLENT&apos;).ordinal).toBe(4);
121:     expect(labelToOrdinal(&apos;highly-relevant&apos;).ordinal).toBe(4);
122:     expect(labelToOrdinal(&apos;Fully_Faithful&apos;).ordinal).toBe(4);
123:   });
124: 
125:   it(&apos;unknown label → ordinal 2, Review, mapped false&apos;, () =&gt; {
126:     const result = labelToOrdinal(&apos;unknown_label&apos;);
127:     expect(result).toEqual({ ordinal: 2, category: &apos;Review&apos;, mapped: false });
128:   });
129: });
130: 
131: // ---------------------------------------------------------------------------
132: // ordinalToCategory
133: // ---------------------------------------------------------------------------
134: 
135: describe(&apos;ordinalToCategory&apos;, () =&gt; {
136:   it.each&lt;[number, string]&gt;([
137:     [4, &apos;Pass&apos;],
138:     [3, &apos;Pass&apos;],
139:     [2, &apos;Review&apos;],
140:     [1, &apos;Fail&apos;],
141:     [0, &apos;Fail&apos;],
142:   ])(&apos;ordinal %i → %s&apos;, (ordinal, expected) =&gt; {
143:     expect(ordinalToCategory(ordinal)).toBe(expected);
144:   });
145: });
146: 
147: // ---------------------------------------------------------------------------
148: // SCORE_COLORS
149: // ---------------------------------------------------------------------------
150: 
151: describe(&apos;SCORE_COLORS&apos;, () =&gt; {
152:   it(&apos;has all required bands&apos;, () =&gt; {
153:     const bands = [&apos;excellent&apos;, &apos;good&apos;, &apos;adequate&apos;, &apos;poor&apos;, &apos;failing&apos;, &apos;no_data&apos;] as const;
154:     for (const band of bands) {
155:       expect(SCORE_COLORS[band]).toMatch(/^#[0-9a-f]{6}$/i);
156:     }
157:   });
158: 
159:   it(&apos;pins exact color values (drift sentinel)&apos;, () =&gt; {
160:     expect(SCORE_COLORS.excellent).toBe(&apos;#26d97f&apos;);
161:     expect(SCORE_COLORS.good).toBe(&apos;#34d399&apos;);
162:     expect(SCORE_COLORS.adequate).toBe(&apos;#e5a00d&apos;);
163:     expect(SCORE_COLORS.poor).toBe(&apos;#f97316&apos;);
164:     expect(SCORE_COLORS.failing).toBe(&apos;#f04438&apos;);
165:     expect(SCORE_COLORS.no_data).toBe(&apos;#6b7280&apos;);
166:   });
167: });
168: 
169: // ---------------------------------------------------------------------------
170: // ROLE_FEATURE_CONFIG shape (sentinel)
171: // ---------------------------------------------------------------------------
172: 
173: describe(&apos;ROLE_FEATURE_CONFIG&apos;, () =&gt; {
174:   const roles = [&apos;executive&apos;, &apos;operator&apos;, &apos;auditor&apos;] as const;
175: 
176:   it(&apos;has all three roles&apos;, () =&gt; {
177:     for (const role of roles) {
178:       expect(ROLE_FEATURE_CONFIG[role]).toBeDefined();
179:     }
180:   });
181: 
182:   it(&apos;executive hides variance and operator controls&apos;, () =&gt; {
183:     expect(ROLE_FEATURE_CONFIG.executive.showVariance).toBe(false);
184:     expect(ROLE_FEATURE_CONFIG.executive.showAcceleration).toBe(false);
185:     expect(ROLE_FEATURE_CONFIG.executive.showRawExport).toBe(false);
186:     expect(ROLE_FEATURE_CONFIG.executive.maxWorstEvaluations).toBe(1);
187:   });
188: 
189:   it(&apos;operator shows operational metrics&apos;, () =&gt; {
190:     expect(ROLE_FEATURE_CONFIG.operator.showVariance).toBe(true);
191:     expect(ROLE_FEATURE_CONFIG.operator.showCorrelationRemediation).toBe(true);
192:     expect(ROLE_FEATURE_CONFIG.operator.showCoverageHeatmap).toBe(true);
193:     expect(ROLE_FEATURE_CONFIG.operator.maxWorstEvaluations).toBe(5);
194:   });
195: 
196:   it(&apos;auditor has full access with raw export&apos;, () =&gt; {
197:     expect(ROLE_FEATURE_CONFIG.auditor.showProvenance).toBe(true);
198:     expect(ROLE_FEATURE_CONFIG.auditor.showRawExport).toBe(true);
199:     expect(ROLE_FEATURE_CONFIG.auditor.maxWorstEvaluations).toBe(10);
200:     expect(ROLE_FEATURE_CONFIG.auditor.explanationTruncation).toBe(2000);
201:   });
202: });
203: 
204: // ---------------------------------------------------------------------------
205: // truncateText
206: // ---------------------------------------------------------------------------
207: 
208: describe(&apos;truncateText&apos;, () =&gt; {
209:   it(&apos;returns original text when under limit&apos;, () =&gt; {
210:     expect(truncateText(&apos;hello&apos;, 10)).toBe(&apos;hello&apos;);
211:   });
212: 
213:   it(&apos;truncates at max and appends ellipsis&apos;, () =&gt; {
214:     expect(truncateText(&apos;hello world&apos;, 5)).toBe(&apos;hello...&apos;);
215:   });
216: 
217:   it(&apos;returns original when exactly at limit&apos;, () =&gt; {
218:     expect(truncateText(&apos;hello&apos;, 5)).toBe(&apos;hello&apos;);
219:   });
220: });</file><file path="src/__tests__/setup.ts"> 1: import &apos;@testing-library/jest-dom/vitest&apos;;
 2: 
 3: // Recharts uses ResizeObserver — provide a minimal stub for jsdom
 4: if (typeof window !== &apos;undefined&apos; &amp;&amp; !(&apos;ResizeObserver&apos; in window)) {
 5:   (window as unknown as Record&lt;string, unknown&gt;).ResizeObserver = class {
 6:     observe() {}
 7:     unobserve() {}
 8:     disconnect() {}
 9:   };
10: }</file><file path="src/api/routes/evaluations.ts"> 1: import { Hono } from &apos;hono&apos;;
 2: import { z } from &apos;zod&apos;;
 3: import { sanitizeErrorForResponse } from &apos;../../../../dist/lib/error-sanitizer.js&apos;;
 4: import { HttpStatus } from &apos;../../lib/constants.js&apos;;
 5: import { loadEvaluationsByTraceId } from &apos;../data-loader.js&apos;;
 6: 
 7: const TraceIdSchema = z.string().min(1).max(256);
 8: 
 9: export const evaluationRoutes = new Hono();
10: 
11: evaluationRoutes.get(&apos;/evaluations/trace/:traceId&apos;, async (c) =&gt; {
12:   const parseResult = TraceIdSchema.safeParse(c.req.param(&apos;traceId&apos;));
13:   if (!parseResult.success) {
14:     return c.json({ error: &apos;Invalid traceId&apos; }, HttpStatus.BadRequest);
15:   }
16: 
17:   try {
18:     const evaluations = await loadEvaluationsByTraceId(parseResult.data);
19:     return c.json({ evaluations });
20:   } catch (err) {
21:     return c.json({ error: sanitizeErrorForResponse(err) }, HttpStatus.InternalServerError);
22:   }
23: });</file><file path="src/components/AlertList.tsx">  1: import { Link } from &apos;wouter&apos;;
  2: import type { TriggeredAlert } from &apos;../types.js&apos;;
  3: 
  4: type AlertWithMeta = TriggeredAlert &amp; { metricName?: string };
  5: 
  6: function SimpleAlertItem({ alert }: { alert: AlertWithMeta }) {
  7:   return (
  8:     &lt;li className={`alert-item ${alert.severity}`}&gt;
  9:       &lt;div className=&quot;alert-message&quot;&gt;{alert.message}&lt;/div&gt;
 10:       &lt;div className=&quot;alert-meta text-secondary text-xs&quot;&gt;
 11:         {alert.aggregation} = {alert.actualValue?.toFixed(4)} (threshold: {alert.threshold?.toFixed(4)})
 12:       &lt;/div&gt;
 13:       {alert.remediationHints &amp;&amp; alert.remediationHints.length &gt; 0 &amp;&amp; (
 14:         &lt;div className=&quot;remediation text-xs&quot;&gt;
 15:           Hint: {alert.remediationHints[0]}
 16:         &lt;/div&gt;
 17:       )}
 18:     &lt;/li&gt;
 19:   );
 20: }
 21: 
 22: function ThresholdBar({ actual, threshold, direction }: {
 23:   actual: number;
 24:   threshold: number;
 25:   direction: &apos;above&apos; | &apos;below&apos;;
 26: }) {
 27:   const max = Math.max(actual, threshold) * 1.2 || 1;
 28:   const actualPct = Math.max(0, Math.min((actual / max) * 100, 100));
 29:   const thresholdPct = Math.max(0, Math.min((threshold / max) * 100, 100));
 30:   const isViolating = direction === &apos;below&apos; ? actual &lt; threshold : actual &gt; threshold;
 31: 
 32:   return (
 33:     &lt;div className=&quot;threshold-bar&quot; aria-label={`Actual: ${actual.toFixed(4)}, Threshold: ${threshold.toFixed(4)}`}&gt;
 34:       &lt;div
 35:         className=&quot;threshold-bar-fill&quot;
 36:         style={{
 37:           width: `${actualPct}%`,
 38:           background: isViolating ? &apos;var(--status-critical)&apos; : &apos;var(--status-healthy)&apos;,
 39:         }}
 40:       /&gt;
 41:       &lt;div
 42:         className=&quot;threshold-bar-marker&quot;
 43:         style={{ left: `${thresholdPct}%` }}
 44:         title={`Threshold: ${threshold.toFixed(4)}`}
 45:       /&gt;
 46:     &lt;/div&gt;
 47:   );
 48: }
 49: 
 50: function CompoundAlertCard({ alert }: { alert: AlertWithMeta }) {
 51:   return (
 52:     &lt;li className={`alert-item alert-compound ${alert.severity}`}&gt;
 53:       &lt;div className=&quot;alert-message&quot;&gt;{alert.message}&lt;/div&gt;
 54:       &lt;div className=&quot;alert-meta text-secondary text-xs&quot;&gt;
 55:         {alert.aggregation} = {alert.actualValue?.toFixed(4)} (threshold: {alert.threshold?.toFixed(4)})
 56:       &lt;/div&gt;
 57: 
 58:       &lt;ThresholdBar
 59:         actual={alert.actualValue}
 60:         threshold={alert.threshold}
 61:         direction={alert.direction}
 62:       /&gt;
 63: 
 64:       {alert.remediationHints &amp;&amp; alert.remediationHints.length &gt; 0 &amp;&amp; (
 65:         &lt;ol className=&quot;remediation-list text-xs&quot;&gt;
 66:           {alert.remediationHints.map((hint, i) =&gt; (
 67:             &lt;li key={i}&gt;{hint}&lt;/li&gt;
 68:           ))}
 69:         &lt;/ol&gt;
 70:       )}
 71: 
 72:       {alert.relatedMetrics &amp;&amp; alert.relatedMetrics.length &gt; 0 &amp;&amp; (
 73:         &lt;div className=&quot;alert-related&quot;&gt;
 74:           &lt;span className=&quot;text-secondary text-xs&quot;&gt;Related:&lt;/span&gt;
 75:           {alert.relatedMetrics.map((m) =&gt; (
 76:             &lt;Link key={m} href={`/metrics/${m}`} className=&quot;alert-metric-link text-xs&quot;&gt;
 77:               {m}
 78:             &lt;/Link&gt;
 79:           ))}
 80:         &lt;/div&gt;
 81:       )}
 82:     &lt;/li&gt;
 83:   );
 84: }
 85: 
 86: export function AlertList({ alerts }: { alerts: AlertWithMeta[] }) {
 87:   if (alerts.length === 0) return null;
 88: 
 89:   const sorted = [...alerts].sort((a, b) =&gt; {
 90:     const order = { critical: 0, warning: 1, info: 2 };
 91:     return (order[a.severity as keyof typeof order] ?? 2) - (order[b.severity as keyof typeof order] ?? 2);
 92:   });
 93: 
 94:   return (
 95:     &lt;ul className=&quot;alert-list&quot;&gt;
 96:       {sorted.map((alert, i) =&gt;
 97:         alert.isCompound
 98:           ? &lt;CompoundAlertCard key={`${alert.message}-${i}`} alert={alert} /&gt;
 99:           : &lt;SimpleAlertItem key={`${alert.message}-${i}`} alert={alert} /&gt;
100:       )}
101:     &lt;/ul&gt;
102:   );
103: }</file><file path="src/components/Indicators.tsx"> 1: import type { MetricTrend, ConfidenceIndicator } from &apos;../types.js&apos;;
 2: 
 3: const STATUS_SHAPES: Record&lt;string, string&gt; = {
 4:   healthy: &apos;\u25CF&apos;,   // ●
 5:   warning: &apos;\u25B2&apos;,   // ▲
 6:   critical: &apos;\u25A0&apos;,  // ■
 7:   no_data: &apos;\u25CB&apos;,   // ○
 8: };
 9: 
10: export function StatusBadge({ status }: { status: string }) {
11:   const shape = STATUS_SHAPES[status] ?? STATUS_SHAPES.no_data;
12:   return (
13:     &lt;span className={`status-badge text-xs ${status}`} aria-label={`Status: ${status}`}&gt;
14:       {shape} {status}
15:     &lt;/span&gt;
16:   );
17: }
18: 
19: export function TrendIndicator({ trend }: { trend?: MetricTrend }) {
20:   if (!trend) return null;
21:   const arrow = trend.direction === &apos;improving&apos; ? &apos;\u2191&apos; : trend.direction === &apos;degrading&apos; ? &apos;\u2193&apos; : &apos;\u2192&apos;;
22:   const pct = trend.percentChange ?? 0;
23:   const sign = pct &gt; 0 ? &apos;+&apos; : &apos;&apos;;
24:   return (
25:     &lt;span className={`trend ${trend.direction}`} aria-label={`Trend: ${trend.direction}, ${sign}${pct.toFixed(1)}%`}&gt;
26:       {arrow} {sign}{pct.toFixed(1)}%
27:       {trend.lowSampleWarning &amp;&amp; &lt;span title=&quot;Low sample count&quot;&gt; *&lt;/span&gt;}
28:     &lt;/span&gt;
29:   );
30: }
31: 
32: const CONFIDENCE_SYMBOLS: Record&lt;string, string&gt; = {
33:   high: &apos;\u25CF&apos;,   // ●
34:   medium: &apos;\u25D0&apos;, // ◐
35:   low: &apos;\u25CB&apos;,    // ○
36: };
37: 
38: export function ConfidenceBadge({ confidence }: { confidence?: ConfidenceIndicator }) {
39:   if (!confidence) return null;
40:   const symbol = CONFIDENCE_SYMBOLS[confidence.level] ?? &apos;\u25CB&apos;;
41:   return (
42:     &lt;span className=&quot;text-secondary text-xs&quot; aria-label={`Confidence: ${confidence.level}`}&gt;
43:       {symbol} {confidence.level}
44:     &lt;/span&gt;
45:   );
46: }</file><file path="src/components/Layout.tsx"> 1: import type { ReactNode } from &apos;react&apos;;
 2: import type { Period } from &apos;../types.js&apos;;
 3: import { ShortcutOverlay } from &apos;./ShortcutOverlay.js&apos;;
 4: 
 5: const PERIODS: Period[] = [&apos;24h&apos;, &apos;7d&apos;, &apos;30d&apos;];
 6: 
 7: export function Layout({
 8:   period,
 9:   onPeriodChange,
10:   children,
11: }: {
12:   period: Period;
13:   onPeriodChange: (p: Period) =&gt; void;
14:   children: ReactNode;
15: }) {
16:   return (
17:     &lt;div className=&quot;dashboard-container&quot;&gt;
18:       &lt;div className=&quot;header&quot;&gt;
19:         &lt;h1&gt;Quality Metrics&lt;/h1&gt;
20:         &lt;div className=&quot;period-selector&quot;&gt;
21:           {PERIODS.map((p) =&gt; (
22:             &lt;button
23:               key={p}
24:               className={`period-btn ${p === period ? &apos;active&apos; : &apos;&apos;}`}
25:               onClick={() =&gt; onPeriodChange(p)}
26:             &gt;
27:               {p}
28:             &lt;/button&gt;
29:           ))}
30:         &lt;/div&gt;
31:       &lt;/div&gt;
32:       {children}
33:       &lt;ShortcutOverlay /&gt;
34:     &lt;/div&gt;
35:   );
36: }</file><file path="src/components/MetaItem.tsx"> 1: export function MetaItem({ label, value }: { label: string; value?: string | number }) {
 2:   if (value == null) return null;
 3:   return (
 4:     &lt;div style={{ minWidth: 120 }}&gt;
 5:       &lt;div className=&quot;section-label mb-1&quot;&gt;{label}&lt;/div&gt;
 6:       &lt;div className=&quot;mono-xs&quot; style={{ marginTop: 2, wordBreak: &apos;break-all&apos; }}&gt;
 7:         {value}
 8:       &lt;/div&gt;
 9:     &lt;/div&gt;
10:   );
11: }</file><file path="src/components/MetricGrid.tsx"> 1: import type { QualityMetricResult } from &apos;../types.js&apos;;
 2: import { MetricCard } from &apos;./MetricCard.js&apos;;
 3: 
 4: export function MetricGrid({ metrics, sparklines }: {
 5:   metrics: QualityMetricResult[];
 6:   sparklines?: Record&lt;string, (number | null)[]&gt;;
 7: }) {
 8:   return (
 9:     &lt;div className=&quot;metric-grid&quot;&gt;
10:       {metrics.map((m) =&gt; (
11:         &lt;MetricCard key={m.name} metric={m} sparklineData={sparklines?.[m.name]} /&gt;
12:       ))}
13:     &lt;/div&gt;
14:   );
15: }
16: 
17: export function MetricGridSkeleton() {
18:   return (
19:     &lt;div className=&quot;metric-grid&quot;&gt;
20:       {Array.from({ length: 7 }, (_, i) =&gt; (
21:         &lt;div key={i} className=&quot;card skeleton&quot; style={{ height: 180 }} /&gt;
22:       ))}
23:     &lt;/div&gt;
24:   );
25: }</file><file path="src/components/PageShell.tsx"> 1: import { type ReactNode } from &apos;react&apos;;
 2: import { Link } from &apos;wouter&apos;;
 3: 
 4: interface PageShellProps {
 5:   isLoading: boolean;
 6:   error: Error | null | undefined;
 7:   skeletonHeight?: number;
 8:   children: ReactNode;
 9: }
10: 
11: export function PageShell({ isLoading, error, skeletonHeight = 300, children }: PageShellProps) {
12:   return (
13:     &lt;div&gt;
14:       &lt;Link href=&quot;/&quot; className=&quot;back-link&quot;&gt;&amp;larr; Back to dashboard&lt;/Link&gt;
15:       {isLoading &amp;&amp; &lt;div className=&quot;card skeleton&quot; style={{ height: skeletonHeight }} /&gt;}
16:       {!isLoading &amp;&amp; error != null &amp;&amp; (
17:         &lt;div className=&quot;error-state&quot;&gt;&lt;h2&gt;Failed to load&lt;/h2&gt;&lt;p&gt;{error.message}&lt;/p&gt;&lt;/div&gt;
18:       )}
19:       {!isLoading &amp;&amp; error == null &amp;&amp; children}
20:     &lt;/div&gt;
21:   );
22: }</file><file path="src/main.tsx"> 1: import { createRoot } from &apos;react-dom/client&apos;;
 2: import { QueryClient, QueryClientProvider } from &apos;@tanstack/react-query&apos;;
 3: import { ErrorBoundary } from &apos;react-error-boundary&apos;;
 4: import { App } from &apos;./App.js&apos;;
 5: import &apos;./theme.css&apos;;
 6: 
 7: const queryClient = new QueryClient({
 8:   defaultOptions: {
 9:     queries: {
10:       refetchOnWindowFocus: false,
11:     },
12:   },
13: });
14: 
15: function ErrorFallback({ error, resetErrorBoundary }: { error: Error; resetErrorBoundary: () =&gt; void }) {
16:   return (
17:     &lt;div className=&quot;dashboard-container&quot;&gt;
18:       &lt;div className=&quot;error-state&quot;&gt;
19:         &lt;h2&gt;Something went wrong&lt;/h2&gt;
20:         &lt;p&gt;{error.message}&lt;/p&gt;
21:         &lt;button onClick={resetErrorBoundary} style={{ marginTop: 12, padding: &apos;6px 16px&apos;, cursor: &apos;pointer&apos; }}&gt;
22:           Try again
23:         &lt;/button&gt;
24:       &lt;/div&gt;
25:     &lt;/div&gt;
26:   );
27: }
28: 
29: createRoot(document.getElementById(&apos;root&apos;)!).render(
30:   &lt;ErrorBoundary FallbackComponent={ErrorFallback}&gt;
31:     &lt;QueryClientProvider client={queryClient}&gt;
32:       &lt;App /&gt;
33:     &lt;/QueryClientProvider&gt;
34:   &lt;/ErrorBoundary&gt;
35: );</file><file path="src/api/routes/correlations.ts"> 1: import { Hono } from &apos;hono&apos;;
 2: import { computeCorrelationMatrix } from &apos;../../../../dist/lib/quality-feature-engineering.js&apos;;
 3: import { sanitizeErrorForResponse } from &apos;../../../../dist/lib/error-sanitizer.js&apos;;
 4: import { loadEvaluationsByMetric } from &apos;../data-loader.js&apos;;
 5: import { PeriodSchema, PERIOD_MS, ErrorMessage, HttpStatus } from &apos;../../lib/constants.js&apos;;
 6: 
 7: export const correlationRoutes = new Hono();
 8: 
 9: correlationRoutes.get(&apos;/correlations&apos;, async (c) =&gt; {
10:   const periodResult = PeriodSchema.safeParse(c.req.query(&apos;period&apos;));
11:   if (!periodResult.success) {
12:     return c.json({ error: ErrorMessage.InvalidPeriod }, HttpStatus.BadRequest);
13:   }
14: 
15:   try {
16:     const now = new Date();
17:     const periodMs = PERIOD_MS[periodResult.data] ?? PERIOD_MS[&apos;30d&apos;];
18:     const start = new Date(now.getTime() - periodMs);
19:     const evaluationsByMetric = await loadEvaluationsByMetric(start.toISOString(), now.toISOString());
20: 
21:     const metricTimeSeries = new Map&lt;string, number[]&gt;();
22:     const metricNames: string[] = [];
23:     for (const [name, evals] of evaluationsByMetric) {
24:       metricTimeSeries.set(name, evals.filter(e =&gt; e.scoreValue != null).map(e =&gt; e.scoreValue!));
25:       metricNames.push(name);
26:     }
27: 
28:     const correlations = computeCorrelationMatrix(metricTimeSeries);
29:     return c.json({ correlations, metrics: metricNames });
30:   } catch (err) {
31:     return c.json({ error: sanitizeErrorForResponse(err) }, HttpStatus.InternalServerError);
32:   }
33: });</file><file path="src/api/routes/pipeline.ts"> 1: import { Hono } from &apos;hono&apos;;
 2: import {
 3:   computePipelineView,
 4:   computeDashboardSummary,
 5: } from &apos;../../../../dist/lib/quality-metrics.js&apos;;
 6: import { sanitizeErrorForResponse } from &apos;../../../../dist/lib/error-sanitizer.js&apos;;
 7: import { loadEvaluationsByMetric } from &apos;../data-loader.js&apos;;
 8: import { PeriodSchema, PERIOD_MS, ErrorMessage, HttpStatus } from &apos;../../lib/constants.js&apos;;
 9: 
10: export const pipelineRoutes = new Hono();
11: 
12: /**
13:  * GET /api/pipeline
14:  * Returns pipeline funnel: 4-stage evaluation flow with drop-off metrics.
15:  *
16:  * Query params:
17:  *   period: &apos;24h&apos; | &apos;7d&apos; | &apos;30d&apos; (default: &apos;7d&apos;)
18:  */
19: pipelineRoutes.get(&apos;/pipeline&apos;, async (c) =&gt; {
20:   const periodResult = PeriodSchema.safeParse(c.req.query(&apos;period&apos;));
21:   if (!periodResult.success) {
22:     return c.json({ error: ErrorMessage.InvalidPeriod }, HttpStatus.BadRequest);
23:   }
24: 
25:   try {
26:     const now = new Date();
27:     const period = periodResult.data;
28:     const periodMs = PERIOD_MS[period] ?? PERIOD_MS[&apos;7d&apos;];
29:     const start = new Date(now.getTime() - periodMs);
30: 
31:     const evaluationsByMetric = await loadEvaluationsByMetric(
32:       start.toISOString(),
33:       now.toISOString(),
34:     );
35: 
36:     const dashboard = computeDashboardSummary(evaluationsByMetric);
37:     const pipeline = computePipelineView(evaluationsByMetric, dashboard);
38: 
39:     return c.json({ period, ...pipeline });
40:   } catch (err) {
41:     return c.json({ error: sanitizeErrorForResponse(err) }, HttpStatus.InternalServerError);
42:   }
43: });</file><file path="src/api/routes/traces.ts"> 1: import { Hono } from &apos;hono&apos;;
 2: import { sanitizeErrorForResponse } from &apos;../../../../dist/lib/error-sanitizer.js&apos;;
 3: import { HttpStatus } from &apos;../../lib/constants.js&apos;;
 4: import { loadTracesByTraceId, loadEvaluationsByTraceId } from &apos;../data-loader.js&apos;;
 5: 
 6: export const traceRoutes = new Hono();
 7: 
 8: /**
 9:  * GET /api/traces/:traceId
10:  * Returns spans + evaluations for a trace.
11:  */
12: traceRoutes.get(&apos;/traces/:traceId&apos;, async (c) =&gt; {
13:   const traceId = c.req.param(&apos;traceId&apos;);
14:   if (!traceId) {
15:     return c.json({ error: &apos;traceId is required&apos; }, HttpStatus.BadRequest);
16:   }
17: 
18:   try {
19:     const [spans, evaluations] = await Promise.all([
20:       loadTracesByTraceId(traceId),
21:       loadEvaluationsByTraceId(traceId),
22:     ]);
23: 
24:     return c.json({ traceId, spans, evaluations });
25:   } catch (err) {
26:     return c.json({ error: sanitizeErrorForResponse(err) }, HttpStatus.InternalServerError);
27:   }
28: });</file><file path="src/components/views/AuditorView.tsx"> 1: import type { AuditorView as AuditorViewType } from &apos;../../types.js&apos;;
 2: import { MetricGrid } from &apos;../MetricGrid.js&apos;;
 3: import { AlertList } from &apos;../AlertList.js&apos;;
 4: import { SLATable } from &apos;../SLATable.js&apos;;
 5: import { StatCard } from &apos;../StatCard.js&apos;;
 6: import { ViewSection } from &apos;../Section.js&apos;;
 7: 
 8: export function AuditorView({ data }: { data: AuditorViewType }) {
 9:   return (
10:     &lt;div&gt;
11:       &lt;div style={{ display: &apos;flex&apos;, gap: &apos;var(--space-4)&apos;, marginBottom: &apos;var(--space-6)&apos; }}&gt;
12:         &lt;StatCard value={data.totalEvaluationCount} label=&quot;Total Evaluations&quot; /&gt;
13:         &lt;StatCard value={data.metrics.length} label=&quot;Metrics&quot; /&gt;
14:         &lt;StatCard value={data.alerts.length} label=&quot;Alerts&quot; /&gt;
15:         &lt;StatCard
16:           value={new Date(data.timestamp).toLocaleString()}
17:           label=&quot;Computed At&quot;
18:           valueColor=&quot;var(--text-secondary)&quot;
19:         /&gt;
20:       &lt;/div&gt;
21: 
22:       &lt;ViewSection title=&quot;All Metrics&quot;&gt;
23:         &lt;MetricGrid metrics={data.metrics} /&gt;
24:       &lt;/ViewSection&gt;
25: 
26:       {data.alerts.length &gt; 0 &amp;&amp; (
27:         &lt;ViewSection title=&quot;All Alerts&quot;&gt;
28:           &lt;AlertList alerts={data.alerts} /&gt;
29:         &lt;/ViewSection&gt;
30:       )}
31: 
32:       {data.slaCompliance &amp;&amp; data.slaCompliance.length &gt; 0 &amp;&amp; (
33:         &lt;ViewSection title=&quot;SLA Compliance&quot;&gt;
34:           &lt;SLATable slas={data.slaCompliance} /&gt;
35:         &lt;/ViewSection&gt;
36:       )}
37:     &lt;/div&gt;
38:   );
39: }</file><file path="src/components/ComplianceFrameworkMap.tsx"> 1: const FRAMEWORKS = [
 2:   {
 3:     name: &apos;EU AI Act&apos;,
 4:     articles: [
 5:       { ref: &apos;Art. 9 — Risk Management&apos;, feature: &apos;SLA compliance tracking, alerts&apos; },
 6:       { ref: &apos;Art. 13 — Transparency&apos;, feature: &apos;Chain-of-thought, evaluation provenance&apos; },
 7:       { ref: &apos;Art. 14 — Human Oversight&apos;, feature: &apos;Human verification events&apos; },
 8:       { ref: &apos;Art. 15 — Accuracy &amp; Robustness&apos;, feature: &apos;Quality metrics, trend analysis&apos; },
 9:     ],
10:   },
11:   {
12:     name: &apos;NIST AI RMF&apos;,
13:     articles: [
14:       { ref: &apos;MAP 1.5 — Impact Assessment&apos;, feature: &apos;Correlation heatmap, CQI&apos; },
15:       { ref: &apos;MEASURE 2.6 — Evaluation&apos;, feature: &apos;LLM-as-Judge, Agent-as-Judge&apos; },
16:       { ref: &apos;MEASURE 2.7 — AI System Performance&apos;, feature: &apos;Dashboard metrics, pipeline coverage&apos; },
17:       { ref: &apos;MANAGE 4.1 — Risk Monitoring&apos;, feature: &apos;Alerts, threshold monitoring&apos; },
18:     ],
19:   },
20: ];
21: 
22: export function ComplianceFrameworkMap() {
23:   return (
24:     &lt;div&gt;
25:       {FRAMEWORKS.map(fw =&gt; (
26:         &lt;div key={fw.name} className=&quot;card mb-3&quot;&gt;
27:           &lt;h4 className=&quot;mb-3 text-base&quot;&gt;{fw.name}&lt;/h4&gt;
28:           &lt;table className=&quot;eval-table&quot; style={{ width: &apos;100%&apos; }}&gt;
29:             &lt;thead&gt;
30:               &lt;tr&gt;
31:                 &lt;th style={{ textAlign: &apos;left&apos; }}&gt;Reference&lt;/th&gt;
32:                 &lt;th style={{ textAlign: &apos;left&apos; }}&gt;Dashboard Feature&lt;/th&gt;
33:               &lt;/tr&gt;
34:             &lt;/thead&gt;
35:             &lt;tbody&gt;
36:               {fw.articles.map(a =&gt; (
37:                 &lt;tr key={a.ref}&gt;
38:                   &lt;td style={{ fontSize: 12 }}&gt;{a.ref}&lt;/td&gt;
39:                   &lt;td className=&quot;text-secondary text-xs&quot;&gt;{a.feature}&lt;/td&gt;
40:                 &lt;/tr&gt;
41:               ))}
42:             &lt;/tbody&gt;
43:           &lt;/table&gt;
44:         &lt;/div&gt;
45:       ))}
46:     &lt;/div&gt;
47:   );
48: }</file><file path="src/components/ConfidencePanel.tsx">  1: import type { ConfidenceIndicator } from &apos;../types.js&apos;;
  2: import { SCORE_COLORS, type ScoreColorBand } from &apos;../lib/quality-utils.js&apos;;
  3: 
  4: interface EvaluatorScore {
  5:   evaluator: string;
  6:   score: number;
  7:   label?: string;
  8: }
  9: 
 10: interface ConfidencePanelProps {
 11:   confidence: ConfidenceIndicator;
 12:   /** Per-evaluator scores for multi-judge display */
 13:   evaluatorScores?: EvaluatorScore[];
 14: }
 15: 
 16: function levelColor(level: string): string {
 17:   if (level === &apos;high&apos;) return SCORE_COLORS.excellent;
 18:   if (level === &apos;medium&apos;) return SCORE_COLORS.adequate;
 19:   return SCORE_COLORS.failing;
 20: }
 21: 
 22: function levelShape(level: string): string {
 23:   if (level === &apos;high&apos;) return &apos;\u25CF&apos;; // ●
 24:   if (level === &apos;medium&apos;) return &apos;\u25D0&apos;; // ◐
 25:   return &apos;\u25CB&apos;; // ○
 26: }
 27: 
 28: function VarianceBar({ value, max }: { value: number; max: number }) {
 29:   const pct = max &gt; 0 ? Math.min(100, (value / max) * 100) : 0;
 30:   const band: ScoreColorBand = pct &lt; 20 ? &apos;excellent&apos; : pct &lt; 50 ? &apos;adequate&apos; : &apos;failing&apos;;
 31:   return (
 32:     &lt;div className=&quot;variance-bar&quot;&gt;
 33:       &lt;div className=&quot;variance-bar-track&quot;&gt;
 34:         &lt;div className=&quot;variance-bar-fill&quot; style={{ width: `${pct}%`, background: SCORE_COLORS[band] }} /&gt;
 35:       &lt;/div&gt;
 36:       &lt;span className=&quot;mono-xs text-secondary&quot; style={{ minWidth: 36 }}&gt;
 37:         {value.toFixed(3)}
 38:       &lt;/span&gt;
 39:     &lt;/div&gt;
 40:   );
 41: }
 42: 
 43: export function ConfidencePanel({ confidence, evaluatorScores }: ConfidencePanelProps) {
 44:   const { level, sampleCount, scoreStdDev, evaluatorCount, evaluatorAgreement } = confidence;
 45:   const method = evaluatorCount &gt; 1 ? &apos;multi-judge agreement&apos; : sampleCount &gt; 50 ? &apos;sample size&apos; : &apos;sample count&apos;;
 46: 
 47:   const hasMultiJudge = evaluatorScores &amp;&amp; evaluatorScores.length &gt; 1;
 48: 
 49:   return (
 50:     &lt;div className=&quot;text-xs&quot;&gt;
 51:       &lt;div className=&quot;confidence-header&quot;&gt;
 52:         &lt;span className=&quot;text-base&quot; style={{ color: levelColor(level) }}&gt;
 53:           {levelShape(level)} {level}
 54:         &lt;/span&gt;
 55:         &lt;span className=&quot;confidence-method&quot;&gt;({method})&lt;/span&gt;
 56:       &lt;/div&gt;
 57: 
 58:       &lt;div className=&quot;mb-3&quot; style={{ display: &apos;grid&apos;, gridTemplateColumns: &apos;auto 1fr&apos;, gap: &apos;4px 16px&apos;, fontSize: 12 }}&gt;
 59:         &lt;span className=&quot;text-secondary&quot;&gt;Sample Count&lt;/span&gt;
 60:         &lt;span className=&quot;mono&quot;&gt;{sampleCount}&lt;/span&gt;
 61: 
 62:         {scoreStdDev != null &amp;&amp; (
 63:           &lt;&gt;
 64:             &lt;span className=&quot;text-secondary&quot;&gt;Score Variance&lt;/span&gt;
 65:             &lt;VarianceBar value={scoreStdDev} max={0.5} /&gt;
 66:           &lt;/&gt;
 67:         )}
 68: 
 69:         &lt;span className=&quot;text-secondary&quot;&gt;Evaluators&lt;/span&gt;
 70:         &lt;span className=&quot;mono&quot;&gt;{evaluatorCount}&lt;/span&gt;
 71: 
 72:         {evaluatorAgreement != null &amp;&amp; (
 73:           &lt;&gt;
 74:             &lt;span className=&quot;text-secondary&quot;&gt;Agreement&lt;/span&gt;
 75:             &lt;span className=&quot;mono&quot; style={{
 76:               color: evaluatorAgreement &gt; 0.8 ? SCORE_COLORS.excellent : evaluatorAgreement &gt; 0.5 ? SCORE_COLORS.adequate : SCORE_COLORS.failing,
 77:             }}&gt;
 78:               {(evaluatorAgreement * 100).toFixed(0)}%
 79:             &lt;/span&gt;
 80:           &lt;/&gt;
 81:         )}
 82:       &lt;/div&gt;
 83: 
 84:       {hasMultiJudge &amp;&amp; (
 85:         &lt;div&gt;
 86:           &lt;div className=&quot;section-label mb-1-5&quot;&gt;Judge Panel&lt;/div&gt;
 87:           &lt;div className=&quot;agreement-grid&quot;&gt;
 88:             &lt;span className=&quot;ag-header&quot;&gt;Evaluator&lt;/span&gt;
 89:             &lt;span className=&quot;ag-header&quot;&gt;Score&lt;/span&gt;
 90:             &lt;span className=&quot;ag-header&quot;&gt;Label&lt;/span&gt;
 91:             {evaluatorScores!.map((es) =&gt; (
 92:               &lt;div key={es.evaluator} style={{ display: &apos;contents&apos; }}&gt;
 93:                 &lt;span className=&quot;mono-xs&quot;&gt;{es.evaluator}&lt;/span&gt;
 94:                 &lt;span className=&quot;mono-xs&quot;&gt;{es.score.toFixed(4)}&lt;/span&gt;
 95:                 &lt;span className=&quot;text-secondary text-xs&quot;&gt;{es.label ?? &apos;-&apos;}&lt;/span&gt;
 96:               &lt;/div&gt;
 97:             ))}
 98:           &lt;/div&gt;
 99: 
100:           &lt;div className=&quot;agreement-summary&quot;&gt;
101:             &lt;div&gt;
102:               Agreement: &lt;span className=&quot;summary-value&quot;&gt;
103:                 {evaluatorScores!.every(s =&gt; s.label === evaluatorScores![0].label) ? &apos;100%&apos; : &apos;partial&apos;}
104:               &lt;/span&gt;
105:               {&apos; &apos;}({evaluatorScores!.filter(s =&gt; s.label === evaluatorScores![0].label).length}/{evaluatorScores!.length} same label)
106:             &lt;/div&gt;
107:             &lt;div&gt;
108:               Score Range: &lt;span className=&quot;summary-value&quot;&gt;
109:                 {Math.min(...evaluatorScores!.map(s =&gt; s.score)).toFixed(2)} &amp;ndash; {Math.max(...evaluatorScores!.map(s =&gt; s.score)).toFixed(2)}
110:               &lt;/span&gt;
111:               {&apos; &apos;}(spread: {(Math.max(...evaluatorScores!.map(s =&gt; s.score)) - Math.min(...evaluatorScores!.map(s =&gt; s.score))).toFixed(3)})
112:             &lt;/div&gt;
113:           &lt;/div&gt;
114:         &lt;/div&gt;
115:       )}
116:     &lt;/div&gt;
117:   );
118: }</file><file path="src/components/EvaluationDetail.tsx"> 1: import { useState, useEffect, useRef } from &apos;react&apos;;
 2: import { EvaluationTable, type EvalRow } from &apos;./EvaluationTable.js&apos;;
 3: import { useMetricEvaluations } from &apos;../hooks/useMetricEvaluations.js&apos;;
 4: import type { Period } from &apos;../types.js&apos;;
 5: 
 6: export function EvaluationDetail({
 7:   worst,
 8:   best,
 9:   metricName,
10:   period,
11: }: {
12:   worst: EvalRow[];
13:   best: EvalRow[];
14:   metricName?: string;
15:   period?: Period;
16: }) {
17:   const [showAll, setShowAll] = useState(false);
18:   const prevMetricRef = useRef(metricName);
19: 
20:   useEffect(() =&gt; {
21:     if (prevMetricRef.current !== metricName) {
22:       prevMetricRef.current = metricName;
23:       setShowAll(false);
24:     }
25:   }, [metricName]);
26: 
27:   const { data, isLoading } = useMetricEvaluations(metricName, period, {
28:     limit: 200,
29:     enabled: showAll &amp;&amp; !!metricName,
30:   });
31: 
32:   const topEvals: EvalRow[] = [...worst, ...best];
33:   const displayEvals = showAll &amp;&amp; data ? data.rows : topEvals;
34: 
35:   return (
36:     &lt;div&gt;
37:       &lt;EvaluationTable evaluations={displayEvals} /&gt;
38:       {metricName &amp;&amp; (
39:         &lt;div className=&quot;flex-center gap-3&quot; style={{ marginTop: 12 }}&gt;
40:           {!showAll ? (
41:             &lt;button
42:               type=&quot;button&quot;
43:               onClick={() =&gt; setShowAll(true)}
44:               style={{
45:                 background: &apos;none&apos;,
46:                 border: &apos;1px solid var(--border)&apos;,
47:                 color: &apos;var(--accent)&apos;,
48:                 padding: &apos;6px 14px&apos;,
49:                 borderRadius: 6,
50:                 fontSize: 12,
51:                 cursor: &apos;pointer&apos;,
52:               }}
53:             &gt;
54:               Show all evaluations
55:             &lt;/button&gt;
56:           ) : isLoading ? (
57:             &lt;span className=&quot;text-secondary text-xs&quot;&gt;Loading...&lt;/span&gt;
58:           ) : data ? (
59:             &lt;span className=&quot;text-secondary text-xs&quot;&gt;
60:               Showing {data.rows.length} of {data.total} evaluations
61:             &lt;/span&gt;
62:           ) : null}
63:         &lt;/div&gt;
64:       )}
65:     &lt;/div&gt;
66:   );
67: }</file><file path="src/components/PipelineFunnel.tsx"> 1: import { memo } from &apos;react&apos;;
 2: import type { PipelineStage, PipelineDropoff } from &apos;../types.js&apos;;
 3: 
 4: interface PipelineFunnelProps {
 5:   stages: PipelineStage[];
 6:   dropoffs: PipelineDropoff[];
 7:   overallConversionPercent: number;
 8: }
 9: 
10: function PipelineFunnelInner({ stages, dropoffs, overallConversionPercent }: PipelineFunnelProps) {
11:   if (stages.length === 0) return &lt;p&gt;No pipeline data available.&lt;/p&gt;;
12: 
13:   const maxCount = Math.max(...stages.map(s =&gt; s.entryCount), 1);
14: 
15:   return (
16:     &lt;div role=&quot;region&quot; aria-label=&quot;Evaluation pipeline funnel&quot;&gt;
17:       &lt;div className=&quot;flex-center mb-3 gap-2&quot;&gt;
18:         &lt;span className=&quot;mono-xl font-semibold&quot;&gt;
19:           {overallConversionPercent.toFixed(1)}%
20:         &lt;/span&gt;
21:         &lt;span className=&quot;text-secondary text-base&quot;&gt;overall conversion&lt;/span&gt;
22:       &lt;/div&gt;
23: 
24:       &lt;div className=&quot;gap-1&quot; style={{ display: &apos;flex&apos;, flexDirection: &apos;column&apos; }}&gt;
25:         {stages.map((stage, idx) =&gt; {
26:           const widthPct = Math.max(2, (stage.entryCount / maxCount) * 100);
27:           const dropoff = dropoffs[idx];
28:           const showDropoff = dropoff &amp;&amp; dropoff.dropped &gt; 0;
29: 
30:           return (
31:             &lt;div key={stage.name}&gt;
32:               {/* Stage bar */}
33:               &lt;div className=&quot;flex-center gap-3&quot;&gt;
34:                 &lt;div
35:                   style={{
36:                     width: `${widthPct}%`,
37:                     minWidth: 40,
38:                     height: 32,
39:                     background: `var(--stage-${stage.name}, var(--accent))`,
40:                     borderRadius: 4,
41:                     display: &apos;flex&apos;,
42:                     alignItems: &apos;center&apos;,
43:                     justifyContent: &apos;space-between&apos;,
44:                     padding: &apos;0 10px&apos;,
45:                     transition: &apos;width 0.3s ease&apos;,
46:                   }}
47:                   role=&quot;meter&quot;
48:                   aria-label={`${stage.displayName}: ${stage.entryCount} evaluations`}
49:                   aria-valuenow={stage.entryCount}
50:                   aria-valuemin={0}
51:                   aria-valuemax={maxCount}
52:                 &gt;
53:                   &lt;span className=&quot;text-xs font-semibold&quot; style={{ color: &apos;#fff&apos;, whiteSpace: &apos;nowrap&apos; }}&gt;
54:                     {stage.displayName}
55:                   &lt;/span&gt;
56:                   &lt;span className=&quot;mono-xs&quot; style={{ color: &apos;#fff&apos;, whiteSpace: &apos;nowrap&apos; }}&gt;
57:                     {stage.entryCount.toLocaleString()}
58:                   &lt;/span&gt;
59:                 &lt;/div&gt;
60:               &lt;/div&gt;
61: 
62:               {/* Drop-off indicator */}
63:               {showDropoff &amp;&amp; (
64:                 &lt;div style={{
65:                   fontSize: 12,
66:                   color: dropoff.dropoffPercent &gt; 20 ? &apos;var(--status-warning)&apos; : &apos;var(--text-secondary)&apos;,
67:                   paddingLeft: 10,
68:                   margin: &apos;2px 0&apos;,
69:                 }}&gt;
70:                   {&apos;\u2193&apos;} -{dropoff.dropped.toLocaleString()} ({dropoff.dropoffPercent.toFixed(1)}% drop)
71:                 &lt;/div&gt;
72:               )}
73:             &lt;/div&gt;
74:           );
75:         })}
76:       &lt;/div&gt;
77: 
78:       {/* Screen reader summary table */}
79:       &lt;table className=&quot;sr-only&quot; aria-label=&quot;Pipeline stage details&quot;&gt;
80:         &lt;thead&gt;
81:           &lt;tr&gt;&lt;th&gt;Stage&lt;/th&gt;&lt;th&gt;Entry&lt;/th&gt;&lt;th&gt;Exit&lt;/th&gt;&lt;th&gt;Drop-off&lt;/th&gt;&lt;/tr&gt;
82:         &lt;/thead&gt;
83:         &lt;tbody&gt;
84:           {stages.map((stage, idx) =&gt; (
85:             &lt;tr key={stage.name}&gt;
86:               &lt;td&gt;{stage.displayName}&lt;/td&gt;
87:               &lt;td&gt;{stage.entryCount}&lt;/td&gt;
88:               &lt;td&gt;{stage.exitCount}&lt;/td&gt;
89:               &lt;td&gt;{dropoffs[idx] != null ? `${dropoffs[idx].dropoffPercent.toFixed(1)}%` : &apos;\u2014&apos;}&lt;/td&gt;
90:             &lt;/tr&gt;
91:           ))}
92:         &lt;/tbody&gt;
93:       &lt;/table&gt;
94:     &lt;/div&gt;
95:   );
96: }
97: 
98: export const PipelineFunnel = memo(PipelineFunnelInner);</file><file path="src/components/StatCard.tsx"> 1: import type { ReactNode } from &apos;react&apos;;
 2: 
 3: interface StatCardProps {
 4:   value: ReactNode;
 5:   label: string;
 6:   valueColor?: string;
 7: }
 8: 
 9: export function StatCard({ value, label, valueColor }: StatCardProps) {
10:   return (
11:     &lt;div className=&quot;card summary-count&quot; style={{ padding: &apos;var(--space-3)&apos;, minWidth: 120 }}&gt;
12:       &lt;div className=&quot;value&quot; style={valueColor ? { color: valueColor } : undefined}&gt;
13:         {value}
14:       &lt;/div&gt;
15:       &lt;div className=&quot;label text-secondary text-xs&quot;&gt;{label}&lt;/div&gt;
16:     &lt;/div&gt;
17:   );
18: }</file><file path="src/contexts/KeyboardNavContext.tsx">  1: import { createContext, useContext, useCallback, useEffect, useMemo, useRef, useState, type ReactNode } from &apos;react&apos;;
  2: 
  3: interface Shortcut {
  4:   key: string;
  5:   description: string;
  6:   scope: string;
  7:   action: () =&gt; void;
  8: }
  9: 
 10: interface KeyboardNavContextValue {
 11:   shortcuts: Shortcut[];
 12:   register: (key: string, description: string, scope: string, action: () =&gt; void) =&gt; () =&gt; void;
 13:   overlayOpen: boolean;
 14:   toggleOverlay: () =&gt; void;
 15: }
 16: 
 17: const KeyboardNavContext = createContext&lt;KeyboardNavContextValue | null&gt;(null);
 18: 
 19: export function useShortcut(key: string, description: string, scope: string, action: () =&gt; void) {
 20:   const ctx = useContext(KeyboardNavContext);
 21:   const register = ctx?.register;
 22:   const actionRef = useRef(action);
 23:   actionRef.current = action;
 24:   const stableAction = useCallback(() =&gt; actionRef.current(), []);
 25:   useEffect(() =&gt; {
 26:     if (!register) return;
 27:     return register(key, description, scope, stableAction);
 28:   }, [register, key, description, scope, stableAction]);
 29: }
 30: 
 31: export function useKeyboardNav() {
 32:   const ctx = useContext(KeyboardNavContext);
 33:   if (!ctx) throw new Error(&apos;useKeyboardNav must be used within KeyboardNavProvider&apos;);
 34:   return ctx;
 35: }
 36: 
 37: const IGNORED_TAGS = new Set([&apos;INPUT&apos;, &apos;TEXTAREA&apos;, &apos;SELECT&apos;]);
 38: 
 39: export function KeyboardNavProvider({ children }: { children: ReactNode }) {
 40:   const shortcutsRef = useRef&lt;Shortcut[]&gt;([]);
 41:   const [shortcuts, setShortcuts] = useState&lt;Shortcut[]&gt;([]);
 42:   const [overlayOpen, setOverlayOpen] = useState(false);
 43:   const pendingRef = useRef&lt;string | null&gt;(null);
 44:   const pendingTimerRef = useRef&lt;ReturnType&lt;typeof setTimeout&gt; | null&gt;(null);
 45: 
 46:   const register = useCallback((key: string, description: string, scope: string, action: () =&gt; void) =&gt; {
 47:     const shortcut: Shortcut = { key, description, scope, action };
 48:     shortcutsRef.current = [...shortcutsRef.current, shortcut];
 49:     setShortcuts([...shortcutsRef.current]);
 50:     return () =&gt; {
 51:       shortcutsRef.current = shortcutsRef.current.filter(s =&gt; s !== shortcut);
 52:       setShortcuts([...shortcutsRef.current]);
 53:     };
 54:   }, []);
 55: 
 56:   const toggleOverlay = useCallback(() =&gt; setOverlayOpen(o =&gt; !o), []);
 57: 
 58:   useEffect(() =&gt; {
 59:     function handleKeydown(e: KeyboardEvent) {
 60:       if (IGNORED_TAGS.has((e.target as HTMLElement)?.tagName)) return;
 61:       if (e.ctrlKey || e.metaKey || e.altKey) return;
 62: 
 63:       const key = e.key;
 64: 
 65:       if (key === &apos;?&apos;) {
 66:         e.preventDefault();
 67:         setOverlayOpen(o =&gt; !o);
 68:         return;
 69:       }
 70: 
 71:       if (key === &apos;Escape&apos; &amp;&amp; overlayOpen) {
 72:         e.preventDefault();
 73:         setOverlayOpen(false);
 74:         return;
 75:       }
 76: 
 77:       // Two-key combo support (e.g. &quot;g h&quot;)
 78:       if (pendingRef.current) {
 79:         const combo = `${pendingRef.current} ${key}`;
 80:         pendingRef.current = null;
 81:         if (pendingTimerRef.current) clearTimeout(pendingTimerRef.current);
 82:         const match = shortcutsRef.current.find(s =&gt; s.key === combo);
 83:         if (match) {
 84:           e.preventDefault();
 85:           match.action();
 86:           return;
 87:         }
 88:       }
 89: 
 90:       // Check for single-key match
 91:       const single = shortcutsRef.current.find(s =&gt; s.key === key);
 92:       if (single) {
 93:         e.preventDefault();
 94:         single.action();
 95:         return;
 96:       }
 97: 
 98:       // Check if this could be the start of a combo
 99:       const hasCombo = shortcutsRef.current.some(s =&gt; s.key.startsWith(`${key} `));
100:       if (hasCombo) {
101:         pendingRef.current = key;
102:         pendingTimerRef.current = setTimeout(() =&gt; { pendingRef.current = null; }, 500);
103:       }
104:     }
105: 
106:     document.addEventListener(&apos;keydown&apos;, handleKeydown);
107:     return () =&gt; {
108:       document.removeEventListener(&apos;keydown&apos;, handleKeydown);
109:       if (pendingTimerRef.current) clearTimeout(pendingTimerRef.current);
110:     };
111:   }, [overlayOpen]);
112: 
113:   const value = useMemo&lt;KeyboardNavContextValue&gt;(
114:     () =&gt; ({ shortcuts, register, overlayOpen, toggleOverlay }),
115:     [shortcuts, register, overlayOpen, toggleOverlay],
116:   );
117: 
118:   return (
119:     &lt;KeyboardNavContext.Provider value={value}&gt;
120:       {children}
121:     &lt;/KeyboardNavContext.Provider&gt;
122:   );
123: }</file><file path="src/contexts/RoleContext.tsx"> 1: import { createContext, useContext, useEffect, useMemo, type ReactNode } from &apos;react&apos;;
 2: import { useRoute } from &apos;wouter&apos;;
 3: import {
 4:   getRoleFeatureConfig,
 5:   type FeatureRoleType,
 6:   type RoleFeatureConfig,
 7: } from &apos;../lib/quality-utils.js&apos;;
 8: import { ROLES, DEFAULT_ROLE } from &apos;../lib/constants.js&apos;;
 9: 
10: const VALID_ROLES = new Set&lt;FeatureRoleType&gt;(ROLES);
11: 
12: interface RoleContextValue {
13:   role: FeatureRoleType;
14:   config: RoleFeatureConfig;
15:   hasFeature: (feature: keyof RoleFeatureConfig) =&gt; boolean;
16: }
17: 
18: const RoleContext = createContext&lt;RoleContextValue | null&gt;(null);
19: 
20: export function RoleProvider({ children }: { children: ReactNode }) {
21:   const [, params] = useRoute(&apos;/role/:roleName&apos;);
22:   const roleName = params?.roleName as string | undefined;
23: 
24:   const role: FeatureRoleType =
25:     roleName &amp;&amp; VALID_ROLES.has(roleName as FeatureRoleType)
26:       ? (roleName as FeatureRoleType)
27:       : DEFAULT_ROLE;
28: 
29:   useEffect(() =&gt; {
30:     if (roleName &amp;&amp; !VALID_ROLES.has(roleName as FeatureRoleType)) {
31:       console.warn(`[RoleProvider] Unknown role &quot;${roleName}&quot;, falling back to &quot;executive&quot;. Valid roles: ${[...VALID_ROLES].join(&apos;, &apos;)}`);
32:     }
33:   }, [roleName]);
34: 
35:   const value = useMemo&lt;RoleContextValue&gt;(() =&gt; {
36:     const config = getRoleFeatureConfig(role);
37:     return {
38:       role,
39:       config,
40:       hasFeature: (feature: keyof RoleFeatureConfig) =&gt; {
41:         const v = config[feature];
42:         if (typeof v === &apos;boolean&apos;) return v;
43:         return v !== undefined &amp;&amp; v !== null;
44:       },
45:     };
46:   }, [role]);
47: 
48:   return (
49:     &lt;RoleContext.Provider value={value}&gt;
50:       {children}
51:     &lt;/RoleContext.Provider&gt;
52:   );
53: }
54: 
55: export function useRole(): RoleContextValue {
56:   const ctx = useContext(RoleContext);
57:   if (!ctx) {
58:     throw new Error(&apos;useRole must be used within a RoleProvider&apos;);
59:   }
60:   return ctx;
61: }
62: 
63: export function RoleGate({ feature, children }: {
64:   feature: keyof RoleFeatureConfig;
65:   children: ReactNode;
66: }) {
67:   const { hasFeature } = useRole();
68:   return hasFeature(feature) ? &lt;&gt;{children}&lt;/&gt; : null;
69: }</file><file path="src/hooks/useDashboard.ts"> 1: import { useQuery } from &apos;@tanstack/react-query&apos;;
 2: import type { QualityDashboardSummary, RoleView, RoleViewType, Period } from &apos;../types.js&apos;;
 3: import { API_BASE, STALE_TIME, POLL_INTERVAL_MS, RETRY_DELAY_BASE, RETRY_DELAY_CAP } from &apos;../lib/constants.js&apos;;
 4: 
 5: export function useDashboard(period: Period, role?: RoleViewType) {
 6:   return useQuery&lt;QualityDashboardSummary | RoleView&gt;({
 7:     queryKey: [&apos;dashboard&apos;, period, role],
 8:     queryFn: async () =&gt; {
 9:       const params = new URLSearchParams({ period });
10:       if (role) params.set(&apos;role&apos;, role);
11:       const res = await fetch(`${API_BASE}/api/dashboard?${params}`);
12:       if (!res.ok) throw new Error(`API error: ${res.status}`);
13:       return res.json();
14:     },
15:     refetchInterval: POLL_INTERVAL_MS,
16:     staleTime: STALE_TIME.DEFAULT,
17:     retry: 3,
18:     retryDelay: (i) =&gt; Math.min(RETRY_DELAY_BASE * 2 ** i, RETRY_DELAY_CAP),
19:   });
20: }</file><file path="src/hooks/useMetricDetail.ts"> 1: import { useQuery } from &apos;@tanstack/react-query&apos;;
 2: import type { MetricDetailResult, Period } from &apos;../types.js&apos;;
 3: import { API_BASE, STALE_TIME, DEFAULT_TOP_N, DEFAULT_BUCKET_COUNT, DEFAULT_PERIOD_DETAIL } from &apos;../lib/constants.js&apos;;
 4: 
 5: export function useMetricDetail(name: string | undefined, period: Period = DEFAULT_PERIOD_DETAIL) {
 6:   return useQuery&lt;MetricDetailResult&gt;({
 7:     queryKey: [&apos;metric&apos;, name, period],
 8:     queryFn: async () =&gt; {
 9:       const res = await fetch(`${API_BASE}/api/metrics/${name}?period=${period}&amp;topN=${DEFAULT_TOP_N}&amp;bucketCount=${DEFAULT_BUCKET_COUNT}`);
10:       if (!res.ok) throw new Error(`API error: ${res.status}`);
11:       return res.json();
12:     },
13:     enabled: !!name,
14:     staleTime: STALE_TIME.DEFAULT,
15:     retry: 2,
16:   });
17: }</file><file path="src/hooks/usePipeline.ts"> 1: import { useQuery } from &apos;@tanstack/react-query&apos;;
 2: import type { Period, PipelineResult } from &apos;../types.js&apos;;
 3: import { API_BASE, STALE_TIME } from &apos;../lib/constants.js&apos;;
 4: 
 5: export type PipelineResponse = PipelineResult &amp; { period: string };
 6: 
 7: export function usePipeline(period: Period) {
 8:   return useQuery&lt;PipelineResponse&gt;({
 9:     queryKey: [&apos;pipeline&apos;, period],
10:     queryFn: async () =&gt; {
11:       const params = new URLSearchParams({ period });
12:       const res = await fetch(`${API_BASE}/api/pipeline?${params}`);
13:       if (!res.ok) throw new Error(`API error: ${res.status}`);
14:       return res.json();
15:     },
16:     staleTime: STALE_TIME.DEFAULT,
17:     retry: 2,
18:   });
19: }</file><file path="src/__tests__/p1-explainability.test.tsx">  1: import { describe, it, expect, afterEach, vi } from &apos;vitest&apos;;
  2: import { render, screen, cleanup } from &apos;@testing-library/react&apos;;
  3: import { ScoreBadge } from &apos;../components/ScoreBadge.js&apos;;
  4: import { ChainOfThoughtPanel } from &apos;../components/ChainOfThoughtPanel.js&apos;;
  5: import { AlertList } from &apos;../components/AlertList.js&apos;;
  6: import type { TriggeredAlert } from &apos;../types.js&apos;;
  7: 
  8: afterEach(cleanup);
  9: 
 10: // ---------------------------------------------------------------------------
 11: // ScoreBadge tooltip (Feature 3)
 12: // ---------------------------------------------------------------------------
 13: 
 14: describe(&apos;ScoreBadge tooltip&apos;, () =&gt; {
 15:   it(&apos;renders tooltip content when tooltip props provided&apos;, () =&gt; {
 16:     const { container } = render(
 17:       &lt;ScoreBadge
 18:         score={0.85}
 19:         metricName=&quot;relevance&quot;
 20:         evaluator=&quot;gpt-4o&quot;
 21:         evaluatorType=&quot;llm&quot;
 22:         explanation=&quot;This response is highly relevant to the query.&quot;
 23:         traceId=&quot;trace-abc-123&quot;
 24:       /&gt;
 25:     );
 26:     const wrapper = container.querySelector(&apos;.score-badge-wrapper&apos;);
 27:     expect(wrapper).toBeInTheDocument();
 28:     const tooltip = container.querySelector(&apos;.score-badge-tooltip&apos;);
 29:     expect(tooltip).toBeInTheDocument();
 30:     expect(tooltip!.textContent).toContain(&apos;gpt-4o&apos;);
 31:     expect(tooltip!.textContent).toContain(&apos;llm&apos;);
 32:     expect(tooltip!.textContent).toContain(&apos;This response is highly relevant&apos;);
 33:   });
 34: 
 35:   it(&apos;does not render tooltip without tooltip props&apos;, () =&gt; {
 36:     const { container } = render(
 37:       &lt;ScoreBadge score={0.85} metricName=&quot;relevance&quot; /&gt;
 38:     );
 39:     expect(container.querySelector(&apos;.score-badge-wrapper&apos;)).not.toBeInTheDocument();
 40:     expect(container.querySelector(&apos;.score-badge-tooltip&apos;)).not.toBeInTheDocument();
 41:   });
 42: 
 43:   it(&apos;renders &quot;View full explanation&quot; link with traceId&apos;, () =&gt; {
 44:     const { container } = render(
 45:       &lt;ScoreBadge
 46:         score={0.85}
 47:         metricName=&quot;relevance&quot;
 48:         traceId=&quot;trace-abc-123&quot;
 49:       /&gt;
 50:     );
 51:     const link = container.querySelector(&apos;.tooltip-link&apos;);
 52:     expect(link).toBeInTheDocument();
 53:     expect(link!.getAttribute(&apos;href&apos;)).toBe(&apos;/evaluations/trace/trace-abc-123&apos;);
 54:   });
 55: });
 56: 
 57: // ---------------------------------------------------------------------------
 58: // ChainOfThoughtPanel (Feature 2)
 59: // ---------------------------------------------------------------------------
 60: 
 61: describe(&apos;ChainOfThoughtPanel&apos;, () =&gt; {
 62:   it(&apos;renders explanation in details element&apos;, () =&gt; {
 63:     const { container } = render(
 64:       &lt;ChainOfThoughtPanel explanation=&quot;The model output is coherent and well-structured.&quot; /&gt;
 65:     );
 66:     const details = container.querySelector(&apos;details&apos;);
 67:     expect(details).toBeInTheDocument();
 68:     expect(details!.hasAttribute(&apos;open&apos;)).toBe(true);
 69:     expect(details!.textContent).toContain(&apos;The model output is coherent&apos;);
 70:   });
 71: 
 72:   it(&apos;renders evaluator inline without expandable config&apos;, () =&gt; {
 73:     const { container } = render(
 74:       &lt;ChainOfThoughtPanel
 75:         evaluator=&quot;claude-3.5-sonnet&quot;
 76:       /&gt;
 77:     );
 78:     expect(container.querySelectorAll(&apos;details&apos;).length).toBe(0);
 79:     expect(container.textContent).toContain(&apos;claude-3.5-sonnet&apos;);
 80:   });
 81: 
 82:   it(&apos;renders fallback when no data available&apos;, () =&gt; {
 83:     const { container } = render(&lt;ChainOfThoughtPanel /&gt;);
 84:     expect(container.textContent).toContain(&apos;No chain-of-thought data available&apos;);
 85:   });
 86: });
 87: 
 88: // ---------------------------------------------------------------------------
 89: // AlertList compound alerts (Feature 4)
 90: // ---------------------------------------------------------------------------
 91: 
 92: describe(&apos;AlertList compound alerts&apos;, () =&gt; {
 93:   function makeAlerts(): (TriggeredAlert &amp; { metricName: string })[] {
 94:     return [
 95:       {
 96:         severity: &apos;warning&apos;,
 97:         message: &apos;Relevance score below threshold&apos;,
 98:         aggregation: &apos;avg&apos;,
 99:         threshold: 0.7,
100:         actualValue: 0.65,
101:         direction: &apos;below&apos;,
102:         remediationHints: [&apos;Check prompt quality&apos;],
103:         metricName: &apos;relevance&apos;,
104:       },
105:       {
106:         severity: &apos;critical&apos;,
107:         message: &apos;Content quality crisis detected&apos;,
108:         aggregation: &apos;avg&apos;,
109:         threshold: 0.5,
110:         actualValue: 0.35,
111:         direction: &apos;below&apos;,
112:         isCompound: true,
113:         remediationHints: [
114:           &apos;Review prompt templates&apos;,
115:           &apos;Check model configuration&apos;,
116:           &apos;Audit training data&apos;,
117:         ],
118:         relatedMetrics: [&apos;relevance&apos;, &apos;hallucination&apos;, &apos;coherence&apos;],
119:         metricName: &apos;content_quality_crisis&apos;,
120:       },
121:     ];
122:   }
123: 
124:   it(&apos;renders compound alert with full remediation hints&apos;, () =&gt; {
125:     const { container } = render(&lt;AlertList alerts={makeAlerts()} /&gt;);
126:     const compoundCard = container.querySelector(&apos;.alert-compound&apos;);
127:     expect(compoundCard).toBeInTheDocument();
128:     expect(compoundCard!.textContent).toContain(&apos;Review prompt templates&apos;);
129:     expect(compoundCard!.textContent).toContain(&apos;Check model configuration&apos;);
130:     expect(compoundCard!.textContent).toContain(&apos;Audit training data&apos;);
131:   });
132: 
133:   it(&apos;renders related metric links for compound alerts&apos;, () =&gt; {
134:     const { container } = render(&lt;AlertList alerts={makeAlerts()} /&gt;);
135:     const links = container.querySelectorAll(&apos;.alert-metric-link&apos;);
136:     expect(links.length).toBe(3);
137:     expect(links[0].getAttribute(&apos;href&apos;)).toBe(&apos;/metrics/relevance&apos;);
138:     expect(links[1].getAttribute(&apos;href&apos;)).toBe(&apos;/metrics/hallucination&apos;);
139:     expect(links[2].getAttribute(&apos;href&apos;)).toBe(&apos;/metrics/coherence&apos;);
140:   });
141: 
142:   it(&apos;renders threshold bar for compound alerts&apos;, () =&gt; {
143:     const { container } = render(&lt;AlertList alerts={makeAlerts()} /&gt;);
144:     const bar = container.querySelector(&apos;.threshold-bar&apos;);
145:     expect(bar).toBeInTheDocument();
146:   });
147: 
148:   it(&apos;renders simple alerts without compound styling&apos;, () =&gt; {
149:     const { container } = render(&lt;AlertList alerts={makeAlerts()} /&gt;);
150:     const items = container.querySelectorAll(&apos;.alert-item&apos;);
151:     expect(items.length).toBe(2);
152:     const simpleItem = Array.from(items).find(el =&gt; !el.classList.contains(&apos;alert-compound&apos;));
153:     expect(simpleItem).toBeInTheDocument();
154:     expect(simpleItem!.textContent).toContain(&apos;Relevance score below threshold&apos;);
155:   });
156: });
157: 
158: // ---------------------------------------------------------------------------
159: // EvaluationDetailPage (Feature 2) - basic render with mocked hook
160: // ---------------------------------------------------------------------------
161: 
162: vi.mock(&apos;../hooks/useTraceEvaluations.js&apos;, () =&gt; ({
163:   useTraceEvaluations: vi.fn(),
164: }));
165: 
166: const mockEvalData = [
167:   {
168:     timestamp: &apos;2026-02-17T12:00:00Z&apos;,
169:     evaluationName: &apos;relevance&apos;,
170:     scoreValue: 0.92,
171:     scoreLabel: &apos;excellent&apos;,
172:     explanation: &apos;Highly relevant response&apos;,
173:     evaluator: &apos;gpt-4o&apos;,
174:     evaluatorType: &apos;llm&apos; as const,
175:     traceId: &apos;trace-123&apos;,
176:   },
177:   {
178:     timestamp: &apos;2026-02-17T12:00:00Z&apos;,
179:     evaluationName: &apos;coherence&apos;,
180:     scoreValue: 0.78,
181:     scoreLabel: &apos;good&apos;,
182:     explanation: &apos;Mostly coherent&apos;,
183:     evaluator: &apos;gpt-4o&apos;,
184:     evaluatorType: &apos;llm&apos; as const,
185:     traceId: &apos;trace-123&apos;,
186:   },
187: ];
188: 
189: describe(&apos;EvaluationDetailPage&apos;, () =&gt; {
190:   const originalSearch = window.location.search;
191:   afterEach(() =&gt; {
192:     Object.defineProperty(window, &apos;location&apos;, {
193:       value: { ...window.location, search: originalSearch },
194:       writable: true,
195:     });
196:   });
197: 
198:   it(&apos;renders evaluation cards when data is available&apos;, async () =&gt; {
199:     const { useTraceEvaluations } = await import(&apos;../hooks/useTraceEvaluations.js&apos;);
200:     // @ts-expect-error -- partial mock: only fields consumed by component
201:     vi.mocked(useTraceEvaluations).mockReturnValue({
202:       data: mockEvalData,
203:       isLoading: false,
204:       error: null,
205:     });
206: 
207:     const { EvaluationDetailPage } = await import(&apos;../pages/EvaluationDetailPage.js&apos;);
208:     const { container } = render(&lt;EvaluationDetailPage traceId=&quot;trace-123&quot; /&gt;);
209: 
210:     expect(container.textContent).toContain(&apos;Trace Evaluations&apos;);
211:     expect(container.textContent).toContain(&apos;trace-123&apos;);
212:     expect(container.textContent).toContain(&apos;relevance&apos;);
213:     expect(container.textContent).toContain(&apos;coherence&apos;);
214:     const cards = container.querySelectorAll(&apos;.eval-detail-card&apos;);
215:     expect(cards.length).toBe(2);
216:   });
217: 
218:   it(&apos;filters by metric query param&apos;, async () =&gt; {
219:     Object.defineProperty(window, &apos;location&apos;, {
220:       value: { ...window.location, search: &apos;?metric=relevance&apos; },
221:       writable: true,
222:     });
223: 
224:     const { useTraceEvaluations } = await import(&apos;../hooks/useTraceEvaluations.js&apos;);
225:     // @ts-expect-error -- partial mock: only fields consumed by component
226:     vi.mocked(useTraceEvaluations).mockReturnValue({
227:       data: mockEvalData,
228:       isLoading: false,
229:       error: null,
230:     });
231: 
232:     const { EvaluationDetailPage } = await import(&apos;../pages/EvaluationDetailPage.js&apos;);
233:     const { container } = render(&lt;EvaluationDetailPage traceId=&quot;trace-123&quot; /&gt;);
234: 
235:     expect(container.textContent).toContain(&apos;relevance Evaluations&apos;);
236:     expect(container.textContent).toContain(&apos;View all evaluations&apos;);
237:     const cards = container.querySelectorAll(&apos;.eval-detail-card&apos;);
238:     expect(cards.length).toBe(1);
239:   });
240: 
241:   it(&apos;renders loading state&apos;, async () =&gt; {
242:     const { useTraceEvaluations } = await import(&apos;../hooks/useTraceEvaluations.js&apos;);
243:     // @ts-expect-error -- partial mock: only fields consumed by component
244:     vi.mocked(useTraceEvaluations).mockReturnValue({
245:       data: undefined,
246:       isLoading: true,
247:       error: null,
248:     });
249: 
250:     const { EvaluationDetailPage } = await import(&apos;../pages/EvaluationDetailPage.js&apos;);
251:     const { container } = render(&lt;EvaluationDetailPage traceId=&quot;trace-123&quot; /&gt;);
252:     expect(container.querySelector(&apos;.skeleton&apos;)).toBeInTheDocument();
253:   });
254: 
255:   it(&apos;renders empty state when no evaluations&apos;, async () =&gt; {
256:     const { useTraceEvaluations } = await import(&apos;../hooks/useTraceEvaluations.js&apos;);
257:     // @ts-expect-error -- partial mock: only fields consumed by component
258:     vi.mocked(useTraceEvaluations).mockReturnValue({
259:       data: [],
260:       isLoading: false,
261:       error: null,
262:     });
263: 
264:     const { EvaluationDetailPage } = await import(&apos;../pages/EvaluationDetailPage.js&apos;);
265:     const { container } = render(&lt;EvaluationDetailPage traceId=&quot;trace-123&quot; /&gt;);
266:     expect(container.textContent).toContain(&apos;No Evaluations Found&apos;);
267:     expect(container.textContent).toContain(&apos;may not have been synced yet&apos;);
268:   });
269: });</file><file path="src/api/routes/compliance.ts"> 1: import { Hono } from &apos;hono&apos;;
 2: import { computeDashboardSummary } from &apos;../../../../dist/lib/quality-metrics.js&apos;;
 3: import { sanitizeErrorForResponse } from &apos;../../../../dist/lib/error-sanitizer.js&apos;;
 4: import { loadEvaluationsByMetric, loadVerifications } from &apos;../data-loader.js&apos;;
 5: import { PeriodSchema, PERIOD_MS, ErrorMessage, HttpStatus } from &apos;../../lib/constants.js&apos;;
 6: 
 7: export const complianceRoutes = new Hono();
 8: 
 9: /**
10:  * GET /api/compliance/sla
11:  * Returns SLA compliance from the dashboard summary.
12:  */
13: complianceRoutes.get(&apos;/compliance/sla&apos;, async (c) =&gt; {
14:   const periodResult = PeriodSchema.safeParse(c.req.query(&apos;period&apos;));
15:   if (!periodResult.success) {
16:     return c.json({ error: ErrorMessage.InvalidPeriod }, HttpStatus.BadRequest);
17:   }
18: 
19:   try {
20:     const now = new Date();
21:     const period = periodResult.data;
22:     const periodMs = PERIOD_MS[period] ?? PERIOD_MS[&apos;7d&apos;];
23:     const start = new Date(now.getTime() - periodMs);
24:     const dates = { start: start.toISOString(), end: now.toISOString() };
25: 
26:     const evaluationsByMetric = await loadEvaluationsByMetric(dates.start, dates.end);
27:     const summary = computeDashboardSummary(evaluationsByMetric, undefined, dates);
28: 
29:     return c.json({
30:       period,
31:       results: summary.slaCompliance ?? [],
32:       noSLAsConfigured: !summary.slaCompliance || summary.slaCompliance.length === 0,
33:     });
34:   } catch (err) {
35:     return c.json({ error: sanitizeErrorForResponse(err) }, HttpStatus.InternalServerError);
36:   }
37: });
38: 
39: /**
40:  * GET /api/compliance/verifications
41:  * Returns human verification events for the given period.
42:  */
43: complianceRoutes.get(&apos;/compliance/verifications&apos;, async (c) =&gt; {
44:   const periodResult = PeriodSchema.safeParse(c.req.query(&apos;period&apos;));
45:   if (!periodResult.success) {
46:     return c.json({ error: ErrorMessage.InvalidPeriod }, HttpStatus.BadRequest);
47:   }
48: 
49:   try {
50:     const now = new Date();
51:     const period = periodResult.data;
52:     const periodMs = PERIOD_MS[period] ?? PERIOD_MS[&apos;7d&apos;];
53:     const start = new Date(now.getTime() - periodMs);
54: 
55:     const verifications = await loadVerifications({
56:       startDate: start.toISOString(),
57:       endDate: now.toISOString(),
58:     });
59: 
60:     return c.json({ period, count: verifications.length, verifications });
61:   } catch (err) {
62:     return c.json({ error: sanitizeErrorForResponse(err) }, HttpStatus.InternalServerError);
63:   }
64: });</file><file path="src/api/routes/dashboard.ts">  1: import { Hono } from &apos;hono&apos;;
  2: import { z } from &apos;zod&apos;;
  3: import {
  4:   computeDashboardSummary,
  5:   computeRoleView,
  6:   QUALITY_METRICS,
  7: } from &apos;../../../../dist/lib/quality-metrics.js&apos;;
  8: import type { RoleViewType } from &apos;../../../../dist/lib/quality-metrics.js&apos;;
  9: import type { EvaluationResult } from &apos;../../../../dist/backends/index.js&apos;;
 10: import { computeCQI } from &apos;../../../../dist/lib/quality-feature-engineering.js&apos;;
 11: import { sanitizeErrorForResponse } from &apos;../../../../dist/lib/error-sanitizer.js&apos;;
 12: import { loadEvaluationsByMetric, checkHealth } from &apos;../data-loader.js&apos;;
 13: import { PeriodSchema, RoleSchema, ErrorMessage, HttpStatus } from &apos;../../lib/constants.js&apos;;
 14: 
 15: function computePeriodDates(period: string): { start: string; end: string } {
 16:   const now = new Date();
 17:   const ms: Record&lt;string, number&gt; = {
 18:     &apos;24h&apos;: 24 * 60 * 60 * 1000,
 19:     &apos;7d&apos;: 7 * 24 * 60 * 60 * 1000,
 20:     &apos;30d&apos;: 30 * 24 * 60 * 60 * 1000,
 21:   };
 22:   const start = new Date(now.getTime() - (ms[period] ?? ms[&apos;7d&apos;]));
 23:   return { start: start.toISOString(), end: now.toISOString() };
 24: }
 25: 
 26: /** Bucket evaluations into N time bins and return avg scores per bucket */
 27: function computeSparklineData(
 28:   evaluations: EvaluationResult[],
 29:   startMs: number,
 30:   endMs: number,
 31:   buckets: number,
 32: ): (number | null)[] {
 33:   const range = endMs - startMs;
 34:   if (range &lt;= 0 || evaluations.length === 0) return [];
 35: 
 36:   const bucketWidth = range / buckets;
 37:   const sums = new Array(buckets).fill(0);
 38:   const counts = new Array(buckets).fill(0);
 39: 
 40:   for (const ev of evaluations) {
 41:     if (ev.scoreValue == null || !Number.isFinite(ev.scoreValue)) continue;
 42:     const ts = new Date(ev.timestamp).getTime();
 43:     const idx = Math.min(Math.floor((ts - startMs) / bucketWidth), buckets - 1);
 44:     if (idx &gt;= 0) {
 45:       sums[idx] += ev.scoreValue;
 46:       counts[idx]++;
 47:     }
 48:   }
 49: 
 50:   return sums.map((s, i) =&gt; counts[i] &gt; 0 ? s / counts[i] : null);
 51: }
 52: 
 53: export const dashboardRoutes = new Hono();
 54: 
 55: dashboardRoutes.get(&apos;/dashboard&apos;, async (c) =&gt; {
 56:   const periodResult = PeriodSchema.safeParse(c.req.query(&apos;period&apos;));
 57:   if (!periodResult.success) {
 58:     return c.json({ error: ErrorMessage.InvalidPeriod }, HttpStatus.BadRequest);
 59:   }
 60:   const roleResult = RoleSchema.optional().safeParse(c.req.query(&apos;role&apos;) || undefined);
 61:   if (!roleResult.success) {
 62:     return c.json({ error: ErrorMessage.InvalidRole }, HttpStatus.BadRequest);
 63:   }
 64: 
 65:   try {
 66:     const period = periodResult.data;
 67:     const role = roleResult.data;
 68:     const dates = computePeriodDates(period);
 69:     const evaluationsByMetric = await loadEvaluationsByMetric(dates.start, dates.end);
 70:     const dashboard = computeDashboardSummary(evaluationsByMetric, undefined, dates);
 71:     const cqi = computeCQI(dashboard.metrics);
 72: 
 73:     // Compute sparkline data (24 time buckets per metric)
 74:     const startMs = new Date(dates.start).getTime();
 75:     const endMs = new Date(dates.end).getTime();
 76:     const sparklines: Record&lt;string, (number | null)[]&gt; = {};
 77:     for (const [metricName, evals] of evaluationsByMetric) {
 78:       sparklines[metricName] = computeSparklineData(evals, startMs, endMs, 24);
 79:     }
 80: 
 81:     if (role) {
 82:       const view = computeRoleView(dashboard, role as RoleViewType);
 83:       if (role === &apos;executive&apos;) {
 84:         return c.json({ ...view, cqi, sparklines });
 85:       }
 86:       return c.json({ ...view, sparklines });
 87:     }
 88: 
 89:     return c.json({ ...dashboard, cqi, sparklines });
 90:   } catch (err) {
 91:     return c.json({ error: sanitizeErrorForResponse(err) }, HttpStatus.InternalServerError);
 92:   }
 93: });
 94: 
 95: dashboardRoutes.get(&apos;/health&apos;, async (c) =&gt; {
 96:   try {
 97:     const result = await checkHealth();
 98:     return c.json(result);
 99:   } catch (err) {
100:     return c.json({ error: sanitizeErrorForResponse(err) }, HttpStatus.InternalServerError);
101:   }
102: });</file><file path="src/api/routes/metrics.ts">  1: import { Hono } from &apos;hono&apos;;
  2: import { z } from &apos;zod&apos;;
  3: import {
  4:   computeMetricDetail,
  5:   computeAggregations,
  6:   getQualityMetric,
  7: } from &apos;../../../../dist/lib/quality-metrics.js&apos;;
  8: import { computeMetricDynamics } from &apos;../../../../dist/lib/quality-feature-engineering.js&apos;;
  9: import { sanitizeErrorForResponse } from &apos;../../../../dist/lib/error-sanitizer.js&apos;;
 10: import { loadEvaluationsForMetric } from &apos;../data-loader.js&apos;;
 11: import { PeriodSchema, PERIOD_MS, SortBySchema, ErrorMessage, HttpStatus } from &apos;../../lib/constants.js&apos;;
 12: 
 13: const TopNSchema = z.coerce.number().int().min(1).max(50).default(5);
 14: const BucketCountSchema = z.coerce.number().int().min(2).max(20).default(10);
 15: const LimitSchema = z.coerce.number().int().min(1).max(200).default(50);
 16: const OffsetSchema = z.coerce.number().int().min(0).default(0);
 17: const ScoreLabelSchema = z.string().max(100).optional();
 18: 
 19: export const metricsRoutes = new Hono();
 20: 
 21: metricsRoutes.get(&apos;/metrics/:name&apos;, async (c) =&gt; {
 22:   const name = c.req.param(&apos;name&apos;);
 23:   const config = getQualityMetric(name);
 24:   if (!config) {
 25:     return c.json({ error: `Unknown metric: ${name}` }, HttpStatus.NotFound);
 26:   }
 27: 
 28:   const periodResult = PeriodSchema.safeParse(c.req.query(&apos;period&apos;));
 29:   if (!periodResult.success) {
 30:     return c.json({ error: ErrorMessage.InvalidPeriod }, HttpStatus.BadRequest);
 31:   }
 32:   const topNResult = TopNSchema.safeParse(c.req.query(&apos;topN&apos;));
 33:   if (!topNResult.success) {
 34:     return c.json({ error: &apos;Invalid topN parameter. Must be integer 1-50.&apos; }, HttpStatus.BadRequest);
 35:   }
 36:   const bucketResult = BucketCountSchema.safeParse(c.req.query(&apos;bucketCount&apos;));
 37:   if (!bucketResult.success) {
 38:     return c.json({ error: &apos;Invalid bucketCount parameter. Must be integer 2-20.&apos; }, HttpStatus.BadRequest);
 39:   }
 40: 
 41:   try {
 42:     const now = new Date();
 43:     const periodMs = PERIOD_MS[periodResult.data] ?? PERIOD_MS[&apos;7d&apos;];
 44:     const start = new Date(now.getTime() - periodMs);
 45:     const prevStart = new Date(start.getTime() - periodMs);
 46: 
 47:     const [evaluations, prevEvaluations] = await Promise.all([
 48:       loadEvaluationsForMetric(name, start.toISOString(), now.toISOString()),
 49:       loadEvaluationsForMetric(name, prevStart.toISOString(), start.toISOString()),
 50:     ]);
 51: 
 52:     // Compute previous-period aggregations for trend calculation
 53:     const previousValues = prevEvaluations.length &gt; 0
 54:       ? computeAggregations(
 55:           prevEvaluations
 56:             .map(e =&gt; e.scoreValue)
 57:             .filter((v): v is number =&gt; v != null &amp;&amp; Number.isFinite(v)),
 58:           config.aggregations,
 59:         )
 60:       : undefined;
 61: 
 62:     const detail = computeMetricDetail(evaluations, config, {
 63:       topN: topNResult.data,
 64:       bucketCount: bucketResult.data,
 65:       previousValues,
 66:     });
 67: 
 68:     let dynamics = undefined;
 69:     if (detail.trend) {
 70:       dynamics = computeMetricDynamics(
 71:         detail.trend,
 72:         undefined,
 73:         periodResult.data === &apos;24h&apos; ? 1 : 24,
 74:       );
 75:     }
 76: 
 77:     return c.json({ ...detail, dynamics });
 78:   } catch (err) {
 79:     return c.json({ error: sanitizeErrorForResponse(err) }, HttpStatus.InternalServerError);
 80:   }
 81: });
 82: 
 83: metricsRoutes.get(&apos;/metrics/:name/evaluations&apos;, async (c) =&gt; {
 84:   const name = c.req.param(&apos;name&apos;);
 85:   const config = getQualityMetric(name);
 86:   if (!config) {
 87:     return c.json({ error: `Unknown metric: ${name}` }, HttpStatus.NotFound);
 88:   }
 89: 
 90:   const periodResult = PeriodSchema.safeParse(c.req.query(&apos;period&apos;));
 91:   if (!periodResult.success) {
 92:     return c.json({ error: ErrorMessage.InvalidPeriod }, HttpStatus.BadRequest);
 93:   }
 94:   const limitResult = LimitSchema.safeParse(c.req.query(&apos;limit&apos;));
 95:   if (!limitResult.success) {
 96:     return c.json({ error: &apos;Invalid limit. Must be integer 1-200.&apos; }, HttpStatus.BadRequest);
 97:   }
 98:   const offsetResult = OffsetSchema.safeParse(c.req.query(&apos;offset&apos;));
 99:   if (!offsetResult.success) {
100:     return c.json({ error: &apos;Invalid offset. Must be non-negative integer.&apos; }, HttpStatus.BadRequest);
101:   }
102:   const sortByResult = SortBySchema.safeParse(c.req.query(&apos;sortBy&apos;));
103:   if (!sortByResult.success) {
104:     return c.json({ error: &apos;Invalid sortBy. Must be score_asc, score_desc, or timestamp_desc.&apos; }, HttpStatus.BadRequest);
105:   }
106:   const scoreLabelResult = ScoreLabelSchema.safeParse(c.req.query(&apos;scoreLabel&apos;) || undefined);
107:   if (!scoreLabelResult.success) {
108:     return c.json({ error: &apos;Invalid scoreLabel. Max 100 characters.&apos; }, HttpStatus.BadRequest);
109:   }
110:   const scoreLabel = scoreLabelResult.data;
111: 
112:   try {
113:     const now = new Date();
114:     const periodMs = PERIOD_MS[periodResult.data] ?? PERIOD_MS[&apos;7d&apos;];
115:     const start = new Date(now.getTime() - periodMs);
116: 
117:     let evaluations = await loadEvaluationsForMetric(name, start.toISOString(), now.toISOString());
118: 
119:     if (scoreLabel) {
120:       evaluations = evaluations.filter(e =&gt; e.scoreLabel === scoreLabel);
121:     }
122: 
123:     const sortBy = sortByResult.data;
124:     evaluations.sort((a, b) =&gt; {
125:       if (sortBy === &apos;score_asc&apos; || sortBy === &apos;score_desc&apos;) {
126:         const aVal = a.scoreValue ?? null;
127:         const bVal = b.scoreValue ?? null;
128:         if (aVal === null &amp;&amp; bVal === null) return 0;
129:         if (aVal === null) return 1;
130:         if (bVal === null) return -1;
131:         return sortBy === &apos;score_asc&apos; ? aVal - bVal : bVal - aVal;
132:       }
133:       return b.timestamp.localeCompare(a.timestamp);
134:     });
135: 
136:     const total = evaluations.length;
137:     const limit = limitResult.data;
138:     const offset = offsetResult.data;
139:     const page = evaluations.slice(offset, offset + limit);
140: 
141:     const rows = page.map(e =&gt; ({
142:       score: e.scoreValue ?? 0,
143:       explanation: e.explanation,
144:       traceId: e.traceId,
145:       timestamp: e.timestamp,
146:       evaluator: e.evaluator,
147:       label: e.scoreLabel,
148:       evaluatorType: e.evaluatorType,
149:       spanId: e.spanId,
150:       sessionId: e.sessionId,
151:       agentName: e.agentName,
152:       trajectoryLength: e.trajectoryLength,
153:       stepScores: e.stepScores,
154:       toolVerifications: e.toolVerifications,
155:     }));
156: 
157:     return c.json({ rows, total, limit, offset, hasMore: offset + limit &lt; total });
158:   } catch (err) {
159:     return c.json({ error: sanitizeErrorForResponse(err) }, HttpStatus.InternalServerError);
160:   }
161: });</file><file path="src/api/routes/quality.ts"> 1: import { Hono } from &apos;hono&apos;;
 2: import { sanitizeErrorForResponse } from &apos;../../../../dist/lib/error-sanitizer.js&apos;;
 3: import { loadEvaluationsByMetric } from &apos;../data-loader.js&apos;;
 4: import { LIVE_WINDOW_MS, EVAL_LIMIT, HttpStatus } from &apos;../../lib/constants.js&apos;;
 5: 
 6: export const qualityRoutes = new Hono();
 7: 
 8: interface LiveMetric {
 9:   name: string;
10:   score: number;
11:   evaluatorType: string;
12:   timestamp: string;
13: }
14: 
15: interface QualityLiveResponse {
16:   metrics: LiveMetric[];
17:   sessionCount: number;
18:   lastUpdated: string;
19: }
20: 
21: /**
22:  * GET /api/quality/live
23:  * Returns latest quality evaluation results from today&apos;s evaluations.
24:  * Response: { metrics, sessionCount, lastUpdated }
25:  */
26: qualityRoutes.get(&apos;/quality/live&apos;, async (c) =&gt; {
27:   try {
28:     const now = new Date();
29:     const start = new Date(now.getTime() - LIVE_WINDOW_MS);
30: 
31:     const evaluationsByMetric = await loadEvaluationsByMetric(
32:       start.toISOString(),
33:       now.toISOString(),
34:     );
35: 
36:     const metrics: LiveMetric[] = [];
37:     const sessionIds = new Set&lt;string&gt;();
38:     let latestTimestamp = &apos;&apos;;
39: 
40:     for (const [name, evals] of evaluationsByMetric) {
41:       // Take last EVAL_LIMIT records, sorted by timestamp desc
42:       const sorted = evals
43:         .slice()
44:         .sort((a, b) =&gt; b.timestamp.localeCompare(a.timestamp))
45:         .slice(0, EVAL_LIMIT);
46: 
47:       // Track sessions
48:       for (const ev of sorted) {
49:         if (ev.traceId) sessionIds.add(ev.traceId);
50:       }
51: 
52:       // Latest eval for this metric
53:       const latest = sorted[0];
54:       if (latest &amp;&amp; latest.scoreValue != null) {
55:         metrics.push({
56:           name,
57:           score: latest.scoreValue,
58:           evaluatorType: latest.evaluatorType ?? &apos;unknown&apos;,
59:           timestamp: latest.timestamp,
60:         });
61:         if (latest.timestamp &gt; latestTimestamp) {
62:           latestTimestamp = latest.timestamp;
63:         }
64:       }
65:     }
66: 
67:     // Sort by metric name for stable ordering
68:     metrics.sort((a, b) =&gt; a.name.localeCompare(b.name));
69: 
70:     const response: QualityLiveResponse = {
71:       metrics,
72:       sessionCount: sessionIds.size,
73:       lastUpdated: latestTimestamp || now.toISOString(),
74:     };
75: 
76:     return c.json(response);
77:   } catch (err) {
78:     return c.json({ error: sanitizeErrorForResponse(err) }, HttpStatus.InternalServerError);
79:   }
80: });</file><file path="src/api/routes/sessions.ts">  1: import { Hono } from &apos;hono&apos;;
  2: import { computeMultiAgentEvaluation } from &apos;../../../../dist/lib/quality-multi-agent.js&apos;;
  3: import { sanitizeErrorForResponse } from &apos;../../../../dist/lib/error-sanitizer.js&apos;;
  4: import { HttpStatus } from &apos;../../lib/constants.js&apos;;
  5: import {
  6:   loadEvaluationsBySessionId,
  7:   loadLogsBySessionId,
  8: } from &apos;../data-loader.js&apos;;
  9: import { queryTraces } from &apos;../../../../dist/tools/query-traces.js&apos;;
 10: import type { EvaluationResult, TraceSpan, StepScore } from &apos;../../../../dist/backends/index.js&apos;;
 11: 
 12: export const sessionRoutes = new Hono();
 13: 
 14: function attr&lt;T&gt;(span: { attributes?: Record&lt;string, unknown&gt; }, key: string): T | undefined {
 15:   return span.attributes?.[key] as T | undefined;
 16: }
 17: 
 18: function percentile(sorted: number[], p: number): number {
 19:   if (sorted.length === 0) return 0;
 20:   const idx = Math.ceil(sorted.length * p / 100) - 1;
 21:   return sorted[Math.max(0, idx)];
 22: }
 23: 
 24: /** Load spans for a session, defaulting to 30-day window. */
 25: async function loadSessionSpans(sessionId: string, startDate?: string, endDate?: string) {
 26:   const now = new Date();
 27:   const end = endDate ?? now.toISOString().split(&apos;T&apos;)[0];
 28:   const start = startDate ?? new Date(now.getTime() - 30 * 24 * 60 * 60 * 1000).toISOString().split(&apos;T&apos;)[0];
 29:   const result = await queryTraces({
 30:     attributeFilter: { &apos;session.id&apos;: sessionId },
 31:     startDate: start,
 32:     endDate: end,
 33:     limit: 1000,
 34:   });
 35:   return result.traces;
 36: }
 37: 
 38: /**
 39:  * GET /api/sessions/:sessionId
 40:  *
 41:  * Returns structured session data from all available telemetry sources:
 42:  * traces, logs, and evaluations — queried in parallel by sessionId.
 43:  */
 44: sessionRoutes.get(&apos;/sessions/:sessionId&apos;, async (c) =&gt; {
 45:   const sessionId = c.req.param(&apos;sessionId&apos;);
 46:   if (!sessionId) return c.json({ error: &apos;sessionId required&apos; }, HttpStatus.BadRequest);
 47:   const startDate = c.req.query(&apos;startDate&apos;);
 48:   const endDate = c.req.query(&apos;endDate&apos;);
 49: 
 50:   try {
 51:     // Query all 3 data sources in parallel
 52:     const [spans, logs, evaluations] = await Promise.all([
 53:       loadSessionSpans(sessionId, startDate, endDate),
 54:       loadLogsBySessionId(sessionId, startDate, endDate),
 55:       loadEvaluationsBySessionId(sessionId, startDate, endDate),
 56:     ]);
 57: 
 58:     // ---- Data Sources Inventory ----
 59:     const traceIds = new Set&lt;string&gt;();
 60:     for (const s of spans) {
 61:       if (s.traceId) traceIds.add(s.traceId);
 62:     }
 63:     const dataSources = {
 64:       traces: { count: spans.length, traceIds: traceIds.size },
 65:       logs: { count: logs.length },
 66:       evaluations: { count: evaluations.length },
 67:       total: spans.length + logs.length + evaluations.length,
 68:     };
 69: 
 70:     // ---- Session Timespan (from evaluation timestamps — trace query strips time fields) ----
 71:     let tsMin = Infinity;
 72:     let tsMax = -Infinity;
 73:     for (const ev of evaluations) {
 74:       const t = new Date(ev.timestamp).getTime();
 75:       if (t &lt; tsMin) tsMin = t;
 76:       if (t &gt; tsMax) tsMax = t;
 77:     }
 78:     for (const l of logs) {
 79:       const t = new Date((l as { timestamp?: string }).timestamp ?? &apos;&apos;).getTime();
 80:       if (!isNaN(t)) {
 81:         if (t &lt; tsMin) tsMin = t;
 82:         if (t &gt; tsMax) tsMax = t;
 83:       }
 84:     }
 85:     const timespan = tsMin &lt; Infinity ? {
 86:       start: new Date(tsMin).toISOString(),
 87:       end: new Date(tsMax).toISOString(),
 88:       durationHours: +((tsMax - tsMin) / 3_600_000).toFixed(1),
 89:     } : null;
 90: 
 91:     // ---- Session Info from session-start spans ----
 92:     const sessionStarts = spans.filter(s =&gt; attr&lt;string&gt;(s, &apos;hook.name&apos;) === &apos;session-start&apos;);
 93:     const first = sessionStarts[0];
 94:     const last = sessionStarts[sessionStarts.length - 1] ?? first;
 95:     const sessionInfo = first ? {
 96:       projectName: attr&lt;string&gt;(first, &apos;project.name&apos;) ?? &apos;unknown&apos;,
 97:       workingDirectory: attr&lt;string&gt;(first, &apos;working.directory&apos;) ?? &apos;&apos;,
 98:       gitRepository: attr&lt;string&gt;(first, &apos;git.repository&apos;) ?? &apos;&apos;,
 99:       gitBranch: attr&lt;string&gt;(first, &apos;git.branch&apos;) ?? &apos;&apos;,
100:       nodeVersion: attr&lt;string&gt;(first, &apos;node.version&apos;) ?? &apos;&apos;,
101:       resumeCount: sessionStarts.length,
102:       initialMessageCount: attr&lt;number&gt;(first, &apos;context.message_count&apos;) ?? 0,
103:       initialContextTokens: attr&lt;number&gt;(first, &apos;context.estimated_tokens&apos;) ?? 0,
104:       finalMessageCount: attr&lt;number&gt;(last, &apos;context.message_count&apos;) ?? 0,
105:       taskCount: attr&lt;number&gt;(first, &apos;tasks.active&apos;) ?? 0,
106:       uncommittedAtStart: attr&lt;number&gt;(first, &apos;git.uncommitted&apos;) ?? 0,
107:     } : null;
108: 
109:     // ---- Token Progression ----
110:     const tokenProgression = spans
111:       .filter(s =&gt; attr&lt;string&gt;(s, &apos;hook.name&apos;) === &apos;token-metrics-extraction&apos;)
112:       .map(s =&gt; ({
113:         messages: attr&lt;number&gt;(s, &apos;tokens.messages&apos;) ?? 0,
114:         inputTokens: attr&lt;number&gt;(s, &apos;tokens.input&apos;) ?? 0,
115:         outputTokens: attr&lt;number&gt;(s, &apos;tokens.output&apos;) ?? 0,
116:         cacheRead: attr&lt;number&gt;(s, &apos;tokens.cache_read&apos;) ?? 0,
117:         cacheCreation: attr&lt;number&gt;(s, &apos;tokens.cache_creation&apos;) ?? 0,
118:         model: attr&lt;string&gt;(s, &apos;tokens.model&apos;) ?? &apos;&apos;,
119:       }))
120:       .sort((a, b) =&gt; a.messages - b.messages);
121: 
122:     // ---- Token Totals ----
123:     const tokenTotals = {
124:       input: 0, output: 0, cacheRead: 0, cacheCreation: 0, messages: 0,
125:       models: {} as Record&lt;string, number&gt;,
126:     };
127:     for (const t of tokenProgression) {
128:       tokenTotals.input += t.inputTokens;
129:       tokenTotals.output += t.outputTokens;
130:       tokenTotals.cacheRead += t.cacheRead;
131:       tokenTotals.cacheCreation += t.cacheCreation;
132:       tokenTotals.messages += t.messages;
133:       if (t.model) tokenTotals.models[t.model] = (tokenTotals.models[t.model] ?? 0) + 1;
134:     }
135: 
136:     // ---- Tool Usage ----
137:     const toolUsage: Record&lt;string, number&gt; = {};
138:     for (const s of spans) {
139:       if (attr&lt;string&gt;(s, &apos;hook.type&apos;) === &apos;builtin&apos; &amp;&amp; attr&lt;string&gt;(s, &apos;hook.trigger&apos;) === &apos;PostToolUse&apos;) {
140:         const tool = attr&lt;string&gt;(s, &apos;builtin.tool&apos;) ?? &apos;unknown&apos;;
141:         toolUsage[tool] = (toolUsage[tool] ?? 0) + 1;
142:       }
143:     }
144: 
145:     // ---- MCP Usage ----
146:     const mcpUsage: Record&lt;string, number&gt; = {};
147:     for (const s of spans) {
148:       if (attr&lt;string&gt;(s, &apos;hook.type&apos;) === &apos;mcp&apos; &amp;&amp; attr&lt;string&gt;(s, &apos;hook.trigger&apos;) === &apos;PostToolUse&apos;) {
149:         const tool = attr&lt;string&gt;(s, &apos;mcp.tool&apos;) ?? &apos;unknown&apos;;
150:         mcpUsage[tool] = (mcpUsage[tool] ?? 0) + 1;
151:       }
152:     }
153: 
154:     // ---- Span Breakdown + Hook Latency ----
155:     const spanBreakdown: Record&lt;string, number&gt; = {};
156:     const hookDurations: Record&lt;string, number[]&gt; = {};
157:     for (const s of spans) {
158:       spanBreakdown[s.name] = (spanBreakdown[s.name] ?? 0) + 1;
159:       const ms = s.durationMs ?? 0;
160:       if (ms &gt; 0) {
161:         if (!hookDurations[s.name]) hookDurations[s.name] = [];
162:         hookDurations[s.name].push(ms);
163:       }
164:     }
165:     const hookLatency: Record&lt;string, { count: number; avg: number; p50: number; p95: number; max: number }&gt; = {};
166:     for (const [name, durations] of Object.entries(hookDurations)) {
167:       const sorted = durations.sort((a, b) =&gt; a - b);
168:       hookLatency[name] = {
169:         count: sorted.length,
170:         avg: +(sorted.reduce((a, b) =&gt; a + b, 0) / sorted.length).toFixed(1),
171:         p50: +percentile(sorted, 50).toFixed(1),
172:         p95: +percentile(sorted, 95).toFixed(1),
173:         max: +sorted[sorted.length - 1].toFixed(1),
174:       };
175:     }
176: 
177:     // ---- Error Categorization ----
178:     const errorsByCategory: Record&lt;string, number&gt; = {};
179:     const errorDetails: Array&lt;{
180:       spanName: string;
181:       tool?: string;
182:       errorType?: string;
183:       filePath?: string;
184:     }&gt; = [];
185:     for (const s of spans) {
186:       const hasError = attr&lt;boolean&gt;(s, &apos;builtin.has_error&apos;) === true
187:         || attr&lt;boolean&gt;(s, &apos;agent.has_error&apos;) === true
188:         || s.status?.code === 2;
189:       if (!hasError) continue;
190:       const tool = attr&lt;string&gt;(s, &apos;builtin.tool&apos;) ?? attr&lt;string&gt;(s, &apos;agent.type&apos;) ?? &apos;unknown&apos;;
191:       const errType = attr&lt;string&gt;(s, &apos;builtin.error_type&apos;) ?? &apos;unknown&apos;;
192:       const key = `${tool} -&gt; ${errType}`;
193:       errorsByCategory[key] = (errorsByCategory[key] ?? 0) + 1;
194:       errorDetails.push({
195:         spanName: s.name,
196:         tool,
197:         errorType: errType,
198:         filePath: attr&lt;string&gt;(s, &apos;builtin.file_path&apos;),
199:       });
200:     }
201: 
202:     // ---- Agent Activity ----
203:     const agentAcc: Record&lt;string, { invocations: number; errors: number; hasRateLimit: boolean; totalOutputSize: number }&gt; = {};
204:     for (const s of spans) {
205:       if (attr&lt;string&gt;(s, &apos;hook.name&apos;) === &apos;agent-post-tool&apos;) {
206:         const name = attr&lt;string&gt;(s, &apos;gen_ai.agent.name&apos;) ?? &apos;unknown&apos;;
207:         if (!agentAcc[name]) agentAcc[name] = { invocations: 0, errors: 0, hasRateLimit: false, totalOutputSize: 0 };
208:         agentAcc[name].invocations++;
209:         if (attr&lt;boolean&gt;(s, &apos;agent.has_error&apos;)) agentAcc[name].errors++;
210:         if (attr&lt;boolean&gt;(s, &apos;agent.has_rate_limit&apos;)) agentAcc[name].hasRateLimit = true;
211:         agentAcc[name].totalOutputSize += attr&lt;number&gt;(s, &apos;agent.output_size&apos;) ?? 0;
212:       }
213:     }
214:     const agentActivity = Object.entries(agentAcc).map(([agentName, d]) =&gt; ({
215:       agentName,
216:       invocations: d.invocations,
217:       errors: d.errors,
218:       hasRateLimit: d.hasRateLimit,
219:       avgOutputSize: d.invocations &gt; 0 ? Math.round(d.totalOutputSize / d.invocations) : 0,
220:     }));
221: 
222:     // ---- File Access ----
223:     const fileCount: Record&lt;string, number&gt; = {};
224:     for (const s of spans) {
225:       const fp = attr&lt;string&gt;(s, &apos;builtin.file_path&apos;);
226:       if (fp) fileCount[fp] = (fileCount[fp] ?? 0) + 1;
227:     }
228:     const fileAccess = Object.entries(fileCount)
229:       .map(([path, count]) =&gt; ({ path, count }))
230:       .sort((a, b) =&gt; b.count - a.count)
231:       .slice(0, 30);
232: 
233:     // ---- Git Commits ----
234:     const gitCommits = spans
235:       .filter(s =&gt; attr&lt;string&gt;(s, &apos;hook.name&apos;) === &apos;post-commit-review&apos;)
236:       .map(s =&gt; {
237:         const raw = attr&lt;string&gt;(s, &apos;git.command&apos;) ?? &apos;&apos;;
238:         const filesMatch = raw.match(/git add (.+?)(?:\s+&amp;&amp;)/s);
239:         const files = filesMatch ? filesMatch[1].trim() : &apos;&apos;;
240:         const msgMatch = raw.match(/&lt;&lt;&apos;?EOF&apos;?\n([\s\S]+?)\nCo-Authored/);
241:         const fullMessage = msgMatch ? msgMatch[1] : &apos;&apos;;
242:         const subject = fullMessage ? fullMessage.split(&apos;\n&apos;)[0].trim() : raw.slice(0, 80);
243:         const body = fullMessage ? fullMessage.split(&apos;\n&apos;).slice(2).join(&apos;\n&apos;).trim() : &apos;&apos;;
244:         return { subject, body, files };
245:       });
246: 
247:     // ---- Alert Summary ----
248:     const alertSpans = spans.filter(s =&gt; attr&lt;string&gt;(s, &apos;hook.name&apos;) === &apos;telemetry-alert-evaluation&apos;);
249:     const alertSummary = {
250:       totalFired: alertSpans.reduce((sum, s) =&gt; sum + (attr&lt;number&gt;(s, &apos;alerts.triggered_count&apos;) ?? 0), 0),
251:       stopEvents: alertSpans.length,
252:     };
253: 
254:     // ---- Code Structure ----
255:     const codeStructure = spans
256:       .filter(s =&gt; attr&lt;string&gt;(s, &apos;hook.name&apos;) === &apos;code-structure&apos;)
257:       .map(s =&gt; ({
258:         file: attr&lt;string&gt;(s, &apos;code.structure.file&apos;) ?? &apos;&apos;,
259:         lines: attr&lt;number&gt;(s, &apos;code.structure.lines&apos;) ?? 0,
260:         exports: attr&lt;number&gt;(s, &apos;code.structure.exports&apos;) ?? 0,
261:         functions: attr&lt;number&gt;(s, &apos;code.structure.functions&apos;) ?? 0,
262:         hasTypes: attr&lt;boolean&gt;(s, &apos;code.structure.has_types&apos;) ?? false,
263:         score: attr&lt;number&gt;(s, &apos;code.structure.score&apos;) ?? 0,
264:         tool: attr&lt;string&gt;(s, &apos;code.structure.tool&apos;) ?? &apos;&apos;,
265:       }));
266: 
267:     // ---- Evaluation Breakdown (from direct sessionId query) ----
268:     const evalByName: Record&lt;string, { count: number; scores: number[] }&gt; = {};
269:     for (const ev of evaluations) {
270:       const name = ev.evaluationName;
271:       if (!evalByName[name]) evalByName[name] = { count: 0, scores: [] };
272:       evalByName[name].count++;
273:       if (ev.scoreValue != null &amp;&amp; Number.isFinite(ev.scoreValue)) {
274:         evalByName[name].scores.push(ev.scoreValue);
275:       }
276:     }
277:     const evaluationBreakdown = Object.entries(evalByName).map(([name, d]) =&gt; {
278:       const sorted = d.scores.sort((a, b) =&gt; a - b);
279:       return {
280:         name,
281:         count: d.count,
282:         avg: sorted.length &gt; 0 ? +(sorted.reduce((a, b) =&gt; a + b, 0) / sorted.length).toFixed(3) : null,
283:         min: sorted.length &gt; 0 ? +sorted[0].toFixed(3) : null,
284:         max: sorted.length &gt; 0 ? +sorted[sorted.length - 1].toFixed(3) : null,
285:       };
286:     });
287: 
288:     // ---- Log Summary ----
289:     const logBySeverity: Record&lt;string, number&gt; = {};
290:     for (const l of logs) {
291:       const sev = (l as { severity?: string }).severity ?? &apos;UNKNOWN&apos;;
292:       logBySeverity[sev] = (logBySeverity[sev] ?? 0) + 1;
293:     }
294: 
295:     // ---- Multi-agent Evaluation ----
296:     const agentMapForEval = new Map&lt;number, string&gt;();
297:     spans.forEach((span, i) =&gt; {
298:       const agent = span.attributes?.[&apos;agent.name&apos;] as string | undefined;
299:       if (agent) agentMapForEval.set(i, agent);
300:     });
301:     const stepScores: StepScore[] = spans.map((span, i) =&gt; ({
302:       step: i,
303:       score: typeof span.attributes?.[&apos;evaluation.score&apos;] === &apos;number&apos;
304:         ? span.attributes[&apos;evaluation.score&apos;] as number
305:         : (span.status?.code === 2 ? 0 : 1),
306:       explanation: span.name,
307:     }));
308:     const multiAgentEvaluation = computeMultiAgentEvaluation(stepScores, agentMapForEval);
309: 
310:     return c.json({
311:       sessionId,
312:       dataSources,
313:       timespan,
314:       sessionInfo,
315:       tokenTotals,
316:       tokenProgression,
317:       toolUsage,
318:       mcpUsage,
319:       spanBreakdown,
320:       hookLatency,
321:       errors: { byCategory: errorsByCategory, details: errorDetails },
322:       agentActivity,
323:       fileAccess,
324:       gitCommits,
325:       alertSummary,
326:       codeStructure,
327:       evaluationBreakdown,
328:       logSummary: { bySeverity: logBySeverity, logs },
329:       multiAgentEvaluation,
330:       evaluations,
331:     });
332:   } catch (err) {
333:     return c.json({ error: sanitizeErrorForResponse(err) }, HttpStatus.InternalServerError);
334:   }
335: });</file><file path="src/api/routes/trends.ts">  1: import { Hono } from &apos;hono&apos;;
  2: import { z } from &apos;zod&apos;;
  3: import {
  4:   computeMetricDetail,
  5:   computeAggregations,
  6:   getQualityMetric,
  7:   QUALITY_METRICS,
  8: } from &apos;../../../../dist/lib/quality-metrics.js&apos;;
  9: import {
 10:   computePercentileDistribution,
 11:   computeMetricDynamics,
 12: } from &apos;../../../../dist/lib/quality-feature-engineering.js&apos;;
 13: import type { MetricTrend } from &apos;../../../../dist/lib/quality-metrics.js&apos;;
 14: import { sanitizeErrorForResponse } from &apos;../../../../dist/lib/error-sanitizer.js&apos;;
 15: import { loadEvaluationsForMetric } from &apos;../data-loader.js&apos;;
 16: import { PeriodSchema, PERIOD_MS, ErrorMessage, HttpStatus } from &apos;../../lib/constants.js&apos;;
 17: const BucketsSchema = z.coerce.number().int().min(3).max(30).default(7);
 18: 
 19: export const trendRoutes = new Hono();
 20: 
 21: /**
 22:  * GET /api/trends/:name
 23:  * Returns time-bucketed trend data with percentile distributions and metric dynamics.
 24:  *
 25:  * Query params:
 26:  *   period: &apos;24h&apos; | &apos;7d&apos; | &apos;30d&apos; (default: &apos;7d&apos;)
 27:  *   buckets: number 3-30 (default: 7) — how many time buckets to divide the period into
 28:  */
 29: trendRoutes.get(&apos;/trends/:name&apos;, async (c) =&gt; {
 30:   const name = c.req.param(&apos;name&apos;);
 31:   const config = getQualityMetric(name);
 32:   if (!config) {
 33:     return c.json({ error: `Unknown metric: ${name}` }, HttpStatus.NotFound);
 34:   }
 35: 
 36:   const periodResult = PeriodSchema.safeParse(c.req.query(&apos;period&apos;));
 37:   if (!periodResult.success) {
 38:     return c.json({ error: ErrorMessage.InvalidPeriod }, HttpStatus.BadRequest);
 39:   }
 40:   const bucketsResult = BucketsSchema.safeParse(c.req.query(&apos;buckets&apos;));
 41:   if (!bucketsResult.success) {
 42:     return c.json({ error: &apos;Invalid buckets. Must be integer 3-30.&apos; }, HttpStatus.BadRequest);
 43:   }
 44: 
 45:   try {
 46:     const now = new Date();
 47:     const period = periodResult.data;
 48:     const bucketCount = bucketsResult.data;
 49:     const periodMs = PERIOD_MS[period] ?? PERIOD_MS[&apos;7d&apos;];
 50:     const periodStart = new Date(now.getTime() - periodMs);
 51: 
 52:     const evaluations = await loadEvaluationsForMetric(name, periodStart.toISOString(), now.toISOString());
 53: 
 54:     // Determine actual data range — auto-narrow if data is concentrated
 55:     const timestamps = evaluations
 56:       .map(e =&gt; new Date(e.timestamp).getTime())
 57:       .filter(Number.isFinite);
 58:     const dataMin = timestamps.length &gt; 0 ? Math.min(...timestamps) : periodStart.getTime();
 59:     const dataMax = timestamps.length &gt; 0 ? Math.max(...timestamps) : now.getTime();
 60:     const dataSpan = dataMax - dataMin;
 61:     const CONCENTRATION_THRESHOLD = 0.2;
 62:     const narrowed = timestamps.length &gt; 1 &amp;&amp; dataSpan &lt; periodMs * CONCENTRATION_THRESHOLD;
 63:     const pad = narrowed ? Math.max(dataSpan * 0.1, 60_000) : 0;
 64:     const start = narrowed ? new Date(dataMin - pad) : periodStart;
 65:     const end = narrowed ? new Date(dataMax + pad) : now;
 66:     const rangeMs = end.getTime() - start.getTime();
 67:     const bucketMs = rangeMs / bucketCount;
 68: 
 69:     // Group evaluations into time buckets
 70:     const buckets: Array&lt;{
 71:       startTime: string;
 72:       endTime: string;
 73:       scores: number[];
 74:     }&gt; = [];
 75: 
 76:     for (let i = 0; i &lt; bucketCount; i++) {
 77:       const bucketStart = new Date(start.getTime() + i * bucketMs);
 78:       const bucketEnd = new Date(start.getTime() + (i + 1) * bucketMs);
 79:       buckets.push({
 80:         startTime: bucketStart.toISOString(),
 81:         endTime: bucketEnd.toISOString(),
 82:         scores: [],
 83:       });
 84:     }
 85: 
 86:     for (const ev of evaluations) {
 87:       const ts = new Date(ev.timestamp).getTime();
 88:       const bucketIdx = Math.min(
 89:         Math.floor((ts - start.getTime()) / bucketMs),
 90:         bucketCount - 1,
 91:       );
 92:       if (bucketIdx &gt;= 0 &amp;&amp; ev.scoreValue != null &amp;&amp; Number.isFinite(ev.scoreValue)) {
 93:         buckets[bucketIdx].scores.push(ev.scoreValue);
 94:       }
 95:     }
 96: 
 97:     // Compute per-bucket aggregations and trends
 98:     const periodHours = rangeMs / (bucketCount * 3600000);
 99:     let previousTrend: MetricTrend | undefined;
100: 
101:     const trendData = buckets.map((bucket, idx) =&gt; {
102:       const scores = bucket.scores;
103:       const percentiles = computePercentileDistribution(scores);
104:       const avg = scores.length &gt; 0 ? scores.reduce((s, v) =&gt; s + v, 0) / scores.length : null;
105:       const count = scores.length;
106: 
107:       // Compute previous bucket aggregations for trend
108:       const previousValues = (idx &gt; 0 &amp;&amp; buckets[idx - 1].scores.length &gt; 0)
109:         ? computeAggregations(buckets[idx - 1].scores, config.aggregations)
110:         : undefined;
111: 
112:       // Compute metric detail for trend
113:       const detail = scores.length &gt; 0
114:         ? computeMetricDetail(
115:             evaluations.filter(e =&gt; {
116:               const ts = new Date(e.timestamp).getTime();
117:               const bStart = new Date(bucket.startTime).getTime();
118:               const bEnd = new Date(bucket.endTime).getTime();
119:               return ts &gt;= bStart &amp;&amp; ts &lt; bEnd;
120:             }),
121:             config,
122:             { topN: 0, bucketCount: 0, previousValues },
123:           )
124:         : undefined;
125: 
126:       // Compute dynamics from current and previous trend
127:       let dynamics = undefined;
128:       if (detail?.trend) {
129:         dynamics = computeMetricDynamics(
130:           detail.trend,
131:           previousTrend,
132:           periodHours,
133:         );
134:         previousTrend = detail.trend;
135:       }
136: 
137:       return {
138:         startTime: bucket.startTime,
139:         endTime: bucket.endTime,
140:         count,
141:         avg: avg != null ? Math.round(avg * 10000) / 10000 : null,
142:         percentiles,
143:         trend: detail?.trend ?? null,
144:         dynamics: dynamics ?? null,
145:       };
146:     });
147: 
148:     // Overall percentile distribution across the full period
149:     const allScores = evaluations
150:       .map(e =&gt; e.scoreValue)
151:       .filter((v): v is number =&gt; v != null &amp;&amp; Number.isFinite(v));
152:     const overallPercentiles = computePercentileDistribution(allScores);
153: 
154:     return c.json({
155:       metric: name,
156:       period,
157:       bucketCount,
158:       totalEvaluations: allScores.length,
159:       overallPercentiles,
160:       trendData,
161:       narrowed,
162:     });
163:   } catch (err) {
164:     return c.json({ error: sanitizeErrorForResponse(err) }, HttpStatus.InternalServerError);
165:   }
166: });
167: 
168: /**
169:  * GET /api/trends
170:  * Returns trend summary for all metrics (latest percentiles + count).
171:  */
172: trendRoutes.get(&apos;/trends&apos;, async (c) =&gt; {
173:   const periodResult = PeriodSchema.safeParse(c.req.query(&apos;period&apos;));
174:   if (!periodResult.success) {
175:     return c.json({ error: ErrorMessage.InvalidPeriod }, HttpStatus.BadRequest);
176:   }
177: 
178:   try {
179:     const now = new Date();
180:     const period = periodResult.data;
181:     const periodMs = PERIOD_MS[period] ?? PERIOD_MS[&apos;7d&apos;];
182:     const start = new Date(now.getTime() - periodMs);
183: 
184:     const metricNames = Object.keys(QUALITY_METRICS);
185:     const summaries = await Promise.all(
186:       metricNames.map(async (name: string) =&gt; {
187:         const evals = await loadEvaluationsForMetric(name, start.toISOString(), now.toISOString());
188:         const scores = evals
189:           .map(e =&gt; e.scoreValue)
190:           .filter((v): v is number =&gt; v != null &amp;&amp; Number.isFinite(v));
191:         return {
192:           metric: name,
193:           count: scores.length,
194:           percentiles: computePercentileDistribution(scores) ?? null,
195:         };
196:       }),
197:     );
198: 
199:     return c.json({ period, metrics: summaries });
200:   } catch (err) {
201:     return c.json({ error: sanitizeErrorForResponse(err) }, HttpStatus.InternalServerError);
202:   }
203: });</file><file path="src/components/views/OperatorView.tsx"> 1: import type { OperatorView as OperatorViewType } from &apos;../../types.js&apos;;
 2: import { StatusBadge, TrendIndicator } from &apos;../Indicators.js&apos;;
 3: import { AlertList } from &apos;../AlertList.js&apos;;
 4: import { MetricGrid } from &apos;../MetricGrid.js&apos;;
 5: import { ViewSection } from &apos;../Section.js&apos;;
 6: 
 7: export function OperatorView({ data }: { data: OperatorViewType }) {
 8:   return (
 9:     &lt;div&gt;
10:       &lt;div className={`health-banner ${data.overallStatus}`}&gt;
11:         &lt;div className=&quot;flex-center gap-3&quot;&gt;
12:           &lt;StatusBadge status={data.overallStatus} /&gt;
13:           &lt;span&gt;Operator View &amp;middot; {data.prioritizedAlerts.length} active alert{data.prioritizedAlerts.length !== 1 ? &apos;s&apos; : &apos;&apos;}&lt;/span&gt;
14:         &lt;/div&gt;
15:       &lt;/div&gt;
16: 
17:       {data.prioritizedAlerts.length &gt; 0 &amp;&amp; (
18:         &lt;ViewSection title=&quot;Prioritized Alerts&quot;&gt;
19:           &lt;AlertList alerts={data.prioritizedAlerts} /&gt;
20:         &lt;/ViewSection&gt;
21:       )}
22: 
23:       {data.degradingTrends.length &gt; 0 &amp;&amp; (
24:         &lt;ViewSection title=&quot;Degrading Trends&quot;&gt;
25:           &lt;ul className=&quot;alert-list&quot;&gt;
26:             {data.degradingTrends.map((dt) =&gt; (
27:               &lt;li key={dt.metricName} className=&quot;alert-item warning&quot;&gt;
28:                 &lt;div className=&quot;alert-message&quot;&gt;
29:                   {dt.metricName} &lt;TrendIndicator trend={dt.trend} /&gt;
30:                 &lt;/div&gt;
31:                 &lt;div className=&quot;alert-meta text-secondary text-xs&quot;&gt;
32:                   {dt.trend.previousValue?.toFixed(4)} &amp;rarr; {dt.trend.currentValue?.toFixed(4)}
33:                 &lt;/div&gt;
34:               &lt;/li&gt;
35:             ))}
36:           &lt;/ul&gt;
37:         &lt;/ViewSection&gt;
38:       )}
39: 
40:       {data.alertingMetrics.length &gt; 0 &amp;&amp; (
41:         &lt;ViewSection title=&quot;Alerting Metrics&quot;&gt;
42:           &lt;MetricGrid metrics={data.alertingMetrics} /&gt;
43:         &lt;/ViewSection&gt;
44:       )}
45: 
46:       {data.prioritizedAlerts.length === 0 &amp;&amp; data.degradingTrends.length === 0 &amp;&amp; (
47:         &lt;div className=&quot;empty-state&quot;&gt;
48:           &lt;h2&gt;All Clear&lt;/h2&gt;
49:           &lt;p&gt;No active alerts or degrading trends.&lt;/p&gt;
50:         &lt;/div&gt;
51:       )}
52:     &lt;/div&gt;
53:   );
54: }</file><file path="src/components/ChainOfThoughtPanel.tsx"> 1: import { MetaItem } from &apos;./MetaItem.js&apos;;
 2: 
 3: interface ChainOfThoughtPanelProps {
 4:   explanation?: string;
 5:   evaluator?: string;
 6: }
 7: 
 8: export function ChainOfThoughtPanel({ explanation, evaluator }: ChainOfThoughtPanelProps) {
 9: 
10:   return (
11:     &lt;div className=&quot;cot-panel&quot;&gt;
12:       {explanation &amp;&amp; (
13:         &lt;details open&gt;
14:           &lt;summary className=&quot;cot-summary text-xs&quot;&gt;Explanation&lt;/summary&gt;
15:           &lt;div className=&quot;cot-content&quot;&gt;{explanation}&lt;/div&gt;
16:         &lt;/details&gt;
17:       )}
18:       {evaluator &amp;&amp; (
19:         &lt;div className=&quot;cot-content&quot;&gt;
20:           &lt;MetaItem label=&quot;Evaluator&quot; value={evaluator} /&gt;
21:         &lt;/div&gt;
22:       )}
23:       {!explanation &amp;&amp; !evaluator &amp;&amp; (
24:         &lt;div className=&quot;text-muted text-xs&quot;&gt;
25:           No chain-of-thought data available.
26:         &lt;/div&gt;
27:       )}
28:     &lt;/div&gt;
29:   );
30: }</file><file path="src/components/CoverageGrid.tsx">  1: import { memo, useState, useMemo } from &apos;react&apos;;
  2: import type { CoverageCell, CoverageGap, CoverageStatus } from &apos;../types.js&apos;;
  3: import { truncateId } from &apos;../lib/quality-utils.js&apos;;
  4: 
  5: interface CoverageGridProps {
  6:   metrics: string[];
  7:   inputs: string[];
  8:   cells: CoverageCell[];
  9:   gaps: CoverageGap[];
 10:   overallCoveragePercent: number;
 11: }
 12: 
 13: const STATUS_COLORS: Record&lt;CoverageStatus, string&gt; = {
 14:   covered: &apos;var(--score-good, #0072B2)&apos;,
 15:   partial: &apos;var(--score-fair, #E69F00)&apos;,
 16:   missing: &apos;var(--score-poor, #D55E00)&apos;,
 17: };
 18: 
 19: function CoverageGridInner({ metrics, inputs, cells, gaps, overallCoveragePercent }: CoverageGridProps) {
 20:   const [hovered, setHovered] = useState&lt;{ metric: string; input: string } | null&gt;(null);
 21: 
 22:   const cellMap = useMemo(() =&gt; {
 23:     const map = new Map&lt;string, CoverageCell&gt;();
 24:     for (const cell of cells) {
 25:       map.set(`${cell.metric}|${cell.input}`, cell);
 26:     }
 27:     return map;
 28:   }, [cells]);
 29: 
 30:   if (metrics.length === 0 || inputs.length === 0) {
 31:     return &lt;p&gt;No coverage data available.&lt;/p&gt;;
 32:   }
 33: 
 34:   // Limit displayed inputs to avoid huge grids
 35:   const maxInputs = 30;
 36:   const displayInputs = inputs.slice(0, maxInputs);
 37:   const truncated = inputs.length &gt; maxInputs;
 38: 
 39:   return (
 40:     &lt;div role=&quot;region&quot; aria-label=&quot;Evaluation coverage heatmap&quot;&gt;
 41:       {/* Summary bar */}
 42:       &lt;div className=&quot;flex-center mb-3 gap-3&quot;&gt;
 43:         &lt;span className=&quot;mono-xl font-semibold&quot;&gt;
 44:           {overallCoveragePercent.toFixed(1)}%
 45:         &lt;/span&gt;
 46:         &lt;span className=&quot;text-secondary text-base&quot;&gt;
 47:           coverage ({metrics.length} metrics x {inputs.length} inputs)
 48:         &lt;/span&gt;
 49:       &lt;/div&gt;
 50: 
 51:       {/* Legend */}
 52:       &lt;div className=&quot;mb-3 text-xs gap-4&quot; style={{ display: &apos;flex&apos; }}&gt;
 53:         {([&apos;covered&apos;, &apos;partial&apos;, &apos;missing&apos;] as const).map(status =&gt; (
 54:           &lt;div key={status} className=&quot;flex-center gap-1&quot;&gt;
 55:             &lt;div style={{
 56:               width: 12, height: 12, borderRadius: 2,
 57:               background: STATUS_COLORS[status],
 58:             }} /&gt;
 59:             &lt;span&gt;{status}&lt;/span&gt;
 60:           &lt;/div&gt;
 61:         ))}
 62:       &lt;/div&gt;
 63: 
 64:       {/* Grid */}
 65:       &lt;div style={{ overflowX: &apos;auto&apos; }}&gt;
 66:         &lt;div
 67:           role=&quot;table&quot;
 68:           aria-label=&quot;Coverage matrix&quot;
 69:           className=&quot;gap-half&quot;
 70:           style={{
 71:             display: &apos;grid&apos;,
 72:             gridTemplateColumns: `120px repeat(${displayInputs.length}, 28px)`,
 73:           }}
 74:         &gt;
 75:           {/* Header row */}
 76:           &lt;div role=&quot;row&quot; style={{ display: &apos;contents&apos; }}&gt;
 77:             &lt;div role=&quot;columnheader&quot; className=&quot;text-xs font-semibold&quot; /&gt;
 78:             {displayInputs.map(input =&gt; (
 79:               &lt;div
 80:                 key={input}
 81:                 role=&quot;columnheader&quot;
 82:                 title={input}
 83:                 className=&quot;text-secondary&quot;
 84:                 style={{
 85:                   fontSize: &apos;var(--font-size-2xs)&apos;,
 86:                   writingMode: &apos;vertical-lr&apos;,
 87:                   textAlign: &apos;end&apos;,
 88:                   overflow: &apos;hidden&apos;,
 89:                   maxHeight: 60,
 90:                 }}
 91:               &gt;
 92:                 {truncateId(input, 8)}
 93:               &lt;/div&gt;
 94:             ))}
 95:           &lt;/div&gt;
 96: 
 97:           {/* Data rows */}
 98:           {metrics.map(metric =&gt; (
 99:             &lt;div key={metric} role=&quot;row&quot; style={{ display: &apos;contents&apos; }}&gt;
100:               &lt;div
101:                 role=&quot;rowheader&quot;
102:                 style={{
103:                   fontSize: 12,
104:                   fontWeight: 500,
105:                   display: &apos;flex&apos;,
106:                   alignItems: &apos;center&apos;,
107:                   whiteSpace: &apos;nowrap&apos;,
108:                   overflow: &apos;hidden&apos;,
109:                   textOverflow: &apos;ellipsis&apos;,
110:                 }}
111:                 title={metric}
112:               &gt;
113:                 {metric}
114:               &lt;/div&gt;
115:               {displayInputs.map(input =&gt; {
116:                 const cell = cellMap.get(`${metric}|${input}`);
117:                 const status = cell?.status ?? &apos;missing&apos;;
118:                 const count = cell?.count ?? 0;
119:                 const isHovered = hovered?.metric === metric &amp;&amp; hovered?.input === input;
120: 
121:                 return (
122:                   &lt;div
123:                     key={input}
124:                     role=&quot;cell&quot;
125:                     aria-label={`${metric} / ${truncateId(input)}: ${status} (${count})`}
126:                     title={`${metric} / ${truncateId(input)}: ${count} evaluation${count !== 1 ? &apos;s&apos; : &apos;&apos;}`}
127:                     onMouseEnter={() =&gt; setHovered({ metric, input })}
128:                     onMouseLeave={() =&gt; setHovered(null)}
129:                     className=&quot;mono&quot;
130:                     style={{
131:                       width: 28,
132:                       height: 28,
133:                       borderRadius: 3,
134:                       background: STATUS_COLORS[status],
135:                       opacity: isHovered ? 1 : 0.8,
136:                       cursor: &apos;default&apos;,
137:                       display: &apos;flex&apos;,
138:                       alignItems: &apos;center&apos;,
139:                       justifyContent: &apos;center&apos;,
140:                       fontSize: &apos;var(--font-size-2xs)&apos;,
141:                       fontFamily: &apos;var(--font-mono)&apos;,
142:                       color: &apos;#fff&apos;,
143:                       transition: &apos;opacity 0.15s&apos;,
144:                     }}
145:                   &gt;
146:                     {count &gt; 0 ? count : &apos;&apos;}
147:                   &lt;/div&gt;
148:                 );
149:               })}
150:             &lt;/div&gt;
151:           ))}
152:         &lt;/div&gt;
153:       &lt;/div&gt;
154: 
155:       {truncated &amp;&amp; (
156:         &lt;p className=&quot;text-secondary text-xs&quot; style={{ marginTop: 8 }}&gt;
157:           Showing {maxInputs} of {inputs.length} inputs.
158:         &lt;/p&gt;
159:       )}
160: 
161:       {/* Gap summary */}
162:       {gaps.length &gt; 0 &amp;&amp; (
163:         &lt;div style={{ marginTop: 16 }}&gt;
164:           &lt;h4 className=&quot;mb-1-5 text-base&quot;&gt;Coverage Gaps&lt;/h4&gt;
165:           &lt;ul style={{ margin: 0, paddingLeft: 20, fontSize: 12 }}&gt;
166:             {gaps.map(gap =&gt; (
167:               &lt;li key={gap.metric} className=&quot;mb-1&quot;&gt;
168:                 &lt;strong&gt;{gap.metric}&lt;/strong&gt;: {gap.coveragePercent.toFixed(0)}% covered
169:                 ({gap.missingInputs.length} input{gap.missingInputs.length !== 1 ? &apos;s&apos; : &apos;&apos;} missing)
170:               &lt;/li&gt;
171:             ))}
172:           &lt;/ul&gt;
173:         &lt;/div&gt;
174:       )}
175:     &lt;/div&gt;
176:   );
177: }
178: 
179: export const CoverageGrid = memo(CoverageGridInner);</file><file path="src/components/CQIHero.tsx"> 1: import { scoreColorBand, SCORE_COLORS } from &apos;../lib/quality-utils.js&apos;;
 2: import type { CompositeQualityIndex, CQIContribution } from &apos;../types.js&apos;;
 3: 
 4: function segmentColor(contribution: CQIContribution): string {
 5:   const band = scoreColorBand(contribution.rawScore, &apos;maximize&apos;);
 6:   return SCORE_COLORS[band];
 7: }
 8: 
 9: export function CQIHero({ cqi }: { cqi: CompositeQualityIndex }) {
10:   const displayValue = (cqi.value * 100).toFixed(1);
11:   const overallBand = scoreColorBand(cqi.value, &apos;maximize&apos;);
12: 
13:   return (
14:     &lt;div
15:       role=&quot;region&quot;
16:       aria-label={`Composite Quality Index: ${displayValue}`}
17:       className=&quot;card&quot;
18:       style={{ padding: 24, textAlign: &apos;center&apos; }}
19:     &gt;
20:       &lt;div className=&quot;field-label text-secondary text-xs mb-1&quot;&gt;
21:         Composite Quality Index
22:       &lt;/div&gt;
23:       &lt;div
24:         className=&quot;mono&quot;
25:         style={{
26:           fontSize: 36,
27:           fontWeight: 700,
28:           color: SCORE_COLORS[overallBand],
29:           lineHeight: 1.2,
30:         }}
31:       &gt;
32:         {displayValue}
33:       &lt;/div&gt;
34: 
35:       {cqi.contributions.length &gt; 0 &amp;&amp; (
36:         &lt;div
37:           style={{
38:             display: &apos;flex&apos;,
39:             height: 8,
40:             borderRadius: 4,
41:             overflow: &apos;hidden&apos;,
42:             marginTop: 16,
43:           }}
44:         &gt;
45:           {cqi.contributions.map((c) =&gt; (
46:             &lt;div
47:               key={c.metric}
48:               title={`${c.metric}: ${c.rawScore.toFixed(2)} (weight ${(c.weight * 100).toFixed(0)}%)`}
49:               style={{
50:                 flex: c.weight,
51:                 backgroundColor: segmentColor(c),
52:                 minWidth: 2,
53:               }}
54:             /&gt;
55:           ))}
56:         &lt;/div&gt;
57:       )}
58: 
59:       {/* Screen reader breakdown table */}
60:       &lt;table style={{ position: &apos;absolute&apos;, width: 1, height: 1, overflow: &apos;hidden&apos;, clip: &apos;rect(0,0,0,0)&apos; }}&gt;
61:         &lt;caption&gt;CQI Metric Breakdown&lt;/caption&gt;
62:         &lt;thead&gt;
63:           &lt;tr&gt;
64:             &lt;th&gt;Metric&lt;/th&gt;
65:             &lt;th&gt;Raw Score&lt;/th&gt;
66:             &lt;th&gt;Weight&lt;/th&gt;
67:             &lt;th&gt;Contribution&lt;/th&gt;
68:           &lt;/tr&gt;
69:         &lt;/thead&gt;
70:         &lt;tbody&gt;
71:           {cqi.contributions.map((c) =&gt; (
72:             &lt;tr key={c.metric}&gt;
73:               &lt;td&gt;{c.metric}&lt;/td&gt;
74:               &lt;td&gt;{c.rawScore.toFixed(2)}&lt;/td&gt;
75:               &lt;td&gt;{(c.weight * 100).toFixed(0)}%&lt;/td&gt;
76:               &lt;td&gt;{c.contribution.toFixed(3)}&lt;/td&gt;
77:             &lt;/tr&gt;
78:           ))}
79:         &lt;/tbody&gt;
80:       &lt;/table&gt;
81:     &lt;/div&gt;
82:   );
83: }</file><file path="src/components/HandoffCard.tsx"> 1: import { scoreColorBand, SCORE_COLORS } from &apos;../lib/quality-utils.js&apos;;
 2: import type { HandoffEvaluation } from &apos;../types.js&apos;;
 3: 
 4: interface HandoffCardProps {
 5:   handoff: HandoffEvaluation;
 6: }
 7: 
 8: export function HandoffCard({ handoff }: HandoffCardProps) {
 9:   const band = scoreColorBand(handoff.score);
10:   const color = SCORE_COLORS[band];
11: 
12:   return (
13:     &lt;div className=&quot;flex-center gap-3&quot; style={{
14:       padding: &apos;8px 12px&apos;,
15:       borderRadius: 8,
16:       background: &apos;var(--bg-elevated)&apos;,
17:       border: &apos;1px solid var(--border)&apos;,
18:     }}&gt;
19:       &lt;span className=&quot;mono-xs font-semibold&quot;&gt;
20:         {handoff.sourceAgent}
21:       &lt;/span&gt;
22:       &lt;span className=&quot;text-muted text-base&quot;&gt;&amp;rarr;&lt;/span&gt;
23:       &lt;span className=&quot;mono-xs font-semibold&quot;&gt;
24:         {handoff.targetAgent}
25:       &lt;/span&gt;
26:       &lt;span className=&quot;mono-xs chip&quot; style={{
27:         backgroundColor: `${color}20`,
28:         color,
29:       }}&gt;
30:         {handoff.score.toFixed(2)}
31:       &lt;/span&gt;
32:       {handoff.correctTarget &amp;&amp; (
33:         &lt;span style={{ fontSize: &apos;var(--font-size-2xs)&apos;, color: &apos;var(--status-healthy)&apos; }} title=&quot;Correct target&quot;&gt;&amp;#10003;&lt;/span&gt;
34:       )}
35:       {handoff.contextPreserved &amp;&amp; (
36:         &lt;span style={{ fontSize: &apos;var(--font-size-2xs)&apos;, color: &apos;var(--status-healthy)&apos; }} title=&quot;Context preserved&quot;&gt;&amp;#9679;&lt;/span&gt;
37:       )}
38:     &lt;/div&gt;
39:   );
40: }</file><file path="src/components/MetricCard.tsx"> 1: import { memo } from &apos;react&apos;;
 2: import { Link } from &apos;wouter&apos;;
 3: import type { QualityMetricResult, WorstExplanation } from &apos;../types.js&apos;;
 4: import { StatusBadge, TrendIndicator, ConfidenceBadge } from &apos;./Indicators.js&apos;;
 5: import { ScoreBadge } from &apos;./ScoreBadge.js&apos;;
 6: import { Sparkline } from &apos;./Sparkline.js&apos;;
 7: import { inferScoreDirection, truncateText, plural, formatScore } from &apos;../lib/quality-utils.js&apos;;
 8: 
 9: function MetricCardInner({ metric, sparklineData }: {
10:   metric: QualityMetricResult;
11:   sparklineData?: (number | null)[];
12: }) {
13:   const { name, displayName, sampleCount, status, values, trend, confidence, alerts } = metric;
14:   const worst = (metric as QualityMetricResult &amp; { worstExplanation?: WorstExplanation }).worstExplanation;
15:   const primaryValue = values.avg;
16:   const glowClass = status === &apos;critical&apos; ? &apos;glow-critical&apos; : status === &apos;warning&apos; ? &apos;glow-warning&apos; : &apos;&apos;;
17: 
18:   return (
19:     &lt;Link href={`/metrics/${name}`} className=&quot;card-link&quot; aria-label={`View ${displayName} metric details`}&gt;
20:       &lt;div className={`card ${glowClass}`}&gt;
21:         &lt;div className=&quot;metric-card-header&quot;&gt;
22:           &lt;h3&gt;{displayName}&lt;/h3&gt;
23:           &lt;StatusBadge status={status} /&gt;
24:         &lt;/div&gt;
25:         &lt;div className=&quot;metric-values&quot;&gt;
26:           &lt;div className=&quot;primary&quot;&gt;
27:             &lt;ScoreBadge
28:               score={primaryValue ?? null}
29:               metricName={name}
30:               direction={inferScoreDirection(alerts?.[0]?.direction)}
31:               label={formatScore(primaryValue)}
32:             /&gt;
33:             {trend &amp;&amp; &lt;&gt; &lt;TrendIndicator trend={trend} /&gt;&lt;/&gt;}
34:           &lt;/div&gt;
35:           &lt;div className=&quot;secondary&quot;&gt;
36:             p50: {formatScore(values.p50)} &amp;middot; p95: {formatScore(values.p95)}
37:           &lt;/div&gt;
38:         &lt;/div&gt;
39: 
40:         {sparklineData &amp;&amp; sparklineData.length &gt;= 2 &amp;&amp; (
41:           &lt;div style={{ marginTop: 8 }}&gt;
42:             &lt;Sparkline
43:               data={sparklineData}
44:               width={120}
45:               height={24}
46:               color={status === &apos;critical&apos; ? &apos;var(--status-critical)&apos; : status === &apos;warning&apos; ? &apos;var(--status-warning)&apos; : &apos;var(--accent)&apos;}
47:               label={`${displayName} score trend`}
48:             /&gt;
49:           &lt;/div&gt;
50:         )}
51: 
52:         &lt;div className=&quot;metric-footer&quot;&gt;
53:           &lt;span&gt;n={sampleCount} &lt;ConfidenceBadge confidence={confidence} /&gt;&lt;/span&gt;
54:           {alerts.length &gt; 0 &amp;&amp; (
55:             &lt;span style={{ color: &apos;var(--status-warning)&apos; }}&gt;
56:               {&apos;\u25B2&apos;} {plural(alerts.length, &apos;alert&apos;)}
57:             &lt;/span&gt;
58:           )}
59:         &lt;/div&gt;
60: 
61:         {worst &amp;&amp; worst.explanation &amp;&amp; (
62:           &lt;div className=&quot;metric-worst&quot; title={worst.explanation}&gt;
63:             &lt;span className=&quot;worst-score&quot;&gt;{worst.score.toFixed(2)}&lt;/span&gt;{&apos; &apos;}
64:             {truncateText(worst.explanation, 60)}
65:           &lt;/div&gt;
66:         )}
67:       &lt;/div&gt;
68:     &lt;/Link&gt;
69:   );
70: }
71: 
72: export const MetricCard = memo(MetricCardInner);</file><file path="src/components/ScoreBadge.tsx">  1: import { Link } from &apos;wouter&apos;;
  2: import { scoreColorBand, truncateText, SCORE_COLORS, type ScoreColorBand, type ScoreDirection } from &apos;../lib/quality-utils.js&apos;;
  3: 
  4: interface ScoreBadgeProps {
  5:   score: number | null;
  6:   metricName: string;
  7:   direction?: ScoreDirection;
  8:   label?: string;
  9:   evaluator?: string;
 10:   evaluatorType?: string;
 11:   explanation?: string;
 12:   traceId?: string;
 13: }
 14: 
 15: const SCORE_SHAPES: Record&lt;ScoreColorBand | &apos;no_data&apos;, string&gt; = {
 16:   excellent: &apos;\u25CF&apos;,  // ●
 17:   good: &apos;\u25CF&apos;,       // ●
 18:   adequate: &apos;\u25B2&apos;,   // ▲
 19:   poor: &apos;\u25A0&apos;,       // ■
 20:   failing: &apos;\u25A0&apos;,    // ■
 21:   no_data: &apos;\u25CB&apos;,    // ○
 22: };
 23: 
 24: function TooltipRow({ label, value, mono }: { label: string; value: string; mono?: boolean }) {
 25:   return (
 26:     &lt;div className=&quot;tooltip-row&quot;&gt;
 27:       &lt;span className=&quot;text-secondary&quot;&gt;{label}&lt;/span&gt;
 28:       &lt;span className={mono ? &apos;mono-xs&apos; : undefined}&gt;{value}&lt;/span&gt;
 29:     &lt;/div&gt;
 30:   );
 31: }
 32: 
 33: function Tooltip({ score, label, evaluator, evaluatorType, explanation, traceId }: {
 34:   score: number;
 35:   label?: string;
 36:   evaluator?: string;
 37:   evaluatorType?: string;
 38:   explanation?: string;
 39:   traceId?: string;
 40: }) {
 41:   return (
 42:     &lt;div className=&quot;score-badge-tooltip&quot; role=&quot;tooltip&quot;&gt;
 43:       &lt;TooltipRow label=&quot;Score&quot; value={score.toFixed(4)} mono /&gt;
 44:       {label &amp;&amp; &lt;TooltipRow label=&quot;Label&quot; value={label} /&gt;}
 45:       {evaluator &amp;&amp; &lt;TooltipRow label=&quot;Evaluator&quot; value={evaluator} mono /&gt;}
 46:       {evaluatorType &amp;&amp; &lt;TooltipRow label=&quot;Type&quot; value={evaluatorType} /&gt;}
 47:       {explanation &amp;&amp; (
 48:         &lt;div className=&quot;tooltip-row gap-half&quot; style={{ flexDirection: &apos;column&apos; }}&gt;
 49:           &lt;span className=&quot;text-secondary&quot;&gt;Explanation&lt;/span&gt;
 50:           &lt;span className=&quot;text-secondary text-xs&quot;&gt;{truncateText(explanation, 120)}&lt;/span&gt;
 51:         &lt;/div&gt;
 52:       )}
 53:       {traceId &amp;&amp; (
 54:         &lt;Link href={`/evaluations/trace/${traceId}`} className=&quot;tooltip-link text-xs&quot;&gt;
 55:           View full explanation &amp;rarr;
 56:         &lt;/Link&gt;
 57:       )}
 58:     &lt;/div&gt;
 59:   );
 60: }
 61: 
 62: export function ScoreBadge({ score, metricName, direction = &apos;maximize&apos;, label, evaluator, evaluatorType, explanation, traceId }: ScoreBadgeProps) {
 63:   const hasTooltip = evaluator || evaluatorType || explanation || traceId;
 64: 
 65:   if (score === null) {
 66:     return (
 67:       &lt;span
 68:         style={{ display: &apos;inline-flex&apos;, alignItems: &apos;center&apos;, gap: &apos;4px&apos;, color: SCORE_COLORS.no_data }}
 69:         aria-label={`${metricName}: no data`}
 70:       &gt;
 71:         {SCORE_SHAPES.no_data} {label ?? &apos;N/A&apos;}
 72:       &lt;/span&gt;
 73:     );
 74:   }
 75: 
 76:   const band = scoreColorBand(score, direction);
 77:   const color = SCORE_COLORS[band];
 78:   const shape = SCORE_SHAPES[band];
 79:   const directionHint = direction === &apos;minimize&apos; ? &apos;lower is better&apos; : &apos;higher is better&apos;;
 80: 
 81:   const badge = (
 82:     &lt;span
 83:       style={{ display: &apos;inline-flex&apos;, alignItems: &apos;center&apos;, gap: &apos;4px&apos;, color }}
 84:       aria-label={`Score: ${score}, ${band} (${directionHint})`}
 85:     &gt;
 86:       {shape} {label ?? score.toFixed(2)}
 87:     &lt;/span&gt;
 88:   );
 89: 
 90:   if (!hasTooltip) return badge;
 91: 
 92:   return (
 93:     &lt;span className=&quot;score-badge-wrapper&quot; tabIndex={0}&gt;
 94:       {badge}
 95:       &lt;Tooltip
 96:         score={score}
 97:         label={label}
 98:         evaluator={evaluator}
 99:         evaluatorType={evaluatorType}
100:         explanation={explanation}
101:         traceId={traceId}
102:       /&gt;
103:     &lt;/span&gt;
104:   );
105: }</file><file path="src/components/ShortcutOverlay.tsx"> 1: import { useKeyboardNav } from &apos;../contexts/KeyboardNavContext.js&apos;;
 2: 
 3: export function ShortcutOverlay() {
 4:   const { shortcuts, overlayOpen, toggleOverlay } = useKeyboardNav();
 5: 
 6:   if (!overlayOpen) return null;
 7: 
 8:   const grouped = new Map&lt;string, Array&lt;{ key: string; description: string }&gt;&gt;();
 9:   for (const s of shortcuts) {
10:     if (!grouped.has(s.scope)) grouped.set(s.scope, []);
11:     grouped.get(s.scope)!.push({ key: s.key, description: s.description });
12:   }
13: 
14:   return (
15:     &lt;div className=&quot;shortcut-overlay-backdrop&quot; onClick={toggleOverlay} role=&quot;dialog&quot; aria-modal=&quot;true&quot; aria-label=&quot;Keyboard shortcuts&quot;&gt;
16:       &lt;div className=&quot;shortcut-overlay&quot; onClick={e =&gt; e.stopPropagation()}&gt;
17:         &lt;div className=&quot;flex-center mb-3&quot; style={{ justifyContent: &apos;space-between&apos; }}&gt;
18:           &lt;h2 className=&quot;text-md&quot; style={{ margin: 0 }}&gt;Keyboard Shortcuts&lt;/h2&gt;
19:           &lt;button type=&quot;button&quot; onClick={toggleOverlay} aria-label=&quot;Close&quot; className=&quot;text-lg text-secondary&quot; style={{
20:             background: &apos;none&apos;, border: &apos;none&apos;, cursor: &apos;pointer&apos;,
21:           }}&gt;
22:             &amp;times;
23:           &lt;/button&gt;
24:         &lt;/div&gt;
25:         {[...grouped.entries()].map(([scope, items]) =&gt; (
26:           &lt;div key={scope} className=&quot;mb-3&quot;&gt;
27:             &lt;div className=&quot;text-secondary mb-1-5 text-xs uppercase font-semibold&quot;&gt;
28:               {scope}
29:             &lt;/div&gt;
30:             {items.map(item =&gt; (
31:               &lt;div key={item.key} style={{ display: &apos;flex&apos;, justifyContent: &apos;space-between&apos;, padding: &apos;4px 0&apos;, fontSize: 12 }}&gt;
32:                 &lt;span&gt;{item.description}&lt;/span&gt;
33:                 &lt;kbd className=&quot;mono-xs&quot; style={{
34:                   padding: &apos;2px 6px&apos;,
35:                   borderRadius: 4, background: &apos;var(--bg-elevated)&apos;, border: &apos;1px solid var(--border)&apos;,
36:                 }}&gt;
37:                   {item.key}
38:                 &lt;/kbd&gt;
39:               &lt;/div&gt;
40:             ))}
41:           &lt;/div&gt;
42:         ))}
43:         &lt;div className=&quot;text-muted text-xs&quot; style={{ marginTop: 8 }}&gt;
44:           Press &lt;kbd className=&quot;mono-xs&quot;&gt;?&lt;/kbd&gt; or &lt;kbd className=&quot;mono-xs&quot;&gt;Esc&lt;/kbd&gt; to close
45:         &lt;/div&gt;
46:       &lt;/div&gt;
47:     &lt;/div&gt;
48:   );
49: }</file><file path="src/components/SpanTree.tsx">  1: import type { CSSProperties } from &apos;react&apos;;
  2: 
  3: interface SpanNode {
  4:   spanId: string;
  5:   name: string;
  6:   durationMs?: number;
  7:   status?: { code: number; message?: string };
  8:   attributes?: Record&lt;string, unknown&gt;;
  9:   children: SpanNode[];
 10:   evalCount: number;
 11: }
 12: 
 13: interface SpanTreeProps {
 14:   spans: Array&lt;{
 15:     spanId: string;
 16:     name: string;
 17:     durationMs?: number;
 18:     status?: { code: number; message?: string };
 19:     attributes?: Record&lt;string, unknown&gt;;
 20:     parentSpanId?: string;
 21:   }&gt;;
 22:   evalsBySpan: Map&lt;string, number&gt;;
 23:   maxDuration: number;
 24: }
 25: 
 26: function buildTree(
 27:   spans: SpanTreeProps[&apos;spans&apos;],
 28:   evalsBySpan: Map&lt;string, number&gt;,
 29: ): SpanNode[] {
 30:   const nodeMap = new Map&lt;string, SpanNode&gt;();
 31:   const roots: SpanNode[] = [];
 32: 
 33:   for (const s of spans) {
 34:     nodeMap.set(s.spanId, {
 35:       spanId: s.spanId,
 36:       name: s.name,
 37:       durationMs: s.durationMs,
 38:       status: s.status,
 39:       attributes: s.attributes,
 40:       children: [],
 41:       evalCount: evalsBySpan.get(s.spanId) ?? 0,
 42:     });
 43:   }
 44: 
 45:   for (const s of spans) {
 46:     const node = nodeMap.get(s.spanId)!;
 47:     const parentId = (s as { parentSpanId?: string }).parentSpanId;
 48:     if (parentId &amp;&amp; nodeMap.has(parentId)) {
 49:       nodeMap.get(parentId)!.children.push(node);
 50:     } else {
 51:       roots.push(node);
 52:     }
 53:   }
 54: 
 55:   return roots;
 56: }
 57: 
 58: const STATUS_ICONS: Record&lt;number, string&gt; = {
 59:   0: &apos;&apos;,      // UNSET
 60:   1: &apos;\u2713&apos;, // OK ✓
 61:   2: &apos;\u2717&apos;, // ERROR ✗
 62: };
 63: 
 64: function SpanRow({ node, depth, maxDuration }: { node: SpanNode; depth: number; maxDuration: number }) {
 65:   const barPct = maxDuration &gt; 0 &amp;&amp; node.durationMs ? Math.min((node.durationMs / maxDuration) * 100, 100) : 0;
 66:   const statusCode = node.status?.code ?? 0;
 67:   const isError = statusCode === 2;
 68: 
 69:   const barStyle: CSSProperties = {
 70:     height: 4,
 71:     width: `${barPct}%`,
 72:     background: isError ? &apos;var(--status-critical)&apos; : &apos;var(--status-healthy)&apos;,
 73:     borderRadius: 2,
 74:     marginTop: 4,
 75:     minWidth: barPct &gt; 0 ? 2 : 0,
 76:   };
 77: 
 78:   return (
 79:     &lt;&gt;
 80:       &lt;div
 81:         className=&quot;flex-center gap-2&quot;
 82:         style={{
 83:           paddingLeft: depth * 20 + 8,
 84:           paddingTop: 8,
 85:           paddingBottom: 8,
 86:           borderBottom: &apos;1px solid var(--border)&apos;,
 87:         }}
 88:       &gt;
 89:         &lt;span className=&quot;text-base&quot; style={{ color: isError ? &apos;var(--status-critical)&apos; : &apos;var(--text-primary)&apos; }}&gt;
 90:           {STATUS_ICONS[statusCode]}
 91:         &lt;/span&gt;
 92:         &lt;div style={{ flex: 1 }}&gt;
 93:           &lt;div style={{ fontSize: 12, fontWeight: 500 }}&gt;{node.name}&lt;/div&gt;
 94:           &lt;div className=&quot;flex-center gap-2&quot;&gt;
 95:             &lt;div style={{ flex: 1, background: &apos;var(--bg-secondary)&apos;, borderRadius: 2, height: 4 }}&gt;
 96:               &lt;div style={barStyle} /&gt;
 97:             &lt;/div&gt;
 98:             {node.durationMs != null &amp;&amp; (
 99:               &lt;span className=&quot;mono-xs text-secondary&quot; style={{ whiteSpace: &apos;nowrap&apos; }}&gt;
100:                 {node.durationMs &lt; 1000 ? `${node.durationMs.toFixed(0)}ms` : `${(node.durationMs / 1000).toFixed(2)}s`}
101:               &lt;/span&gt;
102:             )}
103:           &lt;/div&gt;
104:         &lt;/div&gt;
105:         {node.evalCount &gt; 0 &amp;&amp; (
106:           &lt;span className=&quot;text-2xs chip font-semibold&quot; style={{
107:             background: &apos;var(--accent-bg)&apos;,
108:             color: &apos;var(--accent)&apos;,
109:           }}&gt;
110:             {node.evalCount} eval{node.evalCount &gt; 1 ? &apos;s&apos; : &apos;&apos;}
111:           &lt;/span&gt;
112:         )}
113:       &lt;/div&gt;
114:       {node.children.map(child =&gt; (
115:         &lt;SpanRow key={child.spanId} node={child} depth={depth + 1} maxDuration={maxDuration} /&gt;
116:       ))}
117:     &lt;/&gt;
118:   );
119: }
120: 
121: export function SpanTree({ spans, evalsBySpan, maxDuration }: SpanTreeProps) {
122:   const roots = buildTree(spans, evalsBySpan);
123: 
124:   if (roots.length === 0) {
125:     return &lt;div className=&quot;text-muted&quot; style={{ padding: 16 }}&gt;No spans found for this trace.&lt;/div&gt;;
126:   }
127: 
128:   return (
129:     &lt;div&gt;
130:       {roots.map(node =&gt; (
131:         &lt;SpanRow key={node.spanId} node={node} depth={0} maxDuration={maxDuration} /&gt;
132:       ))}
133:     &lt;/div&gt;
134:   );
135: }</file><file path="src/components/SplitPane.tsx"> 1: import { useState, useCallback, useRef, useEffect, type ReactNode } from &apos;react&apos;;
 2: 
 3: interface SplitPaneProps {
 4:   left: ReactNode;
 5:   right: ReactNode;
 6:   initialSplit?: number;
 7:   minPct?: number;
 8:   maxPct?: number;
 9: }
10: 
11: export function SplitPane({ left, right, initialSplit = 50, minPct = 25, maxPct = 75 }: SplitPaneProps) {
12:   const [splitPct, setSplitPct] = useState(initialSplit);
13:   const containerRef = useRef&lt;HTMLDivElement&gt;(null);
14:   const dragging = useRef(false);
15: 
16:   const onMouseDown = useCallback(() =&gt; { dragging.current = true; }, []);
17: 
18:   useEffect(() =&gt; {
19:     function onMouseMove(e: MouseEvent) {
20:       if (!dragging.current || !containerRef.current) return;
21:       const rect = containerRef.current.getBoundingClientRect();
22:       const pct = ((e.clientX - rect.left) / rect.width) * 100;
23:       setSplitPct(Math.max(minPct, Math.min(maxPct, pct)));
24:     }
25:     function onMouseUp() { dragging.current = false; }
26:     document.addEventListener(&apos;mousemove&apos;, onMouseMove);
27:     document.addEventListener(&apos;mouseup&apos;, onMouseUp);
28:     return () =&gt; {
29:       document.removeEventListener(&apos;mousemove&apos;, onMouseMove);
30:       document.removeEventListener(&apos;mouseup&apos;, onMouseUp);
31:     };
32:   }, [minPct, maxPct]);
33: 
34:   return (
35:     &lt;div ref={containerRef} style={{ display: &apos;flex&apos;, width: &apos;100%&apos;, minHeight: 300 }}&gt;
36:       &lt;div style={{ width: `${splitPct}%`, overflow: &apos;auto&apos; }}&gt;{left}&lt;/div&gt;
37:       &lt;div
38:         role=&quot;separator&quot;
39:         aria-orientation=&quot;vertical&quot;
40:         aria-valuenow={Math.round(splitPct)}
41:         aria-valuemin={minPct}
42:         aria-valuemax={maxPct}
43:         aria-label=&quot;Resize panes&quot;
44:         tabIndex={0}
45:         onMouseDown={onMouseDown}
46:         onKeyDown={(e) =&gt; {
47:           if (e.key === &apos;ArrowLeft&apos;) { e.preventDefault(); setSplitPct(p =&gt; Math.max(minPct, p - 2)); }
48:           if (e.key === &apos;ArrowRight&apos;) { e.preventDefault(); setSplitPct(p =&gt; Math.min(maxPct, p + 2)); }
49:         }}
50:         style={{
51:           width: 6,
52:           cursor: &apos;col-resize&apos;,
53:           background: &apos;var(--border)&apos;,
54:           flexShrink: 0,
55:           borderRadius: 3,
56:         }}
57:       /&gt;
58:       &lt;div style={{ width: `${100 - splitPct}%`, overflow: &apos;auto&apos; }}&gt;{right}&lt;/div&gt;
59:     &lt;/div&gt;
60:   );
61: }</file><file path="src/components/SyncEmptyState.tsx"> 1: import { type ReactNode } from &apos;react&apos;;
 2: 
 3: interface SyncEmptyStateProps {
 4:   title: string;
 5:   description: ReactNode;
 6: }
 7: 
 8: export function SyncEmptyState({ title, description }: SyncEmptyStateProps) {
 9:   return (
10:     &lt;div className=&quot;empty-state&quot;&gt;
11:       &lt;h2&gt;{title}&lt;/h2&gt;
12:       &lt;p&gt;{description}&lt;/p&gt;
13:       &lt;p className=&quot;text-muted text-xs&quot; style={{ marginTop: &apos;var(--space-2)&apos; }}&gt;
14:         Data may not have been synced yet. Try again after the next sync cycle.
15:       &lt;/p&gt;
16:     &lt;/div&gt;
17:   );
18: }</file><file path="src/components/TrendChart.tsx">  1: import {
  2:   LineChart,
  3:   Line,
  4:   XAxis,
  5:   YAxis,
  6:   CartesianGrid,
  7:   Tooltip,
  8:   ReferenceLine,
  9:   ResponsiveContainer,
 10: } from &apos;recharts&apos;;
 11: import type { MetricDynamics } from &apos;../types.js&apos;;
 12: import type { MetricTrend } from &apos;../types.js&apos;;
 13: import { CHART_COLORS } from &apos;../lib/constants.js&apos;;
 14: 
 15: interface TrendChartProps {
 16:   trend?: MetricTrend;
 17:   dynamics?: MetricDynamics;
 18:   warningThreshold?: number;
 19:   criticalThreshold?: number;
 20:   metricName: string;
 21: }
 22: 
 23: const COLORS = {
 24:   ...CHART_COLORS,
 25:   projection: CHART_COLORS.line,
 26: };
 27: 
 28: function formatValue(v: number): string {
 29:   return Math.abs(v) &lt; 0.001 ? v.toExponential(2) : v.toFixed(4);
 30: }
 31: 
 32: function formatBreachTime(iso: string): string {
 33:   const hours = (new Date(iso).getTime() - Date.now()) / (1000 * 60 * 60);
 34:   if (hours &lt;= 0) return &apos;threshold exceeded&apos;;
 35:   if (hours &lt; 1) return `${Math.round(hours * 60)}m`;
 36:   if (hours &lt; 48) return `${hours.toFixed(1)}h`;
 37:   return `${(hours / 24).toFixed(1)}d`;
 38: }
 39: 
 40: export function TrendChart({
 41:   trend,
 42:   dynamics,
 43:   warningThreshold,
 44:   criticalThreshold,
 45:   metricName,
 46: }: TrendChartProps) {
 47:   if (!trend) {
 48:     return (
 49:       &lt;div style={{ color: COLORS.text, padding: 16, textAlign: &apos;center&apos; }}&gt;
 50:         No trend data available
 51:       &lt;/div&gt;
 52:     );
 53:   }
 54: 
 55:   // Build data points: previous and current
 56:   const data: Array&lt;{ label: string; value: number; projected?: number }&gt; = [
 57:     { label: &apos;Previous&apos;, value: trend.previousValue },
 58:     { label: &apos;Current&apos;, value: trend.currentValue },
 59:   ];
 60: 
 61:   // If dynamics has projectedBreachTime or velocity, add projection point
 62:   if (dynamics &amp;&amp; dynamics.velocity !== 0) {
 63:     const projectedValue = trend.currentValue + dynamics.velocity;
 64:     data.push({
 65:       label: &apos;Projected&apos;,
 66:       value: trend.currentValue, // actual line ends here
 67:       projected: projectedValue,
 68:     });
 69:     // Set current point&apos;s projected value to bridge the dashed line
 70:     data[1].projected = trend.currentValue;
 71:   }
 72: 
 73:   // Compute Y domain with some padding
 74:   const allValues = data.flatMap((d) =&gt; [d.value, d.projected].filter((v): v is number =&gt; v != null));
 75:   if (warningThreshold != null) allValues.push(warningThreshold);
 76:   if (criticalThreshold != null) allValues.push(criticalThreshold);
 77:   if (allValues.length === 0) {
 78:     return &lt;div style={{ color: COLORS.text, padding: 16, textAlign: &apos;center&apos; }}&gt;Insufficient data&lt;/div&gt;;
 79:   }
 80:   const yMin = Math.min(...allValues);
 81:   const yMax = Math.max(...allValues);
 82:   const yPad = (yMax - yMin) * 0.15 || 0.05;
 83: 
 84:   return (
 85:     &lt;div&gt;
 86:       &lt;div aria-label={`Trend chart for ${metricName}`}&gt;
 87:         &lt;ResponsiveContainer width=&quot;100%&quot; height={200}&gt;
 88:           &lt;LineChart data={data} margin={{ top: 8, right: 16, bottom: 4, left: 16 }}&gt;
 89:             &lt;CartesianGrid stroke={COLORS.grid} strokeDasharray=&quot;3 3&quot; /&gt;
 90:             &lt;XAxis
 91:               dataKey=&quot;label&quot;
 92:               tick={{ fill: COLORS.text, fontSize: 12 }}
 93:               stroke={COLORS.grid}
 94:             /&gt;
 95:             &lt;YAxis
 96:               domain={[yMin - yPad, yMax + yPad]}
 97:               tick={{ fill: COLORS.text, fontSize: 12 }}
 98:               stroke={COLORS.grid}
 99:               tickFormatter={(v: number) =&gt; v.toFixed(2)}
100:               width={48}
101:             /&gt;
102:             &lt;Tooltip
103:               contentStyle={{
104:                 backgroundColor: COLORS.tooltip,
105:                 border: `1px solid ${COLORS.grid}`,
106:                 borderRadius: 6,
107:                 color: COLORS.text,
108:                 fontSize: 12,
109:               }}
110:               formatter={(v: number | undefined) =&gt; [v != null ? formatValue(v) : &apos;N/A&apos;, &apos;&apos;]}
111:               labelStyle={{ color: &apos;#e6edf3&apos; }}
112:             /&gt;
113:             {warningThreshold != null &amp;&amp; (
114:               &lt;ReferenceLine
115:                 y={warningThreshold}
116:                 stroke={COLORS.warning}
117:                 strokeDasharray=&quot;6 3&quot;
118:                 label={{ value: &apos;Warning&apos;, fill: COLORS.warning, fontSize: 12, position: &apos;right&apos; }}
119:               /&gt;
120:             )}
121:             {criticalThreshold != null &amp;&amp; (
122:               &lt;ReferenceLine
123:                 y={criticalThreshold}
124:                 stroke={COLORS.critical}
125:                 strokeDasharray=&quot;6 3&quot;
126:                 label={{ value: &apos;Critical&apos;, fill: COLORS.critical, fontSize: 12, position: &apos;right&apos; }}
127:               /&gt;
128:             )}
129:             &lt;Line
130:               type=&quot;monotone&quot;
131:               dataKey=&quot;value&quot;
132:               stroke={COLORS.line}
133:               strokeWidth={2}
134:               dot={{ fill: COLORS.line, r: 4 }}
135:               activeDot={{ r: 6 }}
136:               connectNulls
137:             /&gt;
138:             {dynamics &amp;&amp; dynamics.velocity !== 0 &amp;&amp; (
139:               &lt;Line
140:                 type=&quot;monotone&quot;
141:                 dataKey=&quot;projected&quot;
142:                 stroke={COLORS.projection}
143:                 strokeWidth={2}
144:                 strokeDasharray=&quot;6 4&quot;
145:                 dot={{ fill: COLORS.projection, r: 3, strokeDasharray: &apos;&apos; }}
146:                 connectNulls
147:               /&gt;
148:             )}
149:           &lt;/LineChart&gt;
150:         &lt;/ResponsiveContainer&gt;
151:       &lt;/div&gt;
152:       {dynamics &amp;&amp; (
153:         &lt;div className=&quot;gap-6&quot; style={{
154:           display: &apos;flex&apos;,
155:           flexWrap: &apos;wrap&apos;,
156:           marginTop: 8,
157:           padding: &apos;8px 0&apos;,
158:           fontSize: 12,
159:           color: COLORS.text,
160:         }}&gt;
161:           &lt;div&gt;
162:             &lt;span className=&quot;font-semibold&quot;&gt;Velocity:&lt;/span&gt;{&apos; &apos;}
163:             &lt;span className=&quot;mono&quot;&gt;
164:               {dynamics.velocity &gt;= 0 ? &apos;+&apos; : &apos;&apos;}{formatValue(dynamics.velocity)}/hr
165:             &lt;/span&gt;
166:           &lt;/div&gt;
167:           &lt;div&gt;
168:             &lt;span className=&quot;font-semibold&quot;&gt;Acceleration:&lt;/span&gt;{&apos; &apos;}
169:             &lt;span className=&quot;mono&quot;&gt;
170:               {dynamics.acceleration &gt;= 0 ? &apos;+&apos; : &apos;&apos;}{formatValue(dynamics.acceleration)}/hr
171:             &lt;/span&gt;
172:           &lt;/div&gt;
173:           {dynamics.projectedBreachTime &amp;&amp; (
174:             &lt;div&gt;
175:               &lt;span className=&quot;font-semibold&quot;&gt;Breach in:&lt;/span&gt;{&apos; &apos;}
176:               &lt;span className=&quot;mono&quot; style={{
177:                 color: dynamics.projectedStatus === &apos;critical&apos; ? COLORS.critical : COLORS.warning,
178:               }}&gt;
179:                 {formatBreachTime(dynamics.projectedBreachTime)}
180:               &lt;/span&gt;
181:             &lt;/div&gt;
182:           )}
183:           &lt;div&gt;
184:             &lt;span className=&quot;font-semibold&quot;&gt;Confidence:&lt;/span&gt;{&apos; &apos;}
185:             &lt;span className=&quot;mono&quot;&gt;
186:               {(dynamics.confidence * 100).toFixed(0)}%
187:             &lt;/span&gt;
188:           &lt;/div&gt;
189:         &lt;/div&gt;
190:       )}
191:     &lt;/div&gt;
192:   );
193: }</file><file path="src/components/TrendSeries.tsx">  1: import {
  2:   ComposedChart,
  3:   Line,
  4:   XAxis,
  5:   YAxis,
  6:   CartesianGrid,
  7:   Tooltip,
  8:   Area,
  9:   ResponsiveContainer,
 10: } from &apos;recharts&apos;;
 11: import type { TrendBucket } from &apos;../hooks/useTrend.js&apos;;
 12: import { CHART_COLORS } from &apos;../lib/constants.js&apos;;
 13: 
 14: interface TrendSeriesProps {
 15:   data: TrendBucket[];
 16:   metricName: string;
 17: }
 18: 
 19: const COLORS = {
 20:   ...CHART_COLORS,
 21:   band: &apos;rgba(88, 166, 255, 0.1)&apos;,
 22:   bandStroke: &apos;rgba(88, 166, 255, 0.3)&apos;,
 23:   background: &apos;#0d1117&apos;,
 24: };
 25: 
 26: function formatTime(iso: string, spanDays: number): string {
 27:   const d = new Date(iso);
 28:   if (spanDays &lt;= 1) return d.toLocaleTimeString([], { hour: &apos;2-digit&apos;, minute: &apos;2-digit&apos; });
 29:   if (spanDays &lt;= 7) return d.toLocaleDateString([], { weekday: &apos;short&apos;, hour: &apos;2-digit&apos; });
 30:   return d.toLocaleDateString([], { month: &apos;short&apos;, day: &apos;numeric&apos; });
 31: }
 32: 
 33: export function TrendSeries({ data, metricName }: TrendSeriesProps) {
 34:   if (data.length === 0) {
 35:     return (
 36:       &lt;div style={{ color: COLORS.text, padding: 16, textAlign: &apos;center&apos; }}&gt;
 37:         No trend data available
 38:       &lt;/div&gt;
 39:     );
 40:   }
 41: 
 42:   const spanMs = new Date(data[data.length - 1].endTime).getTime() - new Date(data[0].startTime).getTime();
 43:   const spanDays = spanMs / (1000 * 60 * 60 * 24);
 44: 
 45:   const chartData = data.map((bucket) =&gt; ({
 46:     time: formatTime(bucket.startTime, spanDays),
 47:     avg: bucket.avg,
 48:     p10: bucket.percentiles?.p10 ?? null,
 49:     p50: bucket.percentiles?.p50 ?? null,
 50:     p90: bucket.percentiles?.p90 ?? null,
 51:     count: bucket.count,
 52:   }));
 53: 
 54:   const allVals = chartData.flatMap(d =&gt;
 55:     [d.avg, d.p10, d.p90].filter((v): v is number =&gt; v !== null)
 56:   );
 57:   if (allVals.length === 0) {
 58:     return (
 59:       &lt;div style={{ color: COLORS.text, padding: 16, textAlign: &apos;center&apos; }}&gt;
 60:         No scored evaluations in period
 61:       &lt;/div&gt;
 62:     );
 63:   }
 64: 
 65:   const yMin = Math.min(...allVals);
 66:   const yMax = Math.max(...allVals);
 67:   const yPad = (yMax - yMin) * 0.15 || 0.05;
 68: 
 69:   return (
 70:     &lt;div aria-label={`Time series trend for ${metricName}`}&gt;
 71:       &lt;ResponsiveContainer width=&quot;100%&quot; height={220}&gt;
 72:         &lt;ComposedChart data={chartData} margin={{ top: 8, right: 16, bottom: 4, left: 16 }}&gt;
 73:           &lt;CartesianGrid stroke={COLORS.grid} strokeDasharray=&quot;3 3&quot; /&gt;
 74:           &lt;XAxis
 75:             dataKey=&quot;time&quot;
 76:             tick={{ fill: COLORS.text, fontSize: 12 }}
 77:             stroke={COLORS.grid}
 78:           /&gt;
 79:           &lt;YAxis
 80:             domain={[yMin - yPad, yMax + yPad]}
 81:             tick={{ fill: COLORS.text, fontSize: 12 }}
 82:             stroke={COLORS.grid}
 83:             tickFormatter={(v: number) =&gt; v.toFixed(2)}
 84:             width={48}
 85:           /&gt;
 86:           &lt;Tooltip
 87:             contentStyle={{
 88:               backgroundColor: COLORS.tooltip,
 89:               border: `1px solid ${COLORS.grid}`,
 90:               borderRadius: 6,
 91:               color: COLORS.text,
 92:               fontSize: 12,
 93:             }}
 94:             formatter={(v: number | string | undefined, name?: string) =&gt; [
 95:               typeof v === &apos;number&apos; ? v.toFixed(4) : &apos;N/A&apos;,
 96:               name === &apos;avg&apos; ? &apos;Average&apos; : (name ?? &apos;&apos;).toUpperCase(),
 97:             ]}
 98:             labelStyle={{ color: &apos;#e6edf3&apos; }}
 99:           /&gt;
100:           {/* P10-P90 band */}
101:           &lt;Area
102:             type=&quot;monotone&quot;
103:             dataKey=&quot;p90&quot;
104:             stroke=&quot;none&quot;
105:             fill={COLORS.band}
106:             connectNulls
107:           /&gt;
108:           &lt;Area
109:             type=&quot;monotone&quot;
110:             dataKey=&quot;p10&quot;
111:             stroke=&quot;none&quot;
112:             fill={COLORS.background}
113:             connectNulls
114:           /&gt;
115:           {/* P50 line */}
116:           &lt;Line
117:             type=&quot;monotone&quot;
118:             dataKey=&quot;p50&quot;
119:             stroke={COLORS.bandStroke}
120:             strokeWidth={1}
121:             strokeDasharray=&quot;4 3&quot;
122:             dot={false}
123:             connectNulls
124:           /&gt;
125:           {/* Average line */}
126:           &lt;Line
127:             type=&quot;monotone&quot;
128:             dataKey=&quot;avg&quot;
129:             stroke={COLORS.line}
130:             strokeWidth={2}
131:             dot={{ fill: COLORS.line, r: 3 }}
132:             activeDot={{ r: 5 }}
133:             connectNulls
134:           /&gt;
135:         &lt;/ComposedChart&gt;
136:       &lt;/ResponsiveContainer&gt;
137:       &lt;div className=&quot;text-xs gap-4&quot; style={{ display: &apos;flex&apos;, justifyContent: &apos;center&apos;, color: COLORS.text, marginTop: 4 }}&gt;
138:         &lt;span&gt;&lt;span style={{ color: COLORS.line }}&gt;&amp;#9473;&lt;/span&gt; avg&lt;/span&gt;
139:         &lt;span&gt;&lt;span style={{ opacity: 0.5 }}&gt;- -&lt;/span&gt; p50&lt;/span&gt;
140:         &lt;span&gt;&lt;span style={{ opacity: 0.3 }}&gt;&amp;#9608;&lt;/span&gt; p10-p90&lt;/span&gt;
141:       &lt;/div&gt;
142:     &lt;/div&gt;
143:   );
144: }</file><file path="src/hooks/useAgentSession.ts"> 1: import { useQuery } from &apos;@tanstack/react-query&apos;;
 2: import type { MultiAgentEvaluation, EvaluationResult } from &apos;../types.js&apos;;
 3: import { API_BASE, STALE_TIME } from &apos;../lib/constants.js&apos;;
 4: 
 5: interface AgentSessionResponse {
 6:   sessionId: string;
 7:   spans: Array&lt;{
 8:     traceId: string;
 9:     spanId: string;
10:     name: string;
11:     durationMs?: number;
12:     status?: { code: number; message?: string };
13:     attributes?: Record&lt;string, unknown&gt;;
14:   }&gt;;
15:   evaluation: MultiAgentEvaluation;
16:   evaluations: EvaluationResult[];
17:   agentMap: Record&lt;string, string&gt;;
18: }
19: 
20: export function useAgentSession(sessionId: string | undefined) {
21:   return useQuery&lt;AgentSessionResponse&gt;({
22:     queryKey: [&apos;agent-session&apos;, sessionId],
23:     queryFn: async () =&gt; {
24:       const res = await fetch(`${API_BASE}/api/agents/${encodeURIComponent(sessionId!)}`);
25:       if (!res.ok) throw new Error(`API error: ${res.status}`);
26:       return res.json();
27:     },
28:     enabled: !!sessionId,
29:     staleTime: STALE_TIME.DETAIL,
30:     retry: 2,
31:   });
32: }</file><file path="src/hooks/useCompliance.ts"> 1: import { useQuery } from &apos;@tanstack/react-query&apos;;
 2: import type { SLAComplianceResult, HumanVerificationEvent, Period } from &apos;../types.js&apos;;
 3: import { API_BASE, STALE_TIME } from &apos;../lib/constants.js&apos;;
 4: 
 5: interface SLAResponse {
 6:   results: SLAComplianceResult[];
 7:   noSLAsConfigured: boolean;
 8: }
 9: 
10: interface VerificationResponse {
11:   count: number;
12:   verifications: HumanVerificationEvent[];
13: }
14: 
15: export function useComplianceSLA(period: Period) {
16:   return useQuery&lt;SLAResponse&gt;({
17:     queryKey: [&apos;compliance-sla&apos;, period],
18:     queryFn: async () =&gt; {
19:       const res = await fetch(`${API_BASE}/api/compliance/sla?period=${period}`);
20:       if (!res.ok) throw new Error(`API error: ${res.status}`);
21:       return res.json();
22:     },
23:     staleTime: STALE_TIME.DEFAULT,
24:     retry: 2,
25:   });
26: }
27: 
28: export function useComplianceVerifications(period: Period) {
29:   return useQuery&lt;VerificationResponse&gt;({
30:     queryKey: [&apos;compliance-verifications&apos;, period],
31:     queryFn: async () =&gt; {
32:       const res = await fetch(`${API_BASE}/api/compliance/verifications?period=${period}`);
33:       if (!res.ok) throw new Error(`API error: ${res.status}`);
34:       return res.json();
35:     },
36:     staleTime: STALE_TIME.DEFAULT,
37:     retry: 2,
38:   });
39: }</file><file path="src/hooks/useCoverage.ts"> 1: import { useQuery } from &apos;@tanstack/react-query&apos;;
 2: import type { Period, CoverageHeatmap } from &apos;../types.js&apos;;
 3: import { API_BASE, STALE_TIME, DEFAULT_INPUT_KEY, type InputKey } from &apos;../lib/constants.js&apos;;
 4: 
 5: export type CoverageResponse = CoverageHeatmap &amp; { period: string };
 6: 
 7: export function useCoverage(period: Period, inputKey: InputKey = DEFAULT_INPUT_KEY) {
 8:   return useQuery&lt;CoverageResponse&gt;({
 9:     queryKey: [&apos;coverage&apos;, period, inputKey],
10:     queryFn: async () =&gt; {
11:       const params = new URLSearchParams({ period, inputKey });
12:       const res = await fetch(`${API_BASE}/api/coverage?${params}`);
13:       if (!res.ok) throw new Error(`API error: ${res.status}`);
14:       return res.json();
15:     },
16:     staleTime: STALE_TIME.DEFAULT,
17:     retry: 2,
18:   });
19: }</file><file path="src/hooks/useMetricEvaluations.ts"> 1: import { useQuery } from &apos;@tanstack/react-query&apos;;
 2: import type { EvalRow } from &apos;../components/EvaluationTable.js&apos;;
 3: import type { Period } from &apos;../types.js&apos;;
 4: import { API_BASE, STALE_TIME, DEFAULT_PAGE_LIMIT, DEFAULT_PERIOD, DEFAULT_SORT_BY, type SortBy } from &apos;../lib/constants.js&apos;;
 5: 
 6: interface EvaluationsResponse {
 7:   rows: EvalRow[];
 8:   total: number;
 9:   limit: number;
10:   offset: number;
11:   hasMore: boolean;
12: }
13: 
14: export function useMetricEvaluations(
15:   name: string | undefined,
16:   period: Period = DEFAULT_PERIOD,
17:   { limit = DEFAULT_PAGE_LIMIT, offset = 0, scoreLabel, sortBy = DEFAULT_SORT_BY, enabled = true }: {
18:     limit?: number;
19:     offset?: number;
20:     scoreLabel?: string;
21:     sortBy?: SortBy;
22:     enabled?: boolean;
23:   } = {},
24: ) {
25:   return useQuery&lt;EvaluationsResponse&gt;({
26:     queryKey: [&apos;metric-evaluations&apos;, name, period, limit, offset, scoreLabel, sortBy],
27:     queryFn: async () =&gt; {
28:       const params = new URLSearchParams({ period, limit: String(limit), offset: String(offset), sortBy });
29:       if (scoreLabel) params.set(&apos;scoreLabel&apos;, scoreLabel);
30:       const res = await fetch(`${API_BASE}/api/metrics/${encodeURIComponent(name!)}/evaluations?${params}`);
31:       if (!res.ok) throw new Error(`API error: ${res.status}`);
32:       return res.json();
33:     },
34:     enabled: !!name &amp;&amp; enabled,
35:     staleTime: STALE_TIME.DEFAULT,
36:     retry: 2,
37:   });
38: }</file><file path="src/hooks/useQualityLive.ts"> 1: import { useEffect, useRef, useState } from &apos;react&apos;;
 2: import { API_BASE, POLL_INTERVAL_MS } from &apos;../lib/constants.js&apos;;
 3: 
 4: interface LiveMetric {
 5:   name: string;
 6:   score: number;
 7:   evaluatorType: string;
 8:   timestamp: string;
 9: }
10: 
11: export interface QualityLiveData {
12:   metrics: LiveMetric[];
13:   sessionCount: number;
14:   lastUpdated: string;
15: }
16: 
17: export interface UseQualityLiveResult {
18:   data: QualityLiveData | null;
19:   isLoading: boolean;
20:   error: Error | null;
21: }
22: 
23: export function useQualityLive(): UseQualityLiveResult {
24:   const [data, setData] = useState&lt;QualityLiveData | null&gt;(null);
25:   const [isLoading, setIsLoading] = useState(true);
26:   const [error, setError] = useState&lt;Error | null&gt;(null);
27:   const timerRef = useRef&lt;ReturnType&lt;typeof setInterval&gt; | null&gt;(null);
28: 
29:   useEffect(() =&gt; {
30:     let cancelled = false;
31: 
32:     async function fetchLive() {
33:       try {
34:         const res = await fetch(`${API_BASE}/api/quality/live`);
35:         if (!res.ok) throw new Error(`API error: ${res.status}`);
36:         const json = await res.json() as QualityLiveData;
37:         if (!cancelled) {
38:           setData(json);
39:           setError(null);
40:         }
41:       } catch (err) {
42:         if (!cancelled) {
43:           setError(err instanceof Error ? err : new Error(String(err)));
44:         }
45:       } finally {
46:         if (!cancelled) setIsLoading(false);
47:       }
48:     }
49: 
50:     function startPolling() {
51:       fetchLive();
52:       timerRef.current = setInterval(fetchLive, POLL_INTERVAL_MS);
53:     }
54: 
55:     function stopPolling() {
56:       if (timerRef.current) {
57:         clearInterval(timerRef.current);
58:         timerRef.current = null;
59:       }
60:     }
61: 
62:     function handleVisibility() {
63:       if (document.visibilityState === &apos;visible&apos;) {
64:         startPolling();
65:       } else {
66:         stopPolling();
67:       }
68:     }
69: 
70:     startPolling();
71:     document.addEventListener(&apos;visibilitychange&apos;, handleVisibility);
72: 
73:     return () =&gt; {
74:       cancelled = true;
75:       stopPolling();
76:       document.removeEventListener(&apos;visibilitychange&apos;, handleVisibility);
77:     };
78:   }, []);
79: 
80:   return { data, isLoading, error };
81: }</file><file path="src/hooks/useTrend.ts"> 1: import { useQuery } from &apos;@tanstack/react-query&apos;;
 2: import type { Period, MetricTrend, MetricDynamics } from &apos;../types.js&apos;;
 3: import { API_BASE, STALE_TIME } from &apos;../lib/constants.js&apos;;
 4: 
 5: export interface PercentileSnapshot {
 6:   p10: number;
 7:   p25: number;
 8:   p50: number;
 9:   p75: number;
10:   p90: number;
11: }
12: 
13: export interface TrendBucket {
14:   startTime: string;
15:   endTime: string;
16:   count: number;
17:   avg: number | null;
18:   percentiles: PercentileSnapshot | null;
19:   trend: MetricTrend | null;
20:   dynamics: MetricDynamics | null;
21: }
22: 
23: export interface TrendResponse {
24:   metric: string;
25:   period: string;
26:   bucketCount: number;
27:   totalEvaluations: number;
28:   overallPercentiles: PercentileSnapshot | null;
29:   trendData: TrendBucket[];
30:   narrowed?: boolean;
31: }
32: 
33: export function useTrend(metricName: string, period: Period, buckets = 7) {
34:   return useQuery&lt;TrendResponse&gt;({
35:     queryKey: [&apos;trend&apos;, metricName, period, buckets],
36:     enabled: !!metricName,
37:     queryFn: async () =&gt; {
38:       const params = new URLSearchParams({ period, buckets: String(buckets) });
39:       const res = await fetch(`${API_BASE}/api/trends/${encodeURIComponent(metricName)}?${params}`);
40:       if (!res.ok) throw new Error(`API error: ${res.status}`);
41:       return res.json();
42:     },
43:     staleTime: STALE_TIME.DEFAULT,
44:     retry: 2,
45:   });
46: }</file><file path="src/pages/AgentsPage.tsx"> 1: import { useAgentStats } from &apos;../hooks/useAgentStats.js&apos;;
 2: import { AgentActivityPanel, AgentActivitySummary } from &apos;../components/AgentActivityPanel.js&apos;;
 3: import { PageShell } from &apos;../components/PageShell.js&apos;;
 4: import type { Period } from &apos;../types.js&apos;;
 5: 
 6: export function AgentsPage({ period }: { period: Period }) {
 7:   const { data, isLoading, error } = useAgentStats(period);
 8: 
 9:   const agents = data?.agents ?? [];
10: 
11:   return (
12:     &lt;PageShell isLoading={isLoading} error={error} skeletonHeight={300}&gt;
13:       &lt;div className=&quot;eval-detail-header&quot;&gt;
14:         &lt;h2 className=&quot;text-lg&quot;&gt;Agent Activity&lt;/h2&gt;
15:         &lt;div className=&quot;eval-detail-meta&quot;&gt;
16:           &lt;span className=&quot;text-secondary text-xs&quot;&gt;
17:             {data?.startDate} &amp;ndash; {data?.endDate}
18:           &lt;/span&gt;
19:         &lt;/div&gt;
20:       &lt;/div&gt;
21: 
22:       {agents.length &gt; 0 &amp;&amp; &lt;AgentActivitySummary agents={agents} /&gt;}
23: 
24:       &lt;div className=&quot;card&quot;&gt;
25:         &lt;AgentActivityPanel agents={agents} /&gt;
26:       &lt;/div&gt;
27:     &lt;/PageShell&gt;
28:   );
29: }</file><file path="src/pages/CompliancePage.tsx"> 1: import { Link } from &apos;wouter&apos;;
 2: import { useComplianceSLA, useComplianceVerifications } from &apos;../hooks/useCompliance.js&apos;;
 3: import { ComplianceFrameworkMap } from &apos;../components/ComplianceFrameworkMap.js&apos;;
 4: import { SLATable } from &apos;../components/SLATable.js&apos;;
 5: import { formatTimestamp } from &apos;../lib/quality-utils.js&apos;;
 6: import type { Period } from &apos;../types.js&apos;;
 7: 
 8: export function CompliancePage({ period }: { period: Period }) {
 9:   const { data: slaData, isLoading: slaLoading, error: slaError } = useComplianceSLA(period);
10:   const { data: verData, isLoading: verLoading, error: verError } = useComplianceVerifications(period);
11: 
12:   return (
13:     &lt;div&gt;
14:       &lt;Link href=&quot;/&quot; className=&quot;back-link&quot;&gt;&amp;larr; Back to dashboard&lt;/Link&gt;
15: 
16:       &lt;div className=&quot;view-section&quot;&gt;
17:         &lt;h3 className=&quot;section-heading&quot;&gt;SLA Compliance&lt;/h3&gt;
18:         {slaLoading &amp;&amp; &lt;div className=&quot;card skeleton&quot; style={{ height: 120 }} /&gt;}
19:         {slaError &amp;&amp; &lt;div className=&quot;error-state&quot;&gt;&lt;p&gt;{slaError.message}&lt;/p&gt;&lt;/div&gt;}
20:         {slaData &amp;&amp; !slaData.noSLAsConfigured &amp;&amp; slaData.results.length &gt; 0 &amp;&amp; (
21:           &lt;SLATable slas={slaData.results} /&gt;
22:         )}
23:         {slaData &amp;&amp; slaData.noSLAsConfigured &amp;&amp; (
24:           &lt;div className=&quot;card card--empty&quot;&gt;
25:             No SLAs configured. Define SLAs in your quality metrics configuration.
26:           &lt;/div&gt;
27:         )}
28:         {slaData &amp;&amp; !slaData.noSLAsConfigured &amp;&amp; slaData.results.length === 0 &amp;&amp; (
29:           &lt;div className=&quot;card card--empty&quot;&gt;
30:             All SLAs are compliant for the selected period.
31:           &lt;/div&gt;
32:         )}
33:       &lt;/div&gt;
34: 
35:       &lt;div className=&quot;view-section&quot;&gt;
36:         &lt;h3 className=&quot;section-heading&quot;&gt;Regulatory Framework Mapping&lt;/h3&gt;
37:         &lt;ComplianceFrameworkMap /&gt;
38:       &lt;/div&gt;
39: 
40:       &lt;div className=&quot;view-section&quot;&gt;
41:         &lt;h3 className=&quot;section-heading&quot;&gt;Human Verification Events&lt;/h3&gt;
42:         {verLoading &amp;&amp; &lt;div className=&quot;card skeleton&quot; style={{ height: 120 }} /&gt;}
43:         {verError &amp;&amp; &lt;div className=&quot;error-state&quot;&gt;&lt;p&gt;{verError.message}&lt;/p&gt;&lt;/div&gt;}
44:         {verData &amp;&amp; verData.verifications.length &gt; 0 &amp;&amp; (
45:           &lt;div className=&quot;card&quot;&gt;
46:             &lt;table className=&quot;eval-table&quot; style={{ width: &apos;100%&apos; }}&gt;
47:               &lt;thead&gt;
48:                 &lt;tr&gt;
49:                   &lt;th style={{ textAlign: &apos;left&apos; }}&gt;Timestamp&lt;/th&gt;
50:                   &lt;th style={{ textAlign: &apos;left&apos; }}&gt;Type&lt;/th&gt;
51:                   &lt;th style={{ textAlign: &apos;left&apos; }}&gt;Session&lt;/th&gt;
52:                   &lt;th style={{ textAlign: &apos;left&apos; }}&gt;Verifier&lt;/th&gt;
53:                 &lt;/tr&gt;
54:               &lt;/thead&gt;
55:               &lt;tbody&gt;
56:                 {verData.verifications.map((v, i) =&gt; (
57:                   &lt;tr key={`${v.sessionId}-${v.timestamp}-${i}`}&gt;
58:                     &lt;td style={{ fontSize: 12 }} title={new Date(v.timestamp).toLocaleString()}&gt;
59:                       {formatTimestamp(v.timestamp)}
60:                     &lt;/td&gt;
61:                     &lt;td style={{ fontSize: 12 }}&gt;{v.verificationType}&lt;/td&gt;
62:                     &lt;td className=&quot;mono-xs&quot;&gt;{v.sessionId}&lt;/td&gt;
63:                     &lt;td className=&quot;text-secondary text-xs&quot;&gt;{v.verifierId ?? &apos;-&apos;}&lt;/td&gt;
64:                   &lt;/tr&gt;
65:                 ))}
66:               &lt;/tbody&gt;
67:             &lt;/table&gt;
68:           &lt;/div&gt;
69:         )}
70:         {verData &amp;&amp; verData.verifications.length === 0 &amp;&amp; (
71:           &lt;div className=&quot;card card--empty&quot;&gt;
72:             No verification events for the selected period.
73:           &lt;/div&gt;
74:         )}
75:       &lt;/div&gt;
76:     &lt;/div&gt;
77:   );
78: }</file><file path="src/__tests__/dr13-coverage.test.tsx">  1: /**
  2:  * DR13: Test coverage for TrendChart, TrendSeries, Sparkline, role views, API route validation.
  3:  * Resolves backlog item DR13.
  4:  */
  5: import { describe, it, expect, afterEach, beforeEach, vi } from &apos;vitest&apos;;
  6: import { render, screen, cleanup } from &apos;@testing-library/react&apos;;
  7: import { Sparkline } from &apos;../components/Sparkline.js&apos;;
  8: import { TrendChart } from &apos;../components/TrendChart.js&apos;;
  9: import { TrendSeries } from &apos;../components/TrendSeries.js&apos;;
 10: import { AuditorView } from &apos;../components/views/AuditorView.js&apos;;
 11: import { ExecutiveView } from &apos;../components/views/ExecutiveView.js&apos;;
 12: import { OperatorView } from &apos;../components/views/OperatorView.js&apos;;
 13: import type { MetricTrend, MetricDynamics } from &apos;../types.js&apos;;
 14: import type { TrendBucket } from &apos;../hooks/useTrend.js&apos;;
 15: 
 16: // Note: ResizeObserver stub is installed globally in setup.ts
 17: 
 18: afterEach(cleanup);
 19: 
 20: // ---------------------------------------------------------------------------
 21: // Helpers
 22: // ---------------------------------------------------------------------------
 23: 
 24: function makeTrend(overrides: Partial&lt;MetricTrend&gt; = {}): MetricTrend {
 25:   return {
 26:     direction: &apos;improving&apos;,
 27:     delta: 0.05,
 28:     previousValue: 0.80,
 29:     currentValue: 0.85,
 30:     percentChange: 6.25,
 31:     aggregation: &apos;avg&apos;,
 32:     ...overrides,
 33:   };
 34: }
 35: 
 36: function makeDynamics(overrides: Partial&lt;MetricDynamics&gt; = {}): MetricDynamics {
 37:   return {
 38:     featureVersion: &apos;1.0&apos;,
 39:     velocity: 0.02,
 40:     acceleration: 0.001,
 41:     inflectionDetected: false,
 42:     projectedStatus: &apos;healthy&apos;,
 43:     confidence: 0.75,
 44:     ...overrides,
 45:   };
 46: }
 47: 
 48: function makeTrendBucket(overrides: Partial&lt;TrendBucket&gt; = {}): TrendBucket {
 49:   return {
 50:     startTime: &apos;2026-02-20T00:00:00Z&apos;,
 51:     endTime: &apos;2026-02-21T00:00:00Z&apos;,
 52:     count: 5,
 53:     avg: 0.82,
 54:     percentiles: { p10: 0.7, p25: 0.77, p50: 0.82, p75: 0.88, p90: 0.93 },
 55:     trend: null,
 56:     dynamics: null,
 57:     ...overrides,
 58:   };
 59: }
 60: 
 61: // ---------------------------------------------------------------------------
 62: // Sparkline
 63: // ---------------------------------------------------------------------------
 64: 
 65: describe(&apos;Sparkline&apos;, () =&gt; {
 66:   it(&apos;renders null for fewer than 2 valid data points&apos;, () =&gt; {
 67:     const { container } = render(&lt;Sparkline data={[0.5]} /&gt;);
 68:     expect(container.firstChild).toBeNull();
 69:   });
 70: 
 71:   it(&apos;renders null for empty data&apos;, () =&gt; {
 72:     const { container } = render(&lt;Sparkline data={[]} /&gt;);
 73:     expect(container.firstChild).toBeNull();
 74:   });
 75: 
 76:   it(&apos;renders null when all values are null&apos;, () =&gt; {
 77:     const { container } = render(&lt;Sparkline data={[null, null, null]} /&gt;);
 78:     expect(container.firstChild).toBeNull();
 79:   });
 80: 
 81:   it(&apos;renders SVG with polyline when 2+ valid values&apos;, () =&gt; {
 82:     const { container } = render(&lt;Sparkline data={[0.5, 0.7, 0.9]} /&gt;);
 83:     const svg = container.querySelector(&apos;svg&apos;);
 84:     expect(svg).not.toBeNull();
 85:     const polyline = container.querySelector(&apos;polyline&apos;);
 86:     expect(polyline).not.toBeNull();
 87:     const points = polyline!.getAttribute(&apos;points&apos;);
 88:     expect(points).toBeTruthy();
 89:     expect(points!.split(&apos; &apos;)).toHaveLength(3);
 90:   });
 91: 
 92:   it(&apos;handles null gaps — excludes them from polyline points&apos;, () =&gt; {
 93:     const { container } = render(&lt;Sparkline data={[0.5, null, 0.9]} /&gt;);
 94:     const polyline = container.querySelector(&apos;polyline&apos;);
 95:     expect(polyline).not.toBeNull();
 96:     // Only 2 valid values, so polyline has 2 points
 97:     expect(polyline!.getAttribute(&apos;points&apos;)!.split(&apos; &apos;)).toHaveLength(2);
 98:   });
 99: 
100:   it(&apos;uses custom label as aria-label&apos;, () =&gt; {
101:     render(&lt;Sparkline data={[0.5, 0.7]} label=&quot;relevance trend&quot; /&gt;);
102:     expect(screen.getByLabelText(&apos;relevance trend&apos;)).toBeInTheDocument();
103:   });
104: 
105:   it(&apos;uses default aria-label when none provided&apos;, () =&gt; {
106:     render(&lt;Sparkline data={[0.5, 0.7]} /&gt;);
107:     expect(screen.getByLabelText(&apos;Score trend sparkline&apos;)).toBeInTheDocument();
108:   });
109: 
110:   it(&apos;respects custom width and height&apos;, () =&gt; {
111:     const { container } = render(&lt;Sparkline data={[0.5, 0.7]} width={120} height={40} /&gt;);
112:     const svg = container.querySelector(&apos;svg&apos;);
113:     expect(svg).toHaveAttribute(&apos;width&apos;, &apos;120&apos;);
114:     expect(svg).toHaveAttribute(&apos;height&apos;, &apos;40&apos;);
115:   });
116: 
117:   it(&apos;uses custom color on polyline stroke&apos;, () =&gt; {
118:     const { container } = render(&lt;Sparkline data={[0.5, 0.7]} color=&quot;#ff0000&quot; /&gt;);
119:     const polyline = container.querySelector(&apos;polyline&apos;);
120:     expect(polyline).toHaveAttribute(&apos;stroke&apos;, &apos;#ff0000&apos;);
121:   });
122: 
123:   it(&apos;renders null when only 1 of multiple is finite&apos;, () =&gt; {
124:     const { container } = render(&lt;Sparkline data={[NaN, Infinity, 0.5]} /&gt;);
125:     // Only 1 valid (0.5), renders null
126:     expect(container.firstChild).toBeNull();
127:   });
128: });
129: 
130: // ---------------------------------------------------------------------------
131: // TrendChart
132: // ---------------------------------------------------------------------------
133: 
134: // Pinned epoch for all time-relative assertions in this describe block
135: const PINNED_NOW = new Date(&apos;2026-02-22T12:00:00.000Z&apos;);
136: 
137: describe(&apos;TrendChart&apos;, () =&gt; {
138:   beforeEach(() =&gt; {
139:     vi.useFakeTimers();
140:     vi.setSystemTime(PINNED_NOW);
141:   });
142:   afterEach(() =&gt; {
143:     vi.useRealTimers();
144:   });
145: 
146:   it(&apos;renders empty state when no trend provided&apos;, () =&gt; {
147:     render(&lt;TrendChart metricName=&quot;relevance&quot; /&gt;);
148:     expect(screen.getByText(&apos;No trend data available&apos;)).toBeInTheDocument();
149:   });
150: 
151:   it(&apos;renders chart container with aria-label when trend provided&apos;, () =&gt; {
152:     render(&lt;TrendChart trend={makeTrend()} metricName=&quot;relevance&quot; /&gt;);
153:     expect(screen.getByLabelText(&apos;Trend chart for relevance&apos;)).toBeInTheDocument();
154:   });
155: 
156:   it(&apos;shows projection data when dynamics.velocity is non-zero&apos;, () =&gt; {
157:     const trend = makeTrend();
158:     const dynamics = makeDynamics({ velocity: 0.05 });
159:     render(&lt;TrendChart trend={trend} dynamics={dynamics} metricName=&quot;relevance&quot; /&gt;);
160:     // velocity is shown in the dynamics section
161:     expect(screen.getByText(&apos;Velocity:&apos;)).toBeInTheDocument();
162:     expect(screen.getByText(&apos;Acceleration:&apos;)).toBeInTheDocument();
163:   });
164: 
165:   it(&apos;does not show dynamics section when dynamics is undefined&apos;, () =&gt; {
166:     render(&lt;TrendChart trend={makeTrend()} metricName=&quot;relevance&quot; /&gt;);
167:     expect(screen.queryByText(&apos;Velocity:&apos;)).toBeNull();
168:   });
169: 
170:   it(&apos;shows zero-velocity dynamics section without projection&apos;, () =&gt; {
171:     const dynamics = makeDynamics({ velocity: 0 });
172:     render(&lt;TrendChart trend={makeTrend()} dynamics={dynamics} metricName=&quot;relevance&quot; /&gt;);
173:     expect(screen.getByText(&apos;Velocity:&apos;)).toBeInTheDocument();
174:     // No &quot;Breach in&quot; when velocity is 0 and no projectedBreachTime
175:     expect(screen.queryByText(&apos;Breach in:&apos;)).toBeNull();
176:   });
177: 
178:   it(&apos;shows breach time when projectedBreachTime is provided&apos;, () =&gt; {
179:     // Project breach 25h from pinned now — renders as &quot;25.0h&quot;
180:     const futureIso = new Date(PINNED_NOW.getTime() + 25 * 60 * 60 * 1000).toISOString();
181:     const dynamics = makeDynamics({
182:       velocity: 0.05,
183:       projectedBreachTime: futureIso,
184:       projectedStatus: &apos;warning&apos;,
185:     });
186:     render(&lt;TrendChart trend={makeTrend()} dynamics={dynamics} metricName=&quot;relevance&quot; /&gt;);
187:     expect(screen.getByText(&apos;Breach in:&apos;)).toBeInTheDocument();
188:     expect(screen.getByText(&apos;25.0h&apos;)).toBeInTheDocument();
189:   });
190: 
191:   it(&apos;shows &quot;threshold exceeded&quot; for breach in the past&apos;, () =&gt; {
192:     const pastIso = new Date(PINNED_NOW.getTime() - 1 * 60 * 60 * 1000).toISOString();
193:     const dynamics = makeDynamics({
194:       velocity: 0.05,
195:       projectedBreachTime: pastIso,
196:       projectedStatus: &apos;critical&apos;,
197:     });
198:     render(&lt;TrendChart trend={makeTrend()} dynamics={dynamics} metricName=&quot;relevance&quot; /&gt;);
199:     expect(screen.getByText(&apos;threshold exceeded&apos;)).toBeInTheDocument();
200:   });
201: 
202:   it(&apos;shows breach in minutes for sub-1h breach&apos;, () =&gt; {
203:     // 30 minutes from pinned now → &quot;30m&quot;
204:     const futureIso = new Date(PINNED_NOW.getTime() + 30 * 60 * 1000).toISOString();
205:     const dynamics = makeDynamics({
206:       velocity: 0.05,
207:       projectedBreachTime: futureIso,
208:       projectedStatus: &apos;warning&apos;,
209:     });
210:     render(&lt;TrendChart trend={makeTrend()} dynamics={dynamics} metricName=&quot;relevance&quot; /&gt;);
211:     expect(screen.getByText(&apos;30m&apos;)).toBeInTheDocument();
212:   });
213: 
214:   it(&apos;shows breach in days for 2d+ breach&apos;, () =&gt; {
215:     // 3 days from pinned now → &quot;3.0d&quot;
216:     const futureIso = new Date(PINNED_NOW.getTime() + 3 * 24 * 60 * 60 * 1000).toISOString();
217:     const dynamics = makeDynamics({
218:       velocity: 0.05,
219:       projectedBreachTime: futureIso,
220:       projectedStatus: &apos;warning&apos;,
221:     });
222:     render(&lt;TrendChart trend={makeTrend()} dynamics={dynamics} metricName=&quot;relevance&quot; /&gt;);
223:     expect(screen.getByText(&apos;3.0d&apos;)).toBeInTheDocument();
224:   });
225: 
226:   it(&apos;shows confidence percentage&apos;, () =&gt; {
227:     render(&lt;TrendChart trend={makeTrend()} dynamics={makeDynamics({ confidence: 0.75 })} metricName=&quot;relevance&quot; /&gt;);
228:     expect(screen.getByText(&apos;Confidence:&apos;)).toBeInTheDocument();
229:     expect(screen.getByText(&apos;75%&apos;)).toBeInTheDocument();
230:   });
231: 
232:   // Y-domain: when previousValue === currentValue, yPad falls back to 0.05 (TrendChart.tsx:86)
233:   // This must render the chart container, not the &quot;Insufficient data&quot; fallback
234:   it(&apos;renders chart (not empty state) when previous and current values are equal (flat trend)&apos;, () =&gt; {
235:     const flatTrend = makeTrend({ previousValue: 0.8, currentValue: 0.8, delta: 0 });
236:     render(&lt;TrendChart trend={flatTrend} metricName=&quot;relevance&quot; /&gt;);
237:     expect(screen.getByLabelText(&apos;Trend chart for relevance&apos;)).toBeInTheDocument();
238:     expect(screen.queryByText(&apos;No trend data available&apos;)).toBeNull();
239:     expect(screen.queryByText(&apos;Insufficient data&apos;)).toBeNull();
240:   });
241: 
242:   // Y-domain: chart handles threshold values in domain calculation
243:   it(&apos;renders without error when warningThreshold and criticalThreshold provided&apos;, () =&gt; {
244:     expect(() =&gt;
245:       render(
246:         &lt;TrendChart
247:           trend={makeTrend()}
248:           warningThreshold={0.7}
249:           criticalThreshold={0.5}
250:           metricName=&quot;relevance&quot;
251:         /&gt;,
252:       ),
253:     ).not.toThrow();
254:   });
255: });
256: 
257: // ---------------------------------------------------------------------------
258: // TrendSeries
259: // ---------------------------------------------------------------------------
260: 
261: describe(&apos;TrendSeries&apos;, () =&gt; {
262:   it(&apos;renders empty state when data is empty array&apos;, () =&gt; {
263:     render(&lt;TrendSeries data={[]} metricName=&quot;relevance&quot; /&gt;);
264:     expect(screen.getByText(&apos;No trend data available&apos;)).toBeInTheDocument();
265:   });
266: 
267:   it(&apos;renders &quot;no scored evaluations&quot; when all avg values are null&apos;, () =&gt; {
268:     const buckets: TrendBucket[] = [
269:       makeTrendBucket({ avg: null, percentiles: null }),
270:       makeTrendBucket({ avg: null, percentiles: null }),
271:     ];
272:     render(&lt;TrendSeries data={buckets} metricName=&quot;relevance&quot; /&gt;);
273:     expect(screen.getByText(&apos;No scored evaluations in period&apos;)).toBeInTheDocument();
274:   });
275: 
276:   it(&apos;renders chart container when data has valid avg values&apos;, () =&gt; {
277:     const buckets: TrendBucket[] = [
278:       makeTrendBucket({ startTime: &apos;2026-02-20T00:00:00Z&apos;, endTime: &apos;2026-02-21T00:00:00Z&apos;, avg: 0.82 }),
279:       makeTrendBucket({ startTime: &apos;2026-02-21T00:00:00Z&apos;, endTime: &apos;2026-02-22T00:00:00Z&apos;, avg: 0.85 }),
280:     ];
281:     render(&lt;TrendSeries data={buckets} metricName=&quot;relevance&quot; /&gt;);
282:     expect(screen.getByLabelText(&apos;Time series trend for relevance&apos;)).toBeInTheDocument();
283:   });
284: 
285:   it(&apos;renders legend row with avg, p50, p10-p90 labels&apos;, () =&gt; {
286:     const buckets: TrendBucket[] = [
287:       makeTrendBucket({ avg: 0.82 }),
288:       makeTrendBucket({ avg: 0.85 }),
289:     ];
290:     const { container } = render(&lt;TrendSeries data={buckets} metricName=&quot;relevance&quot; /&gt;);
291:     expect(container.textContent).toContain(&apos;avg&apos;);
292:     expect(container.textContent).toContain(&apos;p50&apos;);
293:     expect(container.textContent).toContain(&apos;p10-p90&apos;);
294:   });
295: 
296:   it(&apos;handles single-day span without error&apos;, () =&gt; {
297:     const now = new Date(&apos;2026-02-22T12:00:00Z&apos;);
298:     const buckets: TrendBucket[] = [
299:       makeTrendBucket({
300:         startTime: new Date(now.getTime() - 12 * 3600000).toISOString(),
301:         endTime: now.toISOString(),
302:         avg: 0.82,
303:       }),
304:       makeTrendBucket({
305:         startTime: now.toISOString(),
306:         endTime: new Date(now.getTime() + 12 * 3600000).toISOString(),
307:         avg: 0.84,
308:       }),
309:     ];
310:     expect(() =&gt; render(&lt;TrendSeries data={buckets} metricName=&quot;relevance&quot; /&gt;)).not.toThrow();
311:   });
312: });
313: 
314: // ---------------------------------------------------------------------------
315: // Role Views
316: // ---------------------------------------------------------------------------
317: 
318: function makeMetricResult(name: string, displayName: string, status: &apos;healthy&apos; | &apos;warning&apos; | &apos;critical&apos; | &apos;no_data&apos; = &apos;healthy&apos;) {
319:   return {
320:     name,
321:     displayName,
322:     status,
323:     sampleCount: 10,
324:     values: { avg: 0.88, min: 0.70, max: 0.95, count: 10, p50: 0.88, p95: 0.93, p99: 0.95 },
325:     alerts: [] as Array&lt;{ severity: &apos;warning&apos; | &apos;critical&apos;; message: string; aggregation: &apos;avg&apos;; threshold: number; actualValue: number; direction: &apos;below&apos; | &apos;above&apos; }&gt;,
326:   };
327: }
328: 
329: describe(&apos;AuditorView&apos;, () =&gt; {
330:   function makeAuditorData() {
331:     return {
332:       role: &apos;auditor&apos; as const,
333:       totalEvaluationCount: 150,
334:       metrics: [makeMetricResult(&apos;relevance&apos;, &apos;Relevance&apos;)],
335:       alerts: [
336:         { severity: &apos;warning&apos; as const, message: &apos;Relevance degrading&apos;, aggregation: &apos;avg&apos; as const,
337:           threshold: 0.8, actualValue: 0.79, direction: &apos;below&apos; as const, metricName: &apos;relevance&apos; },
338:       ],
339:       timestamp: &apos;2026-02-22T12:00:00Z&apos;,
340:       slaCompliance: [],
341:     };
342:   }
343: 
344:   it(&apos;renders total evaluation count&apos;, () =&gt; {
345:     const { container } = render(&lt;AuditorView data={makeAuditorData()} /&gt;);
346:     // The 150 count appears in the first stats card
347:     const countCards = container.querySelectorAll(&apos;.card&apos;);
348:     const texts = Array.from(countCards).map(el =&gt; el.textContent);
349:     expect(texts.some(t =&gt; t?.includes(&apos;150&apos;))).toBe(true);
350:   });
351: 
352:   it(&apos;renders metrics count as 1&apos;, () =&gt; {
353:     const { container } = render(&lt;AuditorView data={makeAuditorData()} /&gt;);
354:     // stats cards: 150 (total), 1 (metrics), 1 (alerts)
355:     const cardTexts = Array.from(container.querySelectorAll(&apos;.card&apos;)).map(el =&gt; el.textContent);
356:     // At least one card shows &quot;1&quot; and &quot;Metrics&quot;
357:     expect(cardTexts.some(t =&gt; t?.includes(&apos;Metrics&apos;) &amp;&amp; t?.includes(&apos;1&apos;))).toBe(true);
358:   });
359: 
360:   it(&apos;shows All Metrics section&apos;, () =&gt; {
361:     render(&lt;AuditorView data={makeAuditorData()} /&gt;);
362:     expect(screen.getByText(&apos;All Metrics&apos;)).toBeInTheDocument();
363:   });
364: 
365:   it(&apos;shows All Alerts section when alerts present&apos;, () =&gt; {
366:     render(&lt;AuditorView data={makeAuditorData()} /&gt;);
367:     expect(screen.getByText(&apos;All Alerts&apos;)).toBeInTheDocument();
368:   });
369: 
370:   it(&apos;does not show alerts section when no alerts&apos;, () =&gt; {
371:     const data = { ...makeAuditorData(), alerts: [] };
372:     render(&lt;AuditorView data={data} /&gt;);
373:     expect(screen.queryByText(&apos;All Alerts&apos;)).toBeNull();
374:   });
375: 
376:   it(&apos;renders computed-at timestamp&apos;, () =&gt; {
377:     render(&lt;AuditorView data={makeAuditorData()} /&gt;);
378:     expect(screen.getByText(&apos;Computed At&apos;)).toBeInTheDocument();
379:   });
380: });
381: 
382: describe(&apos;ExecutiveView&apos;, () =&gt; {
383:   function makeExecutiveData() {
384:     return {
385:       role: &apos;executive&apos; as const,
386:       overallStatus: &apos;healthy&apos; as const,
387:       summary: { totalMetrics: 7, healthyMetrics: 6, warningMetrics: 1, criticalMetrics: 0, noDataMetrics: 0 },
388:       topIssues: [
389:         { name: &apos;hallucination&apos;, displayName: &apos;Hallucination Rate&apos;, status: &apos;warning&apos;, alertCount: 2 },
390:       ],
391:       metricStatuses: [
392:         { name: &apos;relevance&apos;, displayName: &apos;Relevance&apos;, status: &apos;healthy&apos; },
393:         { name: &apos;hallucination&apos;, displayName: &apos;Hallucination Rate&apos;, status: &apos;warning&apos; },
394:       ],
395:       alertCounts: { warning: 1, critical: 0, info: 0 },
396:     };
397:   }
398: 
399:   it(&apos;renders Executive Summary header&apos;, () =&gt; {
400:     render(&lt;ExecutiveView data={makeExecutiveData()} /&gt;);
401:     expect(screen.getByText(&apos;Executive Summary&apos;)).toBeInTheDocument();
402:   });
403: 
404:   it(&apos;renders top issues when present&apos;, () =&gt; {
405:     render(&lt;ExecutiveView data={makeExecutiveData()} /&gt;);
406:     expect(screen.getByText(&apos;Top Issues&apos;)).toBeInTheDocument();
407:     // &quot;Hallucination Rate&quot; appears in both top issues and metric statuses
408:     expect(screen.getAllByText(&apos;Hallucination Rate&apos;).length).toBeGreaterThanOrEqual(1);
409:   });
410: 
411:   it(&apos;renders metric statuses&apos;, () =&gt; {
412:     render(&lt;ExecutiveView data={makeExecutiveData()} /&gt;);
413:     expect(screen.getByText(&apos;Metric Statuses&apos;)).toBeInTheDocument();
414:     expect(screen.getByText(&apos;Relevance&apos;)).toBeInTheDocument();
415:   });
416: 
417:   it(&apos;renders alert summary counts&apos;, () =&gt; {
418:     render(&lt;ExecutiveView data={makeExecutiveData()} /&gt;);
419:     expect(screen.getByText(&apos;Alert Summary&apos;)).toBeInTheDocument();
420:   });
421: 
422:   it(&apos;renders SLA counts when provided&apos;, () =&gt; {
423:     const data = { ...makeExecutiveData(), slaCompliantCount: 3, slaTotalCount: 4 };
424:     render(&lt;ExecutiveView data={data} /&gt;);
425:     expect(screen.getByText(&apos;3/4&apos;)).toBeInTheDocument();
426:     expect(screen.getByText(&apos;SLAs Met&apos;)).toBeInTheDocument();
427:   });
428: 
429:   it(&apos;shows plural alerts in top issues&apos;, () =&gt; {
430:     render(&lt;ExecutiveView data={makeExecutiveData()} /&gt;);
431:     expect(screen.getByText(/2 alerts/)).toBeInTheDocument();
432:   });
433: 
434:   it(&apos;shows singular alert in top issues&apos;, () =&gt; {
435:     const data = {
436:       ...makeExecutiveData(),
437:       topIssues: [{ name: &apos;relevance&apos;, displayName: &apos;Relevance&apos;, status: &apos;warning&apos;, alertCount: 1 }],
438:     };
439:     render(&lt;ExecutiveView data={data} /&gt;);
440:     // &quot;1 alert&quot; (no &apos;s&apos;)
441:     const listItems = screen.getAllByRole(&apos;listitem&apos;);
442:     expect(listItems.some(li =&gt; li.textContent?.includes(&apos;1 alert&apos;) &amp;&amp; !li.textContent?.includes(&apos;alerts&apos;))).toBe(true);
443:   });
444: });
445: 
446: describe(&apos;OperatorView&apos;, () =&gt; {
447:   function makeTrendForOperator(): MetricTrend {
448:     return { direction: &apos;degrading&apos;, delta: -0.05, previousValue: 0.85, currentValue: 0.80, percentChange: -5.88, aggregation: &apos;avg&apos; };
449:   }
450: 
451:   function makeOperatorData() {
452:     return {
453:       role: &apos;operator&apos; as const,
454:       overallStatus: &apos;warning&apos; as const,
455:       prioritizedAlerts: [
456:         { severity: &apos;warning&apos; as const, message: &apos;Relevance below threshold&apos;, aggregation: &apos;avg&apos; as const,
457:           threshold: 0.8, actualValue: 0.75, direction: &apos;below&apos; as const, metricName: &apos;relevance&apos; },
458:       ],
459:       degradingTrends: [
460:         { metricName: &apos;relevance&apos;, trend: makeTrendForOperator() },
461:       ],
462:       alertingMetrics: [],
463:     };
464:   }
465: 
466:   it(&apos;renders &quot;All Clear&quot; when no alerts and no degrading trends&apos;, () =&gt; {
467:     const data = { ...makeOperatorData(), prioritizedAlerts: [], degradingTrends: [] };
468:     render(&lt;OperatorView data={data} /&gt;);
469:     expect(screen.getByText(&apos;All Clear&apos;)).toBeInTheDocument();
470:     expect(screen.getByText(&apos;No active alerts or degrading trends.&apos;)).toBeInTheDocument();
471:   });
472: 
473:   it(&apos;renders prioritized alerts when present&apos;, () =&gt; {
474:     render(&lt;OperatorView data={makeOperatorData()} /&gt;);
475:     expect(screen.getByText(&apos;Prioritized Alerts&apos;)).toBeInTheDocument();
476:     expect(screen.getByText(&apos;Relevance below threshold&apos;)).toBeInTheDocument();
477:   });
478: 
479:   it(&apos;renders degrading trends section when present&apos;, () =&gt; {
480:     render(&lt;OperatorView data={makeOperatorData()} /&gt;);
481:     expect(screen.getByText(&apos;Degrading Trends&apos;)).toBeInTheDocument();
482:     expect(screen.getByText(/relevance/)).toBeInTheDocument();
483:   });
484: 
485:   it(&apos;renders alert count in header banner&apos;, () =&gt; {
486:     render(&lt;OperatorView data={makeOperatorData()} /&gt;);
487:     expect(screen.getByText(/1 active alert/)).toBeInTheDocument();
488:   });
489: 
490:   it(&apos;renders plural in banner for multiple alerts&apos;, () =&gt; {
491:     const data = {
492:       ...makeOperatorData(),
493:       prioritizedAlerts: [
494:         { severity: &apos;warning&apos; as const, message: &apos;Alert 1&apos;, aggregation: &apos;avg&apos; as const, threshold: 0.8, actualValue: 0.75, direction: &apos;below&apos; as const, metricName: &apos;relevance&apos; },
495:         { severity: &apos;critical&apos; as const, message: &apos;Alert 2&apos;, aggregation: &apos;avg&apos; as const, threshold: 0.5, actualValue: 0.3, direction: &apos;below&apos; as const, metricName: &apos;faithfulness&apos; },
496:       ],
497:     };
498:     render(&lt;OperatorView data={data} /&gt;);
499:     expect(screen.getByText(/2 active alerts/)).toBeInTheDocument();
500:   });
501: 
502:   it(&apos;does not show All Clear when only degrading trends present&apos;, () =&gt; {
503:     const data = { ...makeOperatorData(), prioritizedAlerts: [] };
504:     render(&lt;OperatorView data={data} /&gt;);
505:     expect(screen.queryByText(&apos;All Clear&apos;)).toBeNull();
506:   });
507: });
508: 
509: // ---------------------------------------------------------------------------
510: // Trends API route — input validation
511: // ---------------------------------------------------------------------------
512: 
513: vi.mock(&apos;../../../../dist/lib/quality-metrics.js&apos;, () =&gt; ({
514:   getQualityMetric: vi.fn((name: string) =&gt; name === &apos;relevance&apos; ? { aggregations: [&apos;avg&apos;] } : null),
515:   computeMetricDetail: vi.fn(() =&gt; null),
516:   computeAggregations: vi.fn(() =&gt; ({})),
517:   QUALITY_METRICS: { relevance: { aggregations: [&apos;avg&apos;] } },
518: }));
519: 
520: vi.mock(&apos;../../../../dist/lib/quality-feature-engineering.js&apos;, () =&gt; ({
521:   computePercentileDistribution: vi.fn(() =&gt; null),
522:   computeMetricDynamics: vi.fn(() =&gt; null),
523: }));
524: 
525: vi.mock(&apos;../../../../dist/lib/error-sanitizer.js&apos;, () =&gt; ({
526:   sanitizeErrorForResponse: vi.fn((e: unknown) =&gt; String(e)),
527: }));
528: 
529: vi.mock(&apos;../api/data-loader.js&apos;, async () =&gt; ({
530:   loadEvaluationsForMetric: vi.fn(async () =&gt; []),
531: }));
532: 
533: describe(&apos;trends API route validation&apos;, () =&gt; {
534:   // ESM caches the module — trendRoutes is a singleton across all loadTrendRoutes() calls.
535:   // Reset mock call counts after each test; implementations are preserved by vi.clearAllMocks().
536:   afterEach(() =&gt; {
537:     vi.clearAllMocks();
538:   });
539: 
540:   async function loadTrendRoutes() {
541:     const { trendRoutes } = await import(&apos;../api/routes/trends.js&apos;);
542:     return trendRoutes;
543:   }
544: 
545:   it(&apos;returns 404 for unknown metric&apos;, async () =&gt; {
546:     const app = await loadTrendRoutes();
547:     const res = await app.request(&apos;/trends/nonexistent-metric&apos;);
548:     expect(res.status).toBe(404);
549:     const body = await res.json() as { error: string };
550:     expect(body.error).toContain(&apos;nonexistent-metric&apos;);
551:   });
552: 
553:   it(&apos;returns 400 for invalid period param&apos;, async () =&gt; {
554:     const app = await loadTrendRoutes();
555:     const res = await app.request(&apos;/trends/relevance?period=invalid&apos;);
556:     expect(res.status).toBe(400);
557:     const body = await res.json() as { error: string };
558:     expect(body.error).toContain(&apos;Invalid period&apos;);
559:   });
560: 
561:   it(&apos;returns 400 for invalid buckets param (non-integer)&apos;, async () =&gt; {
562:     const app = await loadTrendRoutes();
563:     const res = await app.request(&apos;/trends/relevance?period=7d&amp;buckets=abc&apos;);
564:     expect(res.status).toBe(400);
565:     const body = await res.json() as { error: string };
566:     expect(body.error).toContain(&apos;Invalid buckets&apos;);
567:   });
568: 
569:   it(&apos;returns 400 for buckets below minimum (&lt; 3)&apos;, async () =&gt; {
570:     const app = await loadTrendRoutes();
571:     const res = await app.request(&apos;/trends/relevance?period=7d&amp;buckets=2&apos;);
572:     expect(res.status).toBe(400);
573:   });
574: 
575:   it(&apos;returns 400 for buckets above maximum (&gt; 30)&apos;, async () =&gt; {
576:     const app = await loadTrendRoutes();
577:     const res = await app.request(&apos;/trends/relevance?period=7d&amp;buckets=31&apos;);
578:     expect(res.status).toBe(400);
579:   });
580: 
581:   it(&apos;returns 200 for valid known metric and default params&apos;, async () =&gt; {
582:     const app = await loadTrendRoutes();
583:     const res = await app.request(&apos;/trends/relevance&apos;);
584:     expect(res.status).toBe(200);
585:     const body = await res.json() as { metric: string };
586:     expect(body.metric).toBe(&apos;relevance&apos;);
587:   });
588: 
589:   it(&apos;returns 200 for valid period and buckets&apos;, async () =&gt; {
590:     const app = await loadTrendRoutes();
591:     const res = await app.request(&apos;/trends/relevance?period=24h&amp;buckets=5&apos;);
592:     expect(res.status).toBe(200);
593:   });
594: 
595:   it(&apos;returns 400 for invalid period on /trends summary route&apos;, async () =&gt; {
596:     const app = await loadTrendRoutes();
597:     const res = await app.request(&apos;/trends?period=invalid&apos;);
598:     expect(res.status).toBe(400);
599:   });
600: });</file><file path="src/api/routes/coverage.ts"> 1: import { Hono } from &apos;hono&apos;;
 2: import { z } from &apos;zod&apos;;
 3: import { computeCoverageHeatmap } from &apos;../../../../dist/lib/quality-metrics.js&apos;;
 4: import { sanitizeErrorForResponse } from &apos;../../../../dist/lib/error-sanitizer.js&apos;;
 5: import type { EvaluationResult } from &apos;../../../../dist/backends/index.js&apos;;
 6: import { loadEvaluationsByMetric } from &apos;../data-loader.js&apos;;
 7: import { PeriodSchema, PERIOD_MS, InputKeySchema, ErrorMessage, HttpStatus } from &apos;../../lib/constants.js&apos;;
 8: 
 9: /** Filter out rule-based per-span evaluations; they have incompatible
10:  *  traceId granularity that inflates the coverage input universe.
11:  *  Keeps LLM judge evals (evaluatorType &apos;llm&apos;, undefined for seed/canary). */
12: function filterJudgeEvaluations(
13:   byMetric: Map&lt;string, EvaluationResult[]&gt;,
14: ): Map&lt;string, EvaluationResult[]&gt; {
15:   const filtered = new Map&lt;string, EvaluationResult[]&gt;();
16:   for (const [metric, evals] of byMetric) {
17:     const judgeEvals = evals.filter(e =&gt; e.evaluatorType !== &apos;rule&apos;);
18:     if (judgeEvals.length &gt; 0) {
19:       filtered.set(metric, judgeEvals);
20:     }
21:   }
22:   return filtered;
23: }
24: 
25: export const coverageRoutes = new Hono();
26: 
27: /**
28:  * GET /api/coverage
29:  * Returns coverage heatmap: metrics x inputs with gap identification.
30:  *
31:  * Query params:
32:  *   period: &apos;24h&apos; | &apos;7d&apos; | &apos;30d&apos; (default: &apos;7d&apos;)
33:  *   inputKey: &apos;traceId&apos; | &apos;sessionId&apos; (default: &apos;traceId&apos;)
34:  */
35: coverageRoutes.get(&apos;/coverage&apos;, async (c) =&gt; {
36:   const periodResult = PeriodSchema.safeParse(c.req.query(&apos;period&apos;));
37:   if (!periodResult.success) {
38:     return c.json({ error: ErrorMessage.InvalidPeriod }, HttpStatus.BadRequest);
39:   }
40:   const inputKeyResult = InputKeySchema.safeParse(c.req.query(&apos;inputKey&apos;));
41:   if (!inputKeyResult.success) {
42:     return c.json({ error: &apos;Invalid inputKey. Must be traceId or sessionId.&apos; }, HttpStatus.BadRequest);
43:   }
44: 
45:   try {
46:     const now = new Date();
47:     const period = periodResult.data;
48:     const periodMs = PERIOD_MS[period] ?? PERIOD_MS[&apos;7d&apos;];
49:     const start = new Date(now.getTime() - periodMs);
50: 
51:     const allEvaluations = await loadEvaluationsByMetric(
52:       start.toISOString(),
53:       now.toISOString(),
54:     );
55:     const evaluationsByMetric = filterJudgeEvaluations(allEvaluations);
56: 
57:     const heatmap = computeCoverageHeatmap(evaluationsByMetric, {
58:       inputKey: inputKeyResult.data,
59:     });
60: 
61:     return c.json({ period, ...heatmap });
62:   } catch (err) {
63:     return c.json({ error: sanitizeErrorForResponse(err) }, HttpStatus.InternalServerError);
64:   }
65: });</file><file path="src/api/data-loader.ts">  1: import { MultiDirectoryBackend } from &apos;../../../dist/backends/local-jsonl.js&apos;;
  2: import type { EvaluationResult, TraceSpan } from &apos;../../../dist/backends/index.js&apos;;
  3: import { queryVerifications as queryVerificationsLib, type HumanVerificationEvent, type VerificationQueryOptions } from &apos;../../../dist/lib/verification-events.js&apos;;
  4: import { queryTraces as queryTracesTool } from &apos;../../../dist/tools/query-traces.js&apos;;
  5: 
  6: let backend: MultiDirectoryBackend | undefined;
  7: 
  8: function getBackend(): MultiDirectoryBackend {
  9:   if (!backend) {
 10:     backend = new MultiDirectoryBackend(undefined, true);
 11:   }
 12:   return backend;
 13: }
 14: 
 15: /** Convert ISO timestamp or date string to YYYY-MM-DD */
 16: function toDateOnly(d: string): string {
 17:   return d.split(&apos;T&apos;)[0];
 18: }
 19: 
 20: export async function loadEvaluationsByMetric(
 21:   start: string,
 22:   end: string
 23: ): Promise&lt;Map&lt;string, EvaluationResult[]&gt;&gt; {
 24:   const be = getBackend();
 25:   const evals = await be.queryEvaluations({ startDate: start, endDate: end, limit: 100_000 });
 26:   const grouped = new Map&lt;string, EvaluationResult[]&gt;();
 27:   for (const ev of evals) {
 28:     const name = ev.evaluationName;
 29:     if (!grouped.has(name)) grouped.set(name, []);
 30:     grouped.get(name)!.push(ev);
 31:   }
 32:   return grouped;
 33: }
 34: 
 35: export async function loadEvaluationsForMetric(
 36:   metricName: string,
 37:   start: string,
 38:   end: string
 39: ): Promise&lt;EvaluationResult[]&gt; {
 40:   const be = getBackend();
 41:   return be.queryEvaluations({
 42:     startDate: start,
 43:     endDate: end,
 44:     evaluationName: metricName,
 45:     limit: 10000,
 46:   });
 47: }
 48: 
 49: export async function loadEvaluationsByTraceId(
 50:   traceId: string,
 51:   startDate?: string,
 52:   endDate?: string,
 53: ): Promise&lt;EvaluationResult[]&gt; {
 54:   const be = getBackend();
 55:   const now = new Date();
 56:   return be.queryEvaluations({
 57:     traceId,
 58:     startDate: startDate ?? new Date(now.getTime() - 90 * 24 * 60 * 60 * 1000).toISOString(),
 59:     endDate: endDate ?? now.toISOString(),
 60:     limit: 1000,
 61:   });
 62: }
 63: 
 64: /**
 65:  * Loads evaluations matching any of the given traceIds.
 66:  * NOTE: O(all_evals) — fetches all evaluations for the date range then
 67:  * filters in memory because the backend lacks a multi-traceId query.
 68:  * Callers should keep date ranges narrow to limit the scan cost.
 69:  */
 70: export async function loadEvaluationsByTraceIds(
 71:   traceIds: string[],
 72:   startDate?: string,
 73:   endDate?: string
 74: ): Promise&lt;EvaluationResult[]&gt; {
 75:   if (traceIds.length === 0) return [];
 76:   const be = getBackend();
 77:   const now = new Date();
 78:   const start = startDate ?? new Date(now.getTime() - 7 * 24 * 60 * 60 * 1000).toISOString();
 79:   const end = endDate ?? now.toISOString();
 80:   const allEvals = await be.queryEvaluations({
 81:     startDate: start,
 82:     endDate: end,
 83:     limit: 10000,
 84:   });
 85:   const idSet = new Set(traceIds);
 86:   return allEvals.filter(e =&gt; e.traceId &amp;&amp; idSet.has(e.traceId));
 87: }
 88: 
 89: export async function loadTracesByTraceId(
 90:   traceId: string,
 91:   startDate?: string,
 92:   endDate?: string,
 93: ) {
 94:   const now = new Date();
 95:   const start = startDate ? toDateOnly(startDate)
 96:     : toDateOnly(new Date(now.getTime() - 30 * 24 * 60 * 60 * 1000).toISOString());
 97:   const end = endDate ? toDateOnly(endDate) : toDateOnly(now.toISOString());
 98:   const result = await queryTracesTool({
 99:     traceId,
100:     startDate: start,
101:     endDate: end,
102:     limit: 500,
103:   });
104:   return result.traces;
105: }
106: 
107: export async function loadTracesBySessionId(
108:   sessionId: string,
109:   startDate?: string,
110:   endDate?: string,
111: ) {
112:   const now = new Date();
113:   const start = startDate ? toDateOnly(startDate)
114:     : toDateOnly(new Date(now.getTime() - 30 * 24 * 60 * 60 * 1000).toISOString());
115:   const end = endDate ? toDateOnly(endDate) : toDateOnly(now.toISOString());
116:   const result = await queryTracesTool({
117:     attributeFilter: { &apos;session.id&apos;: sessionId },
118:     startDate: start,
119:     endDate: end,
120:     limit: 500,
121:   });
122:   return result.traces;
123: }
124: 
125: export async function loadLogsByTraceId(
126:   traceId: string,
127:   startDate?: string,
128:   endDate?: string,
129: ): Promise&lt;Awaited&lt;ReturnType&lt;MultiDirectoryBackend[&apos;queryLogs&apos;]&gt;&gt;&gt; {
130:   const { queryLogs } = await import(&apos;../../../dist/tools/query-logs.js&apos;);
131:   const now = new Date();
132:   const start = startDate ? toDateOnly(startDate)
133:     : toDateOnly(new Date(now.getTime() - 30 * 24 * 60 * 60 * 1000).toISOString());
134:   const end = endDate ? toDateOnly(endDate) : toDateOnly(now.toISOString());
135:   const result = await queryLogs({
136:     traceId,
137:     startDate: start,
138:     endDate: end,
139:     limit: 1000,
140:   });
141:   return result.logs;
142: }
143: 
144: export async function loadVerifications(opts: {
145:   startDate?: string;
146:   endDate?: string;
147:   sessionId?: string;
148:   limit?: number;
149: }): Promise&lt;HumanVerificationEvent[]&gt; {
150:   const now = new Date();
151:   const ninetyDaysAgo = new Date(now.getTime() - 90 * 24 * 60 * 60 * 1000);
152:   return queryVerificationsLib({
153:     startDate: opts.startDate ?? ninetyDaysAgo.toISOString(),
154:     endDate: opts.endDate ?? now.toISOString(),
155:     sessionId: opts.sessionId,
156:     limit: opts.limit ?? 1000,
157:   });
158: }
159: 
160: export async function loadLogsBySessionId(
161:   sessionId: string,
162:   startDate?: string,
163:   endDate?: string,
164: ): Promise&lt;Awaited&lt;ReturnType&lt;MultiDirectoryBackend[&apos;queryLogs&apos;]&gt;&gt;&gt; {
165:   const { queryLogs } = await import(&apos;../../../dist/tools/query-logs.js&apos;);
166:   const now = new Date();
167:   const start = startDate ? toDateOnly(startDate)
168:     : toDateOnly(new Date(now.getTime() - 30 * 24 * 60 * 60 * 1000).toISOString());
169:   const end = endDate ? toDateOnly(endDate) : toDateOnly(now.toISOString());
170:   const result = await queryLogs({
171:     sessionId,
172:     startDate: start,
173:     endDate: end,
174:     limit: 1000,
175:   });
176:   return result.logs;
177: }
178: 
179: export async function loadEvaluationsBySessionId(
180:   sessionId: string,
181:   startDate?: string,
182:   endDate?: string,
183: ): Promise&lt;EvaluationResult[]&gt; {
184:   const be = getBackend();
185:   const now = new Date();
186:   return be.queryEvaluations({
187:     sessionId,
188:     startDate: startDate ?? new Date(now.getTime() - 30 * 24 * 60 * 60 * 1000).toISOString(),
189:     endDate: endDate ?? now.toISOString(),
190:     limit: 10000,
191:   });
192: }
193: 
194: export async function checkHealth(): Promise&lt;{ status: string; hasData: boolean }&gt; {
195:   const be = getBackend();
196:   const health = await be.healthCheck();
197:   const now = new Date();
198:   const weekAgo = new Date(now.getTime() - 7 * 24 * 60 * 60 * 1000);
199:   const evals = await be.queryEvaluations({
200:     startDate: weekAgo.toISOString(),
201:     endDate: now.toISOString(),
202:     limit: 1,
203:   });
204:   return { status: health.status, hasData: evals.length &gt; 0 };
205: }</file><file path="src/components/views/ExecutiveView.tsx"> 1: import type { ExecutiveView as ExecutiveViewType, CompositeQualityIndex } from &apos;../../types.js&apos;;
 2: import { StatusBadge } from &apos;../Indicators.js&apos;;
 3: import { CQIHero } from &apos;../CQIHero.js&apos;;
 4: import { StatCard } from &apos;../StatCard.js&apos;;
 5: import { ViewSection } from &apos;../Section.js&apos;;
 6: 
 7: interface ExtendedExecutiveView extends ExecutiveViewType {
 8:   cqi?: CompositeQualityIndex;
 9: }
10: 
11: export function ExecutiveView({ data }: { data: ExtendedExecutiveView }) {
12:   return (
13:     &lt;div&gt;
14:       &lt;div className={`health-banner ${data.overallStatus}`}&gt;
15:         &lt;div className=&quot;flex-center gap-3&quot;&gt;
16:           &lt;StatusBadge status={data.overallStatus} /&gt;
17:           &lt;span&gt;Executive Summary&lt;/span&gt;
18:         &lt;/div&gt;
19:         &lt;div className=&quot;summary-counts&quot;&gt;
20:           &lt;div className=&quot;summary-count&quot;&gt;
21:             &lt;div className=&quot;value&quot;&gt;{data.summary.totalMetrics}&lt;/div&gt;
22:             &lt;div className=&quot;label text-secondary text-xs&quot;&gt;Total&lt;/div&gt;
23:           &lt;/div&gt;
24:           &lt;div className=&quot;summary-count&quot;&gt;
25:             &lt;div className=&quot;value&quot; style={{ color: &apos;var(--status-healthy)&apos; }}&gt;{data.summary.healthyMetrics}&lt;/div&gt;
26:             &lt;div className=&quot;label text-secondary text-xs&quot;&gt;Healthy&lt;/div&gt;
27:           &lt;/div&gt;
28:           {data.slaCompliantCount !== undefined &amp;&amp; (
29:             &lt;div className=&quot;summary-count&quot;&gt;
30:               &lt;div className=&quot;value&quot;&gt;{data.slaCompliantCount}/{data.slaTotalCount}&lt;/div&gt;
31:               &lt;div className=&quot;label text-secondary text-xs&quot;&gt;SLAs Met&lt;/div&gt;
32:             &lt;/div&gt;
33:           )}
34:         &lt;/div&gt;
35:       &lt;/div&gt;
36: 
37:       {data.topIssues.length &gt; 0 &amp;&amp; (
38:         &lt;ViewSection title=&quot;Top Issues&quot;&gt;
39:           &lt;ul className=&quot;alert-list&quot;&gt;
40:             {data.topIssues.map((issue: { name: string; displayName: string; status: string; alertCount: number }) =&gt; (
41:               &lt;li key={issue.name} className={`alert-item ${issue.status}`}&gt;
42:                 &lt;div className=&quot;alert-message&quot;&gt;{issue.displayName}&lt;/div&gt;
43:                 &lt;div className=&quot;alert-meta text-secondary text-xs&quot;&gt;
44:                   Status: {issue.status} &amp;middot; {issue.alertCount} alert{issue.alertCount !== 1 ? &apos;s&apos; : &apos;&apos;}
45:                 &lt;/div&gt;
46:               &lt;/li&gt;
47:             ))}
48:           &lt;/ul&gt;
49:         &lt;/ViewSection&gt;
50:       )}
51: 
52:       {data.cqi &amp;&amp; (
53:         &lt;div className=&quot;view-section&quot;&gt;
54:           &lt;CQIHero cqi={data.cqi} /&gt;
55:         &lt;/div&gt;
56:       )}
57: 
58:       &lt;ViewSection title=&quot;Metric Statuses&quot;&gt;
59:         &lt;div className=&quot;metric-grid&quot;&gt;
60:           {data.metricStatuses.map((m: { name: string; displayName: string; status: string }) =&gt; (
61:             &lt;div key={m.name} className=&quot;card&quot; style={{ padding: 12, display: &apos;flex&apos;, justifyContent: &apos;space-between&apos;, alignItems: &apos;center&apos; }}&gt;
62:               &lt;span&gt;{m.displayName}&lt;/span&gt;
63:               &lt;StatusBadge status={m.status} /&gt;
64:             &lt;/div&gt;
65:           ))}
66:         &lt;/div&gt;
67:       &lt;/ViewSection&gt;
68: 
69:       &lt;ViewSection title=&quot;Alert Summary&quot;&gt;
70:         &lt;div style={{ display: &apos;flex&apos;, gap: &apos;var(--space-4)&apos; }}&gt;
71:           {Object.entries(data.alertCounts).map(([severity, count]) =&gt; (
72:             &lt;StatCard key={severity} value={String(count)} label={severity} /&gt;
73:           ))}
74:         &lt;/div&gt;
75:       &lt;/ViewSection&gt;
76:     &lt;/div&gt;
77:   );
78: }</file><file path="src/components/AgentScoreSummary.tsx"> 1: import { ScoreBadge } from &apos;./ScoreBadge.js&apos;;
 2: 
 3: interface AgentScoreSummaryProps {
 4:   handoffScore: number;
 5:   avgRelevance: number;
 6:   completeness: number;
 7: }
 8: 
 9: const SCORES = [
10:   { label: &apos;Handoff Score&apos;, metricName: &apos;handoff&apos; },
11:   { label: &apos;Avg Relevance&apos;, metricName: &apos;relevance&apos; },
12:   { label: &apos;Completeness&apos;, metricName: &apos;completeness&apos; },
13: ] as const;
14: 
15: export function AgentScoreSummary({ handoffScore, avgRelevance, completeness }: AgentScoreSummaryProps) {
16:   const values = { handoff: handoffScore, relevance: avgRelevance, completeness };
17:   return (
18:     &lt;div className=&quot;gap-6&quot; style={{ display: &apos;flex&apos;, flexWrap: &apos;wrap&apos; }}&gt;
19:       {SCORES.map(({ label, metricName }) =&gt; (
20:         &lt;div key={label} style={{ textAlign: &apos;center&apos; }}&gt;
21:           &lt;div className=&quot;field-label text-secondary text-xs mb-1&quot;&gt;{label}&lt;/div&gt;
22:           &lt;ScoreBadge score={values[metricName]} metricName={metricName} /&gt;
23:         &lt;/div&gt;
24:       ))}
25:     &lt;/div&gt;
26:   );
27: }</file><file path="src/components/CorrelationHeatmap.tsx">  1: import { scaleSequential } from &apos;d3-scale&apos;;
  2: import { interpolateRdYlGn } from &apos;d3-scale-chromatic&apos;;
  3: import type { CorrelationFeature } from &apos;../types.js&apos;;
  4: 
  5: interface CorrelationHeatmapProps {
  6:   correlations: CorrelationFeature[];
  7:   metrics: string[];
  8:   onCellClick?: (rowMetric: string, colMetric: string) =&gt; void;
  9: }
 10: 
 11: const SHORT_NAMES: Record&lt;string, string&gt; = {
 12:   faithfulness: &apos;Faith&apos;,
 13:   relevance: &apos;Relev&apos;,
 14:   coherence: &apos;Coher&apos;,
 15:   safety: &apos;Safety&apos;,
 16:   instruction_adherence: &apos;Instr&apos;,
 17:   tool_accuracy: &apos;Tool&apos;,
 18:   latency: &apos;Latency&apos;,
 19: };
 20: 
 21: function shortName(metric: string): string {
 22:   return SHORT_NAMES[metric] ?? metric.slice(0, 6);
 23: }
 24: 
 25: /**
 26:  * Returns black or white text for WCAG 4.5:1 contrast against the
 27:  * interpolateRdYlGn background color for a given pearsonR value.
 28:  * Uses relative luminance per WCAG 2.1 contrast ratio formula.
 29:  */
 30: function contrastText(pearsonR: number): string {
 31:   const bg = colorScale(pearsonR);
 32:   // Parse &quot;rgb(r, g, b)&quot; string from d3
 33:   const m = bg.match(/(\d+)/g);
 34:   if (!m || m.length &lt; 3) return &apos;#111&apos;;
 35:   const [r, g, b] = m.map(Number);
 36:   // sRGB relative luminance (WCAG 2.1)
 37:   const toLinear = (c: number) =&gt; {
 38:     const s = c / 255;
 39:     return s &lt;= 0.03928 ? s / 12.92 : ((s + 0.055) / 1.055) ** 2.4;
 40:   };
 41:   const L = 0.2126 * toLinear(r) + 0.7152 * toLinear(g) + 0.0722 * toLinear(b);
 42:   // WCAG contrast ratio: (L1 + 0.05) / (L2 + 0.05)
 43:   // White text (#fff, L=1.0) needs ratio &gt;= 4.5 → L_bg &lt;= ~0.18
 44:   // Black text (#111, L≈0.012) needs ratio &gt;= 4.5 → L_bg &gt;= ~0.10
 45:   return L &gt; 0.18 ? &apos;#111&apos; : &apos;#fff&apos;;
 46: }
 47: 
 48: const colorScale = scaleSequential(interpolateRdYlGn).domain([-1, 1]);
 49: 
 50: function lookupCorrelation(
 51:   correlations: CorrelationFeature[],
 52:   a: string,
 53:   b: string,
 54: ): CorrelationFeature | undefined {
 55:   return correlations.find(
 56:     (c) =&gt; (c.metricA === a &amp;&amp; c.metricB === b) || (c.metricA === b &amp;&amp; c.metricB === a),
 57:   );
 58: }
 59: 
 60: export function CorrelationHeatmap({ correlations, metrics, onCellClick }: CorrelationHeatmapProps) {
 61:   const n = metrics.length;
 62:   const cols = n + 1;
 63: 
 64:   return (
 65:     &lt;div
 66:       role=&quot;table&quot;
 67:       aria-label=&quot;Metric correlation matrix&quot;
 68:       className=&quot;gap-half&quot;
 69:       style={{
 70:         display: &apos;grid&apos;,
 71:         gridTemplateColumns: `80px repeat(${n}, 1fr)`,
 72:         gridTemplateRows: `32px repeat(${n}, 1fr)`,
 73:         width: &apos;100%&apos;,
 74:         aspectRatio: `${cols} / ${cols}`,
 75:       }}
 76:     &gt;
 77:       {/* Top-left empty corner */}
 78:       &lt;div role=&quot;cell&quot; /&gt;
 79: 
 80:       {/* Column headers */}
 81:       {metrics.map((m) =&gt; (
 82:         &lt;div
 83:           key={`col-${m}`}
 84:           role=&quot;columnheader&quot;
 85:           className=&quot;text-secondary text-xs font-semibold&quot;
 86:           style={{
 87:             display: &apos;flex&apos;,
 88:             alignItems: &apos;center&apos;,
 89:             justifyContent: &apos;center&apos;,
 90:             overflow: &apos;hidden&apos;,
 91:             textOverflow: &apos;ellipsis&apos;,
 92:             whiteSpace: &apos;nowrap&apos;,
 93:           }}
 94:         &gt;
 95:           {shortName(m)}
 96:         &lt;/div&gt;
 97:       ))}
 98: 
 99:       {/* Rows */}
100:       {metrics.map((rowMetric, ri) =&gt; (
101:         &lt;div key={`row-${rowMetric}`} role=&quot;presentation&quot; style={{ display: &apos;contents&apos; }}&gt;
102:           {/* Row header */}
103:           &lt;div
104:             role=&quot;rowheader&quot;
105:             className=&quot;text-secondary text-xs font-semibold&quot;
106:             style={{
107:               display: &apos;flex&apos;,
108:               alignItems: &apos;center&apos;,
109:               justifyContent: &apos;flex-end&apos;,
110:               paddingRight: 8,
111:               overflow: &apos;hidden&apos;,
112:               textOverflow: &apos;ellipsis&apos;,
113:               whiteSpace: &apos;nowrap&apos;,
114:             }}
115:           &gt;
116:             {shortName(rowMetric)}
117:           &lt;/div&gt;
118: 
119:           {/* Data cells */}
120:           {metrics.map((colMetric, ci) =&gt; {
121:             const isDiag = ri === ci;
122:             const corr = isDiag ? undefined : lookupCorrelation(correlations, rowMetric, colMetric);
123:             const value = isDiag ? 1 : corr?.pearsonR ?? 0;
124:             const isToxic = corr?.isKnownToxicCombo ?? false;
125:             const bg = isDiag ? &apos;var(--bg-secondary, #2a2a2a)&apos; : colorScale(value);
126: 
127:             const tooltip = isDiag
128:               ? `${rowMetric}: diagonal (1.00)`
129:               : corr
130:                 ? `${corr.metricA} vs ${corr.metricB}\npearsonR: ${corr.pearsonR.toFixed(3)}\nlagHours: ${corr.lagHours}\npValue: ${corr.pValue?.toFixed(4) ?? &apos;N/A&apos;}\nsignificant: ${corr.significant}`
131:                 : `${rowMetric} vs ${colMetric}: no data`;
132: 
133:             return (
134:               &lt;div
135:                 key={`${ri}-${ci}`}
136:                 role=&quot;cell&quot;
137:                 aria-label={`${rowMetric} vs ${colMetric}: ${value.toFixed(2)}`}
138:                 title={tooltip}
139:                 onClick={!isDiag &amp;&amp; onCellClick ? () =&gt; onCellClick(rowMetric, colMetric) : undefined}
140:                 className=&quot;mono-xs&quot;
141:                 style={{
142:                   cursor: !isDiag &amp;&amp; onCellClick ? &apos;pointer&apos; : &apos;default&apos;,
143:                   display: &apos;flex&apos;,
144:                   alignItems: &apos;center&apos;,
145:                   justifyContent: &apos;center&apos;,
146:                   backgroundColor: bg,
147:                   color: isDiag ? &apos;var(--text-secondary)&apos; : contrastText(value),
148:                   fontWeight: 500,
149:                   borderRadius: 2,
150:                   border: isToxic ? &apos;2px solid #f04438&apos; : &apos;none&apos;,
151:                   animation: isToxic ? &apos;toxicPulse 2s ease-in-out infinite&apos; : undefined,
152:                   minHeight: 36,
153:                 }}
154:               &gt;
155:                 {value.toFixed(2)}
156:               &lt;/div&gt;
157:             );
158:           })}
159:         &lt;/div&gt;
160:       ))}
161: 
162:     &lt;/div&gt;
163:   );
164: }</file><file path="src/components/EvaluationEventOverlay.tsx"> 1: import { Link } from &apos;wouter&apos;;
 2: import { ScoreBadge } from &apos;./ScoreBadge.js&apos;;
 3: import type { EvaluationResult } from &apos;../types.js&apos;;
 4: 
 5: interface EvaluationEventOverlayProps {
 6:   evaluations: EvaluationResult[];
 7:   traceId?: string;
 8: }
 9: 
10: export function EvaluationEventOverlay({ evaluations, traceId }: EvaluationEventOverlayProps) {
11:   if (evaluations.length === 0) return null;
12: 
13:   const byName = new Map&lt;string, EvaluationResult[]&gt;();
14:   for (const ev of evaluations) {
15:     const name = ev.evaluationName;
16:     if (!byName.has(name)) byName.set(name, []);
17:     byName.get(name)!.push(ev);
18:   }
19: 
20:   return (
21:     &lt;div className=&quot;gap-2&quot; style={{ display: &apos;flex&apos;, flexWrap: &apos;wrap&apos; }}&gt;
22:       {[...byName.entries()].map(([name, evs]) =&gt; {
23:         const avg = evs.reduce((s, e) =&gt; s + (e.scoreValue ?? 0), 0) / evs.length;
24:         const card = (
25:           &lt;div style={{
26:             padding: &apos;4px 8px&apos;, borderRadius: 6,
27:             background: &apos;var(--bg-elevated)&apos;,
28:             border: &apos;1px solid var(--border)&apos;,
29:             ...(traceId ? { cursor: &apos;pointer&apos;, transition: &apos;border-color 0.15s&apos; } : {}),
30:           }}
31:           className={traceId ? &apos;flex-center eval-summary-card gap-1-5&apos; : &apos;flex-center gap-1-5&apos;}
32:           &gt;
33:             &lt;span style={{ fontSize: 12 }}&gt;{name}&lt;/span&gt;
34:             &lt;ScoreBadge score={avg} metricName={name} label={avg.toFixed(2)} /&gt;
35:             &lt;span className=&quot;text-muted text-2xs&quot;&gt;({evs.length})&lt;/span&gt;
36:           &lt;/div&gt;
37:         );
38: 
39:         if (traceId) {
40:           return (
41:             &lt;Link
42:               key={name}
43:               href={`/evaluations/trace/${traceId}?metric=${encodeURIComponent(name)}`}
44:               style={{ textDecoration: &apos;none&apos;, color: &apos;inherit&apos; }}
45:             &gt;
46:               {card}
47:             &lt;/Link&gt;
48:           );
49:         }
50: 
51:         return &lt;div key={name}&gt;{card}&lt;/div&gt;;
52:       })}
53:     &lt;/div&gt;
54:   );
55: }</file><file path="src/components/EvaluationTable.tsx">  1: import { useState, Fragment } from &apos;react&apos;;
  2: import type { EvaluationResult } from &apos;../types.js&apos;;
  3: import {
  4:   createColumnHelper,
  5:   useReactTable,
  6:   getCoreRowModel,
  7:   getSortedRowModel,
  8:   getFilteredRowModel,
  9:   getExpandedRowModel,
 10:   flexRender,
 11:   type SortingState,
 12:   type ColumnFiltersState,
 13:   type ExpandedState,
 14:   type SortingFn,
 15:   type FilterFn,
 16: } from &apos;@tanstack/react-table&apos;;
 17: import {
 18:   labelToOrdinal,
 19:   ordinalToCategory,
 20:   truncateText,
 21:   formatTimestamp,
 22:   type LabelFilterCategory,
 23: } from &apos;../lib/quality-utils.js&apos;;
 24: import { EvaluationExpandedRow, chipBaseStyle } from &apos;./EvaluationExpandedRow.js&apos;;
 25: import { ScoreBadge } from &apos;./ScoreBadge.js&apos;;
 26: 
 27: export interface EvalRow {
 28:   score: number;
 29:   explanation?: string;
 30:   traceId?: string;
 31:   timestamp?: string;
 32:   evaluator?: string;
 33:   label?: string;
 34:   evaluatorType?: string;
 35:   spanId?: string;
 36:   sessionId?: string;
 37:   agentName?: string;
 38:   trajectoryLength?: number;
 39:   stepScores?: Array&lt;{ step: string | number; score: number; explanation?: string }&gt;;
 40:   toolVerifications?: Array&lt;{ toolName: string; toolCorrect: boolean; argsCorrect: boolean; score: number }&gt;;
 41: }
 42: 
 43: const CATEGORY_COLORS: Record&lt;LabelFilterCategory, string&gt; = {
 44:   Pass: &apos;#26d97f&apos;,
 45:   Review: &apos;#e5a00d&apos;,
 46:   Fail: &apos;#f04438&apos;,
 47: };
 48: 
 49: const labelSortFn: SortingFn&lt;EvalRow&gt; = (rowA, rowB) =&gt; {
 50:   const a = labelToOrdinal(rowA.original.label ?? &apos;unknown&apos;).ordinal;
 51:   const b = labelToOrdinal(rowB.original.label ?? &apos;unknown&apos;).ordinal;
 52:   return a - b;
 53: };
 54: 
 55: const categoryFilterFn: FilterFn&lt;EvalRow&gt; = (row, _id, filterValue: LabelFilterCategory[]) =&gt; {
 56:   if (!filterValue || filterValue.length === 0) return true;
 57:   const category = ordinalToCategory(labelToOrdinal(row.original.label ?? &apos;unknown&apos;).ordinal);
 58:   return filterValue.includes(category);
 59: };
 60: 
 61: const columnHelper = createColumnHelper&lt;EvalRow&gt;();
 62: 
 63: const columns = [
 64:   columnHelper.display({
 65:     id: &apos;expand&apos;,
 66:     header: &apos;&apos;,
 67:     cell: ({ row }) =&gt; (
 68:       &lt;button
 69:         type=&quot;button&quot;
 70:         className=&quot;text-secondary text-xs&quot;
 71:         onClick={row.getToggleExpandedHandler()}
 72:         aria-label={row.getIsExpanded() ? &apos;Collapse row&apos; : &apos;Expand row&apos;}
 73:         style={{
 74:           background: &apos;none&apos;,
 75:           border: &apos;none&apos;,
 76:           cursor: &apos;pointer&apos;,
 77:           padding: &apos;2px 6px&apos;,
 78:           transition: &apos;transform 0.15s&apos;,
 79:           transform: row.getIsExpanded() ? &apos;rotate(90deg)&apos; : &apos;rotate(0deg)&apos;,
 80:         }}
 81:       &gt;
 82:         &amp;#9654;
 83:       &lt;/button&gt;
 84:     ),
 85:     size: 32,
 86:   }),
 87:   columnHelper.accessor(&apos;score&apos;, {
 88:     header: &apos;Score&apos;,
 89:     cell: (info) =&gt; {
 90:       const row = info.row.original;
 91:       return (
 92:         &lt;ScoreBadge
 93:           score={info.getValue()}
 94:           metricName=&quot;score&quot;
 95:           label={info.getValue().toFixed(4)}
 96:           evaluator={row.evaluator}
 97:           evaluatorType={row.evaluatorType}
 98:           explanation={row.explanation}
 99:           traceId={row.traceId}
100:         /&gt;
101:       );
102:     },
103:     sortingFn: &apos;basic&apos;,
104:   }),
105:   columnHelper.accessor(&apos;label&apos;, {
106:     header: &apos;Label&apos;,
107:     cell: (info) =&gt; {
108:       const label = info.getValue() ?? &apos;unknown&apos;;
109:       const { category } = labelToOrdinal(label);
110:       return (
111:         &lt;span
112:           className=&quot;mono-xs chip&quot;
113:           style={{
114:             ...chipBaseStyle,
115:             fontWeight: 500,
116:             backgroundColor: `${CATEGORY_COLORS[category]}20`,
117:             color: CATEGORY_COLORS[category],
118:           }}
119:         &gt;
120:           {label}
121:         &lt;/span&gt;
122:       );
123:     },
124:     sortingFn: labelSortFn,
125:     filterFn: categoryFilterFn,
126:   }),
127:   columnHelper.display({
128:     id: &apos;category&apos;,
129:     header: &apos;Category&apos;,
130:     cell: (info) =&gt; {
131:       const label = info.row.original.label ?? &apos;unknown&apos;;
132:       const category = ordinalToCategory(labelToOrdinal(label).ordinal);
133:       return (
134:         &lt;span
135:           className=&quot;mono-xs chip font-semibold&quot;
136:           style={{
137:             ...chipBaseStyle,
138:             backgroundColor: `${CATEGORY_COLORS[category]}20`,
139:             color: CATEGORY_COLORS[category],
140:           }}
141:         &gt;
142:           {category}
143:         &lt;/span&gt;
144:       );
145:     },
146:   }),
147:   columnHelper.accessor(&apos;explanation&apos;, {
148:     header: &apos;Explanation&apos;,
149:     cell: (info) =&gt; {
150:       const text = info.getValue() ?? &apos;-&apos;;
151:       return (
152:         &lt;span className=&quot;explanation&quot; title={text}&gt;
153:           {truncateText(text, 60)}
154:         &lt;/span&gt;
155:       );
156:     },
157:     enableSorting: false,
158:   }),
159:   columnHelper.accessor(&apos;evaluator&apos;, {
160:     header: &apos;Evaluator&apos;,
161:     cell: (info) =&gt; (
162:       &lt;span className=&quot;mono-xs&quot;&gt;
163:         {info.getValue() ?? &apos;-&apos;}
164:       &lt;/span&gt;
165:     ),
166:     enableSorting: false,
167:   }),
168:   columnHelper.accessor(&apos;timestamp&apos;, {
169:     header: &apos;Timestamp&apos;,
170:     cell: (info) =&gt; {
171:       const ts = info.getValue();
172:       if (!ts) return &apos;-&apos;;
173:       return (
174:         &lt;span title={new Date(ts).toLocaleString()}&gt;
175:           {formatTimestamp(ts)}
176:         &lt;/span&gt;
177:       );
178:     },
179:     sortingFn: &apos;datetime&apos;,
180:   }),
181: ];
182: 
183: export function evalToRow(e: EvaluationResult): EvalRow {
184:   return {
185:     score: typeof e.scoreValue === &apos;number&apos; ? e.scoreValue : 0,
186:     explanation: e.explanation,
187:     traceId: e.traceId,
188:     timestamp: e.timestamp,
189:     evaluator: e.evaluator,
190:     label: e.scoreLabel,
191:     evaluatorType: e.evaluatorType,
192:     spanId: e.spanId,
193:     sessionId: e.sessionId,
194:     agentName: e.agentName,
195:     trajectoryLength: e.trajectoryLength,
196:     stepScores: e.stepScores as EvalRow[&apos;stepScores&apos;],
197:     toolVerifications: e.toolVerifications as EvalRow[&apos;toolVerifications&apos;],
198:   };
199: }
200: 
201: export function EvaluationTable({ evaluations }: { evaluations: EvalRow[] }) {
202:   const [sorting, setSorting] = useState&lt;SortingState&gt;([]);
203:   const [columnFilters, setColumnFilters] = useState&lt;ColumnFiltersState&gt;([]);
204:   const [activeCategories, setActiveCategories] = useState&lt;LabelFilterCategory[]&gt;([]);
205:   const [expanded, setExpanded] = useState&lt;ExpandedState&gt;({});
206: 
207:   const table = useReactTable({
208:     data: evaluations,
209:     columns,
210:     state: { sorting, columnFilters, expanded },
211:     onSortingChange: setSorting,
212:     onColumnFiltersChange: setColumnFilters,
213:     onExpandedChange: setExpanded,
214:     getRowCanExpand: () =&gt; true,
215:     getCoreRowModel: getCoreRowModel(),
216:     getSortedRowModel: getSortedRowModel(),
217:     getFilteredRowModel: getFilteredRowModel(),
218:     getExpandedRowModel: getExpandedRowModel(),
219:   });
220: 
221:   const toggleCategory = (cat: LabelFilterCategory) =&gt; {
222:     const next = activeCategories.includes(cat)
223:       ? activeCategories.filter((c) =&gt; c !== cat)
224:       : [...activeCategories, cat];
225:     setActiveCategories(next);
226:     setColumnFilters(
227:       next.length &gt; 0 ? [{ id: &apos;label&apos;, value: next }] : [],
228:     );
229:   };
230: 
231:   const sortDir = (colId: string): &apos;ascending&apos; | &apos;descending&apos; | &apos;none&apos; =&gt; {
232:     const s = sorting.find((entry) =&gt; entry.id === colId);
233:     if (!s) return &apos;none&apos;;
234:     return s.desc ? &apos;descending&apos; : &apos;ascending&apos;;
235:   };
236: 
237:   return (
238:     &lt;div&gt;
239:       &lt;div className=&quot;mb-3 gap-1-5&quot; style={{ display: &apos;flex&apos; }}&gt;
240:         {([&apos;Pass&apos;, &apos;Review&apos;, &apos;Fail&apos;] as const).map((cat) =&gt; {
241:           const active = activeCategories.includes(cat);
242:           return (
243:             &lt;button
244:               key={cat}
245:               type=&quot;button&quot;
246:               onClick={() =&gt; toggleCategory(cat)}
247:               className=&quot;text-xs font-semibold&quot;
248:               style={{
249:                 padding: &apos;4px 12px&apos;,
250:                 borderRadius: 6,
251:                 border: `1px solid ${CATEGORY_COLORS[cat]}`,
252:                 backgroundColor: active ? `${CATEGORY_COLORS[cat]}30` : &apos;transparent&apos;,
253:                 color: CATEGORY_COLORS[cat],
254:                 cursor: &apos;pointer&apos;,
255:                 opacity: active ? 1 : 0.6,
256:                 transition: &apos;opacity 0.15s, background-color 0.15s&apos;,
257:               }}
258:             &gt;
259:               {cat}
260:             &lt;/button&gt;
261:           );
262:         })}
263:       &lt;/div&gt;
264:       &lt;table className=&quot;eval-table&quot;&gt;
265:         &lt;thead&gt;
266:           {table.getHeaderGroups().map((hg) =&gt; (
267:             &lt;tr key={hg.id}&gt;
268:               {hg.headers.map((header) =&gt; {
269:                 const canSort = header.column.getCanSort();
270:                 return (
271:                   &lt;th
272:                     key={header.id}
273:                     onClick={canSort ? header.column.getToggleSortingHandler() : undefined}
274:                     style={{ cursor: canSort ? &apos;pointer&apos; : &apos;default&apos;, userSelect: &apos;none&apos; }}
275:                     aria-sort={canSort ? sortDir(header.id) : undefined}
276:                   &gt;
277:                     {flexRender(header.column.columnDef.header, header.getContext())}
278:                     {canSort &amp;&amp; (
279:                       &lt;span style={{ marginLeft: 4, fontSize: &apos;var(--font-size-2xs)&apos; }}&gt;
280:                         {{ asc: &apos; ^&apos;, desc: &apos; v&apos; }[header.column.getIsSorted() as string] ?? &apos;&apos;}
281:                       &lt;/span&gt;
282:                     )}
283:                   &lt;/th&gt;
284:                 );
285:               })}
286:             &lt;/tr&gt;
287:           ))}
288:         &lt;/thead&gt;
289:         &lt;tbody&gt;
290:           {table.getRowModel().rows.map((row) =&gt; (
291:             &lt;Fragment key={row.id}&gt;
292:               &lt;tr className={row.getIsExpanded() ? &apos;eval-row-expanded&apos; : &apos;&apos;}&gt;
293:                 {row.getVisibleCells().map((cell) =&gt; (
294:                   &lt;td key={cell.id}&gt;
295:                     {flexRender(cell.column.columnDef.cell, cell.getContext())}
296:                   &lt;/td&gt;
297:                 ))}
298:               &lt;/tr&gt;
299:               {row.getIsExpanded() &amp;&amp; (
300:                 &lt;tr className=&quot;eval-expanded-panel&quot;&gt;
301:                   &lt;td colSpan={row.getVisibleCells().length}&gt;
302:                     &lt;EvaluationExpandedRow row={row.original} /&gt;
303:                   &lt;/td&gt;
304:                 &lt;/tr&gt;
305:               )}
306:             &lt;/Fragment&gt;
307:           ))}
308:           {table.getRowModel().rows.length === 0 &amp;&amp; (
309:             &lt;tr&gt;
310:               &lt;td colSpan={table.getVisibleLeafColumns().length} className=&quot;text-muted&quot; style={{ textAlign: &apos;center&apos;, padding: 16 }}&gt;
311:                 No evaluations match the current filter.
312:               &lt;/td&gt;
313:             &lt;/tr&gt;
314:           )}
315:         &lt;/tbody&gt;
316:       &lt;/table&gt;
317:     &lt;/div&gt;
318:   );
319: }</file><file path="src/components/HealthOverview.tsx">  1: import type { QualityDashboardSummary } from &apos;../types.js&apos;;
  2: import { StatusBadge } from &apos;./Indicators.js&apos;;
  3: import { formatTimestamp } from &apos;../lib/quality-utils.js&apos;;
  4: 
  5: interface PipelineHealth {
  6:   evalVolume: number;
  7:   lastEvalAge: string | null;
  8:   evalRate: string;
  9: }
 10: 
 11: function computePipelineHealth(dashboard: QualityDashboardSummary): PipelineHealth {
 12:   let totalSamples = 0;
 13:   let latestTs: string | null = null;
 14: 
 15:   for (const m of dashboard.metrics) {
 16:     totalSamples += m.sampleCount;
 17:   }
 18: 
 19:   // Find most recent evaluation timestamp from worst explanations
 20:   for (const m of dashboard.metrics) {
 21:     const worst = (m as QualityDashboardSummary[&apos;metrics&apos;][number] &amp; { worstExplanation?: { timestamp?: string } }).worstExplanation;
 22:     if (worst?.timestamp) {
 23:       if (!latestTs || worst.timestamp &gt; latestTs) latestTs = worst.timestamp;
 24:     }
 25:   }
 26: 
 27:   const lastEvalAge = latestTs ? formatTimestamp(latestTs) : null;
 28: 
 29:   // Compute rate based on period
 30:   const period = dashboard.metrics[0]?.period;
 31:   let periodHours = 168; // default 7d
 32:   if (period) {
 33:     const diffMs = new Date(period.end).getTime() - new Date(period.start).getTime();
 34:     periodHours = Math.max(1, diffMs / (60 * 60 * 1000));
 35:   }
 36:   const perHour = totalSamples / periodHours;
 37:   const evalRate = perHour &gt;= 100 ? `${(perHour / 1000).toFixed(1)}k/hr`
 38:     : perHour &gt;= 1 ? `${perHour.toFixed(0)}/hr`
 39:     : `${(perHour * 24).toFixed(1)}/day`;
 40: 
 41:   return { evalVolume: totalSamples, lastEvalAge, evalRate };
 42: }
 43: 
 44: function formatVolume(n: number): string {
 45:   if (n &gt;= 10000) return `${(n / 1000).toFixed(1)}k`;
 46:   if (n &gt;= 1000) return `${(n / 1000).toFixed(1)}k`;
 47:   return String(n);
 48: }
 49: 
 50: export function HealthOverview({ dashboard }: { dashboard: QualityDashboardSummary }) {
 51:   const { overallStatus, summary } = dashboard;
 52:   const pipeline = computePipelineHealth(dashboard);
 53: 
 54:   return (
 55:     &lt;div className={`health-banner ${overallStatus}`}&gt;
 56:       &lt;div&gt;
 57:         &lt;div className=&quot;flex-center gap-3&quot;&gt;
 58:           &lt;StatusBadge status={overallStatus} /&gt;
 59:           &lt;span className=&quot;text-base&quot;&gt;
 60:             {overallStatus === &apos;healthy&apos; &amp;&amp; &apos;All metrics within thresholds&apos;}
 61:             {overallStatus === &apos;warning&apos; &amp;&amp; &apos;Some metrics need attention&apos;}
 62:             {overallStatus === &apos;critical&apos; &amp;&amp; &apos;Critical issues detected&apos;}
 63:             {overallStatus === &apos;no_data&apos; &amp;&amp; &apos;No evaluation data available&apos;}
 64:           &lt;/span&gt;
 65:         &lt;/div&gt;
 66:         &lt;div className=&quot;pipeline-stats&quot;&gt;
 67:           &lt;div className=&quot;pipeline-stat&quot;&gt;
 68:             Eval Volume: &lt;span className=&quot;stat-value&quot;&gt;{formatVolume(pipeline.evalVolume)}&lt;/span&gt;
 69:           &lt;/div&gt;
 70:           &lt;div className=&quot;pipeline-stat&quot;&gt;
 71:             Rate: &lt;span className=&quot;stat-value&quot;&gt;{pipeline.evalRate}&lt;/span&gt;
 72:           &lt;/div&gt;
 73:           {pipeline.lastEvalAge &amp;&amp; (
 74:             &lt;div className=&quot;pipeline-stat&quot;&gt;
 75:               Last Eval: &lt;span className=&quot;stat-value&quot;&gt;{pipeline.lastEvalAge}&lt;/span&gt;
 76:             &lt;/div&gt;
 77:           )}
 78:         &lt;/div&gt;
 79:       &lt;/div&gt;
 80:       &lt;div className=&quot;summary-counts&quot;&gt;
 81:         &lt;div className=&quot;summary-count&quot;&gt;
 82:           &lt;div className=&quot;value&quot;&gt;{summary.totalMetrics}&lt;/div&gt;
 83:           &lt;div className=&quot;label text-secondary text-xs&quot;&gt;Total&lt;/div&gt;
 84:         &lt;/div&gt;
 85:         &lt;div className=&quot;summary-count&quot;&gt;
 86:           &lt;div className=&quot;value&quot; style={{ color: &apos;var(--status-healthy)&apos; }}&gt;{summary.healthyMetrics}&lt;/div&gt;
 87:           &lt;div className=&quot;label text-secondary text-xs&quot;&gt;Healthy&lt;/div&gt;
 88:         &lt;/div&gt;
 89:         &lt;div className=&quot;summary-count&quot;&gt;
 90:           &lt;div className=&quot;value&quot; style={{ color: &apos;var(--status-warning)&apos; }}&gt;{summary.warningMetrics}&lt;/div&gt;
 91:           &lt;div className=&quot;label text-secondary text-xs&quot;&gt;Warning&lt;/div&gt;
 92:         &lt;/div&gt;
 93:         &lt;div className=&quot;summary-count&quot;&gt;
 94:           &lt;div className=&quot;value&quot; style={{ color: &apos;var(--status-critical)&apos; }}&gt;{summary.criticalMetrics}&lt;/div&gt;
 95:           &lt;div className=&quot;label text-secondary text-xs&quot;&gt;Critical&lt;/div&gt;
 96:         &lt;/div&gt;
 97:       &lt;/div&gt;
 98:     &lt;/div&gt;
 99:   );
100: }</file><file path="src/components/MetricCompare.tsx"> 1: import { useState } from &apos;react&apos;;
 2: import { TrendChart } from &apos;./TrendChart.js&apos;;
 3: import { useMetricDetail } from &apos;../hooks/useMetricDetail.js&apos;;
 4: import { useTrend } from &apos;../hooks/useTrend.js&apos;;
 5: import type { Period, MetricDynamics } from &apos;../types.js&apos;;
 6: 
 7: interface MetricCompareProps {
 8:   metricName?: string;
 9:   period: Period;
10:   availableMetrics: string[];
11:   onMetricChange: (name: string) =&gt; void;
12: }
13: 
14: export function MetricCompare({ metricName, period, availableMetrics, onMetricChange }: MetricCompareProps) {
15:   const { data: detail } = useMetricDetail(metricName, period);
16:   const { data: trend } = useTrend(metricName ?? &apos;&apos;, period, 10);
17: 
18:   if (!metricName) {
19:     return (
20:       &lt;div className=&quot;text-muted&quot; style={{ padding: 24, textAlign: &apos;center&apos; }}&gt;
21:         Select a metric from the heatmap or dropdown
22:       &lt;/div&gt;
23:     );
24:   }
25: 
26:   return (
27:     &lt;div style={{ padding: 12 }}&gt;
28:       &lt;select
29:         value={metricName}
30:         onChange={(e) =&gt; onMetricChange(e.target.value)}
31:         className=&quot;mb-3&quot;
32:         style={{
33:           padding: &apos;4px 8px&apos;,
34:           background: &apos;var(--bg-elevated)&apos;,
35:           border: &apos;1px solid var(--border)&apos;,
36:           borderRadius: 4,
37:           color: &apos;var(--text-primary)&apos;,
38:           fontSize: 12,
39:         }}
40:       &gt;
41:         {availableMetrics.map(m =&gt; &lt;option key={m} value={m}&gt;{m}&lt;/option&gt;)}
42:       &lt;/select&gt;
43: 
44:       {detail &amp;&amp; (
45:         &lt;div className=&quot;mb-3 gap-4&quot; style={{ display: &apos;flex&apos;, flexWrap: &apos;wrap&apos; }}&gt;
46:           {([&apos;avg&apos;, &apos;p50&apos;, &apos;p95&apos;] as const).map(key =&gt; (
47:             &lt;div key={key} style={{ textAlign: &apos;center&apos; }}&gt;
48:               &lt;div className=&quot;mono text-md font-semibold&quot;&gt;
49:                 {detail.values[key]?.toFixed(4) ?? &apos;N/A&apos;}
50:               &lt;/div&gt;
51:               &lt;div className=&quot;field-label text-secondary text-xs&quot;&gt;{key}&lt;/div&gt;
52:             &lt;/div&gt;
53:           ))}
54:         &lt;/div&gt;
55:       )}
56: 
57:       {detail &amp;&amp; (
58:         &lt;TrendChart
59:           trend={detail.trend}
60:           dynamics={(detail as typeof detail &amp; { dynamics?: MetricDynamics }).dynamics}
61:           metricName={metricName}
62:         /&gt;
63:       )}
64:     &lt;/div&gt;
65:   );
66: }</file><file path="src/hooks/useTrace.ts"> 1: import { useQuery } from &apos;@tanstack/react-query&apos;;
 2: import type { EvaluationResult } from &apos;../types.js&apos;;
 3: import { API_BASE, STALE_TIME } from &apos;../lib/constants.js&apos;;
 4: 
 5: interface TraceSpanResponse {
 6:   traceId: string;
 7:   spanId: string;
 8:   name: string;
 9:   kind?: string;
10:   durationMs?: number;
11:   status?: { code: number; message?: string };
12:   attributes?: Record&lt;string, unknown&gt;;
13: }
14: 
15: interface TraceResponse {
16:   traceId: string;
17:   spans: TraceSpanResponse[];
18:   evaluations: EvaluationResult[];
19: }
20: 
21: export function useTrace(traceId: string | undefined) {
22:   return useQuery&lt;TraceResponse&gt;({
23:     queryKey: [&apos;trace&apos;, traceId],
24:     queryFn: async () =&gt; {
25:       const res = await fetch(`${API_BASE}/api/traces/${encodeURIComponent(traceId!)}`);
26:       if (!res.ok) {
27:         // Worker returns 404 with JSON body when trace not in KV — return empty data
28:         if (res.status === 404) return { traceId: traceId!, spans: [], evaluations: [] };
29:         throw new Error(`API error: ${res.status}`);
30:       }
31:       return res.json();
32:     },
33:     enabled: !!traceId,
34:     staleTime: STALE_TIME.DETAIL,
35:     retry: 2,
36:   });
37: }</file><file path="src/hooks/useTraceEvaluations.ts"> 1: import { useQuery } from &apos;@tanstack/react-query&apos;;
 2: import type { EvaluationResult } from &apos;../types.js&apos;;
 3: import { API_BASE, STALE_TIME } from &apos;../lib/constants.js&apos;;
 4: 
 5: export function useTraceEvaluations(traceId: string | undefined) {
 6:   return useQuery&lt;EvaluationResult[]&gt;({
 7:     queryKey: [&apos;trace-evaluations&apos;, traceId],
 8:     queryFn: async () =&gt; {
 9:       const res = await fetch(`${API_BASE}/api/evaluations/trace/${encodeURIComponent(traceId!)}`);
10:       if (!res.ok) throw new Error(`API error: ${res.status}`);
11:       // Worker returns 200 with { evaluations: [] } when key not in KV (not yet synced)
12:       const data = await res.json();
13:       return (data.evaluations ?? []) as EvaluationResult[];
14:     },
15:     enabled: !!traceId,
16:     staleTime: STALE_TIME.DEFAULT,
17:     retry: 2,
18:   });
19: }</file><file path="src/pages/CorrelationsPage.tsx"> 1: import { useState, useCallback } from &apos;react&apos;;
 2: import { useQuery } from &apos;@tanstack/react-query&apos;;
 3: import { CorrelationHeatmap } from &apos;../components/CorrelationHeatmap.js&apos;;
 4: import { SplitPane } from &apos;../components/SplitPane.js&apos;;
 5: import { MetricCompare } from &apos;../components/MetricCompare.js&apos;;
 6: import { PageShell } from &apos;../components/PageShell.js&apos;;
 7: import { API_BASE } from &apos;../lib/constants.js&apos;;
 8: import type { CorrelationFeature, Period } from &apos;../types.js&apos;;
 9: 
10: interface CorrelationsResponse {
11:   correlations: CorrelationFeature[];
12:   metrics: string[];
13: }
14: 
15: export function CorrelationsPage({ period = &apos;30d&apos; }: { period?: Period }) {
16:   const { data, isLoading, error } = useQuery&lt;CorrelationsResponse&gt;({
17:     queryKey: [&apos;correlations&apos;, period],
18:     queryFn: async () =&gt; {
19:       const res = await fetch(`${API_BASE}/api/correlations?period=${period}`);
20:       if (!res.ok) throw new Error(`API error: ${res.status}`);
21:       return res.json();
22:     },
23:     staleTime: 60_000,
24:     retry: 2,
25:   });
26: 
27:   const [leftMetric, setLeftMetric] = useState&lt;string | undefined&gt;();
28:   const [rightMetric, setRightMetric] = useState&lt;string | undefined&gt;();
29: 
30:   const handleCellClick = useCallback((row: string, col: string) =&gt; {
31:     setLeftMetric(row);
32:     setRightMetric(col);
33:   }, []);
34: 
35:   return (
36:     &lt;PageShell isLoading={isLoading} error={error} skeletonHeight={400}&gt;
37:       {data &amp;&amp; (
38:         &lt;&gt;
39:           &lt;h2 className=&quot;text-lg mb-3&quot;&gt;Metric Correlations&lt;/h2&gt;
40:           &lt;div className=&quot;card&quot;&gt;
41:             &lt;CorrelationHeatmap
42:               correlations={data.correlations}
43:               metrics={data.metrics}
44:               onCellClick={handleCellClick}
45:             /&gt;
46:           &lt;/div&gt;
47: 
48:           {(leftMetric || rightMetric) &amp;&amp; (
49:             &lt;div className=&quot;view-section&quot;&gt;
50:               &lt;h3 className=&quot;section-heading&quot;&gt;Compare Metrics&lt;/h3&gt;
51:               &lt;div className=&quot;card&quot;&gt;
52:                 &lt;SplitPane
53:                   left={
54:                     &lt;MetricCompare
55:                       metricName={leftMetric}
56:                       period={period}
57:                       availableMetrics={data.metrics}
58:                       onMetricChange={setLeftMetric}
59:                     /&gt;
60:                   }
61:                   right={
62:                     &lt;MetricCompare
63:                       metricName={rightMetric}
64:                       period={period}
65:                       availableMetrics={data.metrics}
66:                       onMetricChange={setRightMetric}
67:                     /&gt;
68:                   }
69:                 /&gt;
70:               &lt;/div&gt;
71:             &lt;/div&gt;
72:           )}
73:         &lt;/&gt;
74:       )}
75:     &lt;/PageShell&gt;
76:   );
77: }</file><file path="src/pages/CoveragePage.tsx"> 1: import { useState } from &apos;react&apos;;
 2: import { CoverageGrid } from &apos;../components/CoverageGrid.js&apos;;
 3: import { useCoverage } from &apos;../hooks/useCoverage.js&apos;;
 4: import { PageShell } from &apos;../components/PageShell.js&apos;;
 5: import { DEFAULT_INPUT_KEY, type InputKey } from &apos;../lib/constants.js&apos;;
 6: import type { Period } from &apos;../types.js&apos;;
 7: 
 8: export function CoveragePage({ period }: { period: Period }) {
 9:   const [inputKey, setInputKey] = useState&lt;InputKey&gt;(DEFAULT_INPUT_KEY);
10:   const { data, isLoading, error } = useCoverage(period, inputKey);
11: 
12:   return (
13:     &lt;PageShell isLoading={isLoading} error={error} skeletonHeight={400}&gt;
14:       {data &amp;&amp; (
15:         &lt;&gt;
16:           &lt;div className=&quot;flex-center mb-3 gap-4&quot;&gt;
17:             &lt;h2 className=&quot;text-lg&quot; style={{ margin: 0 }}&gt;Evaluation Coverage&lt;/h2&gt;
18:             &lt;select
19:               value={inputKey}
20:               onChange={(e) =&gt; setInputKey(e.target.value as InputKey)}
21:               aria-label=&quot;Group by&quot;
22:               style={{ fontSize: 12, padding: &apos;4px 8px&apos;, borderRadius: 4, border: &apos;1px solid var(--border)&apos; }}
23:             &gt;
24:               &lt;option value=&quot;traceId&quot;&gt;By Trace&lt;/option&gt;
25:               &lt;option value=&quot;sessionId&quot;&gt;By Session&lt;/option&gt;
26:             &lt;/select&gt;
27:           &lt;/div&gt;
28:           &lt;div className=&quot;card&quot;&gt;
29:             &lt;CoverageGrid
30:               metrics={data.metrics}
31:               inputs={data.inputs}
32:               cells={data.cells}
33:               gaps={data.gaps}
34:               overallCoveragePercent={data.overallCoveragePercent}
35:             /&gt;
36:           &lt;/div&gt;
37:         &lt;/&gt;
38:       )}
39:     &lt;/PageShell&gt;
40:   );
41: }</file><file path="src/pages/PipelinePage.tsx"> 1: import { PipelineFunnel } from &apos;../components/PipelineFunnel.js&apos;;
 2: import { usePipeline } from &apos;../hooks/usePipeline.js&apos;;
 3: import { PageShell } from &apos;../components/PageShell.js&apos;;
 4: import { LLM_SAMPLE_RATE } from &apos;../lib/constants.js&apos;;
 5: import type { Period } from &apos;../types.js&apos;;
 6: 
 7: function T2SamplingStage() {
 8:   return (
 9:     &lt;div
10:       className=&quot;flex-center text-secondary text-xs gap-2-5&quot;
11:       style={{
12:         padding: &apos;10px 14px&apos;,
13:         borderRadius: 6,
14:         border: &apos;1px dashed var(--border, #2a2a3e)&apos;,
15:         background: &apos;var(--surface, #1a1a2e)&apos;,
16:         marginTop: 12,
17:       }}
18:     &gt;
19:       &lt;span style={{
20:         display: &apos;inline-flex&apos;,
21:         alignItems: &apos;center&apos;,
22:         justifyContent: &apos;center&apos;,
23:         width: 24,
24:         height: 24,
25:         borderRadius: &apos;50%&apos;,
26:         background: &apos;var(--accent, #6366f1)&apos;,
27:         color: &apos;#fff&apos;,
28:         fontSize: &apos;var(--font-size-2xs)&apos;,
29:         fontWeight: 700,
30:         flexShrink: 0,
31:       }}&gt;
32:         T2
33:       &lt;/span&gt;
34:       &lt;span&gt;
35:         &lt;strong style={{ color: &apos;var(--text-primary, #e0e0e0)&apos; }}&gt;LLM Sampling&lt;/strong&gt;
36:         {&apos; \u2014 &apos;}
37:         {LLM_SAMPLE_RATE}% sampled for LLM evaluation (relevance, coherence, faithfulness, hallucination)
38:       &lt;/span&gt;
39:     &lt;/div&gt;
40:   );
41: }
42: 
43: export function PipelinePage({ period }: { period: Period }) {
44:   const { data, isLoading, error } = usePipeline(period);
45: 
46:   return (
47:     &lt;PageShell isLoading={isLoading} error={error} skeletonHeight={300}&gt;
48:       {data &amp;&amp; (
49:         &lt;&gt;
50:           &lt;h2 className=&quot;text-lg mb-3&quot;&gt;Evaluation Pipeline&lt;/h2&gt;
51:           &lt;div className=&quot;card&quot;&gt;
52:             &lt;PipelineFunnel
53:               stages={data.stages}
54:               dropoffs={data.dropoffs}
55:               overallConversionPercent={data.overallConversionPercent}
56:             /&gt;
57:             &lt;T2SamplingStage /&gt;
58:           &lt;/div&gt;
59:         &lt;/&gt;
60:       )}
61:     &lt;/PageShell&gt;
62:   );
63: }</file><file path="src/components/EvaluationExpandedRow.tsx">  1: import type { CSSProperties } from &apos;react&apos;;
  2: import { Link } from &apos;wouter&apos;;
  3: import { scoreColorBand, SCORE_COLORS } from &apos;../lib/quality-utils.js&apos;;
  4: import { MetaItem } from &apos;./MetaItem.js&apos;;
  5: import type { EvalRow } from &apos;./EvaluationTable.js&apos;;
  6: 
  7: 
  8: export const chipBaseStyle: CSSProperties = {
  9:   display: &apos;inline-block&apos;,
 10: };
 11: 
 12: export function StepScoreChip({ step, score, explanation }: {
 13:   step: string | number;
 14:   score: number;
 15:   explanation?: string;
 16: }) {
 17:   const band = scoreColorBand(score, &apos;maximize&apos;);
 18:   const color = SCORE_COLORS[band];
 19:   return (
 20:     &lt;span
 21:       className=&quot;mono-xs chip&quot;
 22:       title={explanation ?? `Step ${step}: ${score.toFixed(2)}`}
 23:       style={{ ...chipBaseStyle, backgroundColor: `${color}20`, color }}
 24:     &gt;
 25:       {step}: {score.toFixed(2)}
 26:     &lt;/span&gt;
 27:   );
 28: }
 29: 
 30: export function ToolVerificationChip({ toolName, toolCorrect, argsCorrect, score, index }: {
 31:   toolName: string;
 32:   toolCorrect: boolean;
 33:   argsCorrect: boolean;
 34:   score: number;
 35:   index: number;
 36: }) {
 37:   const ok = toolCorrect &amp;&amp; argsCorrect;
 38:   const color = ok ? &apos;#26d97f&apos; : &apos;#f04438&apos;;
 39:   return (
 40:     &lt;span
 41:       className=&quot;mono-xs chip&quot;
 42:       title={`tool: ${toolCorrect ? &apos;correct&apos; : &apos;wrong&apos;}, args: ${argsCorrect ? &apos;correct&apos; : &apos;wrong&apos;}, score: ${score.toFixed(2)}`}
 43:       style={{ ...chipBaseStyle, backgroundColor: `${color}20`, color }}
 44:     &gt;
 45:       {toolName} {score.toFixed(2)}
 46:     &lt;/span&gt;
 47:   );
 48: }
 49: 
 50: export function EvaluationExpandedRow({ row }: { row: EvalRow }) {
 51:   const meta = [
 52:     { label: &apos;Evaluator Type&apos;, value: row.evaluatorType },
 53:     { label: &apos;Trace ID&apos;, value: row.traceId },
 54:     { label: &apos;Span ID&apos;, value: row.spanId },
 55:     { label: &apos;Session ID&apos;, value: row.sessionId },
 56:     { label: &apos;Agent&apos;, value: row.agentName },
 57:     { label: &apos;Trajectory Length&apos;, value: row.trajectoryLength },
 58:   ].filter(m =&gt; m.value != null);
 59: 
 60:   const hasDetail = row.explanation || meta.length &gt; 0 ||
 61:     (row.stepScores &amp;&amp; row.stepScores.length &gt; 0) ||
 62:     (row.toolVerifications &amp;&amp; row.toolVerifications.length &gt; 0);
 63: 
 64:   return (
 65:     &lt;div className=&quot;eval-expanded-content&quot; style={{
 66:       background: &apos;var(--bg-elevated)&apos;,
 67:       borderRadius: &apos;var(--radius)&apos;,
 68:       padding: 16,
 69:       animation: &apos;fade-in 0.15s ease-in-out&apos;,
 70:     }}&gt;
 71:       {row.explanation &amp;&amp; (
 72:         &lt;div className=&quot;mb-3&quot;&gt;
 73:           &lt;div className=&quot;section-label mb-1&quot;&gt;Explanation&lt;/div&gt;
 74:           &lt;div style={{ fontSize: 12, color: &apos;var(--text-primary)&apos;, lineHeight: 1.5 }}&gt;
 75:             {row.explanation}
 76:           &lt;/div&gt;
 77:         &lt;/div&gt;
 78:       )}
 79: 
 80:       {meta.length &gt; 0 &amp;&amp; (
 81:         &lt;div className=&quot;mb-3 gap-4&quot; style={{ display: &apos;flex&apos;, flexWrap: &apos;wrap&apos; }}&gt;
 82:           {meta.map(m =&gt; &lt;MetaItem key={m.label} label={m.label} value={m.value} /&gt;)}
 83:         &lt;/div&gt;
 84:       )}
 85: 
 86:       {row.stepScores &amp;&amp; row.stepScores.length &gt; 0 &amp;&amp; (
 87:         &lt;div className=&quot;mb-3&quot;&gt;
 88:           &lt;div className=&quot;section-label mb-1-5&quot;&gt;Step Scores&lt;/div&gt;
 89:           &lt;div className=&quot;gap-1-5&quot; style={{ display: &apos;flex&apos;, flexWrap: &apos;wrap&apos; }}&gt;
 90:             {row.stepScores.map(s =&gt; (
 91:               &lt;StepScoreChip key={`${s.step}`} step={s.step} score={s.score} explanation={s.explanation} /&gt;
 92:             ))}
 93:           &lt;/div&gt;
 94:         &lt;/div&gt;
 95:       )}
 96: 
 97:       {row.toolVerifications &amp;&amp; row.toolVerifications.length &gt; 0 &amp;&amp; (
 98:         &lt;div&gt;
 99:           &lt;div className=&quot;section-label mb-1-5&quot;&gt;Tool Verifications&lt;/div&gt;
100:           &lt;div className=&quot;gap-1-5&quot; style={{ display: &apos;flex&apos;, flexWrap: &apos;wrap&apos; }}&gt;
101:             {row.toolVerifications.map((tv, i) =&gt; (
102:               &lt;ToolVerificationChip
103:                 key={`${tv.toolName}-${i}`}
104:                 toolName={tv.toolName}
105:                 toolCorrect={tv.toolCorrect}
106:                 argsCorrect={tv.argsCorrect}
107:                 score={tv.score}
108:                 index={i}
109:               /&gt;
110:             ))}
111:           &lt;/div&gt;
112:         &lt;/div&gt;
113:       )}
114: 
115:       {(row.traceId || row.sessionId) &amp;&amp; (
116:         &lt;div className=&quot;gap-4&quot; style={{ marginTop: 12, paddingTop: 12, borderTop: &apos;1px solid var(--border)&apos;, display: &apos;flex&apos; }}&gt;
117:           {row.traceId &amp;&amp; (
118:             &lt;Link href={`/evaluations/trace/${row.traceId}`} className=&quot;back-link&quot; style={{ marginBottom: 0 }}&gt;
119:               View full evaluation detail &amp;rarr;
120:             &lt;/Link&gt;
121:           )}
122:           {row.sessionId ? (
123:             &lt;Link href={`/sessions/${row.sessionId}`} className=&quot;back-link&quot; style={{ marginBottom: 0 }}&gt;
124:               View trace spans &amp;rarr;
125:             &lt;/Link&gt;
126:           ) : row.traceId ? (
127:             &lt;Link href={`/traces/${row.traceId}`} className=&quot;back-link&quot; style={{ marginBottom: 0 }}&gt;
128:               View trace spans &amp;rarr;
129:             &lt;/Link&gt;
130:           ) : null}
131:         &lt;/div&gt;
132:       )}
133: 
134:       {!hasDetail &amp;&amp; !row.traceId &amp;&amp; !row.sessionId &amp;&amp; (
135:         &lt;div className=&quot;text-muted text-xs&quot;&gt;
136:           No additional detail available.
137:         &lt;/div&gt;
138:       )}
139:     &lt;/div&gt;
140:   );
141: }</file><file path="src/components/ProvenancePanel.tsx">  1: import { useCallback } from &apos;react&apos;;
  2: import { Link } from &apos;wouter&apos;;
  3: 
  4: interface EvaluatorTypeCounts {
  5:   rule: number;
  6:   llm: number;
  7:   seed: number;
  8:   canary: number;
  9: }
 10: 
 11: interface ProvenancePanelProps {
 12:   evaluationName: string;
 13:   scoreValue?: number;
 14:   scoreLabel?: string;
 15:   traceId?: string;
 16:   spanId?: string;
 17:   sessionId?: string;
 18:   timestamp: string;
 19:   evaluator?: string;
 20:   evaluatorType?: string;
 21:   scoreUnit?: string;
 22:   agentName?: string;
 23:   /** Raw evaluation object for JSON export */
 24:   rawData?: Record&lt;string, unknown&gt;;
 25:   /** Evaluator type breakdown counts */
 26:   evaluatorTypeCounts?: EvaluatorTypeCounts;
 27: }
 28: 
 29: export function ProvenancePanel(props: ProvenancePanelProps) {
 30:   const {
 31:     evaluationName, scoreValue, scoreLabel,
 32:     traceId, spanId, sessionId, timestamp,
 33:     evaluator, evaluatorType, scoreUnit,
 34:     agentName, rawData, evaluatorTypeCounts,
 35:   } = props;
 36: 
 37:   const handleExportJson = useCallback(() =&gt; {
 38:     const data = rawData ?? {
 39:       evaluationName,
 40:       scoreValue,
 41:       scoreLabel,
 42:       traceId,
 43:       spanId,
 44:       sessionId,
 45:       timestamp,
 46:       evaluator,
 47:       evaluatorType,
 48:       scoreUnit,
 49:       agentName,
 50:     };
 51:     const blob = new Blob([JSON.stringify(data, null, 2)], { type: &apos;application/json&apos; });
 52:     const url = URL.createObjectURL(blob);
 53:     const a = document.createElement(&apos;a&apos;);
 54:     a.href = url;
 55:     a.download = `eval-${evaluationName}-${new Date(timestamp).getTime()}.json`;
 56:     a.click();
 57:     URL.revokeObjectURL(url);
 58:   }, [rawData, evaluationName, scoreValue, scoreLabel, traceId, spanId, sessionId, timestamp, evaluator, evaluatorType, scoreUnit, agentName]);
 59: 
 60:   const handleCopyTraceLink = useCallback(() =&gt; {
 61:     if (traceId) {
 62:       const link = `${window.location.origin}/traces/${traceId}`;
 63:       navigator.clipboard.writeText(link).catch(() =&gt; {});
 64:     }
 65:   }, [traceId]);
 66: 
 67:   const entries: Array&lt;{ label: string; value: string | undefined }&gt; = [
 68:     { label: &apos;Evaluation&apos;, value: evaluationName },
 69:     { label: &apos;Score&apos;, value: scoreValue != null ? `${scoreValue.toFixed(4)}${scoreLabel ? ` (${scoreLabel})` : &apos;&apos;}` : undefined },
 70:     { label: &apos;Evaluator&apos;, value: evaluator },
 71:     { label: &apos;Type&apos;, value: evaluatorType },
 72:     { label: &apos;Score Unit&apos;, value: scoreUnit },
 73:     { label: &apos;Trace ID&apos;, value: traceId },
 74:     { label: &apos;Span ID&apos;, value: spanId },
 75:     { label: &apos;Session ID&apos;, value: sessionId },
 76:     { label: &apos;Agent&apos;, value: agentName },
 77:     { label: &apos;Evaluated At&apos;, value: new Date(timestamp).toISOString() },
 78:     { label: &apos;OTel Event&apos;, value: &apos;gen_ai.evaluation.result&apos; },
 79:   ];
 80: 
 81:   return (
 82:     &lt;div className=&quot;text-xs&quot;&gt;
 83:       &lt;div className=&quot;provenance-grid&quot;&gt;
 84:         {entries.map(({ label, value }) =&gt; value ? (
 85:           &lt;div key={label} style={{ display: &apos;contents&apos; }}&gt;
 86:             &lt;span className=&quot;prov-label&quot;&gt;{label}&lt;/span&gt;
 87:             &lt;span className=&quot;prov-value&quot;&gt;
 88:               {label === &apos;Trace ID&apos; &amp;&amp; traceId ? (
 89:                 &lt;Link href={`/traces/${traceId}`} style={{ color: &apos;var(--accent)&apos;, textDecoration: &apos;none&apos; }}&gt;
 90:                   {traceId}
 91:                 &lt;/Link&gt;
 92:               ) : label === &apos;Session ID&apos; &amp;&amp; sessionId ? (
 93:                 &lt;Link href={`/sessions/${sessionId}`} style={{ color: &apos;var(--accent)&apos;, textDecoration: &apos;none&apos; }}&gt;
 94:                   {sessionId}
 95:                 &lt;/Link&gt;
 96:               ) : value}
 97:             &lt;/span&gt;
 98:           &lt;/div&gt;
 99:         ) : null)}
100:       &lt;/div&gt;
101:       {evaluatorTypeCounts &amp;&amp; (
102:         &lt;div className=&quot;gap-1-5&quot; style={{ display: &apos;flex&apos;, flexWrap: &apos;wrap&apos;, margin: &apos;8px 0&apos; }}&gt;
103:           {(Object.entries(evaluatorTypeCounts) as Array&lt;[keyof EvaluatorTypeCounts, number]&gt;)
104:             .filter(([, count]) =&gt; count &gt; 0)
105:             .map(([type, count]) =&gt; (
106:               &lt;span
107:                 key={type}
108:                 className=&quot;mono-xs text-secondary chip gap-1&quot;
109:                 style={{
110:                   display: &apos;inline-flex&apos;,
111:                   alignItems: &apos;center&apos;,
112:                   background: &apos;var(--bg-elevated)&apos;,
113:                   border: &apos;1px solid var(--border)&apos;,
114:                 }}
115:               &gt;
116:                 {type}
117:                 &lt;span style={{ fontWeight: 700, color: &apos;var(--text-primary)&apos; }}&gt;
118:                   {count}
119:                 &lt;/span&gt;
120:               &lt;/span&gt;
121:             ))}
122:         &lt;/div&gt;
123:       )}
124:       &lt;div className=&quot;provenance-actions&quot;&gt;
125:         &lt;button type=&quot;button&quot; className=&quot;text-xs&quot; onClick={handleExportJson}&gt;
126:           Export as JSON
127:         &lt;/button&gt;
128:         {traceId &amp;&amp; (
129:           &lt;button type=&quot;button&quot; className=&quot;text-xs&quot; onClick={handleCopyTraceLink}&gt;
130:             Copy trace link
131:           &lt;/button&gt;
132:         )}
133:       &lt;/div&gt;
134:     &lt;/div&gt;
135:   );
136: }</file><file path="src/components/QualityLiveIndicator.tsx"> 1: import { useQualityLive } from &apos;../hooks/useQualityLive.js&apos;;
 2: import { formatTimestamp } from &apos;../lib/quality-utils.js&apos;;
 3: import { SCORE_THRESHOLD_GREEN, SCORE_THRESHOLD_YELLOW } from &apos;../lib/constants.js&apos;;
 4: 
 5: function scoreToBadgeColor(score: number): string {
 6:   if (score &gt;= SCORE_THRESHOLD_GREEN) return &apos;var(--status-healthy)&apos;;
 7:   if (score &gt;= SCORE_THRESHOLD_YELLOW) return &apos;var(--status-warning)&apos;;
 8:   return &apos;var(--status-critical)&apos;;
 9: }
10: 
11: export function QualityLiveIndicator() {
12:   const { data, isLoading, error } = useQualityLive();
13: 
14:   if (isLoading) {
15:     return &lt;div className=&quot;quality-live-bar&quot; style={{ opacity: 0.5 }}&gt;Loading quality signals...&lt;/div&gt;;
16:   }
17: 
18:   if (error || !data) {
19:     return null;
20:   }
21: 
22:   if (data.metrics.length === 0) {
23:     return null;
24:   }
25: 
26:   return (
27:     &lt;div
28:       className=&quot;quality-live-bar flex-center gap-2 text-xs&quot;
29:       role=&quot;status&quot;
30:       aria-label=&quot;Live quality signals&quot;
31:       style={{
32:         flexWrap: &apos;wrap&apos;,
33:         padding: &apos;6px 12px&apos;,
34:         borderRadius: 6,
35:         background: &apos;var(--bg-elevated)&apos;,
36:         border: &apos;1px solid var(--border)&apos;,
37:       }}
38:     &gt;
39:       &lt;span className=&quot;text-secondary font-semibold&quot; style={{ marginRight: 4 }}&gt;
40:         Quality
41:       &lt;/span&gt;
42:       {data.metrics.map((m) =&gt; (
43:         &lt;span
44:           key={m.name}
45:           title={`${m.name}: ${m.score.toFixed(2)} (${m.evaluatorType})`}
46:           className=&quot;mono text-xs chip gap-1&quot;
47:           style={{
48:             display: &apos;inline-flex&apos;,
49:             alignItems: &apos;center&apos;,
50:             background: scoreToBadgeColor(m.score) + &apos;1a&apos;,
51:             color: scoreToBadgeColor(m.score),
52:             fontWeight: 500,
53:           }}
54:         &gt;
55:           &lt;span style={{
56:             width: 6,
57:             height: 6,
58:             borderRadius: &apos;50%&apos;,
59:             background: scoreToBadgeColor(m.score),
60:           }} /&gt;
61:           {m.name.replace(/_/g, &apos; &apos;)}
62:           &lt;span style={{ fontWeight: 700 }}&gt;{m.score.toFixed(2)}&lt;/span&gt;
63:         &lt;/span&gt;
64:       ))}
65:       &lt;span className=&quot;text-secondary&quot; style={{ fontSize: &apos;var(--font-size-2xs)&apos;, marginLeft: &apos;auto&apos; }}&gt;
66:         {formatTimestamp(data.lastUpdated)}
67:       &lt;/span&gt;
68:     &lt;/div&gt;
69:   );
70: }</file><file path="src/components/Section.tsx"> 1: import type { ReactNode } from &apos;react&apos;;
 2: 
 3: /** Non-collapsible view section — wraps .view-section + .section-heading */
 4: export function ViewSection({ title, children }: { title: string; children: ReactNode }) {
 5:   return (
 6:     &lt;div className=&quot;view-section&quot;&gt;
 7:       &lt;h3 className=&quot;section-heading&quot;&gt;{title}&lt;/h3&gt;
 8:       {children}
 9:     &lt;/div&gt;
10:   );
11: }
12: 
13: export type SectionHealth = &apos;ok&apos; | &apos;warn&apos; | &apos;crit&apos; | &apos;neutral&apos;;
14: 
15: export interface SectionProps {
16:   title: string;
17:   badge?: string;
18:   health?: SectionHealth;
19:   defaultOpen?: boolean;
20:   children: ReactNode;
21: }
22: 
23: export function Section({ title, badge, health = &apos;neutral&apos;, defaultOpen = false, children }: SectionProps) {
24:   const railColor = health === &apos;ok&apos;
25:     ? &apos;var(--status-healthy)&apos;
26:     : health === &apos;warn&apos;
27:     ? &apos;var(--status-warning)&apos;
28:     : health === &apos;crit&apos;
29:     ? &apos;var(--status-critical)&apos;
30:     : &apos;var(--border-accent)&apos;;
31: 
32:   return (
33:     &lt;details open={defaultOpen} style={{ marginBottom: 2 }}&gt;
34:       &lt;summary className=&quot;flex-center gap-3&quot; style={{
35:         padding: &apos;12px 20px&apos;,
36:         background: &apos;var(--bg-card)&apos;,
37:         borderLeft: `3px solid ${railColor}`,
38:         borderBottom: &apos;1px solid var(--border-subtle)&apos;,
39:         cursor: &apos;pointer&apos;,
40:         userSelect: &apos;none&apos;,
41:         listStyle: &apos;none&apos;,
42:         transition: &apos;background 0.15s&apos;,
43:       }}&gt;
44:         &lt;span className=&quot;mono&quot; style={{
45:           fontSize: &apos;var(--font-size-2xs)&apos;,
46:           color: railColor,
47:           transition: &apos;transform 0.2s&apos;,
48:           display: &apos;inline-block&apos;,
49:         }}&gt;▶&lt;/span&gt;
50:         &lt;span className=&quot;mono-xs text-secondary uppercase font-semibold&quot; style={{
51:           flex: 1,
52:         }}&gt;{title}&lt;/span&gt;
53:         {badge &amp;&amp; (
54:           &lt;span className=&quot;mono-xs text-muted chip&quot; style={{
55:             background: &apos;var(--bg-elevated)&apos;,
56:             border: &apos;1px solid var(--border-subtle)&apos;,
57:           }}&gt;{badge}&lt;/span&gt;
58:         )}
59:       &lt;/summary&gt;
60:       &lt;div style={{
61:         padding: &apos;16px 20px 20px&apos;,
62:         background: &apos;var(--bg-card)&apos;,
63:         borderLeft: `3px solid ${railColor}`,
64:         borderBottom: &apos;1px solid var(--border-subtle)&apos;,
65:       }}&gt;
66:         {children}
67:       &lt;/div&gt;
68:     &lt;/details&gt;
69:   );
70: }</file><file path="src/components/TurnTimeline.tsx"> 1: import { scoreColorBand, SCORE_COLORS } from &apos;../lib/quality-utils.js&apos;;
 2: import { AGENT_PALETTE } from &apos;../lib/constants.js&apos;;
 3: import type { TurnLevelResult } from &apos;../types.js&apos;;
 4: 
 5: function agentColor(agentName: string, agentNames: string[]): string {
 6:   const idx = agentNames.indexOf(agentName);
 7:   return AGENT_PALETTE[idx % AGENT_PALETTE.length];
 8: }
 9: 
10: interface TurnTimelineProps {
11:   turns: TurnLevelResult[];
12:   agentNames: string[];
13: }
14: 
15: export function TurnTimeline({ turns, agentNames }: TurnTimelineProps) {
16:   if (turns.length === 0) {
17:     return &lt;div className=&quot;text-muted&quot; style={{ padding: 16 }}&gt;No turns to display.&lt;/div&gt;;
18:   }
19: 
20:   return (
21:     &lt;div className=&quot;gap-2&quot; style={{ display: &apos;flex&apos;, overflowX: &apos;auto&apos;, padding: &apos;8px 0&apos; }}&gt;
22:       {turns.map((turn) =&gt; {
23:         const agent = turn.agentName ?? &apos;unknown&apos;;
24:         const color = agentColor(agent, agentNames);
25:         const band = scoreColorBand(turn.relevance);
26:         const bandColor = SCORE_COLORS[band];
27: 
28:         return (
29:           &lt;div
30:             key={turn.turnIndex}
31:             style={{
32:               minWidth: 120,
33:               padding: 12,
34:               borderRadius: 8,
35:               border: `2px solid ${color}`,
36:               background: &apos;var(--bg-elevated)&apos;,
37:               flexShrink: 0,
38:             }}
39:           &gt;
40:             &lt;div className=&quot;flex-center mb-1-5&quot; style={{ justifyContent: &apos;space-between&apos; }}&gt;
41:               &lt;span className=&quot;text-2xs uppercase font-semibold&quot; style={{ color }}&gt;{agent}&lt;/span&gt;
42:               &lt;span className=&quot;text-muted text-2xs&quot;&gt;#{turn.turnIndex}&lt;/span&gt;
43:             &lt;/div&gt;
44: 
45:             {/* Relevance bar */}
46:             &lt;div className=&quot;mb-1-5&quot;&gt;
47:               &lt;div className=&quot;text-secondary&quot; style={{ fontSize: &apos;var(--font-size-2xs)&apos;, marginBottom: 2 }}&gt;Relevance&lt;/div&gt;
48:               &lt;div className=&quot;mini-bar&quot; style={{ &apos;--bar-h&apos;: &apos;6px&apos; } as React.CSSProperties}&gt;
49:                 &lt;div className=&quot;mini-bar-fill&quot; style={{ width: `${turn.relevance * 100}%`, background: bandColor }} /&gt;
50:               &lt;/div&gt;
51:             &lt;/div&gt;
52: 
53:             {/* Task progress bar */}
54:             &lt;div className=&quot;mb-1-5&quot;&gt;
55:               &lt;div className=&quot;text-secondary&quot; style={{ fontSize: &apos;var(--font-size-2xs)&apos;, marginBottom: 2 }}&gt;Progress&lt;/div&gt;
56:               &lt;div className=&quot;mini-bar&quot; style={{ &apos;--bar-h&apos;: &apos;6px&apos; } as React.CSSProperties}&gt;
57:                 &lt;div className=&quot;mini-bar-fill&quot; style={{ width: `${turn.taskProgress * 100}%`, background: &apos;var(--status-healthy)&apos; }} /&gt;
58:               &lt;/div&gt;
59:             &lt;/div&gt;
60: 
61:             {turn.hasError &amp;&amp; (
62:               &lt;div className=&quot;text-2xs font-semibold&quot; style={{ color: &apos;var(--status-critical)&apos;, marginTop: 4 }}&gt;
63:                 Error
64:               &lt;/div&gt;
65:             )}
66:           &lt;/div&gt;
67:         );
68:       })}
69:     &lt;/div&gt;
70:   );
71: }</file><file path="src/hooks/useSessionDetail.ts">  1: import { useQuery } from &apos;@tanstack/react-query&apos;;
  2: import type { MultiAgentEvaluation, EvaluationResult } from &apos;../types.js&apos;;
  3: import { API_BASE, STALE_TIME, ErrorName } from &apos;../lib/constants.js&apos;;
  4: 
  5: export interface SessionInfo {
  6:   projectName: string;
  7:   workingDirectory: string;
  8:   gitRepository: string;
  9:   gitBranch: string;
 10:   nodeVersion: string;
 11:   resumeCount: number;
 12:   initialMessageCount: number;
 13:   initialContextTokens: number;
 14:   finalMessageCount: number;
 15:   taskCount: number;
 16:   uncommittedAtStart: number;
 17: }
 18: 
 19: export interface TokenSnapshot {
 20:   messages: number;
 21:   inputTokens: number;
 22:   outputTokens: number;
 23:   cacheRead: number;
 24:   cacheCreation: number;
 25:   model: string;
 26: }
 27: 
 28: export interface TokenTotals {
 29:   input: number;
 30:   output: number;
 31:   cacheRead: number;
 32:   cacheCreation: number;
 33:   messages: number;
 34:   models: Record&lt;string, number&gt;;
 35: }
 36: 
 37: export interface AgentStat {
 38:   agentName: string;
 39:   invocations: number;
 40:   errors: number;
 41:   hasRateLimit: boolean;
 42:   avgOutputSize: number;
 43: }
 44: 
 45: export interface FileAccessEntry {
 46:   path: string;
 47:   count: number;
 48: }
 49: 
 50: export interface GitCommit {
 51:   subject: string;
 52:   body: string;
 53:   files: string;
 54: }
 55: 
 56: export interface CodeStructureEntry {
 57:   file: string;
 58:   lines: number;
 59:   exports: number;
 60:   functions: number;
 61:   hasTypes: boolean;
 62:   score: number;
 63:   tool: string;
 64: }
 65: 
 66: export interface AlertSummary {
 67:   totalFired: number;
 68:   stopEvents: number;
 69: }
 70: 
 71: export interface DataSources {
 72:   traces: { count: number; traceIds: number };
 73:   logs: { count: number };
 74:   evaluations: { count: number };
 75:   total: number;
 76: }
 77: 
 78: export interface Timespan {
 79:   start: string;
 80:   end: string;
 81:   durationHours: number;
 82: }
 83: 
 84: export interface HookLatency {
 85:   count: number;
 86:   avg: number;
 87:   p50: number;
 88:   p95: number;
 89:   max: number;
 90: }
 91: 
 92: export interface EvaluationBreakdownEntry {
 93:   name: string;
 94:   count: number;
 95:   avg: number | null;
 96:   min: number | null;
 97:   max: number | null;
 98: }
 99: 
100: export interface SessionDetailResponse {
101:   sessionId: string;
102:   dataSources: DataSources;
103:   timespan: Timespan | null;
104:   sessionInfo: SessionInfo | null;
105:   tokenTotals: TokenTotals;
106:   tokenProgression: TokenSnapshot[];
107:   toolUsage: Record&lt;string, number&gt;;
108:   mcpUsage: Record&lt;string, number&gt;;
109:   spanBreakdown: Record&lt;string, number&gt;;
110:   hookLatency: Record&lt;string, HookLatency&gt;;
111:   errors: {
112:     byCategory: Record&lt;string, number&gt;;
113:     details: Array&lt;{
114:       spanName: string;
115:       tool?: string;
116:       errorType?: string;
117:       filePath?: string;
118:     }&gt;;
119:   };
120:   agentActivity: AgentStat[];
121:   fileAccess: FileAccessEntry[];
122:   gitCommits: GitCommit[];
123:   alertSummary: AlertSummary;
124:   codeStructure: CodeStructureEntry[];
125:   evaluationBreakdown: EvaluationBreakdownEntry[];
126:   logSummary: {
127:     bySeverity: Record&lt;string, number&gt;;
128:     logs: unknown[];
129:   };
130:   multiAgentEvaluation: MultiAgentEvaluation;
131:   evaluations: EvaluationResult[];
132: }
133: 
134: export class SessionNotFoundError extends Error {
135:   constructor(sessionId: string) {
136:     super(`Session ${sessionId} has not been synced to the dashboard yet.`);
137:     this.name = ErrorName.SessionNotFound;
138:   }
139: }
140: 
141: export function useSessionDetail(sessionId: string | undefined) {
142:   return useQuery&lt;SessionDetailResponse&gt;({
143:     queryKey: [&apos;session-detail&apos;, sessionId],
144:     queryFn: async () =&gt; {
145:       const res = await fetch(`${API_BASE}/api/sessions/${encodeURIComponent(sessionId!)}`);
146:       if (res.status === 404) throw new SessionNotFoundError(sessionId!);
147:       if (!res.ok) throw new Error(`API error: ${res.status}`);
148:       return res.json();
149:     },
150:     enabled: !!sessionId,
151:     staleTime: STALE_TIME.DETAIL,
152:     retry: (failureCount, error) =&gt;
153:       error instanceof SessionNotFoundError ? false : failureCount &lt; 2,
154:   });
155: }</file><file path="src/api/server.ts"> 1: import { Hono } from &apos;hono&apos;;
 2: import { cors } from &apos;hono/cors&apos;;
 3: import { serve } from &apos;@hono/node-server&apos;;
 4: import { dashboardRoutes } from &apos;./routes/dashboard.js&apos;;
 5: import { metricsRoutes } from &apos;./routes/metrics.js&apos;;
 6: import { correlationRoutes } from &apos;./routes/correlations.js&apos;;
 7: import { evaluationRoutes } from &apos;./routes/evaluations.js&apos;;
 8: import { trendRoutes } from &apos;./routes/trends.js&apos;;
 9: import { coverageRoutes } from &apos;./routes/coverage.js&apos;;
10: import { pipelineRoutes } from &apos;./routes/pipeline.js&apos;;
11: import { complianceRoutes } from &apos;./routes/compliance.js&apos;;
12: import { traceRoutes } from &apos;./routes/traces.js&apos;;
13: import { agentRoutes } from &apos;./routes/agents.js&apos;;
14: import { sessionRoutes } from &apos;./routes/sessions.js&apos;;
15: import { qualityRoutes } from &apos;./routes/quality.js&apos;;
16: 
17: const app = new Hono();
18: 
19: app.use(&apos;/*&apos;, cors({ origin: process.env.CORS_ORIGIN || &apos;http://localhost:5173&apos; }));
20: 
21: app.route(&apos;/api&apos;, dashboardRoutes);
22: app.route(&apos;/api&apos;, metricsRoutes);
23: app.route(&apos;/api&apos;, correlationRoutes);
24: app.route(&apos;/api&apos;, evaluationRoutes);
25: app.route(&apos;/api&apos;, trendRoutes);
26: app.route(&apos;/api&apos;, coverageRoutes);
27: app.route(&apos;/api&apos;, pipelineRoutes);
28: app.route(&apos;/api&apos;, complianceRoutes);
29: app.route(&apos;/api&apos;, traceRoutes);
30: app.route(&apos;/api&apos;, agentRoutes);
31: app.route(&apos;/api&apos;, sessionRoutes);
32: app.route(&apos;/api&apos;, qualityRoutes);
33: 
34: console.log(`API server listening on http://127.0.0.1:${port}`);
35: 
36: serve({ fetch: app.fetch, hostname: &apos;127.0.0.1&apos;, port });</file><file path="src/hooks/useAgentStats.ts"> 1: import { useQuery } from &apos;@tanstack/react-query&apos;;
 2: import type { Period } from &apos;../types.js&apos;;
 3: import { API_BASE, STALE_TIME, ErrorMessage } from &apos;../lib/constants.js&apos;;
 4: 
 5: export interface EvalMetricSummary {
 6:   avg: number;
 7:   min: number;
 8:   max: number;
 9:   count: number;
10: }
11: 
12: export interface AgentStat {
13:   agentName: string;
14:   invocations: number;
15:   errors: number;
16:   errorRate: number;
17:   rateLimitCount: number;
18:   avgOutputSize: number;
19:   sessionCount: number;
20:   sessionIds: string[];
21:   sessionIdsTruncated: boolean;
22:   traceIdsTotal?: number;
23:   traceIds: string[];
24:   traceIdsTruncated: boolean;
25:   sourceTypes: Record&lt;string, number&gt;;
26:   dailyCounts: number[];
27:   evalSummary: Record&lt;string, EvalMetricSummary&gt;;
28: }
29: 
30: interface AgentStatsResponse {
31:   period: string;
32:   startDate: string;
33:   endDate: string;
34:   agents: AgentStat[];
35: }
36: 
37: /** Shallow shape check — validates envelope fields only, not individual AgentStat elements. */
38: function assertAgentStatsResponse(data: unknown): asserts data is AgentStatsResponse {
39:   if (!data || typeof data !== &apos;object&apos;) throw new Error(ErrorMessage.InvalidResponseShape);
40:   const obj = data as Record&lt;string, unknown&gt;;
41:   if (typeof obj.period !== &apos;string&apos; || !Array.isArray(obj.agents)) {
42:     throw new Error(ErrorMessage.MissingPeriodOrAgents);
43:   }
44: }
45: 
46: export function useAgentStats(period: Period) {
47:   return useQuery&lt;AgentStatsResponse&gt;({
48:     queryKey: [&apos;agent-stats&apos;, period],
49:     queryFn: async () =&gt; {
50:       const res = await fetch(`${API_BASE}/api/agents?period=${encodeURIComponent(period)}`);
51:       if (!res.ok) throw new Error(`API error: ${res.status}`);
52:       const data: unknown = await res.json();
53:       assertAgentStatsResponse(data);
54:       return data;
55:     },
56:     staleTime: STALE_TIME.AGGREGATE,
57:     retry: 2,
58:   });
59: }</file><file path="src/lib/constants.ts">  1: import { z } from &apos;zod&apos;;
  2: 
  3: /** Named error identifiers for custom error classes. */
  4: export const enum ErrorName {
  5:   SessionNotFound = &apos;SessionNotFoundError&apos;,
  6: }
  7: 
  8: /** HTTP status codes used in API error responses. */
  9: export const enum HttpStatus {
 10:   BadRequest = 400,
 11:   NotFound = 404,
 12:   InternalServerError = 500,
 13: }
 14: 
 15: /** Reusable error messages for response validation. */
 16: export const enum ErrorMessage {
 17:   InvalidResponseShape = &apos;Invalid response shape&apos;,
 18:   MissingPeriodOrAgents = &apos;Invalid response: missing period or agents&apos;,
 19:   InvalidPeriod = &apos;Invalid period. Must be 24h, 7d, or 30d.&apos;,
 20:   InvalidRole = &apos;Invalid role. Must be executive, operator, or auditor.&apos;,
 21: }
 22: 
 23: /** Zod schema for coverage input key param. Single source for type, values, and default. */
 24: export const InputKeySchema = z.enum([&apos;traceId&apos;, &apos;sessionId&apos;]).default(&apos;traceId&apos;);
 25: export type InputKey = z.infer&lt;typeof InputKeySchema&gt;;
 26: export const DEFAULT_INPUT_KEY: InputKey = InputKeySchema._def.defaultValue();
 27: 
 28: /** Zod schema for evaluation sort order param. */
 29: export const SortBySchema = z.enum([&apos;score_asc&apos;, &apos;score_desc&apos;, &apos;timestamp_desc&apos;]).default(&apos;timestamp_desc&apos;);
 30: export type SortBy = z.infer&lt;typeof SortBySchema&gt;;
 31: export const DEFAULT_SORT_BY: SortBy = SortBySchema._def.defaultValue();
 32: 
 33: /** Zod schema for role param. */
 34: export const RoleSchema = z.enum([&apos;executive&apos;, &apos;operator&apos;, &apos;auditor&apos;]);
 35: export type Role = z.infer&lt;typeof RoleSchema&gt;;
 36: export const ROLES = RoleSchema.options;
 37: export const DEFAULT_ROLE: Role = &apos;executive&apos;;
 38: 
 39: /** Base URL for API requests. Uses VITE_API_URL env var, falls back to localhost:3001 in dev. */
 40: export const API_BASE = import.meta.env.VITE_API_URL ?? (import.meta.env.DEV ? &apos;http://localhost:3001&apos; : &apos;&apos;);
 41: 
 42: /** Percentage of events sampled for T2 LLM evaluation. */
 43: export const LLM_SAMPLE_RATE = 10;
 44: 
 45: /** Score band thresholds for quality indicator color coding. */
 46: export const SCORE_THRESHOLD_GREEN = 0.8;
 47: export const SCORE_THRESHOLD_YELLOW = 0.5;
 48: 
 49: /** Error rate fraction above which agent activity is flagged as critical. */
 50: export const ERROR_RATE_WARNING_THRESHOLD = 0.1;
 51: 
 52: /** Score below which a hallucination evaluation is flagged. */
 53: export const HALLUCINATION_SCORE_THRESHOLD = 0.4;
 54: 
 55: /** Maximum rows shown in session detail tables. */
 56: export const MAX_ERROR_ROWS = 10;
 57: export const MAX_HALLUCINATION_ROWS = 8;
 58: export const MAX_FAILED_EVAL_ROWS = 6;
 59: 
 60: /** Decimal places for displayed score values. */
 61: export const SCORE_DISPLAY_PRECISION = 3;
 62: 
 63: /** Period string → day count for API route validation. */
 64: export const VALID_PERIODS: Record&lt;string, number&gt; = { &apos;24h&apos;: 1, &apos;7d&apos;: 7, &apos;30d&apos;: 30 };
 65: 
 66: /** Zod-compatible tuple of valid period keys, derived from VALID_PERIODS. */
 67: export const PERIOD_KEYS = Object.keys(VALID_PERIODS) as [string, ...string[]];
 68: 
 69: /** Zod enum for period values, derived from VALID_PERIODS keys. */
 70: export const PeriodEnum = z.enum(PERIOD_KEYS);
 71: 
 72: /** Default client-side period for list/evaluation queries. */
 73: export const DEFAULT_PERIOD = PeriodEnum.parse(&apos;7d&apos;) as &apos;7d&apos;;
 74: 
 75: /** Default client-side period for metric detail views (wider window). */
 76: export const DEFAULT_PERIOD_DETAIL = PeriodEnum.parse(&apos;30d&apos;) as &apos;30d&apos;;
 77: 
 78: /** Shared Zod schema for period query param validation (default: &apos;7d&apos;). */
 79: export const PeriodSchema = PeriodEnum.default(DEFAULT_PERIOD);
 80: 
 81: const MS_PER_DAY = 24 * 60 * 60 * 1000;
 82: 
 83: /** Period string → milliseconds, derived from VALID_PERIODS. */
 84: export const PERIOD_MS: Record&lt;string, number&gt; = Object.fromEntries(
 85:   Object.entries(VALID_PERIODS).map(([k, days]) =&gt; [k, days * MS_PER_DAY]),
 86: );
 87: 
 88: /** Max session/trace IDs returned per agent in stats response. */
 89: export const MAX_IDS = 50;
 90: 
 91: /** Recognized agent source type values. */
 92: export const KNOWN_SOURCE_TYPES = new Set([&apos;active&apos;, &apos;lazy&apos;, &apos;builtin&apos;, &apos;skill&apos;, &apos;settings&apos;, &apos;unknown&apos;]);
 93: 
 94: /** Rolling window for live quality endpoint (24 h). */
 95: export const LIVE_WINDOW_MS = 24 * 60 * 60 * 1000;
 96: 
 97: /** Max evaluations returned by the live quality endpoint. */
 98: export const EVAL_LIMIT = 100;
 99: 
100: /** React Query staleTime tiers (ms). */
101: export const STALE_TIME = {
102:   /** Standard data queries (metrics, trends, coverage, compliance, pipeline, evaluations). */
103:   DEFAULT: 25_000,
104:   /** Entity detail views (session, trace, agent session). */
105:   DETAIL: 30_000,
106:   /** Slow-changing aggregate stats (agent stats). */
107:   AGGREGATE: 60_000,
108: } as const;
109: 
110: /** Polling / refetch interval for live and dashboard queries (ms). */
111: export const POLL_INTERVAL_MS = 30_000;
112: 
113: /** Exponential backoff base and cap for retry delays (ms). */
114: export const RETRY_DELAY_BASE = 1_000;
115: export const RETRY_DELAY_CAP = 30_000;
116: 
117: /** Default query params for metric detail endpoint. */
118: export const DEFAULT_TOP_N = 5;
119: export const DEFAULT_BUCKET_COUNT = 10;
120: 
121: /** Default page size for paginated evaluation queries. */
122: export const DEFAULT_PAGE_LIMIT = 50;
123: 
124: /** Shared Recharts color palette for TrendChart and TrendSeries. */
125: export const CHART_COLORS = {
126:   line: &apos;#58a6ff&apos;,
127:   grid: &apos;#30363d&apos;,
128:   text: &apos;#8b949e&apos;,
129:   tooltip: &apos;#161b22&apos;,
130:   warning: &apos;#d29922&apos;,
131:   critical: &apos;#f85149&apos;,
132: } as const;
133: 
134: /** Color palette for per-agent visual distinction. */
135: export const AGENT_PALETTE = [
136:   &apos;#6366f1&apos;, &apos;#ec4899&apos;, &apos;#14b8a6&apos;, &apos;#f59e0b&apos;,
137:   &apos;#8b5cf6&apos;, &apos;#06b6d4&apos;, &apos;#f97316&apos;, &apos;#84cc16&apos;,
138: ] as const;</file><file path="src/lib/quality-utils.ts">  1: /**
  2:  * Subset of quality-feature-engineering utilities needed by the frontend.
  3:  * Extracted from parent src/lib/quality-feature-engineering.ts to allow
  4:  * standalone Vite builds (CI) without the parent dist/ directory.
  5:  *
  6:  * Keep in sync with the parent when these definitions change.
  7:  */
  8: 
  9: // -- Types ------------------------------------------------------------------
 10: 
 11: export type ScoreDirection = &apos;maximize&apos; | &apos;minimize&apos;;
 12: export type ScoreColorBand = &apos;excellent&apos; | &apos;good&apos; | &apos;adequate&apos; | &apos;poor&apos; | &apos;failing&apos;;
 13: export type LabelFilterCategory = &apos;Pass&apos; | &apos;Review&apos; | &apos;Fail&apos;;
 14: 
 15: export interface LabelOrdinal {
 16:   ordinal: number;
 17:   category: LabelFilterCategory;
 18:   mapped: boolean;
 19: }
 20: 
 21: import type { Role } from &apos;./constants.js&apos;;
 22: export type FeatureRoleType = Role;
 23: 
 24: export interface RoleFeatureConfig {
 25:   showCQI: boolean;
 26:   showCQIBreakdown: boolean;
 27:   showVariance: boolean;
 28:   showAcceleration: boolean;
 29:   showProjectedBreach: boolean;
 30:   showCorrelationRemediation: boolean;
 31:   showCoverageHeatmap: boolean;
 32:   showPipelineFunnel: boolean;
 33:   showProvenance: boolean;
 34:   showRawExport: boolean;
 35:   explanationTruncation: number;
 36:   maxWorstEvaluations: number;
 37: }
 38: 
 39: // -- Shared helpers ---------------------------------------------------------
 40: 
 41: export function truncateText(text: string, max: number): string {
 42:   return text.length &gt; max ? text.slice(0, max) + &apos;...&apos; : text;
 43: }
 44: 
 45: export function truncateId(id: string, max = 10): string {
 46:   if (id.length &lt;= max) return id;
 47:   return `${id.slice(0, 4)}\u2026${id.slice(-4)}`;
 48: }
 49: 
 50: export function formatScore(val: number | null | undefined): string {
 51:   if (val === null || val === undefined) return &apos;N/A&apos;;
 52:   return val.toFixed(4);
 53: }
 54: 
 55: export function plural(count: number, singular: string, suffix = &apos;s&apos;): string {
 56:   return `${count} ${singular}${count !== 1 ? suffix : &apos;&apos;}`;
 57: }
 58: 
 59: export const SCORE_COLORS: Record&lt;ScoreColorBand | &apos;no_data&apos;, string&gt; = {
 60:   excellent: &apos;#26d97f&apos;,
 61:   good: &apos;#34d399&apos;,
 62:   adequate: &apos;#e5a00d&apos;,
 63:   poor: &apos;#f97316&apos;,
 64:   failing: &apos;#f04438&apos;,
 65:   no_data: &apos;#6b7280&apos;,
 66: };
 67: 
 68: // -- scoreColorBand ---------------------------------------------------------
 69: 
 70: export function scoreColorBand(
 71:   value: number,
 72:   direction: ScoreDirection = &apos;maximize&apos;,
 73: ): ScoreColorBand {
 74:   const v = direction === &apos;minimize&apos; ? 1 - value : value;
 75:   if (v &gt;= 0.9) return &apos;excellent&apos;;
 76:   if (v &gt;= 0.8) return &apos;good&apos;;
 77:   if (v &gt;= 0.6) return &apos;adequate&apos;;
 78:   if (v &gt;= 0.4) return &apos;poor&apos;;
 79:   return &apos;failing&apos;;
 80: }
 81: 
 82: // -- inferScoreDirection ----------------------------------------------------
 83: 
 84: type ThresholdDirection = &apos;above&apos; | &apos;below&apos;;
 85: 
 86: export function inferScoreDirection(
 87:   alertDirection: ThresholdDirection | undefined,
 88: ): ScoreDirection {
 89:   return alertDirection === &apos;above&apos; ? &apos;minimize&apos; : &apos;maximize&apos;;
 90: }
 91: 
 92: // -- Label ordinal encoding -------------------------------------------------
 93: 
 94: const LABEL_ORDINAL_MAP: Record&lt;string, { ordinal: number; category: LabelFilterCategory }&gt; = {
 95:   excellent: { ordinal: 4, category: &apos;Pass&apos; },
 96:   highly_relevant: { ordinal: 4, category: &apos;Pass&apos; },
 97:   fully_faithful: { ordinal: 4, category: &apos;Pass&apos; },
 98:   perfect: { ordinal: 4, category: &apos;Pass&apos; },
 99:   relevant: { ordinal: 3, category: &apos;Pass&apos; },
100:   good: { ordinal: 3, category: &apos;Pass&apos; },
101:   faithful: { ordinal: 3, category: &apos;Pass&apos; },
102:   pass: { ordinal: 3, category: &apos;Pass&apos; },
103:   correct: { ordinal: 3, category: &apos;Pass&apos; },
104:   coherent: { ordinal: 3, category: &apos;Pass&apos; },
105:   partial: { ordinal: 2, category: &apos;Review&apos; },
106:   borderline: { ordinal: 2, category: &apos;Review&apos; },
107:   adequate: { ordinal: 2, category: &apos;Review&apos; },
108:   mixed: { ordinal: 2, category: &apos;Review&apos; },
109:   off_topic: { ordinal: 1, category: &apos;Fail&apos; },
110:   irrelevant: { ordinal: 1, category: &apos;Fail&apos; },
111:   unfaithful: { ordinal: 1, category: &apos;Fail&apos; },
112:   fail: { ordinal: 1, category: &apos;Fail&apos; },
113:   incorrect: { ordinal: 1, category: &apos;Fail&apos; },
114:   incoherent: { ordinal: 1, category: &apos;Fail&apos; },
115:   hallucinated: { ordinal: 0, category: &apos;Fail&apos; },
116:   fabricated: { ordinal: 0, category: &apos;Fail&apos; },
117:   toxic: { ordinal: 0, category: &apos;Fail&apos; },
118:   dangerous: { ordinal: 0, category: &apos;Fail&apos; },
119: };
120: 
121: function normalizeLabel(label: string): string {
122:   return label.toLowerCase().replace(/-/g, &apos;_&apos;).trim();
123: }
124: 
125: export function labelToOrdinal(label: string): LabelOrdinal {
126:   const normalized = normalizeLabel(label);
127:   const entry = LABEL_ORDINAL_MAP[normalized];
128:   if (entry) {
129:     return { ordinal: entry.ordinal, category: entry.category, mapped: true };
130:   }
131:   return { ordinal: 2, category: &apos;Review&apos;, mapped: false };
132: }
133: 
134: export function ordinalToCategory(ordinal: number): LabelFilterCategory {
135:   if (ordinal &gt;= 3) return &apos;Pass&apos;;
136:   if (ordinal === 2) return &apos;Review&apos;;
137:   return &apos;Fail&apos;;
138: }
139: 
140: // -- Role feature config ----------------------------------------------------
141: 
142: export const ROLE_FEATURE_CONFIG: Record&lt;FeatureRoleType, RoleFeatureConfig&gt; = {
143:   executive: {
144:     showCQI: true,
145:     showCQIBreakdown: true,
146:     showVariance: false,
147:     showAcceleration: false,
148:     showProjectedBreach: true,
149:     showCorrelationRemediation: false,
150:     showCoverageHeatmap: false,
151:     showPipelineFunnel: false,
152:     showProvenance: false,
153:     showRawExport: false,
154:     explanationTruncation: 80,
155:     maxWorstEvaluations: 1,
156:   },
157:   operator: {
158:     showCQI: false,
159:     showCQIBreakdown: false,
160:     showVariance: true,
161:     showAcceleration: true,
162:     showProjectedBreach: true,
163:     showCorrelationRemediation: true,
164:     showCoverageHeatmap: true,
165:     showPipelineFunnel: true,
166:     showProvenance: false,
167:     showRawExport: false,
168:     explanationTruncation: 500,
169:     maxWorstEvaluations: 5,
170:   },
171:   auditor: {
172:     showCQI: true,
173:     showCQIBreakdown: true,
174:     showVariance: true,
175:     showAcceleration: false,
176:     showProjectedBreach: false,
177:     showCorrelationRemediation: true,
178:     showCoverageHeatmap: true,
179:     showPipelineFunnel: true,
180:     showProvenance: true,
181:     showRawExport: true,
182:     explanationTruncation: 2000,
183:     maxWorstEvaluations: 10,
184:   },
185: };
186: 
187: export function getRoleFeatureConfig(role: FeatureRoleType): RoleFeatureConfig {
188:   return ROLE_FEATURE_CONFIG[role];
189: }
190: 
191: // -- Path/byte formatters ---------------------------------------------------
192: 
193: export function shortPath(fullPath: string): string {
194:   const parts = fullPath.replace(/\\/g, &apos;/&apos;).split(&apos;/&apos;);
195:   return parts.length &gt; 3 ? `\u2026/${parts.slice(-3).join(&apos;/&apos;)}` : fullPath;
196: }
197: 
198: export function fmtBytes(n: number): string {
199:   if (n &gt;= 1_000_000) return `${(n / 1_000_000).toFixed(1)}M`;
200:   if (n &gt;= 1_000) return `${(n / 1_000).toFixed(1)}K`;
201:   return String(n);
202: }
203: 
204: // -- Timestamp formatting ---------------------------------------------------
205: 
206: export function formatTimestamp(ts: string): string {
207:   const d = new Date(ts);
208:   if (isNaN(d.getTime())) return ts || &apos;-&apos;;
209:   const now = Date.now();
210:   const diffMs = now - d.getTime();
211:   const diffMin = Math.floor(diffMs / 60_000);
212:   if (diffMin &lt; 1) return &apos;just now&apos;;
213:   if (diffMin &lt; 60) return `${diffMin}m ago`;
214:   const diffHr = Math.floor(diffMin / 60);
215:   if (diffHr &lt; 24) return `${diffHr}h ago`;
216:   const diffDay = Math.floor(diffHr / 24);
217:   if (diffDay &lt; 7) return `${diffDay}d ago`;
218:   return d.toLocaleDateString();
219: }</file><file path="src/pages/TraceDetailPage.tsx"> 1: import { useTrace } from &apos;../hooks/useTrace.js&apos;;
 2: import { SpanTree } from &apos;../components/SpanTree.js&apos;;
 3: import { EvaluationEventOverlay } from &apos;../components/EvaluationEventOverlay.js&apos;;
 4: import { PageShell } from &apos;../components/PageShell.js&apos;;
 5: import { SyncEmptyState } from &apos;../components/SyncEmptyState.js&apos;;
 6: 
 7: export function TraceDetailPage({ traceId }: { traceId: string }) {
 8:   const { data, isLoading, error } = useTrace(traceId);
 9: 
10:   const isEmpty = !data || (data.spans.length === 0 &amp;&amp; data.evaluations.length === 0);
11: 
12:   return (
13:     &lt;PageShell isLoading={isLoading} error={error} skeletonHeight={300}&gt;
14:       {isEmpty ? (
15:         &lt;SyncEmptyState
16:           title=&quot;No Trace Data&quot;
17:           description={&lt;&gt;No spans or evaluations found for trace &lt;code&gt;{traceId}&lt;/code&gt;&lt;/&gt;}
18:         /&gt;
19:       ) : (
20:         &lt;&gt;
21:           &lt;div className=&quot;eval-detail-header&quot;&gt;
22:             &lt;h2 className=&quot;text-lg&quot;&gt;Trace Detail&lt;/h2&gt;
23:             &lt;div className=&quot;eval-detail-meta&quot;&gt;
24:               &lt;span className=&quot;mono-xs text-secondary&quot;&gt;{traceId}&lt;/span&gt;
25:               &lt;span className=&quot;text-secondary text-xs&quot;&gt;
26:                 {data.spans.length} span{data.spans.length !== 1 ? &apos;s&apos; : &apos;&apos;} &amp;middot; {data.evaluations.length} evaluation{data.evaluations.length !== 1 ? &apos;s&apos; : &apos;&apos;}
27:               &lt;/span&gt;
28:             &lt;/div&gt;
29:           &lt;/div&gt;
30: 
31:           {data.evaluations.length &gt; 0 &amp;&amp; (
32:             &lt;div className=&quot;view-section&quot;&gt;
33:               &lt;h3 className=&quot;section-heading&quot;&gt;Evaluation Summary&lt;/h3&gt;
34:               &lt;div className=&quot;card&quot; style={{ padding: 16 }}&gt;
35:                 &lt;EvaluationEventOverlay evaluations={data.evaluations} traceId={traceId} /&gt;
36:               &lt;/div&gt;
37:             &lt;/div&gt;
38:           )}
39: 
40:           {data.spans.length &gt; 0 &amp;&amp; (
41:             &lt;div className=&quot;view-section&quot;&gt;
42:               &lt;h3 className=&quot;section-heading&quot;&gt;Span Hierarchy&lt;/h3&gt;
43:               &lt;div className=&quot;card&quot;&gt;
44:                 &lt;SpanTree
45:                   spans={data.spans}
46:                   evalsBySpan={buildEvalsBySpan(data.evaluations)}
47:                   maxDuration={data.spans.reduce((max, s) =&gt; Math.max(max, s.durationMs ?? 0), 1)}
48:                 /&gt;
49:               &lt;/div&gt;
50:             &lt;/div&gt;
51:           )}
52: 
53:           {data.spans.length === 0 &amp;&amp; data.evaluations.length &gt; 0 &amp;&amp; (
54:             &lt;div className=&quot;view-section&quot;&gt;
55:               &lt;div className=&quot;card text-muted text-xs&quot; style={{ padding: 16 }}&gt;
56:                 Span data not yet available for this trace. Evaluations are shown above.
57:               &lt;/div&gt;
58:             &lt;/div&gt;
59:           )}
60:         &lt;/&gt;
61:       )}
62:     &lt;/PageShell&gt;
63:   );
64: }
65: 
66: function buildEvalsBySpan(evaluations: Array&lt;{ spanId?: string }&gt;): Map&lt;string, number&gt; {
67:   const map = new Map&lt;string, number&gt;();
68:   for (const ev of evaluations) {
69:     if (ev.spanId) {
70:       map.set(ev.spanId, (map.get(ev.spanId) ?? 0) + 1);
71:     }
72:   }
73:   return map;
74: }</file><file path="src/pages/AgentSessionPage.tsx"> 1: import { useAgentSession } from &apos;../hooks/useAgentSession.js&apos;;
 2: import { TurnTimeline } from &apos;../components/TurnTimeline.js&apos;;
 3: import { HandoffCard } from &apos;../components/HandoffCard.js&apos;;
 4: import { AgentScoreSummary } from &apos;../components/AgentScoreSummary.js&apos;;
 5: import { PageShell } from &apos;../components/PageShell.js&apos;;
 6: import { plural } from &apos;../lib/quality-utils.js&apos;;
 7: 
 8: export function AgentSessionPage({ sessionId }: { sessionId: string }) {
 9:   const { data, isLoading, error } = useAgentSession(sessionId);
10: 
11:   if (!isLoading &amp;&amp; !error &amp;&amp; !data) return null;
12: 
13:   const evaluation = data?.evaluation;
14:   const turns = evaluation?.turns ?? [];
15:   const handoffs = evaluation?.handoffs ?? [];
16:   const agentNames = [...new Set(turns.map(t =&gt; t.agentName ?? &apos;unknown&apos;))];
17: 
18:   return (
19:     &lt;PageShell isLoading={isLoading} error={error} skeletonHeight={300}&gt;
20:       {data &amp;&amp; evaluation &amp;&amp; (
21:         &lt;&gt;
22:           &lt;div className=&quot;eval-detail-header&quot;&gt;
23:             &lt;h2 className=&quot;text-lg&quot;&gt;Agent Session&lt;/h2&gt;
24:             &lt;div className=&quot;eval-detail-meta&quot;&gt;
25:               &lt;span className=&quot;mono-xs text-secondary&quot;&gt;{sessionId}&lt;/span&gt;
26:               &lt;span className=&quot;text-secondary text-xs&quot;&gt;
27:                 {plural(evaluation.totalTurns, &apos;turn&apos;)} &amp;middot; {plural(agentNames.length, &apos;agent&apos;)}
28:               &lt;/span&gt;
29:             &lt;/div&gt;
30:           &lt;/div&gt;
31: 
32:           {/* Summary scores */}
33:           &lt;div className=&quot;card gap-6&quot; style={{ display: &apos;flex&apos;, flexWrap: &apos;wrap&apos;, padding: 16, marginBottom: 16, alignItems: &apos;flex-start&apos; }}&gt;
34:             &lt;AgentScoreSummary handoffScore={evaluation.handoffScore ?? 0} avgRelevance={evaluation.avgTurnRelevance ?? 0} completeness={evaluation.conversationCompleteness ?? 0} /&gt;
35:             {evaluation.errorPropagationTurns &gt; 0 &amp;&amp; (
36:               &lt;div style={{ textAlign: &apos;center&apos; }}&gt;
37:                 &lt;div className=&quot;mono-xs text-muted mb-1 uppercase&quot;&gt;Error Propagation&lt;/div&gt;
38:                 &lt;span className=&quot;mono text-md&quot; style={{ color: &apos;var(--status-critical)&apos; }}&gt;
39:                   {plural(evaluation.errorPropagationTurns, &apos;turn&apos;)}
40:                 &lt;/span&gt;
41:               &lt;/div&gt;
42:             )}
43:           &lt;/div&gt;
44: 
45:           {/* Turn timeline */}
46:           &lt;div className=&quot;view-section&quot;&gt;
47:             &lt;h3 className=&quot;section-heading&quot;&gt;Turn Timeline&lt;/h3&gt;
48:             &lt;div className=&quot;card&quot;&gt;
49:               &lt;TurnTimeline turns={turns} agentNames={agentNames} /&gt;
50:             &lt;/div&gt;
51:           &lt;/div&gt;
52: 
53:           {/* Handoffs */}
54:           {handoffs.length &gt; 0 &amp;&amp; (
55:             &lt;div className=&quot;view-section&quot;&gt;
56:               &lt;h3 className=&quot;section-heading&quot;&gt;Handoffs&lt;/h3&gt;
57:               &lt;div className=&quot;gap-2&quot; style={{ display: &apos;flex&apos;, flexDirection: &apos;column&apos; }}&gt;
58:                 {handoffs.map((h, i) =&gt; (
59:                   &lt;HandoffCard key={`${h.sourceAgent}-${h.targetAgent}-${i}`} handoff={h} /&gt;
60:                 ))}
61:               &lt;/div&gt;
62:             &lt;/div&gt;
63:           )}
64:         &lt;/&gt;
65:       )}
66:     &lt;/PageShell&gt;
67:   );
68: }</file><file path="src/pages/EvaluationDetailPage.tsx">  1: import { useTraceEvaluations } from &apos;../hooks/useTraceEvaluations.js&apos;;
  2: import { ScoreBadge } from &apos;../components/ScoreBadge.js&apos;;
  3: import { ChainOfThoughtPanel } from &apos;../components/ChainOfThoughtPanel.js&apos;;
  4: import { ProvenancePanel } from &apos;../components/ProvenancePanel.js&apos;;
  5: import { StepScoreChip } from &apos;../components/EvaluationExpandedRow.js&apos;;
  6: import { PageShell } from &apos;../components/PageShell.js&apos;;
  7: import { SyncEmptyState } from &apos;../components/SyncEmptyState.js&apos;;
  8: import { formatTimestamp } from &apos;../lib/quality-utils.js&apos;;
  9: import { Link, useSearch } from &apos;wouter&apos;;
 10: 
 11: export function EvaluationDetailPage({ traceId }: { traceId: string }) {
 12:   const { data: allEvaluations, isLoading, error } = useTraceEvaluations(traceId);
 13: 
 14:   const search = useSearch();
 15:   const metricFilter = new URLSearchParams(search).get(&apos;metric&apos;);
 16: 
 17:   const evaluations = metricFilter &amp;&amp; allEvaluations
 18:     ? allEvaluations.filter(ev =&gt; ev.evaluationName === metricFilter)
 19:     : allEvaluations;
 20: 
 21:   const heading = metricFilter
 22:     ? `${metricFilter} Evaluations`
 23:     : &apos;Trace Evaluations&apos;;
 24: 
 25:   return (
 26:     &lt;PageShell isLoading={isLoading} error={error} skeletonHeight={200}&gt;
 27:       {(!evaluations || evaluations.length === 0) ? (
 28:         &lt;SyncEmptyState
 29:           title=&quot;No Evaluations Found&quot;
 30:           description={&lt;&gt;No evaluations found for trace &lt;code&gt;{traceId}&lt;/code&gt;&lt;/&gt;}
 31:         /&gt;
 32:       ) : (
 33:         &lt;&gt;
 34:           &lt;div className=&quot;eval-detail-header&quot;&gt;
 35:             &lt;h2 className=&quot;text-lg&quot;&gt;{heading}&lt;/h2&gt;
 36:             &lt;div className=&quot;eval-detail-meta&quot;&gt;
 37:               &lt;span className=&quot;mono-xs text-secondary&quot;&gt;{traceId}&lt;/span&gt;
 38:               &lt;span className=&quot;text-secondary text-xs&quot;&gt;
 39:                 {evaluations.length} evaluation{evaluations.length !== 1 ? &apos;s&apos; : &apos;&apos;}
 40:               &lt;/span&gt;
 41:               &lt;Link href={`/traces/${traceId}`} style={{ fontSize: 12, color: &apos;var(--accent)&apos;, textDecoration: &apos;none&apos; }}&gt;
 42:                 View trace &amp;rarr;
 43:               &lt;/Link&gt;
 44:               {metricFilter &amp;&amp; (
 45:                 &lt;Link
 46:                   href={`/evaluations/trace/${traceId}`}
 47:                   style={{ fontSize: 12, color: &apos;var(--accent)&apos;, textDecoration: &apos;none&apos; }}
 48:                 &gt;
 49:                   View all evaluations
 50:                 &lt;/Link&gt;
 51:               )}
 52:             &lt;/div&gt;
 53:           &lt;/div&gt;
 54: 
 55:           {evaluations.map((ev, i) =&gt; (
 56:             &lt;div key={`${ev.evaluationName}-${ev.timestamp}-${i}`} className=&quot;eval-detail-card card&quot;&gt;
 57:               &lt;div className=&quot;flex-center mb-3&quot; style={{ justifyContent: &apos;space-between&apos; }}&gt;
 58:                 &lt;div className=&quot;flex-center gap-3&quot;&gt;
 59:                   &lt;ScoreBadge
 60:                     score={ev.scoreValue ?? null}
 61:                     metricName={ev.evaluationName}
 62:                     label={ev.scoreLabel ?? (ev.scoreValue != null ? ev.scoreValue.toFixed(4) : undefined)}
 63:                   /&gt;
 64:                   &lt;span className=&quot;text-base&quot; style={{ fontWeight: 500 }}&gt;{ev.evaluationName}&lt;/span&gt;
 65:                 &lt;/div&gt;
 66:                 &lt;span className=&quot;text-secondary text-xs&quot; title={new Date(ev.timestamp).toLocaleString()}&gt;
 67:                   {formatTimestamp(ev.timestamp)}
 68:                 &lt;/span&gt;
 69:               &lt;/div&gt;
 70: 
 71:               &lt;ChainOfThoughtPanel
 72:                 explanation={ev.explanation}
 73:                 evaluator={ev.evaluator}
 74:               /&gt;
 75: 
 76:               {ev.stepScores &amp;&amp; ev.stepScores.length &gt; 0 &amp;&amp; (
 77:                 &lt;div style={{ marginTop: 12 }}&gt;
 78:                   &lt;div className=&quot;section-label mb-1&quot;&gt;Step Scores&lt;/div&gt;
 79:                   &lt;div className=&quot;gap-1-5&quot; style={{ display: &apos;flex&apos;, flexWrap: &apos;wrap&apos;, marginTop: 4 }}&gt;
 80:                     {ev.stepScores.map(s =&gt; (
 81:                       &lt;StepScoreChip key={`${s.step}`} step={s.step} score={s.score} explanation={s.explanation} /&gt;
 82:                     ))}
 83:                   &lt;/div&gt;
 84:                 &lt;/div&gt;
 85:               )}
 86: 
 87:               &lt;details open style={{ marginTop: 12 }}&gt;
 88:                 &lt;summary className=&quot;cot-summary text-xs&quot;&gt;Provenance &amp;amp; Audit Trail&lt;/summary&gt;
 89:                 &lt;div style={{ paddingTop: 8 }}&gt;
 90:                   &lt;ProvenancePanel
 91:                     evaluationName={ev.evaluationName}
 92:                     scoreValue={ev.scoreValue}
 93:                     scoreLabel={ev.scoreLabel}
 94:                     traceId={ev.traceId ?? traceId}
 95:                     spanId={ev.spanId}
 96:                     sessionId={ev.sessionId}
 97:                     timestamp={ev.timestamp}
 98:                     evaluator={ev.evaluator}
 99:                     evaluatorType={ev.evaluatorType}
100:                     scoreUnit={ev.scoreUnit}
101:                     agentName={ev.agentName}
102:                     rawData={ev as unknown as Record&lt;string, unknown&gt;}
103:                   /&gt;
104:                 &lt;/div&gt;
105:               &lt;/details&gt;
106:             &lt;/div&gt;
107:           ))}
108:         &lt;/&gt;
109:       )}
110:     &lt;/PageShell&gt;
111:   );
112: }</file><file path="src/api/routes/agents.ts">  1: import { Hono } from &apos;hono&apos;;
  2: import { computeMultiAgentEvaluation } from &apos;../../../../dist/lib/quality-multi-agent.js&apos;;
  3: import { sanitizeErrorForResponse } from &apos;../../../../dist/lib/error-sanitizer.js&apos;;
  4: import { loadTracesBySessionId, loadEvaluationsByTraceIds } from &apos;../data-loader.js&apos;;
  5: import { queryTraces } from &apos;../../../../dist/tools/query-traces.js&apos;;
  6: import type { StepScore } from &apos;../../../../dist/backends/index.js&apos;;
  7: import { VALID_PERIODS, MAX_IDS, KNOWN_SOURCE_TYPES, HttpStatus } from &apos;../../lib/constants.js&apos;;
  8: 
  9: export const agentRoutes = new Hono();
 10: 
 11: agentRoutes.get(&apos;/agents&apos;, async (c) =&gt; {
 12:   const periodParam = c.req.query(&apos;period&apos;) ?? &apos;30d&apos;;
 13:   const periodDays = VALID_PERIODS[periodParam];
 14:   if (periodDays === undefined) {
 15:     return c.json({ error: `Invalid period value. Must be one of: ${Object.keys(VALID_PERIODS).join(&apos;, &apos;)}` }, HttpStatus.BadRequest);
 16:   }
 17:   const now = new Date();
 18:   const endDate = now.toISOString().split(&apos;T&apos;)[0];
 19:   const startDate = new Date(now.getTime() - periodDays * 24 * 60 * 60 * 1000).toISOString().split(&apos;T&apos;)[0];
 20: 
 21:   try {
 22:     const result = await queryTraces({
 23:       attributeFilter: { &apos;hook.name&apos;: &apos;agent-post-tool&apos; },
 24:       startDate,
 25:       endDate,
 26:       limit: 1000,
 27:     });
 28: 
 29:     // Build date bucket keys for the period (YYYY-MM-DD strings)
 30:     const dateBuckets: string[] = [];
 31:     for (let d = 0; d &lt; periodDays; d++) {
 32:       const day = new Date(now.getTime() - (periodDays - 1 - d) * 24 * 60 * 60 * 1000);
 33:       dateBuckets.push(day.toISOString().split(&apos;T&apos;)[0]);
 34:     }
 35:     const bucketIndex = new Map(dateBuckets.map((b, i) =&gt; [b, i]));
 36: 
 37:     // Phase 1: aggregate agent stats from spans (prototype-safe accumulators)
 38:     const acc: Record&lt;string, {
 39:       invocations: number;
 40:       errors: number;
 41:       rateLimitCount: number;
 42:       totalOutputSize: number;
 43:       sessions: Set&lt;string&gt;;
 44:       traceIds: Set&lt;string&gt;;
 45:       sourceTypes: Record&lt;string, number&gt;;
 46:       dailyCounts: number[];
 47:     }&gt; = Object.create(null);
 48: 
 49:     // Build traceId -&gt; agent names mapping for evaluation join
 50:     const traceToAgents = new Map&lt;string, Set&lt;string&gt;&gt;();
 51: 
 52:     for (const span of result.traces) {
 53:       const name = (span.attributes?.[&apos;gen_ai.agent.name&apos;] as string | undefined) ?? &apos;unknown&apos;;
 54:       if (!acc[name]) {
 55:         acc[name] = { invocations: 0, errors: 0, rateLimitCount: 0, totalOutputSize: 0, sessions: new Set(), traceIds: new Set(), sourceTypes: Object.create(null), dailyCounts: new Array(periodDays).fill(0) };
 56:       }
 57:       acc[name].invocations++;
 58:       // Bucket into daily counts
 59:       if (span.startTimeUnixNano) {
 60:         const dayKey = new Date(span.startTimeUnixNano / 1_000_000).toISOString().split(&apos;T&apos;)[0];
 61:         const idx = bucketIndex.get(dayKey);
 62:         if (idx !== undefined) acc[name].dailyCounts[idx]++;
 63:       }
 64:       if (span.attributes?.[&apos;agent.has_error&apos;]) acc[name].errors++;
 65:       if (span.attributes?.[&apos;agent.has_rate_limit&apos;]) acc[name].rateLimitCount++;
 66:       acc[name].totalOutputSize += (span.attributes?.[&apos;agent.output_size&apos;] as number | undefined) ?? 0;
 67:       const sid = span.attributes?.[&apos;session.id&apos;] as string | undefined;
 68:       if (sid) acc[name].sessions.add(sid);
 69:       if (span.traceId) {
 70:         acc[name].traceIds.add(span.traceId);
 71:         if (!traceToAgents.has(span.traceId)) traceToAgents.set(span.traceId, new Set());
 72:         traceToAgents.get(span.traceId)!.add(name);
 73:       }
 74:       const rawSrc = (span.attributes?.[&apos;agent.source_type&apos;] as string | undefined) ?? &apos;unknown&apos;;
 75:       const src = KNOWN_SOURCE_TYPES.has(rawSrc) ? rawSrc : &apos;other&apos;;
 76:       acc[name].sourceTypes[src] = (acc[name].sourceTypes[src] ?? 0) + 1;
 77:     }
 78: 
 79:     // Phase 2: load evaluations for all agent traceIds and join to agents
 80:     const allTraceIds = [...traceToAgents.keys()];
 81:     const evaluations = await loadEvaluationsByTraceIds(allTraceIds, startDate, endDate);
 82: 
 83:     // Accumulate per-agent evaluation scores by metric name (prototype-safe)
 84:     const agentEvalAcc: Record&lt;string, Record&lt;string, number[]&gt;&gt; = Object.create(null);
 85:     for (const ev of evaluations) {
 86:       if (!ev.traceId || ev.scoreValue == null || !Number.isFinite(ev.scoreValue)) continue;
 87:       const agentNames = traceToAgents.get(ev.traceId);
 88:       if (!agentNames) continue;
 89:       for (const agent of agentNames) {
 90:         if (!agentEvalAcc[agent]) agentEvalAcc[agent] = Object.create(null);
 91:         if (!agentEvalAcc[agent][ev.evaluationName]) agentEvalAcc[agent][ev.evaluationName] = [];
 92:         agentEvalAcc[agent][ev.evaluationName].push(ev.scoreValue);
 93:       }
 94:     }
 95: 
 96:     const agents = Object.entries(acc).map(([agentName, d]) =&gt; {
 97:       // Compute evaluation summary for this agent
 98:       const evalMetrics = agentEvalAcc[agentName] ?? {};
 99:       const evalSummary: Record&lt;string, { avg: number; min: number; max: number; count: number }&gt; = {};
100:       for (const [metric, scores] of Object.entries(evalMetrics)) {
101:         const sorted = [...scores].sort((a, b) =&gt; a - b);
102:         evalSummary[metric] = {
103:           avg: +(sorted.reduce((a, b) =&gt; a + b, 0) / sorted.length).toFixed(3),
104:           min: +sorted[0].toFixed(3),
105:           max: +sorted[sorted.length - 1].toFixed(3),
106:           count: sorted.length,
107:         };
108:       }
109: 
110:       const allSessionIds = [...d.sessions];
111:       const allTraceIdsList = [...d.traceIds];
112: 
113:       return {
114:         agentName,
115:         invocations: d.invocations,
116:         errors: d.errors,
117:         errorRate: d.invocations &gt; 0 ? +(d.errors / d.invocations).toFixed(3) : 0,
118:         rateLimitCount: d.rateLimitCount,
119:         avgOutputSize: d.invocations &gt; 0 ? Math.round(d.totalOutputSize / d.invocations) : 0,
120:         sessionCount: d.sessions.size,  // total unique sessions (invariant: &gt;= sessionIds.length)
121:         sessionIds: allSessionIds.slice(0, MAX_IDS),
122:         sessionIdsTruncated: allSessionIds.length &gt; MAX_IDS,
123:         traceIdsTotal: allTraceIdsList.length,
124:         traceIds: allTraceIdsList.slice(0, MAX_IDS),
125:         traceIdsTruncated: allTraceIdsList.length &gt; MAX_IDS,
126:         sourceTypes: d.sourceTypes,
127:         dailyCounts: d.dailyCounts,
128:         evalSummary,
129:       };
130:     }).sort((a, b) =&gt; b.invocations - a.invocations);
131: 
132:     return c.json({ period: periodParam, startDate, endDate, agents });
133:   } catch (err) {
134:     return c.json({ error: sanitizeErrorForResponse(err) }, HttpStatus.InternalServerError);
135:   }
136: });
137: 
138: /**
139:  * GET /api/agents/:sessionId
140:  * Loads spans for a session, builds agentMap, computes multi-agent evaluation.
141:  */
142: agentRoutes.get(&apos;/agents/:sessionId&apos;, async (c) =&gt; {
143:   const sessionId = c.req.param(&apos;sessionId&apos;);
144:   if (!sessionId) {
145:     return c.json({ error: &apos;sessionId is required&apos; }, HttpStatus.BadRequest);
146:   }
147: 
148:   try {
149:     const spans = await loadTracesBySessionId(sessionId);
150: 
151:     // Build agentMap from span attributes
152:     const agentMap = new Map&lt;number, string&gt;();
153:     const traceIds = new Set&lt;string&gt;();
154:     spans.forEach((span, i) =&gt; {
155:       const agent = span.attributes?.[&apos;agent.name&apos;] as string | undefined;
156:       if (agent) agentMap.set(i, agent);
157:       if (span.traceId) traceIds.add(span.traceId);
158:     });
159: 
160:     // Build step scores from spans
161:     const stepScores: StepScore[] = spans.map((span, i) =&gt; ({
162:       step: i,
163:       score: typeof span.attributes?.[&apos;evaluation.score&apos;] === &apos;number&apos;
164:         ? span.attributes[&apos;evaluation.score&apos;] as number
165:         : (span.status?.code === 2 ? 0 : 1),
166:       explanation: span.name,
167:     }));
168: 
169:     // Compute multi-agent evaluation
170:     const evaluation = computeMultiAgentEvaluation(stepScores, agentMap);
171: 
172:     // Bulk-load evaluations for all traces in the session
173:     const evaluations = await loadEvaluationsByTraceIds([...traceIds]);
174: 
175:     return c.json({
176:       sessionId,
177:       spans,
178:       evaluation,
179:       evaluations,
180:       agentMap: Object.fromEntries(agentMap),
181:     });
182:   } catch (err) {
183:     return c.json({ error: sanitizeErrorForResponse(err) }, HttpStatus.InternalServerError);
184:   }
185: });</file><file path="src/App.tsx">  1: import { useState, useCallback } from &apos;react&apos;;
  2: import { Route, Switch, Link, useLocation, Router } from &apos;wouter&apos;;
  3: import { ErrorBoundary } from &apos;react-error-boundary&apos;;
  4: import { Layout } from &apos;./components/Layout.js&apos;;
  5: import { RoleSelector } from &apos;./components/RoleSelector.js&apos;;
  6: import { KeyboardNavProvider, useShortcut } from &apos;./contexts/KeyboardNavContext.js&apos;;
  7: import { HealthOverview } from &apos;./components/HealthOverview.js&apos;;
  8: import { MetricGrid, MetricGridSkeleton } from &apos;./components/MetricGrid.js&apos;;
  9: import { AlertList } from &apos;./components/AlertList.js&apos;;
 10: import { SLATable } from &apos;./components/SLATable.js&apos;;
 11: import { ScoreHistogram } from &apos;./components/ScoreHistogram.js&apos;;
 12: import { EvaluationDetail } from &apos;./components/EvaluationDetail.js&apos;;
 13: import { StatusBadge, TrendIndicator, ConfidenceBadge } from &apos;./components/Indicators.js&apos;;
 14: import { TrendChart } from &apos;./components/TrendChart.js&apos;;
 15: import { TrendSeries } from &apos;./components/TrendSeries.js&apos;;
 16: import { ConfidencePanel } from &apos;./components/ConfidencePanel.js&apos;;
 17: import { CorrelationsPage } from &apos;./pages/CorrelationsPage.js&apos;;
 18: import { CoveragePage } from &apos;./pages/CoveragePage.js&apos;;
 19: import { PipelinePage } from &apos;./pages/PipelinePage.js&apos;;
 20: import { EvaluationDetailPage } from &apos;./pages/EvaluationDetailPage.js&apos;;
 21: import { CompliancePage } from &apos;./pages/CompliancePage.js&apos;;
 22: import { TraceDetailPage } from &apos;./pages/TraceDetailPage.js&apos;;
 23: import { AgentSessionPage } from &apos;./pages/AgentSessionPage.js&apos;;
 24: import { AgentsPage } from &apos;./pages/AgentsPage.js&apos;;
 25: import { SessionDetailPage } from &apos;./pages/SessionDetailPage.js&apos;;
 26: import { ExecutiveView } from &apos;./components/views/ExecutiveView.js&apos;;
 27: import { OperatorView } from &apos;./components/views/OperatorView.js&apos;;
 28: import { AuditorView } from &apos;./components/views/AuditorView.js&apos;;
 29: import { useDashboard } from &apos;./hooks/useDashboard.js&apos;;
 30: import { useMetricDetail } from &apos;./hooks/useMetricDetail.js&apos;;
 31: import { useTrend } from &apos;./hooks/useTrend.js&apos;;
 32: import { RoleProvider } from &apos;./contexts/RoleContext.js&apos;;
 33: import type {
 34:   Period,
 35:   QualityDashboardSummary,
 36:   RoleViewType,
 37:   ExecutiveView as ExecutiveViewType,
 38:   OperatorView as OperatorViewType,
 39:   AuditorView as AuditorViewType,
 40:   MetricDetailResult,
 41:   MetricDynamics,
 42: } from &apos;./types.js&apos;;
 43: 
 44: function DashboardPage({ period }: { period: Period }) {
 45:   const { data, isLoading, isFetching, error } = useDashboard(period);
 46: 
 47:   if (isLoading &amp;&amp; !data) return &lt;MetricGridSkeleton /&gt;;
 48:   if (error &amp;&amp; !data) return &lt;div className=&quot;error-state&quot;&gt;&lt;h2&gt;Failed to load&lt;/h2&gt;&lt;p&gt;{error.message}&lt;/p&gt;&lt;/div&gt;;
 49: 
 50:   if (!data || (&apos;role&apos; in data)) return &lt;MetricGridSkeleton /&gt;;
 51:   const dashboard = data;
 52:   const sparklines = (data as QualityDashboardSummary &amp; { sparklines?: Record&lt;string, (number | null)[]&gt; }).sparklines;
 53: 
 54:   if (dashboard.overallStatus === &apos;no_data&apos;) {
 55:     return (
 56:       &lt;div className=&quot;empty-state&quot;&gt;
 57:         &lt;h2&gt;No Evaluation Data&lt;/h2&gt;
 58:         &lt;p&gt;No evaluations found for the selected period.&lt;/p&gt;
 59:         &lt;p style={{ marginTop: 8 }}&gt;
 60:           Run evaluations using the &lt;code&gt;obs_inject_evaluations&lt;/code&gt; tool to see metrics here.
 61:         &lt;/p&gt;
 62:       &lt;/div&gt;
 63:     );
 64:   }
 65: 
 66:   return (
 67:     &lt;&gt;
 68:       {isFetching &amp;&amp; data &amp;&amp; &lt;div className=&quot;refetch-indicator&quot;&gt;Updating...&lt;/div&gt;}
 69:       &lt;HealthOverview dashboard={dashboard} /&gt;
 70:       &lt;MetricGrid metrics={dashboard.metrics} sparklines={sparklines} /&gt;
 71:       {dashboard.alerts.length &gt; 0 &amp;&amp; (
 72:         &lt;div className=&quot;view-section&quot;&gt;
 73:           &lt;h3 className=&quot;section-heading&quot;&gt;Active Alerts&lt;/h3&gt;
 74:           &lt;AlertList alerts={dashboard.alerts} /&gt;
 75:         &lt;/div&gt;
 76:       )}
 77:       {dashboard.slaCompliance &amp;&amp; dashboard.slaCompliance.length &gt; 0 &amp;&amp; (
 78:         &lt;div className=&quot;view-section&quot;&gt;
 79:           &lt;h3 className=&quot;section-heading&quot;&gt;SLA Compliance&lt;/h3&gt;
 80:           &lt;SLATable slas={dashboard.slaCompliance} /&gt;
 81:         &lt;/div&gt;
 82:       )}
 83:     &lt;/&gt;
 84:   );
 85: }
 86: 
 87: function RolePage({ role, period }: { role: RoleViewType; period: Period }) {
 88:   const { data, isLoading, error } = useDashboard(period, role);
 89: 
 90:   if (isLoading &amp;&amp; !data) return &lt;MetricGridSkeleton /&gt;;
 91:   if (error &amp;&amp; !data) return &lt;div className=&quot;error-state&quot;&gt;&lt;h2&gt;Failed to load&lt;/h2&gt;&lt;p&gt;{error.message}&lt;/p&gt;&lt;/div&gt;;
 92:   if (!data || !(&apos;role&apos; in data)) return &lt;MetricGridSkeleton /&gt;;
 93: 
 94:   switch (data.role) {
 95:     case &apos;executive&apos;:
 96:       return &lt;ExecutiveView data={data} /&gt;;
 97:     case &apos;operator&apos;:
 98:       return &lt;OperatorView data={data} /&gt;;
 99:     case &apos;auditor&apos;:
100:       return &lt;AuditorView data={data} /&gt;;
101:     default:
102:       return null;
103:   }
104: }
105: 
106: function MetricDetailPage({ name, period }: { name: string; period: Period }) {
107:   const { data, isLoading, error } = useMetricDetail(name, period);
108:   const { data: trendData } = useTrend(name, period, 10);
109: 
110:   if (isLoading) {
111:     return (
112:       &lt;div&gt;
113:         &lt;Link href=&quot;/&quot; className=&quot;back-link&quot;&gt;&amp;larr; Back to dashboard&lt;/Link&gt;
114:         &lt;div className=&quot;card skeleton&quot; style={{ height: 300 }} /&gt;
115:       &lt;/div&gt;
116:     );
117:   }
118:   if (error) {
119:     return (
120:       &lt;div&gt;
121:         &lt;Link href=&quot;/&quot; className=&quot;back-link&quot;&gt;&amp;larr; Back to dashboard&lt;/Link&gt;
122:         &lt;div className=&quot;error-state&quot;&gt;&lt;h2&gt;Failed to load&lt;/h2&gt;&lt;p&gt;{error.message}&lt;/p&gt;&lt;/div&gt;
123:       &lt;/div&gt;
124:     );
125:   }
126: 
127:   if (!data) return null;
128:   const detail = data;
129: 
130:   return (
131:     &lt;div&gt;
132:       &lt;Link href=&quot;/&quot; className=&quot;back-link&quot;&gt;&amp;larr; Back to dashboard&lt;/Link&gt;
133:       &lt;div className=&quot;card&quot; style={{ marginBottom: 24 }}&gt;
134:         &lt;div className=&quot;metric-card-header&quot;&gt;
135:           &lt;h2 className=&quot;text-lg&quot;&gt;{detail.displayName}&lt;/h2&gt;
136:           &lt;StatusBadge status={detail.status} /&gt;
137:         &lt;/div&gt;
138:         &lt;div className=&quot;gap-8&quot; style={{ display: &apos;flex&apos;, marginTop: 12, flexWrap: &apos;wrap&apos; }}&gt;
139:           {([&apos;avg&apos;, &apos;min&apos;, &apos;max&apos;, &apos;p50&apos;, &apos;p95&apos;, &apos;p99&apos;] as const).map((key) =&gt; {
140:             const val = detail.values[key];
141:             return (
142:               &lt;div key={key} style={{ textAlign: &apos;center&apos; }}&gt;
143:                 &lt;div className=&quot;mono-xl font-semibold&quot;&gt;
144:                   {val !== null &amp;&amp; val !== undefined ? val.toFixed(4) : &apos;N/A&apos;}
145:                 &lt;/div&gt;
146:                 &lt;div className=&quot;text-secondary text-xs uppercase&quot;&gt;{key}&lt;/div&gt;
147:               &lt;/div&gt;
148:             );
149:           })}
150:           &lt;div style={{ textAlign: &apos;center&apos; }}&gt;
151:             &lt;div className=&quot;mono-xl font-semibold&quot;&gt;{detail.sampleCount}&lt;/div&gt;
152:             &lt;div className=&quot;text-secondary text-xs uppercase&quot;&gt;samples&lt;/div&gt;
153:           &lt;/div&gt;
154:         &lt;/div&gt;
155:         &lt;div className=&quot;flex-center gap-4&quot; style={{ marginTop: 12 }}&gt;
156:           &lt;TrendIndicator trend={detail.trend} /&gt;
157:           &lt;ConfidenceBadge confidence={detail.confidence} /&gt;
158:         &lt;/div&gt;
159:       &lt;/div&gt;
160: 
161:       {detail.confidence &amp;&amp; (
162:         &lt;div className=&quot;view-section&quot;&gt;
163:           &lt;h3 className=&quot;section-heading&quot;&gt;Confidence Analysis&lt;/h3&gt;
164:           &lt;div className=&quot;card&quot;&gt;
165:             &lt;ConfidencePanel confidence={detail.confidence} /&gt;
166:           &lt;/div&gt;
167:         &lt;/div&gt;
168:       )}
169: 
170:       &lt;div className=&quot;view-section&quot;&gt;
171:         &lt;h3 className=&quot;section-heading&quot;&gt;Trend&lt;/h3&gt;
172:         &lt;div className=&quot;card&quot;&gt;
173:           &lt;TrendChart
174:             trend={detail.trend}
175:             dynamics={(detail as MetricDetailResult &amp; { dynamics?: MetricDynamics }).dynamics}
176:             warningThreshold={detail.alerts.find(a =&gt; a.severity === &apos;warning&apos;)?.threshold}
177:             criticalThreshold={detail.alerts.find(a =&gt; a.severity === &apos;critical&apos;)?.threshold}
178:             metricName={detail.displayName}
179:           /&gt;
180:         &lt;/div&gt;
181:       &lt;/div&gt;
182: 
183:       {trendData &amp;&amp; trendData.trendData.length &gt; 0 &amp;&amp; (
184:         &lt;div className=&quot;view-section&quot;&gt;
185:           &lt;h3 className=&quot;section-heading&quot;&gt;
186:             Time Series ({trendData.totalEvaluations} evaluations)
187:             {trendData.narrowed &amp;&amp; (
188:               &lt;span className=&quot;text-muted text-xs&quot; style={{
189:                 fontWeight: 400,
190:                 marginLeft: 8,
191:               }}&gt;auto-narrowed to data range&lt;/span&gt;
192:             )}
193:           &lt;/h3&gt;
194:           &lt;div className=&quot;card&quot;&gt;
195:             &lt;TrendSeries data={trendData.trendData} metricName={detail.displayName} /&gt;
196:           &lt;/div&gt;
197:         &lt;/div&gt;
198:       )}
199: 
200:       {detail.alerts.length &gt; 0 &amp;&amp; (
201:         &lt;div className=&quot;view-section&quot;&gt;
202:           &lt;h3 className=&quot;section-heading&quot;&gt;Alerts&lt;/h3&gt;
203:           &lt;AlertList alerts={detail.alerts} /&gt;
204:         &lt;/div&gt;
205:       )}
206: 
207:       &lt;div className=&quot;view-section&quot;&gt;
208:         &lt;h3 className=&quot;section-heading&quot;&gt;Score Distribution&lt;/h3&gt;
209:         &lt;div className=&quot;card&quot;&gt;
210:           &lt;ScoreHistogram distribution={detail.scoreDistribution} /&gt;
211:         &lt;/div&gt;
212:       &lt;/div&gt;
213: 
214:       &lt;div className=&quot;view-section&quot;&gt;
215:         &lt;h3 className=&quot;section-heading&quot;&gt;Evaluations&lt;/h3&gt;
216:         &lt;div className=&quot;card&quot;&gt;
217:           &lt;EvaluationDetail worst={detail.worstEvaluations} best={detail.bestEvaluations} metricName={name} period={period} /&gt;
218:         &lt;/div&gt;
219:       &lt;/div&gt;
220:     &lt;/div&gt;
221:   );
222: }
223: 
224: function RouteErrorFallback({ error, resetErrorBoundary }: { error: Error; resetErrorBoundary: () =&gt; void }) {
225:   return (
226:     &lt;div className=&quot;error-state&quot;&gt;
227:       &lt;h2&gt;Something went wrong&lt;/h2&gt;
228:       &lt;p&gt;{error.message}&lt;/p&gt;
229:       &lt;div className=&quot;error-actions&quot;&gt;
230:         &lt;button onClick={resetErrorBoundary}&gt;Try again&lt;/button&gt;
231:         &lt;Link href=&quot;/&quot;&gt;Back to dashboard&lt;/Link&gt;
232:       &lt;/div&gt;
233:     &lt;/div&gt;
234:   );
235: }
236: 
237: function GlobalShortcuts({ setPeriod, navigate }: {
238:   setPeriod: (p: Period) =&gt; void;
239:   navigate: (path: string) =&gt; void;
240: }) {
241:   useShortcut(&apos;1&apos;, &apos;Switch to 24h&apos;, &apos;Period&apos;, useCallback(() =&gt; setPeriod(&apos;24h&apos;), [setPeriod]));
242:   useShortcut(&apos;2&apos;, &apos;Switch to 7d&apos;, &apos;Period&apos;, useCallback(() =&gt; setPeriod(&apos;7d&apos;), [setPeriod]));
243:   useShortcut(&apos;3&apos;, &apos;Switch to 30d&apos;, &apos;Period&apos;, useCallback(() =&gt; setPeriod(&apos;30d&apos;), [setPeriod]));
244:   useShortcut(&apos;g h&apos;, &apos;Go to home&apos;, &apos;Navigation&apos;, useCallback(() =&gt; navigate(&apos;/&apos;), [navigate]));
245:   useShortcut(&apos;g c&apos;, &apos;Go to correlations&apos;, &apos;Navigation&apos;, useCallback(() =&gt; navigate(&apos;/correlations&apos;), [navigate]));
246:   useShortcut(&apos;g p&apos;, &apos;Go to pipeline&apos;, &apos;Navigation&apos;, useCallback(() =&gt; navigate(&apos;/pipeline&apos;), [navigate]));
247:   useShortcut(&apos;g v&apos;, &apos;Go to coverage&apos;, &apos;Navigation&apos;, useCallback(() =&gt; navigate(&apos;/coverage&apos;), [navigate]));
248:   useShortcut(&apos;g a&apos;, &apos;Go to agents&apos;, &apos;Navigation&apos;, useCallback(() =&gt; navigate(&apos;/agents&apos;), [navigate]));
249:   return null;
250: }
251: 
252: const BASE_PATH = import.meta.env.BASE_URL.replace(/\/$/, &apos;&apos;) || &apos;&apos;;
253: 
254: export function App() {
255:   const [period, setPeriod] = useState&lt;Period&gt;(&apos;30d&apos;);
256:   const [location, navigate] = useLocation();
257: 
258:   return (
259:     &lt;Router base={BASE_PATH}&gt;
260:     &lt;KeyboardNavProvider&gt;
261:     &lt;RoleProvider&gt;
262:     &lt;GlobalShortcuts setPeriod={setPeriod} navigate={navigate} /&gt;
263:     &lt;Layout period={period} onPeriodChange={setPeriod}&gt;
264:       &lt;RoleSelector /&gt;
265:       &lt;Switch&gt;
266:         &lt;Route path=&quot;/&quot;&gt;
267:           &lt;ErrorBoundary FallbackComponent={RouteErrorFallback} resetKeys={[location]}&gt;
268:             &lt;DashboardPage period={period} /&gt;
269:           &lt;/ErrorBoundary&gt;
270:         &lt;/Route&gt;
271:         &lt;Route path=&quot;/role/:roleName&quot;&gt;
272:           {(params) =&gt; (
273:             &lt;ErrorBoundary FallbackComponent={RouteErrorFallback} resetKeys={[location]}&gt;
274:               &lt;RolePage role={params.roleName as RoleViewType} period={period} /&gt;
275:             &lt;/ErrorBoundary&gt;
276:           )}
277:         &lt;/Route&gt;
278:         &lt;Route path=&quot;/metrics/:metricName&quot;&gt;
279:           {(params) =&gt; (
280:             &lt;ErrorBoundary FallbackComponent={RouteErrorFallback} resetKeys={[location]}&gt;
281:               &lt;MetricDetailPage name={params.metricName} period={period} /&gt;
282:             &lt;/ErrorBoundary&gt;
283:           )}
284:         &lt;/Route&gt;
285:         &lt;Route path=&quot;/evaluations/trace/:traceId&quot;&gt;
286:           {(params) =&gt; (
287:             &lt;ErrorBoundary FallbackComponent={RouteErrorFallback} resetKeys={[location]}&gt;
288:               &lt;EvaluationDetailPage traceId={params.traceId} /&gt;
289:             &lt;/ErrorBoundary&gt;
290:           )}
291:         &lt;/Route&gt;
292:         &lt;Route path=&quot;/correlations&quot;&gt;
293:           &lt;ErrorBoundary FallbackComponent={RouteErrorFallback} resetKeys={[location]}&gt;
294:             &lt;CorrelationsPage period={period} /&gt;
295:           &lt;/ErrorBoundary&gt;
296:         &lt;/Route&gt;
297:         &lt;Route path=&quot;/coverage&quot;&gt;
298:           &lt;ErrorBoundary FallbackComponent={RouteErrorFallback} resetKeys={[location]}&gt;
299:             &lt;CoveragePage period={period} /&gt;
300:           &lt;/ErrorBoundary&gt;
301:         &lt;/Route&gt;
302:         &lt;Route path=&quot;/pipeline&quot;&gt;
303:           &lt;ErrorBoundary FallbackComponent={RouteErrorFallback} resetKeys={[location]}&gt;
304:             &lt;PipelinePage period={period} /&gt;
305:           &lt;/ErrorBoundary&gt;
306:         &lt;/Route&gt;
307:         &lt;Route path=&quot;/compliance&quot;&gt;
308:           &lt;ErrorBoundary FallbackComponent={RouteErrorFallback} resetKeys={[location]}&gt;
309:             &lt;CompliancePage period={period} /&gt;
310:           &lt;/ErrorBoundary&gt;
311:         &lt;/Route&gt;
312:         &lt;Route path=&quot;/agents&quot;&gt;
313:           &lt;ErrorBoundary FallbackComponent={RouteErrorFallback} resetKeys={[location]}&gt;
314:             &lt;AgentsPage period={period} /&gt;
315:           &lt;/ErrorBoundary&gt;
316:         &lt;/Route&gt;
317:         &lt;Route path=&quot;/traces/:traceId&quot;&gt;
318:           {(params) =&gt; (
319:             &lt;ErrorBoundary FallbackComponent={RouteErrorFallback} resetKeys={[location]}&gt;
320:               &lt;TraceDetailPage traceId={params.traceId} /&gt;
321:             &lt;/ErrorBoundary&gt;
322:           )}
323:         &lt;/Route&gt;
324:         &lt;Route path=&quot;/agents/:sessionId&quot;&gt;
325:           {(params) =&gt; (
326:             &lt;ErrorBoundary FallbackComponent={RouteErrorFallback} resetKeys={[location]}&gt;
327:               &lt;AgentSessionPage sessionId={params.sessionId} /&gt;
328:             &lt;/ErrorBoundary&gt;
329:           )}
330:         &lt;/Route&gt;
331:         &lt;Route path=&quot;/sessions/:sessionId&quot;&gt;
332:           {(params) =&gt; (
333:             &lt;ErrorBoundary FallbackComponent={RouteErrorFallback} resetKeys={[location]}&gt;
334:               &lt;SessionDetailPage sessionId={params.sessionId} /&gt;
335:             &lt;/ErrorBoundary&gt;
336:           )}
337:         &lt;/Route&gt;
338:         &lt;Route&gt;
339:           &lt;div className=&quot;empty-state&quot;&gt;
340:             &lt;h2&gt;Page Not Found&lt;/h2&gt;
341:             &lt;p&gt;&lt;Link href=&quot;/&quot;&gt;Go to dashboard&lt;/Link&gt;&lt;/p&gt;
342:           &lt;/div&gt;
343:         &lt;/Route&gt;
344:       &lt;/Switch&gt;
345:     &lt;/Layout&gt;
346:     &lt;/RoleProvider&gt;
347:     &lt;/KeyboardNavProvider&gt;
348:     &lt;/Router&gt;
349:   );
350: }</file><file path="src/pages/SessionDetailPage.tsx">  1: import { type ReactNode } from &apos;react&apos;;
  2: import { Link } from &apos;wouter&apos;;
  3: import { useSessionDetail, SessionNotFoundError } from &apos;../hooks/useSessionDetail.js&apos;;
  4: import { EvaluationTable, evalToRow, type EvalRow } from &apos;../components/EvaluationTable.js&apos;;
  5: import { ScoreBadge } from &apos;../components/ScoreBadge.js&apos;;
  6: import { AgentScoreSummary } from &apos;../components/AgentScoreSummary.js&apos;;
  7: import { PageShell } from &apos;../components/PageShell.js&apos;;
  8: import { Section, type SectionHealth } from &apos;../components/Section.js&apos;;
  9: import { SCORE_COLORS, scoreColorBand, shortPath, fmtBytes, truncateText, plural } from &apos;../lib/quality-utils.js&apos;;
 10: import {
 11:   HALLUCINATION_SCORE_THRESHOLD,
 12:   MAX_ERROR_ROWS,
 13:   MAX_HALLUCINATION_ROWS,
 14:   MAX_FAILED_EVAL_ROWS,
 15:   SCORE_DISPLAY_PRECISION,
 16: } from &apos;../lib/constants.js&apos;;
 17: 
 18: // ─── Stat chip ───────────────────────────────────────────────────────────────
 19: 
 20: function Stat({ label, value, color }: { label: string; value: string | number; color?: string }) {
 21:   return (
 22:     &lt;div style={{ textAlign: &apos;center&apos;, flex: &apos;1 1 100px&apos;, minWidth: 80 }}&gt;
 23:       &lt;div className=&quot;mono&quot; style={{
 24:         fontSize: 22,
 25:         fontWeight: 700,
 26:         color: color ?? &apos;var(--text-primary)&apos;,
 27:         lineHeight: 1.1,
 28:       }}&gt;{value}&lt;/div&gt;
 29:       &lt;div className=&quot;stat-label&quot; style={{ letterSpacing: &apos;0.1em&apos;, marginTop: 3 }}&gt;{label}&lt;/div&gt;
 30:     &lt;/div&gt;
 31:   );
 32: }
 33: 
 34: // ─── Frequency bar ───────────────────────────────────────────────────────────
 35: 
 36: function FreqBar({ label, count, max, color }: { label: string; count: number; max: number; color?: string }) {
 37:   const pct = max &gt; 0 ? (count / max) * 100 : 0;
 38:   return (
 39:     &lt;div className=&quot;flex-center mb-1-5 gap-2-5&quot;&gt;
 40:       &lt;div className=&quot;mono-xs text-secondary&quot; style={{
 41:         width: 160,
 42:         textAlign: &apos;right&apos;,
 43:         flexShrink: 0,
 44:         overflow: &apos;hidden&apos;,
 45:         textOverflow: &apos;ellipsis&apos;,
 46:         whiteSpace: &apos;nowrap&apos;,
 47:       }}&gt;{label}&lt;/div&gt;
 48:       &lt;div style={{ flex: 1, background: &apos;var(--bg-elevated)&apos;, borderRadius: 2, height: 6, overflow: &apos;hidden&apos; }}&gt;
 49:         &lt;div style={{
 50:           width: `${pct}%`,
 51:           height: &apos;100%&apos;,
 52:           background: color ?? &apos;var(--accent)&apos;,
 53:           borderRadius: 2,
 54:           transition: &apos;width 0.4s ease&apos;,
 55:         }} /&gt;
 56:       &lt;/div&gt;
 57:       &lt;div className=&quot;mono-xs text-muted&quot; style={{
 58:         width: 36,
 59:         textAlign: &apos;right&apos;,
 60:         flexShrink: 0,
 61:       }}&gt;{count}&lt;/div&gt;
 62:     &lt;/div&gt;
 63:   );
 64: }
 65: 
 66: // ─── Issue callout ───────────────────────────────────────────────────────────
 67: 
 68: function IssueCallout({ severity, title, children }: {
 69:   severity: &apos;warning&apos; | &apos;critical&apos;;
 70:   title: string;
 71:   children: ReactNode;
 72: }) {
 73:   const color = severity === &apos;critical&apos; ? &apos;var(--status-critical)&apos; : &apos;var(--status-warning)&apos;;
 74:   return (
 75:     &lt;div style={{
 76:       borderLeft: `3px solid ${color}`,
 77:       background: severity === &apos;critical&apos; ? &apos;rgba(240,68,56,0.06)&apos; : &apos;rgba(229,160,13,0.06)&apos;,
 78:       borderRadius: &apos;0 var(--radius) var(--radius) 0&apos;,
 79:       padding: &apos;10px 14px&apos;,
 80:       marginBottom: 10,
 81:     }}&gt;
 82:       &lt;div className=&quot;mono-xs uppercase font-semibold&quot; style={{
 83:         color,
 84:         marginBottom: 4,
 85:       }}&gt;{title}&lt;/div&gt;
 86:       &lt;div className=&quot;text-secondary text-xs&quot; style={{ lineHeight: 1.6 }}&gt;
 87:         {children}
 88:       &lt;/div&gt;
 89:     &lt;/div&gt;
 90:   );
 91: }
 92: 
 93: 
 94: interface TableColumn {
 95:   label: string;
 96:   align?: &apos;left&apos; | &apos;right&apos; | &apos;center&apos;;
 97: }
 98: 
 99: function MonoTableHead({ columns }: { columns: TableColumn[] }) {
100:   return (
101:     &lt;thead&gt;
102:       &lt;tr style={{ borderBottom: &apos;1px solid var(--border)&apos; }}&gt;
103:         {columns.map(({ label, align = &apos;right&apos; }) =&gt; (
104:           &lt;th key={label} className=&quot;text-muted tracking-wide&quot; style={{ padding: &apos;5px 10px&apos;, textAlign: align, fontWeight: 500, whiteSpace: &apos;nowrap&apos; }}&gt;
105:             {label.toUpperCase()}
106:           &lt;/th&gt;
107:         ))}
108:       &lt;/tr&gt;
109:     &lt;/thead&gt;
110:   );
111: }
112: 
113: function FreqBarGrid({ entries, max, color }: {
114:   entries: [string, number][];
115:   max: number;
116:   color?: string;
117: }) {
118:   return (
119:     &lt;div className=&quot;freq-grid&quot;&gt;
120:       {[...entries]
121:         .sort((a, b) =&gt; b[1] - a[1])
122:         .map(([key, count]) =&gt; (
123:           &lt;FreqBar key={key} label={key} count={count} max={max} color={color} /&gt;
124:         ))
125:       }
126:     &lt;/div&gt;
127:   );
128: }
129: 
130: // ─── Main page ───────────────────────────────────────────────────────────────
131: 
132: export function SessionDetailPage({ sessionId }: { sessionId: string }) {
133:   const { data, isLoading, error } = useSessionDetail(sessionId);
134:   const isNotSynced = !isLoading &amp;&amp; error instanceof SessionNotFoundError;
135: 
136:   if (isLoading || (!isNotSynced &amp;&amp; error)) {
137:     return &lt;PageShell isLoading={isLoading} error={error ?? null} skeletonHeight={400}&gt;{null}&lt;/PageShell&gt;;
138:   }
139: 
140:   if (isNotSynced) {
141:     return (
142:       &lt;div&gt;
143:         &lt;Link href=&quot;/&quot; className=&quot;back-link&quot;&gt;&amp;larr; Back to dashboard&lt;/Link&gt;
144:         &lt;div className=&quot;card&quot; style={{ padding: &apos;32px 24px&apos;, textAlign: &apos;center&apos; }}&gt;
145:           &lt;div className=&quot;mono-xs mb-1-5 uppercase&quot; style={{
146:             color: &apos;var(--status-warning)&apos;,
147:           }}&gt;Session Not Yet Available&lt;/div&gt;
148:           &lt;div className=&quot;mono-xs text-secondary&quot; style={{
149:             lineHeight: 1.6,
150:             maxWidth: 480,
151:             margin: &apos;0 auto&apos;,
152:           }}&gt;
153:             This session has not been synced to the dashboard KV store yet.
154:             Data is synced periodically &amp;mdash; check back after the next pipeline run.
155:           &lt;/div&gt;
156:           &lt;div className=&quot;mono-xs text-muted&quot; style={{
157:             marginTop: 12,
158:             wordBreak: &apos;break-all&apos;,
159:           }}&gt;{sessionId}&lt;/div&gt;
160:         &lt;/div&gt;
161:       &lt;/div&gt;
162:     );
163:   }
164: 
165:   if (!data) return null;
166: 
167:   const {
168:     dataSources, timespan, sessionInfo, tokenTotals, toolUsage, mcpUsage,
169:     agentActivity, fileAccess, gitCommits, tokenProgression, spanBreakdown,
170:     hookLatency, alertSummary, codeStructure, errors, evaluationBreakdown,
171:     multiAgentEvaluation, evaluations,
172:   } = data;
173: 
174:   const si = sessionInfo ?? {
175:     projectName: &apos;unknown&apos;, workingDirectory: &apos;&apos;, gitRepository: &apos;&apos;, gitBranch: &apos;&apos;,
176:     nodeVersion: &apos;&apos;, resumeCount: 0, initialMessageCount: 0, initialContextTokens: 0,
177:     finalMessageCount: 0, taskCount: 0, uncommittedAtStart: 0,
178:   };
179:   const spanCount = dataSources.traces.count;
180:   const errorDetails = errors.details;
181: 
182:   // Derive computed values
183:   const totalToolCalls = Object.values(toolUsage).reduce((a, b) =&gt; a + b, 0);
184:   const totalMcpCalls = Object.values(mcpUsage).reduce((a, b) =&gt; a + b, 0);
185:   const maxTokenSnapshot = tokenProgression.at(-1);
186:   const maxToolCount = Math.max(...Object.values(toolUsage), 1);
187:   const maxMcpCount = Math.max(...Object.values(mcpUsage), 1);
188:   const maxFileCount = fileAccess[0]?.count ?? 1;
189:   const maxSpanCount = Math.max(...Object.values(spanBreakdown), 1);
190: 
191:   // Issue detection
192:   const hallucinationEvals = evaluations.filter(e =&gt;
193:     (e.evaluationName ?? &apos;&apos;).toLowerCase().includes(&apos;hallucin&apos;) ||
194:     ((e.scoreLabel ?? &apos;&apos;).toLowerCase() === &apos;fail&apos; &amp;&amp; typeof e.scoreValue === &apos;number&apos; &amp;&amp; e.scoreValue &lt; HALLUCINATION_SCORE_THRESHOLD)
195:   );
196:   const failedEvals = evaluations.filter(e =&gt;
197:     (e.scoreLabel ?? &apos;&apos;).toLowerCase() === &apos;fail&apos;
198:   );
199:   const errorCount = errorDetails.length;
200:   const hasIssues = alertSummary.totalFired &gt; 0 || errorCount &gt; 0 ||
201:     hallucinationEvals.length &gt; 0 || failedEvals.length &gt; 0;
202:   const issueHealth: SectionHealth = errorCount &gt; 0 || hallucinationEvals.length &gt; 0
203:     ? &apos;crit&apos;
204:     : alertSummary.totalFired &gt; 0 || failedEvals.length &gt; 0
205:     ? &apos;warn&apos;
206:     : &apos;ok&apos;;
207: 
208:   // Score interpretation
209:   const evaluation = multiAgentEvaluation;
210:   const handoffScore = evaluation.handoffScore ?? 0;
211:   const avgRelevance = evaluation.avgTurnRelevance ?? 0;
212:   const completeness = evaluation.conversationCompleteness ?? 0;
213:   const evalRows: EvalRow[] = evaluations.map(evalToRow);
214: 
215:   // Unique models used
216:   const models = [...new Set(tokenProgression.map(t =&gt; t.model).filter(Boolean))];
217: 
218:   return (
219:     &lt;div style={{ maxWidth: 1100 }}&gt;
220:       &lt;Link href=&quot;/&quot; className=&quot;back-link&quot;&gt;&amp;larr; Back to dashboard&lt;/Link&gt;
221: 
222:       {/* ── Header ── */}
223:       &lt;div style={{
224:         background: &apos;var(--bg-card)&apos;,
225:         border: &apos;1px solid var(--border-subtle)&apos;,
226:         borderBottom: &apos;none&apos;,
227:         padding: &apos;20px 24px 16px&apos;,
228:         marginBottom: 0,
229:       }}&gt;
230:         &lt;div className=&quot;gap-4&quot; style={{ display: &apos;flex&apos;, alignItems: &apos;flex-start&apos;, justifyContent: &apos;space-between&apos;, flexWrap: &apos;wrap&apos; }}&gt;
231:           &lt;div&gt;
232:             &lt;div className=&quot;mono text-muted mb-1-5 text-2xs uppercase&quot;&gt;Session Detail&lt;/div&gt;
233:             &lt;div className=&quot;mono font-semibold text-base&quot; style={{
234:               color: &apos;var(--accent-hover)&apos;,
235:               letterSpacing: &apos;0.02em&apos;,
236:               marginBottom: 8,
237:               wordBreak: &apos;break-all&apos;,
238:             }}&gt;{sessionId}&lt;/div&gt;
239:             &lt;div className=&quot;text-secondary text-xs gap-4&quot; style={{ display: &apos;flex&apos;, flexWrap: &apos;wrap&apos; }}&gt;
240:               &lt;span&gt;{si.projectName}&lt;/span&gt;
241:               {si.gitRepository &amp;&amp; (
242:                 &lt;span style={{ color: &apos;var(--text-muted)&apos; }}&gt;
243:                   {si.gitRepository}
244:                   {si.gitBranch ? ` · ${si.gitBranch}` : &apos;&apos;}
245:                 &lt;/span&gt;
246:               )}
247:               {si.resumeCount &gt; 1 &amp;&amp; (
248:                 &lt;span className=&quot;mono text-2xs chip uppercase&quot; style={{
249:                   background: &apos;var(--accent-muted)&apos;,
250:                   color: &apos;var(--accent-hover)&apos;,
251:                 }}&gt;RESUMED ×{si.resumeCount}&lt;/span&gt;
252:               )}
253:               {models.map(m =&gt; (
254:                 &lt;span key={m} className=&quot;mono text-2xs text-muted chip&quot; style={{
255:                   background: &apos;var(--bg-elevated)&apos;,
256:                   border: &apos;1px solid var(--border-subtle)&apos;,
257:                 }}&gt;{m}&lt;/span&gt;
258:               ))}
259:             &lt;/div&gt;
260:           &lt;/div&gt;
261:         &lt;/div&gt;
262:       &lt;/div&gt;
263: 
264:       {/* ── Vitals strip ── */}
265:       &lt;div style={{
266:         display: &apos;flex&apos;,
267:         gap: 0,
268:         background: &apos;var(--bg-elevated)&apos;,
269:         border: &apos;1px solid var(--border-subtle)&apos;,
270:         borderBottom: &apos;1px solid var(--border)&apos;,
271:         padding: &apos;14px 24px&apos;,
272:         flexWrap: &apos;wrap&apos;,
273:         rowGap: 12,
274:         marginBottom: 2,
275:       }}&gt;
276:         &lt;Stat label=&quot;Spans&quot; value={spanCount} /&gt;
277:         &lt;div className=&quot;vitals-divider&quot; /&gt;
278:         &lt;Stat label=&quot;Tool calls&quot; value={totalToolCalls} /&gt;
279:         &lt;div className=&quot;vitals-divider&quot; /&gt;
280:         &lt;Stat label=&quot;MCP calls&quot; value={totalMcpCalls} /&gt;
281:         &lt;div className=&quot;vitals-divider&quot; /&gt;
282:         &lt;Stat label=&quot;Commits&quot; value={gitCommits.length} color={gitCommits.length &gt; 0 ? &apos;var(--status-healthy)&apos; : undefined} /&gt;
283:         &lt;div className=&quot;vitals-divider&quot; /&gt;
284:         &lt;Stat label=&quot;Alerts fired&quot; value={alertSummary.totalFired} color={alertSummary.totalFired &gt; 0 ? &apos;var(--status-warning)&apos; : undefined} /&gt;
285:         &lt;div className=&quot;vitals-divider&quot; /&gt;
286:         &lt;Stat label=&quot;Errors&quot; value={errorCount} color={errorCount &gt; 0 ? &apos;var(--status-critical)&apos; : undefined} /&gt;
287:         {maxTokenSnapshot &amp;&amp; (
288:           &lt;&gt;
289:             &lt;div className=&quot;vitals-divider&quot; /&gt;
290:             &lt;Stat label=&quot;Messages&quot; value={maxTokenSnapshot.messages} /&gt;
291:             &lt;div className=&quot;vitals-divider&quot; /&gt;
292:             &lt;Stat label=&quot;Output tokens&quot; value={fmtBytes(maxTokenSnapshot.outputTokens)} /&gt;
293:           &lt;/&gt;
294:         )}
295:       &lt;/div&gt;
296: 
297:       {/* ── Issues &amp; Anomalies ── */}
298:       &lt;Section
299:         title=&quot;Issues &amp; Anomalies&quot;
300:         badge={hasIssues ? `${[
301:           alertSummary.totalFired &gt; 0 &amp;&amp; `${alertSummary.totalFired} alerts`,
302:           errorCount &gt; 0 &amp;&amp; `${errorCount} errors`,
303:           hallucinationEvals.length &gt; 0 &amp;&amp; `${hallucinationEvals.length} hallucinations`,
304:           failedEvals.length &gt; 0 &amp;&amp; `${failedEvals.length} failures`,
305:         ].filter(Boolean).join(&apos; · &apos;)}` : &apos;clean&apos;}
306:         health={issueHealth}
307:         defaultOpen={hasIssues}
308:       &gt;
309:         {!hasIssues &amp;&amp; (
310:           &lt;div className=&quot;mono-xs&quot; style={{ color: &apos;var(--status-healthy)&apos; }}&gt;
311:             No issues detected in this session.
312:           &lt;/div&gt;
313:         )}
314: 
315:         {alertSummary.totalFired &gt; 0 &amp;&amp; (
316:           &lt;IssueCallout severity=&quot;warning&quot; title={`${plural(alertSummary.totalFired, &apos;alert&apos;)} fired across ${plural(alertSummary.stopEvents, &apos;stop event&apos;)}`}&gt;
317:             &lt;strong&gt;task-completion-low&lt;/strong&gt; — The task completion ratio fell below 0.85.
318:             This fires when tasks are created but not marked complete before the session ends.
319:             Common causes: work deferred to backlog, sub-tasks spawned but not resolved,
320:             or tasks marked in-progress but not completed within the session.
321:           &lt;/IssueCallout&gt;
322:         )}
323: 
324:         {errorCount &gt; 0 &amp;&amp; (
325:           &lt;IssueCallout severity=&quot;critical&quot; title={plural(errorCount, &apos;error span&apos;)}&gt;
326:             &lt;div style={{ marginBottom: 8 }}&gt;Tool invocations or agent calls that reported errors:&lt;/div&gt;
327:             {errorDetails.slice(0, MAX_ERROR_ROWS).map((e, i) =&gt; (
328:               &lt;div key={i} className=&quot;mono-xs&quot; style={{ marginBottom: 4 }}&gt;
329:                 &lt;span style={{ color: &apos;var(--status-critical)&apos; }}&gt;✗&lt;/span&gt;{&apos; &apos;}
330:                 {e.spanName}{e.tool ? ` (${e.tool})` : &apos;&apos;}{e.filePath ? ` · ${shortPath(e.filePath)}` : &apos;&apos;}
331:                 {e.errorType &amp;&amp; e.errorType !== &apos;unknown&apos; &amp;&amp; &lt;span style={{ color: &apos;var(--text-muted)&apos; }}&gt; — {e.errorType}&lt;/span&gt;}
332:               &lt;/div&gt;
333:             ))}
334:             {errorCount &gt; MAX_ERROR_ROWS &amp;&amp; (
335:               &lt;div className=&quot;text-muted text-xs&quot; style={{ marginTop: 4 }}&gt;
336:                 +{errorCount - MAX_ERROR_ROWS} more
337:               &lt;/div&gt;
338:             )}
339:           &lt;/IssueCallout&gt;
340:         )}
341: 
342:         {hallucinationEvals.length &gt; 0 &amp;&amp; (
343:           &lt;IssueCallout severity=&quot;critical&quot; title={`${plural(hallucinationEvals.length, &apos;hallucination indicator&apos;)} detected`}&gt;
344:             &lt;div style={{ marginBottom: 8 }}&gt;
345:               Evaluations flagging potential hallucination or very low confidence:
346:             &lt;/div&gt;
347:             {hallucinationEvals.slice(0, MAX_HALLUCINATION_ROWS).map((e, i) =&gt; (
348:               &lt;div key={i} className=&quot;flex-center gap-2-5 mb-1-5&quot;&gt;
349:                 &lt;ScoreBadge score={typeof e.scoreValue === &apos;number&apos; ? e.scoreValue : 0} metricName={e.evaluationName ?? &apos;hallucination&apos;} /&gt;
350:                 &lt;div&gt;
351:                   &lt;div className=&quot;mono-xs&quot;&gt;{e.evaluationName}&lt;/div&gt;
352:                   {e.explanation &amp;&amp; (
353:                     &lt;div className=&quot;text-muted text-xs&quot; style={{ marginTop: 2 }}&gt;
354:                       {truncateText(e.explanation, 200)}
355:                     &lt;/div&gt;
356:                   )}
357:                 &lt;/div&gt;
358:               &lt;/div&gt;
359:             ))}
360:           &lt;/IssueCallout&gt;
361:         )}
362: 
363:         {failedEvals.length &gt; 0 &amp;&amp; !hallucinationEvals.length &amp;&amp; (
364:           &lt;IssueCallout severity=&quot;warning&quot; title={`${plural(failedEvals.length, &apos;evaluation&apos;)} marked fail`}&gt;
365:             {failedEvals.slice(0, MAX_FAILED_EVAL_ROWS).map((e, i) =&gt; (
366:               &lt;div key={i} className=&quot;mono-xs&quot; style={{ marginBottom: 3 }}&gt;
367:                 &lt;span style={{ color: &apos;var(--status-warning)&apos; }}&gt;⚠&lt;/span&gt;{&apos; &apos;}
368:                 {e.evaluationName} — score {typeof e.scoreValue === &apos;number&apos; ? e.scoreValue.toFixed(SCORE_DISPLAY_PRECISION) : &apos;N/A&apos;}
369:               &lt;/div&gt;
370:             ))}
371:           &lt;/IssueCallout&gt;
372:         )}
373: 
374:         {evaluation.errorPropagationTurns &gt; 0 &amp;&amp; (
375:           &lt;IssueCallout severity=&quot;warning&quot; title={plural(evaluation.errorPropagationTurns, &apos;error propagation turn&apos;)}&gt;
376:             Errors detected in the multi-agent turn sequence may have propagated across agent handoffs.
377:           &lt;/IssueCallout&gt;
378:         )}
379:       &lt;/Section&gt;
380: 
381:       {/* ── Token Journey ── */}
382:       &lt;Section
383:         title=&quot;Token Journey&quot;
384:         badge={maxTokenSnapshot ? `${maxTokenSnapshot.messages} msg · ${fmtBytes(maxTokenSnapshot.outputTokens)} out` : &apos;no data&apos;}
385:         health=&quot;neutral&quot;
386:       &gt;
387:         {tokenProgression.length === 0 ? (
388:           &lt;div className=&quot;text-muted text-xs&quot;&gt;No token snapshots recorded.&lt;/div&gt;
389:         ) : (
390:           &lt;div style={{ overflowX: &apos;auto&apos; }}&gt;
391:             &lt;table className=&quot;mono-xs&quot; style={{
392:               width: &apos;100%&apos;, borderCollapse: &apos;collapse&apos;,
393:             }}&gt;
394:               &lt;MonoTableHead columns={[
395:                 { label: &apos;Messages&apos; }, { label: &apos;Input&apos; }, { label: &apos;Output&apos; },
396:                 { label: &apos;Cache Read&apos; }, { label: &apos;Cache Create&apos; }, { label: &apos;Model&apos; },
397:               ]} /&gt;
398:               &lt;tbody&gt;
399:                 {tokenProgression.map((t, i) =&gt; (
400:                   &lt;tr key={i} style={{ borderBottom: &apos;1px solid var(--border-subtle)&apos; }}&gt;
401:                     &lt;td style={{ padding: &apos;5px 12px&apos;, textAlign: &apos;right&apos; }}&gt;{t.messages}&lt;/td&gt;
402:                     &lt;td className=&quot;text-secondary&quot; style={{ padding: &apos;5px 12px&apos;, textAlign: &apos;right&apos; }}&gt;{fmtBytes(t.inputTokens)}&lt;/td&gt;
403:                     &lt;td style={{ padding: &apos;5px 12px&apos;, textAlign: &apos;right&apos;, color: &apos;var(--accent-hover)&apos; }}&gt;{fmtBytes(t.outputTokens)}&lt;/td&gt;
404:                     &lt;td style={{ padding: &apos;5px 12px&apos;, textAlign: &apos;right&apos;, color: &apos;var(--text-muted)&apos; }}&gt;{fmtBytes(t.cacheRead)}&lt;/td&gt;
405:                     &lt;td style={{ padding: &apos;5px 12px&apos;, textAlign: &apos;right&apos;, color: &apos;var(--text-muted)&apos; }}&gt;{fmtBytes(t.cacheCreation)}&lt;/td&gt;
406:                     &lt;td style={{ padding: &apos;5px 12px&apos;, textAlign: &apos;right&apos;, color: &apos;var(--text-muted)&apos; }}&gt;{t.model}&lt;/td&gt;
407:                   &lt;/tr&gt;
408:                 ))}
409:               &lt;/tbody&gt;
410:             &lt;/table&gt;
411:           &lt;/div&gt;
412:         )}
413:       &lt;/Section&gt;
414: 
415:       {/* ── Tool Activity ── */}
416:       &lt;Section
417:         title=&quot;Tool Activity&quot;
418:         badge={`${totalToolCalls} calls · ${Object.keys(toolUsage).length} tools`}
419:         health=&quot;neutral&quot;
420:       &gt;
421:         &lt;FreqBarGrid entries={Object.entries(toolUsage)} max={maxToolCount} /&gt;
422: 
423:         {totalMcpCalls &gt; 0 &amp;&amp; (
424:           &lt;&gt;
425:             &lt;div className=&quot;stat-label&quot; style={{ letterSpacing: &apos;0.12em&apos;, margin: &apos;14px 0 8px&apos; }}&gt;
426:               MCP Tools — {totalMcpCalls} calls
427:             &lt;/div&gt;
428:             &lt;FreqBarGrid entries={Object.entries(mcpUsage)} max={maxMcpCount} color=&quot;var(--status-healthy)&quot; /&gt;
429:           &lt;/&gt;
430:         )}
431:       &lt;/Section&gt;
432: 
433:       {/* ── Agent Activity ── */}
434:       {agentActivity.length &gt; 0 &amp;&amp; (
435:         &lt;Section
436:           title=&quot;Agent Activity&quot;
437:           badge={agentActivity.map(a =&gt; `${a.agentName} ×${a.invocations}`).join(&apos; · &apos;)}
438:           health={agentActivity.some(a =&gt; a.errors &gt; 0) ? &apos;warn&apos; : &apos;neutral&apos;}
439:         &gt;
440:           &lt;div className=&quot;gap-2-5&quot; style={{ display: &apos;grid&apos;, gridTemplateColumns: &apos;repeat(auto-fill, minmax(220px, 1fr))&apos; }}&gt;
441:             {agentActivity.map(a =&gt; (
442:               &lt;div key={a.agentName} style={{
443:                 background: &apos;var(--bg-elevated)&apos;,
444:                 border: `1px solid ${a.errors &gt; 0 ? &apos;var(--status-warning)&apos; : &apos;var(--border-subtle)&apos;}`,
445:                 borderRadius: &apos;var(--radius)&apos;,
446:                 padding: &apos;10px 14px&apos;,
447:               }}&gt;
448:                 &lt;div className=&quot;mono-xs mb-1-5 font-semibold&quot;&gt;
449:                   {a.agentName}
450:                 &lt;/div&gt;
451:                 &lt;div className=&quot;gap-3&quot; style={{ display: &apos;flex&apos;, flexWrap: &apos;wrap&apos; }}&gt;
452:                   &lt;div&gt;
453:                     &lt;div className=&quot;mono text-md&quot; style={{ fontWeight: 700 }}&gt;{a.invocations}&lt;/div&gt;
454:                     &lt;div className=&quot;stat-label&quot;&gt;invocations&lt;/div&gt;
455:                   &lt;/div&gt;
456:                   {a.errors &gt; 0 &amp;&amp; (
457:                     &lt;div&gt;
458:                       &lt;div className=&quot;mono text-md&quot; style={{ fontWeight: 700, color: &apos;var(--status-warning)&apos; }}&gt;{a.errors}&lt;/div&gt;
459:                       &lt;div className=&quot;stat-label&quot;&gt;errors&lt;/div&gt;
460:                     &lt;/div&gt;
461:                   )}
462:                   &lt;div&gt;
463:                     &lt;div className=&quot;mono text-md&quot; style={{ fontWeight: 700 }}&gt;{fmtBytes(a.avgOutputSize)}&lt;/div&gt;
464:                     &lt;div className=&quot;stat-label&quot;&gt;avg output&lt;/div&gt;
465:                   &lt;/div&gt;
466:                 &lt;/div&gt;
467:                 {a.hasRateLimit &amp;&amp; (
468:                   &lt;div className=&quot;mono&quot; style={{ marginTop: 8, fontSize: &apos;var(--font-size-2xs)&apos;, color: &apos;var(--status-warning)&apos; }}&gt;
469:                     ⚠ Hit rate limit
470:                   &lt;/div&gt;
471:                 )}
472:               &lt;/div&gt;
473:             ))}
474:           &lt;/div&gt;
475: 
476:           {/* Multi-agent evaluation scores */}
477:           &lt;div style={{ marginTop: 16 }}&gt;
478:             &lt;AgentScoreSummary handoffScore={handoffScore} avgRelevance={avgRelevance} completeness={completeness} /&gt;
479:           &lt;/div&gt;
480:         &lt;/Section&gt;
481:       )}
482: 
483:       {/* ── Files Accessed ── */}
484:       {fileAccess.length &gt; 0 &amp;&amp; (
485:         &lt;Section
486:           title=&quot;Files Accessed&quot;
487:           badge={`${fileAccess.length} files · top: ${shortPath(fileAccess[0]?.path ?? &apos;&apos;)}`}
488:           health=&quot;neutral&quot;
489:         &gt;
490:           &lt;div style={{ columns: &apos;2 320px&apos;, columnGap: 32 }}&gt;
491:             {fileAccess.map(({ path, count }) =&gt; (
492:               &lt;div key={path} style={{ breakInside: &apos;avoid&apos; }}&gt;
493:                 &lt;FreqBar
494:                   label={shortPath(path)}
495:                   count={count}
496:                   max={maxFileCount}
497:                   color=&quot;var(--accent)&quot;
498:                 /&gt;
499:               &lt;/div&gt;
500:             ))}
501:           &lt;/div&gt;
502:         &lt;/Section&gt;
503:       )}
504: 
505:       {/* ── Git Commits ── */}
506:       {gitCommits.length &gt; 0 &amp;&amp; (
507:         &lt;Section
508:           title=&quot;Git Commits&quot;
509:           badge={plural(gitCommits.length, &apos;commit&apos;)}
510:           health=&quot;ok&quot;
511:         &gt;
512:           &lt;div className=&quot;gap-half&quot; style={{ display: &apos;flex&apos;, flexDirection: &apos;column&apos; }}&gt;
513:             {gitCommits.map((commit, i) =&gt; {
514:               const commitFiles = commit.files?.split(&apos; &apos;) ?? [];
515:               return (
516:                 &lt;details key={i} style={{ borderBottom: &apos;1px solid var(--border-subtle)&apos; }}&gt;
517:                   &lt;summary className=&quot;flex-center gap-2-5&quot; style={{
518:                     padding: &apos;8px 4px&apos;,
519:                     cursor: &apos;pointer&apos;,
520:                     listStyle: &apos;none&apos;,
521:                   }}&gt;
522:                     &lt;span style={{ color: &apos;var(--status-healthy)&apos;, fontSize: &apos;var(--font-size-2xs)&apos;, flexShrink: 0 }}&gt;●&lt;/span&gt;
523:                     &lt;span className=&quot;mono-xs font-semibold&quot; style={{ flex: 1 }}&gt;
524:                       {commit.subject}
525:                     &lt;/span&gt;
526:                     {commitFiles.length &gt; 0 &amp;&amp; (
527:                       &lt;span style={{ fontSize: &apos;var(--font-size-2xs)&apos;, color: &apos;var(--text-muted)&apos;, flexShrink: 0 }}&gt;
528:                         {plural(commitFiles.length, &apos;file&apos;)}
529:                       &lt;/span&gt;
530:                     )}
531:                   &lt;/summary&gt;
532:                   &lt;div style={{ paddingLeft: 20, paddingBottom: 10 }}&gt;
533:                     {commit.body &amp;&amp; (
534:                       &lt;div className=&quot;text-secondary text-xs&quot; style={{
535:                         lineHeight: 1.6, marginBottom: 8,
536:                         fontFamily: &apos;var(--font-body)&apos;,
537:                       }}&gt;
538:                         {commit.body}
539:                       &lt;/div&gt;
540:                     )}
541:                     {commitFiles.length &gt; 0 &amp;&amp; (
542:                       &lt;div style={{ fontFamily: &apos;var(--font-mono)&apos;, fontSize: &apos;var(--font-size-2xs)&apos;, color: &apos;var(--text-muted)&apos; }}&gt;
543:                         {commitFiles.map((f, fi) =&gt; (
544:                           &lt;div key={fi}&gt;{shortPath(f)}&lt;/div&gt;
545:                         ))}
546:                       &lt;/div&gt;
547:                     )}
548:                   &lt;/div&gt;
549:                 &lt;/details&gt;
550:               );
551:             })}
552:           &lt;/div&gt;
553:         &lt;/Section&gt;
554:       )}
555: 
556:       {/* ── Code Quality ── */}
557:       {codeStructure.length &gt; 0 &amp;&amp; (
558:         &lt;Section
559:           title=&quot;Code Quality&quot;
560:           badge={`${plural(codeStructure.length, &apos;file&apos;)} analyzed`}
561:           health={codeStructure.some(f =&gt; f.score &lt; 0.6) ? &apos;warn&apos; : &apos;ok&apos;}
562:         &gt;
563:           &lt;div style={{ overflowX: &apos;auto&apos; }}&gt;
564:             &lt;table className=&quot;mono-xs&quot; style={{ width: &apos;100%&apos;, borderCollapse: &apos;collapse&apos; }}&gt;
565:               &lt;MonoTableHead columns={[
566:                 { label: &apos;File&apos;, align: &apos;left&apos; }, { label: &apos;Tool&apos;, align: &apos;left&apos; },
567:                 { label: &apos;Lines&apos; }, { label: &apos;Exports&apos; }, { label: &apos;Functions&apos; },
568:                 { label: &apos;Types&apos; }, { label: &apos;Score&apos; },
569:               ]} /&gt;
570:               &lt;tbody&gt;
571:                 {codeStructure.map((f, i) =&gt; (
572:                   &lt;tr key={i} style={{ borderBottom: &apos;1px solid var(--border-subtle)&apos; }}&gt;
573:                     &lt;td className=&quot;text-secondary&quot; style={{ padding: &apos;5px 10px&apos; }}&gt;{shortPath(f.file)}&lt;/td&gt;
574:                     &lt;td className=&quot;text-muted&quot; style={{ padding: &apos;5px 10px&apos; }}&gt;{f.tool}&lt;/td&gt;
575:                     &lt;td style={{ padding: &apos;5px 10px&apos;, textAlign: &apos;right&apos; }}&gt;{f.lines}&lt;/td&gt;
576:                     &lt;td style={{ padding: &apos;5px 10px&apos;, textAlign: &apos;right&apos;, color: &apos;var(--text-muted)&apos; }}&gt;{f.exports}&lt;/td&gt;
577:                     &lt;td style={{ padding: &apos;5px 10px&apos;, textAlign: &apos;right&apos;, color: &apos;var(--text-muted)&apos; }}&gt;{f.functions}&lt;/td&gt;
578:                     &lt;td style={{ padding: &apos;5px 10px&apos;, textAlign: &apos;center&apos; }}&gt;{f.hasTypes ? &apos;✓&apos; : &apos;·&apos;}&lt;/td&gt;
579:                     &lt;td className=&quot;font-semibold&quot; style={{ padding: &apos;5px 10px&apos;, textAlign: &apos;right&apos;, color: SCORE_COLORS[scoreColorBand(f.score)] }}&gt;
580:                       {f.score.toFixed(2)}
581:                     &lt;/td&gt;
582:                   &lt;/tr&gt;
583:                 ))}
584:               &lt;/tbody&gt;
585:             &lt;/table&gt;
586:           &lt;/div&gt;
587:         &lt;/Section&gt;
588:       )}
589: 
590:       {/* ── Span Breakdown ── */}
591:       &lt;Section
592:         title=&quot;Span Breakdown&quot;
593:         badge={`${spanCount} total · ${Object.keys(spanBreakdown).length} types`}
594:         health=&quot;neutral&quot;
595:       &gt;
596:         &lt;FreqBarGrid entries={Object.entries(spanBreakdown)} max={maxSpanCount} color=&quot;var(--border-accent)&quot; /&gt;
597:       &lt;/Section&gt;
598: 
599:       {/* ── Evaluations ── */}
600:       &lt;Section
601:         title=&quot;Evaluations&quot;
602:         badge={evalRows.length &gt; 0 ? plural(evalRows.length, &apos;result&apos;) : &apos;none&apos;}
603:         health={hallucinationEvals.length &gt; 0 ? &apos;crit&apos; : failedEvals.length &gt; 0 ? &apos;warn&apos; : evalRows.length &gt; 0 ? &apos;ok&apos; : &apos;neutral&apos;}
604:       &gt;
605:         {evalRows.length === 0 ? (
606:           &lt;div className=&quot;text-muted text-xs&quot;&gt;
607:             No evaluations recorded for this session.
608:           &lt;/div&gt;
609:         ) : (
610:           &lt;EvaluationTable evaluations={evalRows} /&gt;
611:         )}
612:       &lt;/Section&gt;
613:     &lt;/div&gt;
614:   );
615: }</file><file path="src/components/AgentActivityPanel.tsx">  1: import { Fragment, useCallback, useMemo, useState } from &apos;react&apos;;
  2: import { Link } from &apos;wouter&apos;;
  3: import type { AgentStat, EvalMetricSummary } from &apos;../hooks/useAgentStats.js&apos;;
  4: import { scoreColorBand, SCORE_COLORS, truncateId } from &apos;../lib/quality-utils.js&apos;;
  5: import { AGENT_PALETTE, ERROR_RATE_WARNING_THRESHOLD } from &apos;../lib/constants.js&apos;;
  6: import { Sparkline } from &apos;./Sparkline.js&apos;;
  7: 
  8: const COLUMN_COUNT = 7;
  9: const RATE_LIMIT_BADGE_BG = &apos;var(--bg-status-warning)&apos;;
 10: 
 11: type SortKey = &apos;invocations&apos; | &apos;errorRate&apos; | &apos;sessionCount&apos; | &apos;avgOutputSize&apos;;
 12: 
 13: function errorRateColor(rate: number): string {
 14:   if (rate === 0) return &apos;var(--status-healthy)&apos;;
 15:   if (rate &lt; ERROR_RATE_WARNING_THRESHOLD) return &apos;var(--status-warning)&apos;;
 16:   return &apos;var(--status-critical)&apos;;
 17: }
 18: 
 19: function formatBytes(n: number): string {
 20:   if (n === 0) return &apos;\u2014&apos;;
 21:   if (n &lt; 1024) return `${n}B`;
 22:   return `${(n / 1024).toFixed(1)}K`;
 23: }
 24: 
 25: interface AgentActivityPanelProps {
 26:   agents: AgentStat[];
 27: }
 28: 
 29: export function AgentActivityPanel({ agents }: AgentActivityPanelProps) {
 30:   const [sort, setSort] = useState&lt;SortKey&gt;(&apos;invocations&apos;);
 31:   const [asc, setAsc] = useState(false);
 32:   const [expanded, setExpanded] = useState&lt;string | null&gt;(null);
 33: 
 34:   const colorIndex = useMemo(
 35:     () =&gt; new Map(agents.map((a, i) =&gt; [a.agentName, AGENT_PALETTE[i % AGENT_PALETTE.length]])),
 36:     [agents],
 37:   );
 38: 
 39:   // React 18+ batches both setState calls in event handlers atomically
 40:   const toggleSort = useCallback((key: SortKey) =&gt; {
 41:     if (key === sort) {
 42:       setAsc(v =&gt; !v);
 43:     } else {
 44:       setSort(key);
 45:       setAsc(false);
 46:     }
 47:   }, [sort]);
 48: 
 49:   if (agents.length === 0) {
 50:     return (
 51:       &lt;div className=&quot;text-muted&quot; style={{ padding: &apos;32px 0&apos;, textAlign: &apos;center&apos; }}&gt;
 52:         No agent activity recorded for this period.
 53:       &lt;/div&gt;
 54:     );
 55:   }
 56: 
 57:   const maxInvocations = Math.max(...agents.map(a =&gt; a.invocations), 1);
 58: 
 59:   const sorted = [...agents].sort((a, b) =&gt; {
 60:     const diff = a[sort] &lt; b[sort] ? -1 : a[sort] &gt; b[sort] ? 1 : 0;
 61:     return asc ? diff : -diff;
 62:   });
 63: 
 64:   const sortIndicator = (key: SortKey) =&gt;
 65:     sort === key ? (asc ? &apos; \u2191&apos; : &apos; \u2193&apos;) : &apos;&apos;;
 66: 
 67:   return (
 68:     &lt;div style={{ overflowX: &apos;auto&apos; }}&gt;
 69:       &lt;table className=&quot;sla-table&quot; style={{ minWidth: 640 }}&gt;
 70:         &lt;thead&gt;
 71:           &lt;tr&gt;
 72:             &lt;th style={{ width: &apos;30%&apos; }}&gt;Agent&lt;/th&gt;
 73:             &lt;th style={{ cursor: &apos;pointer&apos;, userSelect: &apos;none&apos; }} onClick={() =&gt; toggleSort(&apos;invocations&apos;)}&gt;
 74:               Invocations{sortIndicator(&apos;invocations&apos;)}
 75:             &lt;/th&gt;
 76:             &lt;th style={{ cursor: &apos;pointer&apos;, userSelect: &apos;none&apos; }} onClick={() =&gt; toggleSort(&apos;errorRate&apos;)}&gt;
 77:               Error Rate{sortIndicator(&apos;errorRate&apos;)}
 78:             &lt;/th&gt;
 79:             &lt;th style={{ cursor: &apos;pointer&apos;, userSelect: &apos;none&apos; }} onClick={() =&gt; toggleSort(&apos;sessionCount&apos;)}&gt;
 80:               Sessions{sortIndicator(&apos;sessionCount&apos;)}
 81:             &lt;/th&gt;
 82:             &lt;th style={{ cursor: &apos;pointer&apos;, userSelect: &apos;none&apos; }} onClick={() =&gt; toggleSort(&apos;avgOutputSize&apos;)}&gt;
 83:               Avg Output{sortIndicator(&apos;avgOutputSize&apos;)}
 84:             &lt;/th&gt;
 85:             &lt;th&gt;Rate Limits&lt;/th&gt;
 86:             &lt;th&gt;Source&lt;/th&gt;
 87:           &lt;/tr&gt;
 88:         &lt;/thead&gt;
 89:         &lt;tbody&gt;
 90:           {sorted.map((agent) =&gt; {
 91:             const color = colorIndex.get(agent.agentName) ?? AGENT_PALETTE[0];
 92:             const errColor = errorRateColor(agent.errorRate);
 93:             const invPct = (agent.invocations / maxInvocations) * 100;
 94:             const topSource = Object.entries(agent.sourceTypes).sort((a, b) =&gt; b[1] - a[1])[0]?.[0];
 95:             const isExpanded = expanded === agent.agentName;
 96:             const hasLinks = agent.sessionIds.length &gt; 0 || agent.traceIds.length &gt; 0;
 97: 
 98:             return (
 99:               &lt;Fragment key={agent.agentName}&gt;
100:                 &lt;tr
101:                   className={isExpanded ? &apos;eval-row-expanded&apos; : &apos;&apos;}
102:                   style={{ verticalAlign: &apos;middle&apos;, cursor: hasLinks ? &apos;pointer&apos; : undefined }}
103:                   onClick={() =&gt; hasLinks &amp;&amp; setExpanded(isExpanded ? null : agent.agentName)}
104:                 &gt;
105:                   {/* Agent name with color accent */}
106:                   &lt;td&gt;
107:                     &lt;div className=&quot;flex-center gap-2&quot;&gt;
108:                       {hasLinks &amp;&amp; (
109:                         &lt;span style={{
110:                           fontSize: &apos;var(--font-size-2xs)&apos;,
111:                           color: &apos;var(--text-muted)&apos;,
112:                           transition: &apos;transform 0.15s&apos;,
113:                           transform: isExpanded ? &apos;rotate(90deg)&apos; : &apos;none&apos;,
114:                           flexShrink: 0,
115:                         }}&gt;
116:                           &amp;#9654;
117:                         &lt;/span&gt;
118:                       )}
119:                       &lt;span style={{
120:                         display: &apos;inline-block&apos;,
121:                         width: 8,
122:                         height: 8,
123:                         borderRadius: &apos;50%&apos;,
124:                         background: color,
125:                         flexShrink: 0,
126:                       }} /&gt;
127:                       &lt;span className=&quot;mono-xs&quot; style={{
128:                         color: &apos;var(--text-primary)&apos;,
129:                         wordBreak: &apos;break-all&apos;,
130:                       }}&gt;
131:                         {agent.agentName}
132:                       &lt;/span&gt;
133:                     &lt;/div&gt;
134:                   &lt;/td&gt;
135: 
136:                   {/* Invocations with inline bar */}
137:                   &lt;td&gt;
138:                     &lt;div className=&quot;flex-center gap-2&quot;&gt;
139:                       &lt;span className=&quot;mono-xs&quot; style={{ minWidth: 32 }}&gt;
140:                         {agent.invocations}
141:                       &lt;/span&gt;
142:                       &lt;div className=&quot;mini-bar&quot; style={{ flex: 1, minWidth: 48 }}&gt;
143:                         &lt;div className=&quot;mini-bar-fill&quot; style={{ width: `${invPct}%`, background: color, opacity: 0.7 }} /&gt;
144:                       &lt;/div&gt;
145:                     &lt;/div&gt;
146:                   &lt;/td&gt;
147: 
148:                   {/* Error rate */}
149:                   &lt;td&gt;
150:                     &lt;div className=&quot;flex-center gap-1-5&quot;&gt;
151:                       &lt;span className=&quot;mono-xs&quot; style={{
152:                         color: errColor,
153:                       }}&gt;
154:                         {agent.errors &gt; 0 ? `${(agent.errorRate * 100).toFixed(1)}%` : &apos;\u2014&apos;}
155:                       &lt;/span&gt;
156:                       {agent.errors &gt; 0 &amp;&amp; (
157:                         &lt;span className=&quot;text-muted text-xs&quot;&gt;
158:                           ({agent.errors})
159:                         &lt;/span&gt;
160:                       )}
161:                     &lt;/div&gt;
162:                   &lt;/td&gt;
163: 
164:                   {/* Session count */}
165:                   &lt;td&gt;
166:                     &lt;span className=&quot;mono-xs&quot;&gt;
167:                       {agent.sessionCount}
168:                     &lt;/span&gt;
169:                   &lt;/td&gt;
170: 
171:                   {/* Avg output size */}
172:                   &lt;td&gt;
173:                     &lt;span className=&quot;mono-xs text-secondary&quot;&gt;
174:                       {formatBytes(agent.avgOutputSize)}
175:                     &lt;/span&gt;
176:                   &lt;/td&gt;
177: 
178:                   {/* Rate limits */}
179:                   &lt;td&gt;
180:                     {agent.rateLimitCount &gt; 0 ? (
181:                       &lt;span className=&quot;mono-xs&quot; style={{
182:                         color: &apos;var(--status-warning)&apos;,
183:                         background: RATE_LIMIT_BADGE_BG,
184:                         padding: &apos;1px 6px&apos;,
185:                         borderRadius: 10,
186:                       }}&gt;
187:                         {agent.rateLimitCount}x
188:                       &lt;/span&gt;
189:                     ) : (
190:                       &lt;span className=&quot;text-muted text-xs&quot;&gt;{&apos;\u2014&apos;}&lt;/span&gt;
191:                     )}
192:                   &lt;/td&gt;
193: 
194:                   {/* Source type */}
195:                   &lt;td&gt;
196:                     {topSource ? (
197:                       &lt;span className=&quot;mono text-muted text-2xs uppercase&quot;&gt;
198:                         {topSource}
199:                       &lt;/span&gt;
200:                     ) : &lt;span className=&quot;text-muted&quot;&gt;{&apos;\u2014&apos;}&lt;/span&gt;}
201:                   &lt;/td&gt;
202:                 &lt;/tr&gt;
203: 
204:                 {/* Expanded row: eval summary + sessions + traces */}
205:                 {isExpanded &amp;&amp; (
206:                   &lt;tr className=&quot;eval-expanded-panel&quot;&gt;
207:                     &lt;td colSpan={COLUMN_COUNT} style={{ padding: &apos;0 10px 10px&apos;, borderBottom: &apos;1px solid var(--border)&apos; }}&gt;
208:                       {/* Evaluation summary */}
209:                       &lt;EvalSummaryRow evalSummary={agent.evalSummary} /&gt;
210: 
211:                       {/* Daily invocation sparkline */}
212:                       {agent.dailyCounts.length &gt; 1 &amp;&amp; agent.dailyCounts.some(v =&gt; v &gt; 0) &amp;&amp; (
213:                         &lt;div style={{
214:                           padding: &apos;10px 0 8px&apos;,
215:                           borderBottom: &apos;1px solid var(--border-subtle)&apos;,
216:                           marginBottom: 4,
217:                         }}&gt;
218:                           &lt;div className=&quot;flex-center gap-3&quot;&gt;
219:                             &lt;div className=&quot;text-xs text-muted uppercase&quot; style={{
220:                               flexShrink: 0,
221:                             }}&gt;
222:                               Daily Activity
223:                             &lt;/div&gt;
224:                             &lt;Sparkline
225:                               data={agent.dailyCounts}
226:                               width={160}
227:                               height={28}
228:                               color={colorIndex.get(agent.agentName) ?? AGENT_PALETTE[0]}
229:                               label={`Daily invocations for ${agent.agentName}`}
230:                             /&gt;
231:                             &lt;span className=&quot;mono text-muted&quot; style={{
232:                               fontSize: &apos;var(--font-size-2xs)&apos;,
233:                               flexShrink: 0,
234:                             }}&gt;
235:                               peak {Math.max(...agent.dailyCounts)}/day
236:                             &lt;/span&gt;
237:                           &lt;/div&gt;
238:                         &lt;/div&gt;
239:                       )}
240: 
241:                       &lt;div className=&quot;gap-4&quot; style={{
242:                         display: &apos;grid&apos;,
243:                         gridTemplateColumns: &apos;1fr 1fr&apos;,
244:                         padding: &apos;12px 0 4px&apos;,
245:                       }}&gt;
246:                         {/* Sessions column */}
247:                         &lt;div&gt;
248:                           &lt;div className=&quot;text-muted mb-1-5 text-xs uppercase&quot;&gt;
249:                             Sessions ({agent.sessionCount})
250:                           &lt;/div&gt;
251:                           &lt;div className=&quot;gap-1&quot; style={{ display: &apos;flex&apos;, flexDirection: &apos;column&apos; }}&gt;
252:                             {agent.sessionIds.map(sid =&gt; (
253:                               &lt;Link
254:                                 key={sid}
255:                                 href={`/sessions/${sid}`}
256:                                 className=&quot;mono-xs&quot;
257:                                 style={{
258:                                   color: &apos;var(--accent)&apos;,
259:                                   textDecoration: &apos;none&apos;,
260:                                 }}
261:                                 onClick={(e: React.MouseEvent) =&gt; e.stopPropagation()}
262:                               &gt;
263:                                 {truncateId(sid, 12)}
264:                               &lt;/Link&gt;
265:                             ))}
266:                             {agent.sessionIds.length === 0 &amp;&amp; (
267:                               &lt;span className=&quot;text-muted text-xs&quot;&gt;none&lt;/span&gt;
268:                             )}
269:                             {/* sessionCount === total unique sessions; sessionIds is capped at 50 */}
270:                             {agent.sessionIdsTruncated &amp;&amp; (
271:                               &lt;span className=&quot;text-muted&quot; style={{ fontSize: &apos;var(--font-size-2xs)&apos;, fontStyle: &apos;italic&apos; }}&gt;
272:                                 +{agent.sessionCount - agent.sessionIds.length} more
273:                               &lt;/span&gt;
274:                             )}
275:                           &lt;/div&gt;
276:                         &lt;/div&gt;
277: 
278:                         {/* Traces column */}
279:                         &lt;div&gt;
280:                           &lt;div className=&quot;text-muted mb-1-5 text-xs uppercase&quot;&gt;
281:                             Traces ({agent.traceIdsTotal ?? agent.traceIds.length})
282:                           &lt;/div&gt;
283:                           &lt;div className=&quot;gap-1&quot; style={{ display: &apos;flex&apos;, flexDirection: &apos;column&apos; }}&gt;
284:                             {agent.traceIds.map(tid =&gt; (
285:                               &lt;Link
286:                                 key={tid}
287:                                 href={`/traces/${tid}`}
288:                                 className=&quot;mono-xs&quot;
289:                                 style={{
290:                                   color: &apos;var(--accent)&apos;,
291:                                   textDecoration: &apos;none&apos;,
292:                                 }}
293:                                 onClick={(e: React.MouseEvent) =&gt; e.stopPropagation()}
294:                               &gt;
295:                                 {truncateId(tid, 12)}
296:                               &lt;/Link&gt;
297:                             ))}
298:                             {agent.traceIds.length === 0 &amp;&amp; (
299:                               &lt;span className=&quot;text-muted text-xs&quot;&gt;none&lt;/span&gt;
300:                             )}
301:                             {agent.traceIdsTruncated &amp;&amp; (
302:                               &lt;span className=&quot;text-muted&quot; style={{ fontSize: &apos;var(--font-size-2xs)&apos;, fontStyle: &apos;italic&apos; }}&gt;
303:                                 +{(agent.traceIdsTotal ?? 0) - agent.traceIds.length} more
304:                               &lt;/span&gt;
305:                             )}
306:                           &lt;/div&gt;
307:                         &lt;/div&gt;
308:                       &lt;/div&gt;
309:                     &lt;/td&gt;
310:                   &lt;/tr&gt;
311:                 )}
312:               &lt;/Fragment&gt;
313:             );
314:           })}
315:         &lt;/tbody&gt;
316:       &lt;/table&gt;
317:     &lt;/div&gt;
318:   );
319: }
320: 
321: /** Per-agent evaluation metrics (relevance, coherence, faithfulness, etc.) */
322: function EvalSummaryRow({ evalSummary }: { evalSummary: Record&lt;string, EvalMetricSummary&gt; }) {
323:   const metrics = Object.entries(evalSummary);
324:   if (metrics.length === 0) {
325:     return (
326:       &lt;div style={{
327:         padding: &apos;10px 0 4px&apos;,
328:         fontSize: 12,
329:         color: &apos;var(--text-muted)&apos;,
330:         borderBottom: &apos;1px solid var(--border-subtle)&apos;,
331:         marginBottom: 4,
332:       }}&gt;
333:         No evaluations linked to this agent.
334:       &lt;/div&gt;
335:     );
336:   }
337: 
338:   return (
339:     &lt;div style={{
340:       padding: &apos;10px 0 8px&apos;,
341:       borderBottom: &apos;1px solid var(--border-subtle)&apos;,
342:       marginBottom: 4,
343:     }}&gt;
344:       &lt;div className=&quot;text-muted mb-1-5 text-xs uppercase&quot;&gt;
345:         Evaluation Metrics
346:       &lt;/div&gt;
347:       &lt;div className=&quot;gap-3&quot; style={{ display: &apos;flex&apos;, flexWrap: &apos;wrap&apos; }}&gt;
348:         {metrics.map(([name, m]) =&gt; {
349:           const band = scoreColorBand(m.avg);
350:           const barColor = SCORE_COLORS[band];
351:           return (
352:             &lt;div key={name} style={{
353:               minWidth: 140,
354:               padding: &apos;8px 10px&apos;,
355:               background: &apos;var(--bg-card)&apos;,
356:               border: &apos;1px solid var(--border-subtle)&apos;,
357:               borderRadius: &apos;var(--radius)&apos;,
358:             }}&gt;
359:               &lt;div className=&quot;text-secondary mb-1 text-xs&quot; style={{
360:                 whiteSpace: &apos;nowrap&apos;,
361:                 overflow: &apos;hidden&apos;,
362:                 textOverflow: &apos;ellipsis&apos;,
363:               }}&gt;
364:                 {name}
365:               &lt;/div&gt;
366:               {/* Score bar */}
367:               &lt;div className=&quot;flex-center mb-1 gap-2&quot;&gt;
368:                 &lt;div className=&quot;mini-bar&quot; style={{ flex: 1 }}&gt;
369:                   &lt;div className=&quot;mini-bar-fill&quot; style={{ width: `${Math.min(m.avg * 100, 100)}%`, background: barColor }} /&gt;
370:                 &lt;/div&gt;
371:                 &lt;span className=&quot;mono-xs font-semibold&quot; style={{
372:                   color: barColor,
373:                   minWidth: 38,
374:                   textAlign: &apos;right&apos;,
375:                 }}&gt;
376:                   {m.avg.toFixed(2)}
377:                 &lt;/span&gt;
378:               &lt;/div&gt;
379:               {/* Min/max range + count */}
380:               &lt;div className=&quot;mono text-muted&quot; style={{
381:                 display: &apos;flex&apos;,
382:                 justifyContent: &apos;space-between&apos;,
383:                 fontSize: &apos;var(--font-size-2xs)&apos;,
384:               }}&gt;
385:                 &lt;span&gt;{m.min.toFixed(2)}\u2013{m.max.toFixed(2)}&lt;/span&gt;
386:                 &lt;span&gt;n={m.count}&lt;/span&gt;
387:               &lt;/div&gt;
388:             &lt;/div&gt;
389:           );
390:         })}
391:       &lt;/div&gt;
392:     &lt;/div&gt;
393:   );
394: }
395: 
396: /** Summary bar above the table -- totals at a glance */
397: export function AgentActivitySummary({ agents }: AgentActivityPanelProps) {
398:   const totalInvocations = agents.reduce((s, a) =&gt; s + a.invocations, 0);
399:   const totalErrors = agents.reduce((s, a) =&gt; s + a.errors, 0);
400:   const totalRateLimits = agents.reduce((s, a) =&gt; s + a.rateLimitCount, 0);
401:   const overallErrorRate = totalInvocations &gt; 0 ? (totalErrors / totalInvocations) * 100 : 0;
402: 
403:   return (
404:     &lt;div style={{
405:       display: &apos;flex&apos;,
406:       gap: &apos;var(--space-8)&apos;,
407:       padding: &apos;var(--space-4) var(--space-5)&apos;,
408:       background: &apos;var(--bg-elevated)&apos;,
409:       borderRadius: &apos;var(--radius)&apos;,
410:       border: &apos;1px solid var(--border-subtle)&apos;,
411:       marginBottom: &apos;var(--space-5)&apos;,
412:       flexWrap: &apos;wrap&apos;,
413:     }}&gt;
414:       {[
415:         { label: &apos;Agents&apos;, value: agents.length },
416:         { label: &apos;Invocations&apos;, value: totalInvocations.toLocaleString() },
417:         {
418:           label: &apos;Error Rate&apos;,
419:           value: totalInvocations &gt; 0 ? `${overallErrorRate.toFixed(1)}%` : &apos;\u2014&apos;,
420:           color: overallErrorRate === 0
421:             ? &apos;var(--status-healthy)&apos;
422:             : overallErrorRate &lt; ERROR_RATE_WARNING_THRESHOLD * 100
423:               ? &apos;var(--status-warning)&apos;
424:               : &apos;var(--status-critical)&apos;,
425:         },
426:         {
427:           label: &apos;Rate Limits&apos;,
428:           value: totalRateLimits &gt; 0 ? totalRateLimits : &apos;\u2014&apos;,
429:           color: totalRateLimits &gt; 0 ? &apos;var(--status-warning)&apos; : undefined,
430:         },
431:       ].map(({ label, value, color }) =&gt; (
432:         &lt;div key={label} className=&quot;summary-count&quot;&gt;
433:           &lt;div className=&quot;value&quot; style={color ? { color } : undefined}&gt;{value}&lt;/div&gt;
434:           &lt;div className=&quot;label text-secondary text-xs&quot;&gt;{label}&lt;/div&gt;
435:         &lt;/div&gt;
436:       ))}
437:     &lt;/div&gt;
438:   );
439: }</file><file path="src/theme.css">  1: @import url(&apos;https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;500;600&amp;family=IBM+Plex+Sans:wght@400;500;600&amp;display=swap&apos;);
  2: 
  3: :root {
  4:   /* Backgrounds */
  5:   --bg-primary: #0a0e14;
  6:   --bg-card: #131920;
  7:   --bg-elevated: #1a2230;
  8:   --bg-surface: #1f2937;
  9:   --bg-hover: #243044;
 10: 
 11:   /* Borders */
 12:   --border: #2a3a4e;
 13:   --border-subtle: #1e2a3a;
 14:   --border-accent: #3b5278;
 15: 
 16:   /* Text */
 17:   --text-primary: #e2e8f0;
 18:   --text-secondary: #94a3b8;
 19:   --text-muted: #475569;
 20: 
 21:   /* Status */
 22:   --status-healthy: #26d97f;
 23:   --status-warning: #e5a00d;
 24:   --status-critical: #f04438;
 25:   --status-no-data: #6b7280;
 26: 
 27:   /* Accent */
 28:   --accent: #3b82f6;
 29:   --accent-hover: #60a5fa;
 30:   --accent-muted: #1e3a5f;
 31: 
 32:   /* Scores (alias shared values to status tokens) */
 33:   --score-excellent: var(--status-healthy);
 34:   --score-good: #34d399;
 35:   --score-adequate: var(--status-warning);
 36:   --score-poor: #f97316;
 37:   --score-failing: var(--status-critical);
 38: 
 39:   /* Typography */
 40:   --font-body: &apos;IBM Plex Sans&apos;, -apple-system, BlinkMacSystemFont, sans-serif;
 41:   --font-mono: &apos;JetBrains Mono&apos;, &apos;SF Mono&apos;, Consolas, monospace;
 42: 
 43:   /* Spacing */
 44:   --space-half: 2px;
 45:   --space-1: 4px;
 46:   --space-1-5: 6px;
 47:   --space-2: 8px;
 48:   --space-2-5: 10px;
 49:   --space-3: 12px;
 50:   --space-4: 16px;
 51:   --space-5: 20px;
 52:   --space-6: 24px;
 53:   --space-8: 32px;
 54:   --space-16: 64px;
 55: 
 56:   /* Layout */
 57:   --layout-max-width: 1280px;
 58: 
 59:   /* Status tints (bg + border pairs) */
 60:   --bg-status-healthy: #0d1f12;
 61:   --bg-status-warning: #1f1a0d;
 62:   --bg-status-critical: #1f0d0d;
 63:   --border-status-healthy: #1a3a1f;
 64:   --border-status-warning: #3a2f1a;
 65:   --border-status-critical: #3a1a1a;
 66: 
 67:   /* Accent alpha */
 68:   --accent-alpha-10: rgba(59, 130, 246, 0.1);
 69:   --accent-alpha-20: rgba(59, 130, 246, 0.2);
 70: 
 71:   /* Status glow alpha */
 72:   --healthy-alpha-15: rgba(38, 217, 127, 0.15);
 73:   --warning-alpha-15: rgba(229, 160, 13, 0.15);
 74:   --critical-alpha-20: rgba(240, 68, 56, 0.2);
 75:   --critical-alpha-40: rgba(240, 68, 56, 0.4);
 76:   --critical-alpha-60: rgba(240, 68, 56, 0.6);
 77: 
 78:   /* Radii */
 79:   --radius-xs: 2px;
 80:   --radius-bar: 3px;
 81:   --radius-sm: 4px;
 82:   --radius: 6px;
 83:   --radius-lg: 8px;
 84:   --radius-pill: 12px;
 85: 
 86:   /* Font sizes */
 87:   --font-size-2xs: 9px;
 88:   --font-size-xs: 12px;
 89:   --font-size-base: 14px;
 90:   --font-size-md: 16px;
 91:   --font-size-lg: 18px;
 92:   --font-size-xl: 20px;
 93:   --font-size-2xl: 24px;
 94: 
 95:   /* Label typography */
 96:   --label-letter-spacing: 0.5px;
 97: 
 98:   /* Transitions */
 99:   --transition-fast: 0.15s ease;
100:   --transition-bar: width 0.3s ease;
101: 
102:   /* Shadows */
103:   --shadow-sm: 0 1px 2px rgba(0,0,0,0.3);
104:   --shadow-glow-healthy: 0 0 12px var(--healthy-alpha-15);
105:   --shadow-glow-warning: 0 0 12px var(--warning-alpha-15);
106:   --shadow-glow-critical: 0 0 12px var(--critical-alpha-20);
107: }
108: 
109: * {
110:   margin: 0;
111:   padding: 0;
112:   box-sizing: border-box;
113: }
114: 
115: /* Shared uppercase label pattern */
116: .summary-count .label,
117: .sla-table th,
118: .section-label,
119: .cot-summary,
120: .agreement-grid .ag-header,
121: .stat-label,
122: .field-label {
123:   text-transform: uppercase;
124:   letter-spacing: var(--label-letter-spacing);
125: }
126: 
127: /* Shared accent link base + hover */
128: .back-link,
129: .tooltip-link,
130: .alert-metric-link {
131:   color: var(--accent);
132:   text-decoration: none;
133: }
134: .back-link:hover,
135: .tooltip-link:hover,
136: .alert-metric-link:hover {
137:   text-decoration: underline;
138: }
139: 
140: .sla-table th,
141: .eval-table th { font-size: var(--font-size-xs); }
142: 
143: .trend.stable { color: var(--text-secondary); }
144: 
145: /* Shared text truncation */
146: .eval-table .explanation,
147: .metric-worst {
148:   overflow: hidden;
149:   text-overflow: ellipsis;
150:   white-space: nowrap;
151: }
152: 
153: /* Shared flex row */
154: .health-banner,
155: .metric-card-header,
156: .metric-footer,
157: .header,
158: .pipeline-stat,
159: .confidence-header,
160: .variance-bar,
161: .eval-detail-meta,
162: .alert-related {
163:   display: flex;
164:   align-items: center;
165: }
166: 
167: /* Shared flex row (no align) */
168: .summary-counts,
169: .pipeline-stats {
170:   display: flex;
171:   gap: var(--space-6);
172: }
173: 
174: /* Shared inline-flex row */
175: .status-badge,
176: .trend,
177: .back-link,
178: .score-badge-wrapper {
179:   display: inline-flex;
180:   align-items: center;
181: }
182: 
183: body {
184:   font-family: var(--font-body);
185:   background: var(--bg-primary);
186:   color: var(--text-primary);
187:   line-height: 1.6;
188:   font-size: var(--font-size-base);
189:   -webkit-font-smoothing: antialiased;
190: }
191: 
192: @media (prefers-reduced-motion: reduce) {
193:   *, *::before, *::after {
194:     animation-duration: 0.01ms !important;
195:     transition-duration: 0.01ms !important;
196:   }
197: }
198: 
199: .dashboard-container {
200:   max-width: var(--layout-max-width);
201:   margin: 0 auto;
202:   padding: var(--space-6);
203: }
204: 
205: .metric-grid {
206:   display: grid;
207:   grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
208:   gap: var(--space-4);
209: }
210: 
211: .card {
212:   background: var(--bg-card);
213:   border: 1px solid var(--border-subtle);
214:   border-radius: var(--radius-lg);
215:   padding: var(--space-5);
216:   box-shadow: var(--shadow-sm);
217: }
218: 
219: .card:hover {
220:   border-color: var(--border);
221: }
222: 
223: .card.glow-warning { box-shadow: var(--shadow-glow-warning); }
224: .card.glow-critical { box-shadow: var(--shadow-glow-critical); }
225: 
226: .card-link {
227:   text-decoration: none;
228:   color: inherit;
229:   display: block;
230: }
231: 
232: /* Health banner */
233: .health-banner {
234:   padding: var(--space-4) var(--space-5);
235:   border-radius: var(--radius);
236:   margin-bottom: var(--space-6);
237:   justify-content: space-between;
238: }
239: .health-banner.healthy { background: var(--bg-status-healthy); border: 1px solid var(--border-status-healthy); }
240: .health-banner.warning { background: var(--bg-status-warning); border: 1px solid var(--border-status-warning); }
241: .health-banner.critical { background: var(--bg-status-critical); border: 1px solid var(--border-status-critical); }
242: .health-banner.no_data { background: var(--bg-card); border: 1px solid var(--border); }
243: 
244: .summary-count {
245:   text-align: center;
246: }
247: .summary-count .value {
248:   font-size: var(--font-size-2xl);
249:   font-weight: 600;
250:   font-family: var(--font-mono);
251: }
252: /* Status badges */
253: .status-badge {
254:   gap: var(--space-1-5);
255:   font-weight: 500;
256:   padding: var(--space-half) var(--space-2);
257:   border-radius: var(--radius-pill);
258: }
259: .status-badge.healthy { color: var(--status-healthy); background: var(--bg-status-healthy); }
260: .status-badge.warning { color: var(--status-warning); background: var(--bg-status-warning); }
261: .status-badge.critical { color: var(--status-critical); background: var(--bg-status-critical); }
262: .status-badge.no_data { color: var(--status-no-data); background: var(--bg-elevated); }
263: 
264: /* Trend indicator */
265: .trend {
266:   gap: var(--space-1);
267:   font-size: var(--font-size-xs);
268:   font-family: var(--font-mono);
269: }
270: .trend.improving { color: var(--status-healthy); }
271: .trend.degrading { color: var(--status-critical); }
272: /* Metric card */
273: .metric-card-header {
274:   justify-content: space-between;
275:   margin-bottom: var(--space-3);
276: }
277: .metric-card-header h3 {
278:   font-size: var(--font-size-base);
279:   font-weight: 500;
280: }
281: 
282: .metric-values {
283:   font-family: var(--font-mono);
284:   font-size: var(--font-size-xs);
285: }
286: .metric-values .primary {
287:   font-size: var(--font-size-2xl);
288:   font-weight: 600;
289:   line-height: 1.2;
290: }
291: .metric-values .secondary {
292:   color: var(--text-secondary);
293:   margin-top: var(--space-1);
294: }
295: 
296: /* Shared section divider */
297: .metric-footer,
298: .pipeline-stats,
299: .agreement-summary {
300:   margin-top: var(--space-3);
301:   padding-top: var(--space-3);
302:   border-top: 1px solid var(--border-subtle);
303:   font-size: var(--font-size-xs);
304:   color: var(--text-secondary);
305: }
306: 
307: .metric-footer {
308:   justify-content: space-between;
309:   border-top-color: var(--border);
310: }
311: 
312: /* Alerts */
313: .alert-list {
314:   list-style: none;
315: }
316: .alert-item {
317:   padding: var(--space-3) var(--space-4);
318:   border-left: 3px solid;
319:   background: var(--bg-card);
320:   margin-bottom: var(--space-2);
321:   border-radius: 0 var(--radius) var(--radius) 0;
322: }
323: .alert-item.critical { border-left-color: var(--status-critical); }
324: .alert-item.warning { border-left-color: var(--status-warning); }
325: .alert-item .alert-meta,
326: .alert-item .remediation {
327:   margin-top: var(--space-1);
328: }
329: .alert-item .remediation { color: var(--accent); }
330: 
331: /* Shared table cell borders */
332: .sla-table th,
333: .sla-table td,
334: .eval-table th,
335: .eval-table td,
336: .eval-table .eval-expanded-panel td {
337:   border-bottom: 1px solid var(--border);
338: }
339: 
340: /* Shared table header base */
341: .sla-table th,
342: .eval-table th {
343:   text-align: left;
344:   color: var(--text-secondary);
345:   font-weight: 500;
346: }
347: 
348: /* SLA table */
349: .sla-table {
350:   width: 100%;
351:   border-collapse: collapse;
352:   font-size: var(--font-size-base);
353: }
354: .sla-table th,
355: .sla-table td {
356:   padding: var(--space-2) var(--space-3);
357: }
358: 
359: /* Histogram */
360: .histogram {
361:   display: flex;
362:   align-items: flex-end;
363:   gap: var(--space-half);
364:   height: 120px;
365:   padding: var(--space-2) 0;
366: }
367: .histogram-bar {
368:   flex: 1;
369:   background: var(--accent);
370:   border-radius: var(--radius-xs) var(--radius-xs) 0 0;
371:   min-height: 2px;
372:   position: relative;
373: }
374: .histogram-bar:hover {
375:   opacity: 0.8;
376: }
377: /* Shared elevated surface */
378: .histogram-bar .tooltip,
379: .score-badge-tooltip,
380: .refetch-indicator {
381:   background: var(--bg-elevated);
382:   border: 1px solid var(--border);
383: }
384: 
385: /* Shared tooltip popup base */
386: .histogram-bar .tooltip,
387: .score-badge-tooltip {
388:   display: none;
389:   position: absolute;
390:   left: 50%;
391:   transform: translateX(-50%);
392: }
393: 
394: .histogram-bar .tooltip {
395:   bottom: 100%;
396:   padding: var(--space-1) var(--space-2);
397:   border-radius: var(--radius-sm);
398:   font-size: var(--font-size-xs);
399:   white-space: nowrap;
400:   z-index: 10;
401: }
402: .histogram-bar:hover .tooltip {
403:   display: block;
404: }
405: .histogram-labels {
406:   display: flex;
407:   justify-content: space-between;
408:   font-size: var(--font-size-xs);
409:   color: var(--text-muted);
410:   font-family: var(--font-mono);
411: }
412: 
413: /* Evaluation detail table */
414: .eval-table {
415:   width: 100%;
416:   border-collapse: collapse;
417:   font-size: var(--font-size-xs);
418: }
419: .eval-table th,
420: .eval-table td {
421:   padding: var(--space-1-5) var(--space-2-5);
422: }
423: .eval-table td {
424:   font-family: var(--font-mono);
425: }
426: .eval-table .explanation {
427:   font-family: inherit;
428:   color: var(--text-secondary);
429:   max-width: 300px;
430: }
431: .eval-table tbody tr:hover,
432: .eval-table .eval-row-expanded {
433:   background: var(--bg-elevated);
434: }
435: .eval-table .eval-expanded-panel td {
436:   padding: 0 var(--space-2-5) var(--space-2-5);
437: }
438: 
439: /* Shared ghost button reset */
440: .tab-btn,
441: .period-btn {
442:   background: none;
443:   border: none;
444:   color: var(--text-secondary);
445:   cursor: pointer;
446: }
447: 
448: /* Tabs / Role selector */
449: .tab-nav {
450:   display: flex;
451:   gap: var(--space-1);
452:   margin-bottom: var(--space-6);
453:   border-bottom: 1px solid var(--border);
454:   padding-bottom: 0;
455: }
456: .tab-btn {
457:   padding: var(--space-2) var(--space-4);
458:   font-size: var(--font-size-base);
459:   border-bottom: 2px solid transparent;
460:   margin-bottom: -1px;
461:   transition: color var(--transition-fast), border-color var(--transition-fast);
462: }
463: .tab-btn:hover {
464:   color: var(--text-primary);
465: }
466: .tab-btn[aria-selected=&quot;true&quot;] {
467:   color: var(--text-primary);
468:   border-bottom-color: var(--accent);
469: }
470: 
471: /* Period selector */
472: .period-selector {
473:   display: inline-flex;
474:   gap: var(--space-1);
475:   background: var(--bg-elevated);
476:   border-radius: var(--radius);
477:   padding: var(--space-half);
478: }
479: .period-btn {
480:   padding: var(--space-1) var(--space-3);
481:   border-radius: var(--radius);
482:   font-size: var(--font-size-xs);
483:   font-family: var(--font-body);
484: }
485: .period-btn.active {
486:   background: var(--bg-card);
487:   color: var(--text-primary);
488: }
489: 
490: /* Header */
491: .header {
492:   justify-content: space-between;
493:   margin-bottom: var(--space-6);
494: }
495: .header h1 {
496:   font-size: var(--font-size-xl);
497:   font-weight: 600;
498: }
499: 
500: /* Loading skeleton */
501: .skeleton {
502:   background: linear-gradient(90deg, var(--bg-card) 25%, var(--bg-elevated) 50%, var(--bg-card) 75%);
503:   background-size: 200% 100%;
504:   animation: skeleton-pulse 1.5s ease-in-out infinite;
505:   border-radius: var(--radius);
506: }
507: @keyframes skeleton-pulse {
508:   0% { background-position: 200% 0; }
509:   100% { background-position: -200% 0; }
510: }
511: 
512: /* Empty state */
513: .empty-state {
514:   text-align: center;
515:   padding: var(--space-16) var(--space-6);
516:   color: var(--text-secondary);
517: }
518: .empty-state h2 {
519:   color: var(--text-primary);
520:   margin-bottom: var(--space-2);
521: }
522: .empty-state code {
523:   background: var(--bg-elevated);
524:   padding: var(--space-half) var(--space-1-5);
525:   border-radius: var(--radius-sm);
526:   font-family: var(--font-mono);
527:   font-size: var(--font-size-xs);
528: }
529: 
530: /* Back link */
531: .back-link {
532:   font-size: var(--font-size-xs);
533:   gap: var(--space-1);
534:   margin-bottom: var(--space-4);
535: }
536: 
537: /* Error state */
538: .error-state {
539:   background: var(--bg-status-critical);
540:   border: 1px solid var(--border-status-critical);
541:   border-radius: var(--radius);
542:   padding: var(--space-6);
543:   text-align: center;
544: }
545: .error-state h2 {
546:   color: var(--status-critical);
547:   margin-bottom: var(--space-2);
548: }
549: .error-state .error-actions {
550:   display: flex;
551:   gap: var(--space-2);
552:   margin-top: var(--space-3);
553:   justify-content: center;
554: }
555: .error-state .error-actions button,
556: .error-state .error-actions a {
557:   padding: var(--space-1-5) var(--space-4);
558:   cursor: pointer;
559: }
560: 
561: /* Section headings */
562: .section-heading {
563:   font-size: var(--font-size-md);
564:   font-weight: 600;
565:   margin-bottom: var(--space-4);
566:   margin-top: var(--space-8);
567: }
568: 
569: /* Shared muted label */
570: .section-label,
571: .metric-worst,
572: .confidence-method {
573:   font-size: var(--font-size-xs);
574:   color: var(--text-muted);
575: }
576: 
577: /* Session detail — stat label, vitals divider, frequency grid */
578: .stat-label {
579:   font-size: var(--font-size-xs);
580:   font-family: var(--font-mono);
581:   color: var(--text-muted);
582: }
583: 
584: .vitals-divider {
585:   width: 1px;
586:   background: var(--border-subtle);
587:   margin: 0 var(--space-2);
588:   align-self: stretch;
589: }
590: 
591: .freq-grid {
592:   display: grid;
593:   grid-template-columns: repeat(auto-fill, minmax(340px, 1fr));
594:   gap: 0 var(--space-8);
595: }
596: 
597: /* View sections */
598: .view-section {
599:   margin-bottom: var(--space-8);
600: }
601: 
602: /* Refetch indicator */
603: .refetch-indicator {
604:   position: fixed;
605:   top: var(--space-4);
606:   right: var(--space-4);
607:   padding: var(--space-2) var(--space-4);
608:   border-radius: var(--radius);
609:   font-size: var(--font-size-xs);
610:   color: var(--text-secondary);
611:   z-index: 1000;
612:   animation: fade-in 0.2s ease-in-out;
613: }
614: 
615: @keyframes fade-in {
616:   from { opacity: 0; transform: translateY(-8px); }
617:   to { opacity: 1; transform: translateY(0); }
618: }
619: 
620: @keyframes toxicPulse {
621:   0%, 100% { box-shadow: 0 0 0 0 var(--critical-alpha-40); }
622:   50% { box-shadow: 0 0 6px 2px var(--critical-alpha-60); }
623: }
624: 
625: /* Score badge tooltip */
626: .score-badge-wrapper {
627:   position: relative;
628:   cursor: default;
629: }
630: .score-badge-tooltip {
631:   bottom: calc(100% + var(--space-2));
632:   border-radius: var(--radius);
633:   padding: var(--space-2-5) var(--space-3);
634:   min-width: 200px;
635:   max-width: 300px;
636:   z-index: 20;
637:   font-size: var(--font-size-xs);
638:   white-space: normal;
639:   animation: fade-in var(--transition-fast);
640: }
641: .score-badge-wrapper:hover .score-badge-tooltip,
642: .score-badge-wrapper:focus-within .score-badge-tooltip {
643:   display: block;
644: }
645: .tooltip-row {
646:   display: flex;
647:   justify-content: space-between;
648:   gap: var(--space-3);
649:   padding: var(--space-half) 0;
650:   color: var(--text-primary);
651: }
652: .tooltip-link {
653:   display: block;
654:   margin-top: var(--space-2);
655:   padding-top: var(--space-1-5);
656:   border-top: 1px solid var(--border);
657: }
658: 
659: /* Chain of thought panel */
660: .cot-panel {
661:   margin-top: var(--space-1);
662: }
663: .cot-summary {
664:   color: var(--text-secondary);
665:   cursor: pointer;
666:   padding: var(--space-1) 0;
667:   list-style: none;
668: }
669: .cot-summary::-webkit-details-marker {
670:   display: none;
671: }
672: .cot-summary::before {
673:   content: &apos;\25B6&apos;;
674:   display: inline-block;
675:   margin-right: var(--space-1-5);
676:   font-size: var(--font-size-2xs);
677:   transition: transform var(--transition-fast);
678: }
679: details[open] &gt; .cot-summary::before {
680:   transform: rotate(90deg);
681: }
682: .cot-content {
683:   font-size: var(--font-size-xs);
684:   color: var(--text-primary);
685:   line-height: 1.6;
686:   padding: var(--space-2) 0 var(--space-1);
687: }
688: 
689: /* Evaluation detail page */
690: .eval-detail-header {
691:   margin-bottom: var(--space-6);
692: }
693: .eval-detail-meta {
694:   gap: var(--space-4);
695:   margin-top: var(--space-2);
696: }
697: .eval-detail-card {
698:   margin-bottom: var(--space-4);
699: }
700: 
701: .eval-summary-card.card:hover {
702:   border-color: var(--accent);
703: }
704: 
705: /* Compound alert card */
706: .alert-compound {
707:   border-left-width: 4px;
708:   background: var(--bg-elevated);
709: }
710: .alert-related {
711:   flex-wrap: wrap;
712:   gap: var(--space-2);
713:   margin-top: var(--space-2);
714: }
715: .alert-metric-link {
716:   font-family: var(--font-mono);
717:   padding: var(--space-half) var(--space-2);
718:   border-radius: var(--radius-pill);
719:   background: var(--accent-alpha-10);
720: }
721: .alert-metric-link:hover {
722:   background: var(--accent-alpha-20);
723: }
724: .remediation-list {
725:   margin-top: var(--space-2);
726:   padding-left: var(--space-5);
727:   color: var(--accent);
728: }
729: .remediation-list li {
730:   margin-bottom: var(--space-1);
731: }
732: .threshold-bar {
733:   position: relative;
734:   height: 6px;
735:   background: var(--bg-card);
736:   border-radius: var(--radius-bar);
737:   margin-top: var(--space-2);
738:   overflow: visible;
739: }
740: /* Shared animated bar fill */
741: .threshold-bar-fill,
742: .variance-bar-fill {
743:   height: 100%;
744:   transition: var(--transition-bar);
745: }
746: .threshold-bar-fill { border-radius: var(--radius-bar); }
747: .variance-bar-fill  { border-radius: var(--radius-xs); }
748: .threshold-bar-marker {
749:   position: absolute;
750:   top: -3px;
751:   width: 2px;
752:   height: 12px;
753:   background: var(--text-primary);
754:   border-radius: calc(var(--radius-xs) / 2);
755:   transform: translateX(-1px);
756: }
757: 
758: /* Pipeline health stats in HealthOverview */
759: .pipeline-stat {
760:   gap: var(--space-1);
761: }
762: .pipeline-stat .stat-value {
763:   font-family: var(--font-mono);
764:   color: var(--text-primary);
765:   font-weight: 500;
766: }
767: 
768: /* Worst explanation preview on MetricCard */
769: .metric-worst {
770:   margin-top: var(--space-2);
771:   line-height: 1.4;
772: }
773: .metric-worst .worst-score {
774:   color: var(--score-failing);
775:   font-family: var(--font-mono);
776:   font-weight: 500;
777: }
778: 
779: /* Provenance panel */
780: .provenance-grid,
781: .agreement-grid {
782:   display: grid;
783:   gap: var(--space-1) var(--space-4);
784:   font-family: var(--font-mono);
785:   font-size: var(--font-size-xs);
786: }
787: .provenance-grid { grid-template-columns: auto 1fr; }
788: .provenance-grid .prov-label {
789:   color: var(--text-secondary);
790:   font-family: var(--font-body);
791:   white-space: nowrap;
792: }
793: .provenance-grid .prov-value {
794:   color: var(--text-primary);
795:   word-break: break-all;
796: }
797: .provenance-actions {
798:   display: flex;
799:   gap: var(--space-2);
800:   margin-top: var(--space-3);
801: }
802: .provenance-actions button {
803:   background: var(--bg-surface);
804:   border: 1px solid var(--border);
805:   color: var(--accent);
806:   padding: var(--space-1) var(--space-3);
807:   border-radius: var(--radius-sm);
808:   cursor: pointer;
809:   font-family: var(--font-body);
810: }
811: .provenance-actions button:hover {
812:   background: var(--bg-hover);
813:   border-color: var(--border-accent);
814: }
815: 
816: /* Confidence panel */
817: .confidence-header {
818:   gap: var(--space-2);
819:   margin-bottom: var(--space-3);
820: }
821: .confidence-method {
822:   font-family: var(--font-mono);
823: }
824: .agreement-grid { grid-template-columns: 1fr auto auto; }
825: .agreement-grid .ag-header {
826:   color: var(--text-muted);
827:   font-size: var(--font-size-xs);
828:   font-family: var(--font-body);
829:   padding-bottom: var(--space-1);
830:   border-bottom: 1px solid var(--border-subtle);
831: }
832: .agreement-summary .summary-value {
833:   font-family: var(--font-mono);
834:   color: var(--text-primary);
835: }
836: .variance-bar {
837:   gap: var(--space-2);
838: }
839: .variance-bar-track {
840:   flex: 1;
841:   height: 4px;
842:   background: var(--bg-surface);
843:   border-radius: var(--radius-xs);
844:   overflow: hidden;
845: }
846: 
847: /* Mini progress bar — track + fill */
848: .mini-bar {
849:   height: var(--bar-h, 4px);
850:   background: var(--bg-surface);
851:   border-radius: var(--radius-xs);
852: }
853: .mini-bar-fill {
854:   height: 100%;
855:   border-radius: var(--radius-xs);
856:   transition: var(--transition-bar);
857: }
858: 
859: /* Empty card state — card with muted placeholder text */
860: .card--empty {
861:   padding: var(--space-4);
862:   color: var(--text-muted);
863: }
864: 
865: /* Monospace utilities */
866: .mono      { font-family: var(--font-mono); }
867: .mono-xs   { font-family: var(--font-mono); font-size: var(--font-size-xs); }
868: .mono-xl   { font-family: var(--font-mono); font-size: var(--font-size-xl); }
869: 
870: /* Font size */
871: .text-2xs  { font-size: var(--font-size-2xs); }
872: .text-xs   { font-size: var(--font-size-xs); }
873: .text-base { font-size: var(--font-size-base); }
874: .text-md   { font-size: var(--font-size-md); }
875: .text-lg   { font-size: var(--font-size-lg); }
876: .text-xl   { font-size: var(--font-size-xl); }
877: .text-2xl  { font-size: var(--font-size-2xl); }
878: 
879: /* Text color utilities */
880: .text-secondary { color: var(--text-secondary); }
881: .text-muted     { color: var(--text-muted); }
882: 
883: /* Flex layout */
884: .flex-center { display: flex; align-items: center; }
885: 
886: /* Text transform */
887: .uppercase { text-transform: uppercase; letter-spacing: 0.05em; }
888: .tracking-wide { letter-spacing: 0.05em; }
889: .font-semibold { font-weight: 600; }
890: 
891: /* Chip / pill */
892: .chip { padding: 2px 6px; border-radius: 10px; }
893: 
894: /* Gap */
895: .gap-half { gap: var(--space-half); }   /*  2px */
896: .gap-1    { gap: var(--space-1); }      /*  4px */
897: .gap-1-5  { gap: var(--space-1-5); }    /*  6px */
898: .gap-2    { gap: var(--space-2); }      /*  8px */
899: .gap-2-5  { gap: var(--space-2-5); }    /* 10px */
900: .gap-3    { gap: var(--space-3); }      /* 12px */
901: .gap-4    { gap: var(--space-4); }      /* 16px */
902: .gap-6    { gap: var(--space-6); }      /* 24px */
903: .gap-8    { gap: var(--space-8); }      /* 32px */
904: 
905: /* Margin-bottom */
906: .mb-1   { margin-bottom: var(--space-1); }
907: .mb-1-5 { margin-bottom: var(--space-1-5); }
908: .mb-3   { margin-bottom: var(--space-3); }</file></files></repomix>