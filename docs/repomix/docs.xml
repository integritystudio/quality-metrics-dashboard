<repomix><file_summary>This file is a merged representation of a subset of the codebase, containing specifically included files and files not matching ignore patterns, combined into a single document by Repomix.
The content has been processed where line numbers have been added, content has been formatted for parsing in xml style.<purpose>This file contains a packed representation of a subset of the repository&apos;s contents that is considered the most important context.
It is designed to be easily consumable by AI systems for analysis, code review,
or other automated processes.</purpose><file_format>The content is organized as follows:
1. This summary section
2. Repository information
3. Directory structure
4. Repository files (if enabled)
5. Repository files, each consisting of:
  - File path as an attribute
  - Full contents of the file</file_format><usage_guidelines>- This file should be treated as read-only. Any changes should be made to the
  original repository files, not this packed version.
- When processing this file, use the file path to distinguish
  between different files in the repository.
- Be aware that this file may contain sensitive information. Handle it with
  the same level of security as you would the original repository.</usage_guidelines><notes>- Some files may have been excluded based on .gitignore rules and Repomix&apos;s configuration
- Binary files are not included in this packed representation. Please refer to the Repository Structure section for a complete list of file paths, including binary files
- Only files matching these patterns are included: src/**/*
- Files matching these patterns are excluded: tmp/, *.log, dist/
- Files matching patterns in .gitignore are excluded
- Files matching default ignore patterns are excluded
- Line numbers have been added to the beginning of each line
- Content has been formatted for parsing in xml style
- Files are sorted by Git change count (files with more changes are at the bottom)
- Git diffs from the worktree and staged changes are included
- Git logs (20 commits) are included to show development patterns</notes></file_summary><directory_structure>src/
  __tests__/
    components.test.tsx
    dr13-coverage.test.tsx
    f1-f6-components.test.tsx
    p1-explainability.test.tsx
    quality-utils-drift.test.ts
    setup.ts
  api/
    routes/
      agents.ts
      compliance.ts
      correlations.ts
      coverage.ts
      dashboard.ts
      evaluations.ts
      metrics.ts
      pipeline.ts
      quality.ts
      sessions.ts
      traces.ts
      trends.ts
    data-loader.ts
    server.ts
  components/
    views/
      AuditorView.tsx
      ExecutiveView.tsx
      OperatorView.tsx
    AgentActivityPanel.tsx
    AlertList.tsx
    ChainOfThoughtPanel.tsx
    ComplianceFrameworkMap.tsx
    ConfidencePanel.tsx
    CorrelationHeatmap.tsx
    CoverageGrid.tsx
    CQIHero.tsx
    EvaluationDetail.tsx
    EvaluationEventOverlay.tsx
    EvaluationExpandedRow.tsx
    EvaluationTable.tsx
    HandoffCard.tsx
    HealthOverview.tsx
    Indicators.tsx
    Layout.tsx
    MetaItem.tsx
    MetricCard.tsx
    MetricCompare.tsx
    MetricGrid.tsx
    PipelineFunnel.tsx
    ProvenancePanel.tsx
    QualityLiveIndicator.tsx
    RoleSelector.tsx
    ScoreBadge.tsx
    ScoreHistogram.tsx
    ShortcutOverlay.tsx
    SLATable.tsx
    SpanTree.tsx
    Sparkline.tsx
    SplitPane.tsx
    TrendChart.tsx
    TrendSeries.tsx
    TurnTimeline.tsx
  contexts/
    KeyboardNavContext.tsx
    RoleContext.tsx
  hooks/
    useAgentSession.ts
    useAgentStats.ts
    useCompliance.ts
    useCoverage.ts
    useDashboard.ts
    useMetricDetail.ts
    useMetricEvaluations.ts
    usePipeline.ts
    useQualityLive.ts
    useSessionDetail.ts
    useTrace.ts
    useTraceEvaluations.ts
    useTrend.ts
  lib/
    quality-utils.ts
  pages/
    AgentSessionPage.tsx
    AgentsPage.tsx
    CompliancePage.tsx
    CorrelationsPage.tsx
    CoveragePage.tsx
    EvaluationDetailPage.tsx
    PipelinePage.tsx
    SessionDetailPage.tsx
    TraceDetailPage.tsx
  App.tsx
  main.tsx
  theme.css
  types.ts
  vite-env.d.ts</directory_structure><files>This section contains the contents of the repository&apos;s files.<file path="src/__tests__/components.test.tsx">  1: import { describe, it, expect, afterEach } from &apos;vitest&apos;;
  2: import { render, screen, cleanup, within } from &apos;@testing-library/react&apos;;
  3: import { StatusBadge, TrendIndicator, ConfidenceBadge } from &apos;../components/Indicators.js&apos;;
  4: import { HealthOverview } from &apos;../components/HealthOverview.js&apos;;
  5: import { AlertList } from &apos;../components/AlertList.js&apos;;
  6: import { SLATable } from &apos;../components/SLATable.js&apos;;
  7: import type {
  8:   QualityDashboardSummary,
  9:   TriggeredAlert,
 10:   SLAComplianceResult,
 11:   MetricTrend,
 12:   ConfidenceIndicator,
 13: } from &apos;../types.js&apos;;
 14: 
 15: // ---------------------------------------------------------------------------
 16: // Test Data Factories
 17: // ---------------------------------------------------------------------------
 18: 
 19: function makeDashboard(overrides: Partial&lt;QualityDashboardSummary&gt; = {}): QualityDashboardSummary {
 20:   return {
 21:     overallStatus: &apos;healthy&apos;,
 22:     metrics: [],
 23:     alerts: [],
 24:     summary: {
 25:       totalMetrics: 7,
 26:       healthyMetrics: 5,
 27:       warningMetrics: 1,
 28:       criticalMetrics: 1,
 29:       noDataMetrics: 0,
 30:     },
 31:     timestamp: &apos;2026-02-10T00:00:00Z&apos;,
 32:     ...overrides,
 33:   };
 34: }
 35: 
 36: function makeAlert(overrides: Partial&lt;TriggeredAlert&gt; = {}): TriggeredAlert {
 37:   return {
 38:     severity: &apos;warning&apos;,
 39:     message: &apos;Test alert message&apos;,
 40:     aggregation: &apos;avg&apos;,
 41:     threshold: 0.7,
 42:     actualValue: 0.6,
 43:     direction: &apos;below&apos;,
 44:     ...overrides,
 45:   };
 46: }
 47: 
 48: function makeSLA(overrides: Partial&lt;SLAComplianceResult&gt; = {}): SLAComplianceResult {
 49:   return {
 50:     sla: { metric: &apos;relevance&apos;, aggregation: &apos;avg&apos;, target: 0.8, direction: &apos;above&apos; },
 51:     compliant: true,
 52:     status: &apos;compliant&apos;,
 53:     actualValue: 0.9,
 54:     gap: 0.1,
 55:     marginPercent: 12.5,
 56:     ...overrides,
 57:   };
 58: }
 59: 
 60: // ---------------------------------------------------------------------------
 61: // StatusBadge
 62: // ---------------------------------------------------------------------------
 63: 
 64: describe(&apos;StatusBadge&apos;, () =&gt; {
 65:   it(&apos;renders healthy status&apos;, () =&gt; {
 66:     render(&lt;StatusBadge status=&quot;healthy&quot; /&gt;);
 67:     expect(screen.getByLabelText(&apos;Status: healthy&apos;)).toBeInTheDocument();
 68:     expect(screen.getByText(/healthy/)).toBeInTheDocument();
 69:   });
 70: 
 71:   it(&apos;renders critical status&apos;, () =&gt; {
 72:     render(&lt;StatusBadge status=&quot;critical&quot; /&gt;);
 73:     expect(screen.getByLabelText(&apos;Status: critical&apos;)).toBeInTheDocument();
 74:   });
 75: 
 76:   it(&apos;renders no_data status&apos;, () =&gt; {
 77:     render(&lt;StatusBadge status=&quot;no_data&quot; /&gt;);
 78:     expect(screen.getByLabelText(&apos;Status: no_data&apos;)).toBeInTheDocument();
 79:   });
 80: });
 81: 
 82: // ---------------------------------------------------------------------------
 83: // TrendIndicator
 84: // ---------------------------------------------------------------------------
 85: 
 86: describe(&apos;TrendIndicator&apos;, () =&gt; {
 87:   it(&apos;renders nothing when trend is undefined&apos;, () =&gt; {
 88:     const { container } = render(&lt;TrendIndicator trend={undefined} /&gt;);
 89:     expect(container.innerHTML).toBe(&apos;&apos;);
 90:   });
 91: 
 92:   it(&apos;renders improving trend with positive percentage&apos;, () =&gt; {
 93:     const trend: MetricTrend = {
 94:       direction: &apos;improving&apos;,
 95:       delta: 0.05,
 96:       percentChange: 5.3,
 97:       currentValue: 0.85,
 98:       previousValue: 0.8,
 99:       aggregation: &apos;avg&apos;,
100:       lowSampleWarning: false,
101:     };
102:     render(&lt;TrendIndicator trend={trend} /&gt;);
103:     expect(screen.getByText(/\+5.3%/)).toBeInTheDocument();
104:     expect(screen.getByLabelText(/improving/)).toBeInTheDocument();
105:   });
106: 
107:   it(&apos;renders degrading trend with negative percentage&apos;, () =&gt; {
108:     const trend: MetricTrend = {
109:       direction: &apos;degrading&apos;,
110:       delta: -0.05,
111:       percentChange: -3.1,
112:       currentValue: 0.75,
113:       previousValue: 0.8,
114:       aggregation: &apos;avg&apos;,
115:       lowSampleWarning: false,
116:     };
117:     render(&lt;TrendIndicator trend={trend} /&gt;);
118:     expect(screen.getByText(/-3.1%/)).toBeInTheDocument();
119:   });
120: 
121:   it(&apos;shows low sample warning indicator&apos;, () =&gt; {
122:     const trend: MetricTrend = {
123:       direction: &apos;stable&apos;,
124:       delta: 0,
125:       percentChange: 0,
126:       currentValue: 0.8,
127:       previousValue: 0.8,
128:       aggregation: &apos;avg&apos;,
129:       lowSampleWarning: true,
130:     };
131:     render(&lt;TrendIndicator trend={trend} /&gt;);
132:     expect(screen.getByText(&apos;*&apos;)).toBeInTheDocument();
133:   });
134: });
135: 
136: // ---------------------------------------------------------------------------
137: // ConfidenceBadge
138: // ---------------------------------------------------------------------------
139: 
140: describe(&apos;ConfidenceBadge&apos;, () =&gt; {
141:   it(&apos;renders nothing when confidence is undefined&apos;, () =&gt; {
142:     const { container } = render(&lt;ConfidenceBadge confidence={undefined} /&gt;);
143:     expect(container.innerHTML).toBe(&apos;&apos;);
144:   });
145: 
146:   it(&apos;renders high confidence&apos;, () =&gt; {
147:     const confidence: ConfidenceIndicator = {
148:       level: &apos;high&apos;,
149:       sampleCount: 100,
150:       scoreStdDev: 0.1,
151:       evaluatorCount: 1,
152:       evaluatorAgreement: null,
153:     };
154:     render(&lt;ConfidenceBadge confidence={confidence} /&gt;);
155:     expect(screen.getByLabelText(&apos;Confidence: high&apos;)).toBeInTheDocument();
156:   });
157: });
158: 
159: // ---------------------------------------------------------------------------
160: // HealthOverview
161: // ---------------------------------------------------------------------------
162: 
163: describe(&apos;HealthOverview&apos;, () =&gt; {
164:   it(&apos;renders healthy banner text&apos;, () =&gt; {
165:     render(&lt;HealthOverview dashboard={makeDashboard({ overallStatus: &apos;healthy&apos; })} /&gt;);
166:     expect(screen.getByText(&apos;All metrics within thresholds&apos;)).toBeInTheDocument();
167:   });
168: 
169:   it(&apos;renders critical banner text&apos;, () =&gt; {
170:     render(&lt;HealthOverview dashboard={makeDashboard({ overallStatus: &apos;critical&apos; })} /&gt;);
171:     expect(screen.getByText(&apos;Critical issues detected&apos;)).toBeInTheDocument();
172:   });
173: 
174:   it(&apos;renders warning banner text&apos;, () =&gt; {
175:     render(&lt;HealthOverview dashboard={makeDashboard({ overallStatus: &apos;warning&apos; })} /&gt;);
176:     expect(screen.getByText(&apos;Some metrics need attention&apos;)).toBeInTheDocument();
177:   });
178: 
179:   it(&apos;renders no_data banner text&apos;, () =&gt; {
180:     render(&lt;HealthOverview dashboard={makeDashboard({ overallStatus: &apos;no_data&apos; })} /&gt;);
181:     expect(screen.getByText(&apos;No evaluation data available&apos;)).toBeInTheDocument();
182:   });
183: 
184:   it(&apos;renders summary counts&apos;, () =&gt; {
185:     const dash = makeDashboard({
186:       summary: { totalMetrics: 7, healthyMetrics: 3, warningMetrics: 2, criticalMetrics: 1, noDataMetrics: 1 },
187:     });
188:     const { container } = render(&lt;HealthOverview dashboard={dash} /&gt;);
189:     const counts = container.querySelectorAll(&apos;.summary-count&apos;);
190:     expect(counts).toHaveLength(4);
191:     expect(within(counts[0] as HTMLElement).getByText(&apos;7&apos;)).toBeInTheDocument();
192:     expect(within(counts[0] as HTMLElement).getByText(&apos;Total&apos;)).toBeInTheDocument();
193:     expect(within(counts[1] as HTMLElement).getByText(&apos;3&apos;)).toBeInTheDocument();
194:     expect(within(counts[2] as HTMLElement).getByText(&apos;2&apos;)).toBeInTheDocument();
195:     expect(within(counts[3] as HTMLElement).getByText(&apos;1&apos;)).toBeInTheDocument();
196:   });
197: });
198: 
199: // ---------------------------------------------------------------------------
200: // AlertList
201: // ---------------------------------------------------------------------------
202: 
203: describe(&apos;AlertList&apos;, () =&gt; {
204:   it(&apos;renders nothing for empty alerts&apos;, () =&gt; {
205:     const { container } = render(&lt;AlertList alerts={[]} /&gt;);
206:     expect(container.innerHTML).toBe(&apos;&apos;);
207:   });
208: 
209:   it(&apos;renders alert messages&apos;, () =&gt; {
210:     const alerts = [makeAlert({ message: &apos;Relevance p50 critically low&apos; })];
211:     render(&lt;AlertList alerts={alerts} /&gt;);
212:     expect(screen.getByText(&apos;Relevance p50 critically low&apos;)).toBeInTheDocument();
213:   });
214: 
215:   it(&apos;sorts alerts by severity (critical first)&apos;, () =&gt; {
216:     const alerts = [
217:       makeAlert({ severity: &apos;info&apos;, message: &apos;info alert&apos; }),
218:       makeAlert({ severity: &apos;critical&apos;, message: &apos;critical alert&apos; }),
219:       makeAlert({ severity: &apos;warning&apos;, message: &apos;warning alert&apos; }),
220:     ];
221:     const { container } = render(&lt;AlertList alerts={alerts} /&gt;);
222:     const items = container.querySelectorAll(&apos;.alert-item&apos;);
223:     expect(items[0]).toHaveTextContent(&apos;critical alert&apos;);
224:     expect(items[1]).toHaveTextContent(&apos;warning alert&apos;);
225:     expect(items[2]).toHaveTextContent(&apos;info alert&apos;);
226:   });
227: 
228:   it(&apos;renders remediation hints&apos;, () =&gt; {
229:     const alerts = [makeAlert({ remediationHints: [&apos;Review recent prompt changes&apos;] })];
230:     render(&lt;AlertList alerts={alerts} /&gt;);
231:     expect(screen.getByText(/Review recent prompt changes/)).toBeInTheDocument();
232:   });
233: 
234:   it(&apos;renders aggregation and threshold metadata&apos;, () =&gt; {
235:     const alerts = [makeAlert({ aggregation: &apos;p50&apos;, actualValue: 0.45, threshold: 0.7 })];
236:     const { container } = render(&lt;AlertList alerts={alerts} /&gt;);
237:     const meta = container.querySelector(&apos;.alert-meta&apos;);
238:     expect(meta).toHaveTextContent(&apos;p50 = 0.4500&apos;);
239:     expect(meta).toHaveTextContent(&apos;threshold: 0.7000&apos;);
240:   });
241: });
242: 
243: // ---------------------------------------------------------------------------
244: // SLATable
245: // ---------------------------------------------------------------------------
246: 
247: describe(&apos;SLATable&apos;, () =&gt; {
248:   it(&apos;renders nothing for empty SLAs&apos;, () =&gt; {
249:     const { container } = render(&lt;SLATable slas={[]} /&gt;);
250:     expect(container.innerHTML).toBe(&apos;&apos;);
251:   });
252: 
253:   it(&apos;renders SLA rows with metric name and target&apos;, () =&gt; {
254:     const slas = [makeSLA()];
255:     render(&lt;SLATable slas={slas} /&gt;);
256:     expect(screen.getByText(&apos;relevance (avg)&apos;)).toBeInTheDocument();
257:     expect(screen.getByText(/&gt;= 0.8000/)).toBeInTheDocument();
258:   });
259: 
260:   it(&apos;renders actual value and gap&apos;, () =&gt; {
261:     const slas = [makeSLA({ actualValue: 0.9, gap: 0.1 })];
262:     const { container } = render(&lt;SLATable slas={slas} /&gt;);
263:     const cells = container.querySelectorAll(&apos;td&apos;);
264:     // Cells: metric, target, actual, gap, status
265:     expect(cells[2]).toHaveTextContent(&apos;0.9000&apos;);
266:     expect(cells[3]).toHaveTextContent(&apos;+0.1000&apos;);
267:   });
268: 
269:   it(&apos;renders N/A for null actual value&apos;, () =&gt; {
270:     const slas = [makeSLA({ actualValue: null, gap: null, status: &apos;no_data&apos;, compliant: false })];
271:     render(&lt;SLATable slas={slas} /&gt;);
272:     expect(screen.getByText(&apos;N/A&apos;)).toBeInTheDocument();
273:   });
274: 
275:   it(&apos;renders non-compliant gap in critical color&apos;, () =&gt; {
276:     const slas = [makeSLA({ compliant: false, gap: -0.1, status: &apos;non_compliant&apos; })];
277:     render(&lt;SLATable slas={slas} /&gt;);
278:     // Gap cell should have critical color style
279:     const gapCell = screen.getByText(&apos;-0.1000&apos;);
280:     expect(gapCell).toHaveStyle({ color: &apos;var(--status-critical)&apos; });
281:   });
282: });</file><file path="src/components/views/AuditorView.tsx"> 1: import type { AuditorView as AuditorViewType } from &apos;../../types.js&apos;;
 2: import { MetricGrid } from &apos;../MetricGrid.js&apos;;
 3: import { AlertList } from &apos;../AlertList.js&apos;;
 4: import { SLATable } from &apos;../SLATable.js&apos;;
 5: 
 6: export function AuditorView({ data }: { data: AuditorViewType }) {
 7:   return (
 8:     &lt;div&gt;
 9:       &lt;div style={{ display: &apos;flex&apos;, gap: 16, marginBottom: 24 }}&gt;
10:         &lt;div className=&quot;card&quot; style={{ padding: 12, textAlign: &apos;center&apos;, minWidth: 120 }}&gt;
11:           &lt;div style={{ fontFamily: &apos;var(--font-mono)&apos;, fontSize: 24, fontWeight: 600 }}&gt;
12:             {data.totalEvaluationCount}
13:           &lt;/div&gt;
14:           &lt;div style={{ fontSize: 12, color: &apos;var(--text-secondary)&apos;, textTransform: &apos;uppercase&apos; }}&gt;
15:             Total Evaluations
16:           &lt;/div&gt;
17:         &lt;/div&gt;
18:         &lt;div className=&quot;card&quot; style={{ padding: 12, textAlign: &apos;center&apos;, minWidth: 120 }}&gt;
19:           &lt;div style={{ fontFamily: &apos;var(--font-mono)&apos;, fontSize: 24, fontWeight: 600 }}&gt;
20:             {data.metrics.length}
21:           &lt;/div&gt;
22:           &lt;div style={{ fontSize: 12, color: &apos;var(--text-secondary)&apos;, textTransform: &apos;uppercase&apos; }}&gt;
23:             Metrics
24:           &lt;/div&gt;
25:         &lt;/div&gt;
26:         &lt;div className=&quot;card&quot; style={{ padding: 12, textAlign: &apos;center&apos;, minWidth: 120 }}&gt;
27:           &lt;div style={{ fontFamily: &apos;var(--font-mono)&apos;, fontSize: 24, fontWeight: 600 }}&gt;
28:             {data.alerts.length}
29:           &lt;/div&gt;
30:           &lt;div style={{ fontSize: 12, color: &apos;var(--text-secondary)&apos;, textTransform: &apos;uppercase&apos; }}&gt;
31:             Alerts
32:           &lt;/div&gt;
33:         &lt;/div&gt;
34:         &lt;div className=&quot;card&quot; style={{ padding: 12, textAlign: &apos;center&apos;, minWidth: 120 }}&gt;
35:           &lt;div style={{ fontFamily: &apos;var(--font-mono)&apos;, fontSize: 12, color: &apos;var(--text-secondary)&apos; }}&gt;
36:             {new Date(data.timestamp).toLocaleString()}
37:           &lt;/div&gt;
38:           &lt;div style={{ fontSize: 12, color: &apos;var(--text-secondary)&apos;, textTransform: &apos;uppercase&apos;, marginTop: 4 }}&gt;
39:             Computed At
40:           &lt;/div&gt;
41:         &lt;/div&gt;
42:       &lt;/div&gt;
43: 
44:       &lt;div className=&quot;view-section&quot;&gt;
45:         &lt;h3 className=&quot;section-heading&quot;&gt;All Metrics&lt;/h3&gt;
46:         &lt;MetricGrid metrics={data.metrics} /&gt;
47:       &lt;/div&gt;
48: 
49:       {data.alerts.length &gt; 0 &amp;&amp; (
50:         &lt;div className=&quot;view-section&quot;&gt;
51:           &lt;h3 className=&quot;section-heading&quot;&gt;All Alerts&lt;/h3&gt;
52:           &lt;AlertList alerts={data.alerts} /&gt;
53:         &lt;/div&gt;
54:       )}
55: 
56:       {data.slaCompliance &amp;&amp; data.slaCompliance.length &gt; 0 &amp;&amp; (
57:         &lt;div className=&quot;view-section&quot;&gt;
58:           &lt;h3 className=&quot;section-heading&quot;&gt;SLA Compliance&lt;/h3&gt;
59:           &lt;SLATable slas={data.slaCompliance} /&gt;
60:         &lt;/div&gt;
61:       )}
62:     &lt;/div&gt;
63:   );
64: }</file><file path="src/components/views/OperatorView.tsx"> 1: import type { OperatorView as OperatorViewType } from &apos;../../types.js&apos;;
 2: import { StatusBadge, TrendIndicator } from &apos;../Indicators.js&apos;;
 3: import { AlertList } from &apos;../AlertList.js&apos;;
 4: import { MetricGrid } from &apos;../MetricGrid.js&apos;;
 5: 
 6: export function OperatorView({ data }: { data: OperatorViewType }) {
 7:   return (
 8:     &lt;div&gt;
 9:       &lt;div className={`health-banner ${data.overallStatus}`}&gt;
10:         &lt;div style={{ display: &apos;flex&apos;, alignItems: &apos;center&apos;, gap: 12 }}&gt;
11:           &lt;StatusBadge status={data.overallStatus} /&gt;
12:           &lt;span&gt;Operator View &amp;middot; {data.prioritizedAlerts.length} active alert{data.prioritizedAlerts.length !== 1 ? &apos;s&apos; : &apos;&apos;}&lt;/span&gt;
13:         &lt;/div&gt;
14:       &lt;/div&gt;
15: 
16:       {data.prioritizedAlerts.length &gt; 0 &amp;&amp; (
17:         &lt;div className=&quot;view-section&quot;&gt;
18:           &lt;h3 className=&quot;section-heading&quot;&gt;Prioritized Alerts&lt;/h3&gt;
19:           &lt;AlertList alerts={data.prioritizedAlerts} /&gt;
20:         &lt;/div&gt;
21:       )}
22: 
23:       {data.degradingTrends.length &gt; 0 &amp;&amp; (
24:         &lt;div className=&quot;view-section&quot;&gt;
25:           &lt;h3 className=&quot;section-heading&quot;&gt;Degrading Trends&lt;/h3&gt;
26:           &lt;ul className=&quot;alert-list&quot;&gt;
27:             {data.degradingTrends.map((dt) =&gt; (
28:               &lt;li key={dt.metricName} className=&quot;alert-item warning&quot;&gt;
29:                 &lt;div className=&quot;alert-message&quot;&gt;
30:                   {dt.metricName} &lt;TrendIndicator trend={dt.trend} /&gt;
31:                 &lt;/div&gt;
32:                 &lt;div className=&quot;alert-meta&quot;&gt;
33:                   {dt.trend.previousValue?.toFixed(4)} &amp;rarr; {dt.trend.currentValue?.toFixed(4)}
34:                 &lt;/div&gt;
35:               &lt;/li&gt;
36:             ))}
37:           &lt;/ul&gt;
38:         &lt;/div&gt;
39:       )}
40: 
41:       {data.alertingMetrics.length &gt; 0 &amp;&amp; (
42:         &lt;div className=&quot;view-section&quot;&gt;
43:           &lt;h3 className=&quot;section-heading&quot;&gt;Alerting Metrics&lt;/h3&gt;
44:           &lt;MetricGrid metrics={data.alertingMetrics} /&gt;
45:         &lt;/div&gt;
46:       )}
47: 
48:       {data.prioritizedAlerts.length === 0 &amp;&amp; data.degradingTrends.length === 0 &amp;&amp; (
49:         &lt;div className=&quot;empty-state&quot;&gt;
50:           &lt;h2&gt;All Clear&lt;/h2&gt;
51:           &lt;p&gt;No active alerts or degrading trends.&lt;/p&gt;
52:         &lt;/div&gt;
53:       )}
54:     &lt;/div&gt;
55:   );
56: }</file><file path="src/components/Indicators.tsx"> 1: import type { MetricTrend, ConfidenceIndicator } from &apos;../types.js&apos;;
 2: 
 3: const STATUS_SHAPES: Record&lt;string, string&gt; = {
 4:   healthy: &apos;\u25CF&apos;,   // ●
 5:   warning: &apos;\u25B2&apos;,   // ▲
 6:   critical: &apos;\u25A0&apos;,  // ■
 7:   no_data: &apos;\u25CB&apos;,   // ○
 8: };
 9: 
10: export function StatusBadge({ status }: { status: string }) {
11:   const shape = STATUS_SHAPES[status] ?? STATUS_SHAPES.no_data;
12:   return (
13:     &lt;span className={`status-badge ${status}`} aria-label={`Status: ${status}`}&gt;
14:       {shape} {status}
15:     &lt;/span&gt;
16:   );
17: }
18: 
19: export function TrendIndicator({ trend }: { trend?: MetricTrend }) {
20:   if (!trend) return null;
21:   const arrow = trend.direction === &apos;improving&apos; ? &apos;\u2191&apos; : trend.direction === &apos;degrading&apos; ? &apos;\u2193&apos; : &apos;\u2192&apos;;
22:   const pct = trend.percentChange ?? 0;
23:   const sign = pct &gt; 0 ? &apos;+&apos; : &apos;&apos;;
24:   return (
25:     &lt;span className={`trend ${trend.direction}`} aria-label={`Trend: ${trend.direction}, ${sign}${pct.toFixed(1)}%`}&gt;
26:       {arrow} {sign}{pct.toFixed(1)}%
27:       {trend.lowSampleWarning &amp;&amp; &lt;span title=&quot;Low sample count&quot;&gt; *&lt;/span&gt;}
28:     &lt;/span&gt;
29:   );
30: }
31: 
32: const CONFIDENCE_SYMBOLS: Record&lt;string, string&gt; = {
33:   high: &apos;\u25CF&apos;,   // ●
34:   medium: &apos;\u25D0&apos;, // ◐
35:   low: &apos;\u25CB&apos;,    // ○
36: };
37: 
38: export function ConfidenceBadge({ confidence }: { confidence?: ConfidenceIndicator }) {
39:   if (!confidence) return null;
40:   const symbol = CONFIDENCE_SYMBOLS[confidence.level] ?? &apos;\u25CB&apos;;
41:   return (
42:     &lt;span className=&quot;confidence&quot; aria-label={`Confidence: ${confidence.level}`}&gt;
43:       {symbol} {confidence.level}
44:     &lt;/span&gt;
45:   );
46: }</file><file path="src/components/ScoreHistogram.tsx"> 1: export function ScoreHistogram({ distribution }: { distribution: Array&lt;{ bucket: string; count: number }&gt; }) {
 2:   if (distribution.length === 0) return null;
 3: 
 4:   const maxCount = Math.max(...distribution.map((d) =&gt; d.count), 1);
 5: 
 6:   return (
 7:     &lt;div&gt;
 8:       &lt;div className=&quot;histogram&quot;&gt;
 9:         {distribution.map((d, i) =&gt; (
10:           &lt;div
11:             key={i}
12:             className=&quot;histogram-bar&quot;
13:             style={{ height: `${(d.count / maxCount) * 100}%` }}
14:             aria-label={`${d.bucket}: ${d.count} evaluations`}
15:           &gt;
16:             &lt;div className=&quot;tooltip&quot;&gt;
17:               {d.bucket}: {d.count}
18:             &lt;/div&gt;
19:           &lt;/div&gt;
20:         ))}
21:       &lt;/div&gt;
22:       &lt;div className=&quot;histogram-labels&quot;&gt;
23:         &lt;span&gt;{distribution[0]?.bucket}&lt;/span&gt;
24:         &lt;span&gt;{distribution[distribution.length - 1]?.bucket}&lt;/span&gt;
25:       &lt;/div&gt;
26:     &lt;/div&gt;
27:   );
28: }</file><file path="src/vite-env.d.ts">1: /// &lt;reference types=&quot;vite/client&quot; /&gt;</file><file path="src/__tests__/quality-utils-drift.test.ts">  1: /**
  2:  * Drift detection for dashboard/src/lib/quality-utils.ts (DR12).
  3:  *
  4:  * These tests pin the exact output of every exported function and constant
  5:  * against reference values derived from src/lib/quality-feature-engineering.ts.
  6:  * If the parent changes a threshold or mapping and quality-utils.ts is not
  7:  * updated, at least one assertion here will fail.
  8:  */
  9: 
 10: import { describe, it, expect } from &apos;vitest&apos;;
 11: import {
 12:   scoreColorBand,
 13:   inferScoreDirection,
 14:   labelToOrdinal,
 15:   ordinalToCategory,
 16:   truncateText,
 17:   ROLE_FEATURE_CONFIG,
 18:   SCORE_COLORS,
 19: } from &apos;../lib/quality-utils.js&apos;;
 20: 
 21: // ---------------------------------------------------------------------------
 22: // scoreColorBand
 23: // ---------------------------------------------------------------------------
 24: 
 25: describe(&apos;scoreColorBand&apos;, () =&gt; {
 26:   describe(&apos;maximize direction (default)&apos;, () =&gt; {
 27:     it.each&lt;[number, string]&gt;([
 28:       [1.0, &apos;excellent&apos;],
 29:       [0.95, &apos;excellent&apos;],
 30:       [0.9, &apos;excellent&apos;],   // &gt;= 0.9 threshold
 31:       [0.89, &apos;good&apos;],
 32:       [0.8, &apos;good&apos;],        // &gt;= 0.8 threshold
 33:       [0.79, &apos;adequate&apos;],
 34:       [0.6, &apos;adequate&apos;],    // &gt;= 0.6 threshold
 35:       [0.59, &apos;poor&apos;],
 36:       [0.4, &apos;poor&apos;],        // &gt;= 0.4 threshold
 37:       [0.39, &apos;failing&apos;],
 38:       [0.0, &apos;failing&apos;],
 39:     ])(&apos;score %f → %s&apos;, (score, expected) =&gt; {
 40:       expect(scoreColorBand(score, &apos;maximize&apos;)).toBe(expected);
 41:     });
 42:   });
 43: 
 44:   describe(&apos;minimize direction&apos;, () =&gt; {
 45:     it.each&lt;[number, string]&gt;([
 46:       [0.0, &apos;excellent&apos;],   // 1 - 0.0 = 1.0 &gt;= 0.9
 47:       [0.1, &apos;excellent&apos;],   // 1 - 0.1 = 0.9 &gt;= 0.9
 48:       [0.11, &apos;good&apos;],       // 1 - 0.11 = 0.89 &gt;= 0.8
 49:       [0.2, &apos;good&apos;],        // 1 - 0.2 = 0.8 &gt;= 0.8
 50:       [0.4, &apos;adequate&apos;],    // 1 - 0.4 = 0.6 &gt;= 0.6
 51:       [0.6, &apos;poor&apos;],        // 1 - 0.6 = 0.4 &gt;= 0.4
 52:       [0.61, &apos;failing&apos;],    // 1 - 0.61 = 0.39
 53:     ])(&apos;score %f → %s&apos;, (score, expected) =&gt; {
 54:       expect(scoreColorBand(score, &apos;minimize&apos;)).toBe(expected);
 55:     });
 56:   });
 57: 
 58:   it(&apos;defaults to maximize when direction omitted&apos;, () =&gt; {
 59:     expect(scoreColorBand(0.95)).toBe(&apos;excellent&apos;);
 60:     expect(scoreColorBand(0.5)).toBe(&apos;poor&apos;);
 61:   });
 62: });
 63: 
 64: // ---------------------------------------------------------------------------
 65: // inferScoreDirection
 66: // ---------------------------------------------------------------------------
 67: 
 68: describe(&apos;inferScoreDirection&apos;, () =&gt; {
 69:   it(&apos;above → minimize&apos;, () =&gt; {
 70:     expect(inferScoreDirection(&apos;above&apos;)).toBe(&apos;minimize&apos;);
 71:   });
 72: 
 73:   it(&apos;below → maximize&apos;, () =&gt; {
 74:     expect(inferScoreDirection(&apos;below&apos;)).toBe(&apos;maximize&apos;);
 75:   });
 76: 
 77:   it(&apos;undefined → maximize&apos;, () =&gt; {
 78:     expect(inferScoreDirection(undefined)).toBe(&apos;maximize&apos;);
 79:   });
 80: });
 81: 
 82: // ---------------------------------------------------------------------------
 83: // labelToOrdinal
 84: // ---------------------------------------------------------------------------
 85: 
 86: describe(&apos;labelToOrdinal&apos;, () =&gt; {
 87:   it.each([
 88:     [&apos;excellent&apos;, 4, &apos;Pass&apos;],
 89:     [&apos;highly_relevant&apos;, 4, &apos;Pass&apos;],
 90:     [&apos;fully_faithful&apos;, 4, &apos;Pass&apos;],
 91:     [&apos;perfect&apos;, 4, &apos;Pass&apos;],
 92:     [&apos;relevant&apos;, 3, &apos;Pass&apos;],
 93:     [&apos;good&apos;, 3, &apos;Pass&apos;],
 94:     [&apos;faithful&apos;, 3, &apos;Pass&apos;],
 95:     [&apos;pass&apos;, 3, &apos;Pass&apos;],
 96:     [&apos;correct&apos;, 3, &apos;Pass&apos;],
 97:     [&apos;coherent&apos;, 3, &apos;Pass&apos;],
 98:     [&apos;partial&apos;, 2, &apos;Review&apos;],
 99:     [&apos;borderline&apos;, 2, &apos;Review&apos;],
100:     [&apos;adequate&apos;, 2, &apos;Review&apos;],
101:     [&apos;mixed&apos;, 2, &apos;Review&apos;],
102:     [&apos;off_topic&apos;, 1, &apos;Fail&apos;],
103:     [&apos;irrelevant&apos;, 1, &apos;Fail&apos;],
104:     [&apos;unfaithful&apos;, 1, &apos;Fail&apos;],
105:     [&apos;fail&apos;, 1, &apos;Fail&apos;],
106:     [&apos;incorrect&apos;, 1, &apos;Fail&apos;],
107:     [&apos;incoherent&apos;, 1, &apos;Fail&apos;],
108:     [&apos;hallucinated&apos;, 0, &apos;Fail&apos;],
109:     [&apos;fabricated&apos;, 0, &apos;Fail&apos;],
110:     [&apos;toxic&apos;, 0, &apos;Fail&apos;],
111:     [&apos;dangerous&apos;, 0, &apos;Fail&apos;],
112:   ] as [string, number, string][])(&apos;&quot;%s&quot; → ordinal %i, category %s&apos;, (label, ordinal, category) =&gt; {
113:     const result = labelToOrdinal(label);
114:     expect(result.ordinal).toBe(ordinal);
115:     expect(result.category).toBe(category);
116:     expect(result.mapped).toBe(true);
117:   });
118: 
119:   it(&apos;normalizes case and hyphens&apos;, () =&gt; {
120:     expect(labelToOrdinal(&apos;EXCELLENT&apos;).ordinal).toBe(4);
121:     expect(labelToOrdinal(&apos;highly-relevant&apos;).ordinal).toBe(4);
122:     expect(labelToOrdinal(&apos;Fully_Faithful&apos;).ordinal).toBe(4);
123:   });
124: 
125:   it(&apos;unknown label → ordinal 2, Review, mapped false&apos;, () =&gt; {
126:     const result = labelToOrdinal(&apos;unknown_label&apos;);
127:     expect(result).toEqual({ ordinal: 2, category: &apos;Review&apos;, mapped: false });
128:   });
129: });
130: 
131: // ---------------------------------------------------------------------------
132: // ordinalToCategory
133: // ---------------------------------------------------------------------------
134: 
135: describe(&apos;ordinalToCategory&apos;, () =&gt; {
136:   it.each&lt;[number, string]&gt;([
137:     [4, &apos;Pass&apos;],
138:     [3, &apos;Pass&apos;],
139:     [2, &apos;Review&apos;],
140:     [1, &apos;Fail&apos;],
141:     [0, &apos;Fail&apos;],
142:   ])(&apos;ordinal %i → %s&apos;, (ordinal, expected) =&gt; {
143:     expect(ordinalToCategory(ordinal)).toBe(expected);
144:   });
145: });
146: 
147: // ---------------------------------------------------------------------------
148: // SCORE_COLORS
149: // ---------------------------------------------------------------------------
150: 
151: describe(&apos;SCORE_COLORS&apos;, () =&gt; {
152:   it(&apos;has all required bands&apos;, () =&gt; {
153:     const bands = [&apos;excellent&apos;, &apos;good&apos;, &apos;adequate&apos;, &apos;poor&apos;, &apos;failing&apos;, &apos;no_data&apos;] as const;
154:     for (const band of bands) {
155:       expect(SCORE_COLORS[band]).toMatch(/^#[0-9a-f]{6}$/i);
156:     }
157:   });
158: 
159:   it(&apos;pins exact color values (drift sentinel)&apos;, () =&gt; {
160:     expect(SCORE_COLORS.excellent).toBe(&apos;#26d97f&apos;);
161:     expect(SCORE_COLORS.good).toBe(&apos;#34d399&apos;);
162:     expect(SCORE_COLORS.adequate).toBe(&apos;#e5a00d&apos;);
163:     expect(SCORE_COLORS.poor).toBe(&apos;#f97316&apos;);
164:     expect(SCORE_COLORS.failing).toBe(&apos;#f04438&apos;);
165:     expect(SCORE_COLORS.no_data).toBe(&apos;#6b7280&apos;);
166:   });
167: });
168: 
169: // ---------------------------------------------------------------------------
170: // ROLE_FEATURE_CONFIG shape (sentinel)
171: // ---------------------------------------------------------------------------
172: 
173: describe(&apos;ROLE_FEATURE_CONFIG&apos;, () =&gt; {
174:   const roles = [&apos;executive&apos;, &apos;operator&apos;, &apos;auditor&apos;] as const;
175: 
176:   it(&apos;has all three roles&apos;, () =&gt; {
177:     for (const role of roles) {
178:       expect(ROLE_FEATURE_CONFIG[role]).toBeDefined();
179:     }
180:   });
181: 
182:   it(&apos;executive hides variance and operator controls&apos;, () =&gt; {
183:     expect(ROLE_FEATURE_CONFIG.executive.showVariance).toBe(false);
184:     expect(ROLE_FEATURE_CONFIG.executive.showAcceleration).toBe(false);
185:     expect(ROLE_FEATURE_CONFIG.executive.showRawExport).toBe(false);
186:     expect(ROLE_FEATURE_CONFIG.executive.maxWorstEvaluations).toBe(1);
187:   });
188: 
189:   it(&apos;operator shows operational metrics&apos;, () =&gt; {
190:     expect(ROLE_FEATURE_CONFIG.operator.showVariance).toBe(true);
191:     expect(ROLE_FEATURE_CONFIG.operator.showCorrelationRemediation).toBe(true);
192:     expect(ROLE_FEATURE_CONFIG.operator.showCoverageHeatmap).toBe(true);
193:     expect(ROLE_FEATURE_CONFIG.operator.maxWorstEvaluations).toBe(5);
194:   });
195: 
196:   it(&apos;auditor has full access with raw export&apos;, () =&gt; {
197:     expect(ROLE_FEATURE_CONFIG.auditor.showProvenance).toBe(true);
198:     expect(ROLE_FEATURE_CONFIG.auditor.showRawExport).toBe(true);
199:     expect(ROLE_FEATURE_CONFIG.auditor.maxWorstEvaluations).toBe(10);
200:     expect(ROLE_FEATURE_CONFIG.auditor.explanationTruncation).toBe(2000);
201:   });
202: });
203: 
204: // ---------------------------------------------------------------------------
205: // truncateText
206: // ---------------------------------------------------------------------------
207: 
208: describe(&apos;truncateText&apos;, () =&gt; {
209:   it(&apos;returns original text when under limit&apos;, () =&gt; {
210:     expect(truncateText(&apos;hello&apos;, 10)).toBe(&apos;hello&apos;);
211:   });
212: 
213:   it(&apos;truncates at max and appends ellipsis&apos;, () =&gt; {
214:     expect(truncateText(&apos;hello world&apos;, 5)).toBe(&apos;hello...&apos;);
215:   });
216: 
217:   it(&apos;returns original when exactly at limit&apos;, () =&gt; {
218:     expect(truncateText(&apos;hello&apos;, 5)).toBe(&apos;hello&apos;);
219:   });
220: });</file><file path="src/__tests__/setup.ts"> 1: import &apos;@testing-library/jest-dom/vitest&apos;;
 2: 
 3: // Recharts uses ResizeObserver — provide a minimal stub for jsdom
 4: if (typeof window !== &apos;undefined&apos; &amp;&amp; !(&apos;ResizeObserver&apos; in window)) {
 5:   (window as unknown as Record&lt;string, unknown&gt;).ResizeObserver = class {
 6:     observe() {}
 7:     unobserve() {}
 8:     disconnect() {}
 9:   };
10: }</file><file path="src/api/routes/compliance.ts"> 1: import { Hono } from &apos;hono&apos;;
 2: import { z } from &apos;zod&apos;;
 3: import { computeDashboardSummary } from &apos;../../../../dist/lib/quality-metrics.js&apos;;
 4: import { sanitizeErrorForResponse } from &apos;../../../../dist/lib/error-sanitizer.js&apos;;
 5: import { loadEvaluationsByMetric, loadVerifications } from &apos;../data-loader.js&apos;;
 6: 
 7: const PeriodSchema = z.enum([&apos;24h&apos;, &apos;7d&apos;, &apos;30d&apos;]).default(&apos;7d&apos;);
 8: 
 9: const PERIOD_MS: Record&lt;string, number&gt; = {
10:   &apos;24h&apos;: 24 * 60 * 60 * 1000,
11:   &apos;7d&apos;: 7 * 24 * 60 * 60 * 1000,
12:   &apos;30d&apos;: 30 * 24 * 60 * 60 * 1000,
13: };
14: 
15: export const complianceRoutes = new Hono();
16: 
17: /**
18:  * GET /api/compliance/sla
19:  * Returns SLA compliance from the dashboard summary.
20:  */
21: complianceRoutes.get(&apos;/compliance/sla&apos;, async (c) =&gt; {
22:   const periodResult = PeriodSchema.safeParse(c.req.query(&apos;period&apos;));
23:   if (!periodResult.success) {
24:     return c.json({ error: &apos;Invalid period. Must be 24h, 7d, or 30d.&apos; }, 400);
25:   }
26: 
27:   try {
28:     const now = new Date();
29:     const period = periodResult.data;
30:     const periodMs = PERIOD_MS[period] ?? PERIOD_MS[&apos;7d&apos;];
31:     const start = new Date(now.getTime() - periodMs);
32:     const dates = { start: start.toISOString(), end: now.toISOString() };
33: 
34:     const evaluationsByMetric = await loadEvaluationsByMetric(dates.start, dates.end);
35:     const summary = computeDashboardSummary(evaluationsByMetric, undefined, dates);
36: 
37:     return c.json({
38:       period,
39:       results: summary.slaCompliance ?? [],
40:       noSLAsConfigured: !summary.slaCompliance || summary.slaCompliance.length === 0,
41:     });
42:   } catch (err) {
43:     return c.json({ error: sanitizeErrorForResponse(err) }, 500);
44:   }
45: });
46: 
47: /**
48:  * GET /api/compliance/verifications
49:  * Returns human verification events for the given period.
50:  */
51: complianceRoutes.get(&apos;/compliance/verifications&apos;, async (c) =&gt; {
52:   const periodResult = PeriodSchema.safeParse(c.req.query(&apos;period&apos;));
53:   if (!periodResult.success) {
54:     return c.json({ error: &apos;Invalid period. Must be 24h, 7d, or 30d.&apos; }, 400);
55:   }
56: 
57:   try {
58:     const now = new Date();
59:     const period = periodResult.data;
60:     const periodMs = PERIOD_MS[period] ?? PERIOD_MS[&apos;7d&apos;];
61:     const start = new Date(now.getTime() - periodMs);
62: 
63:     const verifications = await loadVerifications({
64:       startDate: start.toISOString(),
65:       endDate: now.toISOString(),
66:     });
67: 
68:     return c.json({ period, count: verifications.length, verifications });
69:   } catch (err) {
70:     return c.json({ error: sanitizeErrorForResponse(err) }, 500);
71:   }
72: });</file><file path="src/api/routes/evaluations.ts"> 1: import { Hono } from &apos;hono&apos;;
 2: import { z } from &apos;zod&apos;;
 3: import { sanitizeErrorForResponse } from &apos;../../../../dist/lib/error-sanitizer.js&apos;;
 4: import { loadEvaluationsByTraceId } from &apos;../data-loader.js&apos;;
 5: 
 6: const TraceIdSchema = z.string().min(1).max(256);
 7: 
 8: export const evaluationRoutes = new Hono();
 9: 
10: evaluationRoutes.get(&apos;/evaluations/trace/:traceId&apos;, async (c) =&gt; {
11:   const parseResult = TraceIdSchema.safeParse(c.req.param(&apos;traceId&apos;));
12:   if (!parseResult.success) {
13:     return c.json({ error: &apos;Invalid traceId&apos; }, 400);
14:   }
15: 
16:   try {
17:     const evaluations = await loadEvaluationsByTraceId(parseResult.data);
18:     return c.json({ evaluations });
19:   } catch (err) {
20:     return c.json({ error: sanitizeErrorForResponse(err) }, 500);
21:   }
22: });</file><file path="src/api/routes/pipeline.ts"> 1: import { Hono } from &apos;hono&apos;;
 2: import { z } from &apos;zod&apos;;
 3: import {
 4:   computePipelineView,
 5:   computeDashboardSummary,
 6: } from &apos;../../../../dist/lib/quality-metrics.js&apos;;
 7: import { sanitizeErrorForResponse } from &apos;../../../../dist/lib/error-sanitizer.js&apos;;
 8: import { loadEvaluationsByMetric } from &apos;../data-loader.js&apos;;
 9: 
10: const PeriodSchema = z.enum([&apos;24h&apos;, &apos;7d&apos;, &apos;30d&apos;]).default(&apos;7d&apos;);
11: 
12: const PERIOD_MS: Record&lt;string, number&gt; = {
13:   &apos;24h&apos;: 24 * 60 * 60 * 1000,
14:   &apos;7d&apos;: 7 * 24 * 60 * 60 * 1000,
15:   &apos;30d&apos;: 30 * 24 * 60 * 60 * 1000,
16: };
17: 
18: export const pipelineRoutes = new Hono();
19: 
20: /**
21:  * GET /api/pipeline
22:  * Returns pipeline funnel: 4-stage evaluation flow with drop-off metrics.
23:  *
24:  * Query params:
25:  *   period: &apos;24h&apos; | &apos;7d&apos; | &apos;30d&apos; (default: &apos;7d&apos;)
26:  */
27: pipelineRoutes.get(&apos;/pipeline&apos;, async (c) =&gt; {
28:   const periodResult = PeriodSchema.safeParse(c.req.query(&apos;period&apos;));
29:   if (!periodResult.success) {
30:     return c.json({ error: &apos;Invalid period. Must be 24h, 7d, or 30d.&apos; }, 400);
31:   }
32: 
33:   try {
34:     const now = new Date();
35:     const period = periodResult.data;
36:     const periodMs = PERIOD_MS[period] ?? PERIOD_MS[&apos;7d&apos;];
37:     const start = new Date(now.getTime() - periodMs);
38: 
39:     const evaluationsByMetric = await loadEvaluationsByMetric(
40:       start.toISOString(),
41:       now.toISOString(),
42:     );
43: 
44:     const dashboard = computeDashboardSummary(evaluationsByMetric);
45:     const pipeline = computePipelineView(evaluationsByMetric, dashboard);
46: 
47:     return c.json({ period, ...pipeline });
48:   } catch (err) {
49:     return c.json({ error: sanitizeErrorForResponse(err) }, 500);
50:   }
51: });</file><file path="src/api/routes/quality.ts"> 1: import { Hono } from &apos;hono&apos;;
 2: import { sanitizeErrorForResponse } from &apos;../../../../dist/lib/error-sanitizer.js&apos;;
 3: import { loadEvaluationsByMetric } from &apos;../data-loader.js&apos;;
 4: 
 5: export const qualityRoutes = new Hono();
 6: 
 7: interface LiveMetric {
 8:   name: string;
 9:   score: number;
10:   evaluatorType: string;
11:   timestamp: string;
12: }
13: 
14: interface QualityLiveResponse {
15:   metrics: LiveMetric[];
16:   sessionCount: number;
17:   lastUpdated: string;
18: }
19: 
20: const LIVE_WINDOW_MS = 24 * 60 * 60 * 1000;
21: const EVAL_LIMIT = 100;
22: 
23: /**
24:  * GET /api/quality/live
25:  * Returns latest quality evaluation results from today&apos;s evaluations.
26:  * Response: { metrics, sessionCount, lastUpdated }
27:  */
28: qualityRoutes.get(&apos;/quality/live&apos;, async (c) =&gt; {
29:   try {
30:     const now = new Date();
31:     const start = new Date(now.getTime() - LIVE_WINDOW_MS);
32: 
33:     const evaluationsByMetric = await loadEvaluationsByMetric(
34:       start.toISOString(),
35:       now.toISOString(),
36:     );
37: 
38:     const metrics: LiveMetric[] = [];
39:     const sessionIds = new Set&lt;string&gt;();
40:     let latestTimestamp = &apos;&apos;;
41: 
42:     for (const [name, evals] of evaluationsByMetric) {
43:       // Take last EVAL_LIMIT records, sorted by timestamp desc
44:       const sorted = evals
45:         .slice()
46:         .sort((a, b) =&gt; b.timestamp.localeCompare(a.timestamp))
47:         .slice(0, EVAL_LIMIT);
48: 
49:       // Track sessions
50:       for (const ev of sorted) {
51:         if (ev.traceId) sessionIds.add(ev.traceId);
52:       }
53: 
54:       // Latest eval for this metric
55:       const latest = sorted[0];
56:       if (latest &amp;&amp; latest.scoreValue != null) {
57:         metrics.push({
58:           name,
59:           score: latest.scoreValue,
60:           evaluatorType: latest.evaluatorType ?? &apos;unknown&apos;,
61:           timestamp: latest.timestamp,
62:         });
63:         if (latest.timestamp &gt; latestTimestamp) {
64:           latestTimestamp = latest.timestamp;
65:         }
66:       }
67:     }
68: 
69:     // Sort by metric name for stable ordering
70:     metrics.sort((a, b) =&gt; a.name.localeCompare(b.name));
71: 
72:     const response: QualityLiveResponse = {
73:       metrics,
74:       sessionCount: sessionIds.size,
75:       lastUpdated: latestTimestamp || now.toISOString(),
76:     };
77: 
78:     return c.json(response);
79:   } catch (err) {
80:     return c.json({ error: sanitizeErrorForResponse(err) }, 500);
81:   }
82: });</file><file path="src/api/routes/traces.ts"> 1: import { Hono } from &apos;hono&apos;;
 2: import { sanitizeErrorForResponse } from &apos;../../../../dist/lib/error-sanitizer.js&apos;;
 3: import { loadTracesByTraceId, loadEvaluationsByTraceId } from &apos;../data-loader.js&apos;;
 4: 
 5: export const traceRoutes = new Hono();
 6: 
 7: /**
 8:  * GET /api/traces/:traceId
 9:  * Returns spans + evaluations for a trace.
10:  */
11: traceRoutes.get(&apos;/traces/:traceId&apos;, async (c) =&gt; {
12:   const traceId = c.req.param(&apos;traceId&apos;);
13:   if (!traceId) {
14:     return c.json({ error: &apos;traceId is required&apos; }, 400);
15:   }
16: 
17:   try {
18:     const [spans, evaluations] = await Promise.all([
19:       loadTracesByTraceId(traceId),
20:       loadEvaluationsByTraceId(traceId),
21:     ]);
22: 
23:     return c.json({ traceId, spans, evaluations });
24:   } catch (err) {
25:     return c.json({ error: sanitizeErrorForResponse(err) }, 500);
26:   }
27: });</file><file path="src/components/views/ExecutiveView.tsx"> 1: import type { ExecutiveView as ExecutiveViewType, CompositeQualityIndex } from &apos;../../types.js&apos;;
 2: import { StatusBadge } from &apos;../Indicators.js&apos;;
 3: import { CQIHero } from &apos;../CQIHero.js&apos;;
 4: 
 5: interface ExtendedExecutiveView extends ExecutiveViewType {
 6:   cqi?: CompositeQualityIndex;
 7: }
 8: 
 9: export function ExecutiveView({ data }: { data: ExtendedExecutiveView }) {
10:   return (
11:     &lt;div&gt;
12:       &lt;div className={`health-banner ${data.overallStatus}`}&gt;
13:         &lt;div style={{ display: &apos;flex&apos;, alignItems: &apos;center&apos;, gap: 12 }}&gt;
14:           &lt;StatusBadge status={data.overallStatus} /&gt;
15:           &lt;span&gt;Executive Summary&lt;/span&gt;
16:         &lt;/div&gt;
17:         &lt;div className=&quot;summary-counts&quot;&gt;
18:           &lt;div className=&quot;summary-count&quot;&gt;
19:             &lt;div className=&quot;value&quot;&gt;{data.summary.totalMetrics}&lt;/div&gt;
20:             &lt;div className=&quot;label&quot;&gt;Total&lt;/div&gt;
21:           &lt;/div&gt;
22:           &lt;div className=&quot;summary-count&quot;&gt;
23:             &lt;div className=&quot;value&quot; style={{ color: &apos;var(--status-healthy)&apos; }}&gt;{data.summary.healthyMetrics}&lt;/div&gt;
24:             &lt;div className=&quot;label&quot;&gt;Healthy&lt;/div&gt;
25:           &lt;/div&gt;
26:           {data.slaCompliantCount !== undefined &amp;&amp; (
27:             &lt;div className=&quot;summary-count&quot;&gt;
28:               &lt;div className=&quot;value&quot;&gt;{data.slaCompliantCount}/{data.slaTotalCount}&lt;/div&gt;
29:               &lt;div className=&quot;label&quot;&gt;SLAs Met&lt;/div&gt;
30:             &lt;/div&gt;
31:           )}
32:         &lt;/div&gt;
33:       &lt;/div&gt;
34: 
35:       {data.topIssues.length &gt; 0 &amp;&amp; (
36:         &lt;div className=&quot;view-section&quot;&gt;
37:           &lt;h3 className=&quot;section-heading&quot;&gt;Top Issues&lt;/h3&gt;
38:           &lt;ul className=&quot;alert-list&quot;&gt;
39:             {data.topIssues.map((issue: { name: string; displayName: string; status: string; alertCount: number }) =&gt; (
40:               &lt;li key={issue.name} className={`alert-item ${issue.status}`}&gt;
41:                 &lt;div className=&quot;alert-message&quot;&gt;{issue.displayName}&lt;/div&gt;
42:                 &lt;div className=&quot;alert-meta&quot;&gt;
43:                   Status: {issue.status} &amp;middot; {issue.alertCount} alert{issue.alertCount !== 1 ? &apos;s&apos; : &apos;&apos;}
44:                 &lt;/div&gt;
45:               &lt;/li&gt;
46:             ))}
47:           &lt;/ul&gt;
48:         &lt;/div&gt;
49:       )}
50: 
51:       {data.cqi &amp;&amp; (
52:         &lt;div className=&quot;view-section&quot;&gt;
53:           &lt;CQIHero cqi={data.cqi} /&gt;
54:         &lt;/div&gt;
55:       )}
56: 
57:       &lt;div className=&quot;view-section&quot;&gt;
58:         &lt;h3 className=&quot;section-heading&quot;&gt;Metric Statuses&lt;/h3&gt;
59:         &lt;div className=&quot;metric-grid&quot;&gt;
60:           {data.metricStatuses.map((m: { name: string; displayName: string; status: string }) =&gt; (
61:             &lt;div key={m.name} className=&quot;card&quot; style={{ padding: 12, display: &apos;flex&apos;, justifyContent: &apos;space-between&apos;, alignItems: &apos;center&apos; }}&gt;
62:               &lt;span&gt;{m.displayName}&lt;/span&gt;
63:               &lt;StatusBadge status={m.status} /&gt;
64:             &lt;/div&gt;
65:           ))}
66:         &lt;/div&gt;
67:       &lt;/div&gt;
68: 
69:       &lt;div className=&quot;view-section&quot;&gt;
70:         &lt;h3 className=&quot;section-heading&quot;&gt;Alert Summary&lt;/h3&gt;
71:         &lt;div style={{ display: &apos;flex&apos;, gap: 16 }}&gt;
72:           {Object.entries(data.alertCounts).map(([severity, count]) =&gt; (
73:             &lt;div key={severity} className=&quot;card&quot; style={{ padding: 12, textAlign: &apos;center&apos;, minWidth: 100 }}&gt;
74:               &lt;div style={{ fontFamily: &apos;var(--font-mono)&apos;, fontSize: 24, fontWeight: 600 }}&gt;{String(count)}&lt;/div&gt;
75:               &lt;div style={{ fontSize: 12, color: &apos;var(--text-secondary)&apos;, textTransform: &apos;uppercase&apos; }}&gt;{severity}&lt;/div&gt;
76:             &lt;/div&gt;
77:           ))}
78:         &lt;/div&gt;
79:       &lt;/div&gt;
80:     &lt;/div&gt;
81:   );
82: }</file><file path="src/components/ComplianceFrameworkMap.tsx"> 1: const FRAMEWORKS = [
 2:   {
 3:     name: &apos;EU AI Act&apos;,
 4:     articles: [
 5:       { ref: &apos;Art. 9 — Risk Management&apos;, feature: &apos;SLA compliance tracking, alerts&apos; },
 6:       { ref: &apos;Art. 13 — Transparency&apos;, feature: &apos;Chain-of-thought, evaluation provenance&apos; },
 7:       { ref: &apos;Art. 14 — Human Oversight&apos;, feature: &apos;Human verification events&apos; },
 8:       { ref: &apos;Art. 15 — Accuracy &amp; Robustness&apos;, feature: &apos;Quality metrics, trend analysis&apos; },
 9:     ],
10:   },
11:   {
12:     name: &apos;NIST AI RMF&apos;,
13:     articles: [
14:       { ref: &apos;MAP 1.5 — Impact Assessment&apos;, feature: &apos;Correlation heatmap, CQI&apos; },
15:       { ref: &apos;MEASURE 2.6 — Evaluation&apos;, feature: &apos;LLM-as-Judge, Agent-as-Judge&apos; },
16:       { ref: &apos;MEASURE 2.7 — AI System Performance&apos;, feature: &apos;Dashboard metrics, pipeline coverage&apos; },
17:       { ref: &apos;MANAGE 4.1 — Risk Monitoring&apos;, feature: &apos;Alerts, threshold monitoring&apos; },
18:     ],
19:   },
20: ];
21: 
22: export function ComplianceFrameworkMap() {
23:   return (
24:     &lt;div&gt;
25:       {FRAMEWORKS.map(fw =&gt; (
26:         &lt;div key={fw.name} className=&quot;card&quot; style={{ marginBottom: 16 }}&gt;
27:           &lt;h4 style={{ fontSize: 14, marginBottom: 12 }}&gt;{fw.name}&lt;/h4&gt;
28:           &lt;table className=&quot;eval-table&quot; style={{ width: &apos;100%&apos; }}&gt;
29:             &lt;thead&gt;
30:               &lt;tr&gt;
31:                 &lt;th style={{ textAlign: &apos;left&apos; }}&gt;Reference&lt;/th&gt;
32:                 &lt;th style={{ textAlign: &apos;left&apos; }}&gt;Dashboard Feature&lt;/th&gt;
33:               &lt;/tr&gt;
34:             &lt;/thead&gt;
35:             &lt;tbody&gt;
36:               {fw.articles.map(a =&gt; (
37:                 &lt;tr key={a.ref}&gt;
38:                   &lt;td style={{ fontSize: 13 }}&gt;{a.ref}&lt;/td&gt;
39:                   &lt;td style={{ fontSize: 13, color: &apos;var(--text-secondary)&apos; }}&gt;{a.feature}&lt;/td&gt;
40:                 &lt;/tr&gt;
41:               ))}
42:             &lt;/tbody&gt;
43:           &lt;/table&gt;
44:         &lt;/div&gt;
45:       ))}
46:     &lt;/div&gt;
47:   );
48: }</file><file path="src/components/ConfidencePanel.tsx">  1: import type { ConfidenceIndicator } from &apos;../types.js&apos;;
  2: import { SCORE_COLORS, type ScoreColorBand } from &apos;../lib/quality-utils.js&apos;;
  3: 
  4: interface EvaluatorScore {
  5:   evaluator: string;
  6:   score: number;
  7:   label?: string;
  8: }
  9: 
 10: interface ConfidencePanelProps {
 11:   confidence: ConfidenceIndicator;
 12:   /** Per-evaluator scores for multi-judge display */
 13:   evaluatorScores?: EvaluatorScore[];
 14: }
 15: 
 16: function levelColor(level: string): string {
 17:   if (level === &apos;high&apos;) return SCORE_COLORS.excellent;
 18:   if (level === &apos;medium&apos;) return SCORE_COLORS.adequate;
 19:   return SCORE_COLORS.failing;
 20: }
 21: 
 22: function levelShape(level: string): string {
 23:   if (level === &apos;high&apos;) return &apos;\u25CF&apos;; // ●
 24:   if (level === &apos;medium&apos;) return &apos;\u25D0&apos;; // ◐
 25:   return &apos;\u25CB&apos;; // ○
 26: }
 27: 
 28: function VarianceBar({ value, max }: { value: number; max: number }) {
 29:   const pct = max &gt; 0 ? Math.min(100, (value / max) * 100) : 0;
 30:   const band: ScoreColorBand = pct &lt; 20 ? &apos;excellent&apos; : pct &lt; 50 ? &apos;adequate&apos; : &apos;failing&apos;;
 31:   return (
 32:     &lt;div className=&quot;variance-bar&quot;&gt;
 33:       &lt;div className=&quot;variance-bar-track&quot;&gt;
 34:         &lt;div className=&quot;variance-bar-fill&quot; style={{ width: `${pct}%`, background: SCORE_COLORS[band] }} /&gt;
 35:       &lt;/div&gt;
 36:       &lt;span style={{ fontFamily: &apos;var(--font-mono)&apos;, fontSize: 11, color: &apos;var(--text-secondary)&apos;, minWidth: 36 }}&gt;
 37:         {value.toFixed(3)}
 38:       &lt;/span&gt;
 39:     &lt;/div&gt;
 40:   );
 41: }
 42: 
 43: export function ConfidencePanel({ confidence, evaluatorScores }: ConfidencePanelProps) {
 44:   const { level, sampleCount, scoreStdDev, evaluatorCount, evaluatorAgreement } = confidence;
 45:   const method = evaluatorCount &gt; 1 ? &apos;multi-judge agreement&apos; : sampleCount &gt; 50 ? &apos;sample size&apos; : &apos;sample count&apos;;
 46: 
 47:   const hasMultiJudge = evaluatorScores &amp;&amp; evaluatorScores.length &gt; 1;
 48: 
 49:   return (
 50:     &lt;div className=&quot;confidence-panel&quot;&gt;
 51:       &lt;div className=&quot;confidence-header&quot;&gt;
 52:         &lt;span style={{ color: levelColor(level), fontSize: 14 }}&gt;
 53:           {levelShape(level)} {level}
 54:         &lt;/span&gt;
 55:         &lt;span className=&quot;confidence-method&quot;&gt;({method})&lt;/span&gt;
 56:       &lt;/div&gt;
 57: 
 58:       &lt;div style={{ display: &apos;grid&apos;, gridTemplateColumns: &apos;auto 1fr&apos;, gap: &apos;4px 16px&apos;, fontSize: 12, marginBottom: 12 }}&gt;
 59:         &lt;span style={{ color: &apos;var(--text-secondary)&apos; }}&gt;Sample Count&lt;/span&gt;
 60:         &lt;span style={{ fontFamily: &apos;var(--font-mono)&apos; }}&gt;{sampleCount}&lt;/span&gt;
 61: 
 62:         {scoreStdDev != null &amp;&amp; (
 63:           &lt;&gt;
 64:             &lt;span style={{ color: &apos;var(--text-secondary)&apos; }}&gt;Score Variance&lt;/span&gt;
 65:             &lt;VarianceBar value={scoreStdDev} max={0.5} /&gt;
 66:           &lt;/&gt;
 67:         )}
 68: 
 69:         &lt;span style={{ color: &apos;var(--text-secondary)&apos; }}&gt;Evaluators&lt;/span&gt;
 70:         &lt;span style={{ fontFamily: &apos;var(--font-mono)&apos; }}&gt;{evaluatorCount}&lt;/span&gt;
 71: 
 72:         {evaluatorAgreement != null &amp;&amp; (
 73:           &lt;&gt;
 74:             &lt;span style={{ color: &apos;var(--text-secondary)&apos; }}&gt;Agreement&lt;/span&gt;
 75:             &lt;span style={{
 76:               fontFamily: &apos;var(--font-mono)&apos;,
 77:               color: evaluatorAgreement &gt; 0.8 ? SCORE_COLORS.excellent : evaluatorAgreement &gt; 0.5 ? SCORE_COLORS.adequate : SCORE_COLORS.failing,
 78:             }}&gt;
 79:               {(evaluatorAgreement * 100).toFixed(0)}%
 80:             &lt;/span&gt;
 81:           &lt;/&gt;
 82:         )}
 83:       &lt;/div&gt;
 84: 
 85:       {hasMultiJudge &amp;&amp; (
 86:         &lt;div&gt;
 87:           &lt;div className=&quot;section-label&quot; style={{ marginBottom: 6 }}&gt;Judge Panel&lt;/div&gt;
 88:           &lt;div className=&quot;agreement-grid&quot;&gt;
 89:             &lt;span className=&quot;ag-header&quot;&gt;Evaluator&lt;/span&gt;
 90:             &lt;span className=&quot;ag-header&quot;&gt;Score&lt;/span&gt;
 91:             &lt;span className=&quot;ag-header&quot;&gt;Label&lt;/span&gt;
 92:             {evaluatorScores!.map((es) =&gt; (
 93:               &lt;div key={es.evaluator} style={{ display: &apos;contents&apos; }}&gt;
 94:                 &lt;span style={{ fontFamily: &apos;var(--font-mono)&apos;, fontSize: 12 }}&gt;{es.evaluator}&lt;/span&gt;
 95:                 &lt;span style={{ fontFamily: &apos;var(--font-mono)&apos;, fontSize: 12 }}&gt;{es.score.toFixed(4)}&lt;/span&gt;
 96:                 &lt;span style={{ fontSize: 12, color: &apos;var(--text-secondary)&apos; }}&gt;{es.label ?? &apos;-&apos;}&lt;/span&gt;
 97:               &lt;/div&gt;
 98:             ))}
 99:           &lt;/div&gt;
100: 
101:           &lt;div className=&quot;agreement-summary&quot;&gt;
102:             &lt;div&gt;
103:               Agreement: &lt;span className=&quot;summary-value&quot;&gt;
104:                 {evaluatorScores!.every(s =&gt; s.label === evaluatorScores![0].label) ? &apos;100%&apos; : &apos;partial&apos;}
105:               &lt;/span&gt;
106:               {&apos; &apos;}({evaluatorScores!.filter(s =&gt; s.label === evaluatorScores![0].label).length}/{evaluatorScores!.length} same label)
107:             &lt;/div&gt;
108:             &lt;div&gt;
109:               Score Range: &lt;span className=&quot;summary-value&quot;&gt;
110:                 {Math.min(...evaluatorScores!.map(s =&gt; s.score)).toFixed(2)} &amp;ndash; {Math.max(...evaluatorScores!.map(s =&gt; s.score)).toFixed(2)}
111:               &lt;/span&gt;
112:               {&apos; &apos;}(spread: {(Math.max(...evaluatorScores!.map(s =&gt; s.score)) - Math.min(...evaluatorScores!.map(s =&gt; s.score))).toFixed(3)})
113:             &lt;/div&gt;
114:           &lt;/div&gt;
115:         &lt;/div&gt;
116:       )}
117:     &lt;/div&gt;
118:   );
119: }</file><file path="src/components/HandoffCard.tsx"> 1: import { scoreColorBand, SCORE_COLORS } from &apos;../lib/quality-utils.js&apos;;
 2: import type { HandoffEvaluation } from &apos;../types.js&apos;;
 3: 
 4: interface HandoffCardProps {
 5:   handoff: HandoffEvaluation;
 6: }
 7: 
 8: export function HandoffCard({ handoff }: HandoffCardProps) {
 9:   const band = scoreColorBand(handoff.score);
10:   const color = SCORE_COLORS[band];
11: 
12:   return (
13:     &lt;div style={{
14:       display: &apos;flex&apos;,
15:       alignItems: &apos;center&apos;,
16:       gap: 12,
17:       padding: &apos;8px 12px&apos;,
18:       borderRadius: 8,
19:       background: &apos;var(--bg-elevated)&apos;,
20:       border: &apos;1px solid var(--border)&apos;,
21:     }}&gt;
22:       &lt;span style={{ fontFamily: &apos;var(--font-mono)&apos;, fontSize: 12, fontWeight: 600 }}&gt;
23:         {handoff.sourceAgent}
24:       &lt;/span&gt;
25:       &lt;span style={{ color: &apos;var(--text-muted)&apos;, fontSize: 14 }}&gt;&amp;rarr;&lt;/span&gt;
26:       &lt;span style={{ fontFamily: &apos;var(--font-mono)&apos;, fontSize: 12, fontWeight: 600 }}&gt;
27:         {handoff.targetAgent}
28:       &lt;/span&gt;
29:       &lt;span style={{
30:         fontSize: 11,
31:         padding: &apos;2px 6px&apos;,
32:         borderRadius: 10,
33:         backgroundColor: `${color}20`,
34:         color,
35:         fontFamily: &apos;var(--font-mono)&apos;,
36:       }}&gt;
37:         {handoff.score.toFixed(2)}
38:       &lt;/span&gt;
39:       {handoff.correctTarget &amp;&amp; (
40:         &lt;span style={{ fontSize: 10, color: &apos;var(--status-healthy)&apos; }} title=&quot;Correct target&quot;&gt;&amp;#10003;&lt;/span&gt;
41:       )}
42:       {handoff.contextPreserved &amp;&amp; (
43:         &lt;span style={{ fontSize: 10, color: &apos;var(--status-healthy)&apos; }} title=&quot;Context preserved&quot;&gt;&amp;#9679;&lt;/span&gt;
44:       )}
45:     &lt;/div&gt;
46:   );
47: }</file><file path="src/components/HealthOverview.tsx">  1: import type { QualityDashboardSummary } from &apos;../types.js&apos;;
  2: import { StatusBadge } from &apos;./Indicators.js&apos;;
  3: 
  4: interface PipelineHealth {
  5:   evalVolume: number;
  6:   lastEvalAge: string | null;
  7:   evalRate: string;
  8: }
  9: 
 10: function computePipelineHealth(dashboard: QualityDashboardSummary): PipelineHealth {
 11:   let totalSamples = 0;
 12:   let latestTs: string | null = null;
 13: 
 14:   for (const m of dashboard.metrics) {
 15:     totalSamples += m.sampleCount;
 16:   }
 17: 
 18:   // Find most recent evaluation timestamp from worst explanations
 19:   for (const m of dashboard.metrics) {
 20:     const worst = (m as QualityDashboardSummary[&apos;metrics&apos;][number] &amp; { worstExplanation?: { timestamp?: string } }).worstExplanation;
 21:     if (worst?.timestamp) {
 22:       if (!latestTs || worst.timestamp &gt; latestTs) latestTs = worst.timestamp;
 23:     }
 24:   }
 25: 
 26:   let lastEvalAge: string | null = null;
 27:   if (latestTs) {
 28:     const diffMs = Date.now() - new Date(latestTs).getTime();
 29:     const diffSec = Math.floor(diffMs / 1000);
 30:     if (diffSec &lt; 60) lastEvalAge = `${diffSec}s ago`;
 31:     else if (diffSec &lt; 3600) lastEvalAge = `${Math.floor(diffSec / 60)}m ago`;
 32:     else if (diffSec &lt; 86400) lastEvalAge = `${Math.floor(diffSec / 3600)}h ago`;
 33:     else lastEvalAge = `${Math.floor(diffSec / 86400)}d ago`;
 34:   }
 35: 
 36:   // Compute rate based on period
 37:   const period = dashboard.metrics[0]?.period;
 38:   let periodHours = 168; // default 7d
 39:   if (period) {
 40:     const diffMs = new Date(period.end).getTime() - new Date(period.start).getTime();
 41:     periodHours = Math.max(1, diffMs / (60 * 60 * 1000));
 42:   }
 43:   const perHour = totalSamples / periodHours;
 44:   const evalRate = perHour &gt;= 100 ? `${(perHour / 1000).toFixed(1)}k/hr`
 45:     : perHour &gt;= 1 ? `${perHour.toFixed(0)}/hr`
 46:     : `${(perHour * 24).toFixed(1)}/day`;
 47: 
 48:   return { evalVolume: totalSamples, lastEvalAge, evalRate };
 49: }
 50: 
 51: function formatVolume(n: number): string {
 52:   if (n &gt;= 10000) return `${(n / 1000).toFixed(1)}k`;
 53:   if (n &gt;= 1000) return `${(n / 1000).toFixed(1)}k`;
 54:   return String(n);
 55: }
 56: 
 57: export function HealthOverview({ dashboard }: { dashboard: QualityDashboardSummary }) {
 58:   const { overallStatus, summary } = dashboard;
 59:   const pipeline = computePipelineHealth(dashboard);
 60: 
 61:   return (
 62:     &lt;div className={`health-banner ${overallStatus}`}&gt;
 63:       &lt;div&gt;
 64:         &lt;div style={{ display: &apos;flex&apos;, alignItems: &apos;center&apos;, gap: 12 }}&gt;
 65:           &lt;StatusBadge status={overallStatus} /&gt;
 66:           &lt;span style={{ fontSize: 14 }}&gt;
 67:             {overallStatus === &apos;healthy&apos; &amp;&amp; &apos;All metrics within thresholds&apos;}
 68:             {overallStatus === &apos;warning&apos; &amp;&amp; &apos;Some metrics need attention&apos;}
 69:             {overallStatus === &apos;critical&apos; &amp;&amp; &apos;Critical issues detected&apos;}
 70:             {overallStatus === &apos;no_data&apos; &amp;&amp; &apos;No evaluation data available&apos;}
 71:           &lt;/span&gt;
 72:         &lt;/div&gt;
 73:         &lt;div className=&quot;pipeline-stats&quot;&gt;
 74:           &lt;div className=&quot;pipeline-stat&quot;&gt;
 75:             Eval Volume: &lt;span className=&quot;stat-value&quot;&gt;{formatVolume(pipeline.evalVolume)}&lt;/span&gt;
 76:           &lt;/div&gt;
 77:           &lt;div className=&quot;pipeline-stat&quot;&gt;
 78:             Rate: &lt;span className=&quot;stat-value&quot;&gt;{pipeline.evalRate}&lt;/span&gt;
 79:           &lt;/div&gt;
 80:           {pipeline.lastEvalAge &amp;&amp; (
 81:             &lt;div className=&quot;pipeline-stat&quot;&gt;
 82:               Last Eval: &lt;span className=&quot;stat-value&quot;&gt;{pipeline.lastEvalAge}&lt;/span&gt;
 83:             &lt;/div&gt;
 84:           )}
 85:         &lt;/div&gt;
 86:       &lt;/div&gt;
 87:       &lt;div className=&quot;summary-counts&quot;&gt;
 88:         &lt;div className=&quot;summary-count&quot;&gt;
 89:           &lt;div className=&quot;value&quot;&gt;{summary.totalMetrics}&lt;/div&gt;
 90:           &lt;div className=&quot;label&quot;&gt;Total&lt;/div&gt;
 91:         &lt;/div&gt;
 92:         &lt;div className=&quot;summary-count&quot;&gt;
 93:           &lt;div className=&quot;value&quot; style={{ color: &apos;var(--status-healthy)&apos; }}&gt;{summary.healthyMetrics}&lt;/div&gt;
 94:           &lt;div className=&quot;label&quot;&gt;Healthy&lt;/div&gt;
 95:         &lt;/div&gt;
 96:         &lt;div className=&quot;summary-count&quot;&gt;
 97:           &lt;div className=&quot;value&quot; style={{ color: &apos;var(--status-warning)&apos; }}&gt;{summary.warningMetrics}&lt;/div&gt;
 98:           &lt;div className=&quot;label&quot;&gt;Warning&lt;/div&gt;
 99:         &lt;/div&gt;
100:         &lt;div className=&quot;summary-count&quot;&gt;
101:           &lt;div className=&quot;value&quot; style={{ color: &apos;var(--status-critical)&apos; }}&gt;{summary.criticalMetrics}&lt;/div&gt;
102:           &lt;div className=&quot;label&quot;&gt;Critical&lt;/div&gt;
103:         &lt;/div&gt;
104:       &lt;/div&gt;
105:     &lt;/div&gt;
106:   );
107: }</file><file path="src/components/MetaItem.tsx"> 1: export function MetaItem({ label, value }: { label: string; value?: string | number }) {
 2:   if (value == null) return null;
 3:   return (
 4:     &lt;div style={{ minWidth: 120 }}&gt;
 5:       &lt;div className=&quot;section-label&quot;&gt;{label}&lt;/div&gt;
 6:       &lt;div style={{ fontFamily: &apos;var(--font-mono)&apos;, fontSize: 13, marginTop: 2, wordBreak: &apos;break-all&apos; }}&gt;
 7:         {value}
 8:       &lt;/div&gt;
 9:     &lt;/div&gt;
10:   );
11: }</file><file path="src/components/MetricCompare.tsx"> 1: import { useState } from &apos;react&apos;;
 2: import { TrendChart } from &apos;./TrendChart.js&apos;;
 3: import { useMetricDetail } from &apos;../hooks/useMetricDetail.js&apos;;
 4: import { useTrend } from &apos;../hooks/useTrend.js&apos;;
 5: import type { Period, MetricDynamics } from &apos;../types.js&apos;;
 6: 
 7: interface MetricCompareProps {
 8:   metricName?: string;
 9:   period: Period;
10:   availableMetrics: string[];
11:   onMetricChange: (name: string) =&gt; void;
12: }
13: 
14: export function MetricCompare({ metricName, period, availableMetrics, onMetricChange }: MetricCompareProps) {
15:   const { data: detail } = useMetricDetail(metricName, period);
16:   const { data: trend } = useTrend(metricName ?? &apos;&apos;, period, 10);
17: 
18:   if (!metricName) {
19:     return (
20:       &lt;div style={{ padding: 24, color: &apos;var(--text-muted)&apos;, textAlign: &apos;center&apos; }}&gt;
21:         Select a metric from the heatmap or dropdown
22:       &lt;/div&gt;
23:     );
24:   }
25: 
26:   return (
27:     &lt;div style={{ padding: 12 }}&gt;
28:       &lt;select
29:         value={metricName}
30:         onChange={(e) =&gt; onMetricChange(e.target.value)}
31:         style={{
32:           marginBottom: 12,
33:           padding: &apos;4px 8px&apos;,
34:           background: &apos;var(--bg-elevated)&apos;,
35:           border: &apos;1px solid var(--border)&apos;,
36:           borderRadius: 4,
37:           color: &apos;var(--text-primary)&apos;,
38:           fontSize: 13,
39:         }}
40:       &gt;
41:         {availableMetrics.map(m =&gt; &lt;option key={m} value={m}&gt;{m}&lt;/option&gt;)}
42:       &lt;/select&gt;
43: 
44:       {detail &amp;&amp; (
45:         &lt;div style={{ display: &apos;flex&apos;, gap: 16, flexWrap: &apos;wrap&apos;, marginBottom: 12 }}&gt;
46:           {([&apos;avg&apos;, &apos;p50&apos;, &apos;p95&apos;] as const).map(key =&gt; (
47:             &lt;div key={key} style={{ textAlign: &apos;center&apos; }}&gt;
48:               &lt;div style={{ fontFamily: &apos;var(--font-mono)&apos;, fontSize: 16, fontWeight: 600 }}&gt;
49:                 {detail.values[key]?.toFixed(4) ?? &apos;N/A&apos;}
50:               &lt;/div&gt;
51:               &lt;div style={{ fontSize: 11, color: &apos;var(--text-secondary)&apos;, textTransform: &apos;uppercase&apos; }}&gt;{key}&lt;/div&gt;
52:             &lt;/div&gt;
53:           ))}
54:         &lt;/div&gt;
55:       )}
56: 
57:       {detail &amp;&amp; (
58:         &lt;TrendChart
59:           trend={detail.trend}
60:           dynamics={(detail as typeof detail &amp; { dynamics?: MetricDynamics }).dynamics}
61:           metricName={metricName}
62:         /&gt;
63:       )}
64:     &lt;/div&gt;
65:   );
66: }</file><file path="src/components/MetricGrid.tsx"> 1: import type { QualityMetricResult } from &apos;../types.js&apos;;
 2: import { MetricCard } from &apos;./MetricCard.js&apos;;
 3: 
 4: export function MetricGrid({ metrics, sparklines }: {
 5:   metrics: QualityMetricResult[];
 6:   sparklines?: Record&lt;string, (number | null)[]&gt;;
 7: }) {
 8:   return (
 9:     &lt;div className=&quot;metric-grid&quot;&gt;
10:       {metrics.map((m) =&gt; (
11:         &lt;MetricCard key={m.name} metric={m} sparklineData={sparklines?.[m.name]} /&gt;
12:       ))}
13:     &lt;/div&gt;
14:   );
15: }
16: 
17: export function MetricGridSkeleton() {
18:   return (
19:     &lt;div className=&quot;metric-grid&quot;&gt;
20:       {Array.from({ length: 7 }, (_, i) =&gt; (
21:         &lt;div key={i} className=&quot;card skeleton&quot; style={{ height: 180 }} /&gt;
22:       ))}
23:     &lt;/div&gt;
24:   );
25: }</file><file path="src/components/QualityLiveIndicator.tsx"> 1: import { useQualityLive } from &apos;../hooks/useQualityLive.js&apos;;
 2: import { formatTimestamp } from &apos;../lib/quality-utils.js&apos;;
 3: 
 4: const SCORE_THRESHOLD_GREEN = 0.8;
 5: const SCORE_THRESHOLD_YELLOW = 0.5;
 6: 
 7: function scoreToBadgeColor(score: number): string {
 8:   if (score &gt;= SCORE_THRESHOLD_GREEN) return &apos;#26d97f&apos;;
 9:   if (score &gt;= SCORE_THRESHOLD_YELLOW) return &apos;#e5a00d&apos;;
10:   return &apos;#f04438&apos;;
11: }
12: 
13: export function QualityLiveIndicator() {
14:   const { data, isLoading, error } = useQualityLive();
15: 
16:   if (isLoading) {
17:     return &lt;div className=&quot;quality-live-bar&quot; style={{ opacity: 0.5 }}&gt;Loading quality signals...&lt;/div&gt;;
18:   }
19: 
20:   if (error || !data) {
21:     return null;
22:   }
23: 
24:   if (data.metrics.length === 0) {
25:     return null;
26:   }
27: 
28:   return (
29:     &lt;div
30:       className=&quot;quality-live-bar&quot;
31:       role=&quot;status&quot;
32:       aria-label=&quot;Live quality signals&quot;
33:       style={{
34:         display: &apos;flex&apos;,
35:         alignItems: &apos;center&apos;,
36:         gap: 8,
37:         flexWrap: &apos;wrap&apos;,
38:         padding: &apos;6px 12px&apos;,
39:         fontSize: 12,
40:         borderRadius: 6,
41:         background: &apos;var(--surface, #1a1a2e)&apos;,
42:         border: &apos;1px solid var(--border, #2a2a3e)&apos;,
43:       }}
44:     &gt;
45:       &lt;span style={{ color: &apos;var(--text-secondary)&apos;, fontWeight: 600, marginRight: 4 }}&gt;
46:         Quality
47:       &lt;/span&gt;
48:       {data.metrics.map((m) =&gt; (
49:         &lt;span
50:           key={m.name}
51:           title={`${m.name}: ${m.score.toFixed(2)} (${m.evaluatorType})`}
52:           style={{
53:             display: &apos;inline-flex&apos;,
54:             alignItems: &apos;center&apos;,
55:             gap: 4,
56:             padding: &apos;2px 8px&apos;,
57:             borderRadius: 12,
58:             background: scoreToBadgeColor(m.score) + &apos;1a&apos;,
59:             color: scoreToBadgeColor(m.score),
60:             fontFamily: &apos;var(--font-mono)&apos;,
61:             fontSize: 11,
62:             fontWeight: 500,
63:           }}
64:         &gt;
65:           &lt;span style={{
66:             width: 6,
67:             height: 6,
68:             borderRadius: &apos;50%&apos;,
69:             background: scoreToBadgeColor(m.score),
70:           }} /&gt;
71:           {m.name.replace(/_/g, &apos; &apos;)}
72:           &lt;span style={{ fontWeight: 700 }}&gt;{m.score.toFixed(2)}&lt;/span&gt;
73:         &lt;/span&gt;
74:       ))}
75:       &lt;span style={{ color: &apos;var(--text-secondary)&apos;, fontSize: 10, marginLeft: &apos;auto&apos; }}&gt;
76:         {formatTimestamp(data.lastUpdated)}
77:       &lt;/span&gt;
78:     &lt;/div&gt;
79:   );
80: }</file><file path="src/components/SLATable.tsx"> 1: import type { SLAComplianceResult } from &apos;../types.js&apos;;
 2: import { StatusBadge } from &apos;./Indicators.js&apos;;
 3: 
 4: export function SLATable({ slas }: { slas: SLAComplianceResult[] }) {
 5:   if (slas.length === 0) return null;
 6: 
 7:   return (
 8:     &lt;table className=&quot;sla-table&quot;&gt;
 9:       &lt;thead&gt;
10:         &lt;tr&gt;
11:           &lt;th&gt;Metric&lt;/th&gt;
12:           &lt;th&gt;Target&lt;/th&gt;
13:           &lt;th&gt;Actual&lt;/th&gt;
14:           &lt;th&gt;Gap&lt;/th&gt;
15:           &lt;th&gt;Status&lt;/th&gt;
16:         &lt;/tr&gt;
17:       &lt;/thead&gt;
18:       &lt;tbody&gt;
19:         {slas.map((sla) =&gt; (
20:           &lt;tr key={`${sla.sla.metric}-${sla.sla.aggregation}`}&gt;
21:             &lt;td&gt;{sla.sla.metric} ({sla.sla.aggregation})&lt;/td&gt;
22:             &lt;td style={{ fontFamily: &apos;var(--font-mono)&apos; }}&gt;
23:               {sla.sla.direction === &apos;above&apos; ? &apos;&gt;=&apos; : &apos;&lt;=&apos;} {sla.sla.target.toFixed(4)}
24:             &lt;/td&gt;
25:             &lt;td style={{ fontFamily: &apos;var(--font-mono)&apos; }}&gt;
26:               {sla.actualValue !== null ? sla.actualValue.toFixed(4) : &apos;N/A&apos;}
27:             &lt;/td&gt;
28:             &lt;td style={{
29:               fontFamily: &apos;var(--font-mono)&apos;,
30:               color: sla.gap !== null &amp;&amp; !sla.compliant ? &apos;var(--status-critical)&apos; : &apos;var(--status-healthy)&apos;,
31:             }}&gt;
32:               {sla.gap !== null ? (sla.gap &gt;= 0 ? &apos;+&apos; : &apos;&apos;) + sla.gap.toFixed(4) : &apos;-&apos;}
33:             &lt;/td&gt;
34:             &lt;td&gt;&lt;StatusBadge status={sla.status} /&gt;&lt;/td&gt;
35:           &lt;/tr&gt;
36:         ))}
37:       &lt;/tbody&gt;
38:     &lt;/table&gt;
39:   );
40: }</file><file path="src/components/SpanTree.tsx">  1: import type { CSSProperties } from &apos;react&apos;;
  2: 
  3: interface SpanNode {
  4:   spanId: string;
  5:   name: string;
  6:   durationMs?: number;
  7:   status?: { code: number; message?: string };
  8:   attributes?: Record&lt;string, unknown&gt;;
  9:   children: SpanNode[];
 10:   evalCount: number;
 11: }
 12: 
 13: interface SpanTreeProps {
 14:   spans: Array&lt;{
 15:     spanId: string;
 16:     name: string;
 17:     durationMs?: number;
 18:     status?: { code: number; message?: string };
 19:     attributes?: Record&lt;string, unknown&gt;;
 20:     parentSpanId?: string;
 21:   }&gt;;
 22:   evalsBySpan: Map&lt;string, number&gt;;
 23:   maxDuration: number;
 24: }
 25: 
 26: function buildTree(
 27:   spans: SpanTreeProps[&apos;spans&apos;],
 28:   evalsBySpan: Map&lt;string, number&gt;,
 29: ): SpanNode[] {
 30:   const nodeMap = new Map&lt;string, SpanNode&gt;();
 31:   const roots: SpanNode[] = [];
 32: 
 33:   for (const s of spans) {
 34:     nodeMap.set(s.spanId, {
 35:       spanId: s.spanId,
 36:       name: s.name,
 37:       durationMs: s.durationMs,
 38:       status: s.status,
 39:       attributes: s.attributes,
 40:       children: [],
 41:       evalCount: evalsBySpan.get(s.spanId) ?? 0,
 42:     });
 43:   }
 44: 
 45:   for (const s of spans) {
 46:     const node = nodeMap.get(s.spanId)!;
 47:     const parentId = (s as { parentSpanId?: string }).parentSpanId;
 48:     if (parentId &amp;&amp; nodeMap.has(parentId)) {
 49:       nodeMap.get(parentId)!.children.push(node);
 50:     } else {
 51:       roots.push(node);
 52:     }
 53:   }
 54: 
 55:   return roots;
 56: }
 57: 
 58: const STATUS_ICONS: Record&lt;number, string&gt; = {
 59:   0: &apos;&apos;,      // UNSET
 60:   1: &apos;\u2713&apos;, // OK ✓
 61:   2: &apos;\u2717&apos;, // ERROR ✗
 62: };
 63: 
 64: function SpanRow({ node, depth, maxDuration }: { node: SpanNode; depth: number; maxDuration: number }) {
 65:   const barPct = maxDuration &gt; 0 &amp;&amp; node.durationMs ? Math.min((node.durationMs / maxDuration) * 100, 100) : 0;
 66:   const statusCode = node.status?.code ?? 0;
 67:   const isError = statusCode === 2;
 68: 
 69:   const barStyle: CSSProperties = {
 70:     height: 4,
 71:     width: `${barPct}%`,
 72:     background: isError ? &apos;var(--status-critical)&apos; : &apos;var(--status-healthy)&apos;,
 73:     borderRadius: 2,
 74:     marginTop: 4,
 75:     minWidth: barPct &gt; 0 ? 2 : 0,
 76:   };
 77: 
 78:   return (
 79:     &lt;&gt;
 80:       &lt;div
 81:         style={{
 82:           paddingLeft: depth * 20 + 8,
 83:           paddingTop: 8,
 84:           paddingBottom: 8,
 85:           borderBottom: &apos;1px solid var(--border)&apos;,
 86:           display: &apos;flex&apos;,
 87:           alignItems: &apos;center&apos;,
 88:           gap: 8,
 89:         }}
 90:       &gt;
 91:         &lt;span style={{ fontSize: 14, color: isError ? &apos;var(--status-critical)&apos; : &apos;var(--text-primary)&apos; }}&gt;
 92:           {STATUS_ICONS[statusCode]}
 93:         &lt;/span&gt;
 94:         &lt;div style={{ flex: 1 }}&gt;
 95:           &lt;div style={{ fontSize: 13, fontWeight: 500 }}&gt;{node.name}&lt;/div&gt;
 96:           &lt;div style={{ display: &apos;flex&apos;, alignItems: &apos;center&apos;, gap: 8 }}&gt;
 97:             &lt;div style={{ flex: 1, background: &apos;var(--bg-secondary)&apos;, borderRadius: 2, height: 4 }}&gt;
 98:               &lt;div style={barStyle} /&gt;
 99:             &lt;/div&gt;
100:             {node.durationMs != null &amp;&amp; (
101:               &lt;span style={{ fontSize: 11, fontFamily: &apos;var(--font-mono)&apos;, color: &apos;var(--text-secondary)&apos;, whiteSpace: &apos;nowrap&apos; }}&gt;
102:                 {node.durationMs &lt; 1000 ? `${node.durationMs.toFixed(0)}ms` : `${(node.durationMs / 1000).toFixed(2)}s`}
103:               &lt;/span&gt;
104:             )}
105:           &lt;/div&gt;
106:         &lt;/div&gt;
107:         {node.evalCount &gt; 0 &amp;&amp; (
108:           &lt;span style={{
109:             fontSize: 10,
110:             padding: &apos;2px 6px&apos;,
111:             borderRadius: 10,
112:             background: &apos;var(--accent-bg)&apos;,
113:             color: &apos;var(--accent)&apos;,
114:             fontWeight: 600,
115:           }}&gt;
116:             {node.evalCount} eval{node.evalCount &gt; 1 ? &apos;s&apos; : &apos;&apos;}
117:           &lt;/span&gt;
118:         )}
119:       &lt;/div&gt;
120:       {node.children.map(child =&gt; (
121:         &lt;SpanRow key={child.spanId} node={child} depth={depth + 1} maxDuration={maxDuration} /&gt;
122:       ))}
123:     &lt;/&gt;
124:   );
125: }
126: 
127: export function SpanTree({ spans, evalsBySpan, maxDuration }: SpanTreeProps) {
128:   const roots = buildTree(spans, evalsBySpan);
129: 
130:   if (roots.length === 0) {
131:     return &lt;div style={{ padding: 16, color: &apos;var(--text-muted)&apos; }}&gt;No spans found for this trace.&lt;/div&gt;;
132:   }
133: 
134:   return (
135:     &lt;div&gt;
136:       {roots.map(node =&gt; (
137:         &lt;SpanRow key={node.spanId} node={node} depth={0} maxDuration={maxDuration} /&gt;
138:       ))}
139:     &lt;/div&gt;
140:   );
141: }</file><file path="src/components/TurnTimeline.tsx"> 1: import { scoreColorBand, SCORE_COLORS } from &apos;../lib/quality-utils.js&apos;;
 2: import type { TurnLevelResult } from &apos;../types.js&apos;;
 3: 
 4: const AGENT_COLORS = [&apos;#6366f1&apos;, &apos;#ec4899&apos;, &apos;#14b8a6&apos;, &apos;#f59e0b&apos;, &apos;#8b5cf6&apos;, &apos;#06b6d4&apos;];
 5: 
 6: function agentColor(agentName: string, agentNames: string[]): string {
 7:   const idx = agentNames.indexOf(agentName);
 8:   return AGENT_COLORS[idx % AGENT_COLORS.length];
 9: }
10: 
11: interface TurnTimelineProps {
12:   turns: TurnLevelResult[];
13:   agentNames: string[];
14: }
15: 
16: export function TurnTimeline({ turns, agentNames }: TurnTimelineProps) {
17:   if (turns.length === 0) {
18:     return &lt;div style={{ padding: 16, color: &apos;var(--text-muted)&apos; }}&gt;No turns to display.&lt;/div&gt;;
19:   }
20: 
21:   return (
22:     &lt;div style={{ display: &apos;flex&apos;, gap: 8, overflowX: &apos;auto&apos;, padding: &apos;8px 0&apos; }}&gt;
23:       {turns.map((turn) =&gt; {
24:         const agent = turn.agentName ?? &apos;unknown&apos;;
25:         const color = agentColor(agent, agentNames);
26:         const band = scoreColorBand(turn.relevance);
27:         const bandColor = SCORE_COLORS[band];
28: 
29:         return (
30:           &lt;div
31:             key={turn.turnIndex}
32:             style={{
33:               minWidth: 120,
34:               padding: 12,
35:               borderRadius: 8,
36:               border: `2px solid ${color}`,
37:               background: &apos;var(--bg-elevated)&apos;,
38:               flexShrink: 0,
39:             }}
40:           &gt;
41:             &lt;div style={{ display: &apos;flex&apos;, justifyContent: &apos;space-between&apos;, alignItems: &apos;center&apos;, marginBottom: 8 }}&gt;
42:               &lt;span style={{ fontSize: 10, fontWeight: 600, color, textTransform: &apos;uppercase&apos; }}&gt;{agent}&lt;/span&gt;
43:               &lt;span style={{ fontSize: 10, color: &apos;var(--text-muted)&apos; }}&gt;#{turn.turnIndex}&lt;/span&gt;
44:             &lt;/div&gt;
45: 
46:             {/* Relevance bar */}
47:             &lt;div style={{ marginBottom: 6 }}&gt;
48:               &lt;div style={{ fontSize: 10, color: &apos;var(--text-secondary)&apos;, marginBottom: 2 }}&gt;Relevance&lt;/div&gt;
49:               &lt;div style={{ height: 6, background: &apos;var(--bg-secondary)&apos;, borderRadius: 3 }}&gt;
50:                 &lt;div style={{
51:                   height: 6,
52:                   width: `${turn.relevance * 100}%`,
53:                   background: bandColor,
54:                   borderRadius: 3,
55:                 }} /&gt;
56:               &lt;/div&gt;
57:             &lt;/div&gt;
58: 
59:             {/* Task progress bar */}
60:             &lt;div style={{ marginBottom: 6 }}&gt;
61:               &lt;div style={{ fontSize: 10, color: &apos;var(--text-secondary)&apos;, marginBottom: 2 }}&gt;Progress&lt;/div&gt;
62:               &lt;div style={{ height: 6, background: &apos;var(--bg-secondary)&apos;, borderRadius: 3 }}&gt;
63:                 &lt;div style={{
64:                   height: 6,
65:                   width: `${turn.taskProgress * 100}%`,
66:                   background: &apos;var(--status-healthy)&apos;,
67:                   borderRadius: 3,
68:                 }} /&gt;
69:               &lt;/div&gt;
70:             &lt;/div&gt;
71: 
72:             {turn.hasError &amp;&amp; (
73:               &lt;div style={{ fontSize: 10, color: &apos;var(--status-critical)&apos;, fontWeight: 600, marginTop: 4 }}&gt;
74:                 Error
75:               &lt;/div&gt;
76:             )}
77:           &lt;/div&gt;
78:         );
79:       })}
80:     &lt;/div&gt;
81:   );
82: }</file><file path="src/hooks/useAgentSession.ts"> 1: import { useQuery } from &apos;@tanstack/react-query&apos;;
 2: import type { MultiAgentEvaluation, EvaluationResult } from &apos;../types.js&apos;;
 3: 
 4: const API_BASE = import.meta.env.VITE_API_URL ?? (import.meta.env.DEV ? &apos;http://localhost:3001&apos; : &apos;&apos;);
 5: 
 6: interface AgentSessionResponse {
 7:   sessionId: string;
 8:   spans: Array&lt;{
 9:     traceId: string;
10:     spanId: string;
11:     name: string;
12:     durationMs?: number;
13:     status?: { code: number; message?: string };
14:     attributes?: Record&lt;string, unknown&gt;;
15:   }&gt;;
16:   evaluation: MultiAgentEvaluation;
17:   evaluations: EvaluationResult[];
18:   agentMap: Record&lt;string, string&gt;;
19: }
20: 
21: export function useAgentSession(sessionId: string | undefined) {
22:   return useQuery&lt;AgentSessionResponse&gt;({
23:     queryKey: [&apos;agent-session&apos;, sessionId],
24:     queryFn: async () =&gt; {
25:       const res = await fetch(`${API_BASE}/api/agents/${encodeURIComponent(sessionId!)}`);
26:       if (!res.ok) throw new Error(`API error: ${res.status}`);
27:       return res.json();
28:     },
29:     enabled: !!sessionId,
30:     staleTime: 30_000,
31:     retry: 2,
32:   });
33: }</file><file path="src/hooks/useCompliance.ts"> 1: import { useQuery } from &apos;@tanstack/react-query&apos;;
 2: import type { SLAComplianceResult, HumanVerificationEvent, Period } from &apos;../types.js&apos;;
 3: 
 4: const API_BASE = import.meta.env.VITE_API_URL ?? (import.meta.env.DEV ? &apos;http://localhost:3001&apos; : &apos;&apos;);
 5: 
 6: interface SLAResponse {
 7:   results: SLAComplianceResult[];
 8:   noSLAsConfigured: boolean;
 9: }
10: 
11: interface VerificationResponse {
12:   count: number;
13:   verifications: HumanVerificationEvent[];
14: }
15: 
16: export function useComplianceSLA(period: Period) {
17:   return useQuery&lt;SLAResponse&gt;({
18:     queryKey: [&apos;compliance-sla&apos;, period],
19:     queryFn: async () =&gt; {
20:       const res = await fetch(`${API_BASE}/api/compliance/sla?period=${period}`);
21:       if (!res.ok) throw new Error(`API error: ${res.status}`);
22:       return res.json();
23:     },
24:     staleTime: 25_000,
25:     retry: 2,
26:   });
27: }
28: 
29: export function useComplianceVerifications(period: Period) {
30:   return useQuery&lt;VerificationResponse&gt;({
31:     queryKey: [&apos;compliance-verifications&apos;, period],
32:     queryFn: async () =&gt; {
33:       const res = await fetch(`${API_BASE}/api/compliance/verifications?period=${period}`);
34:       if (!res.ok) throw new Error(`API error: ${res.status}`);
35:       return res.json();
36:     },
37:     staleTime: 25_000,
38:     retry: 2,
39:   });
40: }</file><file path="src/hooks/useCoverage.ts"> 1: import { useQuery } from &apos;@tanstack/react-query&apos;;
 2: import type { Period, CoverageHeatmap } from &apos;../types.js&apos;;
 3: 
 4: const API_BASE = import.meta.env.VITE_API_URL ?? (import.meta.env.DEV ? &apos;http://localhost:3001&apos; : &apos;&apos;);
 5: 
 6: export type CoverageResponse = CoverageHeatmap &amp; { period: string };
 7: 
 8: export function useCoverage(period: Period, inputKey: &apos;traceId&apos; | &apos;sessionId&apos; = &apos;traceId&apos;) {
 9:   return useQuery&lt;CoverageResponse&gt;({
10:     queryKey: [&apos;coverage&apos;, period, inputKey],
11:     queryFn: async () =&gt; {
12:       const params = new URLSearchParams({ period, inputKey });
13:       const res = await fetch(`${API_BASE}/api/coverage?${params}`);
14:       if (!res.ok) throw new Error(`API error: ${res.status}`);
15:       return res.json();
16:     },
17:     staleTime: 25_000,
18:     retry: 2,
19:   });
20: }</file><file path="src/hooks/useDashboard.ts"> 1: import { useQuery } from &apos;@tanstack/react-query&apos;;
 2: import type { QualityDashboardSummary, RoleView, RoleViewType, Period } from &apos;../types.js&apos;;
 3: 
 4: const API_BASE = import.meta.env.VITE_API_URL ?? (import.meta.env.DEV ? &apos;http://localhost:3001&apos; : &apos;&apos;);
 5: 
 6: export function useDashboard(period: Period, role?: RoleViewType) {
 7:   return useQuery&lt;QualityDashboardSummary | RoleView&gt;({
 8:     queryKey: [&apos;dashboard&apos;, period, role],
 9:     queryFn: async () =&gt; {
10:       const params = new URLSearchParams({ period });
11:       if (role) params.set(&apos;role&apos;, role);
12:       const res = await fetch(`${API_BASE}/api/dashboard?${params}`);
13:       if (!res.ok) throw new Error(`API error: ${res.status}`);
14:       return res.json();
15:     },
16:     refetchInterval: 30_000,
17:     staleTime: 25_000,
18:     retry: 3,
19:     retryDelay: (i) =&gt; Math.min(1000 * 2 ** i, 30_000),
20:   });
21: }</file><file path="src/hooks/useMetricDetail.ts"> 1: import { useQuery } from &apos;@tanstack/react-query&apos;;
 2: import type { MetricDetailResult, Period } from &apos;../types.js&apos;;
 3: 
 4: const API_BASE = import.meta.env.VITE_API_URL ?? (import.meta.env.DEV ? &apos;http://localhost:3001&apos; : &apos;&apos;);
 5: 
 6: export function useMetricDetail(name: string | undefined, period: Period = &apos;30d&apos;) {
 7:   return useQuery&lt;MetricDetailResult&gt;({
 8:     queryKey: [&apos;metric&apos;, name, period],
 9:     queryFn: async () =&gt; {
10:       const res = await fetch(`${API_BASE}/api/metrics/${name}?period=${period}&amp;topN=5&amp;bucketCount=10`);
11:       if (!res.ok) throw new Error(`API error: ${res.status}`);
12:       return res.json();
13:     },
14:     enabled: !!name,
15:     staleTime: 25_000,
16:     retry: 2,
17:   });
18: }</file><file path="src/hooks/useMetricEvaluations.ts"> 1: import { useQuery } from &apos;@tanstack/react-query&apos;;
 2: import type { EvalRow } from &apos;../components/EvaluationTable.js&apos;;
 3: import type { Period } from &apos;../types.js&apos;;
 4: 
 5: const API_BASE = import.meta.env.VITE_API_URL ?? (import.meta.env.DEV ? &apos;http://localhost:3001&apos; : &apos;&apos;);
 6: 
 7: interface EvaluationsResponse {
 8:   rows: EvalRow[];
 9:   total: number;
10:   limit: number;
11:   offset: number;
12:   hasMore: boolean;
13: }
14: 
15: export function useMetricEvaluations(
16:   name: string | undefined,
17:   period: Period = &apos;7d&apos;,
18:   { limit = 50, offset = 0, scoreLabel, sortBy = &apos;timestamp_desc&apos;, enabled = true }: {
19:     limit?: number;
20:     offset?: number;
21:     scoreLabel?: string;
22:     sortBy?: &apos;score_asc&apos; | &apos;score_desc&apos; | &apos;timestamp_desc&apos;;
23:     enabled?: boolean;
24:   } = {},
25: ) {
26:   return useQuery&lt;EvaluationsResponse&gt;({
27:     queryKey: [&apos;metric-evaluations&apos;, name, period, limit, offset, scoreLabel, sortBy],
28:     queryFn: async () =&gt; {
29:       const params = new URLSearchParams({ period, limit: String(limit), offset: String(offset), sortBy });
30:       if (scoreLabel) params.set(&apos;scoreLabel&apos;, scoreLabel);
31:       const res = await fetch(`${API_BASE}/api/metrics/${encodeURIComponent(name!)}/evaluations?${params}`);
32:       if (!res.ok) throw new Error(`API error: ${res.status}`);
33:       return res.json();
34:     },
35:     enabled: !!name &amp;&amp; enabled,
36:     staleTime: 25_000,
37:     retry: 2,
38:   });
39: }</file><file path="src/hooks/usePipeline.ts"> 1: import { useQuery } from &apos;@tanstack/react-query&apos;;
 2: import type { Period, PipelineResult } from &apos;../types.js&apos;;
 3: 
 4: const API_BASE = import.meta.env.VITE_API_URL ?? (import.meta.env.DEV ? &apos;http://localhost:3001&apos; : &apos;&apos;);
 5: 
 6: export type PipelineResponse = PipelineResult &amp; { period: string };
 7: 
 8: export function usePipeline(period: Period) {
 9:   return useQuery&lt;PipelineResponse&gt;({
10:     queryKey: [&apos;pipeline&apos;, period],
11:     queryFn: async () =&gt; {
12:       const params = new URLSearchParams({ period });
13:       const res = await fetch(`${API_BASE}/api/pipeline?${params}`);
14:       if (!res.ok) throw new Error(`API error: ${res.status}`);
15:       return res.json();
16:     },
17:     staleTime: 25_000,
18:     retry: 2,
19:   });
20: }</file><file path="src/hooks/useQualityLive.ts"> 1: import { useEffect, useRef, useState } from &apos;react&apos;;
 2: 
 3: const API_BASE = import.meta.env.VITE_API_URL ?? (import.meta.env.DEV ? &apos;http://localhost:3001&apos; : &apos;&apos;);
 4: 
 5: const POLL_INTERVAL_MS = 30_000;
 6: 
 7: interface LiveMetric {
 8:   name: string;
 9:   score: number;
10:   evaluatorType: string;
11:   timestamp: string;
12: }
13: 
14: export interface QualityLiveData {
15:   metrics: LiveMetric[];
16:   sessionCount: number;
17:   lastUpdated: string;
18: }
19: 
20: export interface UseQualityLiveResult {
21:   data: QualityLiveData | null;
22:   isLoading: boolean;
23:   error: Error | null;
24: }
25: 
26: export function useQualityLive(): UseQualityLiveResult {
27:   const [data, setData] = useState&lt;QualityLiveData | null&gt;(null);
28:   const [isLoading, setIsLoading] = useState(true);
29:   const [error, setError] = useState&lt;Error | null&gt;(null);
30:   const timerRef = useRef&lt;ReturnType&lt;typeof setInterval&gt; | null&gt;(null);
31: 
32:   useEffect(() =&gt; {
33:     let cancelled = false;
34: 
35:     async function fetchLive() {
36:       try {
37:         const res = await fetch(`${API_BASE}/api/quality/live`);
38:         if (!res.ok) throw new Error(`API error: ${res.status}`);
39:         const json = await res.json() as QualityLiveData;
40:         if (!cancelled) {
41:           setData(json);
42:           setError(null);
43:         }
44:       } catch (err) {
45:         if (!cancelled) {
46:           setError(err instanceof Error ? err : new Error(String(err)));
47:         }
48:       } finally {
49:         if (!cancelled) setIsLoading(false);
50:       }
51:     }
52: 
53:     function startPolling() {
54:       fetchLive();
55:       timerRef.current = setInterval(fetchLive, POLL_INTERVAL_MS);
56:     }
57: 
58:     function stopPolling() {
59:       if (timerRef.current) {
60:         clearInterval(timerRef.current);
61:         timerRef.current = null;
62:       }
63:     }
64: 
65:     function handleVisibility() {
66:       if (document.visibilityState === &apos;visible&apos;) {
67:         startPolling();
68:       } else {
69:         stopPolling();
70:       }
71:     }
72: 
73:     startPolling();
74:     document.addEventListener(&apos;visibilitychange&apos;, handleVisibility);
75: 
76:     return () =&gt; {
77:       cancelled = true;
78:       stopPolling();
79:       document.removeEventListener(&apos;visibilitychange&apos;, handleVisibility);
80:     };
81:   }, []);
82: 
83:   return { data, isLoading, error };
84: }</file><file path="src/pages/AgentsPage.tsx"> 1: import { Link } from &apos;wouter&apos;;
 2: import { useAgentStats } from &apos;../hooks/useAgentStats.js&apos;;
 3: import { AgentActivityPanel, AgentActivitySummary } from &apos;../components/AgentActivityPanel.js&apos;;
 4: import type { Period } from &apos;../types.js&apos;;
 5: 
 6: export function AgentsPage({ period }: { period: Period }) {
 7:   const { data, isLoading, error } = useAgentStats(period);
 8: 
 9:   if (isLoading) {
10:     return (
11:       &lt;div&gt;
12:         &lt;Link href=&quot;/&quot; className=&quot;back-link&quot;&gt;&amp;larr; Back to dashboard&lt;/Link&gt;
13:         &lt;div className=&quot;card skeleton&quot; style={{ height: 300 }} /&gt;
14:       &lt;/div&gt;
15:     );
16:   }
17: 
18:   if (error) {
19:     return (
20:       &lt;div&gt;
21:         &lt;Link href=&quot;/&quot; className=&quot;back-link&quot;&gt;&amp;larr; Back to dashboard&lt;/Link&gt;
22:         &lt;div className=&quot;error-state&quot;&gt;
23:           &lt;h2&gt;Failed to load&lt;/h2&gt;
24:           &lt;p&gt;{error.message}&lt;/p&gt;
25:         &lt;/div&gt;
26:       &lt;/div&gt;
27:     );
28:   }
29: 
30:   const agents = data?.agents ?? [];
31: 
32:   return (
33:     &lt;div&gt;
34:       &lt;Link href=&quot;/&quot; className=&quot;back-link&quot;&gt;&amp;larr; Back to dashboard&lt;/Link&gt;
35: 
36:       &lt;div className=&quot;eval-detail-header&quot;&gt;
37:         &lt;h2 style={{ fontSize: 18 }}&gt;Agent Activity&lt;/h2&gt;
38:         &lt;div className=&quot;eval-detail-meta&quot;&gt;
39:           &lt;span style={{ fontSize: 13, color: &apos;var(--text-secondary)&apos; }}&gt;
40:             {data?.startDate} &amp;ndash; {data?.endDate}
41:           &lt;/span&gt;
42:         &lt;/div&gt;
43:       &lt;/div&gt;
44: 
45:       {agents.length &gt; 0 &amp;&amp; &lt;AgentActivitySummary agents={agents} /&gt;}
46: 
47:       &lt;div className=&quot;card&quot;&gt;
48:         &lt;AgentActivityPanel agents={agents} /&gt;
49:       &lt;/div&gt;
50:     &lt;/div&gt;
51:   );
52: }</file><file path="src/pages/CompliancePage.tsx"> 1: import { Link } from &apos;wouter&apos;;
 2: import { useComplianceSLA, useComplianceVerifications } from &apos;../hooks/useCompliance.js&apos;;
 3: import { ComplianceFrameworkMap } from &apos;../components/ComplianceFrameworkMap.js&apos;;
 4: import { SLATable } from &apos;../components/SLATable.js&apos;;
 5: import { formatTimestamp } from &apos;../lib/quality-utils.js&apos;;
 6: import type { Period } from &apos;../types.js&apos;;
 7: 
 8: export function CompliancePage({ period }: { period: Period }) {
 9:   const { data: slaData, isLoading: slaLoading, error: slaError } = useComplianceSLA(period);
10:   const { data: verData, isLoading: verLoading, error: verError } = useComplianceVerifications(period);
11: 
12:   return (
13:     &lt;div&gt;
14:       &lt;Link href=&quot;/&quot; className=&quot;back-link&quot;&gt;&amp;larr; Back to dashboard&lt;/Link&gt;
15: 
16:       &lt;div className=&quot;view-section&quot;&gt;
17:         &lt;h3 className=&quot;section-heading&quot;&gt;SLA Compliance&lt;/h3&gt;
18:         {slaLoading &amp;&amp; &lt;div className=&quot;card skeleton&quot; style={{ height: 120 }} /&gt;}
19:         {slaError &amp;&amp; &lt;div className=&quot;error-state&quot;&gt;&lt;p&gt;{slaError.message}&lt;/p&gt;&lt;/div&gt;}
20:         {slaData &amp;&amp; !slaData.noSLAsConfigured &amp;&amp; slaData.results.length &gt; 0 &amp;&amp; (
21:           &lt;SLATable slas={slaData.results} /&gt;
22:         )}
23:         {slaData &amp;&amp; slaData.noSLAsConfigured &amp;&amp; (
24:           &lt;div className=&quot;card&quot; style={{ padding: 16, color: &apos;var(--text-muted)&apos; }}&gt;
25:             No SLAs configured. Define SLAs in your quality metrics configuration.
26:           &lt;/div&gt;
27:         )}
28:         {slaData &amp;&amp; !slaData.noSLAsConfigured &amp;&amp; slaData.results.length === 0 &amp;&amp; (
29:           &lt;div className=&quot;card&quot; style={{ padding: 16, color: &apos;var(--text-muted)&apos; }}&gt;
30:             All SLAs are compliant for the selected period.
31:           &lt;/div&gt;
32:         )}
33:       &lt;/div&gt;
34: 
35:       &lt;div className=&quot;view-section&quot;&gt;
36:         &lt;h3 className=&quot;section-heading&quot;&gt;Regulatory Framework Mapping&lt;/h3&gt;
37:         &lt;ComplianceFrameworkMap /&gt;
38:       &lt;/div&gt;
39: 
40:       &lt;div className=&quot;view-section&quot;&gt;
41:         &lt;h3 className=&quot;section-heading&quot;&gt;Human Verification Events&lt;/h3&gt;
42:         {verLoading &amp;&amp; &lt;div className=&quot;card skeleton&quot; style={{ height: 120 }} /&gt;}
43:         {verError &amp;&amp; &lt;div className=&quot;error-state&quot;&gt;&lt;p&gt;{verError.message}&lt;/p&gt;&lt;/div&gt;}
44:         {verData &amp;&amp; verData.verifications.length &gt; 0 &amp;&amp; (
45:           &lt;div className=&quot;card&quot;&gt;
46:             &lt;table className=&quot;eval-table&quot; style={{ width: &apos;100%&apos; }}&gt;
47:               &lt;thead&gt;
48:                 &lt;tr&gt;
49:                   &lt;th style={{ textAlign: &apos;left&apos; }}&gt;Timestamp&lt;/th&gt;
50:                   &lt;th style={{ textAlign: &apos;left&apos; }}&gt;Type&lt;/th&gt;
51:                   &lt;th style={{ textAlign: &apos;left&apos; }}&gt;Session&lt;/th&gt;
52:                   &lt;th style={{ textAlign: &apos;left&apos; }}&gt;Verifier&lt;/th&gt;
53:                 &lt;/tr&gt;
54:               &lt;/thead&gt;
55:               &lt;tbody&gt;
56:                 {verData.verifications.map((v, i) =&gt; (
57:                   &lt;tr key={`${v.sessionId}-${v.timestamp}-${i}`}&gt;
58:                     &lt;td style={{ fontSize: 13 }} title={new Date(v.timestamp).toLocaleString()}&gt;
59:                       {formatTimestamp(v.timestamp)}
60:                     &lt;/td&gt;
61:                     &lt;td style={{ fontSize: 13 }}&gt;{v.verificationType}&lt;/td&gt;
62:                     &lt;td style={{ fontFamily: &apos;var(--font-mono)&apos;, fontSize: 12 }}&gt;{v.sessionId}&lt;/td&gt;
63:                     &lt;td style={{ fontSize: 13, color: &apos;var(--text-secondary)&apos; }}&gt;{v.verifierId ?? &apos;-&apos;}&lt;/td&gt;
64:                   &lt;/tr&gt;
65:                 ))}
66:               &lt;/tbody&gt;
67:             &lt;/table&gt;
68:           &lt;/div&gt;
69:         )}
70:         {verData &amp;&amp; verData.verifications.length === 0 &amp;&amp; (
71:           &lt;div className=&quot;card&quot; style={{ padding: 16, color: &apos;var(--text-muted)&apos; }}&gt;
72:             No verification events for the selected period.
73:           &lt;/div&gt;
74:         )}
75:       &lt;/div&gt;
76:     &lt;/div&gt;
77:   );
78: }</file><file path="src/pages/CoveragePage.tsx"> 1: import { useState } from &apos;react&apos;;
 2: import { Link } from &apos;wouter&apos;;
 3: import { CoverageGrid } from &apos;../components/CoverageGrid.js&apos;;
 4: import { useCoverage } from &apos;../hooks/useCoverage.js&apos;;
 5: import type { Period } from &apos;../types.js&apos;;
 6: 
 7: export function CoveragePage({ period }: { period: Period }) {
 8:   const [inputKey, setInputKey] = useState&lt;&apos;traceId&apos; | &apos;sessionId&apos;&gt;(&apos;traceId&apos;);
 9:   const { data, isLoading, error } = useCoverage(period, inputKey);
10: 
11:   if (isLoading) return &lt;div className=&quot;card skeleton&quot; style={{ height: 400 }} /&gt;;
12:   if (error) return &lt;div className=&quot;error-state&quot;&gt;&lt;h2&gt;Failed to load&lt;/h2&gt;&lt;p&gt;{error.message}&lt;/p&gt;&lt;/div&gt;;
13:   if (!data) return null;
14: 
15:   return (
16:     &lt;div&gt;
17:       &lt;Link href=&quot;/&quot; className=&quot;back-link&quot;&gt;&amp;larr; Back to dashboard&lt;/Link&gt;
18:       &lt;div style={{ display: &apos;flex&apos;, alignItems: &apos;center&apos;, gap: 16, marginBottom: 16 }}&gt;
19:         &lt;h2 style={{ fontSize: 18, margin: 0 }}&gt;Evaluation Coverage&lt;/h2&gt;
20:         &lt;select
21:           value={inputKey}
22:           onChange={(e) =&gt; setInputKey(e.target.value as &apos;traceId&apos; | &apos;sessionId&apos;)}
23:           aria-label=&quot;Group by&quot;
24:           style={{ fontSize: 13, padding: &apos;4px 8px&apos;, borderRadius: 4, border: &apos;1px solid var(--border)&apos; }}
25:         &gt;
26:           &lt;option value=&quot;traceId&quot;&gt;By Trace&lt;/option&gt;
27:           &lt;option value=&quot;sessionId&quot;&gt;By Session&lt;/option&gt;
28:         &lt;/select&gt;
29:       &lt;/div&gt;
30:       &lt;div className=&quot;card&quot;&gt;
31:         &lt;CoverageGrid
32:           metrics={data.metrics}
33:           inputs={data.inputs}
34:           cells={data.cells}
35:           gaps={data.gaps}
36:           overallCoveragePercent={data.overallCoveragePercent}
37:         /&gt;
38:       &lt;/div&gt;
39:     &lt;/div&gt;
40:   );
41: }</file><file path="src/main.tsx"> 1: import { createRoot } from &apos;react-dom/client&apos;;
 2: import { QueryClient, QueryClientProvider } from &apos;@tanstack/react-query&apos;;
 3: import { ErrorBoundary } from &apos;react-error-boundary&apos;;
 4: import { App } from &apos;./App.js&apos;;
 5: import &apos;./theme.css&apos;;
 6: 
 7: const queryClient = new QueryClient({
 8:   defaultOptions: {
 9:     queries: {
10:       refetchOnWindowFocus: false,
11:     },
12:   },
13: });
14: 
15: function ErrorFallback({ error, resetErrorBoundary }: { error: Error; resetErrorBoundary: () =&gt; void }) {
16:   return (
17:     &lt;div className=&quot;dashboard-container&quot;&gt;
18:       &lt;div className=&quot;error-state&quot;&gt;
19:         &lt;h2&gt;Something went wrong&lt;/h2&gt;
20:         &lt;p&gt;{error.message}&lt;/p&gt;
21:         &lt;button onClick={resetErrorBoundary} style={{ marginTop: 12, padding: &apos;6px 16px&apos;, cursor: &apos;pointer&apos; }}&gt;
22:           Try again
23:         &lt;/button&gt;
24:       &lt;/div&gt;
25:     &lt;/div&gt;
26:   );
27: }
28: 
29: createRoot(document.getElementById(&apos;root&apos;)!).render(
30:   &lt;ErrorBoundary FallbackComponent={ErrorFallback}&gt;
31:     &lt;QueryClientProvider client={queryClient}&gt;
32:       &lt;App /&gt;
33:     &lt;/QueryClientProvider&gt;
34:   &lt;/ErrorBoundary&gt;
35: );</file><file path="src/api/routes/correlations.ts"> 1: import { Hono } from &apos;hono&apos;;
 2: import { z } from &apos;zod&apos;;
 3: import { computeCorrelationMatrix } from &apos;../../../../dist/lib/quality-feature-engineering.js&apos;;
 4: import { sanitizeErrorForResponse } from &apos;../../../../dist/lib/error-sanitizer.js&apos;;
 5: import { loadEvaluationsByMetric } from &apos;../data-loader.js&apos;;
 6: 
 7: const PeriodSchema = z.enum([&apos;24h&apos;, &apos;7d&apos;, &apos;30d&apos;]).default(&apos;30d&apos;);
 8: const PERIOD_MS: Record&lt;string, number&gt; = {
 9:   &apos;24h&apos;: 24 * 60 * 60 * 1000,
10:   &apos;7d&apos;: 7 * 24 * 60 * 60 * 1000,
11:   &apos;30d&apos;: 30 * 24 * 60 * 60 * 1000,
12: };
13: 
14: export const correlationRoutes = new Hono();
15: 
16: correlationRoutes.get(&apos;/correlations&apos;, async (c) =&gt; {
17:   const periodResult = PeriodSchema.safeParse(c.req.query(&apos;period&apos;));
18:   if (!periodResult.success) {
19:     return c.json({ error: &apos;Invalid period. Must be 24h, 7d, or 30d.&apos; }, 400);
20:   }
21: 
22:   try {
23:     const now = new Date();
24:     const periodMs = PERIOD_MS[periodResult.data] ?? PERIOD_MS[&apos;30d&apos;];
25:     const start = new Date(now.getTime() - periodMs);
26:     const evaluationsByMetric = await loadEvaluationsByMetric(start.toISOString(), now.toISOString());
27: 
28:     const metricTimeSeries = new Map&lt;string, number[]&gt;();
29:     const metricNames: string[] = [];
30:     for (const [name, evals] of evaluationsByMetric) {
31:       metricTimeSeries.set(name, evals.filter(e =&gt; e.scoreValue != null).map(e =&gt; e.scoreValue!));
32:       metricNames.push(name);
33:     }
34: 
35:     const correlations = computeCorrelationMatrix(metricTimeSeries);
36:     return c.json({ correlations, metrics: metricNames });
37:   } catch (err) {
38:     return c.json({ error: sanitizeErrorForResponse(err) }, 500);
39:   }
40: });</file><file path="src/api/routes/coverage.ts"> 1: import { Hono } from &apos;hono&apos;;
 2: import { z } from &apos;zod&apos;;
 3: import { computeCoverageHeatmap } from &apos;../../../../dist/lib/quality-metrics.js&apos;;
 4: import { sanitizeErrorForResponse } from &apos;../../../../dist/lib/error-sanitizer.js&apos;;
 5: import type { EvaluationResult } from &apos;../../../../dist/backends/index.js&apos;;
 6: import { loadEvaluationsByMetric } from &apos;../data-loader.js&apos;;
 7: 
 8: const PeriodSchema = z.enum([&apos;24h&apos;, &apos;7d&apos;, &apos;30d&apos;]).default(&apos;7d&apos;);
 9: const InputKeySchema = z.enum([&apos;traceId&apos;, &apos;sessionId&apos;]).default(&apos;traceId&apos;);
10: 
11: /** Filter out rule-based per-span evaluations; they have incompatible
12:  *  traceId granularity that inflates the coverage input universe.
13:  *  Keeps LLM judge evals (evaluatorType &apos;llm&apos;, undefined for seed/canary). */
14: function filterJudgeEvaluations(
15:   byMetric: Map&lt;string, EvaluationResult[]&gt;,
16: ): Map&lt;string, EvaluationResult[]&gt; {
17:   const filtered = new Map&lt;string, EvaluationResult[]&gt;();
18:   for (const [metric, evals] of byMetric) {
19:     const judgeEvals = evals.filter(e =&gt; e.evaluatorType !== &apos;rule&apos;);
20:     if (judgeEvals.length &gt; 0) {
21:       filtered.set(metric, judgeEvals);
22:     }
23:   }
24:   return filtered;
25: }
26: 
27: const PERIOD_MS: Record&lt;string, number&gt; = {
28:   &apos;24h&apos;: 24 * 60 * 60 * 1000,
29:   &apos;7d&apos;: 7 * 24 * 60 * 60 * 1000,
30:   &apos;30d&apos;: 30 * 24 * 60 * 60 * 1000,
31: };
32: 
33: export const coverageRoutes = new Hono();
34: 
35: /**
36:  * GET /api/coverage
37:  * Returns coverage heatmap: metrics x inputs with gap identification.
38:  *
39:  * Query params:
40:  *   period: &apos;24h&apos; | &apos;7d&apos; | &apos;30d&apos; (default: &apos;7d&apos;)
41:  *   inputKey: &apos;traceId&apos; | &apos;sessionId&apos; (default: &apos;traceId&apos;)
42:  */
43: coverageRoutes.get(&apos;/coverage&apos;, async (c) =&gt; {
44:   const periodResult = PeriodSchema.safeParse(c.req.query(&apos;period&apos;));
45:   if (!periodResult.success) {
46:     return c.json({ error: &apos;Invalid period. Must be 24h, 7d, or 30d.&apos; }, 400);
47:   }
48:   const inputKeyResult = InputKeySchema.safeParse(c.req.query(&apos;inputKey&apos;));
49:   if (!inputKeyResult.success) {
50:     return c.json({ error: &apos;Invalid inputKey. Must be traceId or sessionId.&apos; }, 400);
51:   }
52: 
53:   try {
54:     const now = new Date();
55:     const period = periodResult.data;
56:     const periodMs = PERIOD_MS[period] ?? PERIOD_MS[&apos;7d&apos;];
57:     const start = new Date(now.getTime() - periodMs);
58: 
59:     const allEvaluations = await loadEvaluationsByMetric(
60:       start.toISOString(),
61:       now.toISOString(),
62:     );
63:     const evaluationsByMetric = filterJudgeEvaluations(allEvaluations);
64: 
65:     const heatmap = computeCoverageHeatmap(evaluationsByMetric, {
66:       inputKey: inputKeyResult.data,
67:     });
68: 
69:     return c.json({ period, ...heatmap });
70:   } catch (err) {
71:     return c.json({ error: sanitizeErrorForResponse(err) }, 500);
72:   }
73: });</file><file path="src/api/routes/dashboard.ts">  1: import { Hono } from &apos;hono&apos;;
  2: import { z } from &apos;zod&apos;;
  3: import {
  4:   computeDashboardSummary,
  5:   computeRoleView,
  6:   QUALITY_METRICS,
  7: } from &apos;../../../../dist/lib/quality-metrics.js&apos;;
  8: import type { RoleViewType } from &apos;../../../../dist/lib/quality-metrics.js&apos;;
  9: import type { EvaluationResult } from &apos;../../../../dist/backends/index.js&apos;;
 10: import { computeCQI } from &apos;../../../../dist/lib/quality-feature-engineering.js&apos;;
 11: import { sanitizeErrorForResponse } from &apos;../../../../dist/lib/error-sanitizer.js&apos;;
 12: import { loadEvaluationsByMetric, checkHealth } from &apos;../data-loader.js&apos;;
 13: 
 14: const PeriodSchema = z.enum([&apos;24h&apos;, &apos;7d&apos;, &apos;30d&apos;]).default(&apos;7d&apos;);
 15: const RoleSchema = z.enum([&apos;executive&apos;, &apos;operator&apos;, &apos;auditor&apos;]).optional();
 16: 
 17: function computePeriodDates(period: string): { start: string; end: string } {
 18:   const now = new Date();
 19:   const ms: Record&lt;string, number&gt; = {
 20:     &apos;24h&apos;: 24 * 60 * 60 * 1000,
 21:     &apos;7d&apos;: 7 * 24 * 60 * 60 * 1000,
 22:     &apos;30d&apos;: 30 * 24 * 60 * 60 * 1000,
 23:   };
 24:   const start = new Date(now.getTime() - (ms[period] ?? ms[&apos;7d&apos;]));
 25:   return { start: start.toISOString(), end: now.toISOString() };
 26: }
 27: 
 28: /** Bucket evaluations into N time bins and return avg scores per bucket */
 29: function computeSparklineData(
 30:   evaluations: EvaluationResult[],
 31:   startMs: number,
 32:   endMs: number,
 33:   buckets: number,
 34: ): (number | null)[] {
 35:   const range = endMs - startMs;
 36:   if (range &lt;= 0 || evaluations.length === 0) return [];
 37: 
 38:   const bucketWidth = range / buckets;
 39:   const sums = new Array(buckets).fill(0);
 40:   const counts = new Array(buckets).fill(0);
 41: 
 42:   for (const ev of evaluations) {
 43:     if (ev.scoreValue == null || !Number.isFinite(ev.scoreValue)) continue;
 44:     const ts = new Date(ev.timestamp).getTime();
 45:     const idx = Math.min(Math.floor((ts - startMs) / bucketWidth), buckets - 1);
 46:     if (idx &gt;= 0) {
 47:       sums[idx] += ev.scoreValue;
 48:       counts[idx]++;
 49:     }
 50:   }
 51: 
 52:   return sums.map((s, i) =&gt; counts[i] &gt; 0 ? s / counts[i] : null);
 53: }
 54: 
 55: export const dashboardRoutes = new Hono();
 56: 
 57: dashboardRoutes.get(&apos;/dashboard&apos;, async (c) =&gt; {
 58:   const periodResult = PeriodSchema.safeParse(c.req.query(&apos;period&apos;));
 59:   if (!periodResult.success) {
 60:     return c.json({ error: &apos;Invalid period. Must be 24h, 7d, or 30d.&apos; }, 400);
 61:   }
 62:   const roleResult = RoleSchema.safeParse(c.req.query(&apos;role&apos;) || undefined);
 63:   if (!roleResult.success) {
 64:     return c.json({ error: &apos;Invalid role. Must be executive, operator, or auditor.&apos; }, 400);
 65:   }
 66: 
 67:   try {
 68:     const period = periodResult.data;
 69:     const role = roleResult.data;
 70:     const dates = computePeriodDates(period);
 71:     const evaluationsByMetric = await loadEvaluationsByMetric(dates.start, dates.end);
 72:     const dashboard = computeDashboardSummary(evaluationsByMetric, undefined, dates);
 73:     const cqi = computeCQI(dashboard.metrics);
 74: 
 75:     // Compute sparkline data (24 time buckets per metric)
 76:     const startMs = new Date(dates.start).getTime();
 77:     const endMs = new Date(dates.end).getTime();
 78:     const sparklines: Record&lt;string, (number | null)[]&gt; = {};
 79:     for (const [metricName, evals] of evaluationsByMetric) {
 80:       sparklines[metricName] = computeSparklineData(evals, startMs, endMs, 24);
 81:     }
 82: 
 83:     if (role) {
 84:       const view = computeRoleView(dashboard, role as RoleViewType);
 85:       if (role === &apos;executive&apos;) {
 86:         return c.json({ ...view, cqi, sparklines });
 87:       }
 88:       return c.json({ ...view, sparklines });
 89:     }
 90: 
 91:     return c.json({ ...dashboard, cqi, sparklines });
 92:   } catch (err) {
 93:     return c.json({ error: sanitizeErrorForResponse(err) }, 500);
 94:   }
 95: });
 96: 
 97: dashboardRoutes.get(&apos;/health&apos;, async (c) =&gt; {
 98:   try {
 99:     const result = await checkHealth();
100:     return c.json(result);
101:   } catch (err) {
102:     return c.json({ error: sanitizeErrorForResponse(err) }, 500);
103:   }
104: });</file><file path="src/api/routes/sessions.ts">  1: import { Hono } from &apos;hono&apos;;
  2: import { computeMultiAgentEvaluation } from &apos;../../../../dist/lib/quality-multi-agent.js&apos;;
  3: import { sanitizeErrorForResponse } from &apos;../../../../dist/lib/error-sanitizer.js&apos;;
  4: import {
  5:   loadEvaluationsBySessionId,
  6:   loadLogsBySessionId,
  7: } from &apos;../data-loader.js&apos;;
  8: import { queryTraces } from &apos;../../../../dist/tools/query-traces.js&apos;;
  9: import type { EvaluationResult, TraceSpan, StepScore } from &apos;../../../../dist/backends/index.js&apos;;
 10: 
 11: export const sessionRoutes = new Hono();
 12: 
 13: function attr&lt;T&gt;(span: { attributes?: Record&lt;string, unknown&gt; }, key: string): T | undefined {
 14:   return span.attributes?.[key] as T | undefined;
 15: }
 16: 
 17: function percentile(sorted: number[], p: number): number {
 18:   if (sorted.length === 0) return 0;
 19:   const idx = Math.ceil(sorted.length * p / 100) - 1;
 20:   return sorted[Math.max(0, idx)];
 21: }
 22: 
 23: /** Load spans for a session, defaulting to 30-day window. */
 24: async function loadSessionSpans(sessionId: string, startDate?: string, endDate?: string) {
 25:   const now = new Date();
 26:   const end = endDate ?? now.toISOString().split(&apos;T&apos;)[0];
 27:   const start = startDate ?? new Date(now.getTime() - 30 * 24 * 60 * 60 * 1000).toISOString().split(&apos;T&apos;)[0];
 28:   const result = await queryTraces({
 29:     attributeFilter: { &apos;session.id&apos;: sessionId },
 30:     startDate: start,
 31:     endDate: end,
 32:     limit: 1000,
 33:   });
 34:   return result.traces;
 35: }
 36: 
 37: /**
 38:  * GET /api/sessions/:sessionId
 39:  *
 40:  * Returns structured session data from all available telemetry sources:
 41:  * traces, logs, and evaluations — queried in parallel by sessionId.
 42:  */
 43: sessionRoutes.get(&apos;/sessions/:sessionId&apos;, async (c) =&gt; {
 44:   const sessionId = c.req.param(&apos;sessionId&apos;);
 45:   if (!sessionId) return c.json({ error: &apos;sessionId required&apos; }, 400);
 46:   const startDate = c.req.query(&apos;startDate&apos;);
 47:   const endDate = c.req.query(&apos;endDate&apos;);
 48: 
 49:   try {
 50:     // Query all 3 data sources in parallel
 51:     const [spans, logs, evaluations] = await Promise.all([
 52:       loadSessionSpans(sessionId, startDate, endDate),
 53:       loadLogsBySessionId(sessionId, startDate, endDate),
 54:       loadEvaluationsBySessionId(sessionId, startDate, endDate),
 55:     ]);
 56: 
 57:     // ---- Data Sources Inventory ----
 58:     const traceIds = new Set&lt;string&gt;();
 59:     for (const s of spans) {
 60:       if (s.traceId) traceIds.add(s.traceId);
 61:     }
 62:     const dataSources = {
 63:       traces: { count: spans.length, traceIds: traceIds.size },
 64:       logs: { count: logs.length },
 65:       evaluations: { count: evaluations.length },
 66:       total: spans.length + logs.length + evaluations.length,
 67:     };
 68: 
 69:     // ---- Session Timespan (from evaluation timestamps — trace query strips time fields) ----
 70:     let tsMin = Infinity;
 71:     let tsMax = -Infinity;
 72:     for (const ev of evaluations) {
 73:       const t = new Date(ev.timestamp).getTime();
 74:       if (t &lt; tsMin) tsMin = t;
 75:       if (t &gt; tsMax) tsMax = t;
 76:     }
 77:     for (const l of logs) {
 78:       const t = new Date((l as { timestamp?: string }).timestamp ?? &apos;&apos;).getTime();
 79:       if (!isNaN(t)) {
 80:         if (t &lt; tsMin) tsMin = t;
 81:         if (t &gt; tsMax) tsMax = t;
 82:       }
 83:     }
 84:     const timespan = tsMin &lt; Infinity ? {
 85:       start: new Date(tsMin).toISOString(),
 86:       end: new Date(tsMax).toISOString(),
 87:       durationHours: +((tsMax - tsMin) / 3_600_000).toFixed(1),
 88:     } : null;
 89: 
 90:     // ---- Session Info from session-start spans ----
 91:     const sessionStarts = spans.filter(s =&gt; attr&lt;string&gt;(s, &apos;hook.name&apos;) === &apos;session-start&apos;);
 92:     const first = sessionStarts[0];
 93:     const last = sessionStarts[sessionStarts.length - 1] ?? first;
 94:     const sessionInfo = first ? {
 95:       projectName: attr&lt;string&gt;(first, &apos;project.name&apos;) ?? &apos;unknown&apos;,
 96:       workingDirectory: attr&lt;string&gt;(first, &apos;working.directory&apos;) ?? &apos;&apos;,
 97:       gitRepository: attr&lt;string&gt;(first, &apos;git.repository&apos;) ?? &apos;&apos;,
 98:       gitBranch: attr&lt;string&gt;(first, &apos;git.branch&apos;) ?? &apos;&apos;,
 99:       nodeVersion: attr&lt;string&gt;(first, &apos;node.version&apos;) ?? &apos;&apos;,
100:       resumeCount: sessionStarts.length,
101:       initialMessageCount: attr&lt;number&gt;(first, &apos;context.message_count&apos;) ?? 0,
102:       initialContextTokens: attr&lt;number&gt;(first, &apos;context.estimated_tokens&apos;) ?? 0,
103:       finalMessageCount: attr&lt;number&gt;(last, &apos;context.message_count&apos;) ?? 0,
104:       taskCount: attr&lt;number&gt;(first, &apos;tasks.active&apos;) ?? 0,
105:       uncommittedAtStart: attr&lt;number&gt;(first, &apos;git.uncommitted&apos;) ?? 0,
106:     } : null;
107: 
108:     // ---- Token Progression ----
109:     const tokenProgression = spans
110:       .filter(s =&gt; attr&lt;string&gt;(s, &apos;hook.name&apos;) === &apos;token-metrics-extraction&apos;)
111:       .map(s =&gt; ({
112:         messages: attr&lt;number&gt;(s, &apos;tokens.messages&apos;) ?? 0,
113:         inputTokens: attr&lt;number&gt;(s, &apos;tokens.input&apos;) ?? 0,
114:         outputTokens: attr&lt;number&gt;(s, &apos;tokens.output&apos;) ?? 0,
115:         cacheRead: attr&lt;number&gt;(s, &apos;tokens.cache_read&apos;) ?? 0,
116:         cacheCreation: attr&lt;number&gt;(s, &apos;tokens.cache_creation&apos;) ?? 0,
117:         model: attr&lt;string&gt;(s, &apos;tokens.model&apos;) ?? &apos;&apos;,
118:       }))
119:       .sort((a, b) =&gt; a.messages - b.messages);
120: 
121:     // ---- Token Totals ----
122:     const tokenTotals = {
123:       input: 0, output: 0, cacheRead: 0, cacheCreation: 0, messages: 0,
124:       models: {} as Record&lt;string, number&gt;,
125:     };
126:     for (const t of tokenProgression) {
127:       tokenTotals.input += t.inputTokens;
128:       tokenTotals.output += t.outputTokens;
129:       tokenTotals.cacheRead += t.cacheRead;
130:       tokenTotals.cacheCreation += t.cacheCreation;
131:       tokenTotals.messages += t.messages;
132:       if (t.model) tokenTotals.models[t.model] = (tokenTotals.models[t.model] ?? 0) + 1;
133:     }
134: 
135:     // ---- Tool Usage ----
136:     const toolUsage: Record&lt;string, number&gt; = {};
137:     for (const s of spans) {
138:       if (attr&lt;string&gt;(s, &apos;hook.type&apos;) === &apos;builtin&apos; &amp;&amp; attr&lt;string&gt;(s, &apos;hook.trigger&apos;) === &apos;PostToolUse&apos;) {
139:         const tool = attr&lt;string&gt;(s, &apos;builtin.tool&apos;) ?? &apos;unknown&apos;;
140:         toolUsage[tool] = (toolUsage[tool] ?? 0) + 1;
141:       }
142:     }
143: 
144:     // ---- MCP Usage ----
145:     const mcpUsage: Record&lt;string, number&gt; = {};
146:     for (const s of spans) {
147:       if (attr&lt;string&gt;(s, &apos;hook.type&apos;) === &apos;mcp&apos; &amp;&amp; attr&lt;string&gt;(s, &apos;hook.trigger&apos;) === &apos;PostToolUse&apos;) {
148:         const tool = attr&lt;string&gt;(s, &apos;mcp.tool&apos;) ?? &apos;unknown&apos;;
149:         mcpUsage[tool] = (mcpUsage[tool] ?? 0) + 1;
150:       }
151:     }
152: 
153:     // ---- Span Breakdown + Hook Latency ----
154:     const spanBreakdown: Record&lt;string, number&gt; = {};
155:     const hookDurations: Record&lt;string, number[]&gt; = {};
156:     for (const s of spans) {
157:       spanBreakdown[s.name] = (spanBreakdown[s.name] ?? 0) + 1;
158:       const ms = s.durationMs ?? 0;
159:       if (ms &gt; 0) {
160:         if (!hookDurations[s.name]) hookDurations[s.name] = [];
161:         hookDurations[s.name].push(ms);
162:       }
163:     }
164:     const hookLatency: Record&lt;string, { count: number; avg: number; p50: number; p95: number; max: number }&gt; = {};
165:     for (const [name, durations] of Object.entries(hookDurations)) {
166:       const sorted = durations.sort((a, b) =&gt; a - b);
167:       hookLatency[name] = {
168:         count: sorted.length,
169:         avg: +(sorted.reduce((a, b) =&gt; a + b, 0) / sorted.length).toFixed(1),
170:         p50: +percentile(sorted, 50).toFixed(1),
171:         p95: +percentile(sorted, 95).toFixed(1),
172:         max: +sorted[sorted.length - 1].toFixed(1),
173:       };
174:     }
175: 
176:     // ---- Error Categorization ----
177:     const errorsByCategory: Record&lt;string, number&gt; = {};
178:     const errorDetails: Array&lt;{
179:       spanName: string;
180:       tool?: string;
181:       errorType?: string;
182:       filePath?: string;
183:     }&gt; = [];
184:     for (const s of spans) {
185:       const hasError = attr&lt;boolean&gt;(s, &apos;builtin.has_error&apos;) === true
186:         || attr&lt;boolean&gt;(s, &apos;agent.has_error&apos;) === true
187:         || s.status?.code === 2;
188:       if (!hasError) continue;
189:       const tool = attr&lt;string&gt;(s, &apos;builtin.tool&apos;) ?? attr&lt;string&gt;(s, &apos;agent.type&apos;) ?? &apos;unknown&apos;;
190:       const errType = attr&lt;string&gt;(s, &apos;builtin.error_type&apos;) ?? &apos;unknown&apos;;
191:       const key = `${tool} -&gt; ${errType}`;
192:       errorsByCategory[key] = (errorsByCategory[key] ?? 0) + 1;
193:       errorDetails.push({
194:         spanName: s.name,
195:         tool,
196:         errorType: errType,
197:         filePath: attr&lt;string&gt;(s, &apos;builtin.file_path&apos;),
198:       });
199:     }
200: 
201:     // ---- Agent Activity ----
202:     const agentAcc: Record&lt;string, { invocations: number; errors: number; hasRateLimit: boolean; totalOutputSize: number }&gt; = {};
203:     for (const s of spans) {
204:       if (attr&lt;string&gt;(s, &apos;hook.name&apos;) === &apos;agent-post-tool&apos;) {
205:         const name = attr&lt;string&gt;(s, &apos;gen_ai.agent.name&apos;) ?? &apos;unknown&apos;;
206:         if (!agentAcc[name]) agentAcc[name] = { invocations: 0, errors: 0, hasRateLimit: false, totalOutputSize: 0 };
207:         agentAcc[name].invocations++;
208:         if (attr&lt;boolean&gt;(s, &apos;agent.has_error&apos;)) agentAcc[name].errors++;
209:         if (attr&lt;boolean&gt;(s, &apos;agent.has_rate_limit&apos;)) agentAcc[name].hasRateLimit = true;
210:         agentAcc[name].totalOutputSize += attr&lt;number&gt;(s, &apos;agent.output_size&apos;) ?? 0;
211:       }
212:     }
213:     const agentActivity = Object.entries(agentAcc).map(([agentName, d]) =&gt; ({
214:       agentName,
215:       invocations: d.invocations,
216:       errors: d.errors,
217:       hasRateLimit: d.hasRateLimit,
218:       avgOutputSize: d.invocations &gt; 0 ? Math.round(d.totalOutputSize / d.invocations) : 0,
219:     }));
220: 
221:     // ---- File Access ----
222:     const fileCount: Record&lt;string, number&gt; = {};
223:     for (const s of spans) {
224:       const fp = attr&lt;string&gt;(s, &apos;builtin.file_path&apos;);
225:       if (fp) fileCount[fp] = (fileCount[fp] ?? 0) + 1;
226:     }
227:     const fileAccess = Object.entries(fileCount)
228:       .map(([path, count]) =&gt; ({ path, count }))
229:       .sort((a, b) =&gt; b.count - a.count)
230:       .slice(0, 30);
231: 
232:     // ---- Git Commits ----
233:     const gitCommits = spans
234:       .filter(s =&gt; attr&lt;string&gt;(s, &apos;hook.name&apos;) === &apos;post-commit-review&apos;)
235:       .map(s =&gt; {
236:         const raw = attr&lt;string&gt;(s, &apos;git.command&apos;) ?? &apos;&apos;;
237:         const filesMatch = raw.match(/git add (.+?)(?:\s+&amp;&amp;)/s);
238:         const files = filesMatch ? filesMatch[1].trim() : &apos;&apos;;
239:         const msgMatch = raw.match(/&lt;&lt;&apos;?EOF&apos;?\n([\s\S]+?)\nCo-Authored/);
240:         const fullMessage = msgMatch ? msgMatch[1] : &apos;&apos;;
241:         const subject = fullMessage ? fullMessage.split(&apos;\n&apos;)[0].trim() : raw.slice(0, 80);
242:         const body = fullMessage ? fullMessage.split(&apos;\n&apos;).slice(2).join(&apos;\n&apos;).trim() : &apos;&apos;;
243:         return { subject, body, files };
244:       });
245: 
246:     // ---- Alert Summary ----
247:     const alertSpans = spans.filter(s =&gt; attr&lt;string&gt;(s, &apos;hook.name&apos;) === &apos;telemetry-alert-evaluation&apos;);
248:     const alertSummary = {
249:       totalFired: alertSpans.reduce((sum, s) =&gt; sum + (attr&lt;number&gt;(s, &apos;alerts.triggered_count&apos;) ?? 0), 0),
250:       stopEvents: alertSpans.length,
251:     };
252: 
253:     // ---- Code Structure ----
254:     const codeStructure = spans
255:       .filter(s =&gt; attr&lt;string&gt;(s, &apos;hook.name&apos;) === &apos;code-structure&apos;)
256:       .map(s =&gt; ({
257:         file: attr&lt;string&gt;(s, &apos;code.structure.file&apos;) ?? &apos;&apos;,
258:         lines: attr&lt;number&gt;(s, &apos;code.structure.lines&apos;) ?? 0,
259:         exports: attr&lt;number&gt;(s, &apos;code.structure.exports&apos;) ?? 0,
260:         functions: attr&lt;number&gt;(s, &apos;code.structure.functions&apos;) ?? 0,
261:         hasTypes: attr&lt;boolean&gt;(s, &apos;code.structure.has_types&apos;) ?? false,
262:         score: attr&lt;number&gt;(s, &apos;code.structure.score&apos;) ?? 0,
263:         tool: attr&lt;string&gt;(s, &apos;code.structure.tool&apos;) ?? &apos;&apos;,
264:       }));
265: 
266:     // ---- Evaluation Breakdown (from direct sessionId query) ----
267:     const evalByName: Record&lt;string, { count: number; scores: number[] }&gt; = {};
268:     for (const ev of evaluations) {
269:       const name = ev.evaluationName;
270:       if (!evalByName[name]) evalByName[name] = { count: 0, scores: [] };
271:       evalByName[name].count++;
272:       if (ev.scoreValue != null &amp;&amp; Number.isFinite(ev.scoreValue)) {
273:         evalByName[name].scores.push(ev.scoreValue);
274:       }
275:     }
276:     const evaluationBreakdown = Object.entries(evalByName).map(([name, d]) =&gt; {
277:       const sorted = d.scores.sort((a, b) =&gt; a - b);
278:       return {
279:         name,
280:         count: d.count,
281:         avg: sorted.length &gt; 0 ? +(sorted.reduce((a, b) =&gt; a + b, 0) / sorted.length).toFixed(3) : null,
282:         min: sorted.length &gt; 0 ? +sorted[0].toFixed(3) : null,
283:         max: sorted.length &gt; 0 ? +sorted[sorted.length - 1].toFixed(3) : null,
284:       };
285:     });
286: 
287:     // ---- Log Summary ----
288:     const logBySeverity: Record&lt;string, number&gt; = {};
289:     for (const l of logs) {
290:       const sev = (l as { severity?: string }).severity ?? &apos;UNKNOWN&apos;;
291:       logBySeverity[sev] = (logBySeverity[sev] ?? 0) + 1;
292:     }
293: 
294:     // ---- Multi-agent Evaluation ----
295:     const agentMapForEval = new Map&lt;number, string&gt;();
296:     spans.forEach((span, i) =&gt; {
297:       const agent = span.attributes?.[&apos;agent.name&apos;] as string | undefined;
298:       if (agent) agentMapForEval.set(i, agent);
299:     });
300:     const stepScores: StepScore[] = spans.map((span, i) =&gt; ({
301:       step: i,
302:       score: typeof span.attributes?.[&apos;evaluation.score&apos;] === &apos;number&apos;
303:         ? span.attributes[&apos;evaluation.score&apos;] as number
304:         : (span.status?.code === 2 ? 0 : 1),
305:       explanation: span.name,
306:     }));
307:     const multiAgentEvaluation = computeMultiAgentEvaluation(stepScores, agentMapForEval);
308: 
309:     return c.json({
310:       sessionId,
311:       dataSources,
312:       timespan,
313:       sessionInfo,
314:       tokenTotals,
315:       tokenProgression,
316:       toolUsage,
317:       mcpUsage,
318:       spanBreakdown,
319:       hookLatency,
320:       errors: { byCategory: errorsByCategory, details: errorDetails },
321:       agentActivity,
322:       fileAccess,
323:       gitCommits,
324:       alertSummary,
325:       codeStructure,
326:       evaluationBreakdown,
327:       logSummary: { bySeverity: logBySeverity, logs },
328:       multiAgentEvaluation,
329:       evaluations,
330:     });
331:   } catch (err) {
332:     return c.json({ error: sanitizeErrorForResponse(err) }, 500);
333:   }
334: });</file><file path="src/components/CoverageGrid.tsx">  1: import { memo, useState, useMemo } from &apos;react&apos;;
  2: import type { CoverageCell, CoverageGap, CoverageStatus } from &apos;../types.js&apos;;
  3: 
  4: interface CoverageGridProps {
  5:   metrics: string[];
  6:   inputs: string[];
  7:   cells: CoverageCell[];
  8:   gaps: CoverageGap[];
  9:   overallCoveragePercent: number;
 10: }
 11: 
 12: const STATUS_COLORS: Record&lt;CoverageStatus, string&gt; = {
 13:   covered: &apos;var(--score-good, #0072B2)&apos;,
 14:   partial: &apos;var(--score-fair, #E69F00)&apos;,
 15:   missing: &apos;var(--score-poor, #D55E00)&apos;,
 16: };
 17: 
 18: /** Truncate long IDs for display */
 19: function truncateId(id: string, max = 10): string {
 20:   if (id.length &lt;= max) return id;
 21:   return id.slice(0, 4) + &apos;\u2026&apos; + id.slice(-4);
 22: }
 23: 
 24: function CoverageGridInner({ metrics, inputs, cells, gaps, overallCoveragePercent }: CoverageGridProps) {
 25:   const [hovered, setHovered] = useState&lt;{ metric: string; input: string } | null&gt;(null);
 26: 
 27:   const cellMap = useMemo(() =&gt; {
 28:     const map = new Map&lt;string, CoverageCell&gt;();
 29:     for (const cell of cells) {
 30:       map.set(`${cell.metric}|${cell.input}`, cell);
 31:     }
 32:     return map;
 33:   }, [cells]);
 34: 
 35:   if (metrics.length === 0 || inputs.length === 0) {
 36:     return &lt;p&gt;No coverage data available.&lt;/p&gt;;
 37:   }
 38: 
 39:   // Limit displayed inputs to avoid huge grids
 40:   const maxInputs = 30;
 41:   const displayInputs = inputs.slice(0, maxInputs);
 42:   const truncated = inputs.length &gt; maxInputs;
 43: 
 44:   return (
 45:     &lt;div role=&quot;region&quot; aria-label=&quot;Evaluation coverage heatmap&quot;&gt;
 46:       {/* Summary bar */}
 47:       &lt;div style={{ display: &apos;flex&apos;, alignItems: &apos;center&apos;, gap: 12, marginBottom: 16 }}&gt;
 48:         &lt;span style={{ fontFamily: &apos;var(--font-mono)&apos;, fontSize: 20, fontWeight: 600 }}&gt;
 49:           {overallCoveragePercent.toFixed(1)}%
 50:         &lt;/span&gt;
 51:         &lt;span style={{ color: &apos;var(--text-secondary)&apos;, fontSize: 14 }}&gt;
 52:           coverage ({metrics.length} metrics x {inputs.length} inputs)
 53:         &lt;/span&gt;
 54:       &lt;/div&gt;
 55: 
 56:       {/* Legend */}
 57:       &lt;div style={{ display: &apos;flex&apos;, gap: 16, marginBottom: 12, fontSize: 12 }}&gt;
 58:         {([&apos;covered&apos;, &apos;partial&apos;, &apos;missing&apos;] as const).map(status =&gt; (
 59:           &lt;div key={status} style={{ display: &apos;flex&apos;, alignItems: &apos;center&apos;, gap: 4 }}&gt;
 60:             &lt;div style={{
 61:               width: 12, height: 12, borderRadius: 2,
 62:               background: STATUS_COLORS[status],
 63:             }} /&gt;
 64:             &lt;span&gt;{status}&lt;/span&gt;
 65:           &lt;/div&gt;
 66:         ))}
 67:       &lt;/div&gt;
 68: 
 69:       {/* Grid */}
 70:       &lt;div style={{ overflowX: &apos;auto&apos; }}&gt;
 71:         &lt;div
 72:           role=&quot;table&quot;
 73:           aria-label=&quot;Coverage matrix&quot;
 74:           style={{
 75:             display: &apos;grid&apos;,
 76:             gridTemplateColumns: `120px repeat(${displayInputs.length}, 28px)`,
 77:             gap: 1,
 78:           }}
 79:         &gt;
 80:           {/* Header row */}
 81:           &lt;div role=&quot;row&quot; style={{ display: &apos;contents&apos; }}&gt;
 82:             &lt;div role=&quot;columnheader&quot; style={{ fontSize: 11, fontWeight: 600 }} /&gt;
 83:             {displayInputs.map(input =&gt; (
 84:               &lt;div
 85:                 key={input}
 86:                 role=&quot;columnheader&quot;
 87:                 title={input}
 88:                 style={{
 89:                   fontSize: 9,
 90:                   writingMode: &apos;vertical-lr&apos;,
 91:                   textAlign: &apos;end&apos;,
 92:                   overflow: &apos;hidden&apos;,
 93:                   maxHeight: 60,
 94:                   color: &apos;var(--text-secondary)&apos;,
 95:                 }}
 96:               &gt;
 97:                 {truncateId(input, 8)}
 98:               &lt;/div&gt;
 99:             ))}
100:           &lt;/div&gt;
101: 
102:           {/* Data rows */}
103:           {metrics.map(metric =&gt; (
104:             &lt;div key={metric} role=&quot;row&quot; style={{ display: &apos;contents&apos; }}&gt;
105:               &lt;div
106:                 role=&quot;rowheader&quot;
107:                 style={{
108:                   fontSize: 12,
109:                   fontWeight: 500,
110:                   display: &apos;flex&apos;,
111:                   alignItems: &apos;center&apos;,
112:                   whiteSpace: &apos;nowrap&apos;,
113:                   overflow: &apos;hidden&apos;,
114:                   textOverflow: &apos;ellipsis&apos;,
115:                 }}
116:                 title={metric}
117:               &gt;
118:                 {metric}
119:               &lt;/div&gt;
120:               {displayInputs.map(input =&gt; {
121:                 const cell = cellMap.get(`${metric}|${input}`);
122:                 const status = cell?.status ?? &apos;missing&apos;;
123:                 const count = cell?.count ?? 0;
124:                 const isHovered = hovered?.metric === metric &amp;&amp; hovered?.input === input;
125: 
126:                 return (
127:                   &lt;div
128:                     key={input}
129:                     role=&quot;cell&quot;
130:                     aria-label={`${metric} / ${truncateId(input)}: ${status} (${count})`}
131:                     title={`${metric} / ${truncateId(input)}: ${count} evaluation${count !== 1 ? &apos;s&apos; : &apos;&apos;}`}
132:                     onMouseEnter={() =&gt; setHovered({ metric, input })}
133:                     onMouseLeave={() =&gt; setHovered(null)}
134:                     style={{
135:                       width: 28,
136:                       height: 28,
137:                       borderRadius: 3,
138:                       background: STATUS_COLORS[status],
139:                       opacity: isHovered ? 1 : 0.8,
140:                       cursor: &apos;default&apos;,
141:                       display: &apos;flex&apos;,
142:                       alignItems: &apos;center&apos;,
143:                       justifyContent: &apos;center&apos;,
144:                       fontSize: 9,
145:                       fontFamily: &apos;var(--font-mono)&apos;,
146:                       color: &apos;#fff&apos;,
147:                       transition: &apos;opacity 0.15s&apos;,
148:                     }}
149:                   &gt;
150:                     {count &gt; 0 ? count : &apos;&apos;}
151:                   &lt;/div&gt;
152:                 );
153:               })}
154:             &lt;/div&gt;
155:           ))}
156:         &lt;/div&gt;
157:       &lt;/div&gt;
158: 
159:       {truncated &amp;&amp; (
160:         &lt;p style={{ fontSize: 12, color: &apos;var(--text-secondary)&apos;, marginTop: 8 }}&gt;
161:           Showing {maxInputs} of {inputs.length} inputs.
162:         &lt;/p&gt;
163:       )}
164: 
165:       {/* Gap summary */}
166:       {gaps.length &gt; 0 &amp;&amp; (
167:         &lt;div style={{ marginTop: 16 }}&gt;
168:           &lt;h4 style={{ fontSize: 14, marginBottom: 8 }}&gt;Coverage Gaps&lt;/h4&gt;
169:           &lt;ul style={{ margin: 0, paddingLeft: 20, fontSize: 13 }}&gt;
170:             {gaps.map(gap =&gt; (
171:               &lt;li key={gap.metric} style={{ marginBottom: 4 }}&gt;
172:                 &lt;strong&gt;{gap.metric}&lt;/strong&gt;: {gap.coveragePercent.toFixed(0)}% covered
173:                 ({gap.missingInputs.length} input{gap.missingInputs.length !== 1 ? &apos;s&apos; : &apos;&apos;} missing)
174:               &lt;/li&gt;
175:             ))}
176:           &lt;/ul&gt;
177:         &lt;/div&gt;
178:       )}
179:     &lt;/div&gt;
180:   );
181: }
182: 
183: export const CoverageGrid = memo(CoverageGridInner);</file><file path="src/components/CQIHero.tsx"> 1: import { scoreColorBand, type ScoreColorBand } from &apos;../lib/quality-utils.js&apos;;
 2: import type { CompositeQualityIndex, CQIContribution } from &apos;../types.js&apos;;
 3: 
 4: const SCORE_COLORS: Record&lt;ScoreColorBand, string&gt; = {
 5:   excellent: &apos;#26d97f&apos;,
 6:   good: &apos;#34d399&apos;,
 7:   adequate: &apos;#e5a00d&apos;,
 8:   poor: &apos;#f97316&apos;,
 9:   failing: &apos;#f04438&apos;,
10: };
11: 
12: function segmentColor(contribution: CQIContribution): string {
13:   const band = scoreColorBand(contribution.rawScore, &apos;maximize&apos;);
14:   return SCORE_COLORS[band];
15: }
16: 
17: export function CQIHero({ cqi }: { cqi: CompositeQualityIndex }) {
18:   const displayValue = (cqi.value * 100).toFixed(1);
19:   const overallBand = scoreColorBand(cqi.value, &apos;maximize&apos;);
20: 
21:   return (
22:     &lt;div
23:       role=&quot;region&quot;
24:       aria-label={`Composite Quality Index: ${displayValue}`}
25:       className=&quot;card&quot;
26:       style={{ padding: 24, textAlign: &apos;center&apos; }}
27:     &gt;
28:       &lt;div style={{ fontSize: 12, color: &apos;var(--text-secondary)&apos;, textTransform: &apos;uppercase&apos;, marginBottom: 4 }}&gt;
29:         Composite Quality Index
30:       &lt;/div&gt;
31:       &lt;div
32:         style={{
33:           fontFamily: &apos;var(--font-mono)&apos;,
34:           fontSize: 36,
35:           fontWeight: 700,
36:           color: SCORE_COLORS[overallBand],
37:           lineHeight: 1.2,
38:         }}
39:       &gt;
40:         {displayValue}
41:       &lt;/div&gt;
42: 
43:       {cqi.contributions.length &gt; 0 &amp;&amp; (
44:         &lt;div
45:           style={{
46:             display: &apos;flex&apos;,
47:             height: 8,
48:             borderRadius: 4,
49:             overflow: &apos;hidden&apos;,
50:             marginTop: 16,
51:           }}
52:         &gt;
53:           {cqi.contributions.map((c) =&gt; (
54:             &lt;div
55:               key={c.metric}
56:               title={`${c.metric}: ${c.rawScore.toFixed(2)} (weight ${(c.weight * 100).toFixed(0)}%)`}
57:               style={{
58:                 flex: c.weight,
59:                 backgroundColor: segmentColor(c),
60:                 minWidth: 2,
61:               }}
62:             /&gt;
63:           ))}
64:         &lt;/div&gt;
65:       )}
66: 
67:       {/* Screen reader breakdown table */}
68:       &lt;table style={{ position: &apos;absolute&apos;, width: 1, height: 1, overflow: &apos;hidden&apos;, clip: &apos;rect(0,0,0,0)&apos; }}&gt;
69:         &lt;caption&gt;CQI Metric Breakdown&lt;/caption&gt;
70:         &lt;thead&gt;
71:           &lt;tr&gt;
72:             &lt;th&gt;Metric&lt;/th&gt;
73:             &lt;th&gt;Raw Score&lt;/th&gt;
74:             &lt;th&gt;Weight&lt;/th&gt;
75:             &lt;th&gt;Contribution&lt;/th&gt;
76:           &lt;/tr&gt;
77:         &lt;/thead&gt;
78:         &lt;tbody&gt;
79:           {cqi.contributions.map((c) =&gt; (
80:             &lt;tr key={c.metric}&gt;
81:               &lt;td&gt;{c.metric}&lt;/td&gt;
82:               &lt;td&gt;{c.rawScore.toFixed(2)}&lt;/td&gt;
83:               &lt;td&gt;{(c.weight * 100).toFixed(0)}%&lt;/td&gt;
84:               &lt;td&gt;{c.contribution.toFixed(3)}&lt;/td&gt;
85:             &lt;/tr&gt;
86:           ))}
87:         &lt;/tbody&gt;
88:       &lt;/table&gt;
89:     &lt;/div&gt;
90:   );
91: }</file><file path="src/components/EvaluationDetail.tsx"> 1: import { useState, useEffect, useRef } from &apos;react&apos;;
 2: import { EvaluationTable, type EvalRow } from &apos;./EvaluationTable.js&apos;;
 3: import { useMetricEvaluations } from &apos;../hooks/useMetricEvaluations.js&apos;;
 4: import type { Period } from &apos;../types.js&apos;;
 5: 
 6: export function EvaluationDetail({
 7:   worst,
 8:   best,
 9:   metricName,
10:   period,
11: }: {
12:   worst: EvalRow[];
13:   best: EvalRow[];
14:   metricName?: string;
15:   period?: Period;
16: }) {
17:   const [showAll, setShowAll] = useState(false);
18:   const prevMetricRef = useRef(metricName);
19: 
20:   useEffect(() =&gt; {
21:     if (prevMetricRef.current !== metricName) {
22:       prevMetricRef.current = metricName;
23:       setShowAll(false);
24:     }
25:   }, [metricName]);
26: 
27:   const { data, isLoading } = useMetricEvaluations(metricName, period, {
28:     limit: 200,
29:     enabled: showAll &amp;&amp; !!metricName,
30:   });
31: 
32:   const topEvals: EvalRow[] = [...worst, ...best];
33:   const displayEvals = showAll &amp;&amp; data ? data.rows : topEvals;
34: 
35:   return (
36:     &lt;div&gt;
37:       &lt;EvaluationTable evaluations={displayEvals} /&gt;
38:       {metricName &amp;&amp; (
39:         &lt;div style={{ marginTop: 12, display: &apos;flex&apos;, alignItems: &apos;center&apos;, gap: 12 }}&gt;
40:           {!showAll ? (
41:             &lt;button
42:               type=&quot;button&quot;
43:               onClick={() =&gt; setShowAll(true)}
44:               style={{
45:                 background: &apos;none&apos;,
46:                 border: &apos;1px solid var(--border)&apos;,
47:                 color: &apos;var(--accent)&apos;,
48:                 padding: &apos;6px 14px&apos;,
49:                 borderRadius: 6,
50:                 fontSize: 13,
51:                 cursor: &apos;pointer&apos;,
52:               }}
53:             &gt;
54:               Show all evaluations
55:             &lt;/button&gt;
56:           ) : isLoading ? (
57:             &lt;span style={{ fontSize: 13, color: &apos;var(--text-secondary)&apos; }}&gt;Loading...&lt;/span&gt;
58:           ) : data ? (
59:             &lt;span style={{ fontSize: 12, color: &apos;var(--text-secondary)&apos; }}&gt;
60:               Showing {data.rows.length} of {data.total} evaluations
61:             &lt;/span&gt;
62:           ) : null}
63:         &lt;/div&gt;
64:       )}
65:     &lt;/div&gt;
66:   );
67: }</file><file path="src/components/EvaluationEventOverlay.tsx"> 1: import { Link } from &apos;wouter&apos;;
 2: import { ScoreBadge } from &apos;./ScoreBadge.js&apos;;
 3: import type { EvaluationResult } from &apos;../types.js&apos;;
 4: 
 5: interface EvaluationEventOverlayProps {
 6:   evaluations: EvaluationResult[];
 7:   traceId?: string;
 8: }
 9: 
10: export function EvaluationEventOverlay({ evaluations, traceId }: EvaluationEventOverlayProps) {
11:   if (evaluations.length === 0) return null;
12: 
13:   const byName = new Map&lt;string, EvaluationResult[]&gt;();
14:   for (const ev of evaluations) {
15:     const name = ev.evaluationName;
16:     if (!byName.has(name)) byName.set(name, []);
17:     byName.get(name)!.push(ev);
18:   }
19: 
20:   return (
21:     &lt;div style={{ display: &apos;flex&apos;, flexWrap: &apos;wrap&apos;, gap: 8 }}&gt;
22:       {[...byName.entries()].map(([name, evs]) =&gt; {
23:         const avg = evs.reduce((s, e) =&gt; s + (e.scoreValue ?? 0), 0) / evs.length;
24:         const card = (
25:           &lt;div style={{
26:             display: &apos;flex&apos;, alignItems: &apos;center&apos;, gap: 6,
27:             padding: &apos;4px 8px&apos;, borderRadius: 6,
28:             background: &apos;var(--bg-elevated)&apos;,
29:             border: &apos;1px solid var(--border)&apos;,
30:             ...(traceId ? { cursor: &apos;pointer&apos;, transition: &apos;border-color 0.15s&apos; } : {}),
31:           }}
32:           className={traceId ? &apos;eval-summary-card&apos; : undefined}
33:           &gt;
34:             &lt;span style={{ fontSize: 12 }}&gt;{name}&lt;/span&gt;
35:             &lt;ScoreBadge score={avg} metricName={name} label={avg.toFixed(2)} /&gt;
36:             &lt;span style={{ fontSize: 10, color: &apos;var(--text-muted)&apos; }}&gt;({evs.length})&lt;/span&gt;
37:           &lt;/div&gt;
38:         );
39: 
40:         if (traceId) {
41:           return (
42:             &lt;Link
43:               key={name}
44:               href={`/evaluations/trace/${traceId}?metric=${encodeURIComponent(name)}`}
45:               style={{ textDecoration: &apos;none&apos;, color: &apos;inherit&apos; }}
46:             &gt;
47:               {card}
48:             &lt;/Link&gt;
49:           );
50:         }
51: 
52:         return &lt;div key={name}&gt;{card}&lt;/div&gt;;
53:       })}
54:     &lt;/div&gt;
55:   );
56: }</file><file path="src/components/Layout.tsx"> 1: import type { ReactNode } from &apos;react&apos;;
 2: import type { Period } from &apos;../types.js&apos;;
 3: import { ShortcutOverlay } from &apos;./ShortcutOverlay.js&apos;;
 4: 
 5: const PERIODS: Period[] = [&apos;24h&apos;, &apos;7d&apos;, &apos;30d&apos;];
 6: 
 7: export function Layout({
 8:   period,
 9:   onPeriodChange,
10:   children,
11: }: {
12:   period: Period;
13:   onPeriodChange: (p: Period) =&gt; void;
14:   children: ReactNode;
15: }) {
16:   return (
17:     &lt;div className=&quot;dashboard-container&quot;&gt;
18:       &lt;div className=&quot;header&quot;&gt;
19:         &lt;h1&gt;Quality Metrics&lt;/h1&gt;
20:         &lt;div className=&quot;period-selector&quot;&gt;
21:           {PERIODS.map((p) =&gt; (
22:             &lt;button
23:               key={p}
24:               className={`period-btn ${p === period ? &apos;active&apos; : &apos;&apos;}`}
25:               onClick={() =&gt; onPeriodChange(p)}
26:             &gt;
27:               {p}
28:             &lt;/button&gt;
29:           ))}
30:         &lt;/div&gt;
31:       &lt;/div&gt;
32:       {children}
33:       &lt;ShortcutOverlay /&gt;
34:     &lt;/div&gt;
35:   );
36: }</file><file path="src/components/PipelineFunnel.tsx"> 1: import { memo } from &apos;react&apos;;
 2: import type { PipelineStage, PipelineDropoff } from &apos;../types.js&apos;;
 3: 
 4: interface PipelineFunnelProps {
 5:   stages: PipelineStage[];
 6:   dropoffs: PipelineDropoff[];
 7:   overallConversionPercent: number;
 8: }
 9: 
10: function PipelineFunnelInner({ stages, dropoffs, overallConversionPercent }: PipelineFunnelProps) {
11:   if (stages.length === 0) return &lt;p&gt;No pipeline data available.&lt;/p&gt;;
12: 
13:   const maxCount = Math.max(...stages.map(s =&gt; s.entryCount), 1);
14: 
15:   return (
16:     &lt;div role=&quot;region&quot; aria-label=&quot;Evaluation pipeline funnel&quot;&gt;
17:       &lt;div style={{ display: &apos;flex&apos;, alignItems: &apos;center&apos;, gap: 8, marginBottom: 16 }}&gt;
18:         &lt;span style={{ fontFamily: &apos;var(--font-mono)&apos;, fontSize: 20, fontWeight: 600 }}&gt;
19:           {overallConversionPercent.toFixed(1)}%
20:         &lt;/span&gt;
21:         &lt;span style={{ color: &apos;var(--text-secondary)&apos;, fontSize: 14 }}&gt;overall conversion&lt;/span&gt;
22:       &lt;/div&gt;
23: 
24:       &lt;div style={{ display: &apos;flex&apos;, flexDirection: &apos;column&apos;, gap: 4 }}&gt;
25:         {stages.map((stage, idx) =&gt; {
26:           const widthPct = Math.max(2, (stage.entryCount / maxCount) * 100);
27:           const dropoff = dropoffs[idx];
28:           const showDropoff = dropoff &amp;&amp; dropoff.dropped &gt; 0;
29: 
30:           return (
31:             &lt;div key={stage.name}&gt;
32:               {/* Stage bar */}
33:               &lt;div style={{ display: &apos;flex&apos;, alignItems: &apos;center&apos;, gap: 12 }}&gt;
34:                 &lt;div
35:                   style={{
36:                     width: `${widthPct}%`,
37:                     minWidth: 40,
38:                     height: 32,
39:                     background: `var(--stage-${stage.name}, var(--accent))`,
40:                     borderRadius: 4,
41:                     display: &apos;flex&apos;,
42:                     alignItems: &apos;center&apos;,
43:                     justifyContent: &apos;space-between&apos;,
44:                     padding: &apos;0 10px&apos;,
45:                     transition: &apos;width 0.3s ease&apos;,
46:                   }}
47:                   role=&quot;meter&quot;
48:                   aria-label={`${stage.displayName}: ${stage.entryCount} evaluations`}
49:                   aria-valuenow={stage.entryCount}
50:                   aria-valuemin={0}
51:                   aria-valuemax={maxCount}
52:                 &gt;
53:                   &lt;span style={{ fontSize: 12, fontWeight: 600, color: &apos;#fff&apos;, whiteSpace: &apos;nowrap&apos; }}&gt;
54:                     {stage.displayName}
55:                   &lt;/span&gt;
56:                   &lt;span style={{ fontSize: 12, fontFamily: &apos;var(--font-mono)&apos;, color: &apos;#fff&apos;, whiteSpace: &apos;nowrap&apos; }}&gt;
57:                     {stage.entryCount.toLocaleString()}
58:                   &lt;/span&gt;
59:                 &lt;/div&gt;
60:               &lt;/div&gt;
61: 
62:               {/* Drop-off indicator */}
63:               {showDropoff &amp;&amp; (
64:                 &lt;div style={{
65:                   fontSize: 11,
66:                   color: dropoff.dropoffPercent &gt; 20 ? &apos;var(--status-warning)&apos; : &apos;var(--text-secondary)&apos;,
67:                   paddingLeft: 10,
68:                   margin: &apos;2px 0&apos;,
69:                 }}&gt;
70:                   {&apos;\u2193&apos;} -{dropoff.dropped.toLocaleString()} ({dropoff.dropoffPercent.toFixed(1)}% drop)
71:                 &lt;/div&gt;
72:               )}
73:             &lt;/div&gt;
74:           );
75:         })}
76:       &lt;/div&gt;
77: 
78:       {/* Screen reader summary table */}
79:       &lt;table className=&quot;sr-only&quot; aria-label=&quot;Pipeline stage details&quot;&gt;
80:         &lt;thead&gt;
81:           &lt;tr&gt;&lt;th&gt;Stage&lt;/th&gt;&lt;th&gt;Entry&lt;/th&gt;&lt;th&gt;Exit&lt;/th&gt;&lt;th&gt;Drop-off&lt;/th&gt;&lt;/tr&gt;
82:         &lt;/thead&gt;
83:         &lt;tbody&gt;
84:           {stages.map((stage, idx) =&gt; (
85:             &lt;tr key={stage.name}&gt;
86:               &lt;td&gt;{stage.displayName}&lt;/td&gt;
87:               &lt;td&gt;{stage.entryCount}&lt;/td&gt;
88:               &lt;td&gt;{stage.exitCount}&lt;/td&gt;
89:               &lt;td&gt;{dropoffs[idx] != null ? `${dropoffs[idx].dropoffPercent.toFixed(1)}%` : &apos;\u2014&apos;}&lt;/td&gt;
90:             &lt;/tr&gt;
91:           ))}
92:         &lt;/tbody&gt;
93:       &lt;/table&gt;
94:     &lt;/div&gt;
95:   );
96: }
97: 
98: export const PipelineFunnel = memo(PipelineFunnelInner);</file><file path="src/components/ProvenancePanel.tsx">  1: import { useCallback } from &apos;react&apos;;
  2: import { Link } from &apos;wouter&apos;;
  3: 
  4: interface EvaluatorTypeCounts {
  5:   rule: number;
  6:   llm: number;
  7:   seed: number;
  8:   canary: number;
  9: }
 10: 
 11: interface ProvenancePanelProps {
 12:   evaluationName: string;
 13:   scoreValue?: number;
 14:   scoreLabel?: string;
 15:   traceId?: string;
 16:   spanId?: string;
 17:   sessionId?: string;
 18:   timestamp: string;
 19:   evaluator?: string;
 20:   evaluatorType?: string;
 21:   scoreUnit?: string;
 22:   agentName?: string;
 23:   /** Raw evaluation object for JSON export */
 24:   rawData?: Record&lt;string, unknown&gt;;
 25:   /** Evaluator type breakdown counts */
 26:   evaluatorTypeCounts?: EvaluatorTypeCounts;
 27: }
 28: 
 29: export function ProvenancePanel(props: ProvenancePanelProps) {
 30:   const {
 31:     evaluationName, scoreValue, scoreLabel,
 32:     traceId, spanId, sessionId, timestamp,
 33:     evaluator, evaluatorType, scoreUnit,
 34:     agentName, rawData, evaluatorTypeCounts,
 35:   } = props;
 36: 
 37:   const handleExportJson = useCallback(() =&gt; {
 38:     const data = rawData ?? {
 39:       evaluationName,
 40:       scoreValue,
 41:       scoreLabel,
 42:       traceId,
 43:       spanId,
 44:       sessionId,
 45:       timestamp,
 46:       evaluator,
 47:       evaluatorType,
 48:       scoreUnit,
 49:       agentName,
 50:     };
 51:     const blob = new Blob([JSON.stringify(data, null, 2)], { type: &apos;application/json&apos; });
 52:     const url = URL.createObjectURL(blob);
 53:     const a = document.createElement(&apos;a&apos;);
 54:     a.href = url;
 55:     a.download = `eval-${evaluationName}-${new Date(timestamp).getTime()}.json`;
 56:     a.click();
 57:     URL.revokeObjectURL(url);
 58:   }, [rawData, evaluationName, scoreValue, scoreLabel, traceId, spanId, sessionId, timestamp, evaluator, evaluatorType, scoreUnit, agentName]);
 59: 
 60:   const handleCopyTraceLink = useCallback(() =&gt; {
 61:     if (traceId) {
 62:       const link = `${window.location.origin}/traces/${traceId}`;
 63:       navigator.clipboard.writeText(link).catch(() =&gt; {});
 64:     }
 65:   }, [traceId]);
 66: 
 67:   const entries: Array&lt;{ label: string; value: string | undefined }&gt; = [
 68:     { label: &apos;Evaluation&apos;, value: evaluationName },
 69:     { label: &apos;Score&apos;, value: scoreValue != null ? `${scoreValue.toFixed(4)}${scoreLabel ? ` (${scoreLabel})` : &apos;&apos;}` : undefined },
 70:     { label: &apos;Evaluator&apos;, value: evaluator },
 71:     { label: &apos;Type&apos;, value: evaluatorType },
 72:     { label: &apos;Score Unit&apos;, value: scoreUnit },
 73:     { label: &apos;Trace ID&apos;, value: traceId },
 74:     { label: &apos;Span ID&apos;, value: spanId },
 75:     { label: &apos;Session ID&apos;, value: sessionId },
 76:     { label: &apos;Agent&apos;, value: agentName },
 77:     { label: &apos;Evaluated At&apos;, value: new Date(timestamp).toISOString() },
 78:     { label: &apos;OTel Event&apos;, value: &apos;gen_ai.evaluation.result&apos; },
 79:   ];
 80: 
 81:   return (
 82:     &lt;div className=&quot;provenance-panel&quot;&gt;
 83:       &lt;div className=&quot;provenance-grid&quot;&gt;
 84:         {entries.map(({ label, value }) =&gt; value ? (
 85:           &lt;div key={label} style={{ display: &apos;contents&apos; }}&gt;
 86:             &lt;span className=&quot;prov-label&quot;&gt;{label}&lt;/span&gt;
 87:             &lt;span className=&quot;prov-value&quot;&gt;
 88:               {label === &apos;Trace ID&apos; &amp;&amp; traceId ? (
 89:                 &lt;Link href={`/traces/${traceId}`} style={{ color: &apos;var(--accent)&apos;, textDecoration: &apos;none&apos; }}&gt;
 90:                   {traceId}
 91:                 &lt;/Link&gt;
 92:               ) : label === &apos;Session ID&apos; &amp;&amp; sessionId ? (
 93:                 &lt;Link href={`/sessions/${sessionId}`} style={{ color: &apos;var(--accent)&apos;, textDecoration: &apos;none&apos; }}&gt;
 94:                   {sessionId}
 95:                 &lt;/Link&gt;
 96:               ) : value}
 97:             &lt;/span&gt;
 98:           &lt;/div&gt;
 99:         ) : null)}
100:       &lt;/div&gt;
101:       {evaluatorTypeCounts &amp;&amp; (
102:         &lt;div style={{ display: &apos;flex&apos;, gap: 6, flexWrap: &apos;wrap&apos;, margin: &apos;8px 0&apos; }}&gt;
103:           {(Object.entries(evaluatorTypeCounts) as Array&lt;[keyof EvaluatorTypeCounts, number]&gt;)
104:             .filter(([, count]) =&gt; count &gt; 0)
105:             .map(([type, count]) =&gt; (
106:               &lt;span
107:                 key={type}
108:                 style={{
109:                   display: &apos;inline-flex&apos;,
110:                   alignItems: &apos;center&apos;,
111:                   gap: 4,
112:                   padding: &apos;2px 8px&apos;,
113:                   borderRadius: 12,
114:                   fontSize: 11,
115:                   fontFamily: &apos;var(--font-mono)&apos;,
116:                   background: &apos;var(--surface, #1a1a2e)&apos;,
117:                   border: &apos;1px solid var(--border, #2a2a3e)&apos;,
118:                   color: &apos;var(--text-secondary)&apos;,
119:                 }}
120:               &gt;
121:                 {type}
122:                 &lt;span style={{ fontWeight: 700, color: &apos;var(--text-primary, #e0e0e0)&apos; }}&gt;
123:                   {count}
124:                 &lt;/span&gt;
125:               &lt;/span&gt;
126:             ))}
127:         &lt;/div&gt;
128:       )}
129:       &lt;div className=&quot;provenance-actions&quot;&gt;
130:         &lt;button type=&quot;button&quot; onClick={handleExportJson}&gt;
131:           Export as JSON
132:         &lt;/button&gt;
133:         {traceId &amp;&amp; (
134:           &lt;button type=&quot;button&quot; onClick={handleCopyTraceLink}&gt;
135:             Copy trace link
136:           &lt;/button&gt;
137:         )}
138:       &lt;/div&gt;
139:     &lt;/div&gt;
140:   );
141: }</file><file path="src/components/RoleSelector.tsx"> 1: import { useLocation } from &apos;wouter&apos;;
 2: import type { RoleViewType } from &apos;../types.js&apos;;
 3: 
 4: const TABS: Array&lt;{ path: string; label: string; role?: RoleViewType }&gt; = [
 5:   { path: &apos;/&apos;, label: &apos;Dashboard&apos; },
 6:   { path: &apos;/role/executive&apos;, label: &apos;Executive&apos;, role: &apos;executive&apos; },
 7:   { path: &apos;/role/operator&apos;, label: &apos;Operator&apos;, role: &apos;operator&apos; },
 8:   { path: &apos;/role/auditor&apos;, label: &apos;Auditor&apos;, role: &apos;auditor&apos; },
 9:   { path: &apos;/correlations&apos;, label: &apos;Correlations&apos; },
10:   { path: &apos;/coverage&apos;, label: &apos;Coverage&apos; },
11:   { path: &apos;/pipeline&apos;, label: &apos;Pipeline&apos; },
12: ];
13: 
14: export function RoleSelector() {
15:   const [location, setLocation] = useLocation();
16: 
17:   return (
18:     &lt;nav className=&quot;tab-nav&quot; role=&quot;tablist&quot; aria-label=&quot;Dashboard views&quot;&gt;
19:       {TABS.map((tab) =&gt; {
20:         const active = location === tab.path;
21:         return (
22:           &lt;button
23:             key={tab.path}
24:             role=&quot;tab&quot;
25:             aria-selected={active}
26:             className=&quot;tab-btn&quot;
27:             onClick={() =&gt; setLocation(tab.path)}
28:           &gt;
29:             {tab.label}
30:           &lt;/button&gt;
31:         );
32:       })}
33:     &lt;/nav&gt;
34:   );
35: }</file><file path="src/components/ShortcutOverlay.tsx"> 1: import { useKeyboardNav } from &apos;../contexts/KeyboardNavContext.js&apos;;
 2: 
 3: export function ShortcutOverlay() {
 4:   const { shortcuts, overlayOpen, toggleOverlay } = useKeyboardNav();
 5: 
 6:   if (!overlayOpen) return null;
 7: 
 8:   const grouped = new Map&lt;string, Array&lt;{ key: string; description: string }&gt;&gt;();
 9:   for (const s of shortcuts) {
10:     if (!grouped.has(s.scope)) grouped.set(s.scope, []);
11:     grouped.get(s.scope)!.push({ key: s.key, description: s.description });
12:   }
13: 
14:   return (
15:     &lt;div className=&quot;shortcut-overlay-backdrop&quot; onClick={toggleOverlay} role=&quot;dialog&quot; aria-modal=&quot;true&quot; aria-label=&quot;Keyboard shortcuts&quot;&gt;
16:       &lt;div className=&quot;shortcut-overlay&quot; onClick={e =&gt; e.stopPropagation()}&gt;
17:         &lt;div style={{ display: &apos;flex&apos;, justifyContent: &apos;space-between&apos;, alignItems: &apos;center&apos;, marginBottom: 16 }}&gt;
18:           &lt;h2 style={{ fontSize: 16, margin: 0 }}&gt;Keyboard Shortcuts&lt;/h2&gt;
19:           &lt;button type=&quot;button&quot; onClick={toggleOverlay} aria-label=&quot;Close&quot; style={{
20:             background: &apos;none&apos;, border: &apos;none&apos;, cursor: &apos;pointer&apos;, fontSize: 18, color: &apos;var(--text-secondary)&apos;,
21:           }}&gt;
22:             &amp;times;
23:           &lt;/button&gt;
24:         &lt;/div&gt;
25:         {[...grouped.entries()].map(([scope, items]) =&gt; (
26:           &lt;div key={scope} style={{ marginBottom: 16 }}&gt;
27:             &lt;div style={{ fontSize: 12, fontWeight: 600, color: &apos;var(--text-secondary)&apos;, textTransform: &apos;uppercase&apos;, marginBottom: 8 }}&gt;
28:               {scope}
29:             &lt;/div&gt;
30:             {items.map(item =&gt; (
31:               &lt;div key={item.key} style={{ display: &apos;flex&apos;, justifyContent: &apos;space-between&apos;, padding: &apos;4px 0&apos;, fontSize: 13 }}&gt;
32:                 &lt;span&gt;{item.description}&lt;/span&gt;
33:                 &lt;kbd style={{
34:                   fontFamily: &apos;var(--font-mono)&apos;, fontSize: 11, padding: &apos;2px 6px&apos;,
35:                   borderRadius: 4, background: &apos;var(--bg-elevated)&apos;, border: &apos;1px solid var(--border)&apos;,
36:                 }}&gt;
37:                   {item.key}
38:                 &lt;/kbd&gt;
39:               &lt;/div&gt;
40:             ))}
41:           &lt;/div&gt;
42:         ))}
43:         &lt;div style={{ fontSize: 12, color: &apos;var(--text-muted)&apos;, marginTop: 8 }}&gt;
44:           Press &lt;kbd style={{ fontFamily: &apos;var(--font-mono)&apos;, fontSize: 11 }}&gt;?&lt;/kbd&gt; or &lt;kbd style={{ fontFamily: &apos;var(--font-mono)&apos;, fontSize: 11 }}&gt;Esc&lt;/kbd&gt; to close
45:         &lt;/div&gt;
46:       &lt;/div&gt;
47:     &lt;/div&gt;
48:   );
49: }</file><file path="src/components/Sparkline.tsx"> 1: import { memo } from &apos;react&apos;;
 2: 
 3: interface SparklineProps {
 4:   /** Array of score values (nulls allowed for gaps) */
 5:   data: (number | null)[];
 6:   /** SVG width in px */
 7:   width?: number;
 8:   /** SVG height in px */
 9:   height?: number;
10:   /** Stroke color (CSS var or hex) */
11:   color?: string;
12:   /** Accessible label for the sparkline */
13:   label?: string;
14: }
15: 
16: function SparklineInner({ data, width = 80, height = 24, color = &apos;var(--text-secondary)&apos;, label }: SparklineProps) {
17:   const values = data.filter((v): v is number =&gt; v !== null &amp;&amp; Number.isFinite(v));
18:   if (values.length &lt; 2) return null;
19: 
20:   const min = Math.min(...values);
21:   const max = Math.max(...values);
22:   const range = max - min || 1;
23:   const pad = 2;
24:   const xDenom = data.length &gt; 1 ? data.length - 1 : 1;
25: 
26:   const points = data
27:     .map((v, i) =&gt; {
28:       if (v === null || !Number.isFinite(v)) return null;
29:       const x = pad + (i / xDenom) * (width - pad * 2);
30:       const y = pad + (1 - (v - min) / range) * (height - pad * 2);
31:       return `${x},${y}`;
32:     })
33:     .filter((p): p is string =&gt; p !== null)
34:     .join(&apos; &apos;);
35: 
36:   return (
37:     &lt;svg
38:       width={width}
39:       height={height}
40:       viewBox={`0 0 ${width} ${height}`}
41:       role=&quot;img&quot;
42:       aria-label={label ?? &apos;Score trend sparkline&apos;}
43:       style={{ display: &apos;block&apos; }}
44:     &gt;
45:       &lt;polyline
46:         points={points}
47:         fill=&quot;none&quot;
48:         stroke={color}
49:         strokeWidth={1.5}
50:         strokeLinecap=&quot;round&quot;
51:         strokeLinejoin=&quot;round&quot;
52:       /&gt;
53:     &lt;/svg&gt;
54:   );
55: }
56: 
57: export const Sparkline = memo(SparklineInner);</file><file path="src/components/TrendSeries.tsx">  1: import {
  2:   ComposedChart,
  3:   Line,
  4:   XAxis,
  5:   YAxis,
  6:   CartesianGrid,
  7:   Tooltip,
  8:   Area,
  9:   ResponsiveContainer,
 10: } from &apos;recharts&apos;;
 11: import type { TrendBucket } from &apos;../hooks/useTrend.js&apos;;
 12: 
 13: interface TrendSeriesProps {
 14:   data: TrendBucket[];
 15:   metricName: string;
 16: }
 17: 
 18: const COLORS = {
 19:   line: &apos;#58a6ff&apos;,
 20:   band: &apos;rgba(88, 166, 255, 0.1)&apos;,
 21:   bandStroke: &apos;rgba(88, 166, 255, 0.3)&apos;,
 22:   grid: &apos;#30363d&apos;,
 23:   text: &apos;#8b949e&apos;,
 24:   tooltip: &apos;#161b22&apos;,
 25:   background: &apos;#0d1117&apos;,
 26: };
 27: 
 28: function formatTime(iso: string, spanDays: number): string {
 29:   const d = new Date(iso);
 30:   if (spanDays &lt;= 1) return d.toLocaleTimeString([], { hour: &apos;2-digit&apos;, minute: &apos;2-digit&apos; });
 31:   if (spanDays &lt;= 7) return d.toLocaleDateString([], { weekday: &apos;short&apos;, hour: &apos;2-digit&apos; });
 32:   return d.toLocaleDateString([], { month: &apos;short&apos;, day: &apos;numeric&apos; });
 33: }
 34: 
 35: export function TrendSeries({ data, metricName }: TrendSeriesProps) {
 36:   if (data.length === 0) {
 37:     return (
 38:       &lt;div style={{ color: COLORS.text, padding: 16, textAlign: &apos;center&apos; }}&gt;
 39:         No trend data available
 40:       &lt;/div&gt;
 41:     );
 42:   }
 43: 
 44:   const spanMs = new Date(data[data.length - 1].endTime).getTime() - new Date(data[0].startTime).getTime();
 45:   const spanDays = spanMs / (1000 * 60 * 60 * 24);
 46: 
 47:   const chartData = data.map((bucket) =&gt; ({
 48:     time: formatTime(bucket.startTime, spanDays),
 49:     avg: bucket.avg,
 50:     p10: bucket.percentiles?.p10 ?? null,
 51:     p50: bucket.percentiles?.p50 ?? null,
 52:     p90: bucket.percentiles?.p90 ?? null,
 53:     count: bucket.count,
 54:   }));
 55: 
 56:   const allVals = chartData.flatMap(d =&gt;
 57:     [d.avg, d.p10, d.p90].filter((v): v is number =&gt; v !== null)
 58:   );
 59:   if (allVals.length === 0) {
 60:     return (
 61:       &lt;div style={{ color: COLORS.text, padding: 16, textAlign: &apos;center&apos; }}&gt;
 62:         No scored evaluations in period
 63:       &lt;/div&gt;
 64:     );
 65:   }
 66: 
 67:   const yMin = Math.min(...allVals);
 68:   const yMax = Math.max(...allVals);
 69:   const yPad = (yMax - yMin) * 0.15 || 0.05;
 70: 
 71:   return (
 72:     &lt;div aria-label={`Time series trend for ${metricName}`}&gt;
 73:       &lt;ResponsiveContainer width=&quot;100%&quot; height={220}&gt;
 74:         &lt;ComposedChart data={chartData} margin={{ top: 8, right: 16, bottom: 4, left: 16 }}&gt;
 75:           &lt;CartesianGrid stroke={COLORS.grid} strokeDasharray=&quot;3 3&quot; /&gt;
 76:           &lt;XAxis
 77:             dataKey=&quot;time&quot;
 78:             tick={{ fill: COLORS.text, fontSize: 11 }}
 79:             stroke={COLORS.grid}
 80:           /&gt;
 81:           &lt;YAxis
 82:             domain={[yMin - yPad, yMax + yPad]}
 83:             tick={{ fill: COLORS.text, fontSize: 11 }}
 84:             stroke={COLORS.grid}
 85:             tickFormatter={(v: number) =&gt; v.toFixed(2)}
 86:             width={48}
 87:           /&gt;
 88:           &lt;Tooltip
 89:             contentStyle={{
 90:               backgroundColor: COLORS.tooltip,
 91:               border: `1px solid ${COLORS.grid}`,
 92:               borderRadius: 6,
 93:               color: COLORS.text,
 94:               fontSize: 12,
 95:             }}
 96:             formatter={(v: number | string | undefined, name?: string) =&gt; [
 97:               typeof v === &apos;number&apos; ? v.toFixed(4) : &apos;N/A&apos;,
 98:               name === &apos;avg&apos; ? &apos;Average&apos; : (name ?? &apos;&apos;).toUpperCase(),
 99:             ]}
100:             labelStyle={{ color: &apos;#e6edf3&apos; }}
101:           /&gt;
102:           {/* P10-P90 band */}
103:           &lt;Area
104:             type=&quot;monotone&quot;
105:             dataKey=&quot;p90&quot;
106:             stroke=&quot;none&quot;
107:             fill={COLORS.band}
108:             connectNulls
109:           /&gt;
110:           &lt;Area
111:             type=&quot;monotone&quot;
112:             dataKey=&quot;p10&quot;
113:             stroke=&quot;none&quot;
114:             fill={COLORS.background}
115:             connectNulls
116:           /&gt;
117:           {/* P50 line */}
118:           &lt;Line
119:             type=&quot;monotone&quot;
120:             dataKey=&quot;p50&quot;
121:             stroke={COLORS.bandStroke}
122:             strokeWidth={1}
123:             strokeDasharray=&quot;4 3&quot;
124:             dot={false}
125:             connectNulls
126:           /&gt;
127:           {/* Average line */}
128:           &lt;Line
129:             type=&quot;monotone&quot;
130:             dataKey=&quot;avg&quot;
131:             stroke={COLORS.line}
132:             strokeWidth={2}
133:             dot={{ fill: COLORS.line, r: 3 }}
134:             activeDot={{ r: 5 }}
135:             connectNulls
136:           /&gt;
137:         &lt;/ComposedChart&gt;
138:       &lt;/ResponsiveContainer&gt;
139:       &lt;div style={{ display: &apos;flex&apos;, gap: 16, justifyContent: &apos;center&apos;, fontSize: 11, color: COLORS.text, marginTop: 4 }}&gt;
140:         &lt;span&gt;&lt;span style={{ color: COLORS.line }}&gt;&amp;#9473;&lt;/span&gt; avg&lt;/span&gt;
141:         &lt;span&gt;&lt;span style={{ opacity: 0.5 }}&gt;- -&lt;/span&gt; p50&lt;/span&gt;
142:         &lt;span&gt;&lt;span style={{ opacity: 0.3 }}&gt;&amp;#9608;&lt;/span&gt; p10-p90&lt;/span&gt;
143:       &lt;/div&gt;
144:     &lt;/div&gt;
145:   );
146: }</file><file path="src/hooks/useTrace.ts"> 1: import { useQuery } from &apos;@tanstack/react-query&apos;;
 2: import type { EvaluationResult } from &apos;../types.js&apos;;
 3: 
 4: const API_BASE = import.meta.env.VITE_API_URL ?? (import.meta.env.DEV ? &apos;http://localhost:3001&apos; : &apos;&apos;);
 5: 
 6: interface TraceSpanResponse {
 7:   traceId: string;
 8:   spanId: string;
 9:   name: string;
10:   kind?: string;
11:   durationMs?: number;
12:   status?: { code: number; message?: string };
13:   attributes?: Record&lt;string, unknown&gt;;
14: }
15: 
16: interface TraceResponse {
17:   traceId: string;
18:   spans: TraceSpanResponse[];
19:   evaluations: EvaluationResult[];
20: }
21: 
22: export function useTrace(traceId: string | undefined) {
23:   return useQuery&lt;TraceResponse&gt;({
24:     queryKey: [&apos;trace&apos;, traceId],
25:     queryFn: async () =&gt; {
26:       const res = await fetch(`${API_BASE}/api/traces/${encodeURIComponent(traceId!)}`);
27:       if (!res.ok) {
28:         // Worker returns 404 with JSON body when trace not in KV — return empty data
29:         if (res.status === 404) return { traceId: traceId!, spans: [], evaluations: [] };
30:         throw new Error(`API error: ${res.status}`);
31:       }
32:       return res.json();
33:     },
34:     enabled: !!traceId,
35:     staleTime: 30_000,
36:     retry: 2,
37:   });
38: }</file><file path="src/pages/PipelinePage.tsx"> 1: import { Link } from &apos;wouter&apos;;
 2: import { PipelineFunnel } from &apos;../components/PipelineFunnel.js&apos;;
 3: import { usePipeline } from &apos;../hooks/usePipeline.js&apos;;
 4: import type { Period } from &apos;../types.js&apos;;
 5: 
 6: const LLM_SAMPLE_RATE = 10;
 7: 
 8: function T2SamplingStage() {
 9:   return (
10:     &lt;div
11:       style={{
12:         display: &apos;flex&apos;,
13:         alignItems: &apos;center&apos;,
14:         gap: 10,
15:         padding: &apos;10px 14px&apos;,
16:         borderRadius: 6,
17:         border: &apos;1px dashed var(--border, #2a2a3e)&apos;,
18:         background: &apos;var(--surface, #1a1a2e)&apos;,
19:         fontSize: 12,
20:         color: &apos;var(--text-secondary)&apos;,
21:         marginTop: 12,
22:       }}
23:     &gt;
24:       &lt;span style={{
25:         display: &apos;inline-flex&apos;,
26:         alignItems: &apos;center&apos;,
27:         justifyContent: &apos;center&apos;,
28:         width: 24,
29:         height: 24,
30:         borderRadius: &apos;50%&apos;,
31:         background: &apos;var(--accent, #6366f1)&apos;,
32:         color: &apos;#fff&apos;,
33:         fontSize: 10,
34:         fontWeight: 700,
35:         flexShrink: 0,
36:       }}&gt;
37:         T2
38:       &lt;/span&gt;
39:       &lt;span&gt;
40:         &lt;strong style={{ color: &apos;var(--text-primary, #e0e0e0)&apos; }}&gt;LLM Sampling&lt;/strong&gt;
41:         {&apos; \u2014 &apos;}
42:         {LLM_SAMPLE_RATE}% sampled for LLM evaluation (relevance, coherence, faithfulness, hallucination)
43:       &lt;/span&gt;
44:     &lt;/div&gt;
45:   );
46: }
47: 
48: export function PipelinePage({ period }: { period: Period }) {
49:   const { data, isLoading, error } = usePipeline(period);
50: 
51:   if (isLoading) return &lt;div className=&quot;card skeleton&quot; style={{ height: 300 }} /&gt;;
52:   if (error) return &lt;div className=&quot;error-state&quot;&gt;&lt;h2&gt;Failed to load&lt;/h2&gt;&lt;p&gt;{error.message}&lt;/p&gt;&lt;/div&gt;;
53:   if (!data) return null;
54: 
55:   return (
56:     &lt;div&gt;
57:       &lt;Link href=&quot;/&quot; className=&quot;back-link&quot;&gt;&amp;larr; Back to dashboard&lt;/Link&gt;
58:       &lt;h2 style={{ fontSize: 18, marginBottom: 16 }}&gt;Evaluation Pipeline&lt;/h2&gt;
59:       &lt;div className=&quot;card&quot;&gt;
60:         &lt;PipelineFunnel
61:           stages={data.stages}
62:           dropoffs={data.dropoffs}
63:           overallConversionPercent={data.overallConversionPercent}
64:         /&gt;
65:         &lt;T2SamplingStage /&gt;
66:       &lt;/div&gt;
67:     &lt;/div&gt;
68:   );
69: }</file><file path="src/api/routes/trends.ts">  1: import { Hono } from &apos;hono&apos;;
  2: import { z } from &apos;zod&apos;;
  3: import {
  4:   computeMetricDetail,
  5:   computeAggregations,
  6:   getQualityMetric,
  7:   QUALITY_METRICS,
  8: } from &apos;../../../../dist/lib/quality-metrics.js&apos;;
  9: import {
 10:   computePercentileDistribution,
 11:   computeMetricDynamics,
 12: } from &apos;../../../../dist/lib/quality-feature-engineering.js&apos;;
 13: import type { MetricTrend } from &apos;../../../../dist/lib/quality-metrics.js&apos;;
 14: import { sanitizeErrorForResponse } from &apos;../../../../dist/lib/error-sanitizer.js&apos;;
 15: import { loadEvaluationsForMetric } from &apos;../data-loader.js&apos;;
 16: 
 17: const PeriodSchema = z.enum([&apos;24h&apos;, &apos;7d&apos;, &apos;30d&apos;]).default(&apos;7d&apos;);
 18: const BucketsSchema = z.coerce.number().int().min(3).max(30).default(7);
 19: 
 20: const PERIOD_MS: Record&lt;string, number&gt; = {
 21:   &apos;24h&apos;: 24 * 60 * 60 * 1000,
 22:   &apos;7d&apos;: 7 * 24 * 60 * 60 * 1000,
 23:   &apos;30d&apos;: 30 * 24 * 60 * 60 * 1000,
 24: };
 25: 
 26: export const trendRoutes = new Hono();
 27: 
 28: /**
 29:  * GET /api/trends/:name
 30:  * Returns time-bucketed trend data with percentile distributions and metric dynamics.
 31:  *
 32:  * Query params:
 33:  *   period: &apos;24h&apos; | &apos;7d&apos; | &apos;30d&apos; (default: &apos;7d&apos;)
 34:  *   buckets: number 3-30 (default: 7) — how many time buckets to divide the period into
 35:  */
 36: trendRoutes.get(&apos;/trends/:name&apos;, async (c) =&gt; {
 37:   const name = c.req.param(&apos;name&apos;);
 38:   const config = getQualityMetric(name);
 39:   if (!config) {
 40:     return c.json({ error: `Unknown metric: ${name}` }, 404);
 41:   }
 42: 
 43:   const periodResult = PeriodSchema.safeParse(c.req.query(&apos;period&apos;));
 44:   if (!periodResult.success) {
 45:     return c.json({ error: &apos;Invalid period. Must be 24h, 7d, or 30d.&apos; }, 400);
 46:   }
 47:   const bucketsResult = BucketsSchema.safeParse(c.req.query(&apos;buckets&apos;));
 48:   if (!bucketsResult.success) {
 49:     return c.json({ error: &apos;Invalid buckets. Must be integer 3-30.&apos; }, 400);
 50:   }
 51: 
 52:   try {
 53:     const now = new Date();
 54:     const period = periodResult.data;
 55:     const bucketCount = bucketsResult.data;
 56:     const periodMs = PERIOD_MS[period] ?? PERIOD_MS[&apos;7d&apos;];
 57:     const periodStart = new Date(now.getTime() - periodMs);
 58: 
 59:     const evaluations = await loadEvaluationsForMetric(name, periodStart.toISOString(), now.toISOString());
 60: 
 61:     // Determine actual data range — auto-narrow if data is concentrated
 62:     const timestamps = evaluations
 63:       .map(e =&gt; new Date(e.timestamp).getTime())
 64:       .filter(Number.isFinite);
 65:     const dataMin = timestamps.length &gt; 0 ? Math.min(...timestamps) : periodStart.getTime();
 66:     const dataMax = timestamps.length &gt; 0 ? Math.max(...timestamps) : now.getTime();
 67:     const dataSpan = dataMax - dataMin;
 68:     const CONCENTRATION_THRESHOLD = 0.2;
 69:     const narrowed = timestamps.length &gt; 1 &amp;&amp; dataSpan &lt; periodMs * CONCENTRATION_THRESHOLD;
 70:     const pad = narrowed ? Math.max(dataSpan * 0.1, 60_000) : 0;
 71:     const start = narrowed ? new Date(dataMin - pad) : periodStart;
 72:     const end = narrowed ? new Date(dataMax + pad) : now;
 73:     const rangeMs = end.getTime() - start.getTime();
 74:     const bucketMs = rangeMs / bucketCount;
 75: 
 76:     // Group evaluations into time buckets
 77:     const buckets: Array&lt;{
 78:       startTime: string;
 79:       endTime: string;
 80:       scores: number[];
 81:     }&gt; = [];
 82: 
 83:     for (let i = 0; i &lt; bucketCount; i++) {
 84:       const bucketStart = new Date(start.getTime() + i * bucketMs);
 85:       const bucketEnd = new Date(start.getTime() + (i + 1) * bucketMs);
 86:       buckets.push({
 87:         startTime: bucketStart.toISOString(),
 88:         endTime: bucketEnd.toISOString(),
 89:         scores: [],
 90:       });
 91:     }
 92: 
 93:     for (const ev of evaluations) {
 94:       const ts = new Date(ev.timestamp).getTime();
 95:       const bucketIdx = Math.min(
 96:         Math.floor((ts - start.getTime()) / bucketMs),
 97:         bucketCount - 1,
 98:       );
 99:       if (bucketIdx &gt;= 0 &amp;&amp; ev.scoreValue != null &amp;&amp; Number.isFinite(ev.scoreValue)) {
100:         buckets[bucketIdx].scores.push(ev.scoreValue);
101:       }
102:     }
103: 
104:     // Compute per-bucket aggregations and trends
105:     const periodHours = rangeMs / (bucketCount * 3600000);
106:     let previousTrend: MetricTrend | undefined;
107: 
108:     const trendData = buckets.map((bucket, idx) =&gt; {
109:       const scores = bucket.scores;
110:       const percentiles = computePercentileDistribution(scores);
111:       const avg = scores.length &gt; 0 ? scores.reduce((s, v) =&gt; s + v, 0) / scores.length : null;
112:       const count = scores.length;
113: 
114:       // Compute previous bucket aggregations for trend
115:       const previousValues = (idx &gt; 0 &amp;&amp; buckets[idx - 1].scores.length &gt; 0)
116:         ? computeAggregations(buckets[idx - 1].scores, config.aggregations)
117:         : undefined;
118: 
119:       // Compute metric detail for trend
120:       const detail = scores.length &gt; 0
121:         ? computeMetricDetail(
122:             evaluations.filter(e =&gt; {
123:               const ts = new Date(e.timestamp).getTime();
124:               const bStart = new Date(bucket.startTime).getTime();
125:               const bEnd = new Date(bucket.endTime).getTime();
126:               return ts &gt;= bStart &amp;&amp; ts &lt; bEnd;
127:             }),
128:             config,
129:             { topN: 0, bucketCount: 0, previousValues },
130:           )
131:         : undefined;
132: 
133:       // Compute dynamics from current and previous trend
134:       let dynamics = undefined;
135:       if (detail?.trend) {
136:         dynamics = computeMetricDynamics(
137:           detail.trend,
138:           previousTrend,
139:           periodHours,
140:         );
141:         previousTrend = detail.trend;
142:       }
143: 
144:       return {
145:         startTime: bucket.startTime,
146:         endTime: bucket.endTime,
147:         count,
148:         avg: avg != null ? Math.round(avg * 10000) / 10000 : null,
149:         percentiles,
150:         trend: detail?.trend ?? null,
151:         dynamics: dynamics ?? null,
152:       };
153:     });
154: 
155:     // Overall percentile distribution across the full period
156:     const allScores = evaluations
157:       .map(e =&gt; e.scoreValue)
158:       .filter((v): v is number =&gt; v != null &amp;&amp; Number.isFinite(v));
159:     const overallPercentiles = computePercentileDistribution(allScores);
160: 
161:     return c.json({
162:       metric: name,
163:       period,
164:       bucketCount,
165:       totalEvaluations: allScores.length,
166:       overallPercentiles,
167:       trendData,
168:       narrowed,
169:     });
170:   } catch (err) {
171:     return c.json({ error: sanitizeErrorForResponse(err) }, 500);
172:   }
173: });
174: 
175: /**
176:  * GET /api/trends
177:  * Returns trend summary for all metrics (latest percentiles + count).
178:  */
179: trendRoutes.get(&apos;/trends&apos;, async (c) =&gt; {
180:   const periodResult = PeriodSchema.safeParse(c.req.query(&apos;period&apos;));
181:   if (!periodResult.success) {
182:     return c.json({ error: &apos;Invalid period. Must be 24h, 7d, or 30d.&apos; }, 400);
183:   }
184: 
185:   try {
186:     const now = new Date();
187:     const period = periodResult.data;
188:     const periodMs = PERIOD_MS[period] ?? PERIOD_MS[&apos;7d&apos;];
189:     const start = new Date(now.getTime() - periodMs);
190: 
191:     const metricNames = Object.keys(QUALITY_METRICS);
192:     const summaries = await Promise.all(
193:       metricNames.map(async (name: string) =&gt; {
194:         const evals = await loadEvaluationsForMetric(name, start.toISOString(), now.toISOString());
195:         const scores = evals
196:           .map(e =&gt; e.scoreValue)
197:           .filter((v): v is number =&gt; v != null &amp;&amp; Number.isFinite(v));
198:         return {
199:           metric: name,
200:           count: scores.length,
201:           percentiles: computePercentileDistribution(scores) ?? null,
202:         };
203:       }),
204:     );
205: 
206:     return c.json({ period, metrics: summaries });
207:   } catch (err) {
208:     return c.json({ error: sanitizeErrorForResponse(err) }, 500);
209:   }
210: });</file><file path="src/components/SplitPane.tsx"> 1: import { useState, useCallback, useRef, useEffect, type ReactNode } from &apos;react&apos;;
 2: 
 3: interface SplitPaneProps {
 4:   left: ReactNode;
 5:   right: ReactNode;
 6:   initialSplit?: number;
 7:   minPct?: number;
 8:   maxPct?: number;
 9: }
10: 
11: export function SplitPane({ left, right, initialSplit = 50, minPct = 25, maxPct = 75 }: SplitPaneProps) {
12:   const [splitPct, setSplitPct] = useState(initialSplit);
13:   const containerRef = useRef&lt;HTMLDivElement&gt;(null);
14:   const dragging = useRef(false);
15: 
16:   const onMouseDown = useCallback(() =&gt; { dragging.current = true; }, []);
17: 
18:   useEffect(() =&gt; {
19:     function onMouseMove(e: MouseEvent) {
20:       if (!dragging.current || !containerRef.current) return;
21:       const rect = containerRef.current.getBoundingClientRect();
22:       const pct = ((e.clientX - rect.left) / rect.width) * 100;
23:       setSplitPct(Math.max(minPct, Math.min(maxPct, pct)));
24:     }
25:     function onMouseUp() { dragging.current = false; }
26:     document.addEventListener(&apos;mousemove&apos;, onMouseMove);
27:     document.addEventListener(&apos;mouseup&apos;, onMouseUp);
28:     return () =&gt; {
29:       document.removeEventListener(&apos;mousemove&apos;, onMouseMove);
30:       document.removeEventListener(&apos;mouseup&apos;, onMouseUp);
31:     };
32:   }, [minPct, maxPct]);
33: 
34:   return (
35:     &lt;div ref={containerRef} style={{ display: &apos;flex&apos;, width: &apos;100%&apos;, minHeight: 300 }}&gt;
36:       &lt;div style={{ width: `${splitPct}%`, overflow: &apos;auto&apos; }}&gt;{left}&lt;/div&gt;
37:       &lt;div
38:         role=&quot;separator&quot;
39:         aria-orientation=&quot;vertical&quot;
40:         aria-valuenow={Math.round(splitPct)}
41:         aria-valuemin={minPct}
42:         aria-valuemax={maxPct}
43:         aria-label=&quot;Resize panes&quot;
44:         tabIndex={0}
45:         onMouseDown={onMouseDown}
46:         onKeyDown={(e) =&gt; {
47:           if (e.key === &apos;ArrowLeft&apos;) { e.preventDefault(); setSplitPct(p =&gt; Math.max(minPct, p - 2)); }
48:           if (e.key === &apos;ArrowRight&apos;) { e.preventDefault(); setSplitPct(p =&gt; Math.min(maxPct, p + 2)); }
49:         }}
50:         style={{
51:           width: 6,
52:           cursor: &apos;col-resize&apos;,
53:           background: &apos;var(--border)&apos;,
54:           flexShrink: 0,
55:           borderRadius: 3,
56:         }}
57:       /&gt;
58:       &lt;div style={{ width: `${100 - splitPct}%`, overflow: &apos;auto&apos; }}&gt;{right}&lt;/div&gt;
59:     &lt;/div&gt;
60:   );
61: }</file><file path="src/components/TrendChart.tsx">  1: import {
  2:   LineChart,
  3:   Line,
  4:   XAxis,
  5:   YAxis,
  6:   CartesianGrid,
  7:   Tooltip,
  8:   ReferenceLine,
  9:   ResponsiveContainer,
 10: } from &apos;recharts&apos;;
 11: import type { MetricDynamics } from &apos;../types.js&apos;;
 12: import type { MetricTrend } from &apos;../types.js&apos;;
 13: 
 14: interface TrendChartProps {
 15:   trend?: MetricTrend;
 16:   dynamics?: MetricDynamics;
 17:   warningThreshold?: number;
 18:   criticalThreshold?: number;
 19:   metricName: string;
 20: }
 21: 
 22: const COLORS = {
 23:   line: &apos;#58a6ff&apos;,
 24:   projection: &apos;#58a6ff&apos;,
 25:   grid: &apos;#30363d&apos;,
 26:   text: &apos;#8b949e&apos;,
 27:   warning: &apos;#d29922&apos;,
 28:   critical: &apos;#f85149&apos;,
 29:   tooltip: &apos;#161b22&apos;,
 30: };
 31: 
 32: function formatValue(v: number): string {
 33:   return Math.abs(v) &lt; 0.001 ? v.toExponential(2) : v.toFixed(4);
 34: }
 35: 
 36: function formatBreachTime(iso: string): string {
 37:   const hours = (new Date(iso).getTime() - Date.now()) / (1000 * 60 * 60);
 38:   if (hours &lt;= 0) return &apos;threshold exceeded&apos;;
 39:   if (hours &lt; 1) return `${Math.round(hours * 60)}m`;
 40:   if (hours &lt; 48) return `${hours.toFixed(1)}h`;
 41:   return `${(hours / 24).toFixed(1)}d`;
 42: }
 43: 
 44: export function TrendChart({
 45:   trend,
 46:   dynamics,
 47:   warningThreshold,
 48:   criticalThreshold,
 49:   metricName,
 50: }: TrendChartProps) {
 51:   if (!trend) {
 52:     return (
 53:       &lt;div style={{ color: COLORS.text, padding: 16, textAlign: &apos;center&apos; }}&gt;
 54:         No trend data available
 55:       &lt;/div&gt;
 56:     );
 57:   }
 58: 
 59:   // Build data points: previous and current
 60:   const data: Array&lt;{ label: string; value: number; projected?: number }&gt; = [
 61:     { label: &apos;Previous&apos;, value: trend.previousValue },
 62:     { label: &apos;Current&apos;, value: trend.currentValue },
 63:   ];
 64: 
 65:   // If dynamics has projectedBreachTime or velocity, add projection point
 66:   if (dynamics &amp;&amp; dynamics.velocity !== 0) {
 67:     const projectedValue = trend.currentValue + dynamics.velocity;
 68:     data.push({
 69:       label: &apos;Projected&apos;,
 70:       value: trend.currentValue, // actual line ends here
 71:       projected: projectedValue,
 72:     });
 73:     // Set current point&apos;s projected value to bridge the dashed line
 74:     data[1].projected = trend.currentValue;
 75:   }
 76: 
 77:   // Compute Y domain with some padding
 78:   const allValues = data.flatMap((d) =&gt; [d.value, d.projected].filter((v): v is number =&gt; v != null));
 79:   if (warningThreshold != null) allValues.push(warningThreshold);
 80:   if (criticalThreshold != null) allValues.push(criticalThreshold);
 81:   if (allValues.length === 0) {
 82:     return &lt;div style={{ color: COLORS.text, padding: 16, textAlign: &apos;center&apos; }}&gt;Insufficient data&lt;/div&gt;;
 83:   }
 84:   const yMin = Math.min(...allValues);
 85:   const yMax = Math.max(...allValues);
 86:   const yPad = (yMax - yMin) * 0.15 || 0.05;
 87: 
 88:   return (
 89:     &lt;div&gt;
 90:       &lt;div aria-label={`Trend chart for ${metricName}`}&gt;
 91:         &lt;ResponsiveContainer width=&quot;100%&quot; height={200}&gt;
 92:           &lt;LineChart data={data} margin={{ top: 8, right: 16, bottom: 4, left: 16 }}&gt;
 93:             &lt;CartesianGrid stroke={COLORS.grid} strokeDasharray=&quot;3 3&quot; /&gt;
 94:             &lt;XAxis
 95:               dataKey=&quot;label&quot;
 96:               tick={{ fill: COLORS.text, fontSize: 12 }}
 97:               stroke={COLORS.grid}
 98:             /&gt;
 99:             &lt;YAxis
100:               domain={[yMin - yPad, yMax + yPad]}
101:               tick={{ fill: COLORS.text, fontSize: 11 }}
102:               stroke={COLORS.grid}
103:               tickFormatter={(v: number) =&gt; v.toFixed(2)}
104:               width={48}
105:             /&gt;
106:             &lt;Tooltip
107:               contentStyle={{
108:                 backgroundColor: COLORS.tooltip,
109:                 border: `1px solid ${COLORS.grid}`,
110:                 borderRadius: 6,
111:                 color: COLORS.text,
112:                 fontSize: 12,
113:               }}
114:               formatter={(v: number | undefined) =&gt; [v != null ? formatValue(v) : &apos;N/A&apos;, &apos;&apos;]}
115:               labelStyle={{ color: &apos;#e6edf3&apos; }}
116:             /&gt;
117:             {warningThreshold != null &amp;&amp; (
118:               &lt;ReferenceLine
119:                 y={warningThreshold}
120:                 stroke={COLORS.warning}
121:                 strokeDasharray=&quot;6 3&quot;
122:                 label={{ value: &apos;Warning&apos;, fill: COLORS.warning, fontSize: 11, position: &apos;right&apos; }}
123:               /&gt;
124:             )}
125:             {criticalThreshold != null &amp;&amp; (
126:               &lt;ReferenceLine
127:                 y={criticalThreshold}
128:                 stroke={COLORS.critical}
129:                 strokeDasharray=&quot;6 3&quot;
130:                 label={{ value: &apos;Critical&apos;, fill: COLORS.critical, fontSize: 11, position: &apos;right&apos; }}
131:               /&gt;
132:             )}
133:             &lt;Line
134:               type=&quot;monotone&quot;
135:               dataKey=&quot;value&quot;
136:               stroke={COLORS.line}
137:               strokeWidth={2}
138:               dot={{ fill: COLORS.line, r: 4 }}
139:               activeDot={{ r: 6 }}
140:               connectNulls
141:             /&gt;
142:             {dynamics &amp;&amp; dynamics.velocity !== 0 &amp;&amp; (
143:               &lt;Line
144:                 type=&quot;monotone&quot;
145:                 dataKey=&quot;projected&quot;
146:                 stroke={COLORS.projection}
147:                 strokeWidth={2}
148:                 strokeDasharray=&quot;6 4&quot;
149:                 dot={{ fill: COLORS.projection, r: 3, strokeDasharray: &apos;&apos; }}
150:                 connectNulls
151:               /&gt;
152:             )}
153:           &lt;/LineChart&gt;
154:         &lt;/ResponsiveContainer&gt;
155:       &lt;/div&gt;
156:       {dynamics &amp;&amp; (
157:         &lt;div style={{
158:           display: &apos;flex&apos;,
159:           gap: 24,
160:           flexWrap: &apos;wrap&apos;,
161:           marginTop: 8,
162:           padding: &apos;8px 0&apos;,
163:           fontSize: 13,
164:           color: COLORS.text,
165:         }}&gt;
166:           &lt;div&gt;
167:             &lt;span style={{ fontWeight: 600 }}&gt;Velocity:&lt;/span&gt;{&apos; &apos;}
168:             &lt;span style={{ fontFamily: &apos;var(--font-mono)&apos; }}&gt;
169:               {dynamics.velocity &gt;= 0 ? &apos;+&apos; : &apos;&apos;}{formatValue(dynamics.velocity)}/hr
170:             &lt;/span&gt;
171:           &lt;/div&gt;
172:           &lt;div&gt;
173:             &lt;span style={{ fontWeight: 600 }}&gt;Acceleration:&lt;/span&gt;{&apos; &apos;}
174:             &lt;span style={{ fontFamily: &apos;var(--font-mono)&apos; }}&gt;
175:               {dynamics.acceleration &gt;= 0 ? &apos;+&apos; : &apos;&apos;}{formatValue(dynamics.acceleration)}/hr
176:             &lt;/span&gt;
177:           &lt;/div&gt;
178:           {dynamics.projectedBreachTime &amp;&amp; (
179:             &lt;div&gt;
180:               &lt;span style={{ fontWeight: 600 }}&gt;Breach in:&lt;/span&gt;{&apos; &apos;}
181:               &lt;span style={{
182:                 fontFamily: &apos;var(--font-mono)&apos;,
183:                 color: dynamics.projectedStatus === &apos;critical&apos; ? COLORS.critical : COLORS.warning,
184:               }}&gt;
185:                 {formatBreachTime(dynamics.projectedBreachTime)}
186:               &lt;/span&gt;
187:             &lt;/div&gt;
188:           )}
189:           &lt;div&gt;
190:             &lt;span style={{ fontWeight: 600 }}&gt;Confidence:&lt;/span&gt;{&apos; &apos;}
191:             &lt;span style={{ fontFamily: &apos;var(--font-mono)&apos; }}&gt;
192:               {(dynamics.confidence * 100).toFixed(0)}%
193:             &lt;/span&gt;
194:           &lt;/div&gt;
195:         &lt;/div&gt;
196:       )}
197:     &lt;/div&gt;
198:   );
199: }</file><file path="src/contexts/KeyboardNavContext.tsx">  1: import { createContext, useContext, useCallback, useEffect, useMemo, useRef, useState, type ReactNode } from &apos;react&apos;;
  2: 
  3: interface Shortcut {
  4:   key: string;
  5:   description: string;
  6:   scope: string;
  7:   action: () =&gt; void;
  8: }
  9: 
 10: interface KeyboardNavContextValue {
 11:   shortcuts: Shortcut[];
 12:   register: (key: string, description: string, scope: string, action: () =&gt; void) =&gt; () =&gt; void;
 13:   overlayOpen: boolean;
 14:   toggleOverlay: () =&gt; void;
 15: }
 16: 
 17: const KeyboardNavContext = createContext&lt;KeyboardNavContextValue | null&gt;(null);
 18: 
 19: export function useShortcut(key: string, description: string, scope: string, action: () =&gt; void) {
 20:   const ctx = useContext(KeyboardNavContext);
 21:   const register = ctx?.register;
 22:   const actionRef = useRef(action);
 23:   actionRef.current = action;
 24:   const stableAction = useCallback(() =&gt; actionRef.current(), []);
 25:   useEffect(() =&gt; {
 26:     if (!register) return;
 27:     return register(key, description, scope, stableAction);
 28:   }, [register, key, description, scope, stableAction]);
 29: }
 30: 
 31: export function useKeyboardNav() {
 32:   const ctx = useContext(KeyboardNavContext);
 33:   if (!ctx) throw new Error(&apos;useKeyboardNav must be used within KeyboardNavProvider&apos;);
 34:   return ctx;
 35: }
 36: 
 37: const IGNORED_TAGS = new Set([&apos;INPUT&apos;, &apos;TEXTAREA&apos;, &apos;SELECT&apos;]);
 38: 
 39: export function KeyboardNavProvider({ children }: { children: ReactNode }) {
 40:   const shortcutsRef = useRef&lt;Shortcut[]&gt;([]);
 41:   const [shortcuts, setShortcuts] = useState&lt;Shortcut[]&gt;([]);
 42:   const [overlayOpen, setOverlayOpen] = useState(false);
 43:   const pendingRef = useRef&lt;string | null&gt;(null);
 44:   const pendingTimerRef = useRef&lt;ReturnType&lt;typeof setTimeout&gt; | null&gt;(null);
 45: 
 46:   const register = useCallback((key: string, description: string, scope: string, action: () =&gt; void) =&gt; {
 47:     const shortcut: Shortcut = { key, description, scope, action };
 48:     shortcutsRef.current = [...shortcutsRef.current, shortcut];
 49:     setShortcuts([...shortcutsRef.current]);
 50:     return () =&gt; {
 51:       shortcutsRef.current = shortcutsRef.current.filter(s =&gt; s !== shortcut);
 52:       setShortcuts([...shortcutsRef.current]);
 53:     };
 54:   }, []);
 55: 
 56:   const toggleOverlay = useCallback(() =&gt; setOverlayOpen(o =&gt; !o), []);
 57: 
 58:   useEffect(() =&gt; {
 59:     function handleKeydown(e: KeyboardEvent) {
 60:       if (IGNORED_TAGS.has((e.target as HTMLElement)?.tagName)) return;
 61:       if (e.ctrlKey || e.metaKey || e.altKey) return;
 62: 
 63:       const key = e.key;
 64: 
 65:       if (key === &apos;?&apos;) {
 66:         e.preventDefault();
 67:         setOverlayOpen(o =&gt; !o);
 68:         return;
 69:       }
 70: 
 71:       if (key === &apos;Escape&apos; &amp;&amp; overlayOpen) {
 72:         e.preventDefault();
 73:         setOverlayOpen(false);
 74:         return;
 75:       }
 76: 
 77:       // Two-key combo support (e.g. &quot;g h&quot;)
 78:       if (pendingRef.current) {
 79:         const combo = `${pendingRef.current} ${key}`;
 80:         pendingRef.current = null;
 81:         if (pendingTimerRef.current) clearTimeout(pendingTimerRef.current);
 82:         const match = shortcutsRef.current.find(s =&gt; s.key === combo);
 83:         if (match) {
 84:           e.preventDefault();
 85:           match.action();
 86:           return;
 87:         }
 88:       }
 89: 
 90:       // Check for single-key match
 91:       const single = shortcutsRef.current.find(s =&gt; s.key === key);
 92:       if (single) {
 93:         e.preventDefault();
 94:         single.action();
 95:         return;
 96:       }
 97: 
 98:       // Check if this could be the start of a combo
 99:       const hasCombo = shortcutsRef.current.some(s =&gt; s.key.startsWith(`${key} `));
100:       if (hasCombo) {
101:         pendingRef.current = key;
102:         pendingTimerRef.current = setTimeout(() =&gt; { pendingRef.current = null; }, 500);
103:       }
104:     }
105: 
106:     document.addEventListener(&apos;keydown&apos;, handleKeydown);
107:     return () =&gt; {
108:       document.removeEventListener(&apos;keydown&apos;, handleKeydown);
109:       if (pendingTimerRef.current) clearTimeout(pendingTimerRef.current);
110:     };
111:   }, [overlayOpen]);
112: 
113:   const value = useMemo&lt;KeyboardNavContextValue&gt;(
114:     () =&gt; ({ shortcuts, register, overlayOpen, toggleOverlay }),
115:     [shortcuts, register, overlayOpen, toggleOverlay],
116:   );
117: 
118:   return (
119:     &lt;KeyboardNavContext.Provider value={value}&gt;
120:       {children}
121:     &lt;/KeyboardNavContext.Provider&gt;
122:   );
123: }</file><file path="src/contexts/RoleContext.tsx"> 1: import { createContext, useContext, useEffect, useMemo, type ReactNode } from &apos;react&apos;;
 2: import { useRoute } from &apos;wouter&apos;;
 3: import {
 4:   getRoleFeatureConfig,
 5:   type FeatureRoleType,
 6:   type RoleFeatureConfig,
 7: } from &apos;../lib/quality-utils.js&apos;;
 8: 
 9: const VALID_ROLES = new Set&lt;FeatureRoleType&gt;([&apos;executive&apos;, &apos;operator&apos;, &apos;auditor&apos;]);
10: 
11: interface RoleContextValue {
12:   role: FeatureRoleType;
13:   config: RoleFeatureConfig;
14:   hasFeature: (feature: keyof RoleFeatureConfig) =&gt; boolean;
15: }
16: 
17: const RoleContext = createContext&lt;RoleContextValue | null&gt;(null);
18: 
19: export function RoleProvider({ children }: { children: ReactNode }) {
20:   const [, params] = useRoute(&apos;/role/:roleName&apos;);
21:   const roleName = params?.roleName as string | undefined;
22: 
23:   const role: FeatureRoleType =
24:     roleName &amp;&amp; VALID_ROLES.has(roleName as FeatureRoleType)
25:       ? (roleName as FeatureRoleType)
26:       : &apos;executive&apos;;
27: 
28:   useEffect(() =&gt; {
29:     if (roleName &amp;&amp; !VALID_ROLES.has(roleName as FeatureRoleType)) {
30:       console.warn(`[RoleProvider] Unknown role &quot;${roleName}&quot;, falling back to &quot;executive&quot;. Valid roles: ${[...VALID_ROLES].join(&apos;, &apos;)}`);
31:     }
32:   }, [roleName]);
33: 
34:   const value = useMemo&lt;RoleContextValue&gt;(() =&gt; {
35:     const config = getRoleFeatureConfig(role);
36:     return {
37:       role,
38:       config,
39:       hasFeature: (feature: keyof RoleFeatureConfig) =&gt; {
40:         const v = config[feature];
41:         if (typeof v === &apos;boolean&apos;) return v;
42:         return v !== undefined &amp;&amp; v !== null;
43:       },
44:     };
45:   }, [role]);
46: 
47:   return (
48:     &lt;RoleContext.Provider value={value}&gt;
49:       {children}
50:     &lt;/RoleContext.Provider&gt;
51:   );
52: }
53: 
54: export function useRole(): RoleContextValue {
55:   const ctx = useContext(RoleContext);
56:   if (!ctx) {
57:     throw new Error(&apos;useRole must be used within a RoleProvider&apos;);
58:   }
59:   return ctx;
60: }
61: 
62: export function RoleGate({ feature, children }: {
63:   feature: keyof RoleFeatureConfig;
64:   children: ReactNode;
65: }) {
66:   const { hasFeature } = useRole();
67:   return hasFeature(feature) ? &lt;&gt;{children}&lt;/&gt; : null;
68: }</file><file path="src/hooks/useSessionDetail.ts">  1: import { useQuery } from &apos;@tanstack/react-query&apos;;
  2: import type { MultiAgentEvaluation, EvaluationResult } from &apos;../types.js&apos;;
  3: 
  4: const API_BASE = import.meta.env.VITE_API_URL ?? (import.meta.env.DEV ? &apos;http://localhost:3001&apos; : &apos;&apos;);
  5: 
  6: export interface SessionInfo {
  7:   projectName: string;
  8:   workingDirectory: string;
  9:   gitRepository: string;
 10:   gitBranch: string;
 11:   nodeVersion: string;
 12:   resumeCount: number;
 13:   initialMessageCount: number;
 14:   initialContextTokens: number;
 15:   finalMessageCount: number;
 16:   taskCount: number;
 17:   uncommittedAtStart: number;
 18: }
 19: 
 20: export interface TokenSnapshot {
 21:   messages: number;
 22:   inputTokens: number;
 23:   outputTokens: number;
 24:   cacheRead: number;
 25:   cacheCreation: number;
 26:   model: string;
 27: }
 28: 
 29: export interface TokenTotals {
 30:   input: number;
 31:   output: number;
 32:   cacheRead: number;
 33:   cacheCreation: number;
 34:   messages: number;
 35:   models: Record&lt;string, number&gt;;
 36: }
 37: 
 38: export interface AgentStat {
 39:   agentName: string;
 40:   invocations: number;
 41:   errors: number;
 42:   hasRateLimit: boolean;
 43:   avgOutputSize: number;
 44: }
 45: 
 46: export interface FileAccessEntry {
 47:   path: string;
 48:   count: number;
 49: }
 50: 
 51: export interface GitCommit {
 52:   subject: string;
 53:   body: string;
 54:   files: string;
 55: }
 56: 
 57: export interface CodeStructureEntry {
 58:   file: string;
 59:   lines: number;
 60:   exports: number;
 61:   functions: number;
 62:   hasTypes: boolean;
 63:   score: number;
 64:   tool: string;
 65: }
 66: 
 67: export interface AlertSummary {
 68:   totalFired: number;
 69:   stopEvents: number;
 70: }
 71: 
 72: export interface DataSources {
 73:   traces: { count: number; traceIds: number };
 74:   logs: { count: number };
 75:   evaluations: { count: number };
 76:   total: number;
 77: }
 78: 
 79: export interface Timespan {
 80:   start: string;
 81:   end: string;
 82:   durationHours: number;
 83: }
 84: 
 85: export interface HookLatency {
 86:   count: number;
 87:   avg: number;
 88:   p50: number;
 89:   p95: number;
 90:   max: number;
 91: }
 92: 
 93: export interface EvaluationBreakdownEntry {
 94:   name: string;
 95:   count: number;
 96:   avg: number | null;
 97:   min: number | null;
 98:   max: number | null;
 99: }
100: 
101: export interface SessionDetailResponse {
102:   sessionId: string;
103:   dataSources: DataSources;
104:   timespan: Timespan | null;
105:   sessionInfo: SessionInfo | null;
106:   tokenTotals: TokenTotals;
107:   tokenProgression: TokenSnapshot[];
108:   toolUsage: Record&lt;string, number&gt;;
109:   mcpUsage: Record&lt;string, number&gt;;
110:   spanBreakdown: Record&lt;string, number&gt;;
111:   hookLatency: Record&lt;string, HookLatency&gt;;
112:   errors: {
113:     byCategory: Record&lt;string, number&gt;;
114:     details: Array&lt;{
115:       spanName: string;
116:       tool?: string;
117:       errorType?: string;
118:       filePath?: string;
119:     }&gt;;
120:   };
121:   agentActivity: AgentStat[];
122:   fileAccess: FileAccessEntry[];
123:   gitCommits: GitCommit[];
124:   alertSummary: AlertSummary;
125:   codeStructure: CodeStructureEntry[];
126:   evaluationBreakdown: EvaluationBreakdownEntry[];
127:   logSummary: {
128:     bySeverity: Record&lt;string, number&gt;;
129:     logs: unknown[];
130:   };
131:   multiAgentEvaluation: MultiAgentEvaluation;
132:   evaluations: EvaluationResult[];
133: }
134: 
135: export class SessionNotFoundError extends Error {
136:   constructor(sessionId: string) {
137:     super(`Session ${sessionId} has not been synced to the dashboard yet.`);
138:     this.name = &apos;SessionNotFoundError&apos;;
139:   }
140: }
141: 
142: export function useSessionDetail(sessionId: string | undefined) {
143:   return useQuery&lt;SessionDetailResponse&gt;({
144:     queryKey: [&apos;session-detail&apos;, sessionId],
145:     queryFn: async () =&gt; {
146:       const res = await fetch(`${API_BASE}/api/sessions/${encodeURIComponent(sessionId!)}`);
147:       if (res.status === 404) throw new SessionNotFoundError(sessionId!);
148:       if (!res.ok) throw new Error(`API error: ${res.status}`);
149:       return res.json();
150:     },
151:     enabled: !!sessionId,
152:     staleTime: 30_000,
153:     retry: (failureCount, error) =&gt;
154:       error instanceof SessionNotFoundError ? false : failureCount &lt; 2,
155:   });
156: }</file><file path="src/hooks/useTrend.ts"> 1: import { useQuery } from &apos;@tanstack/react-query&apos;;
 2: import type { Period, MetricTrend, MetricDynamics } from &apos;../types.js&apos;;
 3: 
 4: const API_BASE = import.meta.env.VITE_API_URL ?? (import.meta.env.DEV ? &apos;http://localhost:3001&apos; : &apos;&apos;);
 5: 
 6: export interface PercentileSnapshot {
 7:   p10: number;
 8:   p25: number;
 9:   p50: number;
10:   p75: number;
11:   p90: number;
12: }
13: 
14: export interface TrendBucket {
15:   startTime: string;
16:   endTime: string;
17:   count: number;
18:   avg: number | null;
19:   percentiles: PercentileSnapshot | null;
20:   trend: MetricTrend | null;
21:   dynamics: MetricDynamics | null;
22: }
23: 
24: export interface TrendResponse {
25:   metric: string;
26:   period: string;
27:   bucketCount: number;
28:   totalEvaluations: number;
29:   overallPercentiles: PercentileSnapshot | null;
30:   trendData: TrendBucket[];
31:   narrowed?: boolean;
32: }
33: 
34: export function useTrend(metricName: string, period: Period, buckets = 7) {
35:   return useQuery&lt;TrendResponse&gt;({
36:     queryKey: [&apos;trend&apos;, metricName, period, buckets],
37:     enabled: !!metricName,
38:     queryFn: async () =&gt; {
39:       const params = new URLSearchParams({ period, buckets: String(buckets) });
40:       const res = await fetch(`${API_BASE}/api/trends/${encodeURIComponent(metricName)}?${params}`);
41:       if (!res.ok) throw new Error(`API error: ${res.status}`);
42:       return res.json();
43:     },
44:     staleTime: 25_000,
45:     retry: 2,
46:   });
47: }</file><file path="src/lib/quality-utils.ts">  1: /**
  2:  * Subset of quality-feature-engineering utilities needed by the frontend.
  3:  * Extracted from parent src/lib/quality-feature-engineering.ts to allow
  4:  * standalone Vite builds (CI) without the parent dist/ directory.
  5:  *
  6:  * Keep in sync with the parent when these definitions change.
  7:  */
  8: 
  9: // -- Types ------------------------------------------------------------------
 10: 
 11: export type ScoreDirection = &apos;maximize&apos; | &apos;minimize&apos;;
 12: export type ScoreColorBand = &apos;excellent&apos; | &apos;good&apos; | &apos;adequate&apos; | &apos;poor&apos; | &apos;failing&apos;;
 13: export type LabelFilterCategory = &apos;Pass&apos; | &apos;Review&apos; | &apos;Fail&apos;;
 14: 
 15: export interface LabelOrdinal {
 16:   ordinal: number;
 17:   category: LabelFilterCategory;
 18:   mapped: boolean;
 19: }
 20: 
 21: export type FeatureRoleType = &apos;executive&apos; | &apos;operator&apos; | &apos;auditor&apos;;
 22: 
 23: export interface RoleFeatureConfig {
 24:   showCQI: boolean;
 25:   showCQIBreakdown: boolean;
 26:   showVariance: boolean;
 27:   showAcceleration: boolean;
 28:   showProjectedBreach: boolean;
 29:   showCorrelationRemediation: boolean;
 30:   showCoverageHeatmap: boolean;
 31:   showPipelineFunnel: boolean;
 32:   showProvenance: boolean;
 33:   showRawExport: boolean;
 34:   explanationTruncation: number;
 35:   maxWorstEvaluations: number;
 36: }
 37: 
 38: // -- Shared helpers ---------------------------------------------------------
 39: 
 40: export function truncateText(text: string, max: number): string {
 41:   return text.length &gt; max ? text.slice(0, max) + &apos;...&apos; : text;
 42: }
 43: 
 44: export const SCORE_COLORS: Record&lt;ScoreColorBand | &apos;no_data&apos;, string&gt; = {
 45:   excellent: &apos;#26d97f&apos;,
 46:   good: &apos;#34d399&apos;,
 47:   adequate: &apos;#e5a00d&apos;,
 48:   poor: &apos;#f97316&apos;,
 49:   failing: &apos;#f04438&apos;,
 50:   no_data: &apos;#6b7280&apos;,
 51: };
 52: 
 53: // -- scoreColorBand ---------------------------------------------------------
 54: 
 55: export function scoreColorBand(
 56:   value: number,
 57:   direction: ScoreDirection = &apos;maximize&apos;,
 58: ): ScoreColorBand {
 59:   const v = direction === &apos;minimize&apos; ? 1 - value : value;
 60:   if (v &gt;= 0.9) return &apos;excellent&apos;;
 61:   if (v &gt;= 0.8) return &apos;good&apos;;
 62:   if (v &gt;= 0.6) return &apos;adequate&apos;;
 63:   if (v &gt;= 0.4) return &apos;poor&apos;;
 64:   return &apos;failing&apos;;
 65: }
 66: 
 67: // -- inferScoreDirection ----------------------------------------------------
 68: 
 69: type ThresholdDirection = &apos;above&apos; | &apos;below&apos;;
 70: 
 71: export function inferScoreDirection(
 72:   alertDirection: ThresholdDirection | undefined,
 73: ): ScoreDirection {
 74:   return alertDirection === &apos;above&apos; ? &apos;minimize&apos; : &apos;maximize&apos;;
 75: }
 76: 
 77: // -- Label ordinal encoding -------------------------------------------------
 78: 
 79: const LABEL_ORDINAL_MAP: Record&lt;string, { ordinal: number; category: LabelFilterCategory }&gt; = {
 80:   excellent: { ordinal: 4, category: &apos;Pass&apos; },
 81:   highly_relevant: { ordinal: 4, category: &apos;Pass&apos; },
 82:   fully_faithful: { ordinal: 4, category: &apos;Pass&apos; },
 83:   perfect: { ordinal: 4, category: &apos;Pass&apos; },
 84:   relevant: { ordinal: 3, category: &apos;Pass&apos; },
 85:   good: { ordinal: 3, category: &apos;Pass&apos; },
 86:   faithful: { ordinal: 3, category: &apos;Pass&apos; },
 87:   pass: { ordinal: 3, category: &apos;Pass&apos; },
 88:   correct: { ordinal: 3, category: &apos;Pass&apos; },
 89:   coherent: { ordinal: 3, category: &apos;Pass&apos; },
 90:   partial: { ordinal: 2, category: &apos;Review&apos; },
 91:   borderline: { ordinal: 2, category: &apos;Review&apos; },
 92:   adequate: { ordinal: 2, category: &apos;Review&apos; },
 93:   mixed: { ordinal: 2, category: &apos;Review&apos; },
 94:   off_topic: { ordinal: 1, category: &apos;Fail&apos; },
 95:   irrelevant: { ordinal: 1, category: &apos;Fail&apos; },
 96:   unfaithful: { ordinal: 1, category: &apos;Fail&apos; },
 97:   fail: { ordinal: 1, category: &apos;Fail&apos; },
 98:   incorrect: { ordinal: 1, category: &apos;Fail&apos; },
 99:   incoherent: { ordinal: 1, category: &apos;Fail&apos; },
100:   hallucinated: { ordinal: 0, category: &apos;Fail&apos; },
101:   fabricated: { ordinal: 0, category: &apos;Fail&apos; },
102:   toxic: { ordinal: 0, category: &apos;Fail&apos; },
103:   dangerous: { ordinal: 0, category: &apos;Fail&apos; },
104: };
105: 
106: function normalizeLabel(label: string): string {
107:   return label.toLowerCase().replace(/-/g, &apos;_&apos;).trim();
108: }
109: 
110: export function labelToOrdinal(label: string): LabelOrdinal {
111:   const normalized = normalizeLabel(label);
112:   const entry = LABEL_ORDINAL_MAP[normalized];
113:   if (entry) {
114:     return { ordinal: entry.ordinal, category: entry.category, mapped: true };
115:   }
116:   return { ordinal: 2, category: &apos;Review&apos;, mapped: false };
117: }
118: 
119: export function ordinalToCategory(ordinal: number): LabelFilterCategory {
120:   if (ordinal &gt;= 3) return &apos;Pass&apos;;
121:   if (ordinal === 2) return &apos;Review&apos;;
122:   return &apos;Fail&apos;;
123: }
124: 
125: // -- Role feature config ----------------------------------------------------
126: 
127: export const ROLE_FEATURE_CONFIG: Record&lt;FeatureRoleType, RoleFeatureConfig&gt; = {
128:   executive: {
129:     showCQI: true,
130:     showCQIBreakdown: true,
131:     showVariance: false,
132:     showAcceleration: false,
133:     showProjectedBreach: true,
134:     showCorrelationRemediation: false,
135:     showCoverageHeatmap: false,
136:     showPipelineFunnel: false,
137:     showProvenance: false,
138:     showRawExport: false,
139:     explanationTruncation: 80,
140:     maxWorstEvaluations: 1,
141:   },
142:   operator: {
143:     showCQI: false,
144:     showCQIBreakdown: false,
145:     showVariance: true,
146:     showAcceleration: true,
147:     showProjectedBreach: true,
148:     showCorrelationRemediation: true,
149:     showCoverageHeatmap: true,
150:     showPipelineFunnel: true,
151:     showProvenance: false,
152:     showRawExport: false,
153:     explanationTruncation: 500,
154:     maxWorstEvaluations: 5,
155:   },
156:   auditor: {
157:     showCQI: true,
158:     showCQIBreakdown: true,
159:     showVariance: true,
160:     showAcceleration: false,
161:     showProjectedBreach: false,
162:     showCorrelationRemediation: true,
163:     showCoverageHeatmap: true,
164:     showPipelineFunnel: true,
165:     showProvenance: true,
166:     showRawExport: true,
167:     explanationTruncation: 2000,
168:     maxWorstEvaluations: 10,
169:   },
170: };
171: 
172: export function getRoleFeatureConfig(role: FeatureRoleType): RoleFeatureConfig {
173:   return ROLE_FEATURE_CONFIG[role];
174: }
175: 
176: // -- Timestamp formatting ---------------------------------------------------
177: 
178: export function formatTimestamp(ts: string): string {
179:   const d = new Date(ts);
180:   if (isNaN(d.getTime())) return ts || &apos;-&apos;;
181:   const now = Date.now();
182:   const diffMs = now - d.getTime();
183:   const diffMin = Math.floor(diffMs / 60_000);
184:   if (diffMin &lt; 1) return &apos;just now&apos;;
185:   if (diffMin &lt; 60) return `${diffMin}m ago`;
186:   const diffHr = Math.floor(diffMin / 60);
187:   if (diffHr &lt; 24) return `${diffHr}h ago`;
188:   const diffDay = Math.floor(diffHr / 24);
189:   if (diffDay &lt; 7) return `${diffDay}d ago`;
190:   return d.toLocaleDateString();
191: }</file><file path="src/pages/AgentSessionPage.tsx"> 1: import { Link } from &apos;wouter&apos;;
 2: import { useAgentSession } from &apos;../hooks/useAgentSession.js&apos;;
 3: import { TurnTimeline } from &apos;../components/TurnTimeline.js&apos;;
 4: import { HandoffCard } from &apos;../components/HandoffCard.js&apos;;
 5: import { ScoreBadge } from &apos;../components/ScoreBadge.js&apos;;
 6: 
 7: export function AgentSessionPage({ sessionId }: { sessionId: string }) {
 8:   const { data, isLoading, error } = useAgentSession(sessionId);
 9: 
10:   if (isLoading) {
11:     return (
12:       &lt;div&gt;
13:         &lt;Link href=&quot;/&quot; className=&quot;back-link&quot;&gt;&amp;larr; Back to dashboard&lt;/Link&gt;
14:         &lt;div className=&quot;card skeleton&quot; style={{ height: 300 }} /&gt;
15:       &lt;/div&gt;
16:     );
17:   }
18: 
19:   if (error) {
20:     return (
21:       &lt;div&gt;
22:         &lt;Link href=&quot;/&quot; className=&quot;back-link&quot;&gt;&amp;larr; Back to dashboard&lt;/Link&gt;
23:         &lt;div className=&quot;error-state&quot;&gt;&lt;h2&gt;Failed to load&lt;/h2&gt;&lt;p&gt;{error.message}&lt;/p&gt;&lt;/div&gt;
24:       &lt;/div&gt;
25:     );
26:   }
27: 
28:   if (!data) return null;
29: 
30:   const { evaluation } = data;
31:   const turns = evaluation.turns ?? [];
32:   const handoffs = evaluation.handoffs ?? [];
33:   const agentNames = [...new Set(turns.map(t =&gt; t.agentName ?? &apos;unknown&apos;))];
34: 
35:   return (
36:     &lt;div&gt;
37:       &lt;Link href=&quot;/&quot; className=&quot;back-link&quot;&gt;&amp;larr; Back to dashboard&lt;/Link&gt;
38: 
39:       &lt;div className=&quot;eval-detail-header&quot;&gt;
40:         &lt;h2 style={{ fontSize: 18 }}&gt;Agent Session&lt;/h2&gt;
41:         &lt;div className=&quot;eval-detail-meta&quot;&gt;
42:           &lt;span style={{ fontFamily: &apos;var(--font-mono)&apos;, fontSize: 12, color: &apos;var(--text-secondary)&apos; }}&gt;
43:             {sessionId}
44:           &lt;/span&gt;
45:           &lt;span style={{ fontSize: 13, color: &apos;var(--text-secondary)&apos; }}&gt;
46:             {evaluation.totalTurns} turn{evaluation.totalTurns !== 1 ? &apos;s&apos; : &apos;&apos;} &amp;middot; {agentNames.length} agent{agentNames.length !== 1 ? &apos;s&apos; : &apos;&apos;}
47:           &lt;/span&gt;
48:         &lt;/div&gt;
49:       &lt;/div&gt;
50: 
51:       {/* Summary scores */}
52:       &lt;div className=&quot;card&quot; style={{ display: &apos;flex&apos;, gap: 24, flexWrap: &apos;wrap&apos;, padding: 16, marginBottom: 16 }}&gt;
53:         &lt;div style={{ textAlign: &apos;center&apos; }}&gt;
54:           &lt;div style={{ fontSize: 12, color: &apos;var(--text-secondary)&apos;, marginBottom: 4 }}&gt;Handoff Score&lt;/div&gt;
55:           &lt;ScoreBadge score={evaluation.handoffScore} metricName=&quot;handoff&quot; /&gt;
56:         &lt;/div&gt;
57:         &lt;div style={{ textAlign: &apos;center&apos; }}&gt;
58:           &lt;div style={{ fontSize: 12, color: &apos;var(--text-secondary)&apos;, marginBottom: 4 }}&gt;Avg Relevance&lt;/div&gt;
59:           &lt;ScoreBadge score={evaluation.avgTurnRelevance} metricName=&quot;relevance&quot; /&gt;
60:         &lt;/div&gt;
61:         &lt;div style={{ textAlign: &apos;center&apos; }}&gt;
62:           &lt;div style={{ fontSize: 12, color: &apos;var(--text-secondary)&apos;, marginBottom: 4 }}&gt;Completeness&lt;/div&gt;
63:           &lt;ScoreBadge score={evaluation.conversationCompleteness} metricName=&quot;completeness&quot; /&gt;
64:         &lt;/div&gt;
65:         {evaluation.errorPropagationTurns &gt; 0 &amp;&amp; (
66:           &lt;div style={{ textAlign: &apos;center&apos; }}&gt;
67:             &lt;div style={{ fontSize: 12, color: &apos;var(--text-secondary)&apos;, marginBottom: 4 }}&gt;Error Propagation&lt;/div&gt;
68:             &lt;span style={{ fontFamily: &apos;var(--font-mono)&apos;, fontSize: 16, color: &apos;var(--status-critical)&apos; }}&gt;
69:               {evaluation.errorPropagationTurns} turn{evaluation.errorPropagationTurns !== 1 ? &apos;s&apos; : &apos;&apos;}
70:             &lt;/span&gt;
71:           &lt;/div&gt;
72:         )}
73:       &lt;/div&gt;
74: 
75:       {/* Turn timeline */}
76:       &lt;div className=&quot;view-section&quot;&gt;
77:         &lt;h3 className=&quot;section-heading&quot;&gt;Turn Timeline&lt;/h3&gt;
78:         &lt;div className=&quot;card&quot;&gt;
79:           &lt;TurnTimeline turns={turns} agentNames={agentNames} /&gt;
80:         &lt;/div&gt;
81:       &lt;/div&gt;
82: 
83:       {/* Handoffs */}
84:       {handoffs.length &gt; 0 &amp;&amp; (
85:         &lt;div className=&quot;view-section&quot;&gt;
86:           &lt;h3 className=&quot;section-heading&quot;&gt;Handoffs&lt;/h3&gt;
87:           &lt;div style={{ display: &apos;flex&apos;, flexDirection: &apos;column&apos;, gap: 8 }}&gt;
88:             {handoffs.map((h, i) =&gt; (
89:               &lt;HandoffCard key={`${h.sourceAgent}-${h.targetAgent}-${i}`} handoff={h} /&gt;
90:             ))}
91:           &lt;/div&gt;
92:         &lt;/div&gt;
93:       )}
94:     &lt;/div&gt;
95:   );
96: }</file><file path="src/pages/SessionDetailPage.tsx">  1: import { type ReactNode } from &apos;react&apos;;
  2: import { Link } from &apos;wouter&apos;;
  3: import { useSessionDetail, SessionNotFoundError } from &apos;../hooks/useSessionDetail.js&apos;;
  4: import { EvaluationTable, type EvalRow } from &apos;../components/EvaluationTable.js&apos;;
  5: import { ScoreBadge } from &apos;../components/ScoreBadge.js&apos;;
  6: import type { EvaluationResult } from &apos;../types.js&apos;;
  7: 
  8: // ─── Helpers ────────────────────────────────────────────────────────────────
  9: 
 10: function shortPath(fullPath: string): string {
 11:   const parts = fullPath.replace(/\\/g, &apos;/&apos;).split(&apos;/&apos;);
 12:   return parts.length &gt; 3 ? `…/${parts.slice(-3).join(&apos;/&apos;)}` : fullPath;
 13: }
 14: 
 15: function fmtBytes(n: number): string {
 16:   if (n &gt;= 1_000_000) return `${(n / 1_000_000).toFixed(1)}M`;
 17:   if (n &gt;= 1_000) return `${(n / 1_000).toFixed(1)}K`;
 18:   return String(n);
 19: }
 20: 
 21: function evalToRow(e: EvaluationResult): EvalRow {
 22:   return {
 23:     score: typeof e.scoreValue === &apos;number&apos; ? e.scoreValue : 0,
 24:     explanation: e.explanation,
 25:     traceId: e.traceId,
 26:     timestamp: e.timestamp,
 27:     evaluator: e.evaluator,
 28:     label: e.scoreLabel,
 29:     evaluatorType: e.evaluatorType,
 30:     spanId: e.spanId,
 31:     sessionId: e.sessionId,
 32:     agentName: e.agentName,
 33:     trajectoryLength: e.trajectoryLength,
 34:     stepScores: e.stepScores as EvalRow[&apos;stepScores&apos;],
 35:     toolVerifications: e.toolVerifications as EvalRow[&apos;toolVerifications&apos;],
 36:   };
 37: }
 38: 
 39: function scoreColor(s: number): string {
 40:   if (s &gt;= 0.85) return &apos;var(--status-healthy)&apos;;
 41:   if (s &gt;= 0.65) return &apos;var(--status-warning)&apos;;
 42:   return &apos;var(--status-critical)&apos;;
 43: }
 44: 
 45: // ─── Section accordion ──────────────────────────────────────────────────────
 46: 
 47: interface SectionProps {
 48:   title: string;
 49:   badge?: string;
 50:   health?: &apos;ok&apos; | &apos;warn&apos; | &apos;crit&apos; | &apos;neutral&apos;;
 51:   defaultOpen?: boolean;
 52:   children: ReactNode;
 53: }
 54: 
 55: function Section({ title, badge, health = &apos;neutral&apos;, defaultOpen = false, children }: SectionProps) {
 56:   const railColor = health === &apos;ok&apos;
 57:     ? &apos;var(--status-healthy)&apos;
 58:     : health === &apos;warn&apos;
 59:     ? &apos;var(--status-warning)&apos;
 60:     : health === &apos;crit&apos;
 61:     ? &apos;var(--status-critical)&apos;
 62:     : &apos;var(--border-accent)&apos;;
 63: 
 64:   return (
 65:     &lt;details open={defaultOpen} style={{ marginBottom: 2 }}&gt;
 66:       &lt;summary style={{
 67:         display: &apos;flex&apos;,
 68:         alignItems: &apos;center&apos;,
 69:         gap: 12,
 70:         padding: &apos;12px 20px&apos;,
 71:         background: &apos;var(--bg-card)&apos;,
 72:         borderLeft: `3px solid ${railColor}`,
 73:         borderBottom: &apos;1px solid var(--border-subtle)&apos;,
 74:         cursor: &apos;pointer&apos;,
 75:         userSelect: &apos;none&apos;,
 76:         listStyle: &apos;none&apos;,
 77:         transition: &apos;background 0.15s&apos;,
 78:       }}&gt;
 79:         &lt;span style={{
 80:           fontFamily: &apos;var(--font-mono)&apos;,
 81:           fontSize: 9,
 82:           color: railColor,
 83:           transition: &apos;transform 0.2s&apos;,
 84:           display: &apos;inline-block&apos;,
 85:         }}&gt;▶&lt;/span&gt;
 86:         &lt;span style={{
 87:           fontFamily: &apos;var(--font-mono)&apos;,
 88:           fontSize: 11,
 89:           fontWeight: 600,
 90:           letterSpacing: &apos;0.12em&apos;,
 91:           textTransform: &apos;uppercase&apos;,
 92:           color: &apos;var(--text-secondary)&apos;,
 93:           flex: 1,
 94:         }}&gt;{title}&lt;/span&gt;
 95:         {badge &amp;&amp; (
 96:           &lt;span style={{
 97:             fontFamily: &apos;var(--font-mono)&apos;,
 98:             fontSize: 11,
 99:             color: &apos;var(--text-muted)&apos;,
100:             background: &apos;var(--bg-elevated)&apos;,
101:             padding: &apos;2px 8px&apos;,
102:             borderRadius: 10,
103:             border: &apos;1px solid var(--border-subtle)&apos;,
104:           }}&gt;{badge}&lt;/span&gt;
105:         )}
106:       &lt;/summary&gt;
107:       &lt;div style={{
108:         padding: &apos;16px 20px 20px&apos;,
109:         background: &apos;var(--bg-card)&apos;,
110:         borderLeft: `3px solid ${railColor}`,
111:         borderBottom: &apos;1px solid var(--border-subtle)&apos;,
112:       }}&gt;
113:         {children}
114:       &lt;/div&gt;
115:     &lt;/details&gt;
116:   );
117: }
118: 
119: // ─── Stat chip ───────────────────────────────────────────────────────────────
120: 
121: function Stat({ label, value, color }: { label: string; value: string | number; color?: string }) {
122:   return (
123:     &lt;div style={{ textAlign: &apos;center&apos;, flex: &apos;1 1 100px&apos;, minWidth: 80 }}&gt;
124:       &lt;div style={{
125:         fontFamily: &apos;var(--font-mono)&apos;,
126:         fontSize: 22,
127:         fontWeight: 700,
128:         color: color ?? &apos;var(--text-primary)&apos;,
129:         lineHeight: 1.1,
130:       }}&gt;{value}&lt;/div&gt;
131:       &lt;div style={{
132:         fontSize: 10,
133:         fontFamily: &apos;var(--font-mono)&apos;,
134:         letterSpacing: &apos;0.1em&apos;,
135:         textTransform: &apos;uppercase&apos;,
136:         color: &apos;var(--text-muted)&apos;,
137:         marginTop: 3,
138:       }}&gt;{label}&lt;/div&gt;
139:     &lt;/div&gt;
140:   );
141: }
142: 
143: // ─── Frequency bar ───────────────────────────────────────────────────────────
144: 
145: function FreqBar({ label, count, max, color }: { label: string; count: number; max: number; color?: string }) {
146:   const pct = max &gt; 0 ? (count / max) * 100 : 0;
147:   return (
148:     &lt;div style={{ display: &apos;flex&apos;, alignItems: &apos;center&apos;, gap: 10, marginBottom: 6 }}&gt;
149:       &lt;div style={{
150:         width: 160,
151:         fontSize: 12,
152:         fontFamily: &apos;var(--font-mono)&apos;,
153:         color: &apos;var(--text-secondary)&apos;,
154:         textAlign: &apos;right&apos;,
155:         flexShrink: 0,
156:         overflow: &apos;hidden&apos;,
157:         textOverflow: &apos;ellipsis&apos;,
158:         whiteSpace: &apos;nowrap&apos;,
159:       }}&gt;{label}&lt;/div&gt;
160:       &lt;div style={{ flex: 1, background: &apos;var(--bg-elevated)&apos;, borderRadius: 2, height: 6, overflow: &apos;hidden&apos; }}&gt;
161:         &lt;div style={{
162:           width: `${pct}%`,
163:           height: &apos;100%&apos;,
164:           background: color ?? &apos;var(--accent)&apos;,
165:           borderRadius: 2,
166:           transition: &apos;width 0.4s ease&apos;,
167:         }} /&gt;
168:       &lt;/div&gt;
169:       &lt;div style={{
170:         fontFamily: &apos;var(--font-mono)&apos;,
171:         fontSize: 11,
172:         color: &apos;var(--text-muted)&apos;,
173:         width: 36,
174:         textAlign: &apos;right&apos;,
175:         flexShrink: 0,
176:       }}&gt;{count}&lt;/div&gt;
177:     &lt;/div&gt;
178:   );
179: }
180: 
181: // ─── Issue callout ───────────────────────────────────────────────────────────
182: 
183: function IssueCallout({ severity, title, children }: {
184:   severity: &apos;warning&apos; | &apos;critical&apos;;
185:   title: string;
186:   children: ReactNode;
187: }) {
188:   const color = severity === &apos;critical&apos; ? &apos;var(--status-critical)&apos; : &apos;var(--status-warning)&apos;;
189:   return (
190:     &lt;div style={{
191:       borderLeft: `3px solid ${color}`,
192:       background: severity === &apos;critical&apos; ? &apos;rgba(240,68,56,0.06)&apos; : &apos;rgba(229,160,13,0.06)&apos;,
193:       borderRadius: &apos;0 var(--radius) var(--radius) 0&apos;,
194:       padding: &apos;10px 14px&apos;,
195:       marginBottom: 10,
196:     }}&gt;
197:       &lt;div style={{
198:         fontFamily: &apos;var(--font-mono)&apos;,
199:         fontSize: 11,
200:         fontWeight: 600,
201:         letterSpacing: &apos;0.08em&apos;,
202:         textTransform: &apos;uppercase&apos;,
203:         color,
204:         marginBottom: 4,
205:       }}&gt;{title}&lt;/div&gt;
206:       &lt;div style={{ fontSize: 13, color: &apos;var(--text-secondary)&apos;, lineHeight: 1.6 }}&gt;
207:         {children}
208:       &lt;/div&gt;
209:     &lt;/div&gt;
210:   );
211: }
212: 
213: // ─── Main page ───────────────────────────────────────────────────────────────
214: 
215: export function SessionDetailPage({ sessionId }: { sessionId: string }) {
216:   const { data, isLoading, error } = useSessionDetail(sessionId);
217: 
218:   if (isLoading) {
219:     return (
220:       &lt;div&gt;
221:         &lt;Link href=&quot;/&quot; className=&quot;back-link&quot;&gt;&amp;larr; Back to dashboard&lt;/Link&gt;
222:         &lt;div className=&quot;card skeleton&quot; style={{ height: 120, marginBottom: 2 }} /&gt;
223:         &lt;div className=&quot;card skeleton&quot; style={{ height: 56, marginBottom: 2 }} /&gt;
224:         &lt;div className=&quot;card skeleton&quot; style={{ height: 200, marginBottom: 2 }} /&gt;
225:         &lt;div className=&quot;card skeleton&quot; style={{ height: 160 }} /&gt;
226:       &lt;/div&gt;
227:     );
228:   }
229: 
230:   if (error) {
231:     const isNotSynced = error instanceof SessionNotFoundError;
232:     return (
233:       &lt;div&gt;
234:         &lt;Link href=&quot;/&quot; className=&quot;back-link&quot;&gt;&amp;larr; Back to dashboard&lt;/Link&gt;
235:         {isNotSynced ? (
236:           &lt;div className=&quot;card&quot; style={{ padding: &apos;32px 24px&apos;, textAlign: &apos;center&apos; }}&gt;
237:             &lt;div style={{
238:               fontFamily: &apos;var(--font-mono)&apos;,
239:               fontSize: 11,
240:               letterSpacing: &apos;0.12em&apos;,
241:               textTransform: &apos;uppercase&apos;,
242:               color: &apos;var(--status-warning)&apos;,
243:               marginBottom: 8,
244:             }}&gt;Session Not Yet Available&lt;/div&gt;
245:             &lt;div style={{
246:               fontFamily: &apos;var(--font-mono)&apos;,
247:               fontSize: 13,
248:               color: &apos;var(--text-secondary)&apos;,
249:               lineHeight: 1.6,
250:               maxWidth: 480,
251:               margin: &apos;0 auto&apos;,
252:             }}&gt;
253:               This session has not been synced to the dashboard KV store yet.
254:               Data is synced periodically &amp;mdash; check back after the next pipeline run.
255:             &lt;/div&gt;
256:             &lt;div style={{
257:               fontFamily: &apos;var(--font-mono)&apos;,
258:               fontSize: 11,
259:               color: &apos;var(--text-muted)&apos;,
260:               marginTop: 12,
261:               wordBreak: &apos;break-all&apos;,
262:             }}&gt;{sessionId}&lt;/div&gt;
263:           &lt;/div&gt;
264:         ) : (
265:           &lt;div className=&quot;error-state&quot;&gt;&lt;h2&gt;Failed to load session&lt;/h2&gt;&lt;p&gt;{error.message}&lt;/p&gt;&lt;/div&gt;
266:         )}
267:       &lt;/div&gt;
268:     );
269:   }
270: 
271:   if (!data) return null;
272: 
273:   const {
274:     dataSources, timespan, sessionInfo, tokenTotals, toolUsage, mcpUsage,
275:     agentActivity, fileAccess, gitCommits, tokenProgression, spanBreakdown,
276:     hookLatency, alertSummary, codeStructure, errors, evaluationBreakdown,
277:     multiAgentEvaluation, evaluations,
278:   } = data;
279: 
280:   const si = sessionInfo ?? {
281:     projectName: &apos;unknown&apos;, workingDirectory: &apos;&apos;, gitRepository: &apos;&apos;, gitBranch: &apos;&apos;,
282:     nodeVersion: &apos;&apos;, resumeCount: 0, initialMessageCount: 0, initialContextTokens: 0,
283:     finalMessageCount: 0, taskCount: 0, uncommittedAtStart: 0,
284:   };
285:   const spanCount = dataSources.traces.count;
286:   const errorDetails = errors.details;
287: 
288:   // Derive computed values
289:   const totalToolCalls = Object.values(toolUsage).reduce((a, b) =&gt; a + b, 0);
290:   const totalMcpCalls = Object.values(mcpUsage).reduce((a, b) =&gt; a + b, 0);
291:   const maxTokenSnapshot = tokenProgression.at(-1);
292:   const maxToolCount = Math.max(...Object.values(toolUsage), 1);
293:   const maxMcpCount = Math.max(...Object.values(mcpUsage), 1);
294:   const maxFileCount = fileAccess[0]?.count ?? 1;
295:   const maxSpanCount = Math.max(...Object.values(spanBreakdown), 1);
296: 
297:   // Issue detection
298:   const hallucinationEvals = evaluations.filter(e =&gt;
299:     (e.evaluationName ?? &apos;&apos;).toLowerCase().includes(&apos;hallucin&apos;) ||
300:     ((e.scoreLabel ?? &apos;&apos;).toLowerCase() === &apos;fail&apos; &amp;&amp; typeof e.scoreValue === &apos;number&apos; &amp;&amp; e.scoreValue &lt; 0.4)
301:   );
302:   const failedEvals = evaluations.filter(e =&gt;
303:     (e.scoreLabel ?? &apos;&apos;).toLowerCase() === &apos;fail&apos;
304:   );
305:   const errorCount = errorDetails.length;
306:   const hasIssues = alertSummary.totalFired &gt; 0 || errorCount &gt; 0 ||
307:     hallucinationEvals.length &gt; 0 || failedEvals.length &gt; 0;
308:   const issueHealth: SectionProps[&apos;health&apos;] = errorCount &gt; 0 || hallucinationEvals.length &gt; 0
309:     ? &apos;crit&apos;
310:     : alertSummary.totalFired &gt; 0 || failedEvals.length &gt; 0
311:     ? &apos;warn&apos;
312:     : &apos;ok&apos;;
313: 
314:   // Score interpretation
315:   const evaluation = multiAgentEvaluation;
316:   const handoffScore = evaluation.handoffScore ?? 0;
317:   const avgRelevance = evaluation.avgTurnRelevance ?? 0;
318:   const completeness = evaluation.conversationCompleteness ?? 0;
319:   const evalRows: EvalRow[] = evaluations.map(evalToRow);
320: 
321:   // Unique models used
322:   const models = [...new Set(tokenProgression.map(t =&gt; t.model).filter(Boolean))];
323: 
324:   return (
325:     &lt;div style={{ maxWidth: 1100 }}&gt;
326:       &lt;Link href=&quot;/&quot; className=&quot;back-link&quot;&gt;&amp;larr; Back to dashboard&lt;/Link&gt;
327: 
328:       {/* ── Header ── */}
329:       &lt;div style={{
330:         background: &apos;var(--bg-card)&apos;,
331:         border: &apos;1px solid var(--border-subtle)&apos;,
332:         borderBottom: &apos;none&apos;,
333:         padding: &apos;20px 24px 16px&apos;,
334:         marginBottom: 0,
335:       }}&gt;
336:         &lt;div style={{ display: &apos;flex&apos;, alignItems: &apos;flex-start&apos;, justifyContent: &apos;space-between&apos;, gap: 16, flexWrap: &apos;wrap&apos; }}&gt;
337:           &lt;div&gt;
338:             &lt;div style={{
339:               fontSize: 10,
340:               fontFamily: &apos;var(--font-mono)&apos;,
341:               letterSpacing: &apos;0.15em&apos;,
342:               textTransform: &apos;uppercase&apos;,
343:               color: &apos;var(--text-muted)&apos;,
344:               marginBottom: 6,
345:             }}&gt;Session Detail&lt;/div&gt;
346:             &lt;div style={{
347:               fontFamily: &apos;var(--font-mono)&apos;,
348:               fontSize: 15,
349:               fontWeight: 600,
350:               color: &apos;var(--accent-hover)&apos;,
351:               letterSpacing: &apos;0.02em&apos;,
352:               marginBottom: 8,
353:               wordBreak: &apos;break-all&apos;,
354:             }}&gt;{sessionId}&lt;/div&gt;
355:             &lt;div style={{ display: &apos;flex&apos;, gap: 16, flexWrap: &apos;wrap&apos;, fontSize: 12, color: &apos;var(--text-secondary)&apos; }}&gt;
356:               &lt;span&gt;{si.projectName}&lt;/span&gt;
357:               {si.gitRepository &amp;&amp; (
358:                 &lt;span style={{ color: &apos;var(--text-muted)&apos; }}&gt;
359:                   {si.gitRepository}
360:                   {si.gitBranch ? ` · ${si.gitBranch}` : &apos;&apos;}
361:                 &lt;/span&gt;
362:               )}
363:               {si.resumeCount &gt; 1 &amp;&amp; (
364:                 &lt;span style={{
365:                   fontFamily: &apos;var(--font-mono)&apos;,
366:                   fontSize: 10,
367:                   background: &apos;var(--accent-muted)&apos;,
368:                   color: &apos;var(--accent-hover)&apos;,
369:                   padding: &apos;2px 8px&apos;,
370:                   borderRadius: 10,
371:                   letterSpacing: &apos;0.05em&apos;,
372:                 }}&gt;RESUMED ×{si.resumeCount}&lt;/span&gt;
373:               )}
374:               {models.map(m =&gt; (
375:                 &lt;span key={m} style={{
376:                   fontFamily: &apos;var(--font-mono)&apos;,
377:                   fontSize: 10,
378:                   background: &apos;var(--bg-elevated)&apos;,
379:                   color: &apos;var(--text-muted)&apos;,
380:                   padding: &apos;2px 8px&apos;,
381:                   borderRadius: 10,
382:                   border: &apos;1px solid var(--border-subtle)&apos;,
383:                 }}&gt;{m}&lt;/span&gt;
384:               ))}
385:             &lt;/div&gt;
386:           &lt;/div&gt;
387:         &lt;/div&gt;
388:       &lt;/div&gt;
389: 
390:       {/* ── Vitals strip ── */}
391:       &lt;div style={{
392:         display: &apos;flex&apos;,
393:         gap: 0,
394:         background: &apos;var(--bg-elevated)&apos;,
395:         border: &apos;1px solid var(--border-subtle)&apos;,
396:         borderBottom: &apos;1px solid var(--border)&apos;,
397:         padding: &apos;14px 24px&apos;,
398:         flexWrap: &apos;wrap&apos;,
399:         rowGap: 12,
400:         marginBottom: 2,
401:       }}&gt;
402:         &lt;Stat label=&quot;Spans&quot; value={spanCount} /&gt;
403:         &lt;div style={{ width: 1, background: &apos;var(--border-subtle)&apos;, margin: &apos;0 8px&apos;, alignSelf: &apos;stretch&apos; }} /&gt;
404:         &lt;Stat label=&quot;Tool calls&quot; value={totalToolCalls} /&gt;
405:         &lt;div style={{ width: 1, background: &apos;var(--border-subtle)&apos;, margin: &apos;0 8px&apos;, alignSelf: &apos;stretch&apos; }} /&gt;
406:         &lt;Stat label=&quot;MCP calls&quot; value={totalMcpCalls} /&gt;
407:         &lt;div style={{ width: 1, background: &apos;var(--border-subtle)&apos;, margin: &apos;0 8px&apos;, alignSelf: &apos;stretch&apos; }} /&gt;
408:         &lt;Stat label=&quot;Commits&quot; value={gitCommits.length} color={gitCommits.length &gt; 0 ? &apos;var(--status-healthy)&apos; : undefined} /&gt;
409:         &lt;div style={{ width: 1, background: &apos;var(--border-subtle)&apos;, margin: &apos;0 8px&apos;, alignSelf: &apos;stretch&apos; }} /&gt;
410:         &lt;Stat label=&quot;Alerts fired&quot; value={alertSummary.totalFired} color={alertSummary.totalFired &gt; 0 ? &apos;var(--status-warning)&apos; : undefined} /&gt;
411:         &lt;div style={{ width: 1, background: &apos;var(--border-subtle)&apos;, margin: &apos;0 8px&apos;, alignSelf: &apos;stretch&apos; }} /&gt;
412:         &lt;Stat label=&quot;Errors&quot; value={errorCount} color={errorCount &gt; 0 ? &apos;var(--status-critical)&apos; : undefined} /&gt;
413:         &lt;div style={{ width: 1, background: &apos;var(--border-subtle)&apos;, margin: &apos;0 8px&apos;, alignSelf: &apos;stretch&apos; }} /&gt;
414:         {maxTokenSnapshot &amp;&amp; (
415:           &lt;Stat label=&quot;Messages&quot; value={maxTokenSnapshot.messages} /&gt;
416:         )}
417:         {maxTokenSnapshot &amp;&amp; (
418:           &lt;&gt;
419:             &lt;div style={{ width: 1, background: &apos;var(--border-subtle)&apos;, margin: &apos;0 8px&apos;, alignSelf: &apos;stretch&apos; }} /&gt;
420:             &lt;Stat label=&quot;Output tokens&quot; value={fmtBytes(maxTokenSnapshot.outputTokens)} /&gt;
421:           &lt;/&gt;
422:         )}
423:       &lt;/div&gt;
424: 
425:       {/* ── Issues &amp; Anomalies ── */}
426:       &lt;Section
427:         title=&quot;Issues &amp; Anomalies&quot;
428:         badge={hasIssues ? `${[
429:           alertSummary.totalFired &gt; 0 &amp;&amp; `${alertSummary.totalFired} alerts`,
430:           errorCount &gt; 0 &amp;&amp; `${errorCount} errors`,
431:           hallucinationEvals.length &gt; 0 &amp;&amp; `${hallucinationEvals.length} hallucinations`,
432:           failedEvals.length &gt; 0 &amp;&amp; `${failedEvals.length} failures`,
433:         ].filter(Boolean).join(&apos; · &apos;)}` : &apos;clean&apos;}
434:         health={issueHealth}
435:         defaultOpen={hasIssues}
436:       &gt;
437:         {!hasIssues &amp;&amp; (
438:           &lt;div style={{ color: &apos;var(--status-healthy)&apos;, fontFamily: &apos;var(--font-mono)&apos;, fontSize: 12 }}&gt;
439:             No issues detected in this session.
440:           &lt;/div&gt;
441:         )}
442: 
443:         {alertSummary.totalFired &gt; 0 &amp;&amp; (
444:           &lt;IssueCallout severity=&quot;warning&quot; title={`${alertSummary.totalFired} alert${alertSummary.totalFired !== 1 ? &apos;s&apos; : &apos;&apos;} fired across ${alertSummary.stopEvents} stop event${alertSummary.stopEvents !== 1 ? &apos;s&apos; : &apos;&apos;}`}&gt;
445:             &lt;strong&gt;task-completion-low&lt;/strong&gt; — The task completion ratio fell below 0.85.
446:             This fires when tasks are created but not marked complete before the session ends.
447:             Common causes: work deferred to backlog, sub-tasks spawned but not resolved,
448:             or tasks marked in-progress but not completed within the session.
449:           &lt;/IssueCallout&gt;
450:         )}
451: 
452:         {errorCount &gt; 0 &amp;&amp; (
453:           &lt;IssueCallout severity=&quot;critical&quot; title={`${errorCount} error span${errorCount !== 1 ? &apos;s&apos; : &apos;&apos;}`}&gt;
454:             &lt;div style={{ marginBottom: 8 }}&gt;Tool invocations or agent calls that reported errors:&lt;/div&gt;
455:             {errorDetails.slice(0, 10).map((e, i) =&gt; (
456:               &lt;div key={i} style={{ fontFamily: &apos;var(--font-mono)&apos;, fontSize: 11, marginBottom: 4 }}&gt;
457:                 &lt;span style={{ color: &apos;var(--status-critical)&apos; }}&gt;✗&lt;/span&gt;{&apos; &apos;}
458:                 {e.spanName}{e.tool ? ` (${e.tool})` : &apos;&apos;}{e.filePath ? ` · ${shortPath(e.filePath)}` : &apos;&apos;}
459:                 {e.errorType &amp;&amp; e.errorType !== &apos;unknown&apos; &amp;&amp; &lt;span style={{ color: &apos;var(--text-muted)&apos; }}&gt; — {e.errorType}&lt;/span&gt;}
460:               &lt;/div&gt;
461:             ))}
462:             {errorCount &gt; 10 &amp;&amp; (
463:               &lt;div style={{ color: &apos;var(--text-muted)&apos;, fontSize: 11, marginTop: 4 }}&gt;
464:                 +{errorCount - 10} more
465:               &lt;/div&gt;
466:             )}
467:           &lt;/IssueCallout&gt;
468:         )}
469: 
470:         {hallucinationEvals.length &gt; 0 &amp;&amp; (
471:           &lt;IssueCallout severity=&quot;critical&quot; title={`${hallucinationEvals.length} hallucination indicator${hallucinationEvals.length !== 1 ? &apos;s&apos; : &apos;&apos;} detected`}&gt;
472:             &lt;div style={{ marginBottom: 8 }}&gt;
473:               Evaluations flagging potential hallucination or very low confidence:
474:             &lt;/div&gt;
475:             {hallucinationEvals.slice(0, 8).map((e, i) =&gt; (
476:               &lt;div key={i} style={{ display: &apos;flex&apos;, alignItems: &apos;center&apos;, gap: 10, marginBottom: 6 }}&gt;
477:                 &lt;ScoreBadge score={typeof e.scoreValue === &apos;number&apos; ? e.scoreValue : 0} metricName={e.evaluationName ?? &apos;hallucination&apos;} /&gt;
478:                 &lt;div&gt;
479:                   &lt;div style={{ fontFamily: &apos;var(--font-mono)&apos;, fontSize: 11 }}&gt;{e.evaluationName}&lt;/div&gt;
480:                   {e.explanation &amp;&amp; (
481:                     &lt;div style={{ fontSize: 12, color: &apos;var(--text-muted)&apos;, marginTop: 2 }}&gt;
482:                       {e.explanation.slice(0, 200)}{e.explanation.length &gt; 200 ? &apos;…&apos; : &apos;&apos;}
483:                     &lt;/div&gt;
484:                   )}
485:                 &lt;/div&gt;
486:               &lt;/div&gt;
487:             ))}
488:           &lt;/IssueCallout&gt;
489:         )}
490: 
491:         {failedEvals.length &gt; 0 &amp;&amp; !hallucinationEvals.length &amp;&amp; (
492:           &lt;IssueCallout severity=&quot;warning&quot; title={`${failedEvals.length} evaluation${failedEvals.length !== 1 ? &apos;s&apos; : &apos;&apos;} marked fail`}&gt;
493:             {failedEvals.slice(0, 6).map((e, i) =&gt; (
494:               &lt;div key={i} style={{ fontFamily: &apos;var(--font-mono)&apos;, fontSize: 11, marginBottom: 3 }}&gt;
495:                 &lt;span style={{ color: &apos;var(--status-warning)&apos; }}&gt;⚠&lt;/span&gt;{&apos; &apos;}
496:                 {e.evaluationName} — score {typeof e.scoreValue === &apos;number&apos; ? e.scoreValue.toFixed(3) : &apos;N/A&apos;}
497:               &lt;/div&gt;
498:             ))}
499:           &lt;/IssueCallout&gt;
500:         )}
501: 
502:         {evaluation.errorPropagationTurns &gt; 0 &amp;&amp; (
503:           &lt;IssueCallout severity=&quot;warning&quot; title={`${evaluation.errorPropagationTurns} error propagation turn${evaluation.errorPropagationTurns !== 1 ? &apos;s&apos; : &apos;&apos;}`}&gt;
504:             Errors detected in the multi-agent turn sequence may have propagated across agent handoffs.
505:           &lt;/IssueCallout&gt;
506:         )}
507:       &lt;/Section&gt;
508: 
509:       {/* ── Token Journey ── */}
510:       &lt;Section
511:         title=&quot;Token Journey&quot;
512:         badge={maxTokenSnapshot ? `${maxTokenSnapshot.messages} msg · ${fmtBytes(maxTokenSnapshot.outputTokens)} out` : &apos;no data&apos;}
513:         health=&quot;neutral&quot;
514:       &gt;
515:         {tokenProgression.length === 0 ? (
516:           &lt;div style={{ color: &apos;var(--text-muted)&apos;, fontSize: 13 }}&gt;No token snapshots recorded.&lt;/div&gt;
517:         ) : (
518:           &lt;div style={{ overflowX: &apos;auto&apos; }}&gt;
519:             &lt;table style={{
520:               width: &apos;100%&apos;, borderCollapse: &apos;collapse&apos;,
521:               fontFamily: &apos;var(--font-mono)&apos;, fontSize: 12,
522:             }}&gt;
523:               &lt;thead&gt;
524:                 &lt;tr style={{ borderBottom: &apos;1px solid var(--border)&apos; }}&gt;
525:                   {[&apos;Messages&apos;, &apos;Input&apos;, &apos;Output&apos;, &apos;Cache Read&apos;, &apos;Cache Create&apos;, &apos;Model&apos;].map(h =&gt; (
526:                     &lt;th key={h} style={{ padding: &apos;6px 12px&apos;, textAlign: &apos;right&apos;, color: &apos;var(--text-muted)&apos;, fontWeight: 500, letterSpacing: &apos;0.05em&apos;, whiteSpace: &apos;nowrap&apos; }}&gt;
527:                       {h.toUpperCase()}
528:                     &lt;/th&gt;
529:                   ))}
530:                 &lt;/tr&gt;
531:               &lt;/thead&gt;
532:               &lt;tbody&gt;
533:                 {tokenProgression.map((t, i) =&gt; (
534:                   &lt;tr key={i} style={{ borderBottom: &apos;1px solid var(--border-subtle)&apos; }}&gt;
535:                     &lt;td style={{ padding: &apos;5px 12px&apos;, textAlign: &apos;right&apos; }}&gt;{t.messages}&lt;/td&gt;
536:                     &lt;td style={{ padding: &apos;5px 12px&apos;, textAlign: &apos;right&apos;, color: &apos;var(--text-secondary)&apos; }}&gt;{fmtBytes(t.inputTokens)}&lt;/td&gt;
537:                     &lt;td style={{ padding: &apos;5px 12px&apos;, textAlign: &apos;right&apos;, color: &apos;var(--accent-hover)&apos; }}&gt;{fmtBytes(t.outputTokens)}&lt;/td&gt;
538:                     &lt;td style={{ padding: &apos;5px 12px&apos;, textAlign: &apos;right&apos;, color: &apos;var(--text-muted)&apos; }}&gt;{fmtBytes(t.cacheRead)}&lt;/td&gt;
539:                     &lt;td style={{ padding: &apos;5px 12px&apos;, textAlign: &apos;right&apos;, color: &apos;var(--text-muted)&apos; }}&gt;{fmtBytes(t.cacheCreation)}&lt;/td&gt;
540:                     &lt;td style={{ padding: &apos;5px 12px&apos;, textAlign: &apos;right&apos;, color: &apos;var(--text-muted)&apos; }}&gt;{t.model}&lt;/td&gt;
541:                   &lt;/tr&gt;
542:                 ))}
543:               &lt;/tbody&gt;
544:             &lt;/table&gt;
545:           &lt;/div&gt;
546:         )}
547:       &lt;/Section&gt;
548: 
549:       {/* ── Tool Activity ── */}
550:       &lt;Section
551:         title=&quot;Tool Activity&quot;
552:         badge={`${totalToolCalls} calls · ${Object.keys(toolUsage).length} tools`}
553:         health=&quot;neutral&quot;
554:       &gt;
555:         &lt;div style={{ display: &apos;grid&apos;, gridTemplateColumns: &apos;repeat(auto-fill, minmax(340px, 1fr))&apos;, gap: &apos;0 32px&apos; }}&gt;
556:           {Object.entries(toolUsage)
557:             .sort((a, b) =&gt; b[1] - a[1])
558:             .map(([tool, count]) =&gt; (
559:               &lt;FreqBar key={tool} label={tool} count={count} max={maxToolCount} /&gt;
560:             ))
561:           }
562:         &lt;/div&gt;
563: 
564:         {totalMcpCalls &gt; 0 &amp;&amp; (
565:           &lt;&gt;
566:             &lt;div style={{ fontSize: 10, fontFamily: &apos;var(--font-mono)&apos;, letterSpacing: &apos;0.12em&apos;, textTransform: &apos;uppercase&apos;, color: &apos;var(--text-muted)&apos;, margin: &apos;14px 0 8px&apos; }}&gt;
567:               MCP Tools — {totalMcpCalls} calls
568:             &lt;/div&gt;
569:             &lt;div style={{ display: &apos;grid&apos;, gridTemplateColumns: &apos;repeat(auto-fill, minmax(340px, 1fr))&apos;, gap: &apos;0 32px&apos; }}&gt;
570:               {Object.entries(mcpUsage)
571:                 .sort((a, b) =&gt; b[1] - a[1])
572:                 .map(([tool, count]) =&gt; (
573:                   &lt;FreqBar key={tool} label={tool} count={count} max={maxMcpCount} color=&quot;var(--status-healthy)&quot; /&gt;
574:                 ))
575:               }
576:             &lt;/div&gt;
577:           &lt;/&gt;
578:         )}
579:       &lt;/Section&gt;
580: 
581:       {/* ── Agent Activity ── */}
582:       {agentActivity.length &gt; 0 &amp;&amp; (
583:         &lt;Section
584:           title=&quot;Agent Activity&quot;
585:           badge={agentActivity.map(a =&gt; `${a.agentName} ×${a.invocations}`).join(&apos; · &apos;)}
586:           health={agentActivity.some(a =&gt; a.errors &gt; 0) ? &apos;warn&apos; : &apos;neutral&apos;}
587:         &gt;
588:           &lt;div style={{ display: &apos;grid&apos;, gridTemplateColumns: &apos;repeat(auto-fill, minmax(220px, 1fr))&apos;, gap: 10 }}&gt;
589:             {agentActivity.map(a =&gt; (
590:               &lt;div key={a.agentName} style={{
591:                 background: &apos;var(--bg-elevated)&apos;,
592:                 border: `1px solid ${a.errors &gt; 0 ? &apos;var(--status-warning)&apos; : &apos;var(--border-subtle)&apos;}`,
593:                 borderRadius: &apos;var(--radius)&apos;,
594:                 padding: &apos;10px 14px&apos;,
595:               }}&gt;
596:                 &lt;div style={{ fontFamily: &apos;var(--font-mono)&apos;, fontSize: 12, fontWeight: 600, marginBottom: 6 }}&gt;
597:                   {a.agentName}
598:                 &lt;/div&gt;
599:                 &lt;div style={{ display: &apos;flex&apos;, gap: 12, flexWrap: &apos;wrap&apos; }}&gt;
600:                   &lt;div&gt;
601:                     &lt;div style={{ fontFamily: &apos;var(--font-mono)&apos;, fontSize: 16, fontWeight: 700 }}&gt;{a.invocations}&lt;/div&gt;
602:                     &lt;div style={{ fontSize: 10, color: &apos;var(--text-muted)&apos;, textTransform: &apos;uppercase&apos; }}&gt;invocations&lt;/div&gt;
603:                   &lt;/div&gt;
604:                   {a.errors &gt; 0 &amp;&amp; (
605:                     &lt;div&gt;
606:                       &lt;div style={{ fontFamily: &apos;var(--font-mono)&apos;, fontSize: 16, fontWeight: 700, color: &apos;var(--status-warning)&apos; }}&gt;{a.errors}&lt;/div&gt;
607:                       &lt;div style={{ fontSize: 10, color: &apos;var(--text-muted)&apos;, textTransform: &apos;uppercase&apos; }}&gt;errors&lt;/div&gt;
608:                     &lt;/div&gt;
609:                   )}
610:                   &lt;div&gt;
611:                     &lt;div style={{ fontFamily: &apos;var(--font-mono)&apos;, fontSize: 16, fontWeight: 700 }}&gt;{fmtBytes(a.avgOutputSize)}&lt;/div&gt;
612:                     &lt;div style={{ fontSize: 10, color: &apos;var(--text-muted)&apos;, textTransform: &apos;uppercase&apos; }}&gt;avg output&lt;/div&gt;
613:                   &lt;/div&gt;
614:                 &lt;/div&gt;
615:                 {a.hasRateLimit &amp;&amp; (
616:                   &lt;div style={{ marginTop: 8, fontFamily: &apos;var(--font-mono)&apos;, fontSize: 10, color: &apos;var(--status-warning)&apos; }}&gt;
617:                     ⚠ Hit rate limit
618:                   &lt;/div&gt;
619:                 )}
620:               &lt;/div&gt;
621:             ))}
622:           &lt;/div&gt;
623: 
624:           {/* Multi-agent evaluation scores */}
625:           &lt;div style={{ marginTop: 16, display: &apos;flex&apos;, gap: 20, flexWrap: &apos;wrap&apos; }}&gt;
626:             {[
627:               { label: &apos;Handoff Score&apos;, value: handoffScore },
628:               { label: &apos;Avg Relevance&apos;, value: avgRelevance },
629:               { label: &apos;Completeness&apos;, value: completeness },
630:             ].map(({ label, value }) =&gt; (
631:               &lt;div key={label} style={{ textAlign: &apos;center&apos; }}&gt;
632:                 &lt;div style={{ fontSize: 11, color: &apos;var(--text-muted)&apos;, marginBottom: 4, fontFamily: &apos;var(--font-mono)&apos;, textTransform: &apos;uppercase&apos;, letterSpacing: &apos;0.05em&apos; }}&gt;{label}&lt;/div&gt;
633:                 &lt;ScoreBadge score={value} metricName={label.toLowerCase()} /&gt;
634:               &lt;/div&gt;
635:             ))}
636:           &lt;/div&gt;
637:         &lt;/Section&gt;
638:       )}
639: 
640:       {/* ── Files Accessed ── */}
641:       {fileAccess.length &gt; 0 &amp;&amp; (
642:         &lt;Section
643:           title=&quot;Files Accessed&quot;
644:           badge={`${fileAccess.length} files · top: ${shortPath(fileAccess[0]?.path ?? &apos;&apos;)}`}
645:           health=&quot;neutral&quot;
646:         &gt;
647:           &lt;div style={{ columns: &apos;2 320px&apos;, columnGap: 32 }}&gt;
648:             {fileAccess.map(({ path, count }) =&gt; (
649:               &lt;div key={path} style={{ breakInside: &apos;avoid&apos; }}&gt;
650:                 &lt;FreqBar
651:                   label={shortPath(path)}
652:                   count={count}
653:                   max={maxFileCount}
654:                   color=&quot;var(--accent)&quot;
655:                 /&gt;
656:               &lt;/div&gt;
657:             ))}
658:           &lt;/div&gt;
659:         &lt;/Section&gt;
660:       )}
661: 
662:       {/* ── Git Commits ── */}
663:       {gitCommits.length &gt; 0 &amp;&amp; (
664:         &lt;Section
665:           title=&quot;Git Commits&quot;
666:           badge={`${gitCommits.length} commit${gitCommits.length !== 1 ? &apos;s&apos; : &apos;&apos;}`}
667:           health=&quot;ok&quot;
668:         &gt;
669:           &lt;div style={{ display: &apos;flex&apos;, flexDirection: &apos;column&apos;, gap: 1 }}&gt;
670:             {gitCommits.map((commit, i) =&gt; (
671:               &lt;details key={i} style={{ borderBottom: &apos;1px solid var(--border-subtle)&apos; }}&gt;
672:                 &lt;summary style={{
673:                   display: &apos;flex&apos;,
674:                   alignItems: &apos;center&apos;,
675:                   gap: 10,
676:                   padding: &apos;8px 4px&apos;,
677:                   cursor: &apos;pointer&apos;,
678:                   listStyle: &apos;none&apos;,
679:                 }}&gt;
680:                   &lt;span style={{ color: &apos;var(--status-healthy)&apos;, fontSize: 10, flexShrink: 0 }}&gt;●&lt;/span&gt;
681:                   &lt;span style={{ fontFamily: &apos;var(--font-mono)&apos;, fontSize: 12, fontWeight: 600, flex: 1 }}&gt;
682:                     {commit.subject}
683:                   &lt;/span&gt;
684:                   {commit.files &amp;&amp; (
685:                     &lt;span style={{ fontSize: 10, color: &apos;var(--text-muted)&apos;, flexShrink: 0 }}&gt;
686:                       {commit.files.split(&apos; &apos;).length} file{commit.files.split(&apos; &apos;).length !== 1 ? &apos;s&apos; : &apos;&apos;}
687:                     &lt;/span&gt;
688:                   )}
689:                 &lt;/summary&gt;
690:                 &lt;div style={{ paddingLeft: 20, paddingBottom: 10 }}&gt;
691:                   {commit.body &amp;&amp; (
692:                     &lt;div style={{
693:                       fontSize: 12, color: &apos;var(--text-secondary)&apos;, lineHeight: 1.6, marginBottom: 8,
694:                       fontFamily: &apos;var(--font-body)&apos;,
695:                     }}&gt;
696:                       {commit.body}
697:                     &lt;/div&gt;
698:                   )}
699:                   {commit.files &amp;&amp; (
700:                     &lt;div style={{ fontFamily: &apos;var(--font-mono)&apos;, fontSize: 10, color: &apos;var(--text-muted)&apos; }}&gt;
701:                       {commit.files.split(&apos; &apos;).map((f, fi) =&gt; (
702:                         &lt;div key={fi}&gt;{shortPath(f)}&lt;/div&gt;
703:                       ))}
704:                     &lt;/div&gt;
705:                   )}
706:                 &lt;/div&gt;
707:               &lt;/details&gt;
708:             ))}
709:           &lt;/div&gt;
710:         &lt;/Section&gt;
711:       )}
712: 
713:       {/* ── Code Quality ── */}
714:       {codeStructure.length &gt; 0 &amp;&amp; (
715:         &lt;Section
716:           title=&quot;Code Quality&quot;
717:           badge={`${codeStructure.length} file${codeStructure.length !== 1 ? &apos;s&apos; : &apos;&apos;} analyzed`}
718:           health={codeStructure.some(f =&gt; f.score &lt; 0.6) ? &apos;warn&apos; : &apos;ok&apos;}
719:         &gt;
720:           &lt;div style={{ overflowX: &apos;auto&apos; }}&gt;
721:             &lt;table style={{ width: &apos;100%&apos;, borderCollapse: &apos;collapse&apos;, fontFamily: &apos;var(--font-mono)&apos;, fontSize: 11 }}&gt;
722:               &lt;thead&gt;
723:                 &lt;tr style={{ borderBottom: &apos;1px solid var(--border)&apos; }}&gt;
724:                   {[&apos;File&apos;, &apos;Tool&apos;, &apos;Lines&apos;, &apos;Exports&apos;, &apos;Functions&apos;, &apos;Types&apos;, &apos;Score&apos;].map(h =&gt; (
725:                     &lt;th key={h} style={{ padding: &apos;5px 10px&apos;, textAlign: h === &apos;File&apos; || h === &apos;Tool&apos; ? &apos;left&apos; : &apos;right&apos;, color: &apos;var(--text-muted)&apos;, fontWeight: 500, letterSpacing: &apos;0.05em&apos; }}&gt;
726:                       {h.toUpperCase()}
727:                     &lt;/th&gt;
728:                   ))}
729:                 &lt;/tr&gt;
730:               &lt;/thead&gt;
731:               &lt;tbody&gt;
732:                 {codeStructure.map((f, i) =&gt; (
733:                   &lt;tr key={i} style={{ borderBottom: &apos;1px solid var(--border-subtle)&apos; }}&gt;
734:                     &lt;td style={{ padding: &apos;5px 10px&apos;, color: &apos;var(--text-secondary)&apos; }}&gt;{shortPath(f.file)}&lt;/td&gt;
735:                     &lt;td style={{ padding: &apos;5px 10px&apos;, color: &apos;var(--text-muted)&apos; }}&gt;{f.tool}&lt;/td&gt;
736:                     &lt;td style={{ padding: &apos;5px 10px&apos;, textAlign: &apos;right&apos; }}&gt;{f.lines}&lt;/td&gt;
737:                     &lt;td style={{ padding: &apos;5px 10px&apos;, textAlign: &apos;right&apos;, color: &apos;var(--text-muted)&apos; }}&gt;{f.exports}&lt;/td&gt;
738:                     &lt;td style={{ padding: &apos;5px 10px&apos;, textAlign: &apos;right&apos;, color: &apos;var(--text-muted)&apos; }}&gt;{f.functions}&lt;/td&gt;
739:                     &lt;td style={{ padding: &apos;5px 10px&apos;, textAlign: &apos;center&apos; }}&gt;{f.hasTypes ? &apos;✓&apos; : &apos;·&apos;}&lt;/td&gt;
740:                     &lt;td style={{ padding: &apos;5px 10px&apos;, textAlign: &apos;right&apos;, fontWeight: 600, color: scoreColor(f.score) }}&gt;
741:                       {f.score.toFixed(2)}
742:                     &lt;/td&gt;
743:                   &lt;/tr&gt;
744:                 ))}
745:               &lt;/tbody&gt;
746:             &lt;/table&gt;
747:           &lt;/div&gt;
748:         &lt;/Section&gt;
749:       )}
750: 
751:       {/* ── Span Breakdown ── */}
752:       &lt;Section
753:         title=&quot;Span Breakdown&quot;
754:         badge={`${spanCount} total · ${Object.keys(spanBreakdown).length} types`}
755:         health=&quot;neutral&quot;
756:       &gt;
757:         &lt;div style={{ display: &apos;grid&apos;, gridTemplateColumns: &apos;repeat(auto-fill, minmax(340px, 1fr))&apos;, gap: &apos;0 32px&apos; }}&gt;
758:           {Object.entries(spanBreakdown)
759:             .sort((a, b) =&gt; b[1] - a[1])
760:             .map(([name, count]) =&gt; (
761:               &lt;FreqBar key={name} label={name} count={count} max={maxSpanCount} color=&quot;var(--border-accent)&quot; /&gt;
762:             ))
763:           }
764:         &lt;/div&gt;
765:       &lt;/Section&gt;
766: 
767:       {/* ── Evaluations ── */}
768:       &lt;Section
769:         title=&quot;Evaluations&quot;
770:         badge={evalRows.length &gt; 0 ? `${evalRows.length} result${evalRows.length !== 1 ? &apos;s&apos; : &apos;&apos;}` : &apos;none&apos;}
771:         health={hallucinationEvals.length &gt; 0 ? &apos;crit&apos; : failedEvals.length &gt; 0 ? &apos;warn&apos; : evalRows.length &gt; 0 ? &apos;ok&apos; : &apos;neutral&apos;}
772:       &gt;
773:         {evalRows.length === 0 ? (
774:           &lt;div style={{ color: &apos;var(--text-muted)&apos;, fontSize: 13 }}&gt;
775:             No evaluations recorded for this session.
776:           &lt;/div&gt;
777:         ) : (
778:           &lt;EvaluationTable evaluations={evalRows} /&gt;
779:         )}
780:       &lt;/Section&gt;
781:     &lt;/div&gt;
782:   );
783: }</file><file path="src/__tests__/dr13-coverage.test.tsx">  1: /**
  2:  * DR13: Test coverage for TrendChart, TrendSeries, Sparkline, role views, API route validation.
  3:  * Resolves backlog item DR13.
  4:  */
  5: import { describe, it, expect, afterEach, beforeEach, vi } from &apos;vitest&apos;;
  6: import { render, screen, cleanup } from &apos;@testing-library/react&apos;;
  7: import { Sparkline } from &apos;../components/Sparkline.js&apos;;
  8: import { TrendChart } from &apos;../components/TrendChart.js&apos;;
  9: import { TrendSeries } from &apos;../components/TrendSeries.js&apos;;
 10: import { AuditorView } from &apos;../components/views/AuditorView.js&apos;;
 11: import { ExecutiveView } from &apos;../components/views/ExecutiveView.js&apos;;
 12: import { OperatorView } from &apos;../components/views/OperatorView.js&apos;;
 13: import type { MetricTrend, MetricDynamics } from &apos;../types.js&apos;;
 14: import type { TrendBucket } from &apos;../hooks/useTrend.js&apos;;
 15: 
 16: // Note: ResizeObserver stub is installed globally in setup.ts
 17: 
 18: afterEach(cleanup);
 19: 
 20: // ---------------------------------------------------------------------------
 21: // Helpers
 22: // ---------------------------------------------------------------------------
 23: 
 24: function makeTrend(overrides: Partial&lt;MetricTrend&gt; = {}): MetricTrend {
 25:   return {
 26:     direction: &apos;improving&apos;,
 27:     delta: 0.05,
 28:     previousValue: 0.80,
 29:     currentValue: 0.85,
 30:     percentChange: 6.25,
 31:     aggregation: &apos;avg&apos;,
 32:     ...overrides,
 33:   };
 34: }
 35: 
 36: function makeDynamics(overrides: Partial&lt;MetricDynamics&gt; = {}): MetricDynamics {
 37:   return {
 38:     featureVersion: &apos;1.0&apos;,
 39:     velocity: 0.02,
 40:     acceleration: 0.001,
 41:     inflectionDetected: false,
 42:     projectedStatus: &apos;healthy&apos;,
 43:     confidence: 0.75,
 44:     ...overrides,
 45:   };
 46: }
 47: 
 48: function makeTrendBucket(overrides: Partial&lt;TrendBucket&gt; = {}): TrendBucket {
 49:   return {
 50:     startTime: &apos;2026-02-20T00:00:00Z&apos;,
 51:     endTime: &apos;2026-02-21T00:00:00Z&apos;,
 52:     count: 5,
 53:     avg: 0.82,
 54:     percentiles: { p10: 0.7, p25: 0.77, p50: 0.82, p75: 0.88, p90: 0.93 },
 55:     trend: null,
 56:     dynamics: null,
 57:     ...overrides,
 58:   };
 59: }
 60: 
 61: // ---------------------------------------------------------------------------
 62: // Sparkline
 63: // ---------------------------------------------------------------------------
 64: 
 65: describe(&apos;Sparkline&apos;, () =&gt; {
 66:   it(&apos;renders null for fewer than 2 valid data points&apos;, () =&gt; {
 67:     const { container } = render(&lt;Sparkline data={[0.5]} /&gt;);
 68:     expect(container.firstChild).toBeNull();
 69:   });
 70: 
 71:   it(&apos;renders null for empty data&apos;, () =&gt; {
 72:     const { container } = render(&lt;Sparkline data={[]} /&gt;);
 73:     expect(container.firstChild).toBeNull();
 74:   });
 75: 
 76:   it(&apos;renders null when all values are null&apos;, () =&gt; {
 77:     const { container } = render(&lt;Sparkline data={[null, null, null]} /&gt;);
 78:     expect(container.firstChild).toBeNull();
 79:   });
 80: 
 81:   it(&apos;renders SVG with polyline when 2+ valid values&apos;, () =&gt; {
 82:     const { container } = render(&lt;Sparkline data={[0.5, 0.7, 0.9]} /&gt;);
 83:     const svg = container.querySelector(&apos;svg&apos;);
 84:     expect(svg).not.toBeNull();
 85:     const polyline = container.querySelector(&apos;polyline&apos;);
 86:     expect(polyline).not.toBeNull();
 87:     const points = polyline!.getAttribute(&apos;points&apos;);
 88:     expect(points).toBeTruthy();
 89:     expect(points!.split(&apos; &apos;)).toHaveLength(3);
 90:   });
 91: 
 92:   it(&apos;handles null gaps — excludes them from polyline points&apos;, () =&gt; {
 93:     const { container } = render(&lt;Sparkline data={[0.5, null, 0.9]} /&gt;);
 94:     const polyline = container.querySelector(&apos;polyline&apos;);
 95:     expect(polyline).not.toBeNull();
 96:     // Only 2 valid values, so polyline has 2 points
 97:     expect(polyline!.getAttribute(&apos;points&apos;)!.split(&apos; &apos;)).toHaveLength(2);
 98:   });
 99: 
100:   it(&apos;uses custom label as aria-label&apos;, () =&gt; {
101:     render(&lt;Sparkline data={[0.5, 0.7]} label=&quot;relevance trend&quot; /&gt;);
102:     expect(screen.getByLabelText(&apos;relevance trend&apos;)).toBeInTheDocument();
103:   });
104: 
105:   it(&apos;uses default aria-label when none provided&apos;, () =&gt; {
106:     render(&lt;Sparkline data={[0.5, 0.7]} /&gt;);
107:     expect(screen.getByLabelText(&apos;Score trend sparkline&apos;)).toBeInTheDocument();
108:   });
109: 
110:   it(&apos;respects custom width and height&apos;, () =&gt; {
111:     const { container } = render(&lt;Sparkline data={[0.5, 0.7]} width={120} height={40} /&gt;);
112:     const svg = container.querySelector(&apos;svg&apos;);
113:     expect(svg).toHaveAttribute(&apos;width&apos;, &apos;120&apos;);
114:     expect(svg).toHaveAttribute(&apos;height&apos;, &apos;40&apos;);
115:   });
116: 
117:   it(&apos;uses custom color on polyline stroke&apos;, () =&gt; {
118:     const { container } = render(&lt;Sparkline data={[0.5, 0.7]} color=&quot;#ff0000&quot; /&gt;);
119:     const polyline = container.querySelector(&apos;polyline&apos;);
120:     expect(polyline).toHaveAttribute(&apos;stroke&apos;, &apos;#ff0000&apos;);
121:   });
122: 
123:   it(&apos;renders null when only 1 of multiple is finite&apos;, () =&gt; {
124:     const { container } = render(&lt;Sparkline data={[NaN, Infinity, 0.5]} /&gt;);
125:     // Only 1 valid (0.5), renders null
126:     expect(container.firstChild).toBeNull();
127:   });
128: });
129: 
130: // ---------------------------------------------------------------------------
131: // TrendChart
132: // ---------------------------------------------------------------------------
133: 
134: // Pinned epoch for all time-relative assertions in this describe block
135: const PINNED_NOW = new Date(&apos;2026-02-22T12:00:00.000Z&apos;);
136: 
137: describe(&apos;TrendChart&apos;, () =&gt; {
138:   beforeEach(() =&gt; {
139:     vi.useFakeTimers();
140:     vi.setSystemTime(PINNED_NOW);
141:   });
142:   afterEach(() =&gt; {
143:     vi.useRealTimers();
144:   });
145: 
146:   it(&apos;renders empty state when no trend provided&apos;, () =&gt; {
147:     render(&lt;TrendChart metricName=&quot;relevance&quot; /&gt;);
148:     expect(screen.getByText(&apos;No trend data available&apos;)).toBeInTheDocument();
149:   });
150: 
151:   it(&apos;renders chart container with aria-label when trend provided&apos;, () =&gt; {
152:     render(&lt;TrendChart trend={makeTrend()} metricName=&quot;relevance&quot; /&gt;);
153:     expect(screen.getByLabelText(&apos;Trend chart for relevance&apos;)).toBeInTheDocument();
154:   });
155: 
156:   it(&apos;shows projection data when dynamics.velocity is non-zero&apos;, () =&gt; {
157:     const trend = makeTrend();
158:     const dynamics = makeDynamics({ velocity: 0.05 });
159:     render(&lt;TrendChart trend={trend} dynamics={dynamics} metricName=&quot;relevance&quot; /&gt;);
160:     // velocity is shown in the dynamics section
161:     expect(screen.getByText(&apos;Velocity:&apos;)).toBeInTheDocument();
162:     expect(screen.getByText(&apos;Acceleration:&apos;)).toBeInTheDocument();
163:   });
164: 
165:   it(&apos;does not show dynamics section when dynamics is undefined&apos;, () =&gt; {
166:     render(&lt;TrendChart trend={makeTrend()} metricName=&quot;relevance&quot; /&gt;);
167:     expect(screen.queryByText(&apos;Velocity:&apos;)).toBeNull();
168:   });
169: 
170:   it(&apos;shows zero-velocity dynamics section without projection&apos;, () =&gt; {
171:     const dynamics = makeDynamics({ velocity: 0 });
172:     render(&lt;TrendChart trend={makeTrend()} dynamics={dynamics} metricName=&quot;relevance&quot; /&gt;);
173:     expect(screen.getByText(&apos;Velocity:&apos;)).toBeInTheDocument();
174:     // No &quot;Breach in&quot; when velocity is 0 and no projectedBreachTime
175:     expect(screen.queryByText(&apos;Breach in:&apos;)).toBeNull();
176:   });
177: 
178:   it(&apos;shows breach time when projectedBreachTime is provided&apos;, () =&gt; {
179:     // Project breach 25h from pinned now — renders as &quot;25.0h&quot;
180:     const futureIso = new Date(PINNED_NOW.getTime() + 25 * 60 * 60 * 1000).toISOString();
181:     const dynamics = makeDynamics({
182:       velocity: 0.05,
183:       projectedBreachTime: futureIso,
184:       projectedStatus: &apos;warning&apos;,
185:     });
186:     render(&lt;TrendChart trend={makeTrend()} dynamics={dynamics} metricName=&quot;relevance&quot; /&gt;);
187:     expect(screen.getByText(&apos;Breach in:&apos;)).toBeInTheDocument();
188:     expect(screen.getByText(&apos;25.0h&apos;)).toBeInTheDocument();
189:   });
190: 
191:   it(&apos;shows &quot;threshold exceeded&quot; for breach in the past&apos;, () =&gt; {
192:     const pastIso = new Date(PINNED_NOW.getTime() - 1 * 60 * 60 * 1000).toISOString();
193:     const dynamics = makeDynamics({
194:       velocity: 0.05,
195:       projectedBreachTime: pastIso,
196:       projectedStatus: &apos;critical&apos;,
197:     });
198:     render(&lt;TrendChart trend={makeTrend()} dynamics={dynamics} metricName=&quot;relevance&quot; /&gt;);
199:     expect(screen.getByText(&apos;threshold exceeded&apos;)).toBeInTheDocument();
200:   });
201: 
202:   it(&apos;shows breach in minutes for sub-1h breach&apos;, () =&gt; {
203:     // 30 minutes from pinned now → &quot;30m&quot;
204:     const futureIso = new Date(PINNED_NOW.getTime() + 30 * 60 * 1000).toISOString();
205:     const dynamics = makeDynamics({
206:       velocity: 0.05,
207:       projectedBreachTime: futureIso,
208:       projectedStatus: &apos;warning&apos;,
209:     });
210:     render(&lt;TrendChart trend={makeTrend()} dynamics={dynamics} metricName=&quot;relevance&quot; /&gt;);
211:     expect(screen.getByText(&apos;30m&apos;)).toBeInTheDocument();
212:   });
213: 
214:   it(&apos;shows breach in days for 2d+ breach&apos;, () =&gt; {
215:     // 3 days from pinned now → &quot;3.0d&quot;
216:     const futureIso = new Date(PINNED_NOW.getTime() + 3 * 24 * 60 * 60 * 1000).toISOString();
217:     const dynamics = makeDynamics({
218:       velocity: 0.05,
219:       projectedBreachTime: futureIso,
220:       projectedStatus: &apos;warning&apos;,
221:     });
222:     render(&lt;TrendChart trend={makeTrend()} dynamics={dynamics} metricName=&quot;relevance&quot; /&gt;);
223:     expect(screen.getByText(&apos;3.0d&apos;)).toBeInTheDocument();
224:   });
225: 
226:   it(&apos;shows confidence percentage&apos;, () =&gt; {
227:     render(&lt;TrendChart trend={makeTrend()} dynamics={makeDynamics({ confidence: 0.75 })} metricName=&quot;relevance&quot; /&gt;);
228:     expect(screen.getByText(&apos;Confidence:&apos;)).toBeInTheDocument();
229:     expect(screen.getByText(&apos;75%&apos;)).toBeInTheDocument();
230:   });
231: 
232:   // Y-domain: when previousValue === currentValue, yPad falls back to 0.05 (TrendChart.tsx:86)
233:   // This must render the chart container, not the &quot;Insufficient data&quot; fallback
234:   it(&apos;renders chart (not empty state) when previous and current values are equal (flat trend)&apos;, () =&gt; {
235:     const flatTrend = makeTrend({ previousValue: 0.8, currentValue: 0.8, delta: 0 });
236:     render(&lt;TrendChart trend={flatTrend} metricName=&quot;relevance&quot; /&gt;);
237:     expect(screen.getByLabelText(&apos;Trend chart for relevance&apos;)).toBeInTheDocument();
238:     expect(screen.queryByText(&apos;No trend data available&apos;)).toBeNull();
239:     expect(screen.queryByText(&apos;Insufficient data&apos;)).toBeNull();
240:   });
241: 
242:   // Y-domain: chart handles threshold values in domain calculation
243:   it(&apos;renders without error when warningThreshold and criticalThreshold provided&apos;, () =&gt; {
244:     expect(() =&gt;
245:       render(
246:         &lt;TrendChart
247:           trend={makeTrend()}
248:           warningThreshold={0.7}
249:           criticalThreshold={0.5}
250:           metricName=&quot;relevance&quot;
251:         /&gt;,
252:       ),
253:     ).not.toThrow();
254:   });
255: });
256: 
257: // ---------------------------------------------------------------------------
258: // TrendSeries
259: // ---------------------------------------------------------------------------
260: 
261: describe(&apos;TrendSeries&apos;, () =&gt; {
262:   it(&apos;renders empty state when data is empty array&apos;, () =&gt; {
263:     render(&lt;TrendSeries data={[]} metricName=&quot;relevance&quot; /&gt;);
264:     expect(screen.getByText(&apos;No trend data available&apos;)).toBeInTheDocument();
265:   });
266: 
267:   it(&apos;renders &quot;no scored evaluations&quot; when all avg values are null&apos;, () =&gt; {
268:     const buckets: TrendBucket[] = [
269:       makeTrendBucket({ avg: null, percentiles: null }),
270:       makeTrendBucket({ avg: null, percentiles: null }),
271:     ];
272:     render(&lt;TrendSeries data={buckets} metricName=&quot;relevance&quot; /&gt;);
273:     expect(screen.getByText(&apos;No scored evaluations in period&apos;)).toBeInTheDocument();
274:   });
275: 
276:   it(&apos;renders chart container when data has valid avg values&apos;, () =&gt; {
277:     const buckets: TrendBucket[] = [
278:       makeTrendBucket({ startTime: &apos;2026-02-20T00:00:00Z&apos;, endTime: &apos;2026-02-21T00:00:00Z&apos;, avg: 0.82 }),
279:       makeTrendBucket({ startTime: &apos;2026-02-21T00:00:00Z&apos;, endTime: &apos;2026-02-22T00:00:00Z&apos;, avg: 0.85 }),
280:     ];
281:     render(&lt;TrendSeries data={buckets} metricName=&quot;relevance&quot; /&gt;);
282:     expect(screen.getByLabelText(&apos;Time series trend for relevance&apos;)).toBeInTheDocument();
283:   });
284: 
285:   it(&apos;renders legend row with avg, p50, p10-p90 labels&apos;, () =&gt; {
286:     const buckets: TrendBucket[] = [
287:       makeTrendBucket({ avg: 0.82 }),
288:       makeTrendBucket({ avg: 0.85 }),
289:     ];
290:     const { container } = render(&lt;TrendSeries data={buckets} metricName=&quot;relevance&quot; /&gt;);
291:     expect(container.textContent).toContain(&apos;avg&apos;);
292:     expect(container.textContent).toContain(&apos;p50&apos;);
293:     expect(container.textContent).toContain(&apos;p10-p90&apos;);
294:   });
295: 
296:   it(&apos;handles single-day span without error&apos;, () =&gt; {
297:     const now = new Date(&apos;2026-02-22T12:00:00Z&apos;);
298:     const buckets: TrendBucket[] = [
299:       makeTrendBucket({
300:         startTime: new Date(now.getTime() - 12 * 3600000).toISOString(),
301:         endTime: now.toISOString(),
302:         avg: 0.82,
303:       }),
304:       makeTrendBucket({
305:         startTime: now.toISOString(),
306:         endTime: new Date(now.getTime() + 12 * 3600000).toISOString(),
307:         avg: 0.84,
308:       }),
309:     ];
310:     expect(() =&gt; render(&lt;TrendSeries data={buckets} metricName=&quot;relevance&quot; /&gt;)).not.toThrow();
311:   });
312: });
313: 
314: // ---------------------------------------------------------------------------
315: // Role Views
316: // ---------------------------------------------------------------------------
317: 
318: function makeMetricResult(name: string, displayName: string, status: &apos;healthy&apos; | &apos;warning&apos; | &apos;critical&apos; | &apos;no_data&apos; = &apos;healthy&apos;) {
319:   return {
320:     name,
321:     displayName,
322:     status,
323:     sampleCount: 10,
324:     values: { avg: 0.88, min: 0.70, max: 0.95, count: 10, p50: 0.88, p95: 0.93, p99: 0.95 },
325:     alerts: [] as Array&lt;{ severity: &apos;warning&apos; | &apos;critical&apos;; message: string; aggregation: &apos;avg&apos;; threshold: number; actualValue: number; direction: &apos;below&apos; | &apos;above&apos; }&gt;,
326:   };
327: }
328: 
329: describe(&apos;AuditorView&apos;, () =&gt; {
330:   function makeAuditorData() {
331:     return {
332:       role: &apos;auditor&apos; as const,
333:       totalEvaluationCount: 150,
334:       metrics: [makeMetricResult(&apos;relevance&apos;, &apos;Relevance&apos;)],
335:       alerts: [
336:         { severity: &apos;warning&apos; as const, message: &apos;Relevance degrading&apos;, aggregation: &apos;avg&apos; as const,
337:           threshold: 0.8, actualValue: 0.79, direction: &apos;below&apos; as const, metricName: &apos;relevance&apos; },
338:       ],
339:       timestamp: &apos;2026-02-22T12:00:00Z&apos;,
340:       slaCompliance: [],
341:     };
342:   }
343: 
344:   it(&apos;renders total evaluation count&apos;, () =&gt; {
345:     const { container } = render(&lt;AuditorView data={makeAuditorData()} /&gt;);
346:     // The 150 count appears in the first stats card
347:     const countCards = container.querySelectorAll(&apos;.card&apos;);
348:     const texts = Array.from(countCards).map(el =&gt; el.textContent);
349:     expect(texts.some(t =&gt; t?.includes(&apos;150&apos;))).toBe(true);
350:   });
351: 
352:   it(&apos;renders metrics count as 1&apos;, () =&gt; {
353:     const { container } = render(&lt;AuditorView data={makeAuditorData()} /&gt;);
354:     // stats cards: 150 (total), 1 (metrics), 1 (alerts)
355:     const cardTexts = Array.from(container.querySelectorAll(&apos;.card&apos;)).map(el =&gt; el.textContent);
356:     // At least one card shows &quot;1&quot; and &quot;Metrics&quot;
357:     expect(cardTexts.some(t =&gt; t?.includes(&apos;Metrics&apos;) &amp;&amp; t?.includes(&apos;1&apos;))).toBe(true);
358:   });
359: 
360:   it(&apos;shows All Metrics section&apos;, () =&gt; {
361:     render(&lt;AuditorView data={makeAuditorData()} /&gt;);
362:     expect(screen.getByText(&apos;All Metrics&apos;)).toBeInTheDocument();
363:   });
364: 
365:   it(&apos;shows All Alerts section when alerts present&apos;, () =&gt; {
366:     render(&lt;AuditorView data={makeAuditorData()} /&gt;);
367:     expect(screen.getByText(&apos;All Alerts&apos;)).toBeInTheDocument();
368:   });
369: 
370:   it(&apos;does not show alerts section when no alerts&apos;, () =&gt; {
371:     const data = { ...makeAuditorData(), alerts: [] };
372:     render(&lt;AuditorView data={data} /&gt;);
373:     expect(screen.queryByText(&apos;All Alerts&apos;)).toBeNull();
374:   });
375: 
376:   it(&apos;renders computed-at timestamp&apos;, () =&gt; {
377:     render(&lt;AuditorView data={makeAuditorData()} /&gt;);
378:     expect(screen.getByText(&apos;Computed At&apos;)).toBeInTheDocument();
379:   });
380: });
381: 
382: describe(&apos;ExecutiveView&apos;, () =&gt; {
383:   function makeExecutiveData() {
384:     return {
385:       role: &apos;executive&apos; as const,
386:       overallStatus: &apos;healthy&apos; as const,
387:       summary: { totalMetrics: 7, healthyMetrics: 6, warningMetrics: 1, criticalMetrics: 0, noDataMetrics: 0 },
388:       topIssues: [
389:         { name: &apos;hallucination&apos;, displayName: &apos;Hallucination Rate&apos;, status: &apos;warning&apos;, alertCount: 2 },
390:       ],
391:       metricStatuses: [
392:         { name: &apos;relevance&apos;, displayName: &apos;Relevance&apos;, status: &apos;healthy&apos; },
393:         { name: &apos;hallucination&apos;, displayName: &apos;Hallucination Rate&apos;, status: &apos;warning&apos; },
394:       ],
395:       alertCounts: { warning: 1, critical: 0, info: 0 },
396:     };
397:   }
398: 
399:   it(&apos;renders Executive Summary header&apos;, () =&gt; {
400:     render(&lt;ExecutiveView data={makeExecutiveData()} /&gt;);
401:     expect(screen.getByText(&apos;Executive Summary&apos;)).toBeInTheDocument();
402:   });
403: 
404:   it(&apos;renders top issues when present&apos;, () =&gt; {
405:     render(&lt;ExecutiveView data={makeExecutiveData()} /&gt;);
406:     expect(screen.getByText(&apos;Top Issues&apos;)).toBeInTheDocument();
407:     // &quot;Hallucination Rate&quot; appears in both top issues and metric statuses
408:     expect(screen.getAllByText(&apos;Hallucination Rate&apos;).length).toBeGreaterThanOrEqual(1);
409:   });
410: 
411:   it(&apos;renders metric statuses&apos;, () =&gt; {
412:     render(&lt;ExecutiveView data={makeExecutiveData()} /&gt;);
413:     expect(screen.getByText(&apos;Metric Statuses&apos;)).toBeInTheDocument();
414:     expect(screen.getByText(&apos;Relevance&apos;)).toBeInTheDocument();
415:   });
416: 
417:   it(&apos;renders alert summary counts&apos;, () =&gt; {
418:     render(&lt;ExecutiveView data={makeExecutiveData()} /&gt;);
419:     expect(screen.getByText(&apos;Alert Summary&apos;)).toBeInTheDocument();
420:   });
421: 
422:   it(&apos;renders SLA counts when provided&apos;, () =&gt; {
423:     const data = { ...makeExecutiveData(), slaCompliantCount: 3, slaTotalCount: 4 };
424:     render(&lt;ExecutiveView data={data} /&gt;);
425:     expect(screen.getByText(&apos;3/4&apos;)).toBeInTheDocument();
426:     expect(screen.getByText(&apos;SLAs Met&apos;)).toBeInTheDocument();
427:   });
428: 
429:   it(&apos;shows plural alerts in top issues&apos;, () =&gt; {
430:     render(&lt;ExecutiveView data={makeExecutiveData()} /&gt;);
431:     expect(screen.getByText(/2 alerts/)).toBeInTheDocument();
432:   });
433: 
434:   it(&apos;shows singular alert in top issues&apos;, () =&gt; {
435:     const data = {
436:       ...makeExecutiveData(),
437:       topIssues: [{ name: &apos;relevance&apos;, displayName: &apos;Relevance&apos;, status: &apos;warning&apos;, alertCount: 1 }],
438:     };
439:     render(&lt;ExecutiveView data={data} /&gt;);
440:     // &quot;1 alert&quot; (no &apos;s&apos;)
441:     const listItems = screen.getAllByRole(&apos;listitem&apos;);
442:     expect(listItems.some(li =&gt; li.textContent?.includes(&apos;1 alert&apos;) &amp;&amp; !li.textContent?.includes(&apos;alerts&apos;))).toBe(true);
443:   });
444: });
445: 
446: describe(&apos;OperatorView&apos;, () =&gt; {
447:   function makeTrendForOperator(): MetricTrend {
448:     return { direction: &apos;degrading&apos;, delta: -0.05, previousValue: 0.85, currentValue: 0.80, percentChange: -5.88, aggregation: &apos;avg&apos; };
449:   }
450: 
451:   function makeOperatorData() {
452:     return {
453:       role: &apos;operator&apos; as const,
454:       overallStatus: &apos;warning&apos; as const,
455:       prioritizedAlerts: [
456:         { severity: &apos;warning&apos; as const, message: &apos;Relevance below threshold&apos;, aggregation: &apos;avg&apos; as const,
457:           threshold: 0.8, actualValue: 0.75, direction: &apos;below&apos; as const, metricName: &apos;relevance&apos; },
458:       ],
459:       degradingTrends: [
460:         { metricName: &apos;relevance&apos;, trend: makeTrendForOperator() },
461:       ],
462:       alertingMetrics: [],
463:     };
464:   }
465: 
466:   it(&apos;renders &quot;All Clear&quot; when no alerts and no degrading trends&apos;, () =&gt; {
467:     const data = { ...makeOperatorData(), prioritizedAlerts: [], degradingTrends: [] };
468:     render(&lt;OperatorView data={data} /&gt;);
469:     expect(screen.getByText(&apos;All Clear&apos;)).toBeInTheDocument();
470:     expect(screen.getByText(&apos;No active alerts or degrading trends.&apos;)).toBeInTheDocument();
471:   });
472: 
473:   it(&apos;renders prioritized alerts when present&apos;, () =&gt; {
474:     render(&lt;OperatorView data={makeOperatorData()} /&gt;);
475:     expect(screen.getByText(&apos;Prioritized Alerts&apos;)).toBeInTheDocument();
476:     expect(screen.getByText(&apos;Relevance below threshold&apos;)).toBeInTheDocument();
477:   });
478: 
479:   it(&apos;renders degrading trends section when present&apos;, () =&gt; {
480:     render(&lt;OperatorView data={makeOperatorData()} /&gt;);
481:     expect(screen.getByText(&apos;Degrading Trends&apos;)).toBeInTheDocument();
482:     expect(screen.getByText(/relevance/)).toBeInTheDocument();
483:   });
484: 
485:   it(&apos;renders alert count in header banner&apos;, () =&gt; {
486:     render(&lt;OperatorView data={makeOperatorData()} /&gt;);
487:     expect(screen.getByText(/1 active alert/)).toBeInTheDocument();
488:   });
489: 
490:   it(&apos;renders plural in banner for multiple alerts&apos;, () =&gt; {
491:     const data = {
492:       ...makeOperatorData(),
493:       prioritizedAlerts: [
494:         { severity: &apos;warning&apos; as const, message: &apos;Alert 1&apos;, aggregation: &apos;avg&apos; as const, threshold: 0.8, actualValue: 0.75, direction: &apos;below&apos; as const, metricName: &apos;relevance&apos; },
495:         { severity: &apos;critical&apos; as const, message: &apos;Alert 2&apos;, aggregation: &apos;avg&apos; as const, threshold: 0.5, actualValue: 0.3, direction: &apos;below&apos; as const, metricName: &apos;faithfulness&apos; },
496:       ],
497:     };
498:     render(&lt;OperatorView data={data} /&gt;);
499:     expect(screen.getByText(/2 active alerts/)).toBeInTheDocument();
500:   });
501: 
502:   it(&apos;does not show All Clear when only degrading trends present&apos;, () =&gt; {
503:     const data = { ...makeOperatorData(), prioritizedAlerts: [] };
504:     render(&lt;OperatorView data={data} /&gt;);
505:     expect(screen.queryByText(&apos;All Clear&apos;)).toBeNull();
506:   });
507: });
508: 
509: // ---------------------------------------------------------------------------
510: // Trends API route — input validation
511: // ---------------------------------------------------------------------------
512: 
513: vi.mock(&apos;../../../../dist/lib/quality-metrics.js&apos;, () =&gt; ({
514:   getQualityMetric: vi.fn((name: string) =&gt; name === &apos;relevance&apos; ? { aggregations: [&apos;avg&apos;] } : null),
515:   computeMetricDetail: vi.fn(() =&gt; null),
516:   computeAggregations: vi.fn(() =&gt; ({})),
517:   QUALITY_METRICS: { relevance: { aggregations: [&apos;avg&apos;] } },
518: }));
519: 
520: vi.mock(&apos;../../../../dist/lib/quality-feature-engineering.js&apos;, () =&gt; ({
521:   computePercentileDistribution: vi.fn(() =&gt; null),
522:   computeMetricDynamics: vi.fn(() =&gt; null),
523: }));
524: 
525: vi.mock(&apos;../../../../dist/lib/error-sanitizer.js&apos;, () =&gt; ({
526:   sanitizeErrorForResponse: vi.fn((e: unknown) =&gt; String(e)),
527: }));
528: 
529: vi.mock(&apos;../api/data-loader.js&apos;, async () =&gt; ({
530:   loadEvaluationsForMetric: vi.fn(async () =&gt; []),
531: }));
532: 
533: describe(&apos;trends API route validation&apos;, () =&gt; {
534:   // ESM caches the module — trendRoutes is a singleton across all loadTrendRoutes() calls.
535:   // Reset mock call counts after each test; implementations are preserved by vi.clearAllMocks().
536:   afterEach(() =&gt; {
537:     vi.clearAllMocks();
538:   });
539: 
540:   async function loadTrendRoutes() {
541:     const { trendRoutes } = await import(&apos;../api/routes/trends.js&apos;);
542:     return trendRoutes;
543:   }
544: 
545:   it(&apos;returns 404 for unknown metric&apos;, async () =&gt; {
546:     const app = await loadTrendRoutes();
547:     const res = await app.request(&apos;/trends/nonexistent-metric&apos;);
548:     expect(res.status).toBe(404);
549:     const body = await res.json() as { error: string };
550:     expect(body.error).toContain(&apos;nonexistent-metric&apos;);
551:   });
552: 
553:   it(&apos;returns 400 for invalid period param&apos;, async () =&gt; {
554:     const app = await loadTrendRoutes();
555:     const res = await app.request(&apos;/trends/relevance?period=invalid&apos;);
556:     expect(res.status).toBe(400);
557:     const body = await res.json() as { error: string };
558:     expect(body.error).toContain(&apos;Invalid period&apos;);
559:   });
560: 
561:   it(&apos;returns 400 for invalid buckets param (non-integer)&apos;, async () =&gt; {
562:     const app = await loadTrendRoutes();
563:     const res = await app.request(&apos;/trends/relevance?period=7d&amp;buckets=abc&apos;);
564:     expect(res.status).toBe(400);
565:     const body = await res.json() as { error: string };
566:     expect(body.error).toContain(&apos;Invalid buckets&apos;);
567:   });
568: 
569:   it(&apos;returns 400 for buckets below minimum (&lt; 3)&apos;, async () =&gt; {
570:     const app = await loadTrendRoutes();
571:     const res = await app.request(&apos;/trends/relevance?period=7d&amp;buckets=2&apos;);
572:     expect(res.status).toBe(400);
573:   });
574: 
575:   it(&apos;returns 400 for buckets above maximum (&gt; 30)&apos;, async () =&gt; {
576:     const app = await loadTrendRoutes();
577:     const res = await app.request(&apos;/trends/relevance?period=7d&amp;buckets=31&apos;);
578:     expect(res.status).toBe(400);
579:   });
580: 
581:   it(&apos;returns 200 for valid known metric and default params&apos;, async () =&gt; {
582:     const app = await loadTrendRoutes();
583:     const res = await app.request(&apos;/trends/relevance&apos;);
584:     expect(res.status).toBe(200);
585:     const body = await res.json() as { metric: string };
586:     expect(body.metric).toBe(&apos;relevance&apos;);
587:   });
588: 
589:   it(&apos;returns 200 for valid period and buckets&apos;, async () =&gt; {
590:     const app = await loadTrendRoutes();
591:     const res = await app.request(&apos;/trends/relevance?period=24h&amp;buckets=5&apos;);
592:     expect(res.status).toBe(200);
593:   });
594: 
595:   it(&apos;returns 400 for invalid period on /trends summary route&apos;, async () =&gt; {
596:     const app = await loadTrendRoutes();
597:     const res = await app.request(&apos;/trends?period=invalid&apos;);
598:     expect(res.status).toBe(400);
599:   });
600: });</file><file path="src/__tests__/f1-f6-components.test.tsx">  1: import { describe, it, expect, afterEach, vi } from &apos;vitest&apos;;
  2: import { render, screen, cleanup, fireEvent, within, act } from &apos;@testing-library/react&apos;;
  3: import { ScoreBadge } from &apos;../components/ScoreBadge.js&apos;;
  4: import { CQIHero } from &apos;../components/CQIHero.js&apos;;
  5: import { EvaluationTable, type EvalRow } from &apos;../components/EvaluationTable.js&apos;;
  6: import { CorrelationHeatmap } from &apos;../components/CorrelationHeatmap.js&apos;;
  7: import { KeyboardNavProvider, useShortcut, useKeyboardNav } from &apos;../contexts/KeyboardNavContext.js&apos;;
  8: import type { CompositeQualityIndex } from &apos;../types.js&apos;;
  9: import type { CorrelationFeature } from &apos;../types.js&apos;;
 10: 
 11: afterEach(cleanup);
 12: 
 13: // ---------------------------------------------------------------------------
 14: // ScoreBadge (F1)
 15: // ---------------------------------------------------------------------------
 16: 
 17: describe(&apos;ScoreBadge&apos;, () =&gt; {
 18:   it(&apos;renders null score as N/A with aria-label&apos;, () =&gt; {
 19:     render(&lt;ScoreBadge score={null} metricName=&quot;relevance&quot; /&gt;);
 20:     const badge = screen.getByLabelText(&apos;relevance: no data&apos;);
 21:     expect(badge).toBeInTheDocument();
 22:     expect(badge.textContent).toContain(&apos;N/A&apos;);
 23:   });
 24: 
 25:   it(&apos;renders high score with excellent band&apos;, () =&gt; {
 26:     render(&lt;ScoreBadge score={0.95} metricName=&quot;relevance&quot; direction=&quot;maximize&quot; /&gt;);
 27:     const badge = screen.getByLabelText(/Score: 0.95, excellent/);
 28:     expect(badge).toBeInTheDocument();
 29:     expect(badge.textContent).toContain(&apos;0.95&apos;);
 30:   });
 31: 
 32:   it(&apos;renders minimize direction hint&apos;, () =&gt; {
 33:     render(&lt;ScoreBadge score={0.05} metricName=&quot;hallucination&quot; direction=&quot;minimize&quot; /&gt;);
 34:     expect(screen.getByLabelText(/lower is better/)).toBeInTheDocument();
 35:   });
 36: 
 37:   it(&apos;uses custom label when provided&apos;, () =&gt; {
 38:     render(&lt;ScoreBadge score={0.85} metricName=&quot;coherence&quot; label=&quot;0.8500&quot; /&gt;);
 39:     const badge = screen.getByLabelText(/Score: 0.85/);
 40:     expect(badge.textContent).toContain(&apos;0.8500&apos;);
 41:   });
 42: 
 43:   it(&apos;renders failing band for low maximize score&apos;, () =&gt; {
 44:     render(&lt;ScoreBadge score={0.3} metricName=&quot;relevance&quot; direction=&quot;maximize&quot; /&gt;);
 45:     expect(screen.getByLabelText(/failing/)).toBeInTheDocument();
 46:   });
 47: });
 48: 
 49: // ---------------------------------------------------------------------------
 50: // CQIHero (F2)
 51: // ---------------------------------------------------------------------------
 52: 
 53: function makeCQI(overrides: Partial&lt;CompositeQualityIndex&gt; = {}): CompositeQualityIndex {
 54:   return {
 55:     value: 0.82,
 56:     featureVersion: &apos;1.0&apos;,
 57:     weights: { relevance: 0.2, coherence: 0.15, hallucination: 0.2 },
 58:     contributions: [
 59:       { metric: &apos;relevance&apos;, rawScore: 0.9, normalizedScore: 0.9, weight: 0.2, contribution: 0.18 },
 60:       { metric: &apos;coherence&apos;, rawScore: 0.85, normalizedScore: 0.85, weight: 0.15, contribution: 0.1275 },
 61:       { metric: &apos;hallucination&apos;, rawScore: 0.05, normalizedScore: 0.95, weight: 0.2, contribution: 0.19 },
 62:     ],
 63:     ...overrides,
 64:   };
 65: }
 66: 
 67: describe(&apos;CQIHero&apos;, () =&gt; {
 68:   it(&apos;renders CQI value as percentage&apos;, () =&gt; {
 69:     const { container } = render(&lt;CQIHero cqi={makeCQI()} /&gt;);
 70:     expect(container.textContent).toContain(&apos;82.0&apos;);
 71:   });
 72: 
 73:   it(&apos;has correct region role and aria-label&apos;, () =&gt; {
 74:     render(&lt;CQIHero cqi={makeCQI()} /&gt;);
 75:     const region = screen.getByRole(&apos;region&apos;);
 76:     expect(region).toHaveAttribute(&apos;aria-label&apos;, &apos;Composite Quality Index: 82.0&apos;);
 77:   });
 78: 
 79:   it(&apos;renders contribution segments with titles&apos;, () =&gt; {
 80:     const { container } = render(&lt;CQIHero cqi={makeCQI()} /&gt;);
 81:     const segments = container.querySelectorAll(&apos;[title*=&quot;weight&quot;]&apos;);
 82:     expect(segments).toHaveLength(3);
 83:   });
 84: 
 85:   it(&apos;renders screen reader table with caption&apos;, () =&gt; {
 86:     const { container } = render(&lt;CQIHero cqi={makeCQI()} /&gt;);
 87:     const caption = container.querySelector(&apos;caption&apos;);
 88:     expect(caption).toHaveTextContent(&apos;CQI Metric Breakdown&apos;);
 89:   });
 90: 
 91:   it(&apos;handles empty contributions&apos;, () =&gt; {
 92:     const { container } = render(&lt;CQIHero cqi={makeCQI({ contributions: [] })} /&gt;);
 93:     expect(container.textContent).toContain(&apos;82.0&apos;);
 94:     expect(container.querySelectorAll(&apos;[title*=&quot;weight&quot;]&apos;)).toHaveLength(0);
 95:   });
 96: });
 97: 
 98: // ---------------------------------------------------------------------------
 99: // EvaluationTable (F6)
100: // ---------------------------------------------------------------------------
101: 
102: function makeEvalRows(): EvalRow[] {
103:   return [
104:     { score: 0.95, label: &apos;excellent&apos;, explanation: &apos;Great output&apos;, evaluator: &apos;judge-1&apos;, timestamp: &apos;2026-02-17T00:00:00Z&apos; },
105:     { score: 0.5, label: &apos;partial&apos;, explanation: &apos;Needs work&apos;, evaluator: &apos;judge-1&apos;, timestamp: &apos;2026-02-16T00:00:00Z&apos; },
106:     { score: 0.1, label: &apos;hallucinated&apos;, explanation: &apos;Contains hallucination&apos;, evaluator: &apos;judge-2&apos;, timestamp: &apos;2026-02-15T00:00:00Z&apos; },
107:   ];
108: }
109: 
110: describe(&apos;EvaluationTable&apos;, () =&gt; {
111:   it(&apos;renders all evaluation rows&apos;, () =&gt; {
112:     const { container } = render(&lt;EvaluationTable evaluations={makeEvalRows()} /&gt;);
113:     const rows = container.querySelectorAll(&apos;tbody tr&apos;);
114:     expect(rows).toHaveLength(3);
115:   });
116: 
117:   it(&apos;renders score values in table cells&apos;, () =&gt; {
118:     const { container } = render(&lt;EvaluationTable evaluations={makeEvalRows()} /&gt;);
119:     expect(container.textContent).toContain(&apos;0.9500&apos;);
120:     expect(container.textContent).toContain(&apos;0.5000&apos;);
121:     expect(container.textContent).toContain(&apos;0.1000&apos;);
122:   });
123: 
124:   it(&apos;renders category filter buttons&apos;, () =&gt; {
125:     render(&lt;EvaluationTable evaluations={makeEvalRows()} /&gt;);
126:     const buttons = screen.getAllByRole(&apos;button&apos;);
127:     const labels = buttons.map(b =&gt; b.textContent);
128:     expect(labels).toContain(&apos;Pass&apos;);
129:     expect(labels).toContain(&apos;Review&apos;);
130:     expect(labels).toContain(&apos;Fail&apos;);
131:   });
132: 
133:   it(&apos;filters rows when category button clicked&apos;, () =&gt; {
134:     const { container } = render(&lt;EvaluationTable evaluations={makeEvalRows()} /&gt;);
135:     const failBtn = screen.getAllByRole(&apos;button&apos;).find(b =&gt; b.textContent === &apos;Fail&apos;)!;
136:     fireEvent.click(failBtn);
137:     const rows = container.querySelectorAll(&apos;tbody tr&apos;);
138:     expect(rows.length).toBeLessThan(3);
139:   });
140: 
141:   it(&apos;renders empty state when no evaluations&apos;, () =&gt; {
142:     const { container } = render(&lt;EvaluationTable evaluations={[]} /&gt;);
143:     expect(container.textContent).toContain(&apos;No evaluations match&apos;);
144:   });
145: 
146:   it(&apos;has sortable column headers with aria-sort&apos;, () =&gt; {
147:     const { container } = render(&lt;EvaluationTable evaluations={makeEvalRows()} /&gt;);
148:     const sortableHeaders = container.querySelectorAll(&apos;th[aria-sort]&apos;);
149:     expect(sortableHeaders.length).toBeGreaterThan(0);
150:   });
151: 
152:   it(&apos;renders expand toggle on each row&apos;, () =&gt; {
153:     render(&lt;EvaluationTable evaluations={makeEvalRows()} /&gt;);
154:     const expandBtns = screen.getAllByLabelText(&apos;Expand row&apos;);
155:     expect(expandBtns).toHaveLength(3);
156:   });
157: 
158:   it(&apos;expands row on click to show full detail&apos;, () =&gt; {
159:     const rows: EvalRow[] = [{
160:       score: 0.95,
161:       label: &apos;excellent&apos;,
162:       explanation: &apos;A very detailed explanation that should be fully visible when expanded&apos;,
163:       evaluator: &apos;judge-1&apos;,
164:       timestamp: &apos;2026-02-17T00:00:00Z&apos;,
165:       evaluatorType: &apos;llm&apos;,
166:       traceId: &apos;abc-123&apos;,
167:       sessionId: &apos;sess-456&apos;,
168:     }];
169:     const { container } = render(&lt;EvaluationTable evaluations={rows} /&gt;);
170:     const expandBtn = screen.getByLabelText(&apos;Expand row&apos;);
171:     fireEvent.click(expandBtn);
172:     expect(container.textContent).toContain(&apos;Evaluator Type&apos;);
173:     expect(container.textContent).toContain(&apos;llm&apos;);
174:     expect(container.textContent).toContain(&apos;abc-123&apos;);
175:     expect(container.textContent).toContain(&apos;sess-456&apos;);
176:   });
177: 
178:   it(&apos;collapses row on second click&apos;, () =&gt; {
179:     const rows: EvalRow[] = [{
180:       score: 0.95,
181:       label: &apos;excellent&apos;,
182:       explanation: &apos;Detail text&apos;,
183:       evaluatorType: &apos;llm&apos;,
184:       traceId: &apos;abc-123&apos;,
185:     }];
186:     const { container } = render(&lt;EvaluationTable evaluations={rows} /&gt;);
187:     const expandBtn = screen.getByLabelText(&apos;Expand row&apos;);
188:     fireEvent.click(expandBtn);
189:     expect(container.textContent).toContain(&apos;Evaluator Type&apos;);
190:     const collapseBtn = screen.getByLabelText(&apos;Collapse row&apos;);
191:     fireEvent.click(collapseBtn);
192:     expect(container.textContent).not.toContain(&apos;Evaluator Type&apos;);
193:   });
194: });
195: 
196: // ---------------------------------------------------------------------------
197: // CorrelationHeatmap (F5)
198: // ---------------------------------------------------------------------------
199: 
200: function makeCorrelations(): { correlations: CorrelationFeature[]; metrics: string[] } {
201:   const metrics = [&apos;relevance&apos;, &apos;coherence&apos;, &apos;hallucination&apos;];
202:   const correlations: CorrelationFeature[] = [
203:     {
204:       metricA: &apos;relevance&apos;, metricB: &apos;coherence&apos;,
205:       pearsonR: 0.73, spearmanR: 0.7, effectSize: 0.5,
206:       pValue: 0.001, significant: true,
207:       lagHours: 0, isKnownToxicCombo: false,
208:       coOccurrenceRate: 0, causalConfidence: &apos;correlation&apos;,
209:       featureVersion: &apos;3.0&apos;,
210:     },
211:     {
212:       metricA: &apos;relevance&apos;, metricB: &apos;hallucination&apos;,
213:       pearsonR: -0.85, spearmanR: -0.82, effectSize: 0.9,
214:       pValue: 0.0001, significant: true,
215:       lagHours: 1, isKnownToxicCombo: true,
216:       coOccurrenceRate: 0.6, causalConfidence: &apos;correlation&apos;,
217:       featureVersion: &apos;3.0&apos;,
218:     },
219:     {
220:       metricA: &apos;coherence&apos;, metricB: &apos;hallucination&apos;,
221:       pearsonR: -0.45, spearmanR: -0.4, effectSize: 0.3,
222:       pValue: 0.05, significant: false,
223:       lagHours: 0, isKnownToxicCombo: false,
224:       coOccurrenceRate: 0, causalConfidence: &apos;correlation&apos;,
225:       featureVersion: &apos;3.0&apos;,
226:     },
227:   ];
228:   return { correlations, metrics };
229: }
230: 
231: describe(&apos;CorrelationHeatmap&apos;, () =&gt; {
232:   it(&apos;renders table with correct role&apos;, () =&gt; {
233:     const { correlations, metrics } = makeCorrelations();
234:     const { container } = render(&lt;CorrelationHeatmap correlations={correlations} metrics={metrics} /&gt;);
235:     expect(container.querySelector(&apos;[role=&quot;table&quot;]&apos;)).toBeInTheDocument();
236:   });
237: 
238:   it(&apos;renders column headers&apos;, () =&gt; {
239:     const { correlations, metrics } = makeCorrelations();
240:     const { container } = render(&lt;CorrelationHeatmap correlations={correlations} metrics={metrics} /&gt;);
241:     const headers = container.querySelectorAll(&apos;[role=&quot;columnheader&quot;]&apos;);
242:     expect(headers).toHaveLength(3);
243:   });
244: 
245:   it(&apos;renders diagonal cells as 1.00&apos;, () =&gt; {
246:     const { correlations, metrics } = makeCorrelations();
247:     const { container } = render(&lt;CorrelationHeatmap correlations={correlations} metrics={metrics} /&gt;);
248:     // Diagonal cells have aria-label like &quot;relevance vs relevance: 1.00&quot;
249:     const allCells = container.querySelectorAll(&apos;[role=&quot;cell&quot;]&apos;);
250:     let diagCount = 0;
251:     allCells.forEach(cell =&gt; {
252:       if (cell.textContent === &apos;1.00&apos;) diagCount++;
253:     });
254:     expect(diagCount).toBe(3);
255:   });
256: 
257:   it(&apos;renders off-diagonal correlation values&apos;, () =&gt; {
258:     const { correlations, metrics } = makeCorrelations();
259:     const { container } = render(&lt;CorrelationHeatmap correlations={correlations} metrics={metrics} /&gt;);
260:     expect(container.textContent).toContain(&apos;0.73&apos;);
261:     expect(container.textContent).toContain(&apos;-0.85&apos;);
262:   });
263: 
264:   it(&apos;renders cells with aria-labels&apos;, () =&gt; {
265:     const { correlations, metrics } = makeCorrelations();
266:     const { container } = render(&lt;CorrelationHeatmap correlations={correlations} metrics={metrics} /&gt;);
267:     const cell = container.querySelector(&apos;[aria-label*=&quot;relevance vs coherence&quot;]&apos;);
268:     expect(cell).toBeInTheDocument();
269:   });
270: 
271:   it(&apos;applies toxic border styling&apos;, () =&gt; {
272:     const { correlations, metrics } = makeCorrelations();
273:     const { container } = render(&lt;CorrelationHeatmap correlations={correlations} metrics={metrics} /&gt;);
274:     const toxicCells = container.querySelectorAll(&apos;[style*=&quot;2px solid&quot;]&apos;);
275:     expect(toxicCells.length).toBeGreaterThanOrEqual(2);
276:   });
277: });
278: 
279: // ---------------------------------------------------------------------------
280: // KeyboardNavContext — regression tests for infinite re-render fix
281: // ---------------------------------------------------------------------------
282: 
283: function ShortcutConsumer({ shortcutKey, desc }: { shortcutKey: string; desc: string }) {
284:   const action = vi.fn();
285:   useShortcut(shortcutKey, desc, &apos;test&apos;, action);
286:   return &lt;div data-testid=&quot;consumer&quot;&gt;{desc}&lt;/div&gt;;
287: }
288: 
289: describe(&apos;KeyboardNavProvider&apos;, () =&gt; {
290:   it(&apos;renders children without infinite loop&apos;, () =&gt; {
291:     const { getByTestId } = render(
292:       &lt;KeyboardNavProvider&gt;
293:         &lt;ShortcutConsumer shortcutKey=&quot;h&quot; desc=&quot;Go home&quot; /&gt;
294:       &lt;/KeyboardNavProvider&gt;,
295:     );
296:     expect(getByTestId(&apos;consumer&apos;)).toBeInTheDocument();
297:   });
298: 
299:   it(&apos;registers multiple shortcuts without loop&apos;, () =&gt; {
300:     const { getAllByTestId } = render(
301:       &lt;KeyboardNavProvider&gt;
302:         &lt;ShortcutConsumer shortcutKey=&quot;h&quot; desc=&quot;Go home&quot; /&gt;
303:         &lt;ShortcutConsumer shortcutKey=&quot;s&quot; desc=&quot;Search&quot; /&gt;
304:         &lt;ShortcutConsumer shortcutKey=&quot;?&quot; desc=&quot;Help&quot; /&gt;
305:       &lt;/KeyboardNavProvider&gt;,
306:     );
307:     expect(getAllByTestId(&apos;consumer&apos;)).toHaveLength(3);
308:   });
309: 
310:   it(&apos;useKeyboardNav throws outside provider&apos;, () =&gt; {
311:     function Orphan() {
312:       useKeyboardNav();
313:       return null;
314:     }
315:     expect(() =&gt; render(&lt;Orphan /&gt;)).toThrow(&apos;useKeyboardNav must be used within KeyboardNavProvider&apos;);
316:   });
317: 
318:   it(&apos;fires shortcut action on keydown&apos;, () =&gt; {
319:     const action = vi.fn();
320:     function ActionConsumer() {
321:       useShortcut(&apos;x&apos;, &apos;Test action&apos;, &apos;test&apos;, action);
322:       return null;
323:     }
324:     render(
325:       &lt;KeyboardNavProvider&gt;
326:         &lt;ActionConsumer /&gt;
327:       &lt;/KeyboardNavProvider&gt;,
328:     );
329:     act(() =&gt; {
330:       fireEvent.keyDown(document, { key: &apos;x&apos; });
331:     });
332:     expect(action).toHaveBeenCalledOnce();
333:   });
334: 
335:   it(&apos;toggles overlay on ? key&apos;, () =&gt; {
336:     function OverlayReader() {
337:       const { overlayOpen } = useKeyboardNav();
338:       return &lt;div data-testid=&quot;overlay&quot;&gt;{overlayOpen ? &apos;open&apos; : &apos;closed&apos;}&lt;/div&gt;;
339:     }
340:     render(
341:       &lt;KeyboardNavProvider&gt;
342:         &lt;OverlayReader /&gt;
343:       &lt;/KeyboardNavProvider&gt;,
344:     );
345:     expect(screen.getByTestId(&apos;overlay&apos;).textContent).toBe(&apos;closed&apos;);
346:     act(() =&gt; {
347:       fireEvent.keyDown(document, { key: &apos;?&apos; });
348:     });
349:     expect(screen.getByTestId(&apos;overlay&apos;).textContent).toBe(&apos;open&apos;);
350:   });
351: });</file><file path="src/__tests__/p1-explainability.test.tsx">  1: import { describe, it, expect, afterEach, vi } from &apos;vitest&apos;;
  2: import { render, screen, cleanup } from &apos;@testing-library/react&apos;;
  3: import { ScoreBadge } from &apos;../components/ScoreBadge.js&apos;;
  4: import { ChainOfThoughtPanel } from &apos;../components/ChainOfThoughtPanel.js&apos;;
  5: import { AlertList } from &apos;../components/AlertList.js&apos;;
  6: import type { TriggeredAlert } from &apos;../types.js&apos;;
  7: 
  8: afterEach(cleanup);
  9: 
 10: // ---------------------------------------------------------------------------
 11: // ScoreBadge tooltip (Feature 3)
 12: // ---------------------------------------------------------------------------
 13: 
 14: describe(&apos;ScoreBadge tooltip&apos;, () =&gt; {
 15:   it(&apos;renders tooltip content when tooltip props provided&apos;, () =&gt; {
 16:     const { container } = render(
 17:       &lt;ScoreBadge
 18:         score={0.85}
 19:         metricName=&quot;relevance&quot;
 20:         evaluator=&quot;gpt-4o&quot;
 21:         evaluatorType=&quot;llm&quot;
 22:         explanation=&quot;This response is highly relevant to the query.&quot;
 23:         traceId=&quot;trace-abc-123&quot;
 24:       /&gt;
 25:     );
 26:     const wrapper = container.querySelector(&apos;.score-badge-wrapper&apos;);
 27:     expect(wrapper).toBeInTheDocument();
 28:     const tooltip = container.querySelector(&apos;.score-badge-tooltip&apos;);
 29:     expect(tooltip).toBeInTheDocument();
 30:     expect(tooltip!.textContent).toContain(&apos;gpt-4o&apos;);
 31:     expect(tooltip!.textContent).toContain(&apos;llm&apos;);
 32:     expect(tooltip!.textContent).toContain(&apos;This response is highly relevant&apos;);
 33:   });
 34: 
 35:   it(&apos;does not render tooltip without tooltip props&apos;, () =&gt; {
 36:     const { container } = render(
 37:       &lt;ScoreBadge score={0.85} metricName=&quot;relevance&quot; /&gt;
 38:     );
 39:     expect(container.querySelector(&apos;.score-badge-wrapper&apos;)).not.toBeInTheDocument();
 40:     expect(container.querySelector(&apos;.score-badge-tooltip&apos;)).not.toBeInTheDocument();
 41:   });
 42: 
 43:   it(&apos;renders &quot;View full explanation&quot; link with traceId&apos;, () =&gt; {
 44:     const { container } = render(
 45:       &lt;ScoreBadge
 46:         score={0.85}
 47:         metricName=&quot;relevance&quot;
 48:         traceId=&quot;trace-abc-123&quot;
 49:       /&gt;
 50:     );
 51:     const link = container.querySelector(&apos;.tooltip-link&apos;);
 52:     expect(link).toBeInTheDocument();
 53:     expect(link!.getAttribute(&apos;href&apos;)).toBe(&apos;/evaluations/trace/trace-abc-123&apos;);
 54:   });
 55: });
 56: 
 57: // ---------------------------------------------------------------------------
 58: // ChainOfThoughtPanel (Feature 2)
 59: // ---------------------------------------------------------------------------
 60: 
 61: describe(&apos;ChainOfThoughtPanel&apos;, () =&gt; {
 62:   it(&apos;renders explanation in details element&apos;, () =&gt; {
 63:     const { container } = render(
 64:       &lt;ChainOfThoughtPanel explanation=&quot;The model output is coherent and well-structured.&quot; /&gt;
 65:     );
 66:     const details = container.querySelector(&apos;details&apos;);
 67:     expect(details).toBeInTheDocument();
 68:     expect(details!.hasAttribute(&apos;open&apos;)).toBe(true);
 69:     expect(details!.textContent).toContain(&apos;The model output is coherent&apos;);
 70:   });
 71: 
 72:   it(&apos;renders evaluator inline without expandable config&apos;, () =&gt; {
 73:     const { container } = render(
 74:       &lt;ChainOfThoughtPanel
 75:         evaluator=&quot;claude-3.5-sonnet&quot;
 76:         evaluatorType=&quot;llm&quot;
 77:         scoreUnit=&quot;ratio_0_1&quot;
 78:       /&gt;
 79:     );
 80:     expect(container.querySelectorAll(&apos;details&apos;).length).toBe(0);
 81:     expect(container.textContent).toContain(&apos;claude-3.5-sonnet&apos;);
 82:   });
 83: 
 84:   it(&apos;renders fallback when no data available&apos;, () =&gt; {
 85:     const { container } = render(&lt;ChainOfThoughtPanel /&gt;);
 86:     expect(container.textContent).toContain(&apos;No chain-of-thought data available&apos;);
 87:   });
 88: });
 89: 
 90: // ---------------------------------------------------------------------------
 91: // AlertList compound alerts (Feature 4)
 92: // ---------------------------------------------------------------------------
 93: 
 94: describe(&apos;AlertList compound alerts&apos;, () =&gt; {
 95:   function makeAlerts(): (TriggeredAlert &amp; { metricName: string })[] {
 96:     return [
 97:       {
 98:         severity: &apos;warning&apos;,
 99:         message: &apos;Relevance score below threshold&apos;,
100:         aggregation: &apos;avg&apos;,
101:         threshold: 0.7,
102:         actualValue: 0.65,
103:         direction: &apos;below&apos;,
104:         remediationHints: [&apos;Check prompt quality&apos;],
105:         metricName: &apos;relevance&apos;,
106:       },
107:       {
108:         severity: &apos;critical&apos;,
109:         message: &apos;Content quality crisis detected&apos;,
110:         aggregation: &apos;avg&apos;,
111:         threshold: 0.5,
112:         actualValue: 0.35,
113:         direction: &apos;below&apos;,
114:         isCompound: true,
115:         remediationHints: [
116:           &apos;Review prompt templates&apos;,
117:           &apos;Check model configuration&apos;,
118:           &apos;Audit training data&apos;,
119:         ],
120:         relatedMetrics: [&apos;relevance&apos;, &apos;hallucination&apos;, &apos;coherence&apos;],
121:         metricName: &apos;content_quality_crisis&apos;,
122:       },
123:     ];
124:   }
125: 
126:   it(&apos;renders compound alert with full remediation hints&apos;, () =&gt; {
127:     const { container } = render(&lt;AlertList alerts={makeAlerts()} /&gt;);
128:     const compoundCard = container.querySelector(&apos;.alert-compound&apos;);
129:     expect(compoundCard).toBeInTheDocument();
130:     expect(compoundCard!.textContent).toContain(&apos;Review prompt templates&apos;);
131:     expect(compoundCard!.textContent).toContain(&apos;Check model configuration&apos;);
132:     expect(compoundCard!.textContent).toContain(&apos;Audit training data&apos;);
133:   });
134: 
135:   it(&apos;renders related metric links for compound alerts&apos;, () =&gt; {
136:     const { container } = render(&lt;AlertList alerts={makeAlerts()} /&gt;);
137:     const links = container.querySelectorAll(&apos;.alert-metric-link&apos;);
138:     expect(links.length).toBe(3);
139:     expect(links[0].getAttribute(&apos;href&apos;)).toBe(&apos;/metrics/relevance&apos;);
140:     expect(links[1].getAttribute(&apos;href&apos;)).toBe(&apos;/metrics/hallucination&apos;);
141:     expect(links[2].getAttribute(&apos;href&apos;)).toBe(&apos;/metrics/coherence&apos;);
142:   });
143: 
144:   it(&apos;renders threshold bar for compound alerts&apos;, () =&gt; {
145:     const { container } = render(&lt;AlertList alerts={makeAlerts()} /&gt;);
146:     const bar = container.querySelector(&apos;.threshold-bar&apos;);
147:     expect(bar).toBeInTheDocument();
148:   });
149: 
150:   it(&apos;renders simple alerts without compound styling&apos;, () =&gt; {
151:     const { container } = render(&lt;AlertList alerts={makeAlerts()} /&gt;);
152:     const items = container.querySelectorAll(&apos;.alert-item&apos;);
153:     expect(items.length).toBe(2);
154:     const simpleItem = Array.from(items).find(el =&gt; !el.classList.contains(&apos;alert-compound&apos;));
155:     expect(simpleItem).toBeInTheDocument();
156:     expect(simpleItem!.textContent).toContain(&apos;Relevance score below threshold&apos;);
157:   });
158: });
159: 
160: // ---------------------------------------------------------------------------
161: // EvaluationDetailPage (Feature 2) - basic render with mocked hook
162: // ---------------------------------------------------------------------------
163: 
164: vi.mock(&apos;../hooks/useTraceEvaluations.js&apos;, () =&gt; ({
165:   useTraceEvaluations: vi.fn(),
166: }));
167: 
168: const mockEvalData = [
169:   {
170:     timestamp: &apos;2026-02-17T12:00:00Z&apos;,
171:     evaluationName: &apos;relevance&apos;,
172:     scoreValue: 0.92,
173:     scoreLabel: &apos;excellent&apos;,
174:     explanation: &apos;Highly relevant response&apos;,
175:     evaluator: &apos;gpt-4o&apos;,
176:     evaluatorType: &apos;llm&apos; as const,
177:     traceId: &apos;trace-123&apos;,
178:   },
179:   {
180:     timestamp: &apos;2026-02-17T12:00:00Z&apos;,
181:     evaluationName: &apos;coherence&apos;,
182:     scoreValue: 0.78,
183:     scoreLabel: &apos;good&apos;,
184:     explanation: &apos;Mostly coherent&apos;,
185:     evaluator: &apos;gpt-4o&apos;,
186:     evaluatorType: &apos;llm&apos; as const,
187:     traceId: &apos;trace-123&apos;,
188:   },
189: ];
190: 
191: describe(&apos;EvaluationDetailPage&apos;, () =&gt; {
192:   const originalSearch = window.location.search;
193:   afterEach(() =&gt; {
194:     Object.defineProperty(window, &apos;location&apos;, {
195:       value: { ...window.location, search: originalSearch },
196:       writable: true,
197:     });
198:   });
199: 
200:   it(&apos;renders evaluation cards when data is available&apos;, async () =&gt; {
201:     const { useTraceEvaluations } = await import(&apos;../hooks/useTraceEvaluations.js&apos;);
202:     // @ts-expect-error -- partial mock: only fields consumed by component
203:     vi.mocked(useTraceEvaluations).mockReturnValue({
204:       data: mockEvalData,
205:       isLoading: false,
206:       error: null,
207:     });
208: 
209:     const { EvaluationDetailPage } = await import(&apos;../pages/EvaluationDetailPage.js&apos;);
210:     const { container } = render(&lt;EvaluationDetailPage traceId=&quot;trace-123&quot; /&gt;);
211: 
212:     expect(container.textContent).toContain(&apos;Trace Evaluations&apos;);
213:     expect(container.textContent).toContain(&apos;trace-123&apos;);
214:     expect(container.textContent).toContain(&apos;relevance&apos;);
215:     expect(container.textContent).toContain(&apos;coherence&apos;);
216:     const cards = container.querySelectorAll(&apos;.eval-detail-card&apos;);
217:     expect(cards.length).toBe(2);
218:   });
219: 
220:   it(&apos;filters by metric query param&apos;, async () =&gt; {
221:     Object.defineProperty(window, &apos;location&apos;, {
222:       value: { ...window.location, search: &apos;?metric=relevance&apos; },
223:       writable: true,
224:     });
225: 
226:     const { useTraceEvaluations } = await import(&apos;../hooks/useTraceEvaluations.js&apos;);
227:     // @ts-expect-error -- partial mock: only fields consumed by component
228:     vi.mocked(useTraceEvaluations).mockReturnValue({
229:       data: mockEvalData,
230:       isLoading: false,
231:       error: null,
232:     });
233: 
234:     const { EvaluationDetailPage } = await import(&apos;../pages/EvaluationDetailPage.js&apos;);
235:     const { container } = render(&lt;EvaluationDetailPage traceId=&quot;trace-123&quot; /&gt;);
236: 
237:     expect(container.textContent).toContain(&apos;relevance Evaluations&apos;);
238:     expect(container.textContent).toContain(&apos;View all evaluations&apos;);
239:     const cards = container.querySelectorAll(&apos;.eval-detail-card&apos;);
240:     expect(cards.length).toBe(1);
241:   });
242: 
243:   it(&apos;renders loading state&apos;, async () =&gt; {
244:     const { useTraceEvaluations } = await import(&apos;../hooks/useTraceEvaluations.js&apos;);
245:     // @ts-expect-error -- partial mock: only fields consumed by component
246:     vi.mocked(useTraceEvaluations).mockReturnValue({
247:       data: undefined,
248:       isLoading: true,
249:       error: null,
250:     });
251: 
252:     const { EvaluationDetailPage } = await import(&apos;../pages/EvaluationDetailPage.js&apos;);
253:     const { container } = render(&lt;EvaluationDetailPage traceId=&quot;trace-123&quot; /&gt;);
254:     expect(container.querySelector(&apos;.skeleton&apos;)).toBeInTheDocument();
255:   });
256: 
257:   it(&apos;renders empty state when no evaluations&apos;, async () =&gt; {
258:     const { useTraceEvaluations } = await import(&apos;../hooks/useTraceEvaluations.js&apos;);
259:     // @ts-expect-error -- partial mock: only fields consumed by component
260:     vi.mocked(useTraceEvaluations).mockReturnValue({
261:       data: [],
262:       isLoading: false,
263:       error: null,
264:     });
265: 
266:     const { EvaluationDetailPage } = await import(&apos;../pages/EvaluationDetailPage.js&apos;);
267:     const { container } = render(&lt;EvaluationDetailPage traceId=&quot;trace-123&quot; /&gt;);
268:     expect(container.textContent).toContain(&apos;No Evaluations Found&apos;);
269:     expect(container.textContent).toContain(&apos;may not have been synced yet&apos;);
270:   });
271: });</file><file path="src/api/routes/metrics.ts">  1: import { Hono } from &apos;hono&apos;;
  2: import { z } from &apos;zod&apos;;
  3: import {
  4:   computeMetricDetail,
  5:   computeAggregations,
  6:   getQualityMetric,
  7: } from &apos;../../../../dist/lib/quality-metrics.js&apos;;
  8: import { computeMetricDynamics } from &apos;../../../../dist/lib/quality-feature-engineering.js&apos;;
  9: import { sanitizeErrorForResponse } from &apos;../../../../dist/lib/error-sanitizer.js&apos;;
 10: import { loadEvaluationsForMetric } from &apos;../data-loader.js&apos;;
 11: 
 12: const PeriodSchema = z.enum([&apos;24h&apos;, &apos;7d&apos;, &apos;30d&apos;]).default(&apos;7d&apos;);
 13: const TopNSchema = z.coerce.number().int().min(1).max(50).default(5);
 14: const BucketCountSchema = z.coerce.number().int().min(2).max(20).default(10);
 15: const LimitSchema = z.coerce.number().int().min(1).max(200).default(50);
 16: const OffsetSchema = z.coerce.number().int().min(0).default(0);
 17: const SortBySchema = z.enum([&apos;score_asc&apos;, &apos;score_desc&apos;, &apos;timestamp_desc&apos;]).default(&apos;timestamp_desc&apos;);
 18: const ScoreLabelSchema = z.string().max(100).optional();
 19: 
 20: const PERIOD_MS: Record&lt;string, number&gt; = {
 21:   &apos;24h&apos;: 24 * 60 * 60 * 1000,
 22:   &apos;7d&apos;: 7 * 24 * 60 * 60 * 1000,
 23:   &apos;30d&apos;: 30 * 24 * 60 * 60 * 1000,
 24: };
 25: 
 26: export const metricsRoutes = new Hono();
 27: 
 28: metricsRoutes.get(&apos;/metrics/:name&apos;, async (c) =&gt; {
 29:   const name = c.req.param(&apos;name&apos;);
 30:   const config = getQualityMetric(name);
 31:   if (!config) {
 32:     return c.json({ error: `Unknown metric: ${name}` }, 404);
 33:   }
 34: 
 35:   const periodResult = PeriodSchema.safeParse(c.req.query(&apos;period&apos;));
 36:   if (!periodResult.success) {
 37:     return c.json({ error: &apos;Invalid period. Must be 24h, 7d, or 30d.&apos; }, 400);
 38:   }
 39:   const topNResult = TopNSchema.safeParse(c.req.query(&apos;topN&apos;));
 40:   if (!topNResult.success) {
 41:     return c.json({ error: &apos;Invalid topN parameter. Must be integer 1-50.&apos; }, 400);
 42:   }
 43:   const bucketResult = BucketCountSchema.safeParse(c.req.query(&apos;bucketCount&apos;));
 44:   if (!bucketResult.success) {
 45:     return c.json({ error: &apos;Invalid bucketCount parameter. Must be integer 2-20.&apos; }, 400);
 46:   }
 47: 
 48:   try {
 49:     const now = new Date();
 50:     const periodMs = PERIOD_MS[periodResult.data] ?? PERIOD_MS[&apos;7d&apos;];
 51:     const start = new Date(now.getTime() - periodMs);
 52:     const prevStart = new Date(start.getTime() - periodMs);
 53: 
 54:     const [evaluations, prevEvaluations] = await Promise.all([
 55:       loadEvaluationsForMetric(name, start.toISOString(), now.toISOString()),
 56:       loadEvaluationsForMetric(name, prevStart.toISOString(), start.toISOString()),
 57:     ]);
 58: 
 59:     // Compute previous-period aggregations for trend calculation
 60:     const previousValues = prevEvaluations.length &gt; 0
 61:       ? computeAggregations(
 62:           prevEvaluations
 63:             .map(e =&gt; e.scoreValue)
 64:             .filter((v): v is number =&gt; v != null &amp;&amp; Number.isFinite(v)),
 65:           config.aggregations,
 66:         )
 67:       : undefined;
 68: 
 69:     const detail = computeMetricDetail(evaluations, config, {
 70:       topN: topNResult.data,
 71:       bucketCount: bucketResult.data,
 72:       previousValues,
 73:     });
 74: 
 75:     let dynamics = undefined;
 76:     if (detail.trend) {
 77:       dynamics = computeMetricDynamics(
 78:         detail.trend,
 79:         undefined,
 80:         periodResult.data === &apos;24h&apos; ? 1 : 24,
 81:       );
 82:     }
 83: 
 84:     return c.json({ ...detail, dynamics });
 85:   } catch (err) {
 86:     return c.json({ error: sanitizeErrorForResponse(err) }, 500);
 87:   }
 88: });
 89: 
 90: metricsRoutes.get(&apos;/metrics/:name/evaluations&apos;, async (c) =&gt; {
 91:   const name = c.req.param(&apos;name&apos;);
 92:   const config = getQualityMetric(name);
 93:   if (!config) {
 94:     return c.json({ error: `Unknown metric: ${name}` }, 404);
 95:   }
 96: 
 97:   const periodResult = PeriodSchema.safeParse(c.req.query(&apos;period&apos;));
 98:   if (!periodResult.success) {
 99:     return c.json({ error: &apos;Invalid period. Must be 24h, 7d, or 30d.&apos; }, 400);
100:   }
101:   const limitResult = LimitSchema.safeParse(c.req.query(&apos;limit&apos;));
102:   if (!limitResult.success) {
103:     return c.json({ error: &apos;Invalid limit. Must be integer 1-200.&apos; }, 400);
104:   }
105:   const offsetResult = OffsetSchema.safeParse(c.req.query(&apos;offset&apos;));
106:   if (!offsetResult.success) {
107:     return c.json({ error: &apos;Invalid offset. Must be non-negative integer.&apos; }, 400);
108:   }
109:   const sortByResult = SortBySchema.safeParse(c.req.query(&apos;sortBy&apos;));
110:   if (!sortByResult.success) {
111:     return c.json({ error: &apos;Invalid sortBy. Must be score_asc, score_desc, or timestamp_desc.&apos; }, 400);
112:   }
113:   const scoreLabelResult = ScoreLabelSchema.safeParse(c.req.query(&apos;scoreLabel&apos;) || undefined);
114:   if (!scoreLabelResult.success) {
115:     return c.json({ error: &apos;Invalid scoreLabel. Max 100 characters.&apos; }, 400);
116:   }
117:   const scoreLabel = scoreLabelResult.data;
118: 
119:   try {
120:     const now = new Date();
121:     const periodMs = PERIOD_MS[periodResult.data] ?? PERIOD_MS[&apos;7d&apos;];
122:     const start = new Date(now.getTime() - periodMs);
123: 
124:     let evaluations = await loadEvaluationsForMetric(name, start.toISOString(), now.toISOString());
125: 
126:     if (scoreLabel) {
127:       evaluations = evaluations.filter(e =&gt; e.scoreLabel === scoreLabel);
128:     }
129: 
130:     const sortBy = sortByResult.data;
131:     evaluations.sort((a, b) =&gt; {
132:       if (sortBy === &apos;score_asc&apos; || sortBy === &apos;score_desc&apos;) {
133:         const aVal = a.scoreValue ?? null;
134:         const bVal = b.scoreValue ?? null;
135:         if (aVal === null &amp;&amp; bVal === null) return 0;
136:         if (aVal === null) return 1;
137:         if (bVal === null) return -1;
138:         return sortBy === &apos;score_asc&apos; ? aVal - bVal : bVal - aVal;
139:       }
140:       return b.timestamp.localeCompare(a.timestamp);
141:     });
142: 
143:     const total = evaluations.length;
144:     const limit = limitResult.data;
145:     const offset = offsetResult.data;
146:     const page = evaluations.slice(offset, offset + limit);
147: 
148:     const rows = page.map(e =&gt; ({
149:       score: e.scoreValue ?? 0,
150:       explanation: e.explanation,
151:       traceId: e.traceId,
152:       timestamp: e.timestamp,
153:       evaluator: e.evaluator,
154:       label: e.scoreLabel,
155:       evaluatorType: e.evaluatorType,
156:       spanId: e.spanId,
157:       sessionId: e.sessionId,
158:       agentName: e.agentName,
159:       trajectoryLength: e.trajectoryLength,
160:       stepScores: e.stepScores,
161:       toolVerifications: e.toolVerifications,
162:     }));
163: 
164:     return c.json({ rows, total, limit, offset, hasMore: offset + limit &lt; total });
165:   } catch (err) {
166:     return c.json({ error: sanitizeErrorForResponse(err) }, 500);
167:   }
168: });</file><file path="src/components/AlertList.tsx">  1: import { Link } from &apos;wouter&apos;;
  2: import type { TriggeredAlert } from &apos;../types.js&apos;;
  3: 
  4: type AlertWithMeta = TriggeredAlert &amp; { metricName?: string };
  5: 
  6: function SimpleAlertItem({ alert }: { alert: AlertWithMeta }) {
  7:   return (
  8:     &lt;li className={`alert-item ${alert.severity}`}&gt;
  9:       &lt;div className=&quot;alert-message&quot;&gt;{alert.message}&lt;/div&gt;
 10:       &lt;div className=&quot;alert-meta&quot;&gt;
 11:         {alert.aggregation} = {alert.actualValue?.toFixed(4)} (threshold: {alert.threshold?.toFixed(4)})
 12:       &lt;/div&gt;
 13:       {alert.remediationHints &amp;&amp; alert.remediationHints.length &gt; 0 &amp;&amp; (
 14:         &lt;div className=&quot;remediation&quot;&gt;
 15:           Hint: {alert.remediationHints[0]}
 16:         &lt;/div&gt;
 17:       )}
 18:     &lt;/li&gt;
 19:   );
 20: }
 21: 
 22: function ThresholdBar({ actual, threshold, direction }: {
 23:   actual: number;
 24:   threshold: number;
 25:   direction: &apos;above&apos; | &apos;below&apos;;
 26: }) {
 27:   const max = Math.max(actual, threshold) * 1.2 || 1;
 28:   const actualPct = Math.max(0, Math.min((actual / max) * 100, 100));
 29:   const thresholdPct = Math.max(0, Math.min((threshold / max) * 100, 100));
 30:   const isViolating = direction === &apos;below&apos; ? actual &lt; threshold : actual &gt; threshold;
 31: 
 32:   return (
 33:     &lt;div className=&quot;threshold-bar&quot; aria-label={`Actual: ${actual.toFixed(4)}, Threshold: ${threshold.toFixed(4)}`}&gt;
 34:       &lt;div
 35:         className=&quot;threshold-bar-fill&quot;
 36:         style={{
 37:           width: `${actualPct}%`,
 38:           background: isViolating ? &apos;var(--status-critical)&apos; : &apos;var(--status-healthy)&apos;,
 39:         }}
 40:       /&gt;
 41:       &lt;div
 42:         className=&quot;threshold-bar-marker&quot;
 43:         style={{ left: `${thresholdPct}%` }}
 44:         title={`Threshold: ${threshold.toFixed(4)}`}
 45:       /&gt;
 46:     &lt;/div&gt;
 47:   );
 48: }
 49: 
 50: function CompoundAlertCard({ alert }: { alert: AlertWithMeta }) {
 51:   return (
 52:     &lt;li className={`alert-item alert-compound ${alert.severity}`}&gt;
 53:       &lt;div className=&quot;alert-message&quot;&gt;{alert.message}&lt;/div&gt;
 54:       &lt;div className=&quot;alert-meta&quot;&gt;
 55:         {alert.aggregation} = {alert.actualValue?.toFixed(4)} (threshold: {alert.threshold?.toFixed(4)})
 56:       &lt;/div&gt;
 57: 
 58:       &lt;ThresholdBar
 59:         actual={alert.actualValue}
 60:         threshold={alert.threshold}
 61:         direction={alert.direction}
 62:       /&gt;
 63: 
 64:       {alert.remediationHints &amp;&amp; alert.remediationHints.length &gt; 0 &amp;&amp; (
 65:         &lt;ol className=&quot;remediation-list&quot;&gt;
 66:           {alert.remediationHints.map((hint, i) =&gt; (
 67:             &lt;li key={i}&gt;{hint}&lt;/li&gt;
 68:           ))}
 69:         &lt;/ol&gt;
 70:       )}
 71: 
 72:       {alert.relatedMetrics &amp;&amp; alert.relatedMetrics.length &gt; 0 &amp;&amp; (
 73:         &lt;div className=&quot;alert-related&quot;&gt;
 74:           &lt;span style={{ fontSize: 12, color: &apos;var(--text-secondary)&apos; }}&gt;Related:&lt;/span&gt;
 75:           {alert.relatedMetrics.map((m) =&gt; (
 76:             &lt;Link key={m} href={`/metrics/${m}`} className=&quot;alert-metric-link&quot;&gt;
 77:               {m}
 78:             &lt;/Link&gt;
 79:           ))}
 80:         &lt;/div&gt;
 81:       )}
 82:     &lt;/li&gt;
 83:   );
 84: }
 85: 
 86: export function AlertList({ alerts }: { alerts: AlertWithMeta[] }) {
 87:   if (alerts.length === 0) return null;
 88: 
 89:   const sorted = [...alerts].sort((a, b) =&gt; {
 90:     const order = { critical: 0, warning: 1, info: 2 };
 91:     return (order[a.severity as keyof typeof order] ?? 2) - (order[b.severity as keyof typeof order] ?? 2);
 92:   });
 93: 
 94:   return (
 95:     &lt;ul className=&quot;alert-list&quot;&gt;
 96:       {sorted.map((alert, i) =&gt;
 97:         alert.isCompound
 98:           ? &lt;CompoundAlertCard key={`${alert.message}-${i}`} alert={alert} /&gt;
 99:           : &lt;SimpleAlertItem key={`${alert.message}-${i}`} alert={alert} /&gt;
100:       )}
101:     &lt;/ul&gt;
102:   );
103: }</file><file path="src/components/ChainOfThoughtPanel.tsx"> 1: import { MetaItem } from &apos;./MetaItem.js&apos;;
 2: 
 3: interface ChainOfThoughtPanelProps {
 4:   explanation?: string;
 5:   evaluator?: string;
 6:   evaluatorType?: string;
 7:   scoreUnit?: string;
 8: }
 9: 
10: export function ChainOfThoughtPanel({ explanation, evaluator }: ChainOfThoughtPanelProps) {
11: 
12:   return (
13:     &lt;div className=&quot;cot-panel&quot;&gt;
14:       {explanation &amp;&amp; (
15:         &lt;details open&gt;
16:           &lt;summary className=&quot;cot-summary&quot;&gt;Explanation&lt;/summary&gt;
17:           &lt;div className=&quot;cot-content&quot;&gt;{explanation}&lt;/div&gt;
18:         &lt;/details&gt;
19:       )}
20:       {evaluator &amp;&amp; (
21:         &lt;div className=&quot;cot-content&quot;&gt;
22:           &lt;MetaItem label=&quot;Evaluator&quot; value={evaluator} /&gt;
23:         &lt;/div&gt;
24:       )}
25:       {!explanation &amp;&amp; !evaluator &amp;&amp; (
26:         &lt;div style={{ color: &apos;var(--text-muted)&apos;, fontSize: 13 }}&gt;
27:           No chain-of-thought data available.
28:         &lt;/div&gt;
29:       )}
30:     &lt;/div&gt;
31:   );
32: }</file><file path="src/components/MetricCard.tsx"> 1: import { memo } from &apos;react&apos;;
 2: import { Link } from &apos;wouter&apos;;
 3: import type { QualityMetricResult, WorstExplanation } from &apos;../types.js&apos;;
 4: import { StatusBadge, TrendIndicator, ConfidenceBadge } from &apos;./Indicators.js&apos;;
 5: import { ScoreBadge } from &apos;./ScoreBadge.js&apos;;
 6: import { Sparkline } from &apos;./Sparkline.js&apos;;
 7: import { inferScoreDirection, truncateText } from &apos;../lib/quality-utils.js&apos;;
 8: 
 9: function formatValue(val: number | null | undefined): string {
10:   if (val === null || val === undefined) return &apos;N/A&apos;;
11:   return val.toFixed(4);
12: }
13: 
14: function MetricCardInner({ metric, sparklineData }: {
15:   metric: QualityMetricResult;
16:   sparklineData?: (number | null)[];
17: }) {
18:   const { name, displayName, sampleCount, status, values, trend, confidence, alerts } = metric;
19:   const worst = (metric as QualityMetricResult &amp; { worstExplanation?: WorstExplanation }).worstExplanation;
20:   const primaryValue = values.avg;
21:   const glowClass = status === &apos;critical&apos; ? &apos;glow-critical&apos; : status === &apos;warning&apos; ? &apos;glow-warning&apos; : &apos;&apos;;
22: 
23:   return (
24:     &lt;Link href={`/metrics/${name}`} className=&quot;card-link&quot; aria-label={`View ${displayName} metric details`}&gt;
25:       &lt;div className={`card ${glowClass}`}&gt;
26:         &lt;div className=&quot;metric-card-header&quot;&gt;
27:           &lt;h3&gt;{displayName}&lt;/h3&gt;
28:           &lt;StatusBadge status={status} /&gt;
29:         &lt;/div&gt;
30:         &lt;div className=&quot;metric-values&quot;&gt;
31:           &lt;div className=&quot;primary&quot;&gt;
32:             &lt;ScoreBadge
33:               score={primaryValue ?? null}
34:               metricName={name}
35:               direction={inferScoreDirection(alerts?.[0]?.direction)}
36:               label={formatValue(primaryValue)}
37:             /&gt;
38:             {trend &amp;&amp; &lt;&gt; &lt;TrendIndicator trend={trend} /&gt;&lt;/&gt;}
39:           &lt;/div&gt;
40:           &lt;div className=&quot;secondary&quot;&gt;
41:             p50: {formatValue(values.p50)} &amp;middot; p95: {formatValue(values.p95)}
42:           &lt;/div&gt;
43:         &lt;/div&gt;
44: 
45:         {sparklineData &amp;&amp; sparklineData.length &gt;= 2 &amp;&amp; (
46:           &lt;div style={{ marginTop: 8 }}&gt;
47:             &lt;Sparkline
48:               data={sparklineData}
49:               width={120}
50:               height={24}
51:               color={status === &apos;critical&apos; ? &apos;var(--status-critical)&apos; : status === &apos;warning&apos; ? &apos;var(--status-warning)&apos; : &apos;var(--accent)&apos;}
52:               label={`${displayName} score trend`}
53:             /&gt;
54:           &lt;/div&gt;
55:         )}
56: 
57:         &lt;div className=&quot;metric-footer&quot;&gt;
58:           &lt;span&gt;n={sampleCount} &lt;ConfidenceBadge confidence={confidence} /&gt;&lt;/span&gt;
59:           {alerts.length &gt; 0 &amp;&amp; (
60:             &lt;span style={{ color: &apos;var(--status-warning)&apos; }}&gt;
61:               {&apos;\u25B2&apos;} {alerts.length} alert{alerts.length &gt; 1 ? &apos;s&apos; : &apos;&apos;}
62:             &lt;/span&gt;
63:           )}
64:         &lt;/div&gt;
65: 
66:         {worst &amp;&amp; worst.explanation &amp;&amp; (
67:           &lt;div className=&quot;metric-worst&quot; title={worst.explanation}&gt;
68:             &lt;span className=&quot;worst-score&quot;&gt;{worst.score.toFixed(2)}&lt;/span&gt;{&apos; &apos;}
69:             {truncateText(worst.explanation, 60)}
70:           &lt;/div&gt;
71:         )}
72:       &lt;/div&gt;
73:     &lt;/Link&gt;
74:   );
75: }
76: 
77: export const MetricCard = memo(MetricCardInner);</file><file path="src/components/ScoreBadge.tsx">  1: import { Link } from &apos;wouter&apos;;
  2: import { scoreColorBand, truncateText, SCORE_COLORS, type ScoreColorBand, type ScoreDirection } from &apos;../lib/quality-utils.js&apos;;
  3: 
  4: interface ScoreBadgeProps {
  5:   score: number | null;
  6:   metricName: string;
  7:   direction?: ScoreDirection;
  8:   label?: string;
  9:   evaluator?: string;
 10:   evaluatorType?: string;
 11:   explanation?: string;
 12:   traceId?: string;
 13: }
 14: 
 15: const SCORE_SHAPES: Record&lt;ScoreColorBand | &apos;no_data&apos;, string&gt; = {
 16:   excellent: &apos;\u25CF&apos;,  // ●
 17:   good: &apos;\u25CF&apos;,       // ●
 18:   adequate: &apos;\u25B2&apos;,   // ▲
 19:   poor: &apos;\u25A0&apos;,       // ■
 20:   failing: &apos;\u25A0&apos;,    // ■
 21:   no_data: &apos;\u25CB&apos;,    // ○
 22: };
 23: 
 24: function Tooltip({ score, label, evaluator, evaluatorType, explanation, traceId }: {
 25:   score: number;
 26:   label?: string;
 27:   evaluator?: string;
 28:   evaluatorType?: string;
 29:   explanation?: string;
 30:   traceId?: string;
 31: }) {
 32:   return (
 33:     &lt;div className=&quot;score-badge-tooltip&quot; role=&quot;tooltip&quot;&gt;
 34:       &lt;div className=&quot;tooltip-row&quot;&gt;
 35:         &lt;span&gt;Score&lt;/span&gt;
 36:         &lt;span style={{ fontFamily: &apos;var(--font-mono)&apos; }}&gt;{score.toFixed(4)}&lt;/span&gt;
 37:       &lt;/div&gt;
 38:       {label &amp;&amp; (
 39:         &lt;div className=&quot;tooltip-row&quot;&gt;
 40:           &lt;span&gt;Label&lt;/span&gt;
 41:           &lt;span&gt;{label}&lt;/span&gt;
 42:         &lt;/div&gt;
 43:       )}
 44:       {evaluator &amp;&amp; (
 45:         &lt;div className=&quot;tooltip-row&quot;&gt;
 46:           &lt;span&gt;Evaluator&lt;/span&gt;
 47:           &lt;span style={{ fontFamily: &apos;var(--font-mono)&apos;, fontSize: 11 }}&gt;{evaluator}&lt;/span&gt;
 48:         &lt;/div&gt;
 49:       )}
 50:       {evaluatorType &amp;&amp; (
 51:         &lt;div className=&quot;tooltip-row&quot;&gt;
 52:           &lt;span&gt;Type&lt;/span&gt;
 53:           &lt;span&gt;{evaluatorType}&lt;/span&gt;
 54:         &lt;/div&gt;
 55:       )}
 56:       {explanation &amp;&amp; (
 57:         &lt;div className=&quot;tooltip-row&quot; style={{ flexDirection: &apos;column&apos;, gap: 2 }}&gt;
 58:           &lt;span&gt;Explanation&lt;/span&gt;
 59:           &lt;span style={{ color: &apos;var(--text-secondary)&apos;, fontSize: 11 }}&gt;{truncateText(explanation, 120)}&lt;/span&gt;
 60:         &lt;/div&gt;
 61:       )}
 62:       {traceId &amp;&amp; (
 63:         &lt;Link href={`/evaluations/trace/${traceId}`} className=&quot;tooltip-link&quot;&gt;
 64:           View full explanation &amp;rarr;
 65:         &lt;/Link&gt;
 66:       )}
 67:     &lt;/div&gt;
 68:   );
 69: }
 70: 
 71: export function ScoreBadge({ score, metricName, direction = &apos;maximize&apos;, label, evaluator, evaluatorType, explanation, traceId }: ScoreBadgeProps) {
 72:   const hasTooltip = evaluator || evaluatorType || explanation || traceId;
 73: 
 74:   if (score === null) {
 75:     return (
 76:       &lt;span
 77:         style={{ display: &apos;inline-flex&apos;, alignItems: &apos;center&apos;, gap: &apos;4px&apos;, color: SCORE_COLORS.no_data }}
 78:         aria-label={`${metricName}: no data`}
 79:       &gt;
 80:         {SCORE_SHAPES.no_data} {label ?? &apos;N/A&apos;}
 81:       &lt;/span&gt;
 82:     );
 83:   }
 84: 
 85:   const band = scoreColorBand(score, direction);
 86:   const color = SCORE_COLORS[band];
 87:   const shape = SCORE_SHAPES[band];
 88:   const directionHint = direction === &apos;minimize&apos; ? &apos;lower is better&apos; : &apos;higher is better&apos;;
 89: 
 90:   const badge = (
 91:     &lt;span
 92:       style={{ display: &apos;inline-flex&apos;, alignItems: &apos;center&apos;, gap: &apos;4px&apos;, color }}
 93:       aria-label={`Score: ${score}, ${band} (${directionHint})`}
 94:     &gt;
 95:       {shape} {label ?? score.toFixed(2)}
 96:     &lt;/span&gt;
 97:   );
 98: 
 99:   if (!hasTooltip) return badge;
100: 
101:   return (
102:     &lt;span className=&quot;score-badge-wrapper&quot; tabIndex={0}&gt;
103:       {badge}
104:       &lt;Tooltip
105:         score={score}
106:         label={label}
107:         evaluator={evaluator}
108:         evaluatorType={evaluatorType}
109:         explanation={explanation}
110:         traceId={traceId}
111:       /&gt;
112:     &lt;/span&gt;
113:   );
114: }</file><file path="src/hooks/useAgentStats.ts"> 1: import { useQuery } from &apos;@tanstack/react-query&apos;;
 2: import type { Period } from &apos;../types.js&apos;;
 3: 
 4: const API_BASE = import.meta.env.VITE_API_URL ?? (import.meta.env.DEV ? &apos;http://localhost:3001&apos; : &apos;&apos;);
 5: 
 6: export interface EvalMetricSummary {
 7:   avg: number;
 8:   min: number;
 9:   max: number;
10:   count: number;
11: }
12: 
13: export interface AgentStat {
14:   agentName: string;
15:   invocations: number;
16:   errors: number;
17:   errorRate: number;
18:   rateLimitCount: number;
19:   avgOutputSize: number;
20:   sessionCount: number;
21:   sessionIds: string[];
22:   sessionIdsTruncated: boolean;
23:   traceIdsTotal?: number;
24:   traceIds: string[];
25:   traceIdsTruncated: boolean;
26:   sourceTypes: Record&lt;string, number&gt;;
27:   dailyCounts: number[];
28:   evalSummary: Record&lt;string, EvalMetricSummary&gt;;
29: }
30: 
31: interface AgentStatsResponse {
32:   period: string;
33:   startDate: string;
34:   endDate: string;
35:   agents: AgentStat[];
36: }
37: 
38: /** Shallow shape check — validates envelope fields only, not individual AgentStat elements. */
39: function assertAgentStatsResponse(data: unknown): asserts data is AgentStatsResponse {
40:   if (!data || typeof data !== &apos;object&apos;) throw new Error(&apos;Invalid response shape&apos;);
41:   const obj = data as Record&lt;string, unknown&gt;;
42:   if (typeof obj.period !== &apos;string&apos; || !Array.isArray(obj.agents)) {
43:     throw new Error(&apos;Invalid response: missing period or agents&apos;);
44:   }
45: }
46: 
47: export function useAgentStats(period: Period) {
48:   return useQuery&lt;AgentStatsResponse&gt;({
49:     queryKey: [&apos;agent-stats&apos;, period],
50:     queryFn: async () =&gt; {
51:       const res = await fetch(`${API_BASE}/api/agents?period=${encodeURIComponent(period)}`);
52:       if (!res.ok) throw new Error(`API error: ${res.status}`);
53:       const data: unknown = await res.json();
54:       assertAgentStatsResponse(data);
55:       return data;
56:     },
57:     staleTime: 60_000,
58:     retry: 2,
59:   });
60: }</file><file path="src/hooks/useTraceEvaluations.ts"> 1: import { useQuery } from &apos;@tanstack/react-query&apos;;
 2: import type { EvaluationResult } from &apos;../types.js&apos;;
 3: 
 4: const API_BASE = import.meta.env.VITE_API_URL ?? (import.meta.env.DEV ? &apos;http://localhost:3001&apos; : &apos;&apos;);
 5: 
 6: export function useTraceEvaluations(traceId: string | undefined) {
 7:   return useQuery&lt;EvaluationResult[]&gt;({
 8:     queryKey: [&apos;trace-evaluations&apos;, traceId],
 9:     queryFn: async () =&gt; {
10:       const res = await fetch(`${API_BASE}/api/evaluations/trace/${encodeURIComponent(traceId!)}`);
11:       if (!res.ok) throw new Error(`API error: ${res.status}`);
12:       // Worker returns 200 with { evaluations: [] } when key not in KV (not yet synced)
13:       const data = await res.json();
14:       return (data.evaluations ?? []) as EvaluationResult[];
15:     },
16:     enabled: !!traceId,
17:     staleTime: 25_000,
18:     retry: 2,
19:   });
20: }</file><file path="src/pages/CorrelationsPage.tsx"> 1: import { useState, useCallback } from &apos;react&apos;;
 2: import { useQuery } from &apos;@tanstack/react-query&apos;;
 3: import { Link } from &apos;wouter&apos;;
 4: import { CorrelationHeatmap } from &apos;../components/CorrelationHeatmap.js&apos;;
 5: import { SplitPane } from &apos;../components/SplitPane.js&apos;;
 6: import { MetricCompare } from &apos;../components/MetricCompare.js&apos;;
 7: import type { CorrelationFeature, Period } from &apos;../types.js&apos;;
 8: 
 9: const API_BASE = import.meta.env.VITE_API_URL ?? (import.meta.env.DEV ? &apos;http://localhost:3001&apos; : &apos;&apos;);
10: 
11: interface CorrelationsResponse {
12:   correlations: CorrelationFeature[];
13:   metrics: string[];
14: }
15: 
16: export function CorrelationsPage({ period = &apos;30d&apos; }: { period?: Period }) {
17:   const { data, isLoading, error } = useQuery&lt;CorrelationsResponse&gt;({
18:     queryKey: [&apos;correlations&apos;, period],
19:     queryFn: async () =&gt; {
20:       const res = await fetch(`${API_BASE}/api/correlations?period=${period}`);
21:       if (!res.ok) throw new Error(`API error: ${res.status}`);
22:       return res.json();
23:     },
24:     staleTime: 60_000,
25:     retry: 2,
26:   });
27: 
28:   const [leftMetric, setLeftMetric] = useState&lt;string | undefined&gt;();
29:   const [rightMetric, setRightMetric] = useState&lt;string | undefined&gt;();
30: 
31:   const handleCellClick = useCallback((row: string, col: string) =&gt; {
32:     setLeftMetric(row);
33:     setRightMetric(col);
34:   }, []);
35: 
36:   if (isLoading) return &lt;div className=&quot;card skeleton&quot; style={{ height: 400 }} /&gt;;
37:   if (error) return &lt;div className=&quot;error-state&quot;&gt;&lt;h2&gt;Failed to load&lt;/h2&gt;&lt;p&gt;{error.message}&lt;/p&gt;&lt;/div&gt;;
38:   if (!data) return null;
39: 
40:   return (
41:     &lt;div&gt;
42:       &lt;Link href=&quot;/&quot; className=&quot;back-link&quot;&gt;&amp;larr; Back to dashboard&lt;/Link&gt;
43:       &lt;h2 style={{ fontSize: 18, marginBottom: 16 }}&gt;Metric Correlations&lt;/h2&gt;
44:       &lt;div className=&quot;card&quot;&gt;
45:         &lt;CorrelationHeatmap
46:           correlations={data.correlations}
47:           metrics={data.metrics}
48:           onCellClick={handleCellClick}
49:         /&gt;
50:       &lt;/div&gt;
51: 
52:       {(leftMetric || rightMetric) &amp;&amp; (
53:         &lt;div className=&quot;view-section&quot;&gt;
54:           &lt;h3 className=&quot;section-heading&quot;&gt;Compare Metrics&lt;/h3&gt;
55:           &lt;div className=&quot;card&quot;&gt;
56:             &lt;SplitPane
57:               left={
58:                 &lt;MetricCompare
59:                   metricName={leftMetric}
60:                   period={period}
61:                   availableMetrics={data.metrics}
62:                   onMetricChange={setLeftMetric}
63:                 /&gt;
64:               }
65:               right={
66:                 &lt;MetricCompare
67:                   metricName={rightMetric}
68:                   period={period}
69:                   availableMetrics={data.metrics}
70:                   onMetricChange={setRightMetric}
71:                 /&gt;
72:               }
73:             /&gt;
74:           &lt;/div&gt;
75:         &lt;/div&gt;
76:       )}
77:     &lt;/div&gt;
78:   );
79: }</file><file path="src/pages/TraceDetailPage.tsx"> 1: import { Link } from &apos;wouter&apos;;
 2: import { useTrace } from &apos;../hooks/useTrace.js&apos;;
 3: import { SpanTree } from &apos;../components/SpanTree.js&apos;;
 4: import { EvaluationEventOverlay } from &apos;../components/EvaluationEventOverlay.js&apos;;
 5: 
 6: export function TraceDetailPage({ traceId }: { traceId: string }) {
 7:   const { data, isLoading, error } = useTrace(traceId);
 8: 
 9:   if (isLoading) {
10:     return (
11:       &lt;div&gt;
12:         &lt;Link href=&quot;/&quot; className=&quot;back-link&quot;&gt;&amp;larr; Back to dashboard&lt;/Link&gt;
13:         &lt;div className=&quot;card skeleton&quot; style={{ height: 300 }} /&gt;
14:       &lt;/div&gt;
15:     );
16:   }
17: 
18:   if (error) {
19:     return (
20:       &lt;div&gt;
21:         &lt;Link href=&quot;/&quot; className=&quot;back-link&quot;&gt;&amp;larr; Back to dashboard&lt;/Link&gt;
22:         &lt;div className=&quot;error-state&quot;&gt;&lt;h2&gt;Failed to load&lt;/h2&gt;&lt;p&gt;{error.message}&lt;/p&gt;&lt;/div&gt;
23:       &lt;/div&gt;
24:     );
25:   }
26: 
27:   if (!data || (data.spans.length === 0 &amp;&amp; data.evaluations.length === 0)) {
28:     return (
29:       &lt;div&gt;
30:         &lt;Link href=&quot;/&quot; className=&quot;back-link&quot;&gt;&amp;larr; Back to dashboard&lt;/Link&gt;
31:         &lt;div className=&quot;empty-state&quot;&gt;
32:           &lt;h2&gt;No Trace Data&lt;/h2&gt;
33:           &lt;p&gt;No spans or evaluations found for trace &lt;code&gt;{traceId}&lt;/code&gt;&lt;/p&gt;
34:           &lt;p style={{ fontSize: 13, color: &apos;var(--text-muted)&apos;, marginTop: 8 }}&gt;
35:             Trace data may not have been synced yet. Try again after the next sync cycle.
36:           &lt;/p&gt;
37:         &lt;/div&gt;
38:       &lt;/div&gt;
39:     );
40:   }
41: 
42:   const evalsBySpan = new Map&lt;string, number&gt;();
43:   for (const ev of data.evaluations) {
44:     if (ev.spanId) {
45:       evalsBySpan.set(ev.spanId, (evalsBySpan.get(ev.spanId) ?? 0) + 1);
46:     }
47:   }
48: 
49:   const maxDuration = data.spans.reduce((max, s) =&gt; Math.max(max, s.durationMs ?? 0), 1);
50: 
51:   return (
52:     &lt;div&gt;
53:       &lt;Link href=&quot;/&quot; className=&quot;back-link&quot;&gt;&amp;larr; Back to dashboard&lt;/Link&gt;
54: 
55:       &lt;div className=&quot;eval-detail-header&quot;&gt;
56:         &lt;h2 style={{ fontSize: 18 }}&gt;Trace Detail&lt;/h2&gt;
57:         &lt;div className=&quot;eval-detail-meta&quot;&gt;
58:           &lt;span style={{ fontFamily: &apos;var(--font-mono)&apos;, fontSize: 12, color: &apos;var(--text-secondary)&apos; }}&gt;
59:             {traceId}
60:           &lt;/span&gt;
61:           &lt;span style={{ fontSize: 13, color: &apos;var(--text-secondary)&apos; }}&gt;
62:             {data.spans.length} span{data.spans.length !== 1 ? &apos;s&apos; : &apos;&apos;} &amp;middot; {data.evaluations.length} evaluation{data.evaluations.length !== 1 ? &apos;s&apos; : &apos;&apos;}
63:           &lt;/span&gt;
64:         &lt;/div&gt;
65:       &lt;/div&gt;
66: 
67:       {data.evaluations.length &gt; 0 &amp;&amp; (
68:         &lt;div className=&quot;view-section&quot;&gt;
69:           &lt;h3 className=&quot;section-heading&quot;&gt;Evaluation Summary&lt;/h3&gt;
70:           &lt;div className=&quot;card&quot; style={{ padding: 16 }}&gt;
71:             &lt;EvaluationEventOverlay evaluations={data.evaluations} traceId={traceId} /&gt;
72:           &lt;/div&gt;
73:         &lt;/div&gt;
74:       )}
75: 
76:       {data.spans.length &gt; 0 &amp;&amp; (
77:         &lt;div className=&quot;view-section&quot;&gt;
78:           &lt;h3 className=&quot;section-heading&quot;&gt;Span Hierarchy&lt;/h3&gt;
79:           &lt;div className=&quot;card&quot;&gt;
80:             &lt;SpanTree spans={data.spans} evalsBySpan={evalsBySpan} maxDuration={maxDuration} /&gt;
81:           &lt;/div&gt;
82:         &lt;/div&gt;
83:       )}
84: 
85:       {data.spans.length === 0 &amp;&amp; data.evaluations.length &gt; 0 &amp;&amp; (
86:         &lt;div className=&quot;view-section&quot;&gt;
87:           &lt;div className=&quot;card&quot; style={{ padding: 16, color: &apos;var(--text-muted)&apos;, fontSize: 13 }}&gt;
88:             Span data not yet available for this trace. Evaluations are shown above.
89:           &lt;/div&gt;
90:         &lt;/div&gt;
91:       )}
92:     &lt;/div&gt;
93:   );
94: }</file><file path="src/types.ts"> 1: export type {
 2:   QualityDashboardSummary,
 3:   QualityMetricResult,
 4:   QualityMetricConfig,
 5:   MetricDetailResult,
 6:   TriggeredAlert,
 7:   MetricTrend,
 8:   ConfidenceIndicator,
 9:   WorstExplanation,
10:   SLAComplianceResult,
11:   ExecutiveView,
12:   OperatorView,
13:   AuditorView,
14:   RoleView,
15:   RoleViewType,
16:   AlertSeverity,
17:   TrendDirection,
18:   PipelineResult,
19:   PipelineStage,
20:   PipelineDropoff,
21:   CoverageHeatmap,
22:   CoverageCell,
23:   CoverageGap,
24:   CoverageStatus,
25: } from &apos;../../dist/lib/quality-metrics.js&apos;;
26: 
27: export type { EvaluationResult, TraceSpan } from &apos;../../dist/backends/index.js&apos;;
28: export type { CompositeQualityIndex, CQIContribution, MetricDynamics, CorrelationFeature } from &apos;../../dist/lib/quality-feature-engineering.js&apos;;
29: export type { HandoffEvaluation, TurnLevelResult, MultiAgentEvaluation } from &apos;../../dist/lib/quality-multi-agent.js&apos;;
30: export type { HumanVerificationEvent } from &apos;../../dist/lib/verification-events.js&apos;;
31: export type { SLAEvaluationResult } from &apos;../../dist/lib/quality-sla.js&apos;;
32: 
33: export type Period = &apos;24h&apos; | &apos;7d&apos; | &apos;30d&apos;;
34: 
35: export type OverallStatus = &apos;healthy&apos; | &apos;warning&apos; | &apos;critical&apos; | &apos;no_data&apos;;</file><file path="src/components/CorrelationHeatmap.tsx">  1: import { scaleSequential } from &apos;d3-scale&apos;;
  2: import { interpolateRdYlGn } from &apos;d3-scale-chromatic&apos;;
  3: import type { CorrelationFeature } from &apos;../types.js&apos;;
  4: 
  5: interface CorrelationHeatmapProps {
  6:   correlations: CorrelationFeature[];
  7:   metrics: string[];
  8:   onCellClick?: (rowMetric: string, colMetric: string) =&gt; void;
  9: }
 10: 
 11: const SHORT_NAMES: Record&lt;string, string&gt; = {
 12:   faithfulness: &apos;Faith&apos;,
 13:   relevance: &apos;Relev&apos;,
 14:   coherence: &apos;Coher&apos;,
 15:   safety: &apos;Safety&apos;,
 16:   instruction_adherence: &apos;Instr&apos;,
 17:   tool_accuracy: &apos;Tool&apos;,
 18:   latency: &apos;Latency&apos;,
 19: };
 20: 
 21: function shortName(metric: string): string {
 22:   return SHORT_NAMES[metric] ?? metric.slice(0, 6);
 23: }
 24: 
 25: /**
 26:  * Returns black or white text for WCAG 4.5:1 contrast against the
 27:  * interpolateRdYlGn background color for a given pearsonR value.
 28:  * Uses relative luminance per WCAG 2.1 contrast ratio formula.
 29:  */
 30: function contrastText(pearsonR: number): string {
 31:   const bg = colorScale(pearsonR);
 32:   // Parse &quot;rgb(r, g, b)&quot; string from d3
 33:   const m = bg.match(/(\d+)/g);
 34:   if (!m || m.length &lt; 3) return &apos;#111&apos;;
 35:   const [r, g, b] = m.map(Number);
 36:   // sRGB relative luminance (WCAG 2.1)
 37:   const toLinear = (c: number) =&gt; {
 38:     const s = c / 255;
 39:     return s &lt;= 0.03928 ? s / 12.92 : ((s + 0.055) / 1.055) ** 2.4;
 40:   };
 41:   const L = 0.2126 * toLinear(r) + 0.7152 * toLinear(g) + 0.0722 * toLinear(b);
 42:   // WCAG contrast ratio: (L1 + 0.05) / (L2 + 0.05)
 43:   // White text (#fff, L=1.0) needs ratio &gt;= 4.5 → L_bg &lt;= ~0.18
 44:   // Black text (#111, L≈0.012) needs ratio &gt;= 4.5 → L_bg &gt;= ~0.10
 45:   return L &gt; 0.18 ? &apos;#111&apos; : &apos;#fff&apos;;
 46: }
 47: 
 48: const colorScale = scaleSequential(interpolateRdYlGn).domain([-1, 1]);
 49: 
 50: function lookupCorrelation(
 51:   correlations: CorrelationFeature[],
 52:   a: string,
 53:   b: string,
 54: ): CorrelationFeature | undefined {
 55:   return correlations.find(
 56:     (c) =&gt; (c.metricA === a &amp;&amp; c.metricB === b) || (c.metricA === b &amp;&amp; c.metricB === a),
 57:   );
 58: }
 59: 
 60: export function CorrelationHeatmap({ correlations, metrics, onCellClick }: CorrelationHeatmapProps) {
 61:   const n = metrics.length;
 62:   const cols = n + 1;
 63: 
 64:   return (
 65:     &lt;div
 66:       role=&quot;table&quot;
 67:       aria-label=&quot;Metric correlation matrix&quot;
 68:       style={{
 69:         display: &apos;grid&apos;,
 70:         gridTemplateColumns: `80px repeat(${n}, 1fr)`,
 71:         gridTemplateRows: `32px repeat(${n}, 1fr)`,
 72:         gap: 2,
 73:         width: &apos;100%&apos;,
 74:         aspectRatio: `${cols} / ${cols}`,
 75:       }}
 76:     &gt;
 77:       {/* Top-left empty corner */}
 78:       &lt;div role=&quot;cell&quot; /&gt;
 79: 
 80:       {/* Column headers */}
 81:       {metrics.map((m) =&gt; (
 82:         &lt;div
 83:           key={`col-${m}`}
 84:           role=&quot;columnheader&quot;
 85:           style={{
 86:             display: &apos;flex&apos;,
 87:             alignItems: &apos;center&apos;,
 88:             justifyContent: &apos;center&apos;,
 89:             fontSize: 11,
 90:             fontWeight: 600,
 91:             color: &apos;var(--text-secondary)&apos;,
 92:             overflow: &apos;hidden&apos;,
 93:             textOverflow: &apos;ellipsis&apos;,
 94:             whiteSpace: &apos;nowrap&apos;,
 95:           }}
 96:         &gt;
 97:           {shortName(m)}
 98:         &lt;/div&gt;
 99:       ))}
100: 
101:       {/* Rows */}
102:       {metrics.map((rowMetric, ri) =&gt; (
103:         &lt;div key={`row-${rowMetric}`} role=&quot;presentation&quot; style={{ display: &apos;contents&apos; }}&gt;
104:           {/* Row header */}
105:           &lt;div
106:             role=&quot;rowheader&quot;
107:             style={{
108:               display: &apos;flex&apos;,
109:               alignItems: &apos;center&apos;,
110:               justifyContent: &apos;flex-end&apos;,
111:               paddingRight: 8,
112:               fontSize: 11,
113:               fontWeight: 600,
114:               color: &apos;var(--text-secondary)&apos;,
115:               overflow: &apos;hidden&apos;,
116:               textOverflow: &apos;ellipsis&apos;,
117:               whiteSpace: &apos;nowrap&apos;,
118:             }}
119:           &gt;
120:             {shortName(rowMetric)}
121:           &lt;/div&gt;
122: 
123:           {/* Data cells */}
124:           {metrics.map((colMetric, ci) =&gt; {
125:             const isDiag = ri === ci;
126:             const corr = isDiag ? undefined : lookupCorrelation(correlations, rowMetric, colMetric);
127:             const value = isDiag ? 1 : corr?.pearsonR ?? 0;
128:             const isToxic = corr?.isKnownToxicCombo ?? false;
129:             const bg = isDiag ? &apos;var(--bg-secondary, #2a2a2a)&apos; : colorScale(value);
130: 
131:             const tooltip = isDiag
132:               ? `${rowMetric}: diagonal (1.00)`
133:               : corr
134:                 ? `${corr.metricA} vs ${corr.metricB}\npearsonR: ${corr.pearsonR.toFixed(3)}\nlagHours: ${corr.lagHours}\npValue: ${corr.pValue?.toFixed(4) ?? &apos;N/A&apos;}\nsignificant: ${corr.significant}`
135:                 : `${rowMetric} vs ${colMetric}: no data`;
136: 
137:             return (
138:               &lt;div
139:                 key={`${ri}-${ci}`}
140:                 role=&quot;cell&quot;
141:                 aria-label={`${rowMetric} vs ${colMetric}: ${value.toFixed(2)}`}
142:                 title={tooltip}
143:                 onClick={!isDiag &amp;&amp; onCellClick ? () =&gt; onCellClick(rowMetric, colMetric) : undefined}
144:                 style={{
145:                   cursor: !isDiag &amp;&amp; onCellClick ? &apos;pointer&apos; : &apos;default&apos;,
146:                   display: &apos;flex&apos;,
147:                   alignItems: &apos;center&apos;,
148:                   justifyContent: &apos;center&apos;,
149:                   backgroundColor: bg,
150:                   color: isDiag ? &apos;var(--text-secondary)&apos; : contrastText(value),
151:                   fontFamily: &apos;var(--font-mono)&apos;,
152:                   fontSize: 12,
153:                   fontWeight: 500,
154:                   borderRadius: 2,
155:                   border: isToxic ? &apos;2px solid #f04438&apos; : &apos;none&apos;,
156:                   animation: isToxic ? &apos;toxicPulse 2s ease-in-out infinite&apos; : undefined,
157:                   minHeight: 36,
158:                 }}
159:               &gt;
160:                 {value.toFixed(2)}
161:               &lt;/div&gt;
162:             );
163:           })}
164:         &lt;/div&gt;
165:       ))}
166: 
167:     &lt;/div&gt;
168:   );
169: }</file><file path="src/components/EvaluationTable.tsx">  1: import { useState, Fragment } from &apos;react&apos;;
  2: import {
  3:   createColumnHelper,
  4:   useReactTable,
  5:   getCoreRowModel,
  6:   getSortedRowModel,
  7:   getFilteredRowModel,
  8:   getExpandedRowModel,
  9:   flexRender,
 10:   type SortingState,
 11:   type ColumnFiltersState,
 12:   type ExpandedState,
 13:   type SortingFn,
 14:   type FilterFn,
 15: } from &apos;@tanstack/react-table&apos;;
 16: import {
 17:   labelToOrdinal,
 18:   ordinalToCategory,
 19:   truncateText,
 20:   formatTimestamp,
 21:   type LabelFilterCategory,
 22: } from &apos;../lib/quality-utils.js&apos;;
 23: import { EvaluationExpandedRow } from &apos;./EvaluationExpandedRow.js&apos;;
 24: import { ScoreBadge } from &apos;./ScoreBadge.js&apos;;
 25: 
 26: export interface EvalRow {
 27:   score: number;
 28:   explanation?: string;
 29:   traceId?: string;
 30:   timestamp?: string;
 31:   evaluator?: string;
 32:   label?: string;
 33:   evaluatorType?: string;
 34:   spanId?: string;
 35:   sessionId?: string;
 36:   agentName?: string;
 37:   trajectoryLength?: number;
 38:   stepScores?: Array&lt;{ step: string | number; score: number; explanation?: string }&gt;;
 39:   toolVerifications?: Array&lt;{ toolName: string; toolCorrect: boolean; argsCorrect: boolean; score: number }&gt;;
 40: }
 41: 
 42: const CATEGORY_COLORS: Record&lt;LabelFilterCategory, string&gt; = {
 43:   Pass: &apos;#26d97f&apos;,
 44:   Review: &apos;#e5a00d&apos;,
 45:   Fail: &apos;#f04438&apos;,
 46: };
 47: 
 48: const labelSortFn: SortingFn&lt;EvalRow&gt; = (rowA, rowB) =&gt; {
 49:   const a = labelToOrdinal(rowA.original.label ?? &apos;unknown&apos;).ordinal;
 50:   const b = labelToOrdinal(rowB.original.label ?? &apos;unknown&apos;).ordinal;
 51:   return a - b;
 52: };
 53: 
 54: const categoryFilterFn: FilterFn&lt;EvalRow&gt; = (row, _id, filterValue: LabelFilterCategory[]) =&gt; {
 55:   if (!filterValue || filterValue.length === 0) return true;
 56:   const category = ordinalToCategory(labelToOrdinal(row.original.label ?? &apos;unknown&apos;).ordinal);
 57:   return filterValue.includes(category);
 58: };
 59: 
 60: const columnHelper = createColumnHelper&lt;EvalRow&gt;();
 61: 
 62: const columns = [
 63:   columnHelper.display({
 64:     id: &apos;expand&apos;,
 65:     header: &apos;&apos;,
 66:     cell: ({ row }) =&gt; (
 67:       &lt;button
 68:         type=&quot;button&quot;
 69:         onClick={row.getToggleExpandedHandler()}
 70:         aria-label={row.getIsExpanded() ? &apos;Collapse row&apos; : &apos;Expand row&apos;}
 71:         style={{
 72:           background: &apos;none&apos;,
 73:           border: &apos;none&apos;,
 74:           cursor: &apos;pointer&apos;,
 75:           padding: &apos;2px 6px&apos;,
 76:           fontSize: 12,
 77:           color: &apos;var(--text-secondary)&apos;,
 78:           transition: &apos;transform 0.15s&apos;,
 79:           transform: row.getIsExpanded() ? &apos;rotate(90deg)&apos; : &apos;rotate(0deg)&apos;,
 80:         }}
 81:       &gt;
 82:         &amp;#9654;
 83:       &lt;/button&gt;
 84:     ),
 85:     size: 32,
 86:   }),
 87:   columnHelper.accessor(&apos;score&apos;, {
 88:     header: &apos;Score&apos;,
 89:     cell: (info) =&gt; {
 90:       const row = info.row.original;
 91:       return (
 92:         &lt;ScoreBadge
 93:           score={info.getValue()}
 94:           metricName=&quot;score&quot;
 95:           label={info.getValue().toFixed(4)}
 96:           evaluator={row.evaluator}
 97:           evaluatorType={row.evaluatorType}
 98:           explanation={row.explanation}
 99:           traceId={row.traceId}
100:         /&gt;
101:       );
102:     },
103:     sortingFn: &apos;basic&apos;,
104:   }),
105:   columnHelper.accessor(&apos;label&apos;, {
106:     header: &apos;Label&apos;,
107:     cell: (info) =&gt; {
108:       const label = info.getValue() ?? &apos;unknown&apos;;
109:       const { category } = labelToOrdinal(label);
110:       return (
111:         &lt;span
112:           style={{
113:             display: &apos;inline-block&apos;,
114:             padding: &apos;2px 8px&apos;,
115:             borderRadius: 10,
116:             fontSize: 11,
117:             fontWeight: 500,
118:             backgroundColor: `${CATEGORY_COLORS[category]}20`,
119:             color: CATEGORY_COLORS[category],
120:           }}
121:         &gt;
122:           {label}
123:         &lt;/span&gt;
124:       );
125:     },
126:     sortingFn: labelSortFn,
127:     filterFn: categoryFilterFn,
128:   }),
129:   columnHelper.display({
130:     id: &apos;category&apos;,
131:     header: &apos;Category&apos;,
132:     cell: (info) =&gt; {
133:       const label = info.row.original.label ?? &apos;unknown&apos;;
134:       const category = ordinalToCategory(labelToOrdinal(label).ordinal);
135:       return (
136:         &lt;span
137:           style={{
138:             display: &apos;inline-block&apos;,
139:             padding: &apos;2px 8px&apos;,
140:             borderRadius: 10,
141:             fontSize: 11,
142:             fontWeight: 600,
143:             backgroundColor: `${CATEGORY_COLORS[category]}20`,
144:             color: CATEGORY_COLORS[category],
145:           }}
146:         &gt;
147:           {category}
148:         &lt;/span&gt;
149:       );
150:     },
151:   }),
152:   columnHelper.accessor(&apos;explanation&apos;, {
153:     header: &apos;Explanation&apos;,
154:     cell: (info) =&gt; {
155:       const text = info.getValue() ?? &apos;-&apos;;
156:       return (
157:         &lt;span className=&quot;explanation&quot; title={text}&gt;
158:           {truncateText(text, 60)}
159:         &lt;/span&gt;
160:       );
161:     },
162:     enableSorting: false,
163:   }),
164:   columnHelper.accessor(&apos;evaluator&apos;, {
165:     header: &apos;Evaluator&apos;,
166:     cell: (info) =&gt; (
167:       &lt;span style={{ fontFamily: &apos;var(--font-mono)&apos;, fontSize: 12 }}&gt;
168:         {info.getValue() ?? &apos;-&apos;}
169:       &lt;/span&gt;
170:     ),
171:     enableSorting: false,
172:   }),
173:   columnHelper.accessor(&apos;timestamp&apos;, {
174:     header: &apos;Timestamp&apos;,
175:     cell: (info) =&gt; {
176:       const ts = info.getValue();
177:       if (!ts) return &apos;-&apos;;
178:       return (
179:         &lt;span title={new Date(ts).toLocaleString()}&gt;
180:           {formatTimestamp(ts)}
181:         &lt;/span&gt;
182:       );
183:     },
184:     sortingFn: &apos;datetime&apos;,
185:   }),
186: ];
187: 
188: export function EvaluationTable({ evaluations }: { evaluations: EvalRow[] }) {
189:   const [sorting, setSorting] = useState&lt;SortingState&gt;([]);
190:   const [columnFilters, setColumnFilters] = useState&lt;ColumnFiltersState&gt;([]);
191:   const [activeCategories, setActiveCategories] = useState&lt;LabelFilterCategory[]&gt;([]);
192:   const [expanded, setExpanded] = useState&lt;ExpandedState&gt;({});
193: 
194:   const table = useReactTable({
195:     data: evaluations,
196:     columns,
197:     state: { sorting, columnFilters, expanded },
198:     onSortingChange: setSorting,
199:     onColumnFiltersChange: setColumnFilters,
200:     onExpandedChange: setExpanded,
201:     getRowCanExpand: () =&gt; true,
202:     getCoreRowModel: getCoreRowModel(),
203:     getSortedRowModel: getSortedRowModel(),
204:     getFilteredRowModel: getFilteredRowModel(),
205:     getExpandedRowModel: getExpandedRowModel(),
206:   });
207: 
208:   const toggleCategory = (cat: LabelFilterCategory) =&gt; {
209:     const next = activeCategories.includes(cat)
210:       ? activeCategories.filter((c) =&gt; c !== cat)
211:       : [...activeCategories, cat];
212:     setActiveCategories(next);
213:     setColumnFilters(
214:       next.length &gt; 0 ? [{ id: &apos;label&apos;, value: next }] : [],
215:     );
216:   };
217: 
218:   const sortDir = (colId: string): &apos;ascending&apos; | &apos;descending&apos; | &apos;none&apos; =&gt; {
219:     const s = sorting.find((entry) =&gt; entry.id === colId);
220:     if (!s) return &apos;none&apos;;
221:     return s.desc ? &apos;descending&apos; : &apos;ascending&apos;;
222:   };
223: 
224:   return (
225:     &lt;div&gt;
226:       &lt;div style={{ display: &apos;flex&apos;, gap: 6, marginBottom: 12 }}&gt;
227:         {([&apos;Pass&apos;, &apos;Review&apos;, &apos;Fail&apos;] as const).map((cat) =&gt; {
228:           const active = activeCategories.includes(cat);
229:           return (
230:             &lt;button
231:               key={cat}
232:               type=&quot;button&quot;
233:               onClick={() =&gt; toggleCategory(cat)}
234:               style={{
235:                 padding: &apos;4px 12px&apos;,
236:                 borderRadius: 6,
237:                 border: `1px solid ${CATEGORY_COLORS[cat]}`,
238:                 backgroundColor: active ? `${CATEGORY_COLORS[cat]}30` : &apos;transparent&apos;,
239:                 color: CATEGORY_COLORS[cat],
240:                 fontSize: 12,
241:                 fontWeight: 600,
242:                 cursor: &apos;pointer&apos;,
243:                 opacity: active ? 1 : 0.6,
244:                 transition: &apos;opacity 0.15s, background-color 0.15s&apos;,
245:               }}
246:             &gt;
247:               {cat}
248:             &lt;/button&gt;
249:           );
250:         })}
251:       &lt;/div&gt;
252:       &lt;table className=&quot;eval-table&quot;&gt;
253:         &lt;thead&gt;
254:           {table.getHeaderGroups().map((hg) =&gt; (
255:             &lt;tr key={hg.id}&gt;
256:               {hg.headers.map((header) =&gt; {
257:                 const canSort = header.column.getCanSort();
258:                 return (
259:                   &lt;th
260:                     key={header.id}
261:                     onClick={canSort ? header.column.getToggleSortingHandler() : undefined}
262:                     style={{ cursor: canSort ? &apos;pointer&apos; : &apos;default&apos;, userSelect: &apos;none&apos; }}
263:                     aria-sort={canSort ? sortDir(header.id) : undefined}
264:                   &gt;
265:                     {flexRender(header.column.columnDef.header, header.getContext())}
266:                     {canSort &amp;&amp; (
267:                       &lt;span style={{ marginLeft: 4, fontSize: 10 }}&gt;
268:                         {{ asc: &apos; ^&apos;, desc: &apos; v&apos; }[header.column.getIsSorted() as string] ?? &apos;&apos;}
269:                       &lt;/span&gt;
270:                     )}
271:                   &lt;/th&gt;
272:                 );
273:               })}
274:             &lt;/tr&gt;
275:           ))}
276:         &lt;/thead&gt;
277:         &lt;tbody&gt;
278:           {table.getRowModel().rows.map((row) =&gt; (
279:             &lt;Fragment key={row.id}&gt;
280:               &lt;tr className={row.getIsExpanded() ? &apos;eval-row-expanded&apos; : &apos;&apos;}&gt;
281:                 {row.getVisibleCells().map((cell) =&gt; (
282:                   &lt;td key={cell.id}&gt;
283:                     {flexRender(cell.column.columnDef.cell, cell.getContext())}
284:                   &lt;/td&gt;
285:                 ))}
286:               &lt;/tr&gt;
287:               {row.getIsExpanded() &amp;&amp; (
288:                 &lt;tr className=&quot;eval-expanded-panel&quot;&gt;
289:                   &lt;td colSpan={row.getVisibleCells().length}&gt;
290:                     &lt;EvaluationExpandedRow row={row.original} /&gt;
291:                   &lt;/td&gt;
292:                 &lt;/tr&gt;
293:               )}
294:             &lt;/Fragment&gt;
295:           ))}
296:           {table.getRowModel().rows.length === 0 &amp;&amp; (
297:             &lt;tr&gt;
298:               &lt;td colSpan={table.getVisibleLeafColumns().length} style={{ textAlign: &apos;center&apos;, color: &apos;var(--text-muted)&apos;, padding: 16 }}&gt;
299:                 No evaluations match the current filter.
300:               &lt;/td&gt;
301:             &lt;/tr&gt;
302:           )}
303:         &lt;/tbody&gt;
304:       &lt;/table&gt;
305:     &lt;/div&gt;
306:   );
307: }</file><file path="src/components/AgentActivityPanel.tsx">  1: import { Fragment, useCallback, useMemo, useState } from &apos;react&apos;;
  2: import { Link } from &apos;wouter&apos;;
  3: import type { AgentStat, EvalMetricSummary } from &apos;../hooks/useAgentStats.js&apos;;
  4: import { scoreColorBand, SCORE_COLORS } from &apos;../lib/quality-utils.js&apos;;
  5: import { Sparkline } from &apos;./Sparkline.js&apos;;
  6: 
  7: const AGENT_COLORS = [&apos;#6366f1&apos;, &apos;#ec4899&apos;, &apos;#14b8a6&apos;, &apos;#f59e0b&apos;, &apos;#8b5cf6&apos;, &apos;#06b6d4&apos;, &apos;#f97316&apos;, &apos;#84cc16&apos;];
  8: 
  9: const COLUMN_COUNT = 7;
 10: const ERROR_RATE_WARNING_THRESHOLD = 0.1;
 11: const RATE_LIMIT_BADGE_BG = &apos;var(--bg-status-warning)&apos;;
 12: 
 13: type SortKey = &apos;invocations&apos; | &apos;errorRate&apos; | &apos;sessionCount&apos; | &apos;avgOutputSize&apos;;
 14: 
 15: function errorRateColor(rate: number): string {
 16:   if (rate === 0) return &apos;var(--status-healthy)&apos;;
 17:   if (rate &lt; ERROR_RATE_WARNING_THRESHOLD) return &apos;var(--status-warning)&apos;;
 18:   return &apos;var(--status-critical)&apos;;
 19: }
 20: 
 21: function formatBytes(n: number): string {
 22:   if (n === 0) return &apos;\u2014&apos;;
 23:   if (n &lt; 1024) return `${n}B`;
 24:   return `${(n / 1024).toFixed(1)}K`;
 25: }
 26: 
 27: function truncateId(id: string): string {
 28:   return id.length &gt; 12 ? `${id.slice(0, 6)}...${id.slice(-4)}` : id;
 29: }
 30: 
 31: interface AgentActivityPanelProps {
 32:   agents: AgentStat[];
 33: }
 34: 
 35: export function AgentActivityPanel({ agents }: AgentActivityPanelProps) {
 36:   const [sort, setSort] = useState&lt;SortKey&gt;(&apos;invocations&apos;);
 37:   const [asc, setAsc] = useState(false);
 38:   const [expanded, setExpanded] = useState&lt;string | null&gt;(null);
 39: 
 40:   const colorIndex = useMemo(
 41:     () =&gt; new Map(agents.map((a, i) =&gt; [a.agentName, AGENT_COLORS[i % AGENT_COLORS.length]])),
 42:     [agents],
 43:   );
 44: 
 45:   // React 18+ batches both setState calls in event handlers atomically
 46:   const toggleSort = useCallback((key: SortKey) =&gt; {
 47:     if (key === sort) {
 48:       setAsc(v =&gt; !v);
 49:     } else {
 50:       setSort(key);
 51:       setAsc(false);
 52:     }
 53:   }, [sort]);
 54: 
 55:   if (agents.length === 0) {
 56:     return (
 57:       &lt;div style={{ padding: &apos;32px 0&apos;, textAlign: &apos;center&apos;, color: &apos;var(--text-muted)&apos; }}&gt;
 58:         No agent activity recorded for this period.
 59:       &lt;/div&gt;
 60:     );
 61:   }
 62: 
 63:   const maxInvocations = Math.max(...agents.map(a =&gt; a.invocations), 1);
 64: 
 65:   const sorted = [...agents].sort((a, b) =&gt; {
 66:     const diff = a[sort] &lt; b[sort] ? -1 : a[sort] &gt; b[sort] ? 1 : 0;
 67:     return asc ? diff : -diff;
 68:   });
 69: 
 70:   const sortIndicator = (key: SortKey) =&gt;
 71:     sort === key ? (asc ? &apos; \u2191&apos; : &apos; \u2193&apos;) : &apos;&apos;;
 72: 
 73:   return (
 74:     &lt;div style={{ overflowX: &apos;auto&apos; }}&gt;
 75:       &lt;table className=&quot;sla-table&quot; style={{ minWidth: 640 }}&gt;
 76:         &lt;thead&gt;
 77:           &lt;tr&gt;
 78:             &lt;th style={{ width: &apos;30%&apos; }}&gt;Agent&lt;/th&gt;
 79:             &lt;th style={{ cursor: &apos;pointer&apos;, userSelect: &apos;none&apos; }} onClick={() =&gt; toggleSort(&apos;invocations&apos;)}&gt;
 80:               Invocations{sortIndicator(&apos;invocations&apos;)}
 81:             &lt;/th&gt;
 82:             &lt;th style={{ cursor: &apos;pointer&apos;, userSelect: &apos;none&apos; }} onClick={() =&gt; toggleSort(&apos;errorRate&apos;)}&gt;
 83:               Error Rate{sortIndicator(&apos;errorRate&apos;)}
 84:             &lt;/th&gt;
 85:             &lt;th style={{ cursor: &apos;pointer&apos;, userSelect: &apos;none&apos; }} onClick={() =&gt; toggleSort(&apos;sessionCount&apos;)}&gt;
 86:               Sessions{sortIndicator(&apos;sessionCount&apos;)}
 87:             &lt;/th&gt;
 88:             &lt;th style={{ cursor: &apos;pointer&apos;, userSelect: &apos;none&apos; }} onClick={() =&gt; toggleSort(&apos;avgOutputSize&apos;)}&gt;
 89:               Avg Output{sortIndicator(&apos;avgOutputSize&apos;)}
 90:             &lt;/th&gt;
 91:             &lt;th&gt;Rate Limits&lt;/th&gt;
 92:             &lt;th&gt;Source&lt;/th&gt;
 93:           &lt;/tr&gt;
 94:         &lt;/thead&gt;
 95:         &lt;tbody&gt;
 96:           {sorted.map((agent) =&gt; {
 97:             const color = colorIndex.get(agent.agentName) ?? AGENT_COLORS[0];
 98:             const errColor = errorRateColor(agent.errorRate);
 99:             const invPct = (agent.invocations / maxInvocations) * 100;
100:             const topSource = Object.entries(agent.sourceTypes).sort((a, b) =&gt; b[1] - a[1])[0]?.[0];
101:             const isExpanded = expanded === agent.agentName;
102:             const hasLinks = agent.sessionIds.length &gt; 0 || agent.traceIds.length &gt; 0;
103: 
104:             return (
105:               &lt;Fragment key={agent.agentName}&gt;
106:                 &lt;tr
107:                   className={isExpanded ? &apos;eval-row-expanded&apos; : &apos;&apos;}
108:                   style={{ verticalAlign: &apos;middle&apos;, cursor: hasLinks ? &apos;pointer&apos; : undefined }}
109:                   onClick={() =&gt; hasLinks &amp;&amp; setExpanded(isExpanded ? null : agent.agentName)}
110:                 &gt;
111:                   {/* Agent name with color accent */}
112:                   &lt;td&gt;
113:                     &lt;div style={{ display: &apos;flex&apos;, alignItems: &apos;center&apos;, gap: 8 }}&gt;
114:                       {hasLinks &amp;&amp; (
115:                         &lt;span style={{
116:                           fontSize: 9,
117:                           color: &apos;var(--text-muted)&apos;,
118:                           transition: &apos;transform 0.15s&apos;,
119:                           transform: isExpanded ? &apos;rotate(90deg)&apos; : &apos;none&apos;,
120:                           flexShrink: 0,
121:                         }}&gt;
122:                           &amp;#9654;
123:                         &lt;/span&gt;
124:                       )}
125:                       &lt;span style={{
126:                         display: &apos;inline-block&apos;,
127:                         width: 8,
128:                         height: 8,
129:                         borderRadius: &apos;50%&apos;,
130:                         background: color,
131:                         flexShrink: 0,
132:                       }} /&gt;
133:                       &lt;span style={{
134:                         fontFamily: &apos;var(--font-mono)&apos;,
135:                         fontSize: 12,
136:                         color: &apos;var(--text-primary)&apos;,
137:                         wordBreak: &apos;break-all&apos;,
138:                       }}&gt;
139:                         {agent.agentName}
140:                       &lt;/span&gt;
141:                     &lt;/div&gt;
142:                   &lt;/td&gt;
143: 
144:                   {/* Invocations with inline bar */}
145:                   &lt;td&gt;
146:                     &lt;div style={{ display: &apos;flex&apos;, alignItems: &apos;center&apos;, gap: 8 }}&gt;
147:                       &lt;span style={{ fontFamily: &apos;var(--font-mono)&apos;, fontSize: 13, minWidth: 32 }}&gt;
148:                         {agent.invocations}
149:                       &lt;/span&gt;
150:                       &lt;div style={{ flex: 1, height: 4, background: &apos;var(--bg-surface)&apos;, borderRadius: 2, minWidth: 48 }}&gt;
151:                         &lt;div style={{
152:                           width: `${invPct}%`,
153:                           height: &apos;100%&apos;,
154:                           background: color,
155:                           borderRadius: 2,
156:                           opacity: 0.7,
157:                         }} /&gt;
158:                       &lt;/div&gt;
159:                     &lt;/div&gt;
160:                   &lt;/td&gt;
161: 
162:                   {/* Error rate */}
163:                   &lt;td&gt;
164:                     &lt;div style={{ display: &apos;flex&apos;, alignItems: &apos;center&apos;, gap: 6 }}&gt;
165:                       &lt;span style={{
166:                         fontFamily: &apos;var(--font-mono)&apos;,
167:                         fontSize: 12,
168:                         color: errColor,
169:                       }}&gt;
170:                         {agent.errors &gt; 0 ? `${(agent.errorRate * 100).toFixed(1)}%` : &apos;\u2014&apos;}
171:                       &lt;/span&gt;
172:                       {agent.errors &gt; 0 &amp;&amp; (
173:                         &lt;span style={{ fontSize: 11, color: &apos;var(--text-muted)&apos; }}&gt;
174:                           ({agent.errors})
175:                         &lt;/span&gt;
176:                       )}
177:                     &lt;/div&gt;
178:                   &lt;/td&gt;
179: 
180:                   {/* Session count */}
181:                   &lt;td&gt;
182:                     &lt;span style={{ fontFamily: &apos;var(--font-mono)&apos;, fontSize: 12 }}&gt;
183:                       {agent.sessionCount}
184:                     &lt;/span&gt;
185:                   &lt;/td&gt;
186: 
187:                   {/* Avg output size */}
188:                   &lt;td&gt;
189:                     &lt;span style={{ fontFamily: &apos;var(--font-mono)&apos;, fontSize: 12, color: &apos;var(--text-secondary)&apos; }}&gt;
190:                       {formatBytes(agent.avgOutputSize)}
191:                     &lt;/span&gt;
192:                   &lt;/td&gt;
193: 
194:                   {/* Rate limits */}
195:                   &lt;td&gt;
196:                     {agent.rateLimitCount &gt; 0 ? (
197:                       &lt;span style={{
198:                         fontFamily: &apos;var(--font-mono)&apos;,
199:                         fontSize: 11,
200:                         color: &apos;var(--status-warning)&apos;,
201:                         background: RATE_LIMIT_BADGE_BG,
202:                         padding: &apos;1px 6px&apos;,
203:                         borderRadius: 10,
204:                       }}&gt;
205:                         {agent.rateLimitCount}x
206:                       &lt;/span&gt;
207:                     ) : (
208:                       &lt;span style={{ color: &apos;var(--text-muted)&apos;, fontSize: 11 }}&gt;{&apos;\u2014&apos;}&lt;/span&gt;
209:                     )}
210:                   &lt;/td&gt;
211: 
212:                   {/* Source type */}
213:                   &lt;td&gt;
214:                     {topSource ? (
215:                       &lt;span style={{
216:                         fontSize: 10,
217:                         fontFamily: &apos;var(--font-mono)&apos;,
218:                         color: &apos;var(--text-muted)&apos;,
219:                         textTransform: &apos;uppercase&apos;,
220:                         letterSpacing: &apos;0.5px&apos;,
221:                       }}&gt;
222:                         {topSource}
223:                       &lt;/span&gt;
224:                     ) : &lt;span style={{ color: &apos;var(--text-muted)&apos; }}&gt;{&apos;\u2014&apos;}&lt;/span&gt;}
225:                   &lt;/td&gt;
226:                 &lt;/tr&gt;
227: 
228:                 {/* Expanded row: eval summary + sessions + traces */}
229:                 {isExpanded &amp;&amp; (
230:                   &lt;tr className=&quot;eval-expanded-panel&quot;&gt;
231:                     &lt;td colSpan={COLUMN_COUNT} style={{ padding: &apos;0 10px 10px&apos;, borderBottom: &apos;1px solid var(--border)&apos; }}&gt;
232:                       {/* Evaluation summary */}
233:                       &lt;EvalSummaryRow evalSummary={agent.evalSummary} /&gt;
234: 
235:                       {/* Daily invocation sparkline */}
236:                       {agent.dailyCounts.length &gt; 1 &amp;&amp; agent.dailyCounts.some(v =&gt; v &gt; 0) &amp;&amp; (
237:                         &lt;div style={{
238:                           padding: &apos;10px 0 8px&apos;,
239:                           borderBottom: &apos;1px solid var(--border-subtle)&apos;,
240:                           marginBottom: 4,
241:                         }}&gt;
242:                           &lt;div style={{
243:                             display: &apos;flex&apos;,
244:                             alignItems: &apos;center&apos;,
245:                             gap: 12,
246:                           }}&gt;
247:                             &lt;div style={{
248:                               fontSize: 11,
249:                               color: &apos;var(--text-muted)&apos;,
250:                               textTransform: &apos;uppercase&apos;,
251:                               letterSpacing: &apos;0.5px&apos;,
252:                               flexShrink: 0,
253:                             }}&gt;
254:                               Daily Activity
255:                             &lt;/div&gt;
256:                             &lt;Sparkline
257:                               data={agent.dailyCounts}
258:                               width={160}
259:                               height={28}
260:                               color={colorIndex.get(agent.agentName) ?? AGENT_COLORS[0]}
261:                               label={`Daily invocations for ${agent.agentName}`}
262:                             /&gt;
263:                             &lt;span style={{
264:                               fontFamily: &apos;var(--font-mono)&apos;,
265:                               fontSize: 10,
266:                               color: &apos;var(--text-muted)&apos;,
267:                               flexShrink: 0,
268:                             }}&gt;
269:                               peak {Math.max(...agent.dailyCounts)}/day
270:                             &lt;/span&gt;
271:                           &lt;/div&gt;
272:                         &lt;/div&gt;
273:                       )}
274: 
275:                       &lt;div style={{
276:                         display: &apos;grid&apos;,
277:                         gridTemplateColumns: &apos;1fr 1fr&apos;,
278:                         gap: 16,
279:                         padding: &apos;12px 0 4px&apos;,
280:                       }}&gt;
281:                         {/* Sessions column */}
282:                         &lt;div&gt;
283:                           &lt;div style={{
284:                             fontSize: 11,
285:                             color: &apos;var(--text-muted)&apos;,
286:                             textTransform: &apos;uppercase&apos;,
287:                             letterSpacing: &apos;0.5px&apos;,
288:                             marginBottom: 6,
289:                           }}&gt;
290:                             Sessions ({agent.sessionCount})
291:                           &lt;/div&gt;
292:                           &lt;div style={{ display: &apos;flex&apos;, flexDirection: &apos;column&apos;, gap: 3 }}&gt;
293:                             {agent.sessionIds.map(sid =&gt; (
294:                               &lt;Link
295:                                 key={sid}
296:                                 href={`/sessions/${sid}`}
297:                                 style={{
298:                                   fontFamily: &apos;var(--font-mono)&apos;,
299:                                   fontSize: 11,
300:                                   color: &apos;var(--accent)&apos;,
301:                                   textDecoration: &apos;none&apos;,
302:                                 }}
303:                                 onClick={(e: React.MouseEvent) =&gt; e.stopPropagation()}
304:                               &gt;
305:                                 {truncateId(sid)}
306:                               &lt;/Link&gt;
307:                             ))}
308:                             {agent.sessionIds.length === 0 &amp;&amp; (
309:                               &lt;span style={{ fontSize: 11, color: &apos;var(--text-muted)&apos; }}&gt;none&lt;/span&gt;
310:                             )}
311:                             {/* sessionCount === total unique sessions; sessionIds is capped at 50 */}
312:                             {agent.sessionIdsTruncated &amp;&amp; (
313:                               &lt;span style={{ fontSize: 10, color: &apos;var(--text-muted)&apos;, fontStyle: &apos;italic&apos; }}&gt;
314:                                 +{agent.sessionCount - agent.sessionIds.length} more
315:                               &lt;/span&gt;
316:                             )}
317:                           &lt;/div&gt;
318:                         &lt;/div&gt;
319: 
320:                         {/* Traces column */}
321:                         &lt;div&gt;
322:                           &lt;div style={{
323:                             fontSize: 11,
324:                             color: &apos;var(--text-muted)&apos;,
325:                             textTransform: &apos;uppercase&apos;,
326:                             letterSpacing: &apos;0.5px&apos;,
327:                             marginBottom: 6,
328:                           }}&gt;
329:                             Traces ({agent.traceIdsTotal ?? agent.traceIds.length})
330:                           &lt;/div&gt;
331:                           &lt;div style={{ display: &apos;flex&apos;, flexDirection: &apos;column&apos;, gap: 3 }}&gt;
332:                             {agent.traceIds.map(tid =&gt; (
333:                               &lt;Link
334:                                 key={tid}
335:                                 href={`/traces/${tid}`}
336:                                 style={{
337:                                   fontFamily: &apos;var(--font-mono)&apos;,
338:                                   fontSize: 11,
339:                                   color: &apos;var(--accent)&apos;,
340:                                   textDecoration: &apos;none&apos;,
341:                                 }}
342:                                 onClick={(e: React.MouseEvent) =&gt; e.stopPropagation()}
343:                               &gt;
344:                                 {truncateId(tid)}
345:                               &lt;/Link&gt;
346:                             ))}
347:                             {agent.traceIds.length === 0 &amp;&amp; (
348:                               &lt;span style={{ fontSize: 11, color: &apos;var(--text-muted)&apos; }}&gt;none&lt;/span&gt;
349:                             )}
350:                             {agent.traceIdsTruncated &amp;&amp; (
351:                               &lt;span style={{ fontSize: 10, color: &apos;var(--text-muted)&apos;, fontStyle: &apos;italic&apos; }}&gt;
352:                                 +{(agent.traceIdsTotal ?? 0) - agent.traceIds.length} more
353:                               &lt;/span&gt;
354:                             )}
355:                           &lt;/div&gt;
356:                         &lt;/div&gt;
357:                       &lt;/div&gt;
358:                     &lt;/td&gt;
359:                   &lt;/tr&gt;
360:                 )}
361:               &lt;/Fragment&gt;
362:             );
363:           })}
364:         &lt;/tbody&gt;
365:       &lt;/table&gt;
366:     &lt;/div&gt;
367:   );
368: }
369: 
370: /** Per-agent evaluation metrics (relevance, coherence, faithfulness, etc.) */
371: function EvalSummaryRow({ evalSummary }: { evalSummary: Record&lt;string, EvalMetricSummary&gt; }) {
372:   const metrics = Object.entries(evalSummary);
373:   if (metrics.length === 0) {
374:     return (
375:       &lt;div style={{
376:         padding: &apos;10px 0 4px&apos;,
377:         fontSize: 11,
378:         color: &apos;var(--text-muted)&apos;,
379:         borderBottom: &apos;1px solid var(--border-subtle)&apos;,
380:         marginBottom: 4,
381:       }}&gt;
382:         No evaluations linked to this agent.
383:       &lt;/div&gt;
384:     );
385:   }
386: 
387:   return (
388:     &lt;div style={{
389:       padding: &apos;10px 0 8px&apos;,
390:       borderBottom: &apos;1px solid var(--border-subtle)&apos;,
391:       marginBottom: 4,
392:     }}&gt;
393:       &lt;div style={{
394:         fontSize: 11,
395:         color: &apos;var(--text-muted)&apos;,
396:         textTransform: &apos;uppercase&apos;,
397:         letterSpacing: &apos;0.5px&apos;,
398:         marginBottom: 8,
399:       }}&gt;
400:         Evaluation Metrics
401:       &lt;/div&gt;
402:       &lt;div style={{ display: &apos;flex&apos;, flexWrap: &apos;wrap&apos;, gap: 12 }}&gt;
403:         {metrics.map(([name, m]) =&gt; {
404:           const band = scoreColorBand(m.avg);
405:           const barColor = SCORE_COLORS[band];
406:           return (
407:             &lt;div key={name} style={{
408:               minWidth: 140,
409:               padding: &apos;8px 10px&apos;,
410:               background: &apos;var(--bg-card)&apos;,
411:               border: &apos;1px solid var(--border-subtle)&apos;,
412:               borderRadius: &apos;var(--radius)&apos;,
413:             }}&gt;
414:               &lt;div style={{
415:                 fontSize: 11,
416:                 color: &apos;var(--text-secondary)&apos;,
417:                 marginBottom: 4,
418:                 whiteSpace: &apos;nowrap&apos;,
419:                 overflow: &apos;hidden&apos;,
420:                 textOverflow: &apos;ellipsis&apos;,
421:               }}&gt;
422:                 {name}
423:               &lt;/div&gt;
424:               {/* Score bar */}
425:               &lt;div style={{ display: &apos;flex&apos;, alignItems: &apos;center&apos;, gap: 8, marginBottom: 4 }}&gt;
426:                 &lt;div style={{ flex: 1, height: 4, background: &apos;var(--bg-surface)&apos;, borderRadius: 2 }}&gt;
427:                   &lt;div style={{
428:                     width: `${Math.min(m.avg * 100, 100)}%`,
429:                     height: &apos;100%&apos;,
430:                     background: barColor,
431:                     borderRadius: 2,
432:                   }} /&gt;
433:                 &lt;/div&gt;
434:                 &lt;span style={{
435:                   fontFamily: &apos;var(--font-mono)&apos;,
436:                   fontSize: 13,
437:                   fontWeight: 600,
438:                   color: barColor,
439:                   minWidth: 38,
440:                   textAlign: &apos;right&apos;,
441:                 }}&gt;
442:                   {m.avg.toFixed(2)}
443:                 &lt;/span&gt;
444:               &lt;/div&gt;
445:               {/* Min/max range + count */}
446:               &lt;div style={{
447:                 display: &apos;flex&apos;,
448:                 justifyContent: &apos;space-between&apos;,
449:                 fontSize: 10,
450:                 fontFamily: &apos;var(--font-mono)&apos;,
451:                 color: &apos;var(--text-muted)&apos;,
452:               }}&gt;
453:                 &lt;span&gt;{m.min.toFixed(2)}\u2013{m.max.toFixed(2)}&lt;/span&gt;
454:                 &lt;span&gt;n={m.count}&lt;/span&gt;
455:               &lt;/div&gt;
456:             &lt;/div&gt;
457:           );
458:         })}
459:       &lt;/div&gt;
460:     &lt;/div&gt;
461:   );
462: }
463: 
464: /** Summary bar above the table -- totals at a glance */
465: export function AgentActivitySummary({ agents }: AgentActivityPanelProps) {
466:   const totalInvocations = agents.reduce((s, a) =&gt; s + a.invocations, 0);
467:   const totalErrors = agents.reduce((s, a) =&gt; s + a.errors, 0);
468:   const totalRateLimits = agents.reduce((s, a) =&gt; s + a.rateLimitCount, 0);
469:   const overallErrorRate = totalInvocations &gt; 0 ? (totalErrors / totalInvocations) * 100 : 0;
470: 
471:   return (
472:     &lt;div style={{
473:       display: &apos;flex&apos;,
474:       gap: &apos;var(--space-8)&apos;,
475:       padding: &apos;var(--space-4) var(--space-5)&apos;,
476:       background: &apos;var(--bg-elevated)&apos;,
477:       borderRadius: &apos;var(--radius)&apos;,
478:       border: &apos;1px solid var(--border-subtle)&apos;,
479:       marginBottom: &apos;var(--space-5)&apos;,
480:       flexWrap: &apos;wrap&apos;,
481:     }}&gt;
482:       {[
483:         { label: &apos;Agents&apos;, value: agents.length },
484:         { label: &apos;Invocations&apos;, value: totalInvocations.toLocaleString() },
485:         {
486:           label: &apos;Error Rate&apos;,
487:           value: totalInvocations &gt; 0 ? `${overallErrorRate.toFixed(1)}%` : &apos;\u2014&apos;,
488:           color: overallErrorRate === 0
489:             ? &apos;var(--status-healthy)&apos;
490:             : overallErrorRate &lt; ERROR_RATE_WARNING_THRESHOLD * 100
491:               ? &apos;var(--status-warning)&apos;
492:               : &apos;var(--status-critical)&apos;,
493:         },
494:         {
495:           label: &apos;Rate Limits&apos;,
496:           value: totalRateLimits &gt; 0 ? totalRateLimits : &apos;\u2014&apos;,
497:           color: totalRateLimits &gt; 0 ? &apos;var(--status-warning)&apos; : undefined,
498:         },
499:       ].map(({ label, value, color }) =&gt; (
500:         &lt;div key={label} className=&quot;summary-count&quot;&gt;
501:           &lt;div className=&quot;value&quot; style={color ? { color } : undefined}&gt;{value}&lt;/div&gt;
502:           &lt;div className=&quot;label&quot;&gt;{label}&lt;/div&gt;
503:         &lt;/div&gt;
504:       ))}
505:     &lt;/div&gt;
506:   );
507: }</file><file path="src/components/EvaluationExpandedRow.tsx">  1: import type { CSSProperties } from &apos;react&apos;;
  2: import { Link } from &apos;wouter&apos;;
  3: import { scoreColorBand, SCORE_COLORS } from &apos;../lib/quality-utils.js&apos;;
  4: import { MetaItem } from &apos;./MetaItem.js&apos;;
  5: import type { EvalRow } from &apos;./EvaluationTable.js&apos;;
  6: 
  7: 
  8: const chipBaseStyle: CSSProperties = {
  9:   display: &apos;inline-block&apos;,
 10:   padding: &apos;2px 8px&apos;,
 11:   borderRadius: 10,
 12:   fontSize: 11,
 13:   fontFamily: &apos;var(--font-mono)&apos;,
 14: };
 15: 
 16: export function StepScoreChip({ step, score, explanation }: {
 17:   step: string | number;
 18:   score: number;
 19:   explanation?: string;
 20: }) {
 21:   const band = scoreColorBand(score, &apos;maximize&apos;);
 22:   const color = SCORE_COLORS[band];
 23:   return (
 24:     &lt;span
 25:       title={explanation ?? `Step ${step}: ${score.toFixed(2)}`}
 26:       style={{ ...chipBaseStyle, backgroundColor: `${color}20`, color }}
 27:     &gt;
 28:       {step}: {score.toFixed(2)}
 29:     &lt;/span&gt;
 30:   );
 31: }
 32: 
 33: export function ToolVerificationChip({ toolName, toolCorrect, argsCorrect, score, index }: {
 34:   toolName: string;
 35:   toolCorrect: boolean;
 36:   argsCorrect: boolean;
 37:   score: number;
 38:   index: number;
 39: }) {
 40:   const ok = toolCorrect &amp;&amp; argsCorrect;
 41:   const color = ok ? &apos;#26d97f&apos; : &apos;#f04438&apos;;
 42:   return (
 43:     &lt;span
 44:       title={`tool: ${toolCorrect ? &apos;correct&apos; : &apos;wrong&apos;}, args: ${argsCorrect ? &apos;correct&apos; : &apos;wrong&apos;}, score: ${score.toFixed(2)}`}
 45:       style={{ ...chipBaseStyle, backgroundColor: `${color}20`, color }}
 46:     &gt;
 47:       {toolName} {score.toFixed(2)}
 48:     &lt;/span&gt;
 49:   );
 50: }
 51: 
 52: export function EvaluationExpandedRow({ row }: { row: EvalRow }) {
 53:   const meta = [
 54:     { label: &apos;Evaluator Type&apos;, value: row.evaluatorType },
 55:     { label: &apos;Trace ID&apos;, value: row.traceId },
 56:     { label: &apos;Span ID&apos;, value: row.spanId },
 57:     { label: &apos;Session ID&apos;, value: row.sessionId },
 58:     { label: &apos;Agent&apos;, value: row.agentName },
 59:     { label: &apos;Trajectory Length&apos;, value: row.trajectoryLength },
 60:   ].filter(m =&gt; m.value != null);
 61: 
 62:   const hasDetail = row.explanation || meta.length &gt; 0 ||
 63:     (row.stepScores &amp;&amp; row.stepScores.length &gt; 0) ||
 64:     (row.toolVerifications &amp;&amp; row.toolVerifications.length &gt; 0);
 65: 
 66:   return (
 67:     &lt;div className=&quot;eval-expanded-content&quot; style={{
 68:       background: &apos;var(--bg-elevated)&apos;,
 69:       borderRadius: &apos;var(--radius)&apos;,
 70:       padding: 16,
 71:       animation: &apos;fade-in 0.15s ease-in-out&apos;,
 72:     }}&gt;
 73:       {row.explanation &amp;&amp; (
 74:         &lt;div style={{ marginBottom: 12 }}&gt;
 75:           &lt;div className=&quot;section-label&quot;&gt;Explanation&lt;/div&gt;
 76:           &lt;div style={{ fontSize: 13, color: &apos;var(--text-primary)&apos;, lineHeight: 1.5 }}&gt;
 77:             {row.explanation}
 78:           &lt;/div&gt;
 79:         &lt;/div&gt;
 80:       )}
 81: 
 82:       {meta.length &gt; 0 &amp;&amp; (
 83:         &lt;div style={{ display: &apos;flex&apos;, flexWrap: &apos;wrap&apos;, gap: 16, marginBottom: 12 }}&gt;
 84:           {meta.map(m =&gt; &lt;MetaItem key={m.label} label={m.label} value={m.value} /&gt;)}
 85:         &lt;/div&gt;
 86:       )}
 87: 
 88:       {row.stepScores &amp;&amp; row.stepScores.length &gt; 0 &amp;&amp; (
 89:         &lt;div style={{ marginBottom: 12 }}&gt;
 90:           &lt;div className=&quot;section-label&quot; style={{ marginBottom: 6 }}&gt;Step Scores&lt;/div&gt;
 91:           &lt;div style={{ display: &apos;flex&apos;, flexWrap: &apos;wrap&apos;, gap: 6 }}&gt;
 92:             {row.stepScores.map(s =&gt; (
 93:               &lt;StepScoreChip key={`${s.step}`} step={s.step} score={s.score} explanation={s.explanation} /&gt;
 94:             ))}
 95:           &lt;/div&gt;
 96:         &lt;/div&gt;
 97:       )}
 98: 
 99:       {row.toolVerifications &amp;&amp; row.toolVerifications.length &gt; 0 &amp;&amp; (
100:         &lt;div&gt;
101:           &lt;div className=&quot;section-label&quot; style={{ marginBottom: 6 }}&gt;Tool Verifications&lt;/div&gt;
102:           &lt;div style={{ display: &apos;flex&apos;, flexWrap: &apos;wrap&apos;, gap: 6 }}&gt;
103:             {row.toolVerifications.map((tv, i) =&gt; (
104:               &lt;ToolVerificationChip
105:                 key={`${tv.toolName}-${i}`}
106:                 toolName={tv.toolName}
107:                 toolCorrect={tv.toolCorrect}
108:                 argsCorrect={tv.argsCorrect}
109:                 score={tv.score}
110:                 index={i}
111:               /&gt;
112:             ))}
113:           &lt;/div&gt;
114:         &lt;/div&gt;
115:       )}
116: 
117:       {(row.traceId || row.sessionId) &amp;&amp; (
118:         &lt;div style={{ marginTop: 12, paddingTop: 12, borderTop: &apos;1px solid var(--border)&apos;, display: &apos;flex&apos;, gap: 16 }}&gt;
119:           {row.traceId &amp;&amp; (
120:             &lt;Link href={`/evaluations/trace/${row.traceId}`} className=&quot;back-link&quot; style={{ marginBottom: 0 }}&gt;
121:               View full evaluation detail &amp;rarr;
122:             &lt;/Link&gt;
123:           )}
124:           {row.sessionId ? (
125:             &lt;Link href={`/sessions/${row.sessionId}`} className=&quot;back-link&quot; style={{ marginBottom: 0 }}&gt;
126:               View trace spans &amp;rarr;
127:             &lt;/Link&gt;
128:           ) : row.traceId ? (
129:             &lt;Link href={`/traces/${row.traceId}`} className=&quot;back-link&quot; style={{ marginBottom: 0 }}&gt;
130:               View trace spans &amp;rarr;
131:             &lt;/Link&gt;
132:           ) : null}
133:         &lt;/div&gt;
134:       )}
135: 
136:       {!hasDetail &amp;&amp; !row.traceId &amp;&amp; !row.sessionId &amp;&amp; (
137:         &lt;div style={{ color: &apos;var(--text-muted)&apos;, fontSize: 13 }}&gt;
138:           No additional detail available.
139:         &lt;/div&gt;
140:       )}
141:     &lt;/div&gt;
142:   );
143: }</file><file path="src/pages/EvaluationDetailPage.tsx">  1: import { Link } from &apos;wouter&apos;;
  2: import { useTraceEvaluations } from &apos;../hooks/useTraceEvaluations.js&apos;;
  3: import { ScoreBadge } from &apos;../components/ScoreBadge.js&apos;;
  4: import { ChainOfThoughtPanel } from &apos;../components/ChainOfThoughtPanel.js&apos;;
  5: import { ProvenancePanel } from &apos;../components/ProvenancePanel.js&apos;;
  6: import { StepScoreChip } from &apos;../components/EvaluationExpandedRow.js&apos;;
  7: import { formatTimestamp } from &apos;../lib/quality-utils.js&apos;;
  8: 
  9: export function EvaluationDetailPage({ traceId }: { traceId: string }) {
 10:   const { data: allEvaluations, isLoading, error } = useTraceEvaluations(traceId);
 11: 
 12:   const metricFilter = new URLSearchParams(window.location.search).get(&apos;metric&apos;);
 13: 
 14:   const evaluations = metricFilter &amp;&amp; allEvaluations
 15:     ? allEvaluations.filter(ev =&gt; ev.evaluationName === metricFilter)
 16:     : allEvaluations;
 17: 
 18:   if (isLoading) {
 19:     return (
 20:       &lt;div&gt;
 21:         &lt;Link href=&quot;/&quot; className=&quot;back-link&quot;&gt;&amp;larr; Back to dashboard&lt;/Link&gt;
 22:         &lt;div className=&quot;card skeleton&quot; style={{ height: 200 }} /&gt;
 23:       &lt;/div&gt;
 24:     );
 25:   }
 26: 
 27:   if (error) {
 28:     return (
 29:       &lt;div&gt;
 30:         &lt;Link href=&quot;/&quot; className=&quot;back-link&quot;&gt;&amp;larr; Back to dashboard&lt;/Link&gt;
 31:         &lt;div className=&quot;error-state&quot;&gt;&lt;h2&gt;Failed to load&lt;/h2&gt;&lt;p&gt;{error.message}&lt;/p&gt;&lt;/div&gt;
 32:       &lt;/div&gt;
 33:     );
 34:   }
 35: 
 36:   if (!evaluations || evaluations.length === 0) {
 37:     return (
 38:       &lt;div&gt;
 39:         &lt;Link href=&quot;/&quot; className=&quot;back-link&quot;&gt;&amp;larr; Back to dashboard&lt;/Link&gt;
 40:         &lt;div className=&quot;empty-state&quot;&gt;
 41:           &lt;h2&gt;No Evaluations Found&lt;/h2&gt;
 42:           &lt;p&gt;No evaluations found for trace &lt;code&gt;{traceId}&lt;/code&gt;&lt;/p&gt;
 43:           &lt;p style={{ fontSize: 13, color: &apos;var(--text-muted)&apos;, marginTop: 8 }}&gt;
 44:             Evaluation data may not have been synced yet. Try again after the next sync cycle.
 45:           &lt;/p&gt;
 46:         &lt;/div&gt;
 47:       &lt;/div&gt;
 48:     );
 49:   }
 50: 
 51:   const heading = metricFilter
 52:     ? `${metricFilter} Evaluations`
 53:     : &apos;Trace Evaluations&apos;;
 54: 
 55:   return (
 56:     &lt;div&gt;
 57:       &lt;Link href=&quot;/&quot; className=&quot;back-link&quot;&gt;&amp;larr; Back to dashboard&lt;/Link&gt;
 58:       &lt;div className=&quot;eval-detail-header&quot;&gt;
 59:         &lt;h2 style={{ fontSize: 18 }}&gt;{heading}&lt;/h2&gt;
 60:         &lt;div className=&quot;eval-detail-meta&quot;&gt;
 61:           &lt;span style={{ fontFamily: &apos;var(--font-mono)&apos;, fontSize: 12, color: &apos;var(--text-secondary)&apos; }}&gt;
 62:             {traceId}
 63:           &lt;/span&gt;
 64:           &lt;span style={{ fontSize: 13, color: &apos;var(--text-secondary)&apos; }}&gt;
 65:             {evaluations.length} evaluation{evaluations.length !== 1 ? &apos;s&apos; : &apos;&apos;}
 66:           &lt;/span&gt;
 67:           &lt;Link href={`/traces/${traceId}`} style={{ fontSize: 12, color: &apos;var(--accent)&apos;, textDecoration: &apos;none&apos; }}&gt;
 68:             View trace &amp;rarr;
 69:           &lt;/Link&gt;
 70:           {metricFilter &amp;&amp; (
 71:             &lt;Link
 72:               href={`/evaluations/trace/${traceId}`}
 73:               style={{ fontSize: 12, color: &apos;var(--accent)&apos;, textDecoration: &apos;none&apos; }}
 74:             &gt;
 75:               View all evaluations
 76:             &lt;/Link&gt;
 77:           )}
 78:         &lt;/div&gt;
 79:       &lt;/div&gt;
 80: 
 81:       {evaluations.map((ev, i) =&gt; (
 82:         &lt;div key={`${ev.evaluationName}-${ev.timestamp}-${i}`} className=&quot;eval-detail-card card&quot;&gt;
 83:           &lt;div style={{ display: &apos;flex&apos;, justifyContent: &apos;space-between&apos;, alignItems: &apos;center&apos;, marginBottom: 12 }}&gt;
 84:             &lt;div style={{ display: &apos;flex&apos;, alignItems: &apos;center&apos;, gap: 12 }}&gt;
 85:               &lt;ScoreBadge
 86:                 score={ev.scoreValue ?? null}
 87:                 metricName={ev.evaluationName}
 88:                 label={ev.scoreLabel ?? (ev.scoreValue != null ? ev.scoreValue.toFixed(4) : undefined)}
 89:               /&gt;
 90:               &lt;span style={{ fontSize: 14, fontWeight: 500 }}&gt;{ev.evaluationName}&lt;/span&gt;
 91:             &lt;/div&gt;
 92:             &lt;span style={{ fontSize: 12, color: &apos;var(--text-secondary)&apos; }} title={new Date(ev.timestamp).toLocaleString()}&gt;
 93:               {formatTimestamp(ev.timestamp)}
 94:             &lt;/span&gt;
 95:           &lt;/div&gt;
 96: 
 97:           &lt;ChainOfThoughtPanel
 98:             explanation={ev.explanation}
 99:             evaluator={ev.evaluator}
100:             evaluatorType={ev.evaluatorType}
101:             scoreUnit={ev.scoreUnit}
102:           /&gt;
103: 
104:           {ev.stepScores &amp;&amp; ev.stepScores.length &gt; 0 &amp;&amp; (
105:             &lt;div style={{ marginTop: 12 }}&gt;
106:               &lt;div className=&quot;section-label&quot;&gt;Step Scores&lt;/div&gt;
107:               &lt;div style={{ display: &apos;flex&apos;, flexWrap: &apos;wrap&apos;, gap: 6, marginTop: 4 }}&gt;
108:                 {ev.stepScores.map(s =&gt; (
109:                   &lt;StepScoreChip key={`${s.step}`} step={s.step} score={s.score} explanation={s.explanation} /&gt;
110:                 ))}
111:               &lt;/div&gt;
112:             &lt;/div&gt;
113:           )}
114: 
115:           &lt;details open style={{ marginTop: 12 }}&gt;
116:             &lt;summary className=&quot;cot-summary&quot;&gt;Provenance &amp;amp; Audit Trail&lt;/summary&gt;
117:             &lt;div style={{ paddingTop: 8 }}&gt;
118:               &lt;ProvenancePanel
119:                 evaluationName={ev.evaluationName}
120:                 scoreValue={ev.scoreValue}
121:                 scoreLabel={ev.scoreLabel}
122:                 traceId={ev.traceId ?? traceId}
123:                 spanId={ev.spanId}
124:                 sessionId={ev.sessionId}
125:                 timestamp={ev.timestamp}
126:                 evaluator={ev.evaluator}
127:                 evaluatorType={ev.evaluatorType}
128:                 scoreUnit={ev.scoreUnit}
129:                 agentName={ev.agentName}
130:                 rawData={ev as unknown as Record&lt;string, unknown&gt;}
131:               /&gt;
132:             &lt;/div&gt;
133:           &lt;/details&gt;
134:         &lt;/div&gt;
135:       ))}
136:     &lt;/div&gt;
137:   );
138: }</file><file path="src/api/routes/agents.ts">  1: import { Hono } from &apos;hono&apos;;
  2: import { computeMultiAgentEvaluation } from &apos;../../../../dist/lib/quality-multi-agent.js&apos;;
  3: import { sanitizeErrorForResponse } from &apos;../../../../dist/lib/error-sanitizer.js&apos;;
  4: import { loadTracesBySessionId, loadEvaluationsByTraceIds } from &apos;../data-loader.js&apos;;
  5: import { queryTraces } from &apos;../../../../dist/tools/query-traces.js&apos;;
  6: import type { StepScore } from &apos;../../../../dist/backends/index.js&apos;;
  7: 
  8: export const agentRoutes = new Hono();
  9: 
 10: /**
 11:  * GET /api/agents?period=30d
 12:  * Returns aggregate agent stats across all sessions for the given period.
 13:  */
 14: const VALID_PERIODS: Record&lt;string, number&gt; = { &apos;24h&apos;: 1, &apos;7d&apos;: 7, &apos;30d&apos;: 30 };
 15: const MAX_IDS = 50;
 16: // &apos;unknown&apos; = attribute absent on span (explicit default); &apos;other&apos; = unrecognized value (clamped)
 17: const KNOWN_SOURCE_TYPES = new Set([&apos;active&apos;, &apos;lazy&apos;, &apos;builtin&apos;, &apos;skill&apos;, &apos;settings&apos;, &apos;unknown&apos;]);
 18: 
 19: agentRoutes.get(&apos;/agents&apos;, async (c) =&gt; {
 20:   const periodParam = c.req.query(&apos;period&apos;) ?? &apos;30d&apos;;
 21:   const periodDays = VALID_PERIODS[periodParam];
 22:   if (periodDays === undefined) {
 23:     return c.json({ error: `Invalid period value. Must be one of: ${Object.keys(VALID_PERIODS).join(&apos;, &apos;)}` }, 400);
 24:   }
 25:   const now = new Date();
 26:   const endDate = now.toISOString().split(&apos;T&apos;)[0];
 27:   const startDate = new Date(now.getTime() - periodDays * 24 * 60 * 60 * 1000).toISOString().split(&apos;T&apos;)[0];
 28: 
 29:   try {
 30:     const result = await queryTraces({
 31:       attributeFilter: { &apos;hook.name&apos;: &apos;agent-post-tool&apos; },
 32:       startDate,
 33:       endDate,
 34:       limit: 1000,
 35:     });
 36: 
 37:     // Build date bucket keys for the period (YYYY-MM-DD strings)
 38:     const dateBuckets: string[] = [];
 39:     for (let d = 0; d &lt; periodDays; d++) {
 40:       const day = new Date(now.getTime() - (periodDays - 1 - d) * 24 * 60 * 60 * 1000);
 41:       dateBuckets.push(day.toISOString().split(&apos;T&apos;)[0]);
 42:     }
 43:     const bucketIndex = new Map(dateBuckets.map((b, i) =&gt; [b, i]));
 44: 
 45:     // Phase 1: aggregate agent stats from spans (prototype-safe accumulators)
 46:     const acc: Record&lt;string, {
 47:       invocations: number;
 48:       errors: number;
 49:       rateLimitCount: number;
 50:       totalOutputSize: number;
 51:       sessions: Set&lt;string&gt;;
 52:       traceIds: Set&lt;string&gt;;
 53:       sourceTypes: Record&lt;string, number&gt;;
 54:       dailyCounts: number[];
 55:     }&gt; = Object.create(null);
 56: 
 57:     // Build traceId -&gt; agent names mapping for evaluation join
 58:     const traceToAgents = new Map&lt;string, Set&lt;string&gt;&gt;();
 59: 
 60:     for (const span of result.traces) {
 61:       const name = (span.attributes?.[&apos;gen_ai.agent.name&apos;] as string | undefined) ?? &apos;unknown&apos;;
 62:       if (!acc[name]) {
 63:         acc[name] = { invocations: 0, errors: 0, rateLimitCount: 0, totalOutputSize: 0, sessions: new Set(), traceIds: new Set(), sourceTypes: Object.create(null), dailyCounts: new Array(periodDays).fill(0) };
 64:       }
 65:       acc[name].invocations++;
 66:       // Bucket into daily counts
 67:       if (span.startTimeUnixNano) {
 68:         const dayKey = new Date(span.startTimeUnixNano / 1_000_000).toISOString().split(&apos;T&apos;)[0];
 69:         const idx = bucketIndex.get(dayKey);
 70:         if (idx !== undefined) acc[name].dailyCounts[idx]++;
 71:       }
 72:       if (span.attributes?.[&apos;agent.has_error&apos;]) acc[name].errors++;
 73:       if (span.attributes?.[&apos;agent.has_rate_limit&apos;]) acc[name].rateLimitCount++;
 74:       acc[name].totalOutputSize += (span.attributes?.[&apos;agent.output_size&apos;] as number | undefined) ?? 0;
 75:       const sid = span.attributes?.[&apos;session.id&apos;] as string | undefined;
 76:       if (sid) acc[name].sessions.add(sid);
 77:       if (span.traceId) {
 78:         acc[name].traceIds.add(span.traceId);
 79:         if (!traceToAgents.has(span.traceId)) traceToAgents.set(span.traceId, new Set());
 80:         traceToAgents.get(span.traceId)!.add(name);
 81:       }
 82:       const rawSrc = (span.attributes?.[&apos;agent.source_type&apos;] as string | undefined) ?? &apos;unknown&apos;;
 83:       const src = KNOWN_SOURCE_TYPES.has(rawSrc) ? rawSrc : &apos;other&apos;;
 84:       acc[name].sourceTypes[src] = (acc[name].sourceTypes[src] ?? 0) + 1;
 85:     }
 86: 
 87:     // Phase 2: load evaluations for all agent traceIds and join to agents
 88:     const allTraceIds = [...traceToAgents.keys()];
 89:     const evaluations = await loadEvaluationsByTraceIds(allTraceIds, startDate, endDate);
 90: 
 91:     // Accumulate per-agent evaluation scores by metric name (prototype-safe)
 92:     const agentEvalAcc: Record&lt;string, Record&lt;string, number[]&gt;&gt; = Object.create(null);
 93:     for (const ev of evaluations) {
 94:       if (!ev.traceId || ev.scoreValue == null || !Number.isFinite(ev.scoreValue)) continue;
 95:       const agentNames = traceToAgents.get(ev.traceId);
 96:       if (!agentNames) continue;
 97:       for (const agent of agentNames) {
 98:         if (!agentEvalAcc[agent]) agentEvalAcc[agent] = Object.create(null);
 99:         if (!agentEvalAcc[agent][ev.evaluationName]) agentEvalAcc[agent][ev.evaluationName] = [];
100:         agentEvalAcc[agent][ev.evaluationName].push(ev.scoreValue);
101:       }
102:     }
103: 
104:     const agents = Object.entries(acc).map(([agentName, d]) =&gt; {
105:       // Compute evaluation summary for this agent
106:       const evalMetrics = agentEvalAcc[agentName] ?? {};
107:       const evalSummary: Record&lt;string, { avg: number; min: number; max: number; count: number }&gt; = {};
108:       for (const [metric, scores] of Object.entries(evalMetrics)) {
109:         const sorted = [...scores].sort((a, b) =&gt; a - b);
110:         evalSummary[metric] = {
111:           avg: +(sorted.reduce((a, b) =&gt; a + b, 0) / sorted.length).toFixed(3),
112:           min: +sorted[0].toFixed(3),
113:           max: +sorted[sorted.length - 1].toFixed(3),
114:           count: sorted.length,
115:         };
116:       }
117: 
118:       const allSessionIds = [...d.sessions];
119:       const allTraceIdsList = [...d.traceIds];
120: 
121:       return {
122:         agentName,
123:         invocations: d.invocations,
124:         errors: d.errors,
125:         errorRate: d.invocations &gt; 0 ? +(d.errors / d.invocations).toFixed(3) : 0,
126:         rateLimitCount: d.rateLimitCount,
127:         avgOutputSize: d.invocations &gt; 0 ? Math.round(d.totalOutputSize / d.invocations) : 0,
128:         sessionCount: d.sessions.size,  // total unique sessions (invariant: &gt;= sessionIds.length)
129:         sessionIds: allSessionIds.slice(0, MAX_IDS),
130:         sessionIdsTruncated: allSessionIds.length &gt; MAX_IDS,
131:         traceIdsTotal: allTraceIdsList.length,
132:         traceIds: allTraceIdsList.slice(0, MAX_IDS),
133:         traceIdsTruncated: allTraceIdsList.length &gt; MAX_IDS,
134:         sourceTypes: d.sourceTypes,
135:         dailyCounts: d.dailyCounts,
136:         evalSummary,
137:       };
138:     }).sort((a, b) =&gt; b.invocations - a.invocations);
139: 
140:     return c.json({ period: periodParam, startDate, endDate, agents });
141:   } catch (err) {
142:     return c.json({ error: sanitizeErrorForResponse(err) }, 500);
143:   }
144: });
145: 
146: /**
147:  * GET /api/agents/:sessionId
148:  * Loads spans for a session, builds agentMap, computes multi-agent evaluation.
149:  */
150: agentRoutes.get(&apos;/agents/:sessionId&apos;, async (c) =&gt; {
151:   const sessionId = c.req.param(&apos;sessionId&apos;);
152:   if (!sessionId) {
153:     return c.json({ error: &apos;sessionId is required&apos; }, 400);
154:   }
155: 
156:   try {
157:     const spans = await loadTracesBySessionId(sessionId);
158: 
159:     // Build agentMap from span attributes
160:     const agentMap = new Map&lt;number, string&gt;();
161:     const traceIds = new Set&lt;string&gt;();
162:     spans.forEach((span, i) =&gt; {
163:       const agent = span.attributes?.[&apos;agent.name&apos;] as string | undefined;
164:       if (agent) agentMap.set(i, agent);
165:       if (span.traceId) traceIds.add(span.traceId);
166:     });
167: 
168:     // Build step scores from spans
169:     const stepScores: StepScore[] = spans.map((span, i) =&gt; ({
170:       step: i,
171:       score: typeof span.attributes?.[&apos;evaluation.score&apos;] === &apos;number&apos;
172:         ? span.attributes[&apos;evaluation.score&apos;] as number
173:         : (span.status?.code === 2 ? 0 : 1),
174:       explanation: span.name,
175:     }));
176: 
177:     // Compute multi-agent evaluation
178:     const evaluation = computeMultiAgentEvaluation(stepScores, agentMap);
179: 
180:     // Bulk-load evaluations for all traces in the session
181:     const evaluations = await loadEvaluationsByTraceIds([...traceIds]);
182: 
183:     return c.json({
184:       sessionId,
185:       spans,
186:       evaluation,
187:       evaluations,
188:       agentMap: Object.fromEntries(agentMap),
189:     });
190:   } catch (err) {
191:     return c.json({ error: sanitizeErrorForResponse(err) }, 500);
192:   }
193: });</file><file path="src/api/data-loader.ts">  1: import { MultiDirectoryBackend } from &apos;../../../dist/backends/local-jsonl.js&apos;;
  2: import type { EvaluationResult, TraceSpan } from &apos;../../../dist/backends/index.js&apos;;
  3: import { queryVerifications as queryVerificationsLib, type HumanVerificationEvent, type VerificationQueryOptions } from &apos;../../../dist/lib/verification-events.js&apos;;
  4: import { queryTraces as queryTracesTool } from &apos;../../../dist/tools/query-traces.js&apos;;
  5: 
  6: let backend: MultiDirectoryBackend | undefined;
  7: 
  8: function getBackend(): MultiDirectoryBackend {
  9:   if (!backend) {
 10:     backend = new MultiDirectoryBackend(undefined, true);
 11:   }
 12:   return backend;
 13: }
 14: 
 15: /** Convert ISO timestamp or date string to YYYY-MM-DD */
 16: function toDateOnly(d: string): string {
 17:   return d.split(&apos;T&apos;)[0];
 18: }
 19: 
 20: export async function loadEvaluationsByMetric(
 21:   start: string,
 22:   end: string
 23: ): Promise&lt;Map&lt;string, EvaluationResult[]&gt;&gt; {
 24:   const be = getBackend();
 25:   const evals = await be.queryEvaluations({ startDate: start, endDate: end, limit: 100_000 });
 26:   const grouped = new Map&lt;string, EvaluationResult[]&gt;();
 27:   for (const ev of evals) {
 28:     const name = ev.evaluationName;
 29:     if (!grouped.has(name)) grouped.set(name, []);
 30:     grouped.get(name)!.push(ev);
 31:   }
 32:   return grouped;
 33: }
 34: 
 35: export async function loadEvaluationsForMetric(
 36:   metricName: string,
 37:   start: string,
 38:   end: string
 39: ): Promise&lt;EvaluationResult[]&gt; {
 40:   const be = getBackend();
 41:   return be.queryEvaluations({
 42:     startDate: start,
 43:     endDate: end,
 44:     evaluationName: metricName,
 45:     limit: 10000,
 46:   });
 47: }
 48: 
 49: export async function loadEvaluationsByTraceId(
 50:   traceId: string,
 51:   startDate?: string,
 52:   endDate?: string,
 53: ): Promise&lt;EvaluationResult[]&gt; {
 54:   const be = getBackend();
 55:   const now = new Date();
 56:   return be.queryEvaluations({
 57:     traceId,
 58:     startDate: startDate ?? new Date(now.getTime() - 90 * 24 * 60 * 60 * 1000).toISOString(),
 59:     endDate: endDate ?? now.toISOString(),
 60:     limit: 1000,
 61:   });
 62: }
 63: 
 64: /**
 65:  * Loads evaluations matching any of the given traceIds.
 66:  * NOTE: O(all_evals) — fetches all evaluations for the date range then
 67:  * filters in memory because the backend lacks a multi-traceId query.
 68:  * Callers should keep date ranges narrow to limit the scan cost.
 69:  */
 70: export async function loadEvaluationsByTraceIds(
 71:   traceIds: string[],
 72:   startDate?: string,
 73:   endDate?: string
 74: ): Promise&lt;EvaluationResult[]&gt; {
 75:   if (traceIds.length === 0) return [];
 76:   const be = getBackend();
 77:   const now = new Date();
 78:   const start = startDate ?? new Date(now.getTime() - 7 * 24 * 60 * 60 * 1000).toISOString();
 79:   const end = endDate ?? now.toISOString();
 80:   const allEvals = await be.queryEvaluations({
 81:     startDate: start,
 82:     endDate: end,
 83:     limit: 10000,
 84:   });
 85:   const idSet = new Set(traceIds);
 86:   return allEvals.filter(e =&gt; e.traceId &amp;&amp; idSet.has(e.traceId));
 87: }
 88: 
 89: export async function loadTracesByTraceId(
 90:   traceId: string,
 91:   startDate?: string,
 92:   endDate?: string,
 93: ) {
 94:   const now = new Date();
 95:   const start = startDate ? toDateOnly(startDate)
 96:     : toDateOnly(new Date(now.getTime() - 30 * 24 * 60 * 60 * 1000).toISOString());
 97:   const end = endDate ? toDateOnly(endDate) : toDateOnly(now.toISOString());
 98:   const result = await queryTracesTool({
 99:     traceId,
100:     startDate: start,
101:     endDate: end,
102:     limit: 500,
103:   });
104:   return result.traces;
105: }
106: 
107: export async function loadTracesBySessionId(
108:   sessionId: string,
109:   startDate?: string,
110:   endDate?: string,
111: ) {
112:   const now = new Date();
113:   const start = startDate ? toDateOnly(startDate)
114:     : toDateOnly(new Date(now.getTime() - 30 * 24 * 60 * 60 * 1000).toISOString());
115:   const end = endDate ? toDateOnly(endDate) : toDateOnly(now.toISOString());
116:   const result = await queryTracesTool({
117:     attributeFilter: { &apos;session.id&apos;: sessionId },
118:     startDate: start,
119:     endDate: end,
120:     limit: 500,
121:   });
122:   return result.traces;
123: }
124: 
125: export async function loadLogsByTraceId(
126:   traceId: string,
127:   startDate?: string,
128:   endDate?: string,
129: ): Promise&lt;Awaited&lt;ReturnType&lt;MultiDirectoryBackend[&apos;queryLogs&apos;]&gt;&gt;&gt; {
130:   const { queryLogs } = await import(&apos;../../../dist/tools/query-logs.js&apos;);
131:   const now = new Date();
132:   const start = startDate ? toDateOnly(startDate)
133:     : toDateOnly(new Date(now.getTime() - 30 * 24 * 60 * 60 * 1000).toISOString());
134:   const end = endDate ? toDateOnly(endDate) : toDateOnly(now.toISOString());
135:   const result = await queryLogs({
136:     traceId,
137:     startDate: start,
138:     endDate: end,
139:     limit: 1000,
140:   });
141:   return result.logs;
142: }
143: 
144: export async function loadVerifications(opts: {
145:   startDate?: string;
146:   endDate?: string;
147:   sessionId?: string;
148:   limit?: number;
149: }): Promise&lt;HumanVerificationEvent[]&gt; {
150:   const now = new Date();
151:   const ninetyDaysAgo = new Date(now.getTime() - 90 * 24 * 60 * 60 * 1000);
152:   return queryVerificationsLib({
153:     startDate: opts.startDate ?? ninetyDaysAgo.toISOString(),
154:     endDate: opts.endDate ?? now.toISOString(),
155:     sessionId: opts.sessionId,
156:     limit: opts.limit ?? 1000,
157:   });
158: }
159: 
160: export async function loadLogsBySessionId(
161:   sessionId: string,
162:   startDate?: string,
163:   endDate?: string,
164: ): Promise&lt;Awaited&lt;ReturnType&lt;MultiDirectoryBackend[&apos;queryLogs&apos;]&gt;&gt;&gt; {
165:   const { queryLogs } = await import(&apos;../../../dist/tools/query-logs.js&apos;);
166:   const now = new Date();
167:   const start = startDate ? toDateOnly(startDate)
168:     : toDateOnly(new Date(now.getTime() - 30 * 24 * 60 * 60 * 1000).toISOString());
169:   const end = endDate ? toDateOnly(endDate) : toDateOnly(now.toISOString());
170:   const result = await queryLogs({
171:     sessionId,
172:     startDate: start,
173:     endDate: end,
174:     limit: 1000,
175:   });
176:   return result.logs;
177: }
178: 
179: export async function loadEvaluationsBySessionId(
180:   sessionId: string,
181:   startDate?: string,
182:   endDate?: string,
183: ): Promise&lt;EvaluationResult[]&gt; {
184:   const be = getBackend();
185:   const now = new Date();
186:   return be.queryEvaluations({
187:     sessionId,
188:     startDate: startDate ?? new Date(now.getTime() - 30 * 24 * 60 * 60 * 1000).toISOString(),
189:     endDate: endDate ?? now.toISOString(),
190:     limit: 10000,
191:   });
192: }
193: 
194: export async function checkHealth(): Promise&lt;{ status: string; hasData: boolean }&gt; {
195:   const be = getBackend();
196:   const health = await be.healthCheck();
197:   const now = new Date();
198:   const weekAgo = new Date(now.getTime() - 7 * 24 * 60 * 60 * 1000);
199:   const evals = await be.queryEvaluations({
200:     startDate: weekAgo.toISOString(),
201:     endDate: now.toISOString(),
202:     limit: 1,
203:   });
204:   return { status: health.status, hasData: evals.length &gt; 0 };
205: }</file><file path="src/api/server.ts"> 1: import { Hono } from &apos;hono&apos;;
 2: import { cors } from &apos;hono/cors&apos;;
 3: import { serve } from &apos;@hono/node-server&apos;;
 4: import { dashboardRoutes } from &apos;./routes/dashboard.js&apos;;
 5: import { metricsRoutes } from &apos;./routes/metrics.js&apos;;
 6: import { correlationRoutes } from &apos;./routes/correlations.js&apos;;
 7: import { evaluationRoutes } from &apos;./routes/evaluations.js&apos;;
 8: import { trendRoutes } from &apos;./routes/trends.js&apos;;
 9: import { coverageRoutes } from &apos;./routes/coverage.js&apos;;
10: import { pipelineRoutes } from &apos;./routes/pipeline.js&apos;;
11: import { complianceRoutes } from &apos;./routes/compliance.js&apos;;
12: import { traceRoutes } from &apos;./routes/traces.js&apos;;
13: import { agentRoutes } from &apos;./routes/agents.js&apos;;
14: import { sessionRoutes } from &apos;./routes/sessions.js&apos;;
15: import { qualityRoutes } from &apos;./routes/quality.js&apos;;
16: 
17: const app = new Hono();
18: 
19: app.use(&apos;/*&apos;, cors({ origin: process.env.CORS_ORIGIN || &apos;http://localhost:5173&apos; }));
20: 
21: app.route(&apos;/api&apos;, dashboardRoutes);
22: app.route(&apos;/api&apos;, metricsRoutes);
23: app.route(&apos;/api&apos;, correlationRoutes);
24: app.route(&apos;/api&apos;, evaluationRoutes);
25: app.route(&apos;/api&apos;, trendRoutes);
26: app.route(&apos;/api&apos;, coverageRoutes);
27: app.route(&apos;/api&apos;, pipelineRoutes);
28: app.route(&apos;/api&apos;, complianceRoutes);
29: app.route(&apos;/api&apos;, traceRoutes);
30: app.route(&apos;/api&apos;, agentRoutes);
31: app.route(&apos;/api&apos;, sessionRoutes);
32: app.route(&apos;/api&apos;, qualityRoutes);
33: 
34: const port = 3001;
35: console.log(`API server listening on http://127.0.0.1:${port}`);
36: 
37: serve({ fetch: app.fetch, hostname: &apos;127.0.0.1&apos;, port });</file><file path="src/App.tsx">  1: import { useState, useCallback } from &apos;react&apos;;
  2: import { Route, Switch, Link, useLocation, Router } from &apos;wouter&apos;;
  3: import { ErrorBoundary } from &apos;react-error-boundary&apos;;
  4: import { Layout } from &apos;./components/Layout.js&apos;;
  5: import { RoleSelector } from &apos;./components/RoleSelector.js&apos;;
  6: import { KeyboardNavProvider, useShortcut } from &apos;./contexts/KeyboardNavContext.js&apos;;
  7: import { HealthOverview } from &apos;./components/HealthOverview.js&apos;;
  8: import { MetricGrid, MetricGridSkeleton } from &apos;./components/MetricGrid.js&apos;;
  9: import { AlertList } from &apos;./components/AlertList.js&apos;;
 10: import { SLATable } from &apos;./components/SLATable.js&apos;;
 11: import { ScoreHistogram } from &apos;./components/ScoreHistogram.js&apos;;
 12: import { EvaluationDetail } from &apos;./components/EvaluationDetail.js&apos;;
 13: import { StatusBadge, TrendIndicator, ConfidenceBadge } from &apos;./components/Indicators.js&apos;;
 14: import { TrendChart } from &apos;./components/TrendChart.js&apos;;
 15: import { TrendSeries } from &apos;./components/TrendSeries.js&apos;;
 16: import { ConfidencePanel } from &apos;./components/ConfidencePanel.js&apos;;
 17: import { CorrelationsPage } from &apos;./pages/CorrelationsPage.js&apos;;
 18: import { CoveragePage } from &apos;./pages/CoveragePage.js&apos;;
 19: import { PipelinePage } from &apos;./pages/PipelinePage.js&apos;;
 20: import { EvaluationDetailPage } from &apos;./pages/EvaluationDetailPage.js&apos;;
 21: import { CompliancePage } from &apos;./pages/CompliancePage.js&apos;;
 22: import { TraceDetailPage } from &apos;./pages/TraceDetailPage.js&apos;;
 23: import { AgentSessionPage } from &apos;./pages/AgentSessionPage.js&apos;;
 24: import { AgentsPage } from &apos;./pages/AgentsPage.js&apos;;
 25: import { SessionDetailPage } from &apos;./pages/SessionDetailPage.js&apos;;
 26: import { ExecutiveView } from &apos;./components/views/ExecutiveView.js&apos;;
 27: import { OperatorView } from &apos;./components/views/OperatorView.js&apos;;
 28: import { AuditorView } from &apos;./components/views/AuditorView.js&apos;;
 29: import { useDashboard } from &apos;./hooks/useDashboard.js&apos;;
 30: import { useMetricDetail } from &apos;./hooks/useMetricDetail.js&apos;;
 31: import { useTrend } from &apos;./hooks/useTrend.js&apos;;
 32: import { RoleProvider } from &apos;./contexts/RoleContext.js&apos;;
 33: import type {
 34:   Period,
 35:   QualityDashboardSummary,
 36:   RoleViewType,
 37:   ExecutiveView as ExecutiveViewType,
 38:   OperatorView as OperatorViewType,
 39:   AuditorView as AuditorViewType,
 40:   MetricDetailResult,
 41:   MetricDynamics,
 42: } from &apos;./types.js&apos;;
 43: 
 44: function DashboardPage({ period }: { period: Period }) {
 45:   const { data, isLoading, isFetching, error } = useDashboard(period);
 46: 
 47:   if (isLoading &amp;&amp; !data) return &lt;MetricGridSkeleton /&gt;;
 48:   if (error &amp;&amp; !data) return &lt;div className=&quot;error-state&quot;&gt;&lt;h2&gt;Failed to load&lt;/h2&gt;&lt;p&gt;{error.message}&lt;/p&gt;&lt;/div&gt;;
 49: 
 50:   if (!data || (&apos;role&apos; in data)) return &lt;MetricGridSkeleton /&gt;;
 51:   const dashboard = data;
 52:   const sparklines = (data as QualityDashboardSummary &amp; { sparklines?: Record&lt;string, (number | null)[]&gt; }).sparklines;
 53: 
 54:   if (dashboard.overallStatus === &apos;no_data&apos;) {
 55:     return (
 56:       &lt;div className=&quot;empty-state&quot;&gt;
 57:         &lt;h2&gt;No Evaluation Data&lt;/h2&gt;
 58:         &lt;p&gt;No evaluations found for the selected period.&lt;/p&gt;
 59:         &lt;p style={{ marginTop: 8 }}&gt;
 60:           Run evaluations using the &lt;code&gt;obs_inject_evaluations&lt;/code&gt; tool to see metrics here.
 61:         &lt;/p&gt;
 62:       &lt;/div&gt;
 63:     );
 64:   }
 65: 
 66:   return (
 67:     &lt;&gt;
 68:       {isFetching &amp;&amp; data &amp;&amp; &lt;div className=&quot;refetch-indicator&quot;&gt;Updating...&lt;/div&gt;}
 69:       &lt;HealthOverview dashboard={dashboard} /&gt;
 70:       &lt;MetricGrid metrics={dashboard.metrics} sparklines={sparklines} /&gt;
 71:       {dashboard.alerts.length &gt; 0 &amp;&amp; (
 72:         &lt;div className=&quot;view-section&quot;&gt;
 73:           &lt;h3 className=&quot;section-heading&quot;&gt;Active Alerts&lt;/h3&gt;
 74:           &lt;AlertList alerts={dashboard.alerts} /&gt;
 75:         &lt;/div&gt;
 76:       )}
 77:       {dashboard.slaCompliance &amp;&amp; dashboard.slaCompliance.length &gt; 0 &amp;&amp; (
 78:         &lt;div className=&quot;view-section&quot;&gt;
 79:           &lt;h3 className=&quot;section-heading&quot;&gt;SLA Compliance&lt;/h3&gt;
 80:           &lt;SLATable slas={dashboard.slaCompliance} /&gt;
 81:         &lt;/div&gt;
 82:       )}
 83:     &lt;/&gt;
 84:   );
 85: }
 86: 
 87: function RolePage({ role, period }: { role: RoleViewType; period: Period }) {
 88:   const { data, isLoading, error } = useDashboard(period, role);
 89: 
 90:   if (isLoading &amp;&amp; !data) return &lt;MetricGridSkeleton /&gt;;
 91:   if (error &amp;&amp; !data) return &lt;div className=&quot;error-state&quot;&gt;&lt;h2&gt;Failed to load&lt;/h2&gt;&lt;p&gt;{error.message}&lt;/p&gt;&lt;/div&gt;;
 92:   if (!data || !(&apos;role&apos; in data)) return &lt;MetricGridSkeleton /&gt;;
 93: 
 94:   switch (data.role) {
 95:     case &apos;executive&apos;:
 96:       return &lt;ExecutiveView data={data} /&gt;;
 97:     case &apos;operator&apos;:
 98:       return &lt;OperatorView data={data} /&gt;;
 99:     case &apos;auditor&apos;:
100:       return &lt;AuditorView data={data} /&gt;;
101:     default:
102:       return null;
103:   }
104: }
105: 
106: function MetricDetailPage({ name, period }: { name: string; period: Period }) {
107:   const { data, isLoading, error } = useMetricDetail(name, period);
108:   const { data: trendData } = useTrend(name, period, 10);
109: 
110:   if (isLoading) {
111:     return (
112:       &lt;div&gt;
113:         &lt;Link href=&quot;/&quot; className=&quot;back-link&quot;&gt;&amp;larr; Back to dashboard&lt;/Link&gt;
114:         &lt;div className=&quot;card skeleton&quot; style={{ height: 300 }} /&gt;
115:       &lt;/div&gt;
116:     );
117:   }
118:   if (error) {
119:     return (
120:       &lt;div&gt;
121:         &lt;Link href=&quot;/&quot; className=&quot;back-link&quot;&gt;&amp;larr; Back to dashboard&lt;/Link&gt;
122:         &lt;div className=&quot;error-state&quot;&gt;&lt;h2&gt;Failed to load&lt;/h2&gt;&lt;p&gt;{error.message}&lt;/p&gt;&lt;/div&gt;
123:       &lt;/div&gt;
124:     );
125:   }
126: 
127:   if (!data) return null;
128:   const detail = data;
129: 
130:   return (
131:     &lt;div&gt;
132:       &lt;Link href=&quot;/&quot; className=&quot;back-link&quot;&gt;&amp;larr; Back to dashboard&lt;/Link&gt;
133:       &lt;div className=&quot;card&quot; style={{ marginBottom: 24 }}&gt;
134:         &lt;div className=&quot;metric-card-header&quot;&gt;
135:           &lt;h2 style={{ fontSize: 18 }}&gt;{detail.displayName}&lt;/h2&gt;
136:           &lt;StatusBadge status={detail.status} /&gt;
137:         &lt;/div&gt;
138:         &lt;div style={{ display: &apos;flex&apos;, gap: 32, marginTop: 12, flexWrap: &apos;wrap&apos; }}&gt;
139:           {([&apos;avg&apos;, &apos;min&apos;, &apos;max&apos;, &apos;p50&apos;, &apos;p95&apos;, &apos;p99&apos;] as const).map((key) =&gt; {
140:             const val = detail.values[key];
141:             return (
142:               &lt;div key={key} style={{ textAlign: &apos;center&apos; }}&gt;
143:                 &lt;div style={{ fontFamily: &apos;var(--font-mono)&apos;, fontSize: 20, fontWeight: 600 }}&gt;
144:                   {val !== null &amp;&amp; val !== undefined ? val.toFixed(4) : &apos;N/A&apos;}
145:                 &lt;/div&gt;
146:                 &lt;div style={{ fontSize: 12, color: &apos;var(--text-secondary)&apos;, textTransform: &apos;uppercase&apos; }}&gt;{key}&lt;/div&gt;
147:               &lt;/div&gt;
148:             );
149:           })}
150:           &lt;div style={{ textAlign: &apos;center&apos; }}&gt;
151:             &lt;div style={{ fontFamily: &apos;var(--font-mono)&apos;, fontSize: 20, fontWeight: 600 }}&gt;{detail.sampleCount}&lt;/div&gt;
152:             &lt;div style={{ fontSize: 12, color: &apos;var(--text-secondary)&apos;, textTransform: &apos;uppercase&apos; }}&gt;samples&lt;/div&gt;
153:           &lt;/div&gt;
154:         &lt;/div&gt;
155:         &lt;div style={{ display: &apos;flex&apos;, gap: 16, marginTop: 12, alignItems: &apos;center&apos; }}&gt;
156:           &lt;TrendIndicator trend={detail.trend} /&gt;
157:           &lt;ConfidenceBadge confidence={detail.confidence} /&gt;
158:         &lt;/div&gt;
159:       &lt;/div&gt;
160: 
161:       {detail.confidence &amp;&amp; (
162:         &lt;div className=&quot;view-section&quot;&gt;
163:           &lt;h3 className=&quot;section-heading&quot;&gt;Confidence Analysis&lt;/h3&gt;
164:           &lt;div className=&quot;card&quot;&gt;
165:             &lt;ConfidencePanel confidence={detail.confidence} /&gt;
166:           &lt;/div&gt;
167:         &lt;/div&gt;
168:       )}
169: 
170:       &lt;div className=&quot;view-section&quot;&gt;
171:         &lt;h3 className=&quot;section-heading&quot;&gt;Trend&lt;/h3&gt;
172:         &lt;div className=&quot;card&quot;&gt;
173:           &lt;TrendChart
174:             trend={detail.trend}
175:             dynamics={(detail as MetricDetailResult &amp; { dynamics?: MetricDynamics }).dynamics}
176:             warningThreshold={detail.alerts.find(a =&gt; a.severity === &apos;warning&apos;)?.threshold}
177:             criticalThreshold={detail.alerts.find(a =&gt; a.severity === &apos;critical&apos;)?.threshold}
178:             metricName={detail.displayName}
179:           /&gt;
180:         &lt;/div&gt;
181:       &lt;/div&gt;
182: 
183:       {trendData &amp;&amp; trendData.trendData.length &gt; 0 &amp;&amp; (
184:         &lt;div className=&quot;view-section&quot;&gt;
185:           &lt;h3 className=&quot;section-heading&quot;&gt;
186:             Time Series ({trendData.totalEvaluations} evaluations)
187:             {trendData.narrowed &amp;&amp; (
188:               &lt;span style={{
189:                 fontSize: 11,
190:                 fontWeight: 400,
191:                 color: &apos;var(--text-muted)&apos;,
192:                 marginLeft: 8,
193:               }}&gt;auto-narrowed to data range&lt;/span&gt;
194:             )}
195:           &lt;/h3&gt;
196:           &lt;div className=&quot;card&quot;&gt;
197:             &lt;TrendSeries data={trendData.trendData} metricName={detail.displayName} /&gt;
198:           &lt;/div&gt;
199:         &lt;/div&gt;
200:       )}
201: 
202:       {detail.alerts.length &gt; 0 &amp;&amp; (
203:         &lt;div className=&quot;view-section&quot;&gt;
204:           &lt;h3 className=&quot;section-heading&quot;&gt;Alerts&lt;/h3&gt;
205:           &lt;AlertList alerts={detail.alerts} /&gt;
206:         &lt;/div&gt;
207:       )}
208: 
209:       &lt;div className=&quot;view-section&quot;&gt;
210:         &lt;h3 className=&quot;section-heading&quot;&gt;Score Distribution&lt;/h3&gt;
211:         &lt;div className=&quot;card&quot;&gt;
212:           &lt;ScoreHistogram distribution={detail.scoreDistribution} /&gt;
213:         &lt;/div&gt;
214:       &lt;/div&gt;
215: 
216:       &lt;div className=&quot;view-section&quot;&gt;
217:         &lt;h3 className=&quot;section-heading&quot;&gt;Evaluations&lt;/h3&gt;
218:         &lt;div className=&quot;card&quot;&gt;
219:           &lt;EvaluationDetail worst={detail.worstEvaluations} best={detail.bestEvaluations} metricName={name} period={period} /&gt;
220:         &lt;/div&gt;
221:       &lt;/div&gt;
222:     &lt;/div&gt;
223:   );
224: }
225: 
226: function RouteErrorFallback({ error, resetErrorBoundary }: { error: Error; resetErrorBoundary: () =&gt; void }) {
227:   return (
228:     &lt;div className=&quot;error-state&quot;&gt;
229:       &lt;h2&gt;Something went wrong&lt;/h2&gt;
230:       &lt;p&gt;{error.message}&lt;/p&gt;
231:       &lt;div className=&quot;error-actions&quot;&gt;
232:         &lt;button onClick={resetErrorBoundary}&gt;Try again&lt;/button&gt;
233:         &lt;Link href=&quot;/&quot;&gt;Back to dashboard&lt;/Link&gt;
234:       &lt;/div&gt;
235:     &lt;/div&gt;
236:   );
237: }
238: 
239: function GlobalShortcuts({ setPeriod, navigate }: {
240:   setPeriod: (p: Period) =&gt; void;
241:   navigate: (path: string) =&gt; void;
242: }) {
243:   useShortcut(&apos;1&apos;, &apos;Switch to 24h&apos;, &apos;Period&apos;, useCallback(() =&gt; setPeriod(&apos;24h&apos;), [setPeriod]));
244:   useShortcut(&apos;2&apos;, &apos;Switch to 7d&apos;, &apos;Period&apos;, useCallback(() =&gt; setPeriod(&apos;7d&apos;), [setPeriod]));
245:   useShortcut(&apos;3&apos;, &apos;Switch to 30d&apos;, &apos;Period&apos;, useCallback(() =&gt; setPeriod(&apos;30d&apos;), [setPeriod]));
246:   useShortcut(&apos;g h&apos;, &apos;Go to home&apos;, &apos;Navigation&apos;, useCallback(() =&gt; navigate(&apos;/&apos;), [navigate]));
247:   useShortcut(&apos;g c&apos;, &apos;Go to correlations&apos;, &apos;Navigation&apos;, useCallback(() =&gt; navigate(&apos;/correlations&apos;), [navigate]));
248:   useShortcut(&apos;g p&apos;, &apos;Go to pipeline&apos;, &apos;Navigation&apos;, useCallback(() =&gt; navigate(&apos;/pipeline&apos;), [navigate]));
249:   useShortcut(&apos;g v&apos;, &apos;Go to coverage&apos;, &apos;Navigation&apos;, useCallback(() =&gt; navigate(&apos;/coverage&apos;), [navigate]));
250:   useShortcut(&apos;g a&apos;, &apos;Go to agents&apos;, &apos;Navigation&apos;, useCallback(() =&gt; navigate(&apos;/agents&apos;), [navigate]));
251:   return null;
252: }
253: 
254: const BASE_PATH = import.meta.env.BASE_URL.replace(/\/$/, &apos;&apos;) || &apos;&apos;;
255: 
256: export function App() {
257:   const [period, setPeriod] = useState&lt;Period&gt;(&apos;30d&apos;);
258:   const [location, navigate] = useLocation();
259: 
260:   return (
261:     &lt;Router base={BASE_PATH}&gt;
262:     &lt;KeyboardNavProvider&gt;
263:     &lt;RoleProvider&gt;
264:     &lt;GlobalShortcuts setPeriod={setPeriod} navigate={navigate} /&gt;
265:     &lt;Layout period={period} onPeriodChange={setPeriod}&gt;
266:       &lt;RoleSelector /&gt;
267:       &lt;Switch&gt;
268:         &lt;Route path=&quot;/&quot;&gt;
269:           &lt;ErrorBoundary FallbackComponent={RouteErrorFallback} resetKeys={[location]}&gt;
270:             &lt;DashboardPage period={period} /&gt;
271:           &lt;/ErrorBoundary&gt;
272:         &lt;/Route&gt;
273:         &lt;Route path=&quot;/role/:roleName&quot;&gt;
274:           {(params) =&gt; (
275:             &lt;ErrorBoundary FallbackComponent={RouteErrorFallback} resetKeys={[location]}&gt;
276:               &lt;RolePage role={params.roleName as RoleViewType} period={period} /&gt;
277:             &lt;/ErrorBoundary&gt;
278:           )}
279:         &lt;/Route&gt;
280:         &lt;Route path=&quot;/metrics/:metricName&quot;&gt;
281:           {(params) =&gt; (
282:             &lt;ErrorBoundary FallbackComponent={RouteErrorFallback} resetKeys={[location]}&gt;
283:               &lt;MetricDetailPage name={params.metricName} period={period} /&gt;
284:             &lt;/ErrorBoundary&gt;
285:           )}
286:         &lt;/Route&gt;
287:         &lt;Route path=&quot;/evaluations/trace/:traceId&quot;&gt;
288:           {(params) =&gt; (
289:             &lt;ErrorBoundary FallbackComponent={RouteErrorFallback} resetKeys={[location]}&gt;
290:               &lt;EvaluationDetailPage traceId={params.traceId} /&gt;
291:             &lt;/ErrorBoundary&gt;
292:           )}
293:         &lt;/Route&gt;
294:         &lt;Route path=&quot;/correlations&quot;&gt;
295:           &lt;ErrorBoundary FallbackComponent={RouteErrorFallback} resetKeys={[location]}&gt;
296:             &lt;CorrelationsPage period={period} /&gt;
297:           &lt;/ErrorBoundary&gt;
298:         &lt;/Route&gt;
299:         &lt;Route path=&quot;/coverage&quot;&gt;
300:           &lt;ErrorBoundary FallbackComponent={RouteErrorFallback} resetKeys={[location]}&gt;
301:             &lt;CoveragePage period={period} /&gt;
302:           &lt;/ErrorBoundary&gt;
303:         &lt;/Route&gt;
304:         &lt;Route path=&quot;/pipeline&quot;&gt;
305:           &lt;ErrorBoundary FallbackComponent={RouteErrorFallback} resetKeys={[location]}&gt;
306:             &lt;PipelinePage period={period} /&gt;
307:           &lt;/ErrorBoundary&gt;
308:         &lt;/Route&gt;
309:         &lt;Route path=&quot;/compliance&quot;&gt;
310:           &lt;ErrorBoundary FallbackComponent={RouteErrorFallback} resetKeys={[location]}&gt;
311:             &lt;CompliancePage period={period} /&gt;
312:           &lt;/ErrorBoundary&gt;
313:         &lt;/Route&gt;
314:         &lt;Route path=&quot;/agents&quot;&gt;
315:           &lt;ErrorBoundary FallbackComponent={RouteErrorFallback} resetKeys={[location]}&gt;
316:             &lt;AgentsPage period={period} /&gt;
317:           &lt;/ErrorBoundary&gt;
318:         &lt;/Route&gt;
319:         &lt;Route path=&quot;/traces/:traceId&quot;&gt;
320:           {(params) =&gt; (
321:             &lt;ErrorBoundary FallbackComponent={RouteErrorFallback} resetKeys={[location]}&gt;
322:               &lt;TraceDetailPage traceId={params.traceId} /&gt;
323:             &lt;/ErrorBoundary&gt;
324:           )}
325:         &lt;/Route&gt;
326:         &lt;Route path=&quot;/agents/:sessionId&quot;&gt;
327:           {(params) =&gt; (
328:             &lt;ErrorBoundary FallbackComponent={RouteErrorFallback} resetKeys={[location]}&gt;
329:               &lt;AgentSessionPage sessionId={params.sessionId} /&gt;
330:             &lt;/ErrorBoundary&gt;
331:           )}
332:         &lt;/Route&gt;
333:         &lt;Route path=&quot;/sessions/:sessionId&quot;&gt;
334:           {(params) =&gt; (
335:             &lt;ErrorBoundary FallbackComponent={RouteErrorFallback} resetKeys={[location]}&gt;
336:               &lt;SessionDetailPage sessionId={params.sessionId} /&gt;
337:             &lt;/ErrorBoundary&gt;
338:           )}
339:         &lt;/Route&gt;
340:         &lt;Route&gt;
341:           &lt;div className=&quot;empty-state&quot;&gt;
342:             &lt;h2&gt;Page Not Found&lt;/h2&gt;
343:             &lt;p&gt;&lt;Link href=&quot;/&quot;&gt;Go to dashboard&lt;/Link&gt;&lt;/p&gt;
344:           &lt;/div&gt;
345:         &lt;/Route&gt;
346:       &lt;/Switch&gt;
347:     &lt;/Layout&gt;
348:     &lt;/RoleProvider&gt;
349:     &lt;/KeyboardNavProvider&gt;
350:     &lt;/Router&gt;
351:   );
352: }</file><file path="src/theme.css">  1: @import url(&apos;https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;500;600&amp;family=IBM+Plex+Sans:wght@400;500;600&amp;display=swap&apos;);
  2: 
  3: :root {
  4:   /* Backgrounds */
  5:   --bg-primary: #0a0e14;
  6:   --bg-card: #131920;
  7:   --bg-elevated: #1a2230;
  8:   --bg-surface: #1f2937;
  9:   --bg-hover: #243044;
 10: 
 11:   /* Borders */
 12:   --border: #2a3a4e;
 13:   --border-subtle: #1e2a3a;
 14:   --border-accent: #3b5278;
 15: 
 16:   /* Text */
 17:   --text-primary: #e2e8f0;
 18:   --text-secondary: #94a3b8;
 19:   --text-muted: #475569;
 20: 
 21:   /* Status */
 22:   --status-healthy: #26d97f;
 23:   --status-warning: #e5a00d;
 24:   --status-critical: #f04438;
 25:   --status-no-data: #6b7280;
 26: 
 27:   /* Accent */
 28:   --accent: #3b82f6;
 29:   --accent-hover: #60a5fa;
 30:   --accent-muted: #1e3a5f;
 31: 
 32:   /* Scores (alias shared values to status tokens) */
 33:   --score-excellent: var(--status-healthy);
 34:   --score-good: #34d399;
 35:   --score-adequate: var(--status-warning);
 36:   --score-poor: #f97316;
 37:   --score-failing: var(--status-critical);
 38: 
 39:   /* Typography */
 40:   --font-body: &apos;IBM Plex Sans&apos;, -apple-system, BlinkMacSystemFont, sans-serif;
 41:   --font-mono: &apos;JetBrains Mono&apos;, &apos;SF Mono&apos;, Consolas, monospace;
 42: 
 43:   /* Spacing */
 44:   --space-half: 2px;
 45:   --space-1: 4px;
 46:   --space-1-5: 6px;
 47:   --space-2: 8px;
 48:   --space-2-5: 10px;
 49:   --space-3: 12px;
 50:   --space-4: 16px;
 51:   --space-5: 20px;
 52:   --space-6: 24px;
 53:   --space-8: 32px;
 54:   --space-16: 64px;
 55: 
 56:   /* Layout */
 57:   --layout-max-width: 1280px;
 58: 
 59:   /* Status tints (bg + border pairs) */
 60:   --bg-status-healthy: #0d1f12;
 61:   --bg-status-warning: #1f1a0d;
 62:   --bg-status-critical: #1f0d0d;
 63:   --border-status-healthy: #1a3a1f;
 64:   --border-status-warning: #3a2f1a;
 65:   --border-status-critical: #3a1a1a;
 66: 
 67:   /* Accent alpha */
 68:   --accent-alpha-10: rgba(59, 130, 246, 0.1);
 69:   --accent-alpha-20: rgba(59, 130, 246, 0.2);
 70: 
 71:   /* Status glow alpha */
 72:   --healthy-alpha-15: rgba(38, 217, 127, 0.15);
 73:   --warning-alpha-15: rgba(229, 160, 13, 0.15);
 74:   --critical-alpha-20: rgba(240, 68, 56, 0.2);
 75:   --critical-alpha-40: rgba(240, 68, 56, 0.4);
 76:   --critical-alpha-60: rgba(240, 68, 56, 0.6);
 77: 
 78:   /* Radii */
 79:   --radius-xs: 2px;
 80:   --radius-bar: 3px;
 81:   --radius-sm: 4px;
 82:   --radius: 6px;
 83:   --radius-lg: 8px;
 84:   --radius-pill: 12px;
 85: 
 86:   /* Font sizes */
 87:   --font-size-2xs: 9px;
 88:   --font-size-label: 11px;
 89:   --font-size-xs: 12px;
 90:   --font-size-sm: 13px;
 91:   --font-size-base: 14px;
 92:   --font-size-md: 16px;
 93:   --font-size-lg: 20px;
 94:   --font-size-xl: 24px;
 95:   --font-size-2xl: 28px;
 96: 
 97:   /* Label typography */
 98:   --label-font-size: var(--font-size-label);
 99:   --label-letter-spacing: 0.5px;
100: 
101:   /* Transitions */
102:   --transition-fast: 0.15s ease;
103:   --transition-bar: width 0.3s ease;
104: 
105:   /* Shadows */
106:   --shadow-sm: 0 1px 2px rgba(0,0,0,0.3);
107:   --shadow-md: 0 2px 8px rgba(0,0,0,0.4);
108:   --shadow-lg: 0 4px 16px rgba(0,0,0,0.5);
109:   --shadow-glow-healthy: 0 0 12px var(--healthy-alpha-15);
110:   --shadow-glow-warning: 0 0 12px var(--warning-alpha-15);
111:   --shadow-glow-critical: 0 0 12px var(--critical-alpha-20);
112: }
113: 
114: * {
115:   margin: 0;
116:   padding: 0;
117:   box-sizing: border-box;
118: }
119: 
120: /* Shared uppercase label pattern */
121: .summary-count .label,
122: .sla-table th,
123: .section-label,
124: .cot-summary,
125: .agreement-grid .ag-header {
126:   text-transform: uppercase;
127:   letter-spacing: var(--label-letter-spacing);
128: }
129: 
130: /* Shared accent link base + hover */
131: .back-link,
132: .tooltip-link,
133: .alert-metric-link {
134:   color: var(--accent);
135:   text-decoration: none;
136: }
137: .back-link:hover,
138: .tooltip-link:hover,
139: .alert-metric-link:hover {
140:   text-decoration: underline;
141: }
142: 
143: /* Shared text truncation */
144: .eval-table .explanation,
145: .metric-worst {
146:   overflow: hidden;
147:   text-overflow: ellipsis;
148:   white-space: nowrap;
149: }
150: 
151: /* Shared flex row */
152: .health-banner,
153: .metric-card-header,
154: .metric-footer,
155: .header,
156: .pipeline-stat,
157: .confidence-header,
158: .variance-bar {
159:   display: flex;
160:   align-items: center;
161: }
162: 
163: /* Shared inline-flex row */
164: .status-badge,
165: .trend,
166: .back-link,
167: .score-badge-wrapper {
168:   display: inline-flex;
169:   align-items: center;
170: }
171: 
172: body {
173:   font-family: var(--font-body);
174:   background: var(--bg-primary);
175:   color: var(--text-primary);
176:   line-height: 1.6;
177:   font-size: var(--font-size-base);
178:   -webkit-font-smoothing: antialiased;
179: }
180: 
181: @media (prefers-reduced-motion: reduce) {
182:   *, *::before, *::after {
183:     animation-duration: 0.01ms !important;
184:     transition-duration: 0.01ms !important;
185:   }
186: }
187: 
188: .dashboard-container {
189:   max-width: var(--layout-max-width);
190:   margin: 0 auto;
191:   padding: var(--space-6);
192: }
193: 
194: .metric-grid {
195:   display: grid;
196:   grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
197:   gap: var(--space-4);
198: }
199: 
200: .card {
201:   background: var(--bg-card);
202:   border: 1px solid var(--border-subtle);
203:   border-radius: var(--radius-lg);
204:   padding: var(--space-5);
205:   box-shadow: var(--shadow-sm);
206: }
207: 
208: .card:hover {
209:   border-color: var(--border);
210: }
211: 
212: .card.glow-warning { box-shadow: var(--shadow-glow-warning); }
213: .card.glow-critical { box-shadow: var(--shadow-glow-critical); }
214: 
215: .card-link {
216:   text-decoration: none;
217:   color: inherit;
218:   display: block;
219: }
220: 
221: /* Health banner */
222: .health-banner {
223:   padding: var(--space-4) var(--space-5);
224:   border-radius: var(--radius);
225:   margin-bottom: var(--space-6);
226:   justify-content: space-between;
227: }
228: .health-banner.healthy { background: var(--bg-status-healthy); border: 1px solid var(--border-status-healthy); }
229: .health-banner.warning { background: var(--bg-status-warning); border: 1px solid var(--border-status-warning); }
230: .health-banner.critical { background: var(--bg-status-critical); border: 1px solid var(--border-status-critical); }
231: .health-banner.no_data { background: var(--bg-card); border: 1px solid var(--border); }
232: 
233: .summary-counts {
234:   display: flex;
235:   gap: var(--space-6);
236: }
237: 
238: .summary-count {
239:   text-align: center;
240: }
241: .summary-count .value {
242:   font-size: var(--font-size-xl);
243:   font-weight: 600;
244:   font-family: var(--font-mono);
245: }
246: .summary-count .label {
247:   font-size: var(--font-size-xs);
248:   color: var(--text-secondary);
249: }
250: 
251: /* Status badges */
252: .status-badge {
253:   gap: var(--space-1-5);
254:   font-size: var(--font-size-xs);
255:   font-weight: 500;
256:   padding: var(--space-half) var(--space-2);
257:   border-radius: var(--radius-pill);
258: }
259: .status-badge.healthy { color: var(--status-healthy); background: var(--bg-status-healthy); }
260: .status-badge.warning { color: var(--status-warning); background: var(--bg-status-warning); }
261: .status-badge.critical { color: var(--status-critical); background: var(--bg-status-critical); }
262: .status-badge.no_data { color: var(--status-no-data); background: var(--bg-elevated); }
263: 
264: /* Trend indicator */
265: .trend {
266:   gap: var(--space-1);
267:   font-size: var(--font-size-sm);
268:   font-family: var(--font-mono);
269: }
270: .trend.improving { color: var(--status-healthy); }
271: .trend.degrading { color: var(--status-critical); }
272: .trend.stable { color: var(--text-secondary); }
273: 
274: /* Confidence badge */
275: .confidence {
276:   font-size: var(--font-size-xs);
277:   color: var(--text-secondary);
278: }
279: 
280: /* Metric card */
281: .metric-card-header {
282:   justify-content: space-between;
283:   margin-bottom: var(--space-3);
284: }
285: .metric-card-header h3 {
286:   font-size: var(--font-size-base);
287:   font-weight: 500;
288: }
289: 
290: .metric-values {
291:   font-family: var(--font-mono);
292:   font-size: var(--font-size-sm);
293: }
294: .metric-values .primary {
295:   font-size: var(--font-size-2xl);
296:   font-weight: 600;
297:   line-height: 1.2;
298: }
299: .metric-values .secondary {
300:   color: var(--text-secondary);
301:   margin-top: var(--space-1);
302: }
303: 
304: /* Shared section divider */
305: .metric-footer,
306: .pipeline-stats,
307: .agreement-summary {
308:   margin-top: var(--space-3);
309:   padding-top: var(--space-3);
310:   border-top: 1px solid var(--border-subtle);
311:   font-size: var(--font-size-xs);
312:   color: var(--text-secondary);
313: }
314: 
315: .metric-footer {
316:   justify-content: space-between;
317:   border-top-color: var(--border);
318: }
319: 
320: /* Alerts */
321: .alert-list {
322:   list-style: none;
323: }
324: .alert-item {
325:   padding: var(--space-3) var(--space-4);
326:   border-left: 3px solid;
327:   background: var(--bg-card);
328:   margin-bottom: var(--space-2);
329:   border-radius: 0 var(--radius) var(--radius) 0;
330: }
331: .alert-item.critical { border-left-color: var(--status-critical); }
332: .alert-item.warning { border-left-color: var(--status-warning); }
333: .alert-item .alert-message {
334:   font-size: var(--font-size-base);
335: }
336: .alert-item .alert-meta,
337: .alert-item .remediation {
338:   font-size: var(--font-size-xs);
339:   margin-top: var(--space-1);
340: }
341: .alert-item .alert-meta { color: var(--text-secondary); }
342: .alert-item .remediation { color: var(--accent); }
343: 
344: /* Shared table cell borders */
345: .sla-table th,
346: .sla-table td,
347: .eval-table th,
348: .eval-table td,
349: .eval-table .eval-expanded-panel td {
350:   border-bottom: 1px solid var(--border);
351: }
352: 
353: /* Shared table header base */
354: .sla-table th,
355: .eval-table th {
356:   text-align: left;
357:   color: var(--text-secondary);
358:   font-weight: 500;
359: }
360: 
361: /* SLA table */
362: .sla-table {
363:   width: 100%;
364:   border-collapse: collapse;
365:   font-size: var(--font-size-base);
366: }
367: .sla-table th,
368: .sla-table td {
369:   padding: var(--space-2) var(--space-3);
370: }
371: .sla-table th {
372:   font-size: var(--label-font-size);
373: }
374: 
375: /* Histogram */
376: .histogram {
377:   display: flex;
378:   align-items: flex-end;
379:   gap: var(--space-half);
380:   height: 120px;
381:   padding: var(--space-2) 0;
382: }
383: .histogram-bar {
384:   flex: 1;
385:   background: var(--accent);
386:   border-radius: var(--radius-xs) var(--radius-xs) 0 0;
387:   min-height: 2px;
388:   position: relative;
389: }
390: .histogram-bar:hover {
391:   opacity: 0.8;
392: }
393: /* Shared elevated surface */
394: .histogram-bar .tooltip,
395: .score-badge-tooltip,
396: .refetch-indicator {
397:   background: var(--bg-elevated);
398:   border: 1px solid var(--border);
399: }
400: 
401: /* Shared tooltip popup base */
402: .histogram-bar .tooltip,
403: .score-badge-tooltip {
404:   display: none;
405:   position: absolute;
406:   left: 50%;
407:   transform: translateX(-50%);
408: }
409: 
410: .histogram-bar .tooltip {
411:   bottom: 100%;
412:   padding: var(--space-1) var(--space-2);
413:   border-radius: var(--radius-sm);
414:   font-size: var(--label-font-size);
415:   white-space: nowrap;
416:   z-index: 10;
417: }
418: .histogram-bar:hover .tooltip {
419:   display: block;
420: }
421: .histogram-labels {
422:   display: flex;
423:   justify-content: space-between;
424:   font-size: var(--label-font-size);
425:   color: var(--text-muted);
426:   font-family: var(--font-mono);
427: }
428: 
429: /* Evaluation detail table */
430: .eval-table {
431:   width: 100%;
432:   border-collapse: collapse;
433:   font-size: var(--font-size-sm);
434: }
435: .eval-table th,
436: .eval-table td {
437:   padding: var(--space-1-5) var(--space-2-5);
438: }
439: .eval-table th {
440:   font-size: var(--font-size-xs);
441: }
442: .eval-table td {
443:   font-family: var(--font-mono);
444: }
445: .eval-table .explanation {
446:   font-family: inherit;
447:   color: var(--text-secondary);
448:   max-width: 300px;
449: }
450: .eval-table tbody tr:hover,
451: .eval-table .eval-row-expanded {
452:   background: var(--bg-elevated);
453: }
454: .eval-table .eval-expanded-panel td {
455:   padding: 0 var(--space-2-5) var(--space-2-5);
456: }
457: 
458: /* Shared ghost button reset */
459: .tab-btn,
460: .period-btn {
461:   background: none;
462:   border: none;
463:   color: var(--text-secondary);
464:   cursor: pointer;
465: }
466: 
467: /* Tabs / Role selector */
468: .tab-nav {
469:   display: flex;
470:   gap: var(--space-1);
471:   margin-bottom: var(--space-6);
472:   border-bottom: 1px solid var(--border);
473:   padding-bottom: 0;
474: }
475: .tab-btn {
476:   padding: var(--space-2) var(--space-4);
477:   font-size: var(--font-size-base);
478:   border-bottom: 2px solid transparent;
479:   margin-bottom: -1px;
480:   transition: color var(--transition-fast), border-color var(--transition-fast);
481: }
482: .tab-btn:hover {
483:   color: var(--text-primary);
484: }
485: .tab-btn[aria-selected=&quot;true&quot;] {
486:   color: var(--text-primary);
487:   border-bottom-color: var(--accent);
488: }
489: 
490: /* Period selector */
491: .period-selector {
492:   display: inline-flex;
493:   gap: var(--space-1);
494:   background: var(--bg-elevated);
495:   border-radius: var(--radius);
496:   padding: var(--space-half);
497: }
498: .period-btn {
499:   padding: var(--space-1) var(--space-3);
500:   border-radius: var(--radius);
501:   font-size: var(--font-size-sm);
502:   font-family: var(--font-body);
503: }
504: .period-btn.active {
505:   background: var(--bg-card);
506:   color: var(--text-primary);
507: }
508: 
509: /* Header */
510: .header {
511:   justify-content: space-between;
512:   margin-bottom: var(--space-6);
513: }
514: .header h1 {
515:   font-size: var(--font-size-lg);
516:   font-weight: 600;
517: }
518: 
519: /* Loading skeleton */
520: .skeleton {
521:   background: linear-gradient(90deg, var(--bg-card) 25%, var(--bg-elevated) 50%, var(--bg-card) 75%);
522:   background-size: 200% 100%;
523:   animation: skeleton-pulse 1.5s ease-in-out infinite;
524:   border-radius: var(--radius);
525: }
526: @keyframes skeleton-pulse {
527:   0% { background-position: 200% 0; }
528:   100% { background-position: -200% 0; }
529: }
530: 
531: /* Empty state */
532: .empty-state {
533:   text-align: center;
534:   padding: var(--space-16) var(--space-6);
535:   color: var(--text-secondary);
536: }
537: .empty-state h2 {
538:   color: var(--text-primary);
539:   margin-bottom: var(--space-2);
540: }
541: .empty-state code {
542:   background: var(--bg-elevated);
543:   padding: var(--space-half) var(--space-1-5);
544:   border-radius: var(--radius-sm);
545:   font-family: var(--font-mono);
546:   font-size: var(--font-size-sm);
547: }
548: 
549: /* Back link */
550: .back-link {
551:   font-size: var(--font-size-sm);
552:   gap: var(--space-1);
553:   margin-bottom: var(--space-4);
554: }
555: 
556: /* Error state */
557: .error-state {
558:   background: var(--bg-status-critical);
559:   border: 1px solid var(--border-status-critical);
560:   border-radius: var(--radius);
561:   padding: var(--space-6);
562:   text-align: center;
563: }
564: .error-state h2 {
565:   color: var(--status-critical);
566:   margin-bottom: var(--space-2);
567: }
568: .error-state .error-actions {
569:   display: flex;
570:   gap: var(--space-2);
571:   margin-top: var(--space-3);
572:   justify-content: center;
573: }
574: .error-state .error-actions button,
575: .error-state .error-actions a {
576:   padding: var(--space-1-5) var(--space-4);
577:   cursor: pointer;
578: }
579: 
580: /* Section headings */
581: .section-heading {
582:   font-size: var(--font-size-md);
583:   font-weight: 600;
584:   margin-bottom: var(--space-4);
585:   margin-top: var(--space-8);
586: }
587: 
588: /* Shared muted label */
589: .section-label,
590: .metric-worst,
591: .confidence-method {
592:   font-size: var(--label-font-size);
593:   color: var(--text-muted);
594: }
595: 
596: .section-label {
597:   margin-bottom: var(--space-1);
598: }
599: 
600: /* View sections */
601: .view-section {
602:   margin-bottom: var(--space-8);
603: }
604: 
605: /* Refetch indicator */
606: .refetch-indicator {
607:   position: fixed;
608:   top: var(--space-4);
609:   right: var(--space-4);
610:   padding: var(--space-2) var(--space-4);
611:   border-radius: var(--radius);
612:   font-size: var(--font-size-sm);
613:   color: var(--text-secondary);
614:   z-index: 1000;
615:   animation: fade-in 0.2s ease-in-out;
616: }
617: 
618: @keyframes fade-in {
619:   from { opacity: 0; transform: translateY(-8px); }
620:   to { opacity: 1; transform: translateY(0); }
621: }
622: 
623: @keyframes toxicPulse {
624:   0%, 100% { box-shadow: 0 0 0 0 var(--critical-alpha-40); }
625:   50% { box-shadow: 0 0 6px 2px var(--critical-alpha-60); }
626: }
627: 
628: /* Score badge tooltip */
629: .score-badge-wrapper {
630:   position: relative;
631:   cursor: default;
632: }
633: .score-badge-tooltip {
634:   bottom: calc(100% + var(--space-2));
635:   border-radius: var(--radius);
636:   padding: var(--space-2-5) var(--space-3);
637:   min-width: 200px;
638:   max-width: 300px;
639:   z-index: 20;
640:   font-size: var(--font-size-xs);
641:   white-space: normal;
642:   animation: fade-in var(--transition-fast);
643: }
644: .score-badge-wrapper:hover .score-badge-tooltip,
645: .score-badge-wrapper:focus-within .score-badge-tooltip {
646:   display: block;
647: }
648: .tooltip-row {
649:   display: flex;
650:   justify-content: space-between;
651:   gap: var(--space-3);
652:   padding: var(--space-half) 0;
653:   color: var(--text-primary);
654: }
655: .tooltip-row span:first-child {
656:   color: var(--text-secondary);
657: }
658: .tooltip-link {
659:   display: block;
660:   margin-top: var(--space-2);
661:   padding-top: var(--space-1-5);
662:   border-top: 1px solid var(--border);
663:   font-size: var(--font-size-xs);
664: }
665: 
666: /* Chain of thought panel */
667: .cot-panel {
668:   margin-top: var(--space-1);
669: }
670: .cot-summary {
671:   font-size: var(--font-size-xs);
672:   color: var(--text-secondary);
673:   cursor: pointer;
674:   padding: var(--space-1) 0;
675:   list-style: none;
676: }
677: .cot-summary::-webkit-details-marker {
678:   display: none;
679: }
680: .cot-summary::before {
681:   content: &apos;\25B6&apos;;
682:   display: inline-block;
683:   margin-right: var(--space-1-5);
684:   font-size: var(--font-size-2xs);
685:   transition: transform var(--transition-fast);
686: }
687: details[open] &gt; .cot-summary::before {
688:   transform: rotate(90deg);
689: }
690: .cot-content {
691:   font-size: var(--font-size-sm);
692:   color: var(--text-primary);
693:   line-height: 1.6;
694:   padding: var(--space-2) 0 var(--space-1);
695: }
696: 
697: /* Evaluation detail page */
698: .eval-detail-header {
699:   margin-bottom: var(--space-6);
700: }
701: .eval-detail-meta {
702:   display: flex;
703:   gap: var(--space-4);
704:   align-items: center;
705:   margin-top: var(--space-2);
706: }
707: .eval-detail-card {
708:   margin-bottom: var(--space-4);
709: }
710: 
711: .eval-summary-card.card:hover {
712:   border-color: var(--accent);
713: }
714: 
715: /* Compound alert card */
716: .alert-compound {
717:   border-left-width: 4px;
718:   background: var(--bg-elevated);
719: }
720: .alert-related {
721:   display: flex;
722:   flex-wrap: wrap;
723:   gap: var(--space-2);
724:   align-items: center;
725:   margin-top: var(--space-2);
726: }
727: .alert-metric-link {
728:   font-size: var(--font-size-xs);
729:   font-family: var(--font-mono);
730:   padding: var(--space-half) var(--space-2);
731:   border-radius: var(--radius-pill);
732:   background: var(--accent-alpha-10);
733: }
734: .alert-metric-link:hover {
735:   background: var(--accent-alpha-20);
736: }
737: .remediation-list {
738:   margin-top: var(--space-2);
739:   padding-left: var(--space-5);
740:   font-size: var(--font-size-xs);
741:   color: var(--accent);
742: }
743: .remediation-list li {
744:   margin-bottom: var(--space-1);
745: }
746: .threshold-bar {
747:   position: relative;
748:   height: 6px;
749:   background: var(--bg-card);
750:   border-radius: var(--radius-bar);
751:   margin-top: var(--space-2);
752:   overflow: visible;
753: }
754: /* Shared animated bar fill */
755: .threshold-bar-fill,
756: .variance-bar-fill {
757:   height: 100%;
758:   transition: var(--transition-bar);
759: }
760: .threshold-bar-fill { border-radius: var(--radius-bar); }
761: .variance-bar-fill  { border-radius: var(--radius-xs); }
762: .threshold-bar-marker {
763:   position: absolute;
764:   top: -3px;
765:   width: 2px;
766:   height: 12px;
767:   background: var(--text-primary);
768:   border-radius: calc(var(--radius-xs) / 2);
769:   transform: translateX(-1px);
770: }
771: 
772: /* Pipeline health stats in HealthOverview */
773: .pipeline-stats {
774:   display: flex;
775:   gap: var(--space-6);
776: }
777: .pipeline-stat {
778:   gap: var(--space-1);
779: }
780: .pipeline-stat .stat-value {
781:   font-family: var(--font-mono);
782:   color: var(--text-primary);
783:   font-weight: 500;
784: }
785: 
786: /* Worst explanation preview on MetricCard */
787: .metric-worst {
788:   margin-top: var(--space-2);
789:   line-height: 1.4;
790: }
791: .metric-worst .worst-score {
792:   color: var(--score-failing);
793:   font-family: var(--font-mono);
794:   font-weight: 500;
795: }
796: 
797: /* Provenance panel */
798: .provenance-panel,
799: .confidence-panel {
800:   font-size: var(--font-size-sm);
801: }
802: .provenance-grid,
803: .agreement-grid {
804:   display: grid;
805:   gap: var(--space-1) var(--space-4);
806:   font-family: var(--font-mono);
807:   font-size: var(--font-size-xs);
808: }
809: .provenance-grid { grid-template-columns: auto 1fr; }
810: .provenance-grid .prov-label {
811:   color: var(--text-secondary);
812:   font-family: var(--font-body);
813:   white-space: nowrap;
814: }
815: .provenance-grid .prov-value {
816:   color: var(--text-primary);
817:   word-break: break-all;
818: }
819: .provenance-actions {
820:   display: flex;
821:   gap: var(--space-2);
822:   margin-top: var(--space-3);
823: }
824: .provenance-actions button {
825:   background: var(--bg-surface);
826:   border: 1px solid var(--border);
827:   color: var(--accent);
828:   padding: var(--space-1) var(--space-3);
829:   border-radius: var(--radius-sm);
830:   font-size: var(--font-size-xs);
831:   cursor: pointer;
832:   font-family: var(--font-body);
833: }
834: .provenance-actions button:hover {
835:   background: var(--bg-hover);
836:   border-color: var(--border-accent);
837: }
838: 
839: /* Confidence panel */
840: .confidence-header {
841:   gap: var(--space-2);
842:   margin-bottom: var(--space-3);
843: }
844: .confidence-method {
845:   font-family: var(--font-mono);
846: }
847: .agreement-grid { grid-template-columns: 1fr auto auto; }
848: .agreement-grid .ag-header {
849:   color: var(--text-muted);
850:   font-size: var(--label-font-size);
851:   font-family: var(--font-body);
852:   padding-bottom: var(--space-1);
853:   border-bottom: 1px solid var(--border-subtle);
854: }
855: .agreement-summary .summary-value {
856:   font-family: var(--font-mono);
857:   color: var(--text-primary);
858: }
859: .variance-bar {
860:   gap: var(--space-2);
861: }
862: .variance-bar-track {
863:   flex: 1;
864:   height: 4px;
865:   background: var(--bg-surface);
866:   border-radius: var(--radius-xs);
867:   overflow: hidden;
868: }</file></files><git_diffs><git_diff_work_tree>diff --git a/docs/BACKLOG.md b/docs/BACKLOG.md
index 2eec444..6db07ed 100644
--- a/docs/BACKLOG.md
+++ b/docs/BACKLOG.md
@@ -2,24 +2,4 @@
 
 Open items from code reviews and deferred work.
 
-## theme.css DRY — remaining token gaps (2026-02-28)
-
-Source: code-reviewer DRY audit. H1-H3, M1-M12, L1-L5 resolved. Items below are residual.
-
-### Tokenize remaining font-size values
-- [x] `font-size: 14px` used 5x (body, metric-card-header h3, alert-message, sla-table, tab-btn) — add `--font-size-base: 14px` ✓
-- [x] `font-size: 16px` used 1x (section-heading) — add `--font-size-md: 16px` ✓
-- [x] `font-size: 20px` used 1x (header h1) — add `--font-size-lg: 20px` ✓
-- [x] `font-size: 24px` used 1x (summary-count .value) — add `--font-size-xl: 24px` ✓
-- [x] `font-size: 28px` used 1x (metric-values .primary) — add `--font-size-2xl: 28px` ✓
-- [x] `font-size: 9px` used 1x (cot-summary::before triangle) — add `--font-size-2xs: 9px` ✓
-
-### Tokenize remaining raw spacing
-- [x] `10px` used in eval-table th/td padding and eval-expanded-panel — added `--space-2-5: 10px` ✓
-- [x] `padding: 10px 12px` in score-badge-tooltip — replaced with `var(--space-2-5) var(--space-3)` ✓
-
-### Shadow glow critical alpha
-- [x] `--shadow-glow-critical` uses inline `rgba(240,68,56,0.2)` — added `--critical-alpha-20` ✓
-
-### Residual gaps (from 2026-02-28 code review)
-- [x] `--shadow-glow-healthy` and `--shadow-glow-warning` — added `--healthy-alpha-15` and `--warning-alpha-15` to complete glow alpha series ✓
+**Resolved items**: [v2.28 Theme CSS DRY Completion](changelog/2.28/CHANGELOG.md) (2026-02-28)
diff --git a/scripts/sync-to-kv.ts b/scripts/sync-to-kv.ts
index b6a8038..4cb8601 100644
--- a/scripts/sync-to-kv.ts
+++ b/scripts/sync-to-kv.ts
@@ -38,8 +38,18 @@ import {
 } from &apos;../../dist/lib/quality-feature-engineering.js&apos;;
 import { computeMultiAgentEvaluation } from &apos;../../dist/lib/quality-multi-agent.js&apos;;
 
-const NAMESPACE_ID = process.env.KV_NAMESPACE_ID;
-if (!NAMESPACE_ID) throw new Error(&apos;KV_NAMESPACE_ID env var is required&apos;);
+function resolveNamespaceId(): string {
+  if (process.env.KV_NAMESPACE_ID) return process.env.KV_NAMESPACE_ID;
+  // Fall back to wrangler.toml kv_namespaces[0].id
+  const tomlPath = join(import.meta.dirname ?? &apos;.&apos;, &apos;..&apos;, &apos;wrangler.toml&apos;);
+  if (existsSync(tomlPath)) {
+    const toml = readFileSync(tomlPath, &apos;utf8&apos;);
+    const match = toml.match(/\[\[kv_namespaces\]\][\s\S]*?^id\s*=\s*&quot;([^&quot;]+)&quot;/m);
+    if (match) return match[1];
+  }
+  throw new Error(&apos;KV_NAMESPACE_ID env var not set and could not resolve from wrangler.toml&apos;);
+}
+const NAMESPACE_ID = resolveNamespaceId();
 
 function parseIntArg(args: string[], flag: string, defaultValue: number): number {
   const match = args.find(a =&gt; a.startsWith(`--${flag}=`));
@@ -724,14 +734,14 @@ async function main(): Promise&lt;void&gt; {
       value: JSON.stringify({ correlations, metrics: corrMetricNames }),
     });
 
-    // Coverage (both inputKey variants)
-    for (const inputKey of [&apos;traceId&apos;, &apos;sessionId&apos;] as const) {
-      const heatmap = computeCoverageHeatmap(grouped, { inputKey });
-      entries.push({
-        key: `coverage:${period}:${inputKey}`,
-        value: JSON.stringify({ period, ...heatmap }),
-      });
-    }
+    // TODO: Re-enable coverage heatmaps once values are capped to stay under KV 25 MB limit
+    // for (const inputKey of [&apos;traceId&apos;, &apos;sessionId&apos;] as const) {
+    //   const heatmap = computeCoverageHeatmap(grouped, { inputKey });
+    //   entries.push({
+    //     key: `coverage:${period}:${inputKey}`,
+    //     value: JSON.stringify({ period, ...heatmap }),
+    //   });
+    // }
 
     // Pipeline
     const pipeline = computePipelineView(grouped, dashboard);
diff --git a/src/theme.css b/src/theme.css
index 5a3b717..e657d2f 100644
--- a/src/theme.css
+++ b/src/theme.css
@@ -29,15 +29,14 @@
   --accent-hover: #60a5fa;
   --accent-muted: #1e3a5f;
 
-  /* Scores */
-  --score-excellent: #26d97f;
+  /* Scores (alias shared values to status tokens) */
+  --score-excellent: var(--status-healthy);
   --score-good: #34d399;
-  --score-adequate: #e5a00d;
+  --score-adequate: var(--status-warning);
   --score-poor: #f97316;
-  --score-failing: #f04438;
+  --score-failing: var(--status-critical);
 
   /* Typography */
-  --font-display: &apos;JetBrains Mono&apos;, &apos;SF Mono&apos;, &apos;Fira Code&apos;, monospace;
   --font-body: &apos;IBM Plex Sans&apos;, -apple-system, BlinkMacSystemFont, sans-serif;
   --font-mono: &apos;JetBrains Mono&apos;, &apos;SF Mono&apos;, Consolas, monospace;
 
@@ -86,6 +85,7 @@
 
   /* Font sizes */
   --font-size-2xs: 9px;
+  --font-size-label: 11px;
   --font-size-xs: 12px;
   --font-size-sm: 13px;
   --font-size-base: 14px;
@@ -95,7 +95,7 @@
   --font-size-2xl: 28px;
 
   /* Label typography */
-  --label-font-size: 11px;
+  --label-font-size: var(--font-size-label);
   --label-letter-spacing: 0.5px;
 
   /* Transitions */
@@ -127,13 +127,48 @@
   letter-spacing: var(--label-letter-spacing);
 }
 
-/* Shared accent link hover */
+/* Shared accent link base + hover */
+.back-link,
+.tooltip-link,
+.alert-metric-link {
+  color: var(--accent);
+  text-decoration: none;
+}
 .back-link:hover,
 .tooltip-link:hover,
 .alert-metric-link:hover {
   text-decoration: underline;
 }
 
+/* Shared text truncation */
+.eval-table .explanation,
+.metric-worst {
+  overflow: hidden;
+  text-overflow: ellipsis;
+  white-space: nowrap;
+}
+
+/* Shared flex row */
+.health-banner,
+.metric-card-header,
+.metric-footer,
+.header,
+.pipeline-stat,
+.confidence-header,
+.variance-bar {
+  display: flex;
+  align-items: center;
+}
+
+/* Shared inline-flex row */
+.status-badge,
+.trend,
+.back-link,
+.score-badge-wrapper {
+  display: inline-flex;
+  align-items: center;
+}
+
 body {
   font-family: var(--font-body);
   background: var(--bg-primary);
@@ -188,8 +223,6 @@ body {
   padding: var(--space-4) var(--space-5);
   border-radius: var(--radius);
   margin-bottom: var(--space-6);
-  display: flex;
-  align-items: center;
   justify-content: space-between;
 }
 .health-banner.healthy { background: var(--bg-status-healthy); border: 1px solid var(--border-status-healthy); }
@@ -217,8 +250,6 @@ body {
 
 /* Status badges */
 .status-badge {
-  display: inline-flex;
-  align-items: center;
   gap: var(--space-1-5);
   font-size: var(--font-size-xs);
   font-weight: 500;
@@ -232,8 +263,6 @@ body {
 
 /* Trend indicator */
 .trend {
-  display: inline-flex;
-  align-items: center;
   gap: var(--space-1);
   font-size: var(--font-size-sm);
   font-family: var(--font-mono);
@@ -250,9 +279,7 @@ body {
 
 /* Metric card */
 .metric-card-header {
-  display: flex;
   justify-content: space-between;
-  align-items: center;
   margin-bottom: var(--space-3);
 }
 .metric-card-header h3 {
@@ -286,9 +313,7 @@ body {
 }
 
 .metric-footer {
-  display: flex;
   justify-content: space-between;
-  align-items: center;
   border-top-color: var(--border);
 }
 
@@ -339,13 +364,13 @@ body {
   border-collapse: collapse;
   font-size: var(--font-size-base);
 }
-.sla-table th {
-  padding: var(--space-2) var(--space-3);
-  font-size: var(--label-font-size);
-}
+.sla-table th,
 .sla-table td {
   padding: var(--space-2) var(--space-3);
 }
+.sla-table th {
+  font-size: var(--label-font-size);
+}
 
 /* Histogram */
 .histogram {
@@ -358,21 +383,32 @@ body {
 .histogram-bar {
   flex: 1;
   background: var(--accent);
-  border-radius: 2px 2px 0 0;
+  border-radius: var(--radius-xs) var(--radius-xs) 0 0;
   min-height: 2px;
   position: relative;
 }
 .histogram-bar:hover {
   opacity: 0.8;
 }
-.histogram-bar .tooltip {
+/* Shared elevated surface */
+.histogram-bar .tooltip,
+.score-badge-tooltip,
+.refetch-indicator {
+  background: var(--bg-elevated);
+  border: 1px solid var(--border);
+}
+
+/* Shared tooltip popup base */
+.histogram-bar .tooltip,
+.score-badge-tooltip {
   display: none;
   position: absolute;
-  bottom: 100%;
   left: 50%;
   transform: translateX(-50%);
-  background: var(--bg-elevated);
-  border: 1px solid var(--border);
+}
+
+.histogram-bar .tooltip {
+  bottom: 100%;
   padding: var(--space-1) var(--space-2);
   border-radius: var(--radius-sm);
   font-size: var(--label-font-size);
@@ -410,9 +446,6 @@ body {
   font-family: inherit;
   color: var(--text-secondary);
   max-width: 300px;
-  overflow: hidden;
-  text-overflow: ellipsis;
-  white-space: nowrap;
 }
 .eval-table tbody tr:hover,
 .eval-table .eval-row-expanded {
@@ -475,9 +508,7 @@ body {
 
 /* Header */
 .header {
-  display: flex;
   justify-content: space-between;
-  align-items: center;
   margin-bottom: var(--space-6);
 }
 .header h1 {
@@ -517,11 +548,7 @@ body {
 
 /* Back link */
 .back-link {
-  color: var(--accent);
-  text-decoration: none;
   font-size: var(--font-size-sm);
-  display: inline-flex;
-  align-items: center;
   gap: var(--space-1);
   margin-bottom: var(--space-4);
 }
@@ -580,8 +607,6 @@ body {
   position: fixed;
   top: var(--space-4);
   right: var(--space-4);
-  background: var(--bg-elevated);
-  border: 1px solid var(--border);
   padding: var(--space-2) var(--space-4);
   border-radius: var(--radius);
   font-size: var(--font-size-sm);
@@ -603,18 +628,10 @@ body {
 /* Score badge tooltip */
 .score-badge-wrapper {
   position: relative;
-  display: inline-flex;
-  align-items: center;
   cursor: default;
 }
 .score-badge-tooltip {
-  display: none;
-  position: absolute;
   bottom: calc(100% + var(--space-2));
-  left: 50%;
-  transform: translateX(-50%);
-  background: var(--bg-elevated);
-  border: 1px solid var(--border);
   border-radius: var(--radius);
   padding: var(--space-2-5) var(--space-3);
   min-width: 200px;
@@ -643,8 +660,6 @@ body {
   margin-top: var(--space-2);
   padding-top: var(--space-1-5);
   border-top: 1px solid var(--border);
-  color: var(--accent);
-  text-decoration: none;
   font-size: var(--font-size-xs);
 }
 
@@ -710,8 +725,6 @@ details[open] &gt; .cot-summary::before {
   margin-top: var(--space-2);
 }
 .alert-metric-link {
-  color: var(--accent);
-  text-decoration: none;
   font-size: var(--font-size-xs);
   font-family: var(--font-mono);
   padding: var(--space-half) var(--space-2);
@@ -752,7 +765,7 @@ details[open] &gt; .cot-summary::before {
   width: 2px;
   height: 12px;
   background: var(--text-primary);
-  border-radius: 1px;
+  border-radius: calc(var(--radius-xs) / 2);
   transform: translateX(-1px);
 }
 
@@ -762,8 +775,6 @@ details[open] &gt; .cot-summary::before {
   gap: var(--space-6);
 }
 .pipeline-stat {
-  display: flex;
-  align-items: center;
   gap: var(--space-1);
 }
 .pipeline-stat .stat-value {
@@ -776,9 +787,6 @@ details[open] &gt; .cot-summary::before {
 .metric-worst {
   margin-top: var(--space-2);
   line-height: 1.4;
-  overflow: hidden;
-  text-overflow: ellipsis;
-  white-space: nowrap;
 }
 .metric-worst .worst-score {
   color: var(--score-failing);
@@ -830,8 +838,6 @@ details[open] &gt; .cot-summary::before {
 
 /* Confidence panel */
 .confidence-header {
-  display: flex;
-  align-items: center;
   gap: var(--space-2);
   margin-bottom: var(--space-3);
 }
@@ -851,8 +857,6 @@ details[open] &gt; .cot-summary::before {
   color: var(--text-primary);
 }
 .variance-bar {
-  display: flex;
-  align-items: center;
   gap: var(--space-2);
 }
 .variance-bar-track {
</git_diff_work_tree><git_diff_staged></git_diff_staged></git_diffs><git_logs><git_log_commit><date>2026-02-28 16:13:43 -0600</date><message>refactor(theme): DRY theme.css — tokens, shared rules, selector consolidation</message><files>src/theme.css</files></git_log_commit><git_log_commit><date>2026-02-28 15:44:54 -0600</date><message>chore(backlog): mark theme.css DRY section complete</message><files>docs/BACKLOG.md</files></git_log_commit><git_log_commit><date>2026-02-28 15:44:45 -0600</date><message>refactor(theme): complete glow alpha series for healthy/warning</message><files>src/theme.css</files></git_log_commit><git_log_commit><date>2026-02-28 15:40:44 -0600</date><message>refactor(theme): add --critical-alpha-20; use in shadow-glow-critical</message><files>src/theme.css</files></git_log_commit><git_log_commit><date>2026-02-28 15:38:45 -0600</date><message>refactor(theme): add --space-2-5 token; replace raw 10px spacing</message><files>src/theme.css</files></git_log_commit><git_log_commit><date>2026-02-28 15:36:54 -0600</date><message>refactor(theme): tokenize remaining font-size values (M13-M18)</message><files>src/theme.css</files></git_log_commit><git_log_commit><date>2026-02-28 15:30:30 -0600</date><message>refactor(theme): DRY remaining token and pattern gaps (M8-M12)</message><files>src/theme.css</files></git_log_commit><git_log_commit><date>2026-02-28 15:27:58 -0600</date><message>refactor(theme): replace all raw spacing values with --space-* tokens (M1-M6)</message><files>src/theme.css</files></git_log_commit><git_log_commit><date>2026-02-28 15:24:06 -0600</date><message>refactor(theme): fill spacing/layout token gaps; remove unused --radius-xl</message><files>src/theme.css</files></git_log_commit><git_log_commit><date>2026-02-28 15:21:01 -0600</date><message>refactor(theme): tokenize font sizes and critical alpha; fix bar-fill radius no-op</message><files>src/theme.css</files></git_log_commit><git_log_commit><date>2026-02-28 15:10:20 -0600</date><message>refactor(theme): DRY CSS — tokenize status tints, radii, accent alpha; consolidate duplicates</message><files>src/components/AgentActivityPanel.tsx</files><files>src/components/Layout.tsx</files><files>src/main.tsx</files><files>src/theme.css</files></git_log_commit><git_log_commit><date>2026-02-27 23:14:04 -0600</date><message>fix(coverage): filter rule-based evals from heatmap; UI improvements</message><files>src/App.tsx</files><files>src/__tests__/p1-explainability.test.tsx</files><files>src/api/routes/coverage.ts</files><files>src/api/routes/trends.ts</files><files>src/components/ChainOfThoughtPanel.tsx</files><files>src/components/EvaluationEventOverlay.tsx</files><files>src/hooks/useSessionDetail.ts</files><files>src/hooks/useTrend.ts</files><files>src/pages/EvaluationDetailPage.tsx</files><files>src/pages/SessionDetailPage.tsx</files><files>src/pages/TraceDetailPage.tsx</files><files>src/theme.css</files></git_log_commit><git_log_commit><date>2026-02-27 21:30:06 -0600</date><message>new evaluations</message><files>packed-codebase.xml</files><files>scripts/derive-evaluations.ts</files><files>scripts/judge-evaluations.ts</files><files>src/api/routes/agents.ts</files></git_log_commit><git_log_commit><date>2026-02-27 20:56:18 -0600</date><message>fix(agents): show true traceIdsTotal in expanded panel header</message><files>src/components/AgentActivityPanel.tsx</files></git_log_commit><git_log_commit><date>2026-02-27 20:53:23 -0600</date><message>fix(agents): show true sessionCount in expanded panel header</message><files>docs/changelog/2.27/CHANGELOG.md</files><files>docs/changelog/2.8/CHANGELOG.md</files><files>src/components/AgentActivityPanel.tsx</files></git_log_commit><git_log_commit><date>2026-02-27 20:51:51 -0600</date><message>fix(agents): harden routes, types, and update README</message><files>README.md</files><files>src/api/routes/agents.ts</files><files>src/components/AgentActivityPanel.tsx</files><files>src/hooks/useAgentStats.ts</files></git_log_commit><git_log_commit><date>2026-02-27 20:45:20 -0600</date><message>fix(sync-to-kv): replace localeCompare with locale-independent sort; type entry</message><files>scripts/sync-to-kv.ts</files></git_log_commit><git_log_commit><date>2026-02-27 20:41:43 -0600</date><message>fix(agents): address second-pass code-reviewer findings</message><files>src/api/routes/agents.ts</files><files>src/components/AgentActivityPanel.tsx</files><files>src/hooks/useAgentStats.ts</files></git_log_commit><git_log_commit><date>2026-02-27 20:32:01 -0600</date><message>fix(sync-to-kv): address code-reviewer M-1, M-2, L-1 for session buffer</message><files>scripts/sync-to-kv.ts</files></git_log_commit><git_log_commit><date>2026-02-27 20:31:04 -0600</date><message>fix(agents): address code-reviewer findings from 52e4296</message><files>src/api/data-loader.ts</files><files>src/api/routes/agents.ts</files><files>src/components/AgentActivityPanel.tsx</files><files>src/hooks/useAgentStats.ts</files></git_log_commit></git_logs></repomix>